
document.addEventListener('DOMContentLoaded', () => {  
    // =============================================================
    // ======================= UI ELEMENTS =========================
    // =============================================================
    const UIElements = {
        // Abas
        tabs: document.querySelectorAll('.tab-button'),
        tabContents: {
            jornada: document.getElementById('tab-content-jornada'),
            dashboard: document.getElementById('tab-content-dashboard'),
            financeiro: document.getElementById('tab-content-financeiro'),
            manutencao: document.getElementById('tab-content-manutencao'),
            configuracoes: document.getElementById('tab-content-configuracoes')
        },
        // Controles Gerais
        btnToggleStatusView: document.getElementById('btnToggleStatusView'),
        modalContainer: document.getElementById('modalContainer'),

        // Aba Jornada
        btnJornada: document.getElementById('btnJornada'),
        btnPausa: document.getElementById('btnPausa'),
        statusContainer: document.getElementById('statusContainer'),
        tempoJornada: document.getElementById('tempoJornada'),
        statusPausa: document.getElementById('statusPausa'),
        tempoPausa: document.getElementById('tempoPausa'),
        alertaCombustivelContainer: document.getElementById('alertaCombustivelContainer'),
        metaContainer: document.getElementById('metaContainer'),
        metaHorasInput: document.getElementById('metaHorasInput'),
        metaHoraResultado: document.getElementById('metaHoraResultado'),
        painelControleJornada: document.getElementById('painelControleJornada'),
        opcoesJornada: document.getElementById('opcoesJornada'),
        kmContainer: document.getElementById('kmContainer'),
        kmInicialInput: document.getElementById('kmInicialInput'),
        kmFinalInput: document.getElementById('kmFinalInput'),
        controlesOcultaveis: document.getElementById('controlesOcultaveis'),
        servicosManager: document.getElementById('servicosManager'),
        valorServicoInput: document.getElementById('valorServico'),
        categoriaServicoSelect: document.getElementById('categoriaServico'),
        subcategoriaServicoContainer: document.getElementById('subcategoriaServicoContainer'),
        subcategoriaServicoSelect: document.getElementById('subcategoriaServico'),
        descricaoServicoInput: document.getElementById('descricaoServico'),
        kmInicialServicoInput: document.getElementById('kmInicialServicoInput'),
        btnIniciarServico: document.getElementById('btnIniciarServico'),
        btnServicoRapido: document.getElementById('btnServicoRapido'),
        servicosEmAndamentoContainer: document.getElementById('servicosEmAndamentoContainer'),
        tituloServicosEmAndamento: document.getElementById('tituloServicosEmAndamento'),
        listaServicosEmAndamento: document.getElementById('listaServicosEmAndamento'),
        diaAnteriorBtn: document.getElementById('diaAnteriorBtn'),
        proximoDiaBtn: document.getElementById('proximoDiaBtn'),
        dataAtualHistorico: document.getElementById('dataAtualHistorico'),
        btnExcluirDia: document.getElementById('btnExcluirDia'),
        btnDownloadDia: document.getElementById('btnDownloadDia'),
        btnAbrirCalculadora: document.getElementById('btnAbrirCalculadora'),
        resumoDia: document.getElementById('resumoDia'),
        listaAtividades: document.getElementById('listaAtividades'),
        btnTogglePendentes: document.getElementById('btnTogglePendentes'),
        tituloHistoricoCard: document.getElementById('tituloHistoricoCard'),
        historicoDiaContainer: document.getElementById('historicoDiaContainer'),
        pendentesContainer: document.getElementById('pendentesContainer'),
        listaPendencias: document.getElementById('listaPendencias'),
        alertasJornadaContainer: document.getElementById('alertasJornadaContainer'),
        listaAlertasJornada: document.getElementById('listaAlertasJornada'),
        
        // --- IN√çCIO: SUPER-PASSO N (Adicionado) ---
        contasRecorrentesAlertContainer: document.getElementById('contasRecorrentesAlertContainer'),
        // --- FIM: SUPER-PASSO N ---
        
        btnMostrarCustos: document.getElementById('btnMostrarCustos'),
        custosContainer: document.getElementById('custosContainer'),
        litrosAbastecidosInput: document.getElementById('litrosAbastecidos'),
        valorAbastecidoInput: document.getElementById('valorAbastecido'),
		kmAbastecimentoInput: document.getElementById('kmAbastecimentoInput'),
        litrosRestantesInput: document.getElementById('litrosRestantesInput'), // <-- ETAPA 2 (NOVO)
        resumoAbastecimento: document.getElementById('resumoAbastecimento'),
        descricaoCustoInput: document.getElementById('descricaoCusto'),
        valorCustoInput: document.getElementById('valorCusto'),
        btnAdicionarCusto: document.getElementById('btnAdicionarCusto'),
        listaCustos: document.getElementById('listaCustos'),
        
        // Roadmap Etapa 2
        roadmapContainer: document.getElementById('roadmapContainer'), // <-- ETAPA 2 (NOVO)
        roadmapProximosEventos: document.getElementById('roadmapProximosEventos'), // <-- ETAPA 2 (NOVO)
        roadmapTimeline: document.getElementById('roadmapTimeline'), // <-- ETAPA 2 (NOVO)
        
        // --- IN√çCIO DA ETAPA 3: IDs do Resumo do Roadmap (Req 4) ---
        roadmapResumoFinanceiro: document.getElementById('roadmapResumoFinanceiro'),
        roadmapTotalEntradas: document.getElementById('roadmapTotalEntradas'),
        roadmapTotalSaidas: document.getElementById('roadmapTotalSaidas'),
        // --- FIM DA ETAPA 3 ---
        // Aba Dashboard
        dashboardFilterContainer: document.getElementById('dashboardFilterContainer'), // <-- ETAPA 2 (NOVO)
        selectDia: document.getElementById('selectDia'), // <-- ETAPA 2 (NOVO)
        selectMes: document.getElementById('selectMes'),
        selectAno: document.getElementById('selectAno'),
        dashboardResumoCards: document.getElementById('dashboardResumoCards'),
        graficoGanhosCustos: document.getElementById('graficoGanhosCustos'),
        graficoCategorias: document.getElementById('graficoCategorias'),
        graficoCustos: document.getElementById('graficoCustos'),
        lucroLiquidoCard: document.getElementById('lucroLiquidoCard'),
        ganhosBrutosCard: document.getElementById('ganhosBrutosCard'),
        custosTotaisCard: document.getElementById('custosTotaisCard'),
        tempoLiquidoCard: document.getElementById('tempoLiquidoCard'),
        kmRodadosCard: document.getElementById('kmRodadosCard'),
        mediaBrutaKMCard: document.getElementById('mediaBrutaKMCard'),
        mediaBrutaHoraCard: document.getElementById('mediaBrutaHoraCard'),
        mediaPausaDiaCard: document.getElementById('mediaPausaDiaCard'),
        mediaKmLCard: document.getElementById('mediaKmLCard'), // <-- ETAPA 2 (NOVO)
        graficoMetasContainer: document.getElementById('graficoMetasContainer'),
        graficoMetasFinanceiras: document.getElementById('graficoMetasFinanceiras'), 
        graficoDrilldown: document.getElementById('graficoDrilldown'),
        graficoDrilldownKm: document.getElementById('graficoDrilldownKm'),
        btnVoltarDrilldown: document.getElementById('btnVoltarDrilldown'),
        // Novos Gr√°ficos Etapa 2
        graficoCustoCombustivel: document.getElementById('graficoCustoCombustivel'), // <-- ETAPA 2 (NOVO)
        graficoMediaKmL: document.getElementById('graficoMediaKmL'), // <-- ETAPA 2 (NOVO)
        tituloGraficoMediaKmL: document.getElementById('tituloGraficoMediaKmL'), // <-- ETAPA 2 (NOVO)
        // Roadmap Etapa 2
        roadmapContainer: document.getElementById('roadmapContainer'), // <-- ETAPA 2 (NOVO)
        roadmapProximosEventos: document.getElementById('roadmapProximosEventos'), // <-- ETAPA 2 (NOVO)
        roadmapTimeline: document.getElementById('roadmapTimeline'), // <-- ETAPA 2 (NOVO)
        
        // Aba Manuten√ß√£o
        gamTabButtons: document.querySelectorAll('.gam-tab-button'),
        gamTabPanes: {
            plano: document.getElementById('gam-tab-content-plano'),
            historico: document.getElementById('gam-tab-content-historico'),
            dashboard: document.getElementById('gam-tab-content-dashboard'),
            alertas: document.getElementById('gam-tab-content-alertas')
        },
        planoCategoriaSelect: document.getElementById('planoCategoriaSelect'),
        planoDescricaoInput: document.getElementById('planoDescricao'),
        planoAcaoSelect: document.getElementById('planoAcaoSelect'), // NOVO
        planoObservacaoInput: document.getElementById('planoObservacao'), // NOVO
        planoCustoEstimadoInput: document.getElementById('planoCustoEstimado'),
        planoIntervaloKmInput: document.getElementById('planoIntervaloKm'),
        planoIntervaloMesesInput: document.getElementById('planoIntervaloMeses'),
        planoMetaVinculadaSelect: document.getElementById('planoMetaVinculada'),
        btnAdicionarPlano: document.getElementById('btnAdicionarPlano'),
        listaPlanoMestre: document.getElementById('listaPlanoMestre'),
        planoCountSpan: document.getElementById('planoCount'),
        histDataInput: document.getElementById('histData'),
        histKmInput: document.getElementById('histKm'),
        histPlanoMestreItemSelect: document.getElementById('histPlanoMestreItem'),
        histCategoriaSelect: document.getElementById('histCategoriaSelect'),
        histServicoInput: document.getElementById('histServico'),
        histLocalInput: document.getElementById('histLocal'),
        histValorInput: document.getElementById('histValor'),
        histPagarComCaixinhaSelect: document.getElementById('histPagarComCaixinha'),
        btnAdicionarHistoricoServico: document.getElementById('btnAdicionarHistoricoServico'),
        listaHistoricoServicos: document.getElementById('listaHistoricoServicos'),
        historicoCountSpan: document.getElementById('historicoCount'),
        cotaServicoInput: document.getElementById('cotaServico'),
        cotaLocalInput: document.getElementById('cotaLocal'),
        cotaValorInput: document.getElementById('cotaValor'),
        cotaValidadeInput: document.getElementById('cotaValidade'),
        btnAdicionarCota: document.getElementById('btnAdicionarCota'),
        listaCota: document.getElementById('listaCota'),
        cotaCountSpan: document.getElementById('cotaCount'),
        gamDashboardChart: document.getElementById('gamDashboardChart'),
        gamDashboardSummary: document.getElementById('gamDashboardSummary'),
        gamDashboardKpi: document.getElementById('gamDashboardKpi'),
        gamHealthScoreGauge: document.getElementById('gamHealthScoreGauge'),
        gamHealthScoreText: document.getElementById('gamHealthScoreText'),
        gamHealthItemsList: document.getElementById('gamHealthItemsList'),
        gamHealthOdometerWarning: document.getElementById('gamHealthScoreOdometerWarning'),
        
        // Aba Configura√ß√µes
        proLaboreInput: document.getElementById('proLaboreInput'),
        proLaboreDiaInput: document.getElementById('proLaboreDiaInput'),
        diasTrabalhoSemanaInput: document.getElementById('diasTrabalhoSemanaInput'),
        metaAutonomaInput: document.getElementById('metaAutonomaInput'),
		manterCalculoKmAntigo: document.getElementById('manterCalculoKmAntigo'),
        kmMetaDiariaInput: document.getElementById('kmMetaDiariaInput'),
        incluirPrevisaoManutencao: document.getElementById('incluirPrevisaoManutencao'),
        rateioDinamicoCustos: document.getElementById('rateioDinamicoCustos'),
        valorVeiculoInput: document.getElementById('valorVeiculo'),
        vidaUtilVeiculoInput: document.getElementById('vidaUtilVeiculo'),
        autonomiaVeiculoInput: document.getElementById('autonomiaVeiculoInput'),
        tipoCombustivelSelect: document.getElementById('tipoCombustivelSelect'),
        subcategoriaDescricaoInput: document.getElementById('subcategoriaDescricaoInput'),
        subcategoriaPaiSelect: document.getElementById('subcategoriaPaiSelect'),
        subcategoriaCorInput: document.getElementById('subcategoriaCorInput'),
        btnAdicionarSubcategoria: document.getElementById('btnAdicionarSubcategoria'),
        listaSubcategorias: document.getElementById('listaSubcategorias'),
        btnSalvarConfiguracoes: document.getElementById('btnSalvarConfiguracoes'),
        btnExportarDados: document.getElementById('btnExportarDados'),
        importFileInput: document.getElementById('importFileInput'),
        
        // Aba Financeiro (Movido de Configura√ß√µes)
        descricaoCustoFixoInput: document.getElementById('descricaoCustoFixo'),
        valorCustoFixoInput: document.getElementById('valorCustoFixo'),
        vencimentoCustoFixoInput: document.getElementById('vencimentoCustoFixo'),
        btnAdicionarCustoFixo: document.getElementById('btnAdicionarCustoFixo'),
        listaCustosFixos: document.getElementById('listaCustosFixos'),
        
		// Aba Financeiro - Metas
        metaDescricaoInput: document.getElementById('metaDescricaoInput'),
        metaTipoSelect: document.getElementById('metaTipoSelect'),
        metaBancoVinculado: document.getElementById('metaBancoVinculado'),
        metaValorTotalInput: document.getElementById('metaValorTotalInput'),
		metaValorObjetivoInput: document.getElementById('metaValorObjetivoInput'),
        metaDataVencimentoInput: document.getElementById('metaDataVencimentoInput'),
        metaPrazoMesesInput: document.getElementById('metaPrazoMesesInput'),
        metaTaxaJurosInput: document.getElementById('metaTaxaJurosInput'),
        metaContribuicaoMensalInput: document.getElementById('metaContribuicaoMensalInput'),
        containerValorTotal: document.getElementById('containerValorTotal'),
		containerValorObjetivo: document.getElementById('containerValorObjetivo'),
        containerDataVencimento: document.getElementById('containerDataVencimento'),
        containerPrazoMeses: document.getElementById('containerPrazoMeses'),
        containerPoupanca: document.getElementById('containerPoupanca'),
        containerTaxaJuros: document.getElementById('containerTaxaJuros'),
        containerContribuicaoMensal: document.getElementById('containerContribuicaoMensal'),
        containerPoupancaKm: document.getElementById('containerPoupancaKm'),
        metaValorPorKmInput: document.getElementById('metaValorPorKmInput'),
        metaValorObjetivoInputKm: document.getElementById('metaValorObjetivoInputKm'),
        metaDataVencimentoInputKm: document.getElementById('metaDataVencimentoInputKm'),
        metaTaxaJurosInputKm: document.getElementById('metaTaxaJurosInputKm'),
        btnAdicionarMeta: document.getElementById('btnAdicionarMeta'),
        containerJurosCheckbox: document.getElementById('containerJurosCheckbox'),
        metaJurosCheckbox: document.getElementById('metaJurosCheckbox'),
        containerTipoDivida: document.getElementById('containerTipoDivida'),
        metaTipoDividaSelect: document.getElementById('metaTipoDividaSelect'),
        containerConsorcio: document.getElementById('containerConsorcio'),
        metaValorObjetivoConsorcioInput: document.getElementById('metaValorObjetivoConsorcioInput'),
        metaValorFinanciadoInput: document.getElementById('metaValorFinanciadoInput'),
        metaTaxaJurosAnualInput: document.getElementById('metaTaxaJurosAnualInput'),
        metaTotalParcelasInput: document.getElementById('metaTotalParcelasInput'),
        metaValorParcelaInput: document.getElementById('metaValorParcelaInput'),
        metaDataInicioFinanciamentoInput: document.getElementById('metaDataInicioFinanciamentoInput'),
        metaMetodoAmortizacaoInput: document.getElementById('metaMetodoAmortizacaoInput'),
        containerFinanciamento: document.getElementById('containerFinanciamento'),
        btnSalvarEdicaoMeta: document.getElementById('btnSalvarEdicaoMeta'),
        btnCancelarEdicaoMeta: document.getElementById('btnCancelarEdicaoMeta'),
        listaMetasAtivas: document.getElementById('listaMetasAtivas'),
        listaMetasConcluidas: document.getElementById('listaMetasConcluidas'),
        metaTabAtivas: document.querySelector('[data-meta-tab="ativas"]'),
        metaTabConcluidas: document.querySelector('[data-meta-tab="concluidas"]'),
        metaTabContentAtivas: document.getElementById('meta-tab-content-ativas'),
        metaTabContentConcluidas: document.getElementById('meta-tab-content-concluidas'),
        metaTabManutencao: document.querySelector('[data-meta-tab="manutencao"]'),
        metaTabContentManutencao: document.getElementById('meta-tab-content-manutencao'),
        listaMetasManutencaoPlano: document.getElementById('listaMetasManutencaoPlano'),
        listaMetasManutencaoKm: document.getElementById('listaMetasManutencaoKm'),
        listaMetasManutencaoConcluidas: document.getElementById('listaMetasManutencaoConcluidas'),
		metaIncluirCustoDiarioCheckbox: document.getElementById('metaIncluirCustoDiarioCheckbox'),

        // --- Perfil Motorista (Recibos) ---
        reciboNomeMotorista: document.getElementById('reciboNomeMotorista'),
        reciboDocumento: document.getElementById('reciboDocumento'),
        reciboPlacaVeiculo: document.getElementById('reciboPlacaVeiculo'),
        usarGpsTracking: document.getElementById('usarGpsTracking'),

        // --- M√≥dulo Financeiro (Sub-Abas) ---
        finTabButtons: document.querySelectorAll('.fin-tab-button'),
        finTabPanes: {
            receita: document.getElementById('fin-tab-content-receita'),
            custos: document.getElementById('fin-tab-content-custos'),
            bancos: document.getElementById('fin-tab-content-bancos'),
            relatorios: document.getElementById('fin-tab-content-relatorios')
        },
        
        // --- M√≥dulo Contas/Bancos (Passo B, H, J, L) ---
        finNomeConta: document.getElementById('fin-modal-nome-conta'),
        finSaldoInicial: document.getElementById('fin-modal-saldo-inicial'),
        finTipoConta: document.getElementById('fin-modal-tipo-conta'),
        finIconeConta: document.getElementById('fin-modal-icone-conta'),
        finIconeUrl: document.getElementById('fin-modal-icone-url'),
        containerCamposConta: document.getElementById('container-campos-conta'),
        containerCamposCredito: document.getElementById('container-campos-credito'),
        finLimiteCartao: document.getElementById('fin-modal-limite-cartao'),
        finDiaVencimento: document.getElementById('fin-modal-dia-vencimento'),
        btnAdicionarConta: document.getElementById('btn-adicionar-conta'),
        finListaContas: document.getElementById('fin-modal-lista-contas'),
        finSaldoConsolidado: document.getElementById('fin-saldo-consolidado'),
        btnAbrirNovaTransacao: document.getElementById('btn-abrir-nova-transacao'),

        // --- M√≥dulo Relat√≥rios (Passo D, F) ---
        reportStartDate: document.getElementById('report-start-date'),
        reportEndDate: document.getElementById('report-end-date'),
        btnGerarRelatorio: document.getElementById('btn-gerar-relatorio'),
        reportTabButtons: document.querySelectorAll('.report-tab-button'),
        reportTabPanes: {
            dre: document.getElementById('report-tab-content-dre'),
            livrocaixa: document.getElementById('report-tab-content-livrocaixa'),
            mei: document.getElementById('report-tab-content-mei')
        },
        dreTableBody: document.getElementById('dre-table-body'),
        lcReceitaBruta: document.getElementById('lc-receita-bruta'),
        lcDespesas: document.getElementById('lc-despesas'),
        lcLucroTributavel: document.getElementById('lc-lucro-tributavel'),
        meiFaturamentoBruto: document.getElementById('mei-faturamento-bruto'),
        meiDespesas: document.getElementById('mei-despesas'),
        meiLucroEvidenciado: document.getElementById('mei-lucro-evidenciado'),
        meiParcelaIsenta: document.getElementById('mei-parcela-isenta'),
        meiRendimentoTributavel: document.getElementById('mei-rendimento-tributavel'),
        
        // --- M√≥dulo Perfil Fiscal (Passo E) ---
        configTipoDeclaracao: document.getElementById('config-tipo-declaracao'),
        containerConfigMei: document.getElementById('container-config-mei'),
        configMeiPercentual: document.getElementById('config-mei-percentual'),
        
        // --- M√≥dulo Contas Recorrentes (Passo K) ---
        contaRecorrenteDescricao: document.getElementById('conta-recorrente-descricao'),
        contaRecorrenteValor: document.getElementById('conta-recorrente-valor'),
        contaRecorrenteVencimento: document.getElementById('conta-recorrente-vencimento'),
        contaRecorrenteCategoria: document.getElementById('conta-recorrente-categoria'),
        btnAdicionarContaRecorrente: document.getElementById('btn-adicionar-conta-recorrente'),
        listaContasRecorrentes: document.getElementById('lista-contas-recorrentes-ul'),
        // listaContasRecorrentes: document.getElementById('listaContasRecorrentes')
    };
   
   // ============================================================================
    // POLYFILL GLOBAL DE IDENTIFICADOR √öNICO ‚Äî COMPATIBILIDADE TOTAL
    // ============================================================================
    if (!window.crypto) {
        window.crypto = {};
    }

    if (!window.crypto.randomUUID) {
        console.warn("‚ö†Ô∏è crypto.randomUUID nativo n√£o encontrado. Polyfill ativado.");

        window.crypto.randomUUID = function () {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0;
                var v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
    }
    // ============================================================================


   // =============================================================
    // ======================= APP STATE ===========================
    // =============================================================
    const AppState = {
        jornadas: {},
        historicoTransacoes: [], 
        promocoesAtivas: [],
        tempImportData: null,
        historicoManutencao: [], 
        cotaManutencao: [],
        postosCombustivel: [],
        
        configuracoes: {
            veiculo: { 
                valor: 0, 
                vidaUtil: 5, 
                autonomia: 0, 
                combustivel: 'Gasolina Comum',
                capacidadeBateria: 0, // <-- ETAPA 2 (NOVO p/ EV)
                custoKWh: 0.80 // <-- ETAPA 2 (NOVO p/ EV)
                
            },
            
            litrosRestantes: 0, // <-- ETAPA 2 (NOVO p/ KmL)
            metodoLeituraCombustivel: 'nivel', // 'nivel' (Padr√£o) ou 'consumo' (Pro)
            cronometroModo: 'liquido', // 'liquido' (Padr√£o), 'bruto' ou 'hibrido'
            
            preferenciasCombustivel: {
                mostrarAnalise: false, // Lembra se o usu√°rio quer ver os gr√°ficos
                tipoPadrao: 'Gasolina Comum'
            },
       
            
            
            custosFixos: [],
            contasRecorrentes: [], // <-- PASSO K
            proLabore: 0,
            diasTrabalhoSemana: 5,
            metaAutonoma: 0,
			manterCalculoKmAntigo: false,
            kmMetaDiaria: 0,
            incluirPrevisaoManutencao: false,
            rateioDinamicoCustos: false, // <-- ETAPA 2 (Movido de Config para AppState)
            // cronometroModo: 'bruto', // 'bruto' (corrido) ou 'liquido' (desconta pausa)
			metasFinanceiras: [], 
           // planoManutencao: [],
            perfilRecibo: {
                nome: '',
                documento: '',
                placa: ''
            },
            perfilFiscal: { // <-- PASSO E
                tipo: 'pf', 
                meiPercentual: 16
            },
            custosVisiveis: false,
            modoDRE: 'presumido', // 'presumido' (padr√£o) ou 'real'
            pagamentosPendentes: [], 
            usarGpsTracking: false,
            contasBancarias: [], // <-- PASSO B
            gpsWatcherId: null,
            gpsLastPosition: null,
            gpsCurrentOdometer: 0,
            isGpsTracking: false,
            subcategorias: { 'Corrida': [], 'Entrega': [], 'Outro': [] }
        },
        dataSelecionada: new Date(),
        cronometro: null,
        onConfirmCallback: null,
        onAlertCallback: null, // Adicionado explicitamente
        linkingMetaToPlanoId: null,
        itemParaEditarId: null,
        isStatusVisible: true,
        custosVisiveis: false,
        isToday: true,
        activeJornadaChave: null,
		lastMetaFieldEdited: null,
        isCalculatingMeta: false,
        lastDescriptions: { 'Entrega': '', 'Outro': '' },
        graficos: {
            ganhosCustos: null,
            categorias: null,
            custos: null,
            metasFinanceiras: null,
            drilldown: null,
            drilldownKm: null,
            gamDashboard: null,
            custoCombustivel: null, // <-- ETAPA 2 (NOVO)
            mediaKmL: null // <-- ETAPA 2 (NOVO)
        },
        currentScheduleModal: null,
        dashboardState: { 
            graficoCategoriaNivel: 'categoria',
            graficoCategoriaPai: null,
            graficoCustoNivel: 'categoria',
            graficoCustoPai: null,
            isRoadmapVisible: false, // <-- ETAPA 2 (NOVO)
            drilldown: {
                active: false,
                type: null,
                category: null,
                subcategory: null
            }
        },
        servicoFinalizadoEmPausa: false,
        custosModalState: {
            data: new Date(),
            acelerador: 0,
            originalAcelerador: 0
        },
        lastSubcategories: { 'Corrida': '', 'Entrega': '', 'Outro': '' },
        descriptionClickCount: 0,
        descriptionClickTimer: null,
        descriptionLongPressTimer: null,
        descriptionHistoryIndex: 0,
        currentDescriptionHistory: [],
        isPendentesVisible: false,
        modalContext: null,
        tempManutencao: null,
        cotacaoState: {
            nomeCliente: '',
            dataInicio: null, 
            dataFim: null,    
            paradas: [], 
            tipoServico: 'Passageiro',
            qtdItens: 0,
            peso: 0,
            distEmbarque: 0,
            distViagem: 0,
            pedagios: 0,
            seguranca: 0,
            semRetorno: false,
            valorKm: 0,
            valorKmRetorno: 0,
            total: 0,
            custosInclusos: [] 
        },
        alertaManutencaoVistoHoje: false,
        visualSettings: {
            theme: 'theme-dark',
            fontSize: 'font-size-base',
            padding: 'padding-base',
            isSaldoCarteiraOculto: false,
            showIconsInCards: false,
            customColors: {
                '--color-cyan': '#22d3ee',
                '--text-primary': '#e2e8f0',
                '--bg-primary': '#1e293b',
                '--bg-secondary': '#0f172a'
            }
        }
    };
  
  // --- VERIFICA√á√ÉO DE BOOT (P√ìS-RELOAD) ---
(function() {
    console.group("üü¢ DEBUG: BOOT DO SISTEMA");
    const idNoDisco = localStorage.getItem('driver_app_jornada_ativa');
    const prefer√™nciaDRE = localStorage.getItem('preferencia_dre');

    console.log("1. Lendo LocalStorage:", { idNoDisco, prefer√™nciaDRE });

    if (idNoDisco) {
        // Se o sistema acordar sem esses dois, o Zumbi est√° aqui!
        console.log("2. Sincronizando AppState com o Disco...");
        // Se essa sincroniza√ß√£o falhar, o bot√£o de servi√ßo n√£o funcionar√°
    } else {
        console.log("2. Nenhuma jornada ativa detectada no Boot.");
    }
    console.groupEnd();
})();

   let metaEmEdicaoId = null;
   
   
// =================================================================
// MOTOR DE FECHAMENTO V144 (FINAL: WATERFALL + PERSIST√äNCIA FOR√áADA)
// =================================================================
const FechamentoJornada = {

    _toCents: (v) => {
        if (v === null || v === undefined) return 0;
        if (typeof v === 'number') return Math.round(v * 100);
        let str = String(v).trim().replace(/\s/g, '').replace(/&nbsp;/g, '').replace('R$', '');
        if (str.includes(',')) str = str.replace(/\./g, '').replace(',', '.');
        str = str.replace(/[^0-9.-]/g, '');
        return Math.round(Number(str) * 100) || 0;
    },

    _toMoney: (c) => c / 100,

    executar: (metasSelecionadasIDs, lucroRealVisual) => {
        console.log("‚öôÔ∏è Motor V144: Iniciando fechamento...");
        
        // 1. Identifica√ß√£o
        const chaveAtiva = AppState.activeJornadaChave || AppState.jornadaAtivaId;
        if (!chaveAtiva || !AppState.jornadas[chaveAtiva]) {
            alert("Erro: Jornada n√£o encontrada na mem√≥ria.");
            return;
        }

        // Snapshot para seguran√ßa
        let snapshot = { ...AppState }; 
        const loteId = 'id-' + Date.now();
        const jornadaKey = chaveAtiva; 
        const dataFechamento = Date.now();

        try {
            const lucroCents = FechamentoJornada._toCents(lucroRealVisual);

            // 2. Processamento Matem√°tico (Waterfall)
            const resRessarcimento = FechamentoJornada.liquidarCustosExternos(snapshot, jornadaKey, loteId, new Date().toISOString());
            const resDistribuicao = FechamentoJornada.distribuirLucro(snapshot, metasSelecionadasIDs || [], lucroCents, jornadaKey, loteId, new Date().toISOString());

            // 3. Atualiza Objeto da Jornada (NA MEM√ìRIA)
            const j = snapshot.jornadas[chaveAtiva];
            j.fimJornada = dataFechamento;
            j.status = 'finalizada'; // <--- O status muda aqui
            j.financeiroFinal = {
                loteId,
                totalRessarcido: FechamentoJornada._toMoney(resRessarcimento.total),
                totalDistribuido: FechamentoJornada._toMoney(resDistribuicao.totalAlocado),
                saldoFinal: FechamentoJornada._toMoney(resDistribuicao.saldoFinal),
                timestamp: Date.now()
            };

            // Atualiza referencias globais
            AppState.historicoTransacoes = snapshot.historicoTransacoes;
            AppState.configuracoes = snapshot.configuracoes;
            AppState.jornadas[chaveAtiva] = j;

            // =========================================================
            // üõë GRAVA√á√ÉO FOR√áADA (V144) - O PULO DO GATO
            // =========================================================
            
            // A. Limpa vari√°veis de sess√£o
            AppState.activeJornadaChave = null;
            AppState.jornadaAtivaId = null;

            // B. Grava direto no LocalStorage (Sem wrappers, sem delay)
            try {
                // Remove marcadores de atividade
                localStorage.removeItem('driver_app_jornada_ativa');
                localStorage.removeItem('jornadaAtivaId');
                localStorage.removeItem('activeJornadaChave_v6.4');

                // Salva os dados pesados
                // (Confirme se suas chaves s√£o essas mesmas, sen√£o ajuste aqui)
                localStorage.setItem('jornadasTrabalho_v6.4', JSON.stringify(AppState.jornadas));
                localStorage.setItem('historicoTransacoes_v6.4', JSON.stringify(AppState.historicoTransacoes));
                localStorage.setItem('configuracoesDiario_v6.4', JSON.stringify(AppState.configuracoes));
                
                console.log("üíæ Dados persistidos com sucesso.");
            } catch (eSave) {
                console.error("Erro de disco:", eSave);
                alert("Erro ao salvar. Tente novamente.");
                return; // N√£o recarrega se deu erro no save
            }

            // 4. Chama a UI final (que vai recarregar a p√°gina)
            FechamentoJornada.posUI(resRessarcimento, resDistribuicao);

        } catch (err) {
            console.error("Erro no fechamento:", err);
            alert("Erro: " + err.message);
        }
    },

    liquidarCustosExternos: (state, jornadaKey, loteId, dataISO) => {
        let total = 0;
        (state.historicoTransacoes || [])
            .filter(t => {
                let dataTransacao = '';
                if (typeof t.data === 'number') dataTransacao = new Date(t.data).toISOString().split('T')[0];
                else if (typeof t.data === 'string') dataTransacao = t.data.split('T')[0];
                const pertenceAoDia = (t.jornadaId === jornadaKey) || (dataTransacao === jornadaKey);
                return pertenceAoDia && t.tipo === 'saida' && t.contaId !== 'AUTO_ID_CARTEIRA' && (t.isCustoOperacional || t.categoria === 'Combustivel');
            })
            .forEach(t => {
                const valor = FechamentoJornada._toCents(t.valor);
                state.historicoTransacoes.push({
                    id: 'sys-' + Date.now() + Math.random(), data: dataISO, tipo: 'transferencia',
                    valor: FechamentoJornada._toMoney(valor), contaId: 'AUTO_ID_CARTEIRA', contaDestino: t.contaId,
                    categoria: 'Liquida√ß√£o de Custos', descricao: `Ressarcimento: ${t.descricao}`, jornadaId: jornadaKey, detalhes: { loteFechamento: loteId }
                });
                total += valor;
            });
        return { total };
    },

    distribuirLucro: (state, metasIDs, saldoInicial, jornadaKey, loteId, dataISO) => {
        let saldo = saldoInicial;
        let totalAlocado = 0;
        const detalhesAlocacao = [];

        // 1. Configura√ß√£o Waterfall
        const metaReserva = state.configuracoes.metasFinanceiras.find(m => m.id === 'AUTO_ID_RESERVA_LUCRO' || m.tipo === 'reserva');
        const metasCascata = state.configuracoes.metasFinanceiras.filter(m => 
            (metasIDs.includes(m.id) || m.id === 'AUTO_ID_PROLABORE') && 
            m.id !== 'AUTO_ID_RESERVA_LUCRO' && m.tipo !== 'reserva'
        );

        const getPeso = (meta) => {
            if (meta.tipo === 'credito') return 100;
            if (meta.tipo === 'parcelamento') return 90;
            if (meta.tipo === 'custo_fixo') return 80;
            if (meta.tipo === 'poupanca_km') return 70;
            if (meta.id === 'AUTO_ID_PROLABORE') return 60;
            return 10;
        };
        metasCascata.sort((a, b) => getPeso(b) - getPeso(a));

        // 2. Execu√ß√£o da Cascata
        metasCascata.forEach(meta => {
            if (saldo <= 0) return;
            let custo = 0;
            if (meta.tipo === 'poupanca_km' && typeof BusinessLogic !== 'undefined') {
                 custo = FechamentoJornada._toCents(BusinessLogic.calcularCustoDiarioMeta(meta, new Date()));
            } else {
                 custo = FechamentoJornada._toCents((meta.valorTotal || 0) / 30);
            }
            if (custo <= 0) return;
            const pago = Math.min(custo, saldo);
            saldo -= pago;
            totalAlocado += pago;
            const valPago = FechamentoJornada._toMoney(pago);
            detalhesAlocacao.push({ nome: meta.descricao, valor: valPago });
            if (meta.tipo === 'parcelamento') meta.valorProvisionado = (meta.valorProvisionado || 0) + valPago;
            else meta.valorAtual = (meta.valorAtual || 0) + valPago;

            state.historicoTransacoes.push({
                id: 'sys-' + Date.now() + Math.random(), data: dataISO, tipo: 'transferencia',
                valor: valPago, contaId: 'AUTO_ID_CARTEIRA', contaDestino: meta.id,
                categoria: 'Metas Financeiras', descricao: `Aloca√ß√£o: ${meta.descricao}`, jornadaId: jornadaKey, detalhes: { loteFechamento: loteId }
            });
        });

        // 3. Overflow para Reserva
        if (saldo > 0 && metaReserva) {
            const sobra = saldo;
            saldo = 0;
            totalAlocado += sobra;
            const valSobra = FechamentoJornada._toMoney(sobra);
            detalhesAlocacao.push({ nome: "Reserva (Sobra)", valor: valSobra });
            metaReserva.valorAtual = (metaReserva.valorAtual || 0) + valSobra;
            state.historicoTransacoes.push({
                id: 'sys-' + Date.now() + Math.random(), data: dataISO, tipo: 'transferencia',
                valor: valSobra, contaId: 'AUTO_ID_CARTEIRA', contaDestino: metaReserva.id,
                categoria: 'Reserva de Lucro', descricao: `Sobra para Reserva`, jornadaId: jornadaKey, detalhes: { loteFechamento: loteId }
            });
        }
        return { totalAlocado, saldoFinal: saldo, detalhes: detalhesAlocacao };
    },

    posUI: (ress, dist) => {
        if (typeof TimeManager !== 'undefined') TimeManager.pararCronometro();
        const modal = document.getElementById('modalContainer');
        if (modal) { modal.innerHTML = ''; modal.classList.add('hidden'); }

        const format = (v) => Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        let msg = '\nüì¶ Distribui√ß√£o:\n';
        if (dist.detalhes) dist.detalhes.forEach(d => msg += `‚úÖ ${d.nome}: ${format(d.valor)}\n`);

        // Pequeno delay para garantir que o Alert n√£o bloqueie a thread antes do render
        setTimeout(() => {
            alert(`üèÅ Jornada Finalizada com Sucesso!\n\n` +
                  `üí∏ Ressarcidos: ${format(FechamentoJornada._toMoney(ress.total))}\n` +
                  msg + 
                  `\nüíµ Livre: ${format(FechamentoJornada._toMoney(dist.saldoFinal))}`);
            
            location.reload();
        }, 100);
    }
};
   
/*    
// =================================================================
// MOTOR DE FECHAMENTO V8.6 (CORRE√á√ÉO DE DATA TIMESTAMP)
// Cole logo ap√≥s o const Utils = { ... }
// =================================================================
const FechamentoJornada = {

    _toCents: (v) => {
        if (v === null || v === undefined) return 0;
        if (typeof v === 'number') return Math.round(v * 100);
        let str = String(v).trim().replace(/\s/g, '').replace(/&nbsp;/g, '').replace('R$', '');
        if (str.includes(',')) str = str.replace(/\./g, '').replace(',', '.');
        str = str.replace(/[^0-9.-]/g, '');
        return Math.round(Number(str) * 100) || 0;
    },

    _toMoney: (c) => c / 100,

    executar: (metasSelecionadasIDs, lucroRealVisual) => {
        console.log("‚öôÔ∏è Motor v8.6: Iniciando...");
        
        const chaveAtiva = AppState.activeJornadaChave;
        if (!chaveAtiva || !AppState.jornadas[chaveAtiva]) {
            alert("Erro Cr√≠tico: Refer√™ncia da jornada perdida. Recarregue.");
            return;
        }

        // Snapshot
        let snapshot = { ...AppState }; 
        
        const loteId = 'id-' + Date.now();
        const d = new Date(AppState.jornadas[chaveAtiva].inicioJornada || new Date());
        const jornadaKey = d.toISOString().split('T')[0]; // YYYY-MM-DD
        const dataFechamento = new Date().toISOString();

        try {
            const lucroCents = FechamentoJornada._toCents(lucroRealVisual);

            // Processamento
            const resRessarcimento = FechamentoJornada.liquidarCustosExternos(snapshot, jornadaKey, loteId, dataFechamento);
            const resDistribuicao = FechamentoJornada.distribuirLucro(snapshot, metasSelecionadasIDs || [], lucroCents, jornadaKey, loteId, dataFechamento);

            // Finaliza Jornada
            const j = snapshot.jornadas[chaveAtiva];
            j.fimJornada = dataFechamento;
            j.status = 'finalizada';
            j.financeiroFinal = {
                loteId,
                totalRessarcido: FechamentoJornada._toMoney(resRessarcimento.total),
                totalDistribuido: FechamentoJornada._toMoney(resDistribuicao.totalAlocado),
                saldoFinal: FechamentoJornada._toMoney(resDistribuicao.saldoFinal),
                timestamp: Date.now()
            };

            // Salva Estado
            AppState.historicoTransacoes = snapshot.historicoTransacoes;
            AppState.configuracoes = snapshot.configuracoes;
            AppState.jornadas[chaveAtiva] = j;
            AppState.activeJornadaChave = null;

            if (typeof Storage !== 'undefined' && Storage.salvarDados) {
                Storage.salvarDados();
            } else {
                localStorage.setItem('driver_app_data', JSON.stringify(AppState));
            }

            FechamentoJornada.posUI(resRessarcimento, resDistribuicao);

        } catch (err) {
            console.error("Erro no fechamento:", err);
            alert("Erro: " + err.message);
        }
    },

    liquidarCustosExternos: (state, jornadaKey, loteId, dataISO) => {
        let total = 0;
        
        (state.historicoTransacoes || [])
            .filter(t => {
                // üõ°Ô∏è CORRE√á√ÉO DO ERRO t.data.startsWith üõ°Ô∏è
                let dataTransacao = '';
                
                // Se for n√∫mero (Timestamp), converte para YYYY-MM-DD
                if (typeof t.data === 'number') {
                    dataTransacao = new Date(t.data).toISOString().split('T')[0];
                } 
                // Se for String ISO, corta
                else if (typeof t.data === 'string') {
                    dataTransacao = t.data.split('T')[0];
                }

                // Verifica se pertence ao dia (pelo ID ou pela Data)
                const pertenceAoDia = (t.jornadaId === jornadaKey) || (dataTransacao === jornadaKey);
                
                return pertenceAoDia && t.tipo === 'saida' && t.contaId !== 'AUTO_ID_CARTEIRA' && (t.isCustoOperacional || t.categoria === 'Combustivel');
            })
            .forEach(t => {
                const valor = FechamentoJornada._toCents(t.valor);
                state.historicoTransacoes.push({
                    id: 'sys-' + Date.now() + Math.random(),
                    data: dataISO,
                    tipo: 'transferencia',
                    valor: FechamentoJornada._toMoney(valor),
                    contaId: 'AUTO_ID_CARTEIRA',
                    contaDestino: t.contaId,
                    categoria: 'Liquida√ß√£o de Custos',
                    descricao: `Ressarcimento: ${t.descricao}`,
                    jornadaId: jornadaKey,
                    detalhes: { loteFechamento: loteId }
                });
                total += valor;
            });
        return { total };
    },

    distribuirLucro: (state, metasIDs, saldoInicial, jornadaKey, loteId, dataISO) => {
        let saldo = saldoInicial;
        let totalAlocado = 0;
        const detalhesAlocacao = [];

        const metas = state.configuracoes.metasFinanceiras.filter(m => 
            metasIDs.includes(m.id) || m.id === 'AUTO_ID_PROLABORE'
        );

        metas.sort((a, b) => {
            const p = { parcelamento: 4, custo_fixo: 3, salario: 2, poupanca: 1 };
            return (p[b.tipo] || 0) - (p[a.tipo] || 0);
        });

        metas.forEach(meta => {
            if (saldo <= 0) return;

            let custo = FechamentoJornada._toCents((meta.valorTotal || 0) / 30);
            if (typeof BusinessLogic !== 'undefined' && BusinessLogic.calcularCustoDiarioMeta) {
                custo = FechamentoJornada._toCents(BusinessLogic.calcularCustoDiarioMeta(meta, new Date()));
            }

            if (custo <= 0) return;

            const pago = Math.min(custo, saldo);
            saldo -= pago;
            totalAlocado += pago;

            const valPago = FechamentoJornada._toMoney(pago);
            detalhesAlocacao.push({ nome: meta.descricao, valor: valPago });

            if (meta.tipo === 'parcelamento') meta.valorProvisionado = (meta.valorProvisionado || 0) + valPago;
            else meta.valorAtual = (meta.valorAtual || 0) + valPago;

            state.historicoTransacoes.push({
                id: 'sys-' + Date.now() + Math.random(),
                data: dataISO,
                tipo: 'transferencia',
                valor: valPago,
                contaId: 'AUTO_ID_CARTEIRA',
                contaDestino: meta.id,
                categoria: 'Metas Financeiras',
                descricao: `Aloca√ß√£o: ${meta.descricao}`,
                jornadaId: jornadaKey,
                detalhes: { loteFechamento: loteId }
            });
        });

        return { totalAlocado, saldoFinal: saldo, detalhes: detalhesAlocacao };
    },

    posUI: (ress, dist) => {
        if (typeof TimeManager !== 'undefined') TimeManager.pararCronometro();
        const modal = document.getElementById('modalContainer');
        if (modal) { modal.innerHTML = ''; modal.classList.add('hidden'); }

        const format = (v) => Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        let msg = '\nüì¶ Distribui√ß√£o:\n';
        if (dist.detalhes) dist.detalhes.forEach(d => msg += `‚úÖ ${d.nome}: ${format(d.valor)}\n`);

        setTimeout(() => {
            alert(`üèÅ Jornada Finalizada!\n\n` +
                  `üí∏ Ressarcidos: ${format(FechamentoJornada._toMoney(ress.total))}\n` +
                  msg + 
                  `\nüíµ Livre: ${format(FechamentoJornada._toMoney(dist.saldoFinal))}`);
            
            location.reload();
        }, 100);
    }
};


 */
// =============================================================
// ======================= UTILS V8.4 (GOLDEN MASTER + FIX) ====
// =============================================================
const Utils = {
    // -------------------------------------------------------------
    // 1. N√öCLEO MATEM√ÅTICO BLINDADO
    // -------------------------------------------------------------
    Money: {
        toCents: (v) => {
            if (v === null || v === undefined) return 0;
            if (typeof v === 'number') return Math.round(v * 100);
            let str = String(v).trim().replace(/\s/g, '').replace(/&nbsp;/g, '');
            if (str.includes(',')) str = str.replace(/\./g, '').replace(',', '.');
            str = str.replace(/[^0-9.-]/g, '');
            const result = Math.round(Number(str) * 100);
            return isNaN(result) ? 0 : result;
        },
        fromCents: (c) => c / 100,
        add: (a, b) => (Utils.Money.toCents(a) + Utils.Money.toCents(b)) / 100,
        sub: (a, b) => (Utils.Money.toCents(a) - Utils.Money.toCents(b)) / 100,
        mul: (a, b) => Math.round(Utils.Money.toCents(a) * Number(b)) / 100,
        div: (a, b) => {
            const divisor = Number(b);
            return divisor === 0 ? 0 : Math.round(Utils.Money.toCents(a) / divisor) / 100;
        },
        subtract: (a, b) => Utils.Money.sub(a, b),
        multiply: (a, b) => Utils.Money.mul(a, b),
        divide: (a, b) => Utils.Money.div(a, b),
        addCents: (a, b) => Number(a || 0) + Number(b || 0),
        sumArray: (arr, inputIsCents = false) => {
            if (!Array.isArray(arr)) return 0;
            const totalCents = arr.reduce((acc, val) => {
                const v = inputIsCents ? Number(val || 0) : Utils.Money.toCents(val);
                return acc + v;
            }, 0);
            return inputIsCents ? totalCents : Utils.Money.fromCents(totalCents);
        }
    },

    somarCentavos: (a, b) => Utils.Money.add(a, b),
    parseMoeda: (valor) => Utils.Money.fromCents(Utils.Money.toCents(valor)),

    // -------------------------------------------------------------
    // 2. DATA E TEMPO (COM RESOLVER PERIODO INTEGRADO)
    // -------------------------------------------------------------
    
    // *** NOVA FUN√á√ÉO INTEGRADA AQUI ***
    resolverPeriodo: ({ tipo, ano, mes, dia }) => {
        ano = Number(ano);
        mes = Number(mes);
        dia = Number(dia);
/*
        if (tipo === 'dia') {
            const d = new Date(ano, mes, dia);
            return {
                inicio: new Date(d.setHours(0,0,0,0)),
                fim: new Date(d.setHours(23,59,59,999))
            };
        }
        */
        if (tipo === 'dia') {
            // Criamos uma data limpa (sem minutos/segundos residuais do sistema)
            const d = new Date(ano, mes, dia, 0, 0, 0, 0);
            return {
                inicio: new Date(d.getTime()), // 00:00:00
                fim: new Date(d.setHours(23, 59, 59, 999)) // 23:59:59
            };
        }
        if (tipo === 'mes') {
            return {
                inicio: new Date(ano, mes, 1, 0, 0, 0),
                fim: new Date(ano, mes + 1, 0, 23, 59, 59, 999)
            };
        }
        if (tipo === 'ano') {
            return {
                inicio: new Date(ano, 0, 1, 0, 0, 0),
                fim: new Date(ano, 11, 31, 23, 59, 59, 999)
            };
        }
    },

    formatarDataParaChave: (date) => {
        if (!date) return '';
        if (date instanceof Date) return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        if (typeof date === 'number') { const d = new Date(date); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
        if (typeof date === 'string') {
            if (date.match(/^\d{4}-\d{2}-\d{2}$/)) return date;
            if (date.includes('T')) return date.split('T')[0];
            if (date.includes('/')) { const p = date.split('/'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; }
        }
        const d = new Date(date);
        return !isNaN(d.getTime()) ? `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}` : ''; 
    },
    getDateISO: (d) => Utils.formatarDataParaChave(d),
    getDataInputHoje: () => { const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().split('T')[0]; },
    
    formatarDataParaDisplay: (d) => {
        if (!d) return '-';
        if (typeof d === 'string' && d.includes('-')) { const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
        const date = new Date(d);
        return isNaN(date.getTime()) ? d : date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    },
    
    formatarHora: (ts) => {
        const d = new Date(ts);
        return isNaN(d.getTime()) ? '--:--' : d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    },
    
    formatarDuracao: (ms, mostrarSegundos = true) => {
        if (isNaN(ms) || ms < 0) return mostrarSegundos ? '00:00:00' : '00:00';
        const totalSegundos = Math.floor(ms / 1000);
        const h = String(Math.floor(totalSegundos / 3600)).padStart(2, '0');
        const m = String(Math.floor((totalSegundos % 3600) / 60)).padStart(2, '0');
        if (!mostrarSegundos) return `${h}:${m}`;
        const s = String(totalSegundos % 60).padStart(2, '0');
        return `${h}:${m}:${s}`;
    },
    
    getDaysInMonth: (ano, mes) => new Date(ano, mes + 1, 0).getDate(),

    // -------------------------------------------------------------
    // 3. FORMATA√á√ÉO VISUAL E INPUTS
    // -------------------------------------------------------------
    formatarMoeda: (valor) => Number(valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
    formatarMoedaParaInput: (valor) => (!valor && valor !== 0) ? '' : Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2, useGrouping: false }).replace('.', ','),
    formatarMoedaPorKmParaInput: (valor) => (!valor && valor !== 0) ? '' : Number(valor).toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 5, useGrouping: false }).replace('.', ','),
    formatarMoedaPorKm: (valor) => `${Number(valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}/km`,
    formatarDistancia: (km) => `${Math.round(km || 0).toLocaleString('pt-BR')} km`,
    
    mascaraMoeda: (input) => {
        let value = input.value.replace(/\D/g, '');
        value = (Number(value) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        input.value = value;
    },

    // -------------------------------------------------------------
    // 4. IDENTIFICADORES E SEGURAN√áA
    // -------------------------------------------------------------
    gerarUUID: () => {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) { try { return crypto.randomUUID(); } catch(e){} }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = (Date.now() + Math.random() * 16) % 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    },
    gerarId: () => Utils.gerarUUID(),

    escapeHTML: (str) => String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'),
    normalizarTexto: (t) => t ? t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() : "",

    // -------------------------------------------------------------
    // 5. L√ìGICA DE NEG√ìCIO (√çCONES E NOMES)
    // -------------------------------------------------------------
    getIconeSubcategoria: (categoriaPai, subNome) => {
        if (!window.AppState?.configuracoes?.subcategorias) return '‚öôÔ∏è';
        const subs = AppState.configuracoes.subcategorias[categoriaPai] || [];
        const subConfig = subs.find(s => (typeof s === 'string' ? s : s.nome) === subNome);
        if (subConfig && typeof subConfig === 'object' && subConfig.icone) {
            const icone = subConfig.icone;
            if (icone.startsWith('http') || icone.startsWith('data:image')) {
                return `<img src="${icone}" alt="icon" class="w-6 h-6 rounded-full object-cover flex-shrink-0 border border-slate-500">`;
            }
            const map = (typeof RoadmapRenderer !== 'undefined' ? RoadmapRenderer.iconMap : {}) || {};
            return map[`banco-${icone}`] || map[icone] || icone;
        }
        if (categoriaPai === 'Corrida') return 'üöó';
        if (categoriaPai === 'Entrega') return 'üì¶';
        return '‚öôÔ∏è';
    },

    getNomeConta: (id) => {
        if (!id) return '---';
        if (id === 'carteira_motorista' || id === 'AUTO_ID_CARTEIRA') return 'üíµ Carteira (Caixa Di√°rio)';
        if (String(id).startsWith('FATURA_')) return 'üßæ Fatura Cart√£o';
        if (!window.AppState?.configuracoes) return 'Desconhecido';
        const contas = AppState.configuracoes.contasBancarias || [];
        const conta = contas.find(c => c.id === id);
        if (conta) return conta.tipo === 'credito' ? `üí≥ ${conta.nome}` : `üè¶ ${conta.nome}`;
        const metas = AppState.configuracoes.metasFinanceiras || [];
        const meta = metas.find(m => m.id === id);
        if (meta) return `üì¶ ${meta.descricao}`;
        return 'Desconhecido';
    },

    // -------------------------------------------------------------
    // 6. COMBUST√çVEL E EFICI√äNCIA
    // -------------------------------------------------------------
    getUnidadeCombustivel: (tipo, plural = false) => {
        const t = (tipo || '').toLowerCase();
        if (t.includes('el√©trico')) return 'kWh';
        if (t.includes('gnv')) return 'm¬≥';
        return plural ? 'Litros' : 'Litro';
    },
    
    formatarEficiencia: (v, tipo) => {
        const u = Utils.getUnidadeCombustivel(tipo);
        const val = (v || 0).toFixed(2);
        return u === 'kWh' ? `${val} km/kWh` : u === 'm¬≥' ? `${val} km/m¬≥` : `${val} km/L`;
    },

    // -------------------------------------------------------------
    // 7. IMAGEM E UTILIT√ÅRIOS GERAIS
    // -------------------------------------------------------------
    otimizarImagem: (file, callback) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 300; 
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL('image/jpeg', 0.7)); 
            };
        };
    },
    comprimirImagemParaStorage: (f, c) => Utils.otimizarImagem(f, c),

    debounce: (func, delay) => {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    },

    getContrastingTextColor: (hex) => {
        if (!hex) return '#FFFFFF';
        hex = hex.replace("#", "");
        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
        const r = parseInt(hex.substr(0, 2), 16), g = parseInt(hex.substr(2, 2), 16), b = parseInt(hex.substr(4, 2), 16);
        return (((r * 299) + (g * 587) + (b * 114)) / 1000) >= 128 ? '#000000' : '#FFFFFF';
    },

    // -------------------------------------------------------------
    // 8. C√ÅLCULOS FINANCEIROS AVAN√áADOS
    // -------------------------------------------------------------
    normalizeTransaction: (t) => {
        if (!t || typeof t !== 'object') return t;
        t.data = Utils.parseDataSegura(t.data);
        t.valor = Utils.Money.fromCents(Utils.Money.toCents(t.valor));
        t.tipo = t.tipo || 'entrada';
        t.contaId = t.contaId || 'conta_padrao';
        t.detalhes = t.detalhes || {};
        if(t.detalhes.leg) t.detalhes.leg = String(t.detalhes.leg).toLowerCase();
        t._dreProcessed = t._dreProcessed || {};
        return t;
    },

    parseDataSegura: (valor) => {
        if (!valor) return Date.now();
        if (typeof valor === 'number') return valor;
        if (typeof valor === 'string' && valor.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return new Date(valor + 'T12:00:00').getTime();
        }
        const dt = new Date(valor);
        return isNaN(dt.getTime()) ? Date.now() : dt.getTime();
    },
    markTransactionAsProcessedForDre: (t, periodKey) => {
        t._dreProcessed = t._dreProcessed || {};
        t._dreProcessed[periodKey] = Date.now();
    },

    calcularValorFuturo: (valorInicial, contribuicaoMensal, taxaJurosMensal, prazoMeses) => {
        if (prazoMeses <= 0) return valorInicial;
        if (taxaJurosMensal === 0) return valorInicial + (contribuicaoMensal * prazoMeses);
        const fvPV = valorInicial * Math.pow(1 + taxaJurosMensal, prazoMeses);
        const fvPMT = contribuicaoMensal * ((Math.pow(1 + taxaJurosMensal, prazoMeses) - 1) / taxaJurosMensal);
        return fvPV + fvPMT;
    },
    
    calcularContribuicaoMensal: (valorInicial, valorObjetivo, taxaJurosMensal, prazoMeses) => {
        if (prazoMeses <= 0) return 0;
        if (taxaJurosMensal === 0) {
            if (valorObjetivo <= valorInicial) return 0;
            return (valorObjetivo - valorInicial) / prazoMeses;
        }
        const fvPV = valorInicial * Math.pow(1 + taxaJurosMensal, prazoMeses);
        if (fvPV >= valorObjetivo) return 0;
        const numerator = (valorObjetivo - fvPV) * taxaJurosMensal;
        const denominator = Math.pow(1 + taxaJurosMensal, prazoMeses) - 1;
        return numerator / denominator;
    },

    toBRL: (v) => Number(v).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}),

    addMonths: (date, months) => {
        const d = new Date(date);
        const day = d.getDate();
        d.setMonth(d.getMonth() + months);
        if (d.getDate() !== day) d.setDate(0);
        return d;
    },
    daysBetween: (a, b) => {
        const A = new Date(a.getFullYear(), a.getMonth(), a.getDate());
        const B = new Date(b.getFullYear(), b.getMonth(), b.getDate());
        return Math.round((B - A) / (1000 * 60 * 60 * 24));
    },

    genPriceSchedule: (P, i_m, n, startDate, PMT_opcional = 0) => {
        const i = i_m / 100;
        const schedule = [];
        let saldo = P;
        if (i === 0) {
            const PMT = (PMT_opcional && PMT_opcional > 0) ? PMT_opcional : (P / n);
            for (let k = 1; k <= n; k++) {
                const due = Utils.addMonths(new Date(startDate), k);
                saldo = Math.max(0, saldo - PMT);
                schedule.push({ num: k, due, juros: 0, amort: PMT, pmt: PMT, saldo });
            }
            return { PMT, schedule };
        }
        const denom = Math.pow(1 + i, n) - 1;
        const PMT_calculado = denom === 0 ? 0 : P * (i * Math.pow(1 + i, n)) / denom;
        const PMT = (PMT_opcional && PMT_opcional > 0) ? PMT_opcional : PMT_calculado;

        for (let k = 1; k <= n; k++) {
            const juros = saldo * i;
            const amort = PMT - juros;
            const due = Utils.addMonths(new Date(startDate), k);
            saldo = Math.max(0, saldo - amort);
            schedule.push({ num: k, due, juros, amort, pmt: PMT, saldo });
        }
        return { PMT, schedule };
    },

    genSAC: (P, i_m, n, startDate) => {
        const i = i_m / 100;
        const amortConst = P / n;
        let saldo = P; 
        const schedule = [];
        for (let k = 1; k <= n; k++) {
            const juros = saldo * i;
            const parcela = amortConst + juros;
            const due = Utils.addMonths(new Date(startDate), k);
            saldo = Math.max(0, saldo - amortConst);
            schedule.push({ num: k, due, juros, amort: amortConst, pmt: parcela, saldo });
        }
        const avg = schedule.reduce((s, p) => s + p.pmt, 0) / n;
        return { PMT: avg, schedule };
    },

    pvOfSelected: (schedule, selectedNums, dateRef, rate, isDaily = false) => {
        let pv = 0;
        let r = isDaily ? rate : (Math.pow(1 + rate / 100, 1 / 30) - 1);
        for (const it of schedule) {
            if (!selectedNums.includes(it.num)) continue;
            const days = Utils.daysBetween(dateRef, it.due);
            const factor = days > 0 ? Math.pow(1 + r, days) : 1;
            pv += it.pmt / factor;
        }
        return pv;
    },

    descobrirTaxaJuros: (P, PMT, n) => {
        if (PMT <= P / n) return 0;
        let i = 0.1; 
        let iter = 0;
        while (iter++ < 100) {
            const ip1 = 1 + i;
            const ip1n = Math.pow(ip1, n);
            const f = P * i * ip1n - PMT * (ip1n - 1);
            const df = P * (ip1n + n * i * Math.pow(ip1, n - 1)) - PMT * n * Math.pow(ip1, n - 1);
            if (Math.abs(df) < 1e-10) break;
            const newI = i - f / df;
            if (!Number.isFinite(newI)) break;
            if (Math.abs(newI - i) < 1e-7) return newI;
            i = newI;
        }
        return 0;
    }
};
 
 // =============================================================
    // ======================= SYSTEM LOG (DEBUG) ==================
    // =============================================================
    const SystemLog = {
        // Mude para FALSE quando for entregar para o usu√°rio final
        isActive: true, 

        info: (origem, acao, dados = '') => {
            if (!SystemLog.isActive) return;
            const hora = new Date().toLocaleTimeString();
            console.log(`%c[${hora}] ‚ÑπÔ∏è ${origem}:`, 'color: #22d3ee; font-weight: bold;', acao, dados);
        },

        success: (origem, mensagem) => {
            if (!SystemLog.isActive) return;
            console.log(`%c‚úÖ ${origem}: ${mensagem}`, 'color: #4ade80; font-weight: bold;');
        },

        error: (origem, erro) => {
            // Erros a gente sempre mostra, mesmo com debug desligado (opcional)
            console.error(`%c‚ùå ERRO em ${origem}:`, 'color: #f87171; font-weight: bold;', erro);
        },
        
        warn: (origem, mensagem) => {
            if (!SystemLog.isActive) return;
            console.warn(`‚ö†Ô∏è ${origem}: ${mensagem}`);
        }
    };
    
// =============================================================
    // ======================= STORAGE V7.2 (GOLDEN MASTER) ========
    // =============================================================
    const Storage = {
        KEYS: {
            CONFIG: 'configuracoesDiario_v6.4',
            HISTORICO: 'historicoTransacoes_v6.4', // Chave Oficial
            JORNADAS: 'jornadasTrabalho_v6.4',
            MANUTENCAO: 'historicoManutencao_v6.4',
            COTA: 'cotaManutencao_v6.4',
            POSTOS: 'postosCombustivel_v6.4',
            // Chaves Auxiliares (UX)
            PROMOCOES: 'promocoesAtivas_v6.4',
            LAST_DESC: 'lastDescriptions_v6.4',
            LAST_SUB: 'lastSubcategories_v6.4'
        },

        // --- VACINA 3: Wrapper Seguro contra Quota Exceeded ---
        _safeSave: (key, data) => {
            try {
                const stringData = JSON.stringify(data);
                localStorage.setItem(key, stringData);
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    alert("‚ö†Ô∏è MEM√ìRIA CHEIA!\n\nO limite do navegador foi atingido. Tente limpar dados antigos ou excluir fotos de postos.");
                    console.error("[STORAGE CRITICAL] Quota Exceeded.");
                } else {
                    console.error(`[STORAGE ERROR] Falha ao salvar em ${key}:`, e);
                }
            }
        },
// ============================================================================
// STORAGE: carregarDados (V155.0 - VERS√ÉO BLINDADA E COMPLETA)
// ============================================================================
carregarDados: () => {
    console.group("üöÄ [STORAGE] Inicializando Carga de Dados");

    // 1. üõ°Ô∏è BLINDAGEM IMEDIATA DE PREFER√äNCIAS
    // L√™ as prefer√™ncias leves do LocalStorage antes de processar os dados pesados.
    AppState.modoDRE = localStorage.getItem('preferencia_dre') || 'presumido';

    // 2. üö® REANIMADOR DE EMERG√äNCIA (O EXTERMINADOR DE ZUMBIS)
    // Tenta identificar se existe uma jornada ativa no LocalStorage.
    let chaveAtivaDetectada = localStorage.getItem('driver_app_jornada_ativa');
    
    // Se a chave estiver ausente ou nula, fazemos uma inspe√ß√£o profunda no JSON de jornadas.
    if (!chaveAtivaDetectada || chaveAtivaDetectada === "null" || chaveAtivaDetectada === "undefined") {
        const hojeIso = Utils.getDataInputHoje(); // Ex: "2025-12-30"
        const jornadasSalvasNoDisco = localStorage.getItem(Storage.KEYS.JORNADAS);
        
        if (jornadasSalvasNoDisco) {
            try {
                const objetoJornadas = JSON.parse(jornadasSalvasNoDisco);
                // Se a jornada de hoje existe e est√° marcada como 'ativa', recuperamos a chave.
                if (objetoJornadas[hojeIso] && objetoJornadas[hojeIso].status === 'ativa') {
                    console.warn("üßü [REANIMADOR] Chave operacional restaurada via inspe√ß√£o de JSON.");
                    chaveAtivaDetectada = hojeIso;
                    localStorage.setItem('driver_app_jornada_ativa', hojeIso);
                    localStorage.setItem('activeJornadaChave_v6.4', hojeIso);
                }
            } catch (erroJson) {
                console.error("‚ùå [STORAGE] Falha ao pr√©-analisar JSON de jornadas:", erroJson);
            }
        }
    }

    // Define o modo operacional GLOBAL imediatamente para destravar a UI e o cron√¥metro.
    if (chaveAtivaDetectada && chaveAtivaDetectada !== "null" && chaveAtivaDetectada !== "undefined") {
        AppState.modo = 'jornada_ativa';
        AppState.activeJornadaChave = chaveAtivaDetectada;
        console.log("üíâ [STATUS] Modo 'jornada_ativa' injetado com sucesso.");
    } else {
        AppState.modo = 'inativa';
        console.log("üí§ [STATUS] Sistema iniciando em modo ocioso.");
    }

    try {
        // Fun√ß√£o auxiliar para parsing seguro (Garante que o App n√£o quebre se o JSON estiver corrompido)
        const safeParse = (chaveLocalStorage, valorPadrao) => {
            const dadoBruto = localStorage.getItem(chaveLocalStorage);
            if (!dadoBruto || dadoBruto === "undefined" || dadoBruto === "null") {
                return structuredClone(valorPadrao);
            }
            try {
                const dadoConvertido = JSON.parse(dadoBruto);
                return dadoConvertido ?? structuredClone(valorPadrao);
            } catch (erroParse) {
                console.warn(`‚ö†Ô∏è [STORAGE] JSON corrompido na chave ${chaveLocalStorage}. Resetando para o padr√£o.`);
                return structuredClone(valorPadrao);
            }
        };

        // =========================================================
        // 3. MIGRA√á√ÉO DE DADOS LEGADOS
        // =========================================================
        (() => {
            const CHAVE_ANTIGA = 'app_historico_transacoes';
            const CHAVE_NOVA = Storage.KEYS.HISTORICO;
            const dadosLegadosRaw = localStorage.getItem(CHAVE_ANTIGA);
            
            if (dadosLegadosRaw) {
                try {
                    const historicoAntigo = JSON.parse(dadosLegadosRaw);
                    const historicoAtual = safeParse(CHAVE_NOVA, []);
                    
                    // S√≥ migra se o hist√≥rico novo estiver vazio
                    if (Array.isArray(historicoAntigo) && historicoAntigo.length > 0 && historicoAtual.length === 0) {
                        console.info('[MIGRA√á√ÉO] Promovendo transa√ß√µes legadas para a vers√£o est√°vel.');
                        localStorage.setItem(CHAVE_NOVA, JSON.stringify(historicoAntigo));
                    }
                } catch (e) {
                    console.error('[MIGRA√á√ÉO] Erro ao processar dados legados.');
                }
                localStorage.removeItem(CHAVE_ANTIGA);
            }
        })();

        // =========================================================
        // 4. CARREGAMENTO DAS COLE√á√ïES PRINCIPAIS
        // =========================================================
        AppState.jornadas = safeParse(Storage.KEYS.JORNADAS, {});
        AppState.historicoTransacoes = safeParse(Storage.KEYS.HISTORICO, []);
        AppState.historicoManutencao = safeParse(Storage.KEYS.MANUTENCAO, []);
        AppState.cotaManutencao = safeParse(Storage.KEYS.COTA, []);
        AppState.postosCombustivel = safeParse(Storage.KEYS.POSTOS, []);
        
        // Estados Auxiliares e Mem√≥ria de Contexto
        AppState.promocoesAtivas = safeParse(Storage.KEYS.PROMOCOES, []);
        AppState.lastDescriptions = safeParse(Storage.KEYS.LAST_DESC, { 'Entrega': '', 'Outro': '' });
        AppState.lastSubcategories = safeParse(Storage.KEYS.LAST_SUB, { 'Corrida': '', 'Entrega': '', 'Outro': '' });

        // =========================================================
        // 5. CARREGAMENTO E MERGE DE CONFIGURA√á√ïES
        // =========================================================
        const configSalva = safeParse(Storage.KEYS.CONFIG, null);
        
        if (configSalva) {
            // Aplicamos um merge cuidadoso para n√£o perder propriedades novas inseridas no AppState inicial
            AppState.configuracoes = {
                ...AppState.configuracoes,
                ...configSalva,
                veiculo: { ...AppState.configuracoes.veiculo, ...(configSalva.veiculo || {}) },
                perfilRecibo: { ...AppState.configuracoes.perfilRecibo, ...(configSalva.perfilRecibo || {}) },
                perfilFiscal: { ...AppState.configuracoes.perfilFiscal, ...(configSalva.perfilFiscal || {}) }
            };

            // Sanitiza√ß√£o de listas de configura√ß√£o
            AppState.configuracoes.custosFixos = Array.isArray(configSalva.custosFixos) ? configSalva.custosFixos : [];
            AppState.configuracoes.metasFinanceiras = Array.isArray(configSalva.metasFinanceiras) ? configSalva.metasFinanceiras : [];
            AppState.configuracoes.contasBancarias = Array.isArray(configSalva.contasBancarias) ? configSalva.contasBancarias : [];
            AppState.configuracoes.planoManutencao = Array.isArray(configSalva.planoManutencao) ? configSalva.planoManutencao : [];
        }

        // =========================================================
        // 6. SANITIZA√á√ÉO E DEDUPLICA√á√ÉO DE TRANSA√á√ïES (FIREWALL)
        // =========================================================
        if (Array.isArray(AppState.historicoTransacoes)) {
            const idsProcessados = new Set();
            AppState.historicoTransacoes = AppState.historicoTransacoes.map(transacao => {
                // Normaliza datas e valores
                transacao.data = Utils.formatarDataParaChave(transacao.data) || Utils.getDataInputHoje();
                transacao.valor = Number(transacao.valor) || 0;
                
                // Garante ID √∫nico para evitar erros de renderiza√ß√£o em listas
                if (!transacao.id || idsProcessados.has(transacao.id)) {
                    transacao.id = Utils.gerarUUID ? Utils.gerarUUID() : `fix-${Date.now()}-${Math.random()}`;
                }
                idsProcessados.add(transacao.id);
                return transacao;
            }).filter(t => !isNaN(t.valor));
        }

        // =========================================================
        // 7. SINCRONIA FINAL DE REFER√äNCIA (O ELO PERDIDO)
        // =========================================================
        // Conecta o ponteiro AppState.jornadaAtiva diretamente ao objeto dentro da cole√ß√£o.
        if (AppState.activeJornadaChave && AppState.jornadas[AppState.activeJornadaChave]) {
            AppState.jornadaAtiva = AppState.jornadas[AppState.activeJornadaChave];
            console.info(`üîó [SINCRONIA] Motor conectado √† jornada: ${AppState.activeJornadaChave}`);
            
            // Reativa√ß√£o autom√°tica do Cron√¥metro se a jornada estiver ativa
            if (AppState.jornadaAtiva.status === 'ativa' && typeof TimeManager !== 'undefined') {
                setTimeout(() => {
                    if (!TimeManager.rodando) TimeManager.iniciarCronometro();
                }, 500);
            }
        }

        // Inicializa√ß√£o de l√≥gicas autom√°ticas
        BusinessLogic.inicializarCaixinhasAutomaticas();
        
        console.info('‚úÖ [STORAGE] Sistema carregado, sincronizado e blindado.');

    } catch (erroFatal) {
        console.error('‚ùå [STORAGE FATAL] Falha catastr√≥fica ao carregar dados:', erroFatal);
        // Fallback para evitar tela branca: Reinicia as cole√ß√µes b√°sicas como objetos vazios
        AppState.jornadas = AppState.jornadas || {};
        AppState.historicoTransacoes = AppState.historicoTransacoes || [];
    } finally {
        console.groupEnd();
    }
},
        // M√©todos de Salvamento
        salvarJornadas: () => Storage._safeSave(Storage.KEYS.JORNADAS, AppState.jornadas),
        salvarConfiguracoes: () => {
            Storage._safeSave(Storage.KEYS.CONFIG, AppState.configuracoes);
            Storage._safeSave(Storage.KEYS.MANUTENCAO, AppState.historicoManutencao);
            Storage._safeSave(Storage.KEYS.COTA, AppState.cotaManutencao);
            Storage._safeSave(Storage.KEYS.POSTOS, AppState.postosCombustivel);
            Storage._safeSave(Storage.KEYS.PROMOCOES, AppState.promocoesAtivas);
        },
        salvarTransacoes: () => Storage._safeSave(Storage.KEYS.HISTORICO, AppState.historicoTransacoes),
        
        salvarJornadaAtiva: () => {
            if (AppState.activeJornadaChave) localStorage.setItem('activeJornadaChave_v6.4', AppState.activeJornadaChave);
            else localStorage.removeItem('activeJornadaChave_v6.4');
        },
        
        salvarUltimaDescricao: () => localStorage.setItem(Storage.KEYS.LAST_DESC, JSON.stringify(AppState.lastDescriptions || {})),
        salvarUltimaSubcategoria: () => localStorage.setItem(Storage.KEYS.LAST_SUB, JSON.stringify(AppState.lastSubcategories || {})),
        
        salvarVisualSettings: () => {
             try { localStorage.setItem('visualSettings_v6_4', JSON.stringify(AppState.visualSettings)); } catch(e){}
        },
        carregarVisualSettings: () => {
            try {
                const settings = localStorage.getItem('visualSettings_v6_4');
                if (settings) AppState.visualSettings = { ...AppState.visualSettings, ...JSON.parse(settings) };
            } catch (e) {}
        }
    };
 

 // =============================================================
    // ======================= PDF & GPS ===========================
    // =============================================================
    const ReciboGenerator = {
        gerarPDF: (atividade) => {
            const { perfilRecibo } = AppState.configuracoes;
            if (!perfilRecibo.nome || !perfilRecibo.documento || !perfilRecibo.placa) {
                UIRenderer.abrirModal('alerta', {
                    titulo: 'Perfil Incompleto',
                    mensagem: 'V√° em "Configura√ß√µes" e preencha o "Perfil do Motorista" (Nome, Documento e Placa) para gerar recibos.'
                });
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const margin = 15;
                const docWidth = doc.internal.pageSize.getWidth();
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('RECIBO DE TRANSPORTE PARTICULAR', docWidth / 2, 22, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('PRESTADOR DO SERVI√áO (MOTORISTA)', margin, 35);
                doc.setDrawColor(200); 
                doc.line(margin, 37, docWidth - margin, 37);
                doc.setFont('helvetica', 'normal');
                doc.text(`Nome: ${perfilRecibo.nome}`, margin, 44);
                doc.text(`Documento (CPF/CNH): ${perfilRecibo.documento}`, margin, 50);
                doc.text(`Ve√≠culo/Placa: ${perfilRecibo.placa}`, margin, 56);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOMADOR DO SERVI√áO (PASSAGEIRO)', margin, 69);
                doc.line(margin, 71, docWidth - margin, 71); 
                doc.setFont('helvetica', 'normal');
                doc.text(`Nome: ${atividade.nomeCliente || 'N√£o informado'}`, margin, 78);
                const dataViagem = Utils.formatarDataParaDisplay(new Date(atividade.fim));
                const horaViagem = Utils.formatarHora(atividade.fim);
                const kmRodados = (atividade.kmFinalServico && atividade.kmInicialServico && atividade.kmFinalServico > atividade.kmInicialServico)
                    ? (atividade.kmFinalServico - atividade.kmInicialServico)
                    : 0;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('DETALHES DO SERVI√áO', margin, 91);
                doc.line(margin, 93, docWidth - margin, 93);
                doc.setFont('helvetica', 'normal');
                doc.text(`Data: ${dataViagem} √†s ${horaViagem}`, margin, 100);
                doc.text(`Itiner√°rio/Descri√ß√£o: ${atividade.descricao || 'Viagem particular'}`, margin, 106);
                doc.text(`Dist√¢ncia Percorrida: ${kmRodados > 0 ? Utils.formatarDistancia(kmRodados) : 'N√£o medida'}`, margin, 112);
                doc.setFillColor(241, 245, 249);
                doc.setDrawColor(203, 213, 225);
                doc.rect(margin, 125, docWidth - (margin * 2), 20, 'FD');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('VALOR TOTAL PAGO', margin + 5, 137);
                doc.setFontSize(18);
                const valorString = Utils.formatarMoeda(atividade.valor);
                doc.text(valorString, docWidth - margin - 5, 137, { align: 'right' });
                const lineY = 170;
                doc.line(docWidth / 2 - 50, lineY, docWidth / 2 + 50, lineY);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Assinatura do Motorista', docWidth / 2, lineY + 5, { align: 'center' });
                doc.text(perfilRecibo.nome, docWidth / 2, lineY + 10, { align: 'center' });
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text(`Recibo gerado por Di√°rio de Bordo Inteligente - ${new Date().toLocaleString('pt-BR')}`, docWidth / 2, 195, { align: 'center' });
                const nomeArquivo = `recibo_${(atividade.nomeCliente || 'viagem').replace(/ /g, '_')}_${Utils.formatarDataParaChave(new Date(atividade.fim))}.pdf`;
                doc.save(nomeArquivo);
            } catch (e) {
                console.error("Erro ao gerar PDF:", e);
                UIRenderer.abrirModal('alerta', {
                    titulo: 'Erro no PDF',
                    mensagem: 'N√£o foi poss√≠vel gerar o recibo. Verifique sua conex√£o com a internet (para a biblioteca jsPDF).'
                });
            }
        },
        gerarPDFCotacao: () => {
            const { perfilRecibo } = AppState.configuracoes;
            const { cotacaoState } = AppState;

            if (!perfilRecibo.nome || !perfilRecibo.documento || !perfilRecibo.placa) {
                UIRenderer.abrirModal('alerta', {
                    titulo: 'Perfil Incompleto',
                    mensagem: 'V√° em "Configura√ß√µes" e preencha o "Perfil do Motorista" (Nome, Documento e Placa) para gerar a cota√ß√£o.'
                });
                return;
            }
            if (cotacaoState.total <= 0) {
                 UIRenderer.abrirModal('alerta', { 
                    titulo: 'Cota√ß√£o Vazia', 
                    mensagem: 'Preencha os dados da cota√ß√£o e calcule um valor antes de gerar o PDF.' 
                });
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const margin = 15;
                const docWidth = doc.internal.pageSize.getWidth();
                let yPos = 22; 

                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('COTA√á√ÉO DE TRANSPORTE PARTICULAR', docWidth / 2, yPos, { align: 'center' });
                yPos += 8;
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Data da Cota√ß√£o: ${new Date().toLocaleDateString('pt-BR')}`, docWidth / 2, yPos, { align: 'center' });
                yPos += 12;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('PRESTADOR DO SERVI√áO (MOTORISTA)', margin, yPos);
                doc.text('TOMADOR DO SERVI√áO (CLIENTE)', docWidth / 2 + 5, yPos);
                yPos += 2;
                doc.setDrawColor(200);
                doc.line(margin, yPos, docWidth - margin, yPos);
                yPos += 7;

                doc.setFont('helvetica', 'normal');
                doc.text(perfilRecibo.nome, margin, yPos);
                doc.text(cotacaoState.nomeCliente || 'N√£o informado', docWidth / 2 + 5, yPos);
                yPos += 6;
                doc.text(`Documento: ${perfilRecibo.documento}`, margin, yPos);
                yPos += 6;
                doc.text(`Ve√≠culo/Placa: ${perfilRecibo.placa}`, margin, yPos);
                yPos += 13;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('DETALHES DA VIAGEM', margin, yPos);
                yPos += 2;
                doc.line(margin, yPos, docWidth - margin, yPos);
                yPos += 7;

                doc.setFont('helvetica', 'normal');
                if(cotacaoState.dataInicio) {
                    const dataInicioFormat = new Date(cotacaoState.dataInicio).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
                    doc.text(`In√≠cio Previsto: ${dataInicioFormat}`, margin, yPos);
                }
                if(cotacaoState.dataFim) {
                    const dataFimFormat = new Date(cotacaoState.dataFim).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'});
                    doc.text(`Fim Previsto: ${dataFimFormat}`, docWidth / 2 + 5, yPos);
                }
                yPos += 6;

                doc.text(`Tipo de Servi√ßo: ${cotacaoState.tipoServico}`, margin, yPos);
                if (cotacaoState.qtdItens > 0) {
                    doc.text(`Qtd. Itens: ${cotacaoState.qtdItens}`, docWidth / 2, yPos);
                }
                if (cotacaoState.peso > 0) {
                    doc.text(`Peso Aprox.: ${String(cotacaoState.peso).replace('.', ',')} Kg`, docWidth / 2 + 40, yPos);
                }
                yPos += 8;

                doc.setFont('helvetica', 'bold');
                doc.text("Itiner√°rio:", margin, yPos);
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                cotacaoState.paradas.forEach((parada, index) => {
                    if (parada.trim() !== '') {
                        const pontoLabel = String.fromCharCode(65 + index); // A, B, C...
                        doc.text(`Ponto ${pontoLabel}: ${parada}`, margin + 5, yPos);
                        yPos += 5;
                    }
                });
                yPos += 5;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPOSI√á√ÉO DO VALOR', margin, yPos);
                yPos += 2;
                doc.line(margin, yPos, docWidth - margin, yPos);
                yPos += 7;
                
                const col1X = margin;
                const col2X = docWidth - margin - 60; 
                const col3X = docWidth - margin - 30;
                const col4X = docWidth - margin;

                doc.setFont('helvetica', 'bold');
                doc.text("Descri√ß√£o", col1X, yPos);
                doc.text("Base (KM)", col2X, yPos, { align: 'right' });
                doc.text("Vl. Unit", col3X, yPos, { align: 'right' });
                doc.text("Subtotal", col4X, yPos, { align: 'right' });
                yPos += 7;
                doc.setFont('helvetica', 'normal');

                const addRow = (desc, base, vlUnit, subtotal) => {
                    doc.text(desc, col1X, yPos);
                    doc.text(base, col2X, yPos, { align: 'right' });
                    doc.text(vlUnit, col3X, yPos, { align: 'right' });
                    doc.text(Utils.formatarMoeda(subtotal), col4X, yPos, { align: 'right' });
                    yPos += 7;
                };

                addRow("Dist. at√© o embarque", Utils.formatarDistancia(cotacaoState.distEmbarque), Utils.formatarMoeda(cotacaoState.valorKm), cotacaoState.distEmbarque * cotacaoState.valorKm);
                addRow("Dist. da Viagem (Ida)", Utils.formatarDistancia(cotacaoState.distViagem), Utils.formatarMoeda(cotacaoState.valorKm), cotacaoState.distViagem * cotacaoState.valorKm);
                
                if (cotacaoState.semRetorno) {
                    addRow("Retorno (sem passageiro)", Utils.formatarDistancia(cotacaoState.distViagem), Utils.formatarMoeda(cotacaoState.valorKmRetorno), cotacaoState.distViagem * cotacaoState.valorKmRetorno);
                }
                if (cotacaoState.pedagios > 0) {
                    addRow("Custos de Ped√°gio", "N/A", "N/A", cotacaoState.pedagios);
                }
                if (cotacaoState.seguranca > 0) {
                    addRow("Taxas Adicionais (Espera, etc)", "N/A", "N/A", cotacaoState.seguranca);
                }
                yPos += 3;

                doc.setFillColor(241, 245, 249); 
                doc.setDrawColor(203, 213, 225);
                doc.rect(margin, yPos, docWidth - (margin * 2), 15, 'FD');
                yPos += 10;

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('VALOR TOTAL DA VIAGEM', margin + 5, yPos);

                doc.setFontSize(18);
                doc.text(Utils.formatarMoeda(cotacaoState.total), docWidth - margin - 5, yPos, { align: 'right' });
                yPos += 15;

                if (cotacaoState.custosInclusos.length > 0) {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(100);
                    doc.text('Esta cota√ß√£o considera a cobertura dos seguintes custos operacionais di√°rios do prestador:', margin, yPos);
                    yPos += 5;
                    doc.setFont('helvetica', 'normal');
                    let custosStr = '';
                    cotacaoState.custosInclusos.forEach((custo, index) => {
                        custosStr += custo.descricao + (index < cotacaoState.custosInclusos.length - 1 ? ', ' : '.');
                    });
                    doc.text(custosStr, margin, yPos, { maxWidth: docWidth - (margin * 2) });
                    yPos += 10;
                }

                doc.setFontSize(9);
                doc.setTextColor(100);
                doc.text(`Esta √© uma cota√ß√£o e n√£o um recibo de pagamento. Valores v√°lidos por 7 dias.`, margin, yPos);
                yPos += 5;
                doc.text(`Gerado por: Di√°rio de Bordo Inteligente (${perfilRecibo.nome})`, margin, yPos);

                const nomeArquivo = `cotacao_${(cotacaoState.nomeCliente || 'viagem').replace(/ /g, '_')}_${Utils.formatarDataParaChave(new Date())}.pdf`;
                doc.save(nomeArquivo);

            } catch (e) {
                console.error("Erro ao gerar PDF da Cota√ß√£o:", e);
                UIRenderer.abrirModal('alerta', {
                    titulo: 'Erro no PDF',
                    mensagem: 'N√£o foi poss√≠vel gerar a cota√ß√£o. Verifique sua conex√£o com a internet (para a biblioteca jsPDF).'
                });
            }
        }
    };
// PromotionManager.js - Arquivo Completo Revisado (V20)
// --------------------------------------------------------
// Inclui:
// 1. Preprocessamento de imagem para OCR
// 2. Reconhecimento Tesseract integrado
// 3. Extra√ß√£o correta de fases Uber (todas as metas)
// 4. Fun√ß√£o principal: lerPrintPromocao()
// --------------------------------------------------------
// =============================================================
    // ============ PR√â-PROCESSAMENTO (V-FINAL: MATEM√ÅTICA ID√äNTICA AO TESTE) =====
    // =============================================================
    const ImagePreprocessor = {

        processar: async (file, modo = 'padrao') => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    // 1. DEFINI√á√ÉO DE PAR√ÇMETROS (SEUS VALORES VENCEDORES)
                    let options = {
                        scale: 2,
                        brightness: 0,
                        threshold: 180,
                        sharpen: 0
                    };

                    if (modo === '99') {
                        // === CONFIGURA√á√ÉO VENCEDORA DO SEU TESTE ===
                        options.scale = 2.5;
                        options.brightness = -0.17; // Reduz o amarelo de fundo
                        options.threshold = 129;    // For√ßa o texto a ficar preto
                        options.sharpen = 3;        // Define as bordas das letras
                    } 
                    else if (modo === 'uber') {
                        // Configura√ß√£o sugerida para Uber (Fundo branco/preto limpo)
                        options.scale = 2;
                        options.brightness = 0;
                        options.threshold = 160;
                        options.sharpen = 0;
                    }

                    // 2. ESCALA (UPSCALE)
                    const w = Math.round(img.width * options.scale);
                    const h = Math.round(img.height * options.scale);
                    
                    const canvas = document.createElement("canvas");
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext("2d");

                    // Desenha redimensionado (Melhora a leitura de letras pequenas)
                    ctx.drawImage(img, 0, 0, w, h);

                    // 3. MANIPULA√á√ÉO DE PIXELS (GRAY -> BRIGHTNESS -> THRESHOLD)
                    const imgData = ctx.getImageData(0, 0, w, h);
                    const d = imgData.data;

                    for (let i = 0; i < d.length; i += 4) {
                        const r = d[i];
                        const g = d[i+1];
                        const b = d[i+2];

                        // A. Grayscale (Luma Perceptual)
                        const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;

                        // B. Brightness (Ajuste de Brilho)
                        // O valor do slider (-0.17) multiplica por 255 para virar offset de pixel
                        const brightVal = gray + (options.brightness * 255);

                        // C. Threshold (Binariza√ß√£o: Preto ou Branco absoluto)
                        // Se for menor que o limite, vira PRETO (0), sen√£o BRANCO (255)
                        const final = brightVal < options.threshold ? 0 : 255;

                        d[i] = d[i+1] = d[i+2] = final;
                    }

                    ctx.putImageData(imgData, 0, 0);

                    // 4. SHARPEN (CONVOLU√á√ÉO)
                    // Aplica filtro de nitidez se configurado
                    if (options.sharpen > 0) {
                        const s = options.sharpen;
                        // Kernel de Sharpen simples
                        const kernel = [ 
                            0, -1, 0, 
                            -1, (4 + s), -1, 
                            0, -1, 0 
                        ];
                        ImagePreprocessor.convolute(ctx, w, h, kernel);
                    }

                    // Retorna o BLOB da imagem tratada
                    canvas.toBlob((blob) => resolve(blob), "image/png", 1.0);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        },

        // Fun√ß√£o Auxiliar de Convolu√ß√£o (Matem√°tica de Matriz para Sharpen)
        convolute: (ctx, w, h, kernel) => {
            const src = ctx.getImageData(0, 0, w, h);
            const dst = ctx.createImageData(w, h);
            
            const side = Math.round(Math.sqrt(kernel.length));
            const half = Math.floor(side / 2);
            
            const srcData = src.data;
            const dstData = dst.data;
            
            // Percorre cada pixel
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    let r = 0, g = 0, b = 0;
                    const dstOff = (y * w + x) * 4;
                    
                    // Aplica a matriz (kernel) nos vizinhos
                    for (let ky = 0; ky < side; ky++) {
                        for (let kx = 0; kx < side; kx++) {
                            const scy = y + ky - half;
                            const scx = x + kx - half;
                            
                            if (scy >= 0 && scy < h && scx >= 0 && scx < w) {
                                const srcOff = (scy * w + scx) * 4;
                                const wt = kernel[ky * side + kx];
                                
                                r += srcData[srcOff] * wt;
                                g += srcData[srcOff+1] * wt;
                                b += srcData[srcOff+2] * wt;
                            }
                        }
                    }
                    
                    // Clampa os valores entre 0 e 255
                    dstData[dstOff] = Math.min(255, Math.max(0, r));
                    dstData[dstOff+1] = Math.min(255, Math.max(0, g));
                    dstData[dstOff+2] = Math.min(255, Math.max(0, b));
                    dstData[dstOff+3] = 255; // Alpha (Opacidade)
                }
            }
            ctx.putImageData(dst, 0, 0);
        }
    };
// =============================================================
    // ======================= PROMOTION MANAGER (V64 - 99 FIX) ====
    // =============================================================
    const PromotionManager = {
        
        extrairDadosDoTexto: (text) => {
            const dados = { 
                app: 'Outro', tipo: 'escalonada', valor: 0, meta: 0, fases: [], 
                repetir: false, horaInicio: '', horaFim: '', dataInicio: '', dataFim: '' 
            };
            
            if (!text) return dados;

            // 1. LIMPEZA CIR√öRGICA
            let t = text.toLowerCase()
                .replace(/[\n\r]+/g, '  ') // Remove quebras de linha
                .replace(/\s+/g, ' ')      // Remove espa√ßos extras
                .replace(/[|]/g, '')       // Remove barras verticais de OCR
                // Corre√ß√µes espec√≠ficas da 99
                .replace(/fa√ßamais/gi, 'fa√ßa mais ')
                .replace(/(\d)h[oO0](\d)/gi, '$1h0$2') // Corrige 12hO0 para 12h00
                .replace(/rs\$?/gi, 'R$')               // Corrige RS$ e RS
                .replace(/\+\s*s/gi, '+ R$')            // Corrige +S8
                .replace(/\b(\d+)\s*\/\s*(\d+)/g, ' $1/$2 '); // Garante espa√ßos em 0/9

            console.log("Texto Limpo V64:", t);

            // 2. IDENTIFICA APP
            if (t.includes('99') || t.includes('pop') || t.includes('corra')) dados.app = '99';
            else if (t.includes('uber') || t.includes('quest')) dados.app = 'Uber';

            // =========================================================
            // 3. EXTRA√á√ÉO DE DATAS E HORAS
            // =========================================================
            const ano = new Date().getFullYear();
            
            // Regex para "12h00 ... 25/11 ... 20h59 ... 25/11"
            // Captura: Hora1, Min1, Dia1, Mes1, Hora2, Min2, Dia2, Mes2
            const regexTempo = /(\d{1,2})h(\d{2}).*?(\d{1,2})\/(\d{1,2}).*?(\d{1,2})h(\d{2}).*?(\d{1,2})\/(\d{1,2})/i;
            const mTempo = t.match(regexTempo);

            if (mTempo) {
                dados.horaInicio = `${mTempo[1].padStart(2,'0')}:${mTempo[2]}`;
                dados.horaFim = `${mTempo[5].padStart(2,'0')}:${mTempo[6]}`;
                
                dados.dataInicio = Utils.formatarDataParaChave(new Date(ano, parseInt(mTempo[4]) - 1, parseInt(mTempo[3])));
                dados.dataFim = Utils.formatarDataParaChave(new Date(ano, parseInt(mTempo[8]) - 1, parseInt(mTempo[7])));
                dados.repetir = false;
            } else {
                // Fallback: Tenta achar datas soltas se o padr√£o completo falhar
                const matchDatas = [...t.matchAll(/(\d{1,2})\/(\d{1,2})/g)];
                if (matchDatas.length > 0) {
                    const d1 = matchDatas[0];
                    dados.dataInicio = Utils.formatarDataParaChave(new Date(ano, parseInt(d1[2])-1, parseInt(d1[1])));
                    if (matchDatas.length > 1) {
                        const d2 = matchDatas[matchDatas.length-1]; // Pega a √∫ltima data
                        dados.dataFim = Utils.formatarDataParaChave(new Date(ano, parseInt(d2[2])-1, parseInt(d2[1])));
                    } else {
                        dados.dataFim = dados.dataInicio;
                    }
                }
                
                // Fallback Horas
                const matchHoras = [...t.matchAll(/(\d{1,2})h(\d{2})/g)];
                if (matchHoras.length >= 2) {
                    dados.horaInicio = `${matchHoras[0][1].padStart(2,'0')}:${matchHoras[0][2]}`;
                    dados.horaFim = `${matchHoras[1][1].padStart(2,'0')}:${matchHoras[1][2]}`;
                } else {
                    dados.horaInicio = '00:00';
                    dados.horaFim = '23:59';
                    dados.repetir = true;
                }
            }

            // =========================================================
            // 4. L√ìGICA DE FASES (CORRE√á√ÉO DA SOMA)
            // =========================================================
            const fasesTemp = [];

            if (dados.app === '99') {
                // Estrat√©gia: Dividir o texto em "blocos" de recompensa
                // Procuramos padr√µes como "0/9 ... R$8" ou "mais 3 ... R$8"
                
                // 1. Busca a BASE (Ex: 0/9 ou 1/9)
                const regexBase = /(\d+)\/(\d+)\s*(?:corrida|viagem).*?R\$\s*(\d+[,.]?\d*)/i;
                const mBase = t.match(regexBase);
                
                let acumulado = 0;
                
                if (mBase) {
                    const metaBase = parseInt(mBase[2]); // O '9' do '0/9'
                    const valorBase = parseFloat(mBase[3].replace(',', '.'));
                    
                    acumulado = metaBase;
                    fasesTemp.push({ qtd: acumulado, valor: valorBase });
                }

                // 2. Busca os INCREMENTOS (Ex: "Fa√ßa mais 3 ... +R$8")
                // O 'g' no final permite achar todos
                const regexExtra = /(?:mais|\+|fa√ßa mais)\s*(\d+)\s*(?:corrida|viagem).*?R\$\s*(\d+[,.]?\d*)/gi;
                let mExtra;
                
                while ((mExtra = regexExtra.exec(t)) !== null) {
                    const qtdExtra = parseInt(mExtra[1]);
                    const valorExtra = parseFloat(mExtra[2].replace(',', '.'));
                    
                    if (acumulado === 0) {
                        // Se n√£o achou base antes, assume que este √© o primeiro (fallback)
                        acumulado = qtdExtra;
                    } else {
                        // Se j√° tem base, SOMA
                        acumulado += qtdExtra;
                    }
                    
                    // Evita duplicar se o OCR leu a mesma linha duas vezes
                    if (!fasesTemp.some(f => f.qtd === acumulado)) {
                         fasesTemp.push({ qtd: acumulado, valor: valorExtra });
                    }
                }
                
                dados.fases = fasesTemp;

                // Tenta ler o Valor Total do t√≠tulo ("R$28 extras") para validar
                const mTotal = t.match(/r\$\s?(\d+[,.]?\d*)\s*extras/);
                if (mTotal) {
                     const vTot = parseFloat(mTotal[1].replace(',', '.'));
                     const somaFases = fasesTemp.reduce((acc, f) => acc + f.valor, 0);
                     // Usa o maior (se a soma das fases for menor, o OCR perdeu alguma fase, ent√£o usa o total)
                     dados.valor = Math.max(vTot, somaFases);
                } else {
                     dados.valor = fasesTemp.reduce((acc, f) => acc + f.valor, 0);
                }

            } else {
                // === L√ìGICA UBER (MANTIDA) ===
                const regexBarra = /(\d+)\s*[\/]\s*(\d+).*?R\$\s*(\d+[,.]?\d*)/gi;
                let m;
                while ((m = regexBarra.exec(t)) !== null) {
                    fasesTemp.push({ qtd: parseInt(m[2]), valor: parseFloat(m[3].replace(',', '.')), isBase: true });
                }
                const regexExtra = /(\d+)\s*(?:viagens|corridas)?.*?[\+]\s*R\$\s*(\d+[,.]?\d*)/gi;
                while ((m = regexExtra.exec(t)) !== null) {
                    let q = parseInt(m[1]);
                    if (q >= 100 && q.toString().startsWith('1')) q = parseInt(q.toString().substring(1));
                    fasesTemp.push({ qtd: q, valor: parseFloat(m[2].replace(',', '.')), isBase: false });
                }

                if (fasesTemp.length > 0) {
                    let base = fasesTemp.find(f => f.isBase);
                    if (!base) { fasesTemp.sort((a, b) => b.qtd - a.qtd); base = fasesTemp[0]; }
                    const finais = [{ qtd: base.qtd, valor: base.valor }];
                    let metaAcum = base.qtd;
                    fasesTemp.filter(f => f !== base).forEach(ex => {
                         if (ex.qtd < base.qtd) metaAcum += ex.qtd; else metaAcum = ex.qtd;
                         finais.push({ qtd: metaAcum, valor: ex.valor });
                    });
                    dados.fases = finais.sort((a, b) => a.qtd - b.qtd);
                }
                dados.fases = fasesTemp;
            }

            // --- FECHAMENTO ---
            if (dados.fases.length > 0) {
                dados.meta = dados.fases[dados.fases.length - 1].qtd;
                if (!dados.valor || dados.valor === 0) dados.valor = dados.fases.reduce((acc, f) => acc + f.valor, 0);
            }
            
            dados.titulo = dados.titulo || `${dados.app} - Promo√ß√£o`;
            dados.metaQtd = dados.meta;
            dados.valorObjetivo = dados.valor;
            if (dados.repetir === undefined) dados.repetir = (dados.dataInicio === dados.dataFim);
            dados.repetirDiariamente = !!dados.repetir;
            dados.horarios = [{ inicio: dados.horaInicio, fim: dados.horaFim }];

            return dados;
        },

        // Mantenha as outras fun√ß√µes (lerPrintPromocao, criarPromocao, etc.) 
        // exatamente como na vers√£o V63 que enviei anteriormente, pois elas j√° 
        // cont√™m a l√≥gica de rec√°lculo retroativo que voc√™ pediu e funcionou.
        // Apenas a extrairDadosDoTexto precisava dessa cirurgia na l√≥gica da 99.
        
        // ... (resto do PromotionManager) ...
        lerPrintPromocao: async (file, callback) => {
            if (typeof Tesseract === 'undefined') { alert("Erro: Tesseract ausente."); return; }
            UIRenderer.abrirModal('alerta', { titulo: 'Lendo...', mensagem: 'Processando imagem...' });
            try {
                // Tenta perfil 99 primeiro
                const fileProcessado = await ImagePreprocessor.processar(file, '99'); 
                const { data: { text } } = await Tesseract.recognize(fileProcessado, 'por', { 
                    tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ√ß√°√©√≠√≥√∫√¢√™√Æ√¥√ª√£√µ√†√®√¨√≤√π√á√Å√â√ç√ì√ö√Ç√ä√é√î√õ√É√ï√Ä√à√å√í√ô/+R$:. -&%',
                    tessedit_pageseg_mode: '6' 
                });
                const dados = PromotionManager.extrairDadosDoTexto(text);
                UIRenderer.fecharModal();
                callback(dados, text);
            } catch (e) { 
                console.error(e); UIRenderer.fecharModal(); 
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Falha na leitura.' });
            }
        },

        criarPromocao: (dados) => {
            const id = dados.id || ((typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'promo_' + Date.now());
            let fasesFinais = dados.fases;
            if (!fasesFinais || fasesFinais.length === 0) {
                if (dados.metaQtd > 0) fasesFinais = [{ qtd: dados.metaQtd, valor: dados.valorObjetivo }];
                else fasesFinais = [];
            }
            const novaPromo = {
                id: id, titulo: dados.titulo, app: dados.app, tipo: 'escalonada',
                dataInicio: dados.dataInicio || Utils.formatarDataParaChave(new Date()),
                dataFim: dados.dataFim || Utils.formatarDataParaChave(new Date()),
                horarios: Array.isArray(dados.horarios) ? dados.horarios : [],
                repetirDiariamente: !!dados.repetirDiariamente,
                regras: { metaQtd: dados.metaQtd, valorObjetivo: dados.valorObjetivo, fases: fasesFinais },
                progresso: { qtdAtual: 0, qtdNestaFase: 0, faseIndex: 0, kmAtual: 0, valorPago: 0 },
                status: 'ativa'
            };
            if (!AppState.promocoesAtivas) AppState.promocoesAtivas = [];
            const idx = AppState.promocoesAtivas.findIndex(p => p.id === id);
            if (idx !== -1) {
                novaPromo.progresso.valorPago = AppState.promocoesAtivas[idx].progresso.valorPago || 0;
                AppState.promocoesAtivas[idx] = novaPromo;
            } else {
                AppState.promocoesAtivas.push(novaPromo);
            }
            PromotionManager.recalcularTudo();
            Storage.salvarConfiguracoes();
        },

        recalcularTudo: () => {
            if (!AppState.promocoesAtivas) return;
            AppState.promocoesAtivas.forEach(promo => {
                if (promo.status === 'concluida') return;
                promo.progresso.qtdAtual = 0;
                promo.progresso.faseIndex = 0;
                const inicioPromoStr = promo.dataInicio; 
                const fimPromoStr = promo.dataFim;      
                Object.keys(AppState.jornadas).forEach(chaveData => {
                    if (chaveData >= inicioPromoStr && chaveData <= fimPromoStr) {
                        const jornada = AppState.jornadas[chaveData];
                        if (jornada && jornada.atividades) {
                            jornada.atividades.forEach(ativ => {
                                if (promo.app !== 'Outro') {
                                    const txt = ((ativ.categoria||'') + " " + (ativ.subcategoria||'') + " " + (ativ.descricao||'')).toLowerCase();
                                    if (!txt.includes(promo.app.toLowerCase())) return;
                                }
                                if (promo.repetirDiariamente && promo.horarios && promo.horarios.length > 0) {
                                    const hRegra = promo.horarios[0];
                                    if (ativ.fim) {
                                        const horaAtiv = new Date(ativ.fim).toTimeString().slice(0,5);
                                        if (horaAtiv < hRegra.inicio || horaAtiv > hRegra.fim) return;
                                    }
                                }
                                promo.progresso.qtdAtual++;
                            });
                        }
                    }
                });
                if (promo.regras.fases && promo.regras.fases.length > 0) {
                    promo.regras.fases.sort((a,b) => a.qtd - b.qtd);
                    for (let i = 0; i < promo.regras.fases.length; i++) {
                        if (promo.progresso.qtdAtual >= promo.regras.fases[i].qtd) {
                            promo.progresso.faseIndex = Math.min(i + 1, promo.regras.fases.length - 1);
                        } else {
                            promo.progresso.faseIndex = i;
                            break;
                        }
                    }
                }
                PromotionManager.verificarGatilhos(promo);
            });
            if (Storage.salvarConfiguracoes) Storage.salvarConfiguracoes();
        },

        verificarGatilhos: (promo) => {
            if (!promo || !promo.regras.fases) return;
            promo.regras.fases.forEach((fase, index) => {
                if (promo.progresso.qtdAtual >= fase.qtd) {
                    const descPagamento = `B√¥nus: ${promo.titulo} (Fase ${index + 1})`;
                    const jaPagou = AppState.historicoTransacoes.some(t => t.descricao === descPagamento);
                    if (!jaPagou) {
                        let valorAPagar = fase.valor;
                        if (promo.app === 'Uber') {
                             const totalPago = promo.progresso.valorPago || 0;
                             if (fase.valor > totalPago) valorAPagar = fase.valor - totalPago;
                             else valorAPagar = 0;
                        }
                        if (valorAPagar > 0) {
                            PromotionManager.pagarRecompensa(promo, valorAPagar, descPagamento);
                        }
                        if (index === promo.regras.fases.length - 1 && promo.progresso.qtdAtual >= fase.qtd) {
                            promo.status = 'concluida';
                        }
                    }
                }
            });
        },

        pagarRecompensa: (promo, valor, descricao) => {
            if (!AppState.historicoTransacoes) AppState.historicoTransacoes = [];
            const bonus = {
                id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'tx_' + Date.now(),
                data: Date.now(),
                contaId: 'AUTO_ID_CARTEIRA',
                tipo: 'entrada',
                valor: valor,
                descricao: descricao,
                categoria: 'Gorjeta',
                jornadaId: AppState.activeJornadaChave || Utils.formatarDataParaChave(new Date())
            };
            AppState.historicoTransacoes.push(bonus);
            promo.progresso.valorPago = (promo.progresso.valorPago || 0) + valor;
            UIRenderer.abrirModal('alerta', { titulo: 'Meta Batida!', mensagem: `B√¥nus de ${Utils.formatarMoeda(valor)} creditado.`, type: 'success' });
            UIRenderer.render(); 
        }
    };
 
 const GpsTracker = {
        startTracking: (kmInicialJornada) => {
            if (!navigator.geolocation) {
                UIRenderer.abrirModal('alerta', { titulo: 'GPS N√£o Suportado', mensagem: 'Seu navegador n√£o suporta geolocaliza√ß√£o.' });
                return;
            }
            if (AppState.gpsWatcherId) {
                console.log("GPS j√° estava ativo. Reiniciando.");
                GpsTracker.stopTracking();
            }
            AppState.gpsLastPosition = null;
            AppState.gpsCurrentOdometer = kmInicialJornada;
            const options = {
                enableHighAccuracy: true,
                maximumAge: 5000,
                timeout: 10000
            };
            try {
                AppState.gpsWatcherId = navigator.geolocation.watchPosition(
                    GpsTracker.onSuccess,
                    GpsTracker.onError,
                    options
                );
                AppState.isGpsTracking = true;
                console.log("Iniciado monitoramento por GPS. Watcher ID:", AppState.gpsWatcherId);
            } catch (e) {
                console.error("Erro ao iniciar watchPosition:", e);
                GpsTracker.onError({ code: 0, message: "N√£o foi poss√≠vel iniciar o rastreador." });
            }
        },
        stopTracking: () => {
            if (AppState.gpsWatcherId && navigator.geolocation) {
                navigator.geolocation.clearWatch(AppState.gpsWatcherId);
            }
            AppState.gpsWatcherId = null;
            AppState.gpsLastPosition = null;
            AppState.isGpsTracking = false;
            console.log("Monitoramento por GPS parado.");
        },
        onSuccess: (position) => {
            const { latitude, longitude, speed, accuracy } = position.coords;
            console.log(`Posi√ß√£o recebida: Lat ${latitude}, Lon ${longitude}, Precis√£o ${accuracy}m`);
            if (accuracy > 100) {
                console.warn("Posi√ß√£o ignorada, precis√£o muito baixa:", accuracy);
                return;
            }
            if (!AppState.gpsLastPosition) {
                AppState.gpsLastPosition = { latitude, longitude };
                return;
            }
            const newPosition = { latitude, longitude };
            const distanceMeters = GpsTracker.calculateHaversine(AppState.gpsLastPosition, newPosition);
            if (distanceMeters > 5) {
                const distanceKm = distanceMeters / 1000;
                AppState.gpsCurrentOdometer += distanceKm;
                AppState.gpsLastPosition = newPosition;
                const jornadaAtiva = BusinessLogic.getJornadaAtiva();
                if (jornadaAtiva) {
                    jornadaAtiva.kmGps = (jornadaAtiva.kmGps || 0) + distanceKm;
                    jornadaAtiva.kmFinal = AppState.gpsCurrentOdometer;
                    if (UIElements.kmFinalInput) {
                        UIElements.kmFinalInput.value = Math.round(AppState.gpsCurrentOdometer);
                    }
                }
            }
        },
        onError: (error) => {
            AppState.isGpsTracking = false;
            AppState.gpsWatcherId = null;
            let mensagem = 'Erro desconhecido no GPS.';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    mensagem = "Voc√™ negou a permiss√£o de localiza√ß√£o. O rastreio de KM n√£o funcionar√°.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    mensagem = "Sinal de GPS indispon√≠vel. Tente em um local aberto.";
                    break;
                case error.TIMEOUT:
                    mensagem = "Tempo limite para obter a localiza√ß√£o esgotado.";
                    break;
            }
            console.error("Erro no GPS:", error.message);
            UIRenderer.abrirModal('alerta', { titulo: 'Falha no GPS', mensagem: mensagem });
        },
        calculateHaversine: (pos1, pos2) => {
            const R = 6371e3;
            const lat1 = pos1.latitude * Math.PI / 180;
            const lat2 = pos2.latitude * Math.PI / 180;
            const deltaLat = (pos2.latitude - pos1.latitude) * Math.PI / 180;
            const deltaLon = (pos2.longitude - pos1.longitude) * Math.PI / 180;
            const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    };
    
    
  /*  
    // ============================================================================
// SYSTEM MIGRATOR V1 (O PROTETOR DA INTEGRIDADE)
// Fun√ß√£o: Garante que o BusinessLogic s√≥ precise lidar com dados novos.
// ============================================================================
const SystemMigrator = {
    executar: () => {
        console.log("üßπ Migrador: Verificando integridade dos dados...");
        let houveMudanca = false;

        // 1. MIGRA√á√ÉO: Chave de Jornada Ativa (Legado -> Novo)
        // Se existir a vari√°vel velha, movemos para a nova e matamos a velha.
        if (AppState.activeJornadaChave && !AppState.jornadaAtivaId) {
            console.log("üîÑ Migrando chave de jornada antiga...");
            AppState.jornadaAtivaId = AppState.activeJornadaChave;
            AppState.activeJornadaChave = null; // Mata o legado
            houveMudanca = true;
        }

        // 2. SANEAMENTO: Mata Jornadas Zumbis (Ativas no passado)
        const hoje = Utils.getDataInputHoje(); // "2025-12-29"
        if (AppState.jornadas) {
            Object.keys(AppState.jornadas).forEach(id => {
                const j = AppState.jornadas[id];
                // Se est√° ativa MAS n√£o √© a de hoje...
                if (j.status === 'ativa' && id !== hoje) {
                    console.warn(`üßü Zumbi detectado no dia ${id}. Finalizando...`);
                    j.status = 'finalizada';
                    j.fimJornada = j.fimJornada || new Date().getTime();
                    
                    // Se essa era a ativa, limpa a refer√™ncia global
                    if (AppState.jornadaAtivaId === id) {
                        AppState.jornadaAtivaId = null;
                    }
                    houveMudanca = true;
                }
            });
        }

        // 3. LIMPEZA FINAL: Remove lixo do LocalStorage
        if (localStorage.getItem('driver_app_jornada_ativa')) {
            localStorage.removeItem('driver_app_jornada_ativa');
            houveMudanca = true;
        }

        // Se houve faxina, salva o estado limpo
        if (houveMudanca) {
            console.log("‚úÖ Dados migrados e salvos.");
            if (BusinessLogic.salvarDados) BusinessLogic.salvarDados();
            else Storage.salvarJornadas();
        } else {
            console.log("‚ú® Dados j√° est√£o no formato V138.");
        }
    }
};
*/

// =============================================================
    // ======================= BUSINESS LOGIC ======================
    // =============================================================
    const BusinessLogic = {
        
// =============================================================
// REC√ÅLCULO V45 (T√âCNICO PURO + DOM√çNIO CORRIGIDO)
// Corre√ß√µes:
// 1. N√ÉO transforma evento f√≠sico em custo financeiro
// 2. Usa apenas valor financeiro real (dinheiro/cr√©dito)
// 3. Mant√©m valorEvento separado (ativo / m√©dia)
// 4. KM calculado de forma determin√≠stica
// 5. Blindagem contra duplica√ß√µes hist√≥ricas
// =============================================================
// =============================================================
// =============================================================

// Adicione isso dentro do BusinessLogic
    getJornadaById: (idAlvo) => {
        // 1. Pega todas as jornadas salvas (que ficam organizadas por data)
        const listaJornadas = Object.values(AppState.jornadas || {});
        
        // 2. Procura aquela que tem o ID igual ao que estamos buscando
        return listaJornadas.find(j => j.id === idAlvo);
    },
// =============================================================
        // REC√ÅLCULO V46.3 (HIERARQUIA DE IDs BLINDADA + DEDUPLICA√á√ÉO)
        // =============================================================
        recalcularCustosAbastecimentoJornada: (jornadaId) => {
            const jornada = AppState.jornadas[jornadaId];
            if (!jornada) return false;

            // 1. Busca transa√ß√µes
            const abastecimentosDoDia = AppState.historicoTransacoes.filter(t => 
                t.jornadaId === jornadaId && 
                t.categoria === 'Abastecimento' &&
                t.detalhes && 
                t.contaId !== 'LIVRO_CAIXA_DESPESA_CREDITO' &&
                !String(t.descricao || '').includes('(C.C.)')
            );

            // 2. Cen√°rio Zero
            if (abastecimentosDoDia.length === 0) {
                if (jornada.custos && jornada.custos.abastecimento) {
                    delete jornada.custos.abastecimento;
                    jornada.updatedAt = Date.now();
                }
                return true;
            }

            // 3. Soma Inteligente (Financeiro ACUMULA, F√≠sico DEDUPLICA)
            const eventosProcessados = new Set(); 

            const total = abastecimentosDoDia.reduce((acc, t) => {
                // üõ°Ô∏è BLINDAGEM DE ID (Sugest√£o Aprovada)
                // 1. requestId: O v√≠nculo mais forte de splits
                // 2. detalhes.idEventoFisico: Caso venha expl√≠cito do form
                // 3. split_id: Legado de vers√µes anteriores
                // 4. t.id: Se for pagamento √∫nico sem split, ele √© o pr√≥prio evento
                const idEventoFisico = t.requestId || t.detalhes?.idEventoFisico || t.split_id || t.id;
                
                const jaProcessouFisico = eventosProcessados.has(idEventoFisico);

                // --- CAMADA FINANCEIRA (Sempre soma) ---
                const valorFinanceiro = Number(t.valor) || 0; 

                // --- CAMADA F√çSICA (Soma apenas uma vez por evento real) ---
                let litros = 0;
                let valorEvento = 0;

                if (!jaProcessouFisico) {
                    litros = Number(t.detalhes.litros) || 0;
                    valorEvento = Number(t.detalhes.valorEvento ?? t.valor) || 0;
                    eventosProcessados.add(idEventoFisico);
                }

                const ts = t.createdAt || new Date(t.data || Date.now()).getTime();
                const kmEvento = Number(t.detalhes.km) || acc.km;

                return {
                    litros: acc.litros + litros,
                    valorFinanceiro: acc.valorFinanceiro + valorFinanceiro,
                    valorEvento: acc.valorEvento + valorEvento,
                    km: ts >= acc._ts ? kmEvento : acc.km,
                    _ts: Math.max(acc._ts, ts)
                };
            }, { litros: 0, valorFinanceiro: 0, valorEvento: 0, km: 0, _ts: 0 });

            // 4. Prepara Objeto
            if (!jornada.custos) jornada.custos = {};
            
            const objAbastecimento = {
                litros: total.litros,
                valorFinanceiro: total.valorFinanceiro, 
                valorEvento: total.valorEvento,
                km: total.km,
                mediaCalculada: 0,
                litrosRestantes: 0,
                litrosConsumidosPainel: 0,
                valor: 0 
            };

            // 5. M√©dia
            try {
                const dataJornada = new Date(Number(jornada.createdAt || Date.now()));
                const mediaObj = BusinessLogic.calcularMediaConsumo(jornada, dataJornada);
                objAbastecimento.mediaCalculada = mediaObj.media || 0;
            } catch (e) { objAbastecimento.mediaCalculada = 0; }

            // 6. Decis√£o Din√¢mica vs Est√°tica
            const usarDinamico = AppState.configuracoes.usarCustoDinamico === true;

            if (usarDinamico) {
                // Din√¢mico: Custo baseado no KM rodado
                const kmRodado = Math.max(0, (jornada.kmFinal || 0) - (jornada.kmInicial || 0));
                
                // Pre√ßo m√©dio PONDERADO (Total Eventos / Total Litros)
                const precoMedio = total.litros > 0 ? (total.valorEvento / total.litros) : 0;
                
                const consumoL = (objAbastecimento.mediaCalculada > 0) 
                    ? (kmRodado / objAbastecimento.mediaCalculada) 
                    : 0;

                objAbastecimento.valor = consumoL * precoMedio;
                
                console.log(`[V46.3] Din√¢mico | KM: ${kmRodado} | Consumo: ${consumoL.toFixed(2)}L | Custo: ${Utils.formatarMoeda(objAbastecimento.valor)}`);
            } else {
                // Est√°tico: Custo √© o que saiu do bolso
                objAbastecimento.valor = total.valorFinanceiro;
            }

            jornada.custos.abastecimento = objAbastecimento;
            jornada.updatedAt = Date.now();
            return true;
        },

/* 
recalcularCustosAbastecimentoJornada: (jornadaId) => {
    const jornada = AppState.jornadas[jornadaId];
    if (!jornada) return false;

    // 1. Busca transa√ß√µes reais da jornada (Fonte da Verdade)
    const abastecimentosDoDia = AppState.historicoTransacoes.filter(t =>
        t.jornadaId === jornadaId &&
        t.categoria === 'Abastecimento' &&
        t.detalhes &&
        Number(t.detalhes.litros) > 0 &&

        // üõ°Ô∏è Blindagens hist√≥ricas
        t.contaId !== 'LIVRO_CAIXA_DESPESA_CREDITO' &&
        !String(t.descricao || '').includes('(C.C.)')
    );

    // 2. Cen√°rio zero ‚Äî limpeza t√©cnica
    if (abastecimentosDoDia.length === 0) {
        if (jornada.custos?.abastecimento) {
            delete jornada.custos.abastecimento;
            jornada.updatedAt = Date.now();
        }
        return true;
    }

    // 3. Agrega√ß√£o t√©cnica correta
    const total = abastecimentosDoDia.reduce((acc, t) => {
        const litros = Number(t.detalhes.litros) || 0;

        // üîí Valor financeiro REAL (dinheiro / cr√©dito)
        const valorFinanceiro = Number(t.valor) || 0;

        // üîí Valor f√≠sico do evento (ativo / m√©dia)
        const valorEvento = Number(t.detalhes.valorEvento ?? t.valor) || 0;

        // üîí KM do √∫ltimo evento v√°lido (cronol√≥gico)
        const ts = t.createdAt || new Date(t.data || Date.now()).getTime();
        const kmEvento = Number(t.detalhes.km) || acc.km;

        return {
            litros: acc.litros + litros,
            valorFinanceiro: acc.valorFinanceiro + valorFinanceiro,
            valorEvento: acc.valorEvento + valorEvento,
            km: ts >= acc._ts ? kmEvento : acc.km,
            _ts: Math.max(acc._ts, ts)
        };
    }, {
        litros: 0,
        valorFinanceiro: 0,
        valorEvento: 0,
        km: 0,
        _ts: 0
    });

    // 4. Atualiza objeto operacional da jornada
    if (!jornada.custos) jornada.custos = {};

    jornada.custos.abastecimento = {
        litros: total.litros,

        // üî¥ N√ÉO √â CUSTO OPERACIONAL
        // Representa apenas pagamento feito
        valorFinanceiro: total.valorFinanceiro,

        // üü¢ EVENTO F√çSICO (ativo / base de m√©dia)
        valorEvento: total.valorEvento,

        km: total.km,

        // Campos derivados
        mediaCalculada: 0,
        litrosRestantes: 0,
        litrosConsumidosPainel: 0
    };

    // 5. C√°lculo seguro da m√©dia de consumo
    try {
        const dataJornada = new Date(
            Number(jornada.createdAt || Date.now())
        );
        const mediaObj = BusinessLogic.calcularMediaConsumo(jornada, dataJornada);
        jornada.custos.abastecimento.mediaCalculada = mediaObj?.media || 0;
    } catch (e) {
        jornada.custos.abastecimento.mediaCalculada = 0;
    }

    jornada.updatedAt = Date.now();
    return true;
},

 */
// =============================================================
        // SINCRONIA V40: O AGREGADOR INTELIGENTE (SOMA TUDO)
        // =============================================================
        sincronizarAbastecimentoComJornada: (transacaoReferencia) => {
            if (!transacaoReferencia) return false;

            // 1. Identifica a Jornada/Data Correta
            const dataObj = new Date(transacaoReferencia.data);
            const jornada = AppState.jornadas[transacaoReferencia.jornadaId] || BusinessLogic.getJornadaDoDia(dataObj);

            if (!jornada) return false;

            // 2. BUSCA TODAS AS TRANSA√á√ïES DESTE DIA (A M√°gica Acontece Aqui)
            // Em vez de olhar s√≥ a transa√ß√£o atual, olhamos o hist√≥rico do dia inteiro.
            const dataChave = Utils.formatarDataParaChave(dataObj);
            
            const abastecimentosDoDia = AppState.historicoTransacoes.filter(t => {
                // Filtra por ID da Jornada ou pela Data
                const mesmoDia = Utils.formatarDataParaChave(new Date(t.data)) === dataChave;
                const mesmaJornada = t.jornadaId === jornada.id;
                
                // Queremos apenas Combust√≠vel
                return (mesmaJornada || mesmoDia) && t.categoria === 'Abastecimento';
            });

            // 3. SE N√ÉO TIVER NADA (Foi tudo exclu√≠do), LIMPA A JORNADA
            if (abastecimentosDoDia.length === 0) {
                if (jornada.custos && jornada.custos.abastecimento) {
                    delete jornada.custos.abastecimento;
                    jornada.updatedAt = Date.now();
                }
                return true;
            }

            // 4. SOMA TUDO (REDUCE)
            // Aqui resolvemos o Pagamento Misto: somamos o valor de todas as parciais (R$ 20 + R$ 20 = R$ 40)
            // E resolvemos m√∫ltiplos abastecimentos: somamos os litros (10L + 20L = 30L)
            const total = abastecimentosDoDia.reduce((acc, t) => {
                const litros = t.detalhes?.litros || 0;
                const valor = t.valor || 0; // Soma o valor financeiro real de cada perna
                const km = Math.max(acc.km, (t.detalhes?.km || 0)); // Pega o maior KM registrado no dia
                
                return {
                    litros: acc.litros + litros,
                    valor: acc.valor + valor,
                    km: km
                };
            }, { litros: 0, valor: 0, km: 0 });

            // 5. ATUALIZA A JORNADA COM O TOTAL REAL
            if (!jornada.custos) jornada.custos = {};
            
            // Recalcula leitura de painel baseada no total acumulado
            const leituraAtual = transacaoReferencia.detalhes?.leituraPainel || 0;
            let consumidoPainel = 0;
            let restantes = 0;
            
            const { metodoLeituraCombustivel } = AppState.configuracoes;
            if (metodoLeituraCombustivel === 'consumo') {
                consumidoPainel = leituraAtual; // Simplifica√ß√£o para o √∫ltimo input
                // Busca refer√™ncia anterior para c√°lculo preciso de restantes (Opcional, mantido simples aqui)
            } else {
                restantes = leituraAtual; // Se informou leitura direta
            }

            jornada.custos.abastecimento = {
                litros: total.litros,
                valor: total.valor,
                km: total.km,
                mediaCalculada: 0, // Ser√° recalculada abaixo
                litrosRestantes: restantes,
                litrosConsumidosPainel: consumidoPainel
            };

            // Recalcula M√©dia do Dia
            const mediaObj = BusinessLogic.calcularMediaConsumo(jornada, dataObj);
            jornada.custos.abastecimento.mediaCalculada = mediaObj.media;

            jornada.updatedAt = Date.now();
            return true;
        },
        // DENTRO DE BusinessLogic:

    // 1. INICIAR JORNADA (Com prote√ß√£o de data)
// ============================================================================
// INICIAR JORNADA (V150.5 - BLINDAGEM DE INICIALIZA√á√ÉO)
// ============================================================================
iniciarJornada: () => {
    const hoje = Utils.getDataInputHoje();
    
    // 1. Sincronia de Data
    AppState.dataSelecionada = hoje;
    AppState.isToday = true;
    
    const jornadaHoje = BusinessLogic.getJornadaDoDia(new Date());
    
    // 2. Valida√ß√£o de KM Inicial
    const kmInicialManual = parseFloat(UIElements.kmInicialInput?.value) || 0;
    if (!kmInicialManual || kmInicialManual <= 0) {
        alert('Por favor, defina o KM inicial antes de come√ßar.');
        return;
    }

    // 3. Configura√ß√µes de Estado (O "Boot" da Jornada)
    jornadaHoje.kmInicial = kmInicialManual;
    jornadaHoje.status = 'ativa';
    jornadaHoje.inicioJornada = Date.now();
    
    // üß± PATCH DE HERMETICIDADE: Zeragem de acumuladores
    jornadaHoje.tempoInativoAcumulado = 0;
    jornadaHoje.kmProvisionado = 0;
    
    // 4. Limpeza de "Lixo" de encerramentos anteriores ou reaberturas
    jornadaHoje.fimJornada = null;
    jornadaHoje.horaFim = null;
    jornadaHoje.financeiroFinal = null;
    jornadaHoje.resumoFinal = null;

    // 5. Sincroniza√ß√£o de Identidade e Modo
    AppState.activeJornadaChave = hoje;
    AppState.jornadaAtivaId = hoje;
    AppState.jornadaAtiva = jornadaHoje;
    AppState.modo = 'jornada_ativa';

    // 6. Persist√™ncia
    Storage.salvarJornadaAtiva();
    Storage.salvarJornadas();
    
    // 7. Ativa√ß√£o de Motores Externos
    if (typeof TimeManager !== 'undefined') {
        TimeManager.iniciarCronometro();
    }
    
    if (AppState.configuracoes.usarGpsTracking) {
        // Zera o KM GPS para come√ßar do zero no rastreamento
        jornadaHoje.kmGps = 0; 
        if (typeof GpsTracker !== 'undefined') {
            GpsTracker.startTracking(kmInicialManual);
        }
    }
    
    // 8. Refresh da UI
    UIRenderer.render();
    
    console.log("üöÄ [SISTEMA] Jornada iniciada com sucesso e estado zerado.");
},
 
 // 2. FINALIZAR JORNADA (Abre o Modal de Metas)
// ============================================================================
// FINALIZAR JORNADA ‚Äî V151.0 (FLUXO DETERMIN√çSTICO BLINDADO)
// ============================================================================
finalizarJornada: async () => {
    console.group("üî¥ AUDITORIA: FINALIZAR JORNADA");

    // üîí TRAVA GLOBAL CONTRA LOOP / DUPLA EXECU√á√ÉO
    if (AppState._finalizacaoEmAndamento) {
        console.warn("‚õî Finaliza√ß√£o j√° em execu√ß√£o. Abortando chamada duplicada.");
        console.groupEnd();
        return;
    }
    AppState._finalizacaoEmAndamento = true;

    try {
        const jornadaAtiva = BusinessLogic.getJornadaAtiva();

        if (!jornadaAtiva) {
            console.error("‚ùå Nenhuma jornada ativa encontrada.");
            return;
        }

        // =====================================================================
        // üõë PASSO 1 ‚Äî BLOQUEIO ABSOLUTO SE HOUVER SERVI√áO ATIVO
        // =====================================================================
        const servicosAtivos = Array.isArray(jornadaAtiva.servicosEmAndamento)
            ? jornadaAtiva.servicosEmAndamento
            : [];

        if (servicosAtivos.length > 0) {
            console.warn("‚ö†Ô∏è BLOQUEIO: Servi√ßo em andamento impede finaliza√ß√£o.");

            AppState.bloqueioFinalizacao = true;

            UIRenderer.abrirModal('confirmacao', {
                titulo: '‚ö†Ô∏è Servi√ßo em Andamento',
                mensagem: `
                    Voc√™ n√£o pode finalizar a jornada enquanto houver um servi√ßo ativo.<br><br>
                    Finalize o servi√ßo atual antes de continuar.
                `,
                textoConfirmar: 'Entendi',
                esconderCancelar: true,
                callback: () => {
                    UIRenderer.fecharModal();
                }
            });

            return; // ‚õî MORTE TOTAL DO FLUXO
        }

        // =====================================================================
        // üßπ PASSO 2 ‚Äî GARANTIA DE KM FINAL
        // =====================================================================
        if (!jornadaAtiva.kmFinal || jornadaAtiva.kmFinal <= 0) {
            const ultimoKm = BusinessLogic.getUltimoKmRegistrado();
            if (ultimoKm > 0) {
                jornadaAtiva.kmFinal = ultimoKm;
                Storage.salvarJornadas();
            }
        }

        // =====================================================================
        // üìä PASSO 3 ‚Äî C√ÅLCULO FINANCEIRO FINAL
        // =====================================================================
        let lucroDisponivel = 0;

        try {
            const resumo = BusinessLogic.calcularResumoDia(jornadaAtiva, new Date());
            const custosFixos = BusinessLogic.calcularCustosFixosDiarios(new Date());

            const metaObrigatoria =
                (resumo.custoVariavelTotal || 0) +
                (custosFixos.operacional || 0) +
                (custosFixos.proLaboreDiario || 0);

            lucroDisponivel = Math.max(
                0,
                (resumo.totalGanhosFinalizados || 0) - metaObrigatoria
            );

            console.log("üìä Resumo Final:", {
                Bruto: resumo.totalGanhosFinalizados,
                MetaObrigatoria: metaObrigatoria,
                LucroDisponivel: lucroDisponivel
            });

        } catch (erro) {
            console.error("‚ùå Erro no c√°lculo financeiro:", erro);
            lucroDisponivel = 0;
        }

        // =====================================================================
        // üßæ PASSO 4 ‚Äî MODAL DE ALOCA√á√ÉO (√öNICO PONTO DE ENTRADA)
        // =====================================================================
        console.log("üì• Abrindo Modal de Aloca√ß√£o de Metas...");

        UIRenderer.abrirModal('alocacaoMetas', {
            lucroDisponivel: lucroDisponivel,
            kmFinalAuto: jornadaAtiva.kmFinal
                ? `KM Final sugerido: ${jornadaAtiva.kmFinal}`
                : '',
            callback: (dadosFinais) => {
                if (!dadosFinais) return;

                console.log("üèÅ Processando fechamento definitivo...");
                BusinessLogic.processarFechamentoFinanceiro(
                    jornadaAtiva,
                    dadosFinais
                );
            }
        });

    } catch (erro) {
        console.error("‚ùå Erro cr√≠tico na finaliza√ß√£o:", erro);
    } finally {
        // üßº LIBERA TRAVAS
        delete AppState._finalizacaoEmAndamento;
        console.groupEnd();
    }
},


// ============================================================================
// REABRER JORNADA (V152.0 - UNIFICA√á√ÉO DE CHAVE E HARD RESET)
// ============================================================================
reabrirJornada: () => {
    UIRenderer.abrirModal('confirmacao', { 
        titulo: 'Reabrir Jornada?', 
        mensagem: 'O sistema ser√° reiniciado para restaurar os dados e estornar valores. Confirma?', 
        callback: (confirmado) => {
            if (!confirmado) return;

            console.group("üöÄ [SISTEMA] Iniciando Reabertura At√¥mica");

            try {
                // 1. NORMALIZA√á√ÉO DA CHAVE (A raiz do problema)
                // For√ßamos o formato YYYY-MM-DD para evitar conflitos de ISO/Hor√°rio
                const chaveHoje = Utils.getDataInputHoje(); 
                const jornada = AppState.jornadas[chaveHoje];

                if (!jornada) {
                    console.error("‚ùå Erro: Jornada n√£o encontrada para a chave:", chaveHoje);
                    alert("Erro t√©cnico: Objeto da jornada n√£o localizado.");
                    console.groupEnd();
                    return;
                }

                // 2. ESTORNO FINANCEIRO (LEDGER)
                let estornosRealizados = 0;
                if (AppState.historicoTransacoes && Array.isArray(AppState.historicoTransacoes)) {
                    AppState.historicoTransacoes.forEach(t => {
                        // Filtro exato: transa√ß√µes autom√°ticas de fechamento deste dia
                        if (t.jornadaId === chaveHoje && t.tipo === 'transferencia' && !t.invalida) {
                            const metaId = t.contaDestino || (t.destino ? t.destino.id : null);
                            if (metaId) {
                                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                                if (meta) {
                                    const valor = Number(t.valor) || 0;
                                    // Devolve o dinheiro para o saldo da meta (ajuste visual)
                                    if (meta.tipo === 'parcelamento') {
                                        meta.valorProvisionado = Math.max(0, (meta.valorProvisionado || 0) - valor);
                                    } else {
                                        meta.valorAtual = (meta.valorAtual || 0) - valor;
                                    }
                                    // Invalida a transa√ß√£o original
                                    t.invalida = true;
                                    t.descricao += ' (Anulado - Reabertura)';
                                    estornosRealizados++;
                                }
                            }
                        }
                    });
                }
                console.log(`‚úÖ Ledger: ${estornosRealizados} estornos aplicados.`);

                // 3. RESET DO OBJETO JORNADA (LIMPANDO O ZUMBI)
                jornada.status = 'ativa';
                jornada.fimJornada = null;
                jornada.horaFim = null;
                
                // Remove os artefatos de encerramento para for√ßar o rec√°lculo
                if (jornada.financeiroFinal) delete jornada.financeiroFinal;
                if (jornada.resumoFinal) delete jornada.resumoFinal;

                // 4. SINCRONIA DE CHAVES NO DISCO (Onde a chave estava errada)
                // Removemos aspas extras e for√ßamos a string pura
                const chaveLimpa = String(chaveHoje).trim();
                localStorage.setItem('driver_app_jornada_ativa', chaveLimpa);
                localStorage.setItem('activeJornadaChave_v6.4', chaveLimpa);
                localStorage.setItem('preferencia_dre', AppState.modoDRE || 'presumido');

                // Verifica√ß√£o imediata (Anti-Zumbi)
                if (localStorage.getItem('driver_app_jornada_ativa') !== chaveLimpa) {
                    console.error("‚ö†Ô∏è Falha cr√≠tica: O disco n√£o aceitou a chave. Tentando novamente...");
                    localStorage.setItem('driver_app_jornada_ativa', chaveLimpa);
                }

                // 5. PERSIST√äNCIA BRUTA
                Storage.salvarJornadas();
                if (Storage.salvarTransacoes) Storage.salvarTransacoes();

                console.log("üíæ Storage sincronizado com a chave:", chaveLimpa);

                // 6. DESLIGAMENTO DO MOTOR DE TEMPO (Preven√ß√£o)
                if (typeof TimeManager !== 'undefined') {
                    TimeManager.rodando = false;
                    if (TimeManager.intervalo) clearInterval(TimeManager.intervalo);
                }

                console.groupEnd();

                // 7. HARD RESET (Limpeza de Mem√≥ria RAM)
                // O par√¢metro 'v' for√ßa o navegador a ignorar o cache da p√°gina
                setTimeout(() => {
                    // Usamos location.replace para garantir que n√£o haja volta para o estado zumbi no hist√≥rico
                    const url = window.location.origin + window.location.pathname + '?v=' + Date.now();
                    window.location.replace(url);
                }, 300);

            } catch (error) {
                console.error("‚ùå ERRO CR√çTICO NA REABERTURA:", error);
                alert("Falha ao reativar o sistema. Verifique o console.");
                console.groupEnd();
            }
        }
    });
},


/* 
    // 3. REABRIR JORNADA (A L√≥gica Robusta de Estorno)
    // Essa √© a fun√ß√£o que o bot√£o √Çmbar vai chamar
reabrirJornada: () => {
        UIRenderer.abrirModal('confirmacao', { 
            titulo: 'Reabrir Jornada?', 
            mensagem: 'Isso ir√° estornar os valores das caixinhas e reabrir o dia de HOJE. Confirma?', 
            callback: (confirmado) => {
                if (!confirmado) return;

                try {
                    const chaveJornada = Utils.getDataInputHoje();
                    const jornadaHoje = AppState.jornadas[chaveJornada];

                    // üõ°Ô∏è REGRA 6: Trava de estado para evitar re-estorno
                    if (!jornadaHoje || jornadaHoje.status !== 'finalizada') { 
                        alert("Esta jornada j√° est√° aberta ou n√£o foi encontrada."); 
                        return; 
                    }

                    let totalEstornado = 0;

                    // A. L√≥gica de Estorno (Apenas Invalida√ß√£o)
                    if (AppState.historicoTransacoes && Array.isArray(AppState.historicoTransacoes)) {
                        AppState.historicoTransacoes.forEach(t => {
                            // Filtro exato das transfer√™ncias autom√°ticas
                            if (t.jornadaId === chaveJornada && 
                                t.tipo === 'transferencia' && 
                                t.contaId === 'AUTO_ID_CARTEIRA' && 
                                !t.invalida) {
                                
                                const metaId = t.contaDestino || (t.destino ? t.destino.id : null);
                                
                                if (metaId) {
                                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                                    if (meta) {
                                        const valor = Number(t.valor) || 0;
                                        
                                        // üìâ Reverte o saldo da meta (Tira o dinheiro de l√°)
                                        if (meta.tipo === 'parcelamento') {
                                            meta.valorProvisionado = Math.max(0, (meta.valorProvisionado || 0) - valor);
                                        } else {
                                            meta.valorAtual = (meta.valorAtual || 0) - valor;
                                        }

                                        // üö´ Invalida a transa√ß√£o original (O dinheiro volta para a carteira aqui!)
                                        t.invalida = true;
                                        t.descricao += ' (Anulado - Reabertura)';
                                        t.isAjusteInterno = true; 
                                        t.categoria = 'Estorno';

                                        totalEstornado += valor;
                                    }
                                }
                            }
                        });
                    }

                    // ‚ùå BLOCO B REMOVIDO: N√£o criamos "Entrada" artificial. 
                    // O saldo se recupera pela invalida√ß√£o das sa√≠das acima.

                    // C. Ressuscita a Jornada (Estado At√¥mico)
                            // 1. Limpeza de Marcadores de Encerramento (O fim do "Estado Zumbi")
                            jornadaHoje.status = 'ativa';
                            jornadaHoje.fimJornada = null;
                            jornadaHoje.horaFim = null;

                            // 2. Exclus√£o de Artefatos Cont√°beis (For√ßa rec√°lculo em tempo real)
                            if (jornadaHoje.financeiroFinal) delete jornadaHoje.financeiroFinal;
                            if (jornadaHoje.resumoFinal) delete jornadaHoje.resumoFinal;

                            // 3. Sincroniza√ß√£o de Identidade no AppState
                            AppState.activeJornadaChave = chaveJornada;
                            AppState.jornadaAtivaId = chaveJornada;
                            AppState.jornadaAtiva = jornadaHoje;

                            // 4. Blindagem de Prefer√™ncias de Vis√£o
                            if (!AppState.modoDRE) AppState.modoDRE = 'presumido';

                            // üõ°Ô∏è 5. ESTADO OPERACIONAL PADR√ÉO (A pe√ßa que faltava)
                            // Garante que o sistema saiba que estamos "trabalhando" e libere os bot√µes
                            AppState.modo = 'jornada_ativa';

                            // 6. Persist√™ncia de Seguran√ßa
                            Storage.salvarJornadas();
                            Storage.salvarJornadaAtiva();
                            if(Storage.salvarConfiguracoes) Storage.salvarConfiguracoes();

                            // 7. Rein√≠cio do Motor de Tempo
                            if (typeof TimeManager !== 'undefined' && TimeManager.iniciarCronometro) {
                                TimeManager.iniciarCronometro();
                            }

                            // 8. Feedback e Hard Refresh para limpar cache de mem√≥ria
                            setTimeout(() => {
                                console.log("üöÄ [SISTEMA] Jornada Reativada em Modo:", AppState.modo);
                                location.reload(); 
                            }, 150);

                } catch (error) {
                    console.error("Erro cr√≠tico na reabertura:", error);
                    alert("Erro ao reabrir jornada. Verifique os logs.");
                }
            }
        });
    },


 */
// No seu objeto BusinessLogic, atualize estas fun√ß√µes:

    // 1. Valida√ß√£o de Saldo (Robustez M√°xima)
    validarSaldoParaDebito: (contaId, valorFloat) => {
        if (contaId === 'AUTO_ID_CARTEIRA') return true;

        const saldoAtual = BusinessLogic.calcularSaldoConta(contaId);
        
        // Convers√£o para Centavos (Compara√ß√£o Inteira)
        const saldoCents = Utils.Money.toCents(saldoAtual);
        const valorCents = Utils.Money.toCents(valorFloat);

        if (saldoCents < valorCents) {
            throw new Error(
                `Saldo insuficiente.\nNecess√°rio: ${Utils.formatarMoeda(valorFloat)}\nDispon√≠vel: ${Utils.formatarMoeda(saldoAtual)}`
            );
        }
        return true;
    },

    // 2. Transfer√™ncia Segura (Normalizada)
    transferirEntreEntidades: (origemId, destinoId, valorInput, descricao) => {
        try {
            // 1. Sanitiza√ß√£o B√°sica
            let valorFloat = Utils.parseMoeda(valorInput);

            // 2. Blindagem Extrema (NaN / Infinite)
            if (!Number.isFinite(valorFloat) || valorFloat <= 0) {
                throw new Error("Valor inv√°lido para transfer√™ncia.");
            }
            if (origemId === destinoId) throw new Error("Origem e destino n√£o podem ser iguais.");

            // 3. Normaliza√ß√£o (Garante 2 casas decimais estritas no banco de dados)
            // Transforma 10.555555 -> 1056 cents -> 10.56 float
            const valorSafe = Utils.Money.fromCents(Utils.Money.toCents(valorFloat));

            // 4. Valida√ß√£o de Saldo
            BusinessLogic.validarSaldoParaDebito(origemId, valorSafe);

            // 5. Execu√ß√£o
            const agora = new Date().toISOString();
            // Uso do UUID seguro com fallback
            const idTransferencia = Utils.gerarUUID(); 

            AppState.historicoTransacoes.push({
                id: idTransferencia,
                data: agora,
                tipo: 'transferencia',
                valor: valorSafe, // Valor normalizado
                contaId: origemId,
                contaDestino: destinoId,
                categoria: 'Transferencia',
                descricao: descricao || 'Transfer√™ncia entre contas',
                isManual: true
            });

            // 6. Commit
            Storage.salvarConfiguracoes();
            if(Storage.salvarTransacoes) Storage.salvarTransacoes();

            return true;

        } catch (e) {
            console.error(e);
            alert("Erro na opera√ß√£o: " + e.message);
            return false;
        }
    },
// =================================================================
        // DIAGN√ìSTICO DE META (O "Teste de Mesa" em Tempo Real)
        // =================================================================
        diagnosticarSaudeMeta: (meta) => {
            // Ignora se n√£o for meta mensal recorrente ou parcelamento
            if (meta.id === 'AUTO_ID_CARTEIRA' || meta.id === 'AUTO_ID_RESERVA_LUCRO') return null;
            if (!meta.valorTotal || meta.valorTotal <= 0) return null;

            const hoje = new Date();
            const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
            const diaAtual = hoje.getDate();
            
            // 1. % do Tempo que j√° passou no m√™s
            const percentualTempo = (diaAtual / ultimoDiaMes) * 100;

            // 2. % do Valor que j√° foi guardado
            // Se for parcelamento, olhamos o valor da parcela atual, n√£o do total da d√≠vida
            let alvoMes = meta.valorTotal; 
            
            // Ajuste para parcelamentos/custos mensais
            if (meta.tipo === 'parcelamento' && meta.financiamento) {
                alvoMes = meta.financiamento.valorParcela;
            } else if (meta.id === 'META_CUSTOS_MENSAIS') {
                // O alvo √© o total dos custos ativos
                alvoMes = meta.valorTotal; 
            } else if (meta.contribuicaoMensal > 0) {
                alvoMes = meta.contribuicaoMensal;
            }

            // Quanto j√° tem (considerando saldo acumulado ou provisionado no m√™s)
            // Para 'META_CUSTOS_MENSAIS', o valorAtual reseta/flutua, ent√£o usamos ele.
            // Para parcelamento, usamos o valorProvisionado.
            const temHoje = (meta.tipo === 'parcelamento') ? (meta.valorProvisionado || 0) : (meta.valorAtual || 0);

            const percentualFinanceiro = (temHoje / alvoMes) * 100;

            // 3. O Veredito (Toler√¢ncia de 5% para n√£o ser chato demais)
            const diferenca = percentualFinanceiro - percentualTempo;

            if (diferenca < -5) {
                return {
                    status: 'ATRASADO',
                    msg: `Defasagem de ${Math.abs(diferenca).toFixed(0)}%. (Ideal: ${Math.round(percentualTempo)}% | Real: ${Math.round(percentualFinanceiro)}%)`,
                    sugestao: 'Ative o Modo Din√¢mico',
                    cor: 'text-red-400',
                    bg: 'bg-red-500/10'
                };
            } else if (diferenca < 0) {
                return {
                    status: 'ALERTA',
                    msg: 'Ligeiramente abaixo da meta.',
                    sugestao: 'Acompanhe',
                    cor: 'text-amber-400',
                    bg: 'bg-amber-500/10'
                };
            }
            
            return { status: 'OK', msg: 'Meta em dia.', cor: 'text-green-400', bg: 'bg-green-500/10' };
        },



// 1. NOVO HELPER: C√ÅLCULO DE DEPRECIA√á√ÉO POR PER√çODO
// (Adicione isso dentro de BusinessLogic, antes do gerarDRE)
calcularDepreciacaoPeriodo: (startDate, endDate) => {
    const { veiculo } = AppState.configuracoes;
    if (!veiculo.valor || veiculo.valor <= 0) return 0;

    const vidaUtilAnos = veiculo.vidaUtil || 5;
    const depreciacaoAnual = veiculo.valor / vidaUtilAnos;
    const depreciacaoDiaria = depreciacaoAnual / 365;

    // Diferen√ßa em dias
    const diffTime = Math.abs(endDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    // Retorna a perda de valor do carro nesse per√≠odo
    return depreciacaoDiaria * diffDays;
},

// ============================================================================
        // MOTOR DE RELAT√ìRIO DRE (V130 - MENSAL/PERI√ìDICO)
        // Atualizado para bater 100% com a l√≥gica do Painel Di√°rio
        // ============================================================================
        // ============================================================================
        // MOTOR DE RELAT√ìRIO DRE (V131 - BLINDAGEM DE DATA E ID)
        // ============================================================================
        gerarDRE: (startDate, endDate) => {
            const dreData = { 
                receitaBruta: 0, 
                custosVariaveis: 0, 
                margemContribuicao: 0,
                custosFixos: 0, 
                manutencao: 0, 
                depreciacao: 0, 
                jurosMultas: 0, 
                lucroOperacional: 0, 
                amortizacaoDividas: 0, 
                proLabore: 0,
                resultadoCaixa: 0,
                audit: [] 
            };

            // 1. CONVERS√ÉO SEGURA DE DATAS (TIMESTAMP)
            // Garante que comparamos n√∫meros (milissegundos) para n√£o ter erro de fuso/hora
            const tsStart = new Date(startDate).setHours(0,0,0,0);
            const tsEnd = new Date(endDate).setHours(23,59,59,999);

            // 2. FILTRO MESTRE (Data Econ√¥mica + Valida√ß√£o)
            const transacoes = AppState.historicoTransacoes.filter(t => { 
                if (!t || t.invalida) return false;
                
                // Usa Data Econ√¥mica (Jornada) se houver, sen√£o Data Real
                const dataRef = t.dataEconomica || t.data;
                const tsRef = new Date(dataRef).getTime(); // Garante n√∫mero

                return tsRef >= tsStart && tsRef <= tsEnd; 
            });
        /*
        gerarDRE: (startDate, endDate) => {
            const dreData = { 
                receitaBruta: 0, 
                custosVariaveis: 0, 
                margemContribuicao: 0,
                custosFixos: 0, 
                manutencao: 0, 
                depreciacao: 0, 
                jurosMultas: 0, 
                lucroOperacional: 0, 
                amortizacaoDividas: 0, 
                proLabore: 0,
                resultadoCaixa: 0,
                audit: [] 
            };

            // üî• FILTRO V130: DATA ECON√îMICA (COMPET√äNCIA)
            // O relat√≥rio agora obedece a data da jornada, n√£o a do rel√≥gio (para a virada de noite)
            const transacoes = AppState.historicoTransacoes.filter(t => { 
                if (t.invalida) return false;
                
                // Usa a Data Econ√¥mica se existir, sen√£o usa a data f√≠sica
                const dataConsiderada = t.dataEconomica ? new Date(t.dataEconomica) : new Date(t.data);
                
                return dataConsiderada >= startDate && dataConsiderada <= endDate; 
            });
            */
            // Listas de Classifica√ß√£o (Whitelists)
            const catsManutencao = ['Manuten√ß√£o', 'Motor', 'Freios', 'Pneus', 'Suspens√£o', 'El√©trico', 'Arrefecimento', '√ìleo', 'Filtros', 'Revis√£o', 'Funilaria'];
            const catsCustosFixos = ['Administrativo', 'Impostos', 'Seguro', 'Ve√≠culo', 'Outro C. Fixo', 'Custos Fixos'];
            const catsReceita = ['Corrida', 'Entrega', 'Particular', 'Gorjeta', 'Outro'];

            transacoes.forEach(t => {
                let auditEntry = { id: t.id, desc: t.descricao || '', valor: t.valor, type: t.tipo, buckets: [] };
                const descLower = auditEntry.desc.toLowerCase();

                // üõë Blacklist
                if (descLower.includes('estorno') || descLower.includes('lucro excedente')) return; 

                // üí∞ Receitas
                if (t.tipo === 'entrada' && catsReceita.includes(t.categoria)) {
                    dreData.receitaBruta = Utils.somarCentavos(dreData.receitaBruta, t.valor);
                    auditEntry.buckets.push('Receita Bruta');
                }

                // üìâ Despesas
                if (t.tipo === 'saida') {
                    // üî• FILTRO V130: IMPACTA RESULTADO
                    // Se estiver marcado como FALSE (ex: caixinha), ignora no DRE Real
                    if (t.impactaResultado === false) {
                        auditEntry.buckets.push('Ignorado (Investimento/Provis√£o)');
                        return; 
                    }

                    const cat = t.categoria || '';
                    const isAbastecimento = cat === 'Combustivel' || cat === 'abastecimento' || descLower.includes('abastecimento') || descLower.includes('posto ');

                    // A) Vari√°veis
                    if ((t.isCustoOperacional === true || isAbastecimento) && !catsManutencao.includes(cat) && !catsCustosFixos.includes(cat)) {
                        dreData.custosVariaveis = Utils.somarCentavos(dreData.custosVariaveis, t.valor);
                        auditEntry.buckets.push('Custos Vari√°veis');
                    }
                    // B) Manuten√ß√£o
                    else if (catsManutencao.includes(cat)) {
                        if (t.contaId !== 'AUTO_ID_POUPANCA_KM' && t.contaId !== 'META_MANUTENCAO') { 
                            dreData.manutencao = Utils.somarCentavos(dreData.manutencao, t.valor);
                            auditEntry.buckets.push('Manuten√ß√£o');
                        }
                    }
                    // C) Fixos
                    else if (catsCustosFixos.includes(cat)) {
                        if (t.contaId !== 'META_CUSTOS_MENSAIS') {
                            dreData.custosFixos = Utils.somarCentavos(dreData.custosFixos, t.valor);
                            auditEntry.buckets.push('Custos Fixos');
                        }
                    }
                    // D) Financeiros
                    else if (cat === 'Juros e Multas' || descLower.includes('juros') || descLower.includes('multa')) {
                        dreData.jurosMultas = Utils.somarCentavos(dreData.jurosMultas, t.valor);
                        auditEntry.buckets.push('Juros e Multas');
                    }
                }

                // üè¶ Provis√µes / Ajustes de Caixa
                if (t.tipo === 'transferencia' && t.contaId === 'AUTO_ID_CARTEIRA' && t.contaDestino) {
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === t.contaDestino);
                    if (meta) {
                        if (meta.tipo === 'parcelamento') {
                            dreData.amortizacaoDividas = Utils.somarCentavos(dreData.amortizacaoDividas, t.valor);
                            auditEntry.buckets.push('Amortiza√ß√£o');
                        }
                        else if (meta.id === 'AUTO_ID_PROLABORE') {
                            dreData.proLabore = Utils.somarCentavos(dreData.proLabore, t.valor);
                            auditEntry.buckets.push('Pr√≥-Labore');
                        }
                        // Mant√©m compatibilidade com DRE H√≠brido (Opcional)
                        else if (meta.id === 'META_CUSTOS_MENSAIS') {
                            dreData.custosFixos = Utils.somarCentavos(dreData.custosFixos, t.valor);
                        }
                        else if (meta.tipo === 'poupanca_km') {
                            dreData.manutencao = Utils.somarCentavos(dreData.manutencao, t.valor);
                        }
                    }
                }
                
                if (auditEntry.buckets.length > 0) dreData.audit.push(auditEntry);
            });
            
            // --- Deprecia√ß√£o e Resultados Finais ---
            if (BusinessLogic.calcularDepreciacaoPeriodo) {
                const dep = BusinessLogic.calcularDepreciacaoPeriodo(startDate, endDate);
                dreData.depreciacao = Utils.somarCentavos(0, dep);
            }

            dreData.margemContribuicao = Utils.somarCentavos(dreData.receitaBruta, -dreData.custosVariaveis);
            
            let totalDespesasOp = 0;
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.custosFixos);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.manutencao);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.depreciacao);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.jurosMultas);

            dreData.lucroOperacional = Utils.somarCentavos(dreData.margemContribuicao, -totalDespesasOp);
            
            let caixaTemp = Utils.somarCentavos(dreData.lucroOperacional, dreData.depreciacao); 
            caixaTemp = Utils.somarCentavos(caixaTemp, -dreData.amortizacaoDividas);
            dreData.resultadoCaixa = Utils.somarCentavos(caixaTemp, -dreData.proLabore);
            
            return dreData;
        },


/* 

// ============================================================================
        // RELAT√ìRIO DRE MENSAL (V125 - MODERNIZADO E ALINHADO COM O DI√ÅRIO)
        // ============================================================================
        gerarDRE: (startDate, endDate) => {
            const dreData = { 
                receitaBruta: 0, 
                custosVariaveis: 0, 
                margemContribuicao: 0,
                custosFixos: 0, 
                manutencao: 0, 
                depreciacao: 0, 
                jurosMultas: 0, 
                lucroOperacional: 0, 
                amortizacaoDividas: 0, 
                proLabore: 0,
                resultadoCaixa: 0,
                audit: [] 
            };

            const transacoes = AppState.historicoTransacoes.filter(t => { 
                const data = new Date(t.data); 
                return data >= startDate && data <= endDate && !t.invalida; 
            });
            
            // LISTAS DE SEGURAN√áA (WHITELISTS) - Mantidas para classifica√ß√£o
            const catsManutencao = ['Manuten√ß√£o', 'Motor', 'Freios', 'Pneus', 'Suspens√£o', 'El√©trico', 'Arrefecimento', '√ìleo', 'Filtros', 'Revis√£o', 'Funilaria'];
            const catsCustosFixos = ['Administrativo', 'Impostos', 'Seguro', 'Ve√≠culo', 'Outro C. Fixo', 'Custos Fixos'];
            const catsReceita = ['Corrida', 'Entrega', 'Particular', 'Gorjeta', 'Outro'];

            transacoes.forEach(t => {
                let auditEntry = { id: t.id, desc: t.descricao || '', valor: t.valor, type: t.tipo, buckets: [] };
                const descLower = auditEntry.desc.toLowerCase();

                // üõë 1. FILTRO DE SEGURAN√áA M√ÅXIMA
                if (descLower.includes('estorno') || descLower.includes('lucro excedente')) return; 

                // üí∞ 2. RECEITA (SOMENTE DINHEIRO NOVO)
                if (t.tipo === 'entrada' && catsReceita.includes(t.categoria)) {
                    dreData.receitaBruta = Utils.somarCentavos(dreData.receitaBruta, t.valor);
                    auditEntry.buckets.push('Receita Bruta');
                }

                // üìâ 3. DESPESAS PAGAS (SA√çDA REAL)
                if (t.tipo === 'saida') {
                    const cat = t.categoria || '';
                    const isAbastecimento = cat === 'Combustivel' || cat === 'abastecimento' || descLower.includes('abastecimento') || descLower.includes('posto ');
                    
                    // üî• NOVIDADE V124: Checa se impacta resultado (Se existir a flag)
                    // Se a flag for explicitamente FALSE, ignoramos aqui (pois √© apenas transfer√™ncia/provis√£o)
                    if (t.impactaResultado === false) {
                        auditEntry.buckets.push('Ignorado (Provis√£o/Transfer√™ncia)');
                        return; // Pula essa itera√ß√£o
                    }

                    // A) Custo Vari√°vel (Combust√≠vel & Taxas)
                    if ((t.isCustoOperacional === true || isAbastecimento) && !catsManutencao.includes(cat) && !catsCustosFixos.includes(cat)) {
                        dreData.custosVariaveis = Utils.somarCentavos(dreData.custosVariaveis, t.valor);
                        auditEntry.buckets.push('Custos Vari√°veis');
                    }
                    
                    // B) Manuten√ß√£o Paga na Oficina
                    else if (catsManutencao.includes(cat)) {
                        // L√≥gica Anti-Duplica√ß√£o (Se pagou com a caixinha da manuten√ß√£o, j√° foi contabilizado na provis√£o? DEPENDE DO MODELO)
                        // No Modelo V124 Real, a provis√£o N√ÉO conta, s√≥ o gasto conta. Ent√£o somamos aqui.
                        if (t.contaId !== 'AUTO_ID_POUPANCA_KM' && t.contaId !== 'META_MANUTENCAO') { 
                            dreData.manutencao = Utils.somarCentavos(dreData.manutencao, t.valor);
                            auditEntry.buckets.push('Manuten√ß√£o (Real)');
                        } else {
                            // Se pagou COM a caixinha, e a gente j√° contabilizou a entrada na caixinha, aqui ignoramos.
                            // Mas como estamos indo para o modelo REAL, dever√≠amos contar aqui e ignorar a entrada na caixinha.
                            // Vou manter sua l√≥gica original por seguran√ßa, mas deixo o alerta.
                            auditEntry.buckets.push('Manuten√ß√£o (Ignorado: Pago c/ Provis√£o)');
                        }
                    }
                    
                    // C) Custos Fixos Pagos
                    else if (catsCustosFixos.includes(cat)) {
                        if (t.contaId !== 'META_CUSTOS_MENSAIS') {
                            dreData.custosFixos = Utils.somarCentavos(dreData.custosFixos, t.valor);
                            auditEntry.buckets.push('Custos Fixos (Real)');
                        } else {
                            auditEntry.buckets.push('Custo Fixo (Ignorado: Pago c/ Provis√£o)');
                        }
                    }
                    
                    // D) Juros e Multas
                    else if (cat === 'Juros e Multas' || descLower.includes('juros') || descLower.includes('multa')) {
                        dreData.jurosMultas = Utils.somarCentavos(dreData.jurosMultas, t.valor);
                        auditEntry.buckets.push('Juros e Multas');
                    }
                }

                // üè¶ 4. PROVIS√ïES ESTRAT√âGICAS (TRANSFER√äNCIAS INTERNAS)
                // Aqui √© onde entra o "Custo de Compet√™ncia" (Guardar dinheiro conta como custo?)
                // Se estamos no modelo REAL, isso deveria ser ignorado.
                // Mas seu relat√≥rio parece querer mostrar amortiza√ß√£o e pr√≥-labore.
                if (t.tipo === 'transferencia' && t.contaId === 'AUTO_ID_CARTEIRA' && t.contaDestino) {
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === t.contaDestino);

                    if (meta) {
                        // Amortiza√ß√£o de D√≠vida (Isso sempre sai do Caixa Livre)
                        if (meta.tipo === 'parcelamento') {
                            dreData.amortizacaoDividas = Utils.somarCentavos(dreData.amortizacaoDividas, t.valor);
                            auditEntry.buckets.push('Amortiza√ß√£o');
                        }
                        // Pr√≥-Labore
                        else if (meta.id === 'AUTO_ID_PROLABORE') {
                            dreData.proLabore = Utils.somarCentavos(dreData.proLabore, t.valor);
                            auditEntry.buckets.push('Pr√≥-Labore');
                        }
                        // CUSTOS FIXOS (PROVIS√ÉO)
                        // Se voc√™ usou o checkbox "Modo Real" no di√°rio, voc√™ provavelmente n√£o quer ver isso aqui como custo.
                        // Mas vou manter para consist√™ncia com seu relat√≥rio atual.
                        else if (meta.id === 'META_CUSTOS_MENSAIS') {
                            dreData.custosFixos = Utils.somarCentavos(dreData.custosFixos, t.valor);
                            auditEntry.buckets.push('Custos Fixos (Prov)');
                        }
                        // MANUTEN√á√ÉO (PROVIS√ÉO KM)
                        else if (meta.tipo === 'poupanca_km') {
                            dreData.manutencao = Utils.somarCentavos(dreData.manutencao, t.valor);
                            auditEntry.buckets.push('Manuten√ß√£o (Prov KM)');
                        }
                    }
                }
                
                if (auditEntry.buckets.length > 0) dreData.audit.push(auditEntry);
            });
            
            // --- 5. C√ÅLCULO DA DEPRECIA√á√ÉO ---
            if (BusinessLogic.calcularDepreciacaoPeriodo) {
                const dep = BusinessLogic.calcularDepreciacaoPeriodo(startDate, endDate);
                dreData.depreciacao = Utils.somarCentavos(0, dep);
            }

            // --- 6. RESULTADOS ---
            dreData.margemContribuicao = Utils.somarCentavos(dreData.receitaBruta, -dreData.custosVariaveis);
            
            let totalDespesasOp = 0;
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.custosFixos);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.manutencao);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.depreciacao);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.jurosMultas);

            dreData.lucroOperacional = Utils.somarCentavos(dreData.margemContribuicao, -totalDespesasOp);
            
            // Resultado de Caixa
            let caixaTemp = Utils.somarCentavos(dreData.lucroOperacional, dreData.depreciacao); 
            caixaTemp = Utils.somarCentavos(caixaTemp, -dreData.amortizacaoDividas);
            dreData.resultadoCaixa = Utils.somarCentavos(caixaTemp, -dreData.proLabore);
            
            return dreData;
        },

 */
/* 
// --- RELAT√ìRIO DRE (V3: H√çBRIDO BLINDADO) ---
        // Une a seguran√ßa fiscal com a precis√£o gerencial do KM/Custo Fixo
        gerarDRE: (startDate, endDate) => {
            const dreData = { 
                receitaBruta: 0, 
                custosVariaveis: 0, 
                margemContribuicao: 0,
                custosFixos: 0, 
                manutencao: 0, 
                depreciacao: 0, 
                jurosMultas: 0, 
                lucroOperacional: 0, 
                amortizacaoDividas: 0, 
                proLabore: 0,
                resultadoCaixa: 0,
                audit: [] 
            };

            const transacoes = AppState.historicoTransacoes.filter(t => { 
                const data = new Date(t.data); 
                return data >= startDate && data <= endDate; 
            });
            
            // LISTAS DE SEGURAN√áA (WHITELISTS)
            const catsManutencao = ['Manuten√ß√£o', 'Motor', 'Freios', 'Pneus', 'Suspens√£o', 'El√©trico', 'Arrefecimento', '√ìleo', 'Filtros', 'Revis√£o', 'Funilaria'];
            const catsCustosFixos = ['Administrativo', 'Impostos', 'Seguro', 'Ve√≠culo', 'Outro C. Fixo', 'Custos Fixos'];
            const catsReceita = ['Corrida', 'Entrega', 'Particular', 'Gorjeta', 'Outro'];

            transacoes.forEach(t => {
                let auditEntry = { id: t.id, desc: t.descricao || '', valor: t.valor, type: t.tipo, buckets: [] };
                const descLower = auditEntry.desc.toLowerCase();

                // üõë 1. FILTRO DE SEGURAN√áA M√ÅXIMA (BLACK LIST)
                // Elimina qualquer ru√≠do de estorno, reabertura ou lucro excedente
                if (descLower.includes('estorno') || descLower.includes('lucro excedente')) {
                    return; 
                }

                // üí∞ 2. RECEITA (SOMENTE DINHEIRO NOVO)
                if (t.tipo === 'entrada' && catsReceita.includes(t.categoria)) {
                    dreData.receitaBruta = Utils.somarCentavos(dreData.receitaBruta, t.valor);
                    auditEntry.buckets.push('Receita Bruta');
                }

                // üìâ 3. DESPESAS PAGAS (SA√çDA REAL)
                // üìâ 3. DESPESAS PAGAS (SA√çDA REAL)
            if (t.tipo === 'saida') {
                
                // Defini√ß√£o de Categorias Cr√≠ticas (Normaliza√ß√£o)
                const cat = t.categoria || '';
                const desc = (t.descricao || '').toLowerCase();
                const isAbastecimento = cat === 'Combustivel' || cat === 'abastecimento' || desc.includes('abastecimento') || desc.includes('posto ');
                
                // A) Custo Vari√°vel (Combust√≠vel & Taxas)
                // BLINDAGEM: Se for combust√≠vel, ENTRA, mesmo se a flag isCustoOperacional falhar.
                if ((t.isCustoOperacional === true || isAbastecimento) && !catsManutencao.includes(cat) && !catsCustosFixos.includes(cat)) {
                    dreData.custosVariaveis = Utils.somarCentavos(dreData.custosVariaveis, t.valor);
                    auditEntry.buckets.push('Custos Vari√°veis');
                }
                
                // B) Manuten√ß√£o Paga na Oficina
                else if (catsManutencao.includes(cat)) {
                    // EVITAR DUPLA CONTAGEM:
                    // Se voc√™ pagou a oficina usando o saldo da "Poupan√ßa KM" (que j√° foi contabilizada na provis√£o),
                    // n√£o devemos somar aqui de novo, sen√£o o lucro cai 2x.
                    if (t.contaId !== 'AUTO_ID_POUPANCA_KM' && t.contaId !== 'META_MANUTENCAO') { 
                        dreData.manutencao = Utils.somarCentavos(dreData.manutencao, t.valor);
                        auditEntry.buckets.push('Manuten√ß√£o (Real)');
                    } else {
                        auditEntry.buckets.push('Manuten√ß√£o (Ignorado: Pago c/ Provis√£o)');
                    }
                }
                
                // C) Custos Fixos Pagos
                else if (catsCustosFixos.includes(cat)) {
                    // Mesmo racioc√≠nio: Se pagou usando a caixinha META_CUSTOS, ignora aqui pois j√° contou na provis√£o.
                    if (t.contaId !== 'META_CUSTOS_MENSAIS') {
                        dreData.custosFixos = Utils.somarCentavos(dreData.custosFixos, t.valor);
                        auditEntry.buckets.push('Custos Fixos (Real)');
                    } else {
                        auditEntry.buckets.push('Custo Fixo (Ignorado: Pago c/ Provis√£o)');
                    }
                }
                
                // D) Juros e Multas
                else if (cat === 'Juros e Multas' || desc.includes('juros') || desc.includes('multa')) {
                    dreData.jurosMultas = Utils.somarCentavos(dreData.jurosMultas, t.valor);
                    auditEntry.buckets.push('Juros e Multas');
                }
            }

                // üè¶ 4. PROVIS√ïES ESTRAT√âGICAS (O H√çBRIDO)
                // Consideramos transfer√™ncias para certas metas como "Despesa Gerencial"
                if (t.tipo === 'transferencia' && t.contaId === 'AUTO_ID_CARTEIRA' && t.contaDestino) {
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === t.contaDestino);

                    if (meta) {
                        // D√≠vida (Amortiza√ß√£o n√£o √© despesa operacional, √© financeira/caixa)
                        if (meta.tipo === 'parcelamento') {
                            dreData.amortizacaoDividas = Utils.somarCentavos(dreData.amortizacaoDividas, t.valor);
                            auditEntry.buckets.push('Amortiza√ß√£o');
                        }
                        // Pr√≥-Labore (Retirada de S√≥cio)
                        else if (meta.id === 'AUTO_ID_PROLABORE') {
                            dreData.proLabore = Utils.somarCentavos(dreData.proLabore, t.valor);
                            auditEntry.buckets.push('Pr√≥-Labore');
                        }
                        // Custos Fixos (Consideramos a provis√£o como o fato gerador da despesa mensal)
                        else if (meta.id === 'META_CUSTOS_MENSAIS') {
                            dreData.custosFixos = Utils.somarCentavos(dreData.custosFixos, t.valor);
                            auditEntry.buckets.push('Custos Fixos (Prov)');
                        }
                        // Manuten√ß√£o KM (CRUCIAL: O desgaste do carro conta como despesa aqui)
                        else if (meta.tipo === 'poupanca_km') {
                            dreData.manutencao = Utils.somarCentavos(dreData.manutencao, t.valor);
                            auditEntry.buckets.push('Manuten√ß√£o (Prov KM)');
                        }
                        // OBS: Reserva de Lucro e Opcionais N√ÉO entram aqui, pois s√£o Lucro L√≠quido Acumulado.
                    }
                }
                
                if (auditEntry.buckets.length > 0) dreData.audit.push(auditEntry);
            });
            
            // --- 5. C√ÅLCULO DA DEPRECIA√á√ÉO (PERDA DE VALOR DO BEM) ---
            if (BusinessLogic.calcularDepreciacaoPeriodo) {
                const dep = BusinessLogic.calcularDepreciacaoPeriodo(startDate, endDate);
                dreData.depreciacao = Utils.somarCentavos(0, dep);
            }

            // --- 6. RESULTADOS ---
            dreData.margemContribuicao = Utils.somarCentavos(dreData.receitaBruta, -dreData.custosVariaveis);
            
            let totalDespesasOp = 0;
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.custosFixos);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.manutencao);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.depreciacao);
            totalDespesasOp = Utils.somarCentavos(totalDespesasOp, dreData.jurosMultas);

            dreData.lucroOperacional = Utils.somarCentavos(dreData.margemContribuicao, -totalDespesasOp);
            
            // Resultado de Caixa (Dinheiro no Bolso vs Lucro Cont√°bil)
            let caixaTemp = Utils.somarCentavos(dreData.lucroOperacional, dreData.depreciacao); // Devolve deprecia√ß√£o (n√£o sai caixa)
            caixaTemp = Utils.somarCentavos(caixaTemp, -dreData.amortizacaoDividas);
            dreData.resultadoCaixa = Utils.somarCentavos(caixaTemp, -dreData.proLabore);
            
            return dreData;
        },

 */

 // ---------------------------------------------------------
        // 1. HELPERS DE RECEITA E C√ÅLCULOS B√ÅSICOS
        // ---------------------------------------------------------
// --- C√ÅLCULO CIR√öRGICO DO DIA COM FILTRO (CORRIGIDO PARA FIXOS) ---
        calcularResumoDiaComFiltro: (jornada, filter, dataReferencia) => {
            let totalGanhos = 0;
            let totalCustos = 0;
            let totalKm = 0;
            let totalTempo = 0;

            const _fmt = (s) => String(s || '').trim().toLowerCase();
            const fCat = _fmt(filter.category);
            const fSub = filter.subcategory ? _fmt(filter.subcategory) : null;

            // A. RECEITAS
            if (filter.type === 'receita') {
                (jornada.atividades || []).forEach(at => {
                    const cat = _fmt(at.categoria);
                    const sub = _fmt(at.subcategoria || 'N/A');

                    let match = false;
                    if (cat === fCat) {
                        if (!filter.subcategory) match = true;
                        else if (filter.subcategory === 'N/A') match = (sub === 'n/a' || sub === '');
                        else match = (sub === fSub);
                    }

                    if (match) {
                        totalGanhos += Number(at.valor) || 0;
                        const km = (at.kmFinalServico && at.kmInicialServico) ? Math.max(0, at.kmFinalServico - at.kmInicialServico) : 0;
                        totalKm += km;
                        totalTempo += (at.duracaoMs || 0);
                    }
                });
            }

            // B. CUSTOS
            if (filter.type === 'custo') {
                // 1. Custos Vari√°veis (Jornada)
                if (fCat === 'abastecimento') {
                    if (!fSub || fSub === 'combust√≠vel' || fSub === 'combustivel') {
                         totalCustos += (jornada.custos?.abastecimento?.valor || 0);
                    }
                }

                if (jornada.custos && jornada.custos.outros) {
                    jornada.custos.outros.forEach(c => {
                        const cCat = _fmt(c.categoria);
                        const cSub = _fmt(c.subcategoria || c.descricao || 'N/A');
                        if (cCat === fCat) {
                            if (!fSub || cSub === fSub || (filter.subcategory === 'N/A' && (cSub === 'n/a' || cSub === ''))) {
                                totalCustos += c.valor;
                            }
                        }
                    });
                }
                
                // 2. CUSTOS FIXOS E PROVIS√ïES (A CORRE√á√ÉO)
                // Precisamos calcular a fra√ß√£o do dia se o filtro bater com um custo fixo
                if (dataReferencia) {
                    const diasTrabalho = BusinessLogic.calcularDiasTrabalhoNoMes(dataReferencia.getFullYear(), dataReferencia.getMonth());
                    
                    // a) Deprecia√ß√£o
                    if (fCat === 'deprecia√ß√£o') {
                        const { veiculo } = AppState.configuracoes;
                        if (veiculo.valor > 0 && diasTrabalho > 0) {
                             const depDiaria = ((veiculo.valor / (veiculo.vidaUtil || 5)) / 12) / diasTrabalho;
                             totalCustos += depDiaria;
                        }
                    }

                    // b) Lista de Custos Fixos
                    AppState.configuracoes.custosFixos.forEach(cf => {
                        if (_fmt(cf.categoria || 'Outro C. Fixo') === fCat) {
                            const subCf = _fmt(cf.subcategoria || cf.descricao);
                            if (!fSub || subCf === fSub) {
                                totalCustos += (cf.valor / diasTrabalho);
                            }
                        }
                    });
                    
                    // c) Metas Financeiras (D√≠vidas/Poupan√ßas)
                    if (fCat === 'metas financeiras' || fCat === 'manuten√ß√£o (prov.)') {
                        AppState.configuracoes.metasFinanceiras
                            .filter(m => m.incluirComoCustoDiario !== false)
                            .forEach(m => {
                                const nomeCat = (m.tipo === 'poupanca_km' || m.descricao.includes('Fundo')) ? 'manuten√ß√£o (prov.)' : 'metas financeiras';
                                if (nomeCat === fCat) {
                                    if (!fSub || _fmt(m.descricao) === fSub) {
                                        totalCustos += BusinessLogic.calcularCustoDiarioMeta(m, dataReferencia);
                                    }
                                }
                            });
                    }
                }
            }

            return {
                totalGanhosFinalizados: totalGanhos,
                custoOperacionalTotal: totalCustos,
                kmTotal: totalKm,
                tempoLiquido: totalTempo,
                duracaoPausas: 0,
                lucroReal: totalGanhos - totalCustos,
                mediaConsumoDia: 0
            };
        },     
getTotalGanhos: (jornada) => {
        if (!jornada || !Array.isArray(jornada.atividades)) return 0;

        return jornada.atividades.reduce((total, atividade) => {
            const valorCorrida = parseFloat(atividade.valor) || 0;
            return total + valorCorrida;
        }, 0);
    },
getGorjetaTotalDaJornada: (jornada) => {
            if (!jornada || !jornada.atividades) return 0;
            return jornada.atividades.reduce((total, ativ) => {
                // Soma a gorjeta nativa (valorGorjeta) + a manual (valorExtras)
                return total + (ativ.valorGorjeta || 0) + (ativ.valorExtras || 0);
            }, 0);
        },

getTaxaTotalDaJornada: (jornada) => {
        if (!jornada || !Array.isArray(jornada.atividades)) return 0;

        return jornada.atividades.reduce((total, atividade) => {
            let taxa = 0;

            // Prioridade 1: Taxa original salva (Congelada no momento do Extra)
            if (atividade.taxaAppOriginal !== undefined && atividade.taxaAppOriginal !== null) {
                taxa = parseFloat(atividade.taxaAppOriginal);
            } 
            // Prioridade 2: C√°lculo din√¢mico (Bruto - L√≠quido)
            else if (atividade.valorBruto && atividade.valor) {
                // Se tiver extra, precisamos subtrair ele para achar a taxa real baseada no original
                const valorSemExtra = atividade.valor - (atividade.valorExtras || 0);
                taxa = (parseFloat(atividade.valorBruto) - valorSemExtra);
            }

            return total + Math.max(0, taxa); // Nunca retorna taxa negativa
        }, 0);
    },
    
    normalizeValoresAtividade(atividade) {
    if (!atividade) return;
    atividade.valor = Utils.parseMoeda(String(atividade.valor ?? 0));
    atividade.valorBruto = Utils.parseMoeda(String(atividade.valorBruto ?? 0));
    atividade.valorGorjeta = Utils.parseMoeda(String(atividade.valorGorjeta ?? 0));
    atividade.valorExtras = Utils.parseMoeda(String(atividade.valorExtras ?? 0));

    if (atividade.taxaAppOriginal !== undefined && atividade.taxaAppOriginal !== null) {
        atividade.taxaAppOriginal = Utils.parseMoeda(String(atividade.taxaAppOriginal));
    }
},

// 4. PREVEN√á√ÉO DE ERROS (Executar ao carregar ou calcular)
    normalizeExtras: (jornada) => {
        if (!jornada || !Array.isArray(jornada.atividades)) return;
        jornada.atividades.forEach(a => {
            BusinessLogic.normalizeValoresAtividade(a);
        });
    },
    
 // =================================================================
// C√âREBRO FINAL: LEDGER UNIVERSAL V36.5 (ID MATCHING PATCH)
// =================================================================
calcularSaldoConta: (contaId) => {
    if (!contaId) return 0;
    
    // 1. Localiza a configura√ß√£o
    const contaConfig = AppState.configuracoes.contasBancarias.find(c => c.id === contaId) || 
                        AppState.configuracoes.metasFinanceiras.find(m => m.id === contaId);
    
    // 2. Detec√ß√£o de Tipo
    const isCredito = (contaConfig && contaConfig.tipo === 'credito') || String(contaId).startsWith('FATURA_');

    // 3. NORMALIZA√á√ÉO DE ID DE BUSCA (A CORRE√á√ÉO EST√Å AQUI)
    // Removemos o prefixo 'FATURA_' para ter o UUID puro da conta
    const idBuscaPuro = String(contaId).replace('FATURA_', '');

    let saldoCents = 0;

    // 4. Saldo Inicial
    if (contaConfig && contaConfig.saldoInicial) {
        saldoCents += Utils.Money.toCents(contaConfig.saldoInicial);
    }

    // 5. Varredura Blindada com Normaliza√ß√£o
    if (Array.isArray(AppState.historicoTransacoes)) {
        AppState.historicoTransacoes.forEach(t => {
            if (!t || t.invalida) return;
            if (t.isAjusteInterno === true) return;

            // --- RESOLVER UNIVERSAL DE ID ---
            const rawOrigem = (typeof t.contaId === 'string') ? t.contaId : (t.contaId?.id || t.conta?.id);
            const rawDestino = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.contaDestino?.id || t.destino?.id);
            
            // NORMALIZA OS IDs DA TRANSA√á√ÉO TAMB√âM
            const tOrigemPuro = String(rawOrigem).replace('FATURA_', '');
            const tDestinoPuro = String(rawDestino).replace('FATURA_', '');
            
            const valorCents = Utils.Money.toCents(t.valor);
            if (valorCents === 0) return;

            // ==========================================================
            // L√ìGICA DE CART√ÉO DE CR√âDITO
            // ==========================================================
            if (isCredito) {
                // Comparamos os IDs Puros (sem FATURA_)
                
                // A. AUMENTA A FATURA (Compra)
                if (tOrigemPuro === idBuscaPuro && t.tipo === 'saida') {
                    saldoCents += valorCents;
                }
                // B. DIMINUI A FATURA (Pagamento/Estorno)
                else if (tOrigemPuro === idBuscaPuro && t.tipo === 'entrada') {
                    saldoCents -= valorCents;
                }
                else if (tDestinoPuro === idBuscaPuro && t.tipo === 'transferencia') {
                    saldoCents -= valorCents;
                }
            } 
            // ==========================================================
            // L√ìGICA DE CONTA CORRENTE
            // ==========================================================
            else {
                if (t.tipo === 'transferencia') {
                    if (tOrigemPuro === idBuscaPuro) saldoCents -= valorCents;
                    else if (tDestinoPuro === idBuscaPuro) saldoCents += valorCents;
                } else if (tOrigemPuro === idBuscaPuro) {
                    if (t.tipo === 'entrada') saldoCents += valorCents;
                    else if (t.tipo === 'saida') saldoCents -= valorCents;
                }
            }
        });
    }

    return Utils.Money.fromCents(saldoCents);
},   
    
    /*
    
    // =================================================================
// C√âREBRO FINAL: LEDGER UNIVERSAL V36.0 (TITANIUM - FIX CREDITO)
// =================================================================
calcularSaldoConta: (contaId) => {
    if (!contaId) return 0;
    
    // 1. Localiza a configura√ß√£o
    const contaConfig = AppState.configuracoes.contasBancarias.find(c => c.id === contaId) || 
                        AppState.configuracoes.metasFinanceiras.find(m => m.id === contaId);
    
    // 2. Detec√ß√£o de Tipo
    const isCredito = (contaConfig && contaConfig.tipo === 'credito') || String(contaId).startsWith('FATURA_');

    let saldoCents = 0;

    // 3. Saldo Inicial
    if (contaConfig && contaConfig.saldoInicial) {
        saldoCents += Utils.Money.toCents(contaConfig.saldoInicial);
    }

    // 4. Varredura Blindada
    if (Array.isArray(AppState.historicoTransacoes)) {
        AppState.historicoTransacoes.forEach(t => {
            if (!t || t.invalida) return;
            if (t.isAjusteInterno === true) return; // Trava de seguran√ßa

            // --- RESOLVER UNIVERSAL DE ID ---
            const tOrigem = (typeof t.contaId === 'string') ? t.contaId : (t.contaId?.id || t.conta?.id);
            const tDestino = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.contaDestino?.id || t.destino?.id);
            
            const valorCents = Utils.Money.toCents(t.valor);
            if (valorCents === 0) return;

            // ==========================================================
            // L√ìGICA DE CART√ÉO DE CR√âDITO (A CORRE√á√ÉO EST√Å AQUI)
            // ==========================================================
            if (isCredito) {
                // A. AUMENTA A FATURA (D√≠vida)
                // √â uma SA√çDA onde a origem √© o cart√£o
                if (tOrigem === contaId && t.tipo === 'saida') {
                    saldoCents += valorCents;
                }

                // B. DIMINUI A FATURA (Abatimento)
                // 1. Estorno/Devolu√ß√£o (Entrada direto no cart√£o)
                else if (tOrigem === contaId && t.tipo === 'entrada') {
                    saldoCents -= valorCents;
                }
                // 2. Pagamento de Fatura (Transfer√™ncia vindo de fora para o cart√£o)
                else if (tDestino === contaId && t.tipo === 'transferencia') {
                    saldoCents -= valorCents;
                }
            } 
            // ==========================================================
            // L√ìGICA DE CONTA CORRENTE / CARTEIRA (ATIVO)
            // ==========================================================
            else {
                if (t.tipo === 'transferencia') {
                    if (tOrigem === contaId) saldoCents -= valorCents;
                    else if (tDestino === contaId) saldoCents += valorCents;
                } else if (tOrigem === contaId) {
                    if (t.tipo === 'entrada') saldoCents += valorCents;
                    else if (t.tipo === 'saida') saldoCents -= valorCents;
                }
            }
        });
    }
if (String(contaConfig?.nome).includes('NuCredito') || isCredito) {
    console.log(`--- DEBUG CART√ÉO (${contaId}) ---`);
    console.log(`Total Calculado: ${saldoCents}`);
    // Mostra as transa√ß√µes que ele achou
    const achadas = AppState.historicoTransacoes.filter(t => (t.contaId === contaId || t.conta?.id === contaId));
    console.log('Transa√ß√µes encontradas para este ID:', achadas);
}
    return Utils.Money.fromCents(saldoCents);
},
 
*/
 
  /*  
    
// =================================================================
// C√âREBRO FINAL: LEDGER UNIVERSAL V35.5 (BLINDAGEM TOTAL)
// =================================================================
calcularSaldoConta: (contaId) => {
    if (!contaId) return 0;
    
    // 1. Localiza a configura√ß√£o da conta/meta
    const contaConfig = AppState.configuracoes.contasBancarias.find(c => c.id === contaId) || 
                       AppState.configuracoes.metasFinanceiras.find(m => m.id === contaId);
    
    // 2. Detec√ß√£o H√≠brida de Cart√£o (Tipo + Prefixo Virtual)
    const isCredito = (contaConfig && contaConfig.tipo === 'credito') || String(contaId).startsWith('FATURA_');

    let saldoCents = 0;

    // 3. Saldo Inicial (A base do castelo)
    if (contaConfig && contaConfig.saldoInicial) {
        saldoCents += Utils.Money.toCents(contaConfig.saldoInicial);
    }

    // 4. Varredura do Hist√≥rico com "Universal ID Resolver"
    if (Array.isArray(AppState.historicoTransacoes)) {
        AppState.historicoTransacoes.forEach(t => {
            if (!t || t.invalida) return;

             // üîí TRAVA ABSOLUTA ‚Äî AJUSTE INTERNO N√ÉO √â DINHEIRO
            if (t.isAjusteInterno === true) return;

            // --- RESOLVER UNIVERSAL DE ID (A ponte entre vers√µes) ---
            const tOrigem = (typeof t.contaId === 'string') ? t.contaId : (t.contaId?.id || t.conta?.id);
            const tDestino = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.contaDestino?.id || t.destino?.id);
            
            const valorCents = Utils.Money.toCents(t.valor);
            if (valorCents === 0) return;

            if (isCredito) {
                // --- REGRA DE PASSIVO (D√çVIDA / CART√ÉO) ---
                
                // 1. GASTO NA CONTA (Origem) = FATURAMENTO (+)
                // Aumenta a d√≠vida
                if (tOrigem === contaId) {
                    saldoCents += valorCents;
                }
                
                // 2. PAGAMENTO DE FATURA (Destino) = PAGAMENTO (-)
                // S√≥ abate a d√≠vida se for REALMENTE um pagamento de fatura
                else if (tDestino === contaId && t.tipo === 'transferencia') {
                    // Verifica se √© um pagamento leg√≠timo e n√£o apenas um ressarcimento interno
                    const isPagamentoReal = t.categoria === 'pagamento_fatura' || 
                                          (t.descricao && t.descricao.toLowerCase().includes('pagamento de fatura'));

                    if (isPagamentoReal) {
                        saldoCents -= valorCents;
                    }
                    // SE N√ÉO FOR PAGAMENTO REAL, IGNORA! (A d√≠vida continua l√°)
                } 
            } else {
                // --- REGRA DE ATIVO (DINHEIRO / CONTA CORRENTE) ---
                // (Mant√©m a l√≥gica padr√£o que j√° estava certa)
                if (t.tipo === 'transferencia') {
                    if (tOrigem === contaId) saldoCents -= valorCents;
                    else if (tDestino === contaId) saldoCents += valorCents;
                } else if (tOrigem === contaId) {
                    if (t.tipo === 'entrada') saldoCents += valorCents;
                    else if (t.tipo === 'saida') saldoCents -= valorCents;
                }
            }
        });
    }

    return Utils.Money.fromCents(saldoCents);
},


*/

    







        // ---------------------------------------------------------
        // 2. GEST√ÉO DE PAGAMENTOS E DATAS
        // ---------------------------------------------------------
// --- Verifica virada de m√™s das faturas de cart√£o (CORRIGIDO) ---
        verificarViradaFaturas: () => {
            const { metasFinanceiras } = AppState.configuracoes;
            const hoje = new Date();
            // Zera hora para evitar bugs de fuso
            hoje.setHours(0, 0, 0, 0);
            
            let mudouAlgo = false;

            metasFinanceiras.forEach(meta => {
                // S√≥ processa se for fatura de cart√£o (IDs come√ßam com FATURA_) e tiver vencimento
                if (meta.id.startsWith('FATURA_') && meta.dataVencimento) {
                    
                    // Cria data segura
                    let dataVenc = new Date(meta.dataVencimento + "T12:00:00");
                    dataVenc.setHours(0, 0, 0, 0);

                    // VERIFICA√á√ÉO DE SEGURAN√áA 1: Data Inv√°lida
                    if (isNaN(dataVenc.getTime())) {
                        console.warn(`[SISTEMA] Data de vencimento corrompida na fatura ${meta.descricao}. Resetando para hoje.`);
                        meta.dataVencimento = Utils.formatarDataParaChave(hoje);
                        mudouAlgo = true;
                        return;
                    }

                    // VERIFICA√á√ÉO DE SEGURAN√áA 2: Loop Infinito
                    let contadorSeguranca = 0;
                    const LIMITE_LOOPS = 60; // M√°ximo de 5 anos de atualiza√ß√£o (60 meses)

                    // Enquanto hoje for maior que o vencimento, empurra o vencimento pra frente
                    while (hoje > dataVenc && contadorSeguranca < LIMITE_LOOPS) {
                        // Avan√ßa 1 m√™s
                        dataVenc.setMonth(dataVenc.getMonth() + 1);
                        
                        // Atualiza a string da data
                        meta.dataVencimento = Utils.formatarDataParaChave(dataVenc);
                        
                        // Opcional: Se virou o m√™s, talvez voc√™ queira zerar o valor atual da fatura?
                        // Se n√£o quiser zerar autom√°tico, mantenha essa linha comentada:
                        // meta.valorAtual = 0; 

                        mudouAlgo = true;
                        contadorSeguranca++;
                    }

                    // Se atingiu o limite, for√ßa a data para evitar travamento eterno
                    if (contadorSeguranca >= LIMITE_LOOPS) {
                        console.error(`[CR√çTICO] Loop infinito detectado na fatura ${meta.descricao}. For√ßando atualiza√ß√£o.`);
                        meta.dataVencimento = Utils.formatarDataParaChave(hoje);
                        mudouAlgo = true;
                    }
                }
            });

            // Se houve altera√ß√£o de datas, salva e atualiza a tela
            if (mudouAlgo) {
                Storage.salvarConfiguracoes();
                if (UIRenderer.renderMetasFinanceiras) {
                    UIRenderer.renderMetasFinanceiras();
                }
            }
        },

// --- Sincroniza√ß√£o Inteligente (L√≥gica de Refer√™ncia/Contador) ---
        sincronizarPagamentoRecorrente: (transacao, idRecorrenteEspecifico = null) => {
            // Se n√£o for sa√≠da, ignora
            if (transacao.tipo !== 'saida') return;
            
            // Dados da transa√ß√£o
            const dataPgto = new Date(transacao.data);
            // Normaliza para meia-noite para c√°lculo de dias limpo
            dataPgto.setHours(0,0,0,0);
            
            let contaEncontrada = null;

            // 1. Tenta achar pelo ID (Bot√£o Pagar)
            if (idRecorrenteEspecifico) {
                contaEncontrada = AppState.configuracoes.contasRecorrentes.find(c => c.id === idRecorrenteEspecifico);
            }

            // 2. Backup: Tenta achar pelo valor e nome (Pagamento Manual)
            if (!contaEncontrada) {
                contaEncontrada = AppState.configuracoes.contasRecorrentes.find(c => {
                    const valorTransacao = parseFloat(transacao.valor);
                    const valorConta = parseFloat(c.valor);
                    // Margem de 10 centavos
                    if (Math.abs(valorTransacao - valorConta) > 0.10) return false;

                    const n1 = (c.descricao || '').toLowerCase();
                    const n2 = (transacao.descricao || '').toLowerCase();
                    return n2.includes(n1) || n1.includes(n2);
                });
            }

            // 3. O PULO DO GATO: C√°lculo do M√™s de Refer√™ncia (O Contador Oculto)
            if (contaEncontrada) {
                const diaVencimento = parseInt(contaEncontrada.vencimento);
                
                // Cria as datas de vencimento poss√≠veis ao redor do pagamento
                const anoPgto = dataPgto.getFullYear();
                const mesPgto = dataPgto.getMonth(); // 0-11

                // Vencimento no M√™s do Pagamento
                const vencimentoMesAtual = new Date(anoPgto, mesPgto, diaVencimento);
                
                // Vencimento no Pr√≥ximo M√™s
                const vencimentoProximoMes = new Date(anoPgto, mesPgto + 1, diaVencimento);

                // Vencimento no M√™s Anterior
                const vencimentoMesAnterior = new Date(anoPgto, mesPgto - 1, diaVencimento);

                // Calcula dist√¢ncias em dias (absoluto)
                const distAtual = Math.abs(dataPgto - vencimentoMesAtual);
                const distProximo = Math.abs(dataPgto - vencimentoProximoMes);
                const distAnterior = Math.abs(dataPgto - vencimentoMesAnterior);

                // Descobre qual √© o vencimento mais pr√≥ximo da data que voc√™ pagou
                let dataReferencia = vencimentoMesAtual;
                
                // Se pagou muito adiantado (est√° mais perto do pr√≥ximo m√™s)
                if (distProximo < distAtual && distProximo < distAnterior) {
                    dataReferencia = vencimentoProximoMes;
                }
                // Se pagou muito atrasado (est√° mais perto do m√™s anterior)
                else if (distAnterior < distAtual && distAnterior < distProximo) {
                    dataReferencia = vencimentoMesAnterior;
                }

                // Gera o "Carimbo" (ex: "2024-01")
                const carimboReferencia = `${dataReferencia.getFullYear()}-${String(dataReferencia.getMonth() + 1).padStart(2, '0')}`;

                // Salva na conta
                contaEncontrada.dataUltimoPagamento = Utils.formatarDataParaChave(dataPgto); // Hist√≥rico visual
                contaEncontrada.ultimoMesReferenciaPago = carimboReferencia; // O CONTADOR OCULTO L√ìGICO
                
                console.log(`[SMART SYNC] Conta: ${contaEncontrada.descricao} | Pago em: ${Utils.formatarDataParaChave(dataPgto)} | Refer√™ncia: ${carimboReferencia}`);
                
                // Persist√™ncia Imediata
                if (Storage && Storage.salvarConfiguracoes) {
                    Storage.salvarConfiguracoes();
                }

                // Atualiza tela
                if (UIRenderer.renderAlertasContasRecorrentes) {
                    UIRenderer.renderAlertasContasRecorrentes();
                }
            }
        },
       // --- C√°lculo de Dias (Blindado) ---
        calcularDiasTrabalhoEntreDatas: (dataInicio, dataFim) => {
            let configDias = AppState.configuracoes.diasTrabalhoSemana;
            if (!Array.isArray(configDias)) configDias = [1, 2, 3, 4, 5]; 

            let diasTrabalho = 0;
            let dataAtual = new Date(dataInicio);
            dataAtual.setHours(0, 0, 0, 0);
            
            let dataFinal = new Date(dataFim);
            dataFinal.setHours(23, 59, 59, 999);

            while (dataAtual <= dataFinal) {
                const diaDaSemana = dataAtual.getDay(); 
                if (configDias.includes(diaDaSemana)) {
                    diasTrabalho++;
                }
                dataAtual.setDate(dataAtual.getDate() + 1);
            }
            return diasTrabalho > 0 ? diasTrabalho : (dataInicio < dataFim ? 1 : 0);
        },

        calcularDiasTrabalhoNoMes: (ano, mes) => {
            const diasNoMes = new Date(ano, mes + 1, 0).getDate();
            let configDias = AppState.configuracoes.diasTrabalhoSemana;
            if (!Array.isArray(configDias)) configDias = [1, 2, 3, 4, 5];

            if (configDias.length === 7) return diasNoMes;
            
            let diasTrabalho = 0;
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const data = new Date(ano, mes, dia);
                const diaDaSemana = data.getDay();
                if (configDias.includes(diaDaSemana)) {
                    diasTrabalho++;
                }
            }
            return diasTrabalho > 0 ? diasTrabalho : 1;
        },

// 3. C√ÅLCULO FINANCEIRO (H√çBRIDO + WATERFALL)
        calcularCustoDiarioMeta: (meta, dataReferencia = new Date()) => {
            
            // --- CORRE√á√ÉO APLICADA: PROTE√á√ÉO CONTRA CUSTO ZERO/INFINITO ---
            // Se for poupan√ßa com prazo, mas a contribui√ß√£o estiver zerada, calcula dinamicamente
            if (meta.tipo === 'poupanca' && meta.prazoMeses > 0 && (!meta.contribuicaoMensal || meta.contribuicaoMensal <= 0)) {
                const saldoFaltante = Math.max(0, (meta.valorTotal || 0) - (meta.valorAtual || 0));
                meta.contribuicaoMensal = saldoFaltante / meta.prazoMeses;
            }
            // ----------------------------------------------------------------

            // 1. Cart√£o (Sempre fixo)
            if (meta.id.startsWith('FATURA_') && meta.custoMensalEstimado > 0) {
                const diasMes = BusinessLogic.calcularDiasTrabalhoNoMes(dataReferencia.getFullYear(), dataReferencia.getMonth());
                return meta.custoMensalEstimado / (diasMes || 1);
            }

            // 2. Acelerador
            if (meta.aceleradorMensal) {
                const chaveMes = `${dataReferencia.getFullYear()}-${dataReferencia.getMonth()}`;
                const custoAcelerado = meta.aceleradorMensal[chaveMes];
                if (custoAcelerado && custoAcelerado > 0) return custoAcelerado;
            }

            const isGlobalDinamico = AppState.configuracoes.rateioDinamicoCustos;
            const isItemDinamico = meta.modoProvisionamento === 'dinamico';
            const usarModoDinamico = isGlobalDinamico || isItemDinamico;


            // 3. POUPAN√áA E PR√ì-LABORE
            if (meta.tipo === 'poupanca' || meta.id === 'AUTO_ID_PROLABORE') {
                const valorBase = meta.contribuicaoMensal > 0 ? meta.contribuicaoMensal : (meta.valorTotal || 0);
                if (valorBase <= 0) return 0;

                if (usarModoDinamico) {
                    const hoje = new Date(dataReferencia);
                    hoje.setHours(0, 0, 0, 0);

                    // --- A) CUSTOS FIXOS MENSAIS (WATERFALL RESTAURADO) ---
                    if (meta.id === 'META_CUSTOS_MENSAIS') {
                        const custos = AppState.configuracoes.custosFixos || [];
                        if (custos.length === 0) return 0;
                        const mesRef = hoje.getMonth();
                        const anoRef = hoje.getFullYear();
                        
                        // Verifica o que j√° foi pago neste m√™s
                        const saidasDesteMes = (meta.saidas || []).filter(s => {
                            const d = new Date(s.data);
                            return d.getMonth() === mesRef && d.getFullYear() === anoRef;
                        });

                        const itensCalculados = custos.map(c => {
                            const descCusto = (c.descricao || '').toLowerCase().trim();
                            const foiPago = saidasDesteMes.some(s => {
                                const descSaida = (s.descricao || '').toLowerCase().trim();
                                return descSaida.includes(descCusto) || descCusto.includes(descSaida);
                            });
                            
                            // Se pago, n√£o cobra mais (Custo 0)
                            if (foiPago) return { ...c, diasRestantes: Infinity, resolvido: true, urgencia: Infinity };
                            
                            let dataVenc = new Date(anoRef, mesRef, c.vencimento);
                            dataVenc.setHours(23, 59, 59, 999);
                            const diasRestantes = BusinessLogic.calcularDiasTrabalhoEntreDatas(hoje, dataVenc);
                            
                            return { ...c, diasRestantes: diasRestantes > 0 ? diasRestantes : 1, resolvido: false, urgencia: dataVenc.getTime() };
                        });
                        
                        let saldoDisponivel = BusinessLogic.calcularSaldoConta(meta.id);
                        let custoDiarioAcumulado = 0;
                        
                        // Cobra os mais urgentes primeiro
                        const itensPendentes = itensCalculados.filter(i => !i.resolvido);
                        itensPendentes.sort((a, b) => a.urgencia - b.urgencia);
                        
                        itensPendentes.forEach(item => {
                            let faltaParaEsteItem = 0;
                            if (saldoDisponivel >= item.valor) {
                                saldoDisponivel -= item.valor; // Saldo cobre este item
                            } else {
                                faltaParaEsteItem = item.valor - saldoDisponivel; // Saldo acabou ou cobriu parcial
                                saldoDisponivel = 0;
                            }
                            if (faltaParaEsteItem > 0) custoDiarioAcumulado += (faltaParaEsteItem / item.diasRestantes);
                        });
                        return custoDiarioAcumulado;
                    }
                    
                    // --- B) OUTRAS METAS E PR√ì-LABORE (DATA LIMITE) ---
                    // Calcula quanto j√° tem na conta/pago
                    let jaPagoNoMes = 0;
                    if (meta.id === 'AUTO_ID_PROLABORE') {
                            const mesRef = hoje.getMonth();
                            jaPagoNoMes = (meta.saidas || [])
                            .filter(s => new Date(s.data).getMonth() === mesRef)
                            .reduce((acc, s) => acc + s.valor, 0);
                            jaPagoNoMes += BusinessLogic.calcularSaldoConta(meta.id);
                    } else {
                        jaPagoNoMes = BusinessLogic.calcularSaldoConta(meta.id);
                    }

                    const falta = Math.max(0, valorBase - jaPagoNoMes);
                    if (falta <= 0) return 0;

                    let dataLimite;
                    if (meta.dataVencimento) {
                        dataLimite = new Date(meta.dataVencimento + "T12:00:00");
                        if (hoje > dataLimite) dataLimite = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    } else if (meta.id === 'AUTO_ID_PROLABORE' && AppState.configuracoes.diaPagamentoProLabore > 0) {
                        dataLimite = new Date(hoje.getFullYear(), hoje.getMonth(), AppState.configuracoes.diaPagamentoProLabore);
                        if (hoje.getDate() > AppState.configuracoes.diaPagamentoProLabore) dataLimite.setMonth(dataLimite.getMonth() + 1);
                    } else {
                        dataLimite = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    }
                    
                    dataLimite.setHours(23, 59, 59, 999);
                    const diasRestantes = BusinessLogic.calcularDiasTrabalhoEntreDatas(hoje, dataLimite);
                    return falta / (diasRestantes > 0 ? diasRestantes : 1);

                } else {
                    // === MODO FIXO (DIAS DO M√äS) ===
                    const diasTrabalhoMes = BusinessLogic.calcularDiasTrabalhoNoMes(dataReferencia.getFullYear(), dataReferencia.getMonth());
                    return valorBase / (diasTrabalhoMes || 1);
                }
            } 
            
            // 4. PARCELAMENTO (Mantido igual)
            else if (meta.tipo === 'parcelamento') {
                let valorBase = 0;
                if (meta.financiamento && meta.financiamento.valorParcela > 0) {
                    valorBase = meta.financiamento.valorParcela;
                } else {
                    valorBase = (meta.valorTotal || 0) - (meta.valorAtual || 0);
                }

                if (usarModoDinamico) {
                    const hoje = new Date(dataReferencia);
                    hoje.setHours(0,0,0,0);
                    let dataVenc = meta.dataVencimento ? new Date(meta.dataVencimento + "T12:00:00") : new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    if (hoje > dataVenc) dataVenc.setMonth(dataVenc.getMonth() + 1);
                    dataVenc.setHours(23, 59, 59, 999);
                    const diasRestantes = BusinessLogic.calcularDiasTrabalhoEntreDatas(hoje, dataVenc);
                    return valorBase / (diasRestantes > 0 ? diasRestantes : 1);
                } else {
                    const diasTrabalhoMes = BusinessLogic.calcularDiasTrabalhoNoMes(dataReferencia.getFullYear(), dataReferencia.getMonth());
                    return valorBase / (diasTrabalhoMes || 1);
                }
            }
            
            // 5. Poupanca KM (Mantido)
            else if (meta.tipo === 'poupanca_km') {
                const kmMetaDiaria = AppState.configuracoes.kmMetaDiaria || 0;
                const valorPorKm = meta.valorPorKm || 0;
                if (kmMetaDiaria > 0 && valorPorKm > 0) return valorPorKm * kmMetaDiaria;
                return 0;
            }
            return 0;
        },
 
        
        // --- Soma das Metas Extras ---
// --- Soma das Metas Extras (Simplificado) ---
calcularMetasFinanceirasDiarias: (data) => {
            const { metasFinanceiras } = AppState.configuracoes;
            if (!metasFinanceiras || metasFinanceiras.length === 0) return 0;
            
            let custoDiarioTotalMetas = 0;

            // Filtra apenas as metas onde o checkbox est√° MARCADO ( !== false)
            // Ignora Custos Mensais e Pr√≥-Labore pois eles t√™m c√°lculo pr√≥prio em outro lugar
            const metasAtivas = metasFinanceiras.filter(meta => 
                meta.incluirComoCustoDiario !== false && 
                meta.id !== 'META_CUSTOS_MENSAIS' && 
                meta.id !== 'AUTO_ID_PROLABORE'      
            );

            metasAtivas.forEach(meta => {
                // Calcula o custo (Din√¢mico ou Fixo, a pr√≥pria fun√ß√£o decide)
                const custoCalculado = BusinessLogic.calcularCustoDiarioMeta(meta, data);
                custoDiarioTotalMetas += custoCalculado;
            });
            
            return custoDiarioTotalMetas;
        },
        
// 4. RESUMO FINAL (SEPARA√á√ÉO TOTAL: CUSTO vs SAL√ÅRIO)
        calcularCustosFixosDiarios: (data = new Date()) => {
            const { veiculo, proLabore, metaAutonoma, rateioDinamicoCustos, metasFinanceiras } = AppState.configuracoes;
            
            // 1. Deprecia√ß√£o
            let depreciacaoMensal = 0;
            if (veiculo.valor > 0) {
                const vidaUtil = veiculo.vidaUtil > 0 ? veiculo.vidaUtil : 5;
                const depreciacaoAnual = veiculo.valor / vidaUtil;
                depreciacaoMensal = depreciacaoAnual / 12;
            }
            const diasTrabalho = BusinessLogic.calcularDiasTrabalhoNoMes(data.getFullYear(), data.getMonth());
            const custoFixoDiarioBase = depreciacaoMensal / (diasTrabalho || 1);
            
            // 2. Custos Fixos Mensais (Caixinha)
            let custoFixosCaixinha = 0;
            const metaCustos = metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
            if (metaCustos && metaCustos.incluirComoCustoDiario !== false) {
                custoFixosCaixinha = BusinessLogic.calcularCustoDiarioMeta(metaCustos, data);
            }
            
            // 3. Metas Extras (D√≠vidas, Poupan√ßas)
            const custoMetasDiario = BusinessLogic.calcularMetasFinanceirasDiarias(data);
            
            // 4. Manuten√ß√£o (R$/KM Previs√£o)
            let custoPrevisaoManutencaoDiario = 0;
            if (AppState.configuracoes.incluirPrevisaoManutencao && AppState.configuracoes.kmMetaDiaria > 0) {
                if (typeof BusinessLogic.calcularCustoManutencaoRateadoDiario === 'function') {
                     custoPrevisaoManutencaoDiario = BusinessLogic.calcularCustoManutencaoRateadoDiario();
                }
            }
            
            // 5. Pr√≥-Labore (C√°lculo Isolado)
            let proLaboreDiarioCalculado = 0;
            const metaPL = metasFinanceiras.find(m => m.id === 'AUTO_ID_PROLABORE');

            if (metaPL) {
                if (proLabore > 0) metaPL.valorTotal = proLabore;
                // Calcula o valor (Din√¢mico ou Fixo) se houver valor definido
                if (metaPL.valorTotal > 0) {
                    proLaboreDiarioCalculado = BusinessLogic.calcularCustoDiarioMeta(metaPL, data);
                }
            } else {
                // Fallback
                proLaboreDiarioCalculado = (proLabore || 0) / (diasTrabalho || 1);
            }

            // --- A CORRE√á√ÉO DEFINITIVA ---
            // Card 1 (Operacional): NUNCA inclui o sal√°rio. √â s√≥ custo pra rodar.
            const custoProLaboreNoCard1 = 0; 
            
            // Card 2 (Target Sal√°rio): Recebe o valor integral do sal√°rio do dia.
            // O renderResumoDia vai somar (Card 1 + Esse Valor) para mostrar a meta total.
            const custoProLaboreNoCard2 = proLaboreDiarioCalculado;

            // Soma Operacional (Sem Sal√°rio)
            const custoOperacionalDiarioTotal = custoFixoDiarioBase + custoFixosCaixinha + custoMetasDiario + custoPrevisaoManutencaoDiario + custoProLaboreNoCard1;
            
            return {
                operacional: custoOperacionalDiarioTotal, // Vai pro Card 1
                proLaboreDiario: custoProLaboreNoCard2,   // Vai somar no Card 2
                metaAutonomaDiaria: metaAutonoma || 0
            };
        },
    // ---------------------------------------------------------
        // 4. ATUALIZA√á√ïES E SINCRONIZA√á√ïES (RESTAURADAS)
        // ---------------------------------------------------------
// --- ATUALIZA A META DE CUSTOS MENSAIS (COM CATEGORIA) ---
        atualizarMetaCustosMensais: () => {
            const { custosFixos, metasFinanceiras } = AppState.configuracoes;
            const totalCustos = custosFixos.reduce((acc, item) => acc + (item.valor || 0), 0);
            
            let meta = metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
            if (!meta) {
                meta = {
                    id: 'META_CUSTOS_MENSAIS', descricao: 'üìâ Custos Fixos Mensais',
                    tipo: 'poupanca', valorTotal: 0, valorAtual: 0, incluirComoCustoDiario: true,
                    isLocked: true, custosDetalhados: [], historicoProvisao: [], saidas: [],
                    itensAntecipados: [] 
                };
                metasFinanceiras.push(meta);
            }
            
            meta.valorTotal = totalCustos;
            
            const detalhesAntigos = meta.custosDetalhados || [];
            
            // RECRIA A LISTA MANTENDO O PROGRESSO E AGORA SALVANDO A CATEGORIA
            meta.custosDetalhados = custosFixos.map(custo => {
                const anterior = detalhesAntigos.find(d => d.idCustoFixo === custo.id);
                return {
                    idCustoFixo: custo.id,
                    descricao: custo.descricao,
                    valorObjetivo: custo.valor,
                    pesoAceleracao: anterior ? anterior.pesoAceleracao : (100 / Math.max(1, custosFixos.length)),
                    valorGuardado: anterior ? anterior.valorGuardado : 0,
                    vencimento: custo.vencimento,
                    
                    // >>> CORRE√á√ÉO AQUI: Salva a categoria original <<<
                    categoria: custo.categoria || 'Outro C. Fixo',
                    subcategoria: custo.subcategoria
                };
            });
            
            const saldoSoma = meta.custosDetalhados.reduce((acc, c) => acc + (c.valorGuardado || 0), 0);
            meta.valorAtual = saldoSoma;
        },
        // Fun√ß√£o ESSENCIAL para o m√≥dulo de cart√£o de cr√©dito
        recalcularProvisaoFatura: (faturaMeta) => {
            if (!faturaMeta.comprasParceladas) return;
            let somaParcelasMensais = 0;
            faturaMeta.comprasParceladas.forEach(compra => {
                somaParcelasMensais += compra.valorParcela;
            });
            faturaMeta.custoMensalEstimado = somaParcelasMensais;
        },

        // Fun√ß√£o ESSENCIAL para o m√≥dulo de manuten√ß√£o
        sincronizarMetaManutencao: (metaId) => {
            const { planoManutencao, metasFinanceiras, kmMetaDiaria } = AppState.configuracoes;
            const meta = metasFinanceiras.find(m => m.id === metaId);
            if (!meta) return;
            const itensVinculados = planoManutencao.filter(item => item.metaId === metaId);
            if (itensVinculados.length === 0) return;

            let custoTotalEstimado = 0;
            let taxaBasePorKm = 0;
            let menorKmFaltante = Infinity; 

            const saldoDisponivel = BusinessLogic.calcularSaldoConta(metaId);
            const jornadaHoje = BusinessLogic.getJornadaDoDia(new Date());
            const kmAtual = parseFloat(jornadaHoje.kmFinal || jornadaHoje.kmInicial) || 0;
            const historico = AppState.historicoManutencao;

            const statusItens = itensVinculados.map(item => {
                custoTotalEstimado += (item.custoEstimado || 0);
                const taxaItem = (item.intervaloKm > 0 && item.custoEstimado > 0) ? (item.custoEstimado / item.intervaloKm) : 0;
                taxaBasePorKm += taxaItem;
                let kmFaltante = item.intervaloKm; 
                if (item.intervaloKm > 0 && kmAtual > 0) {
                    const ultimos = historico.filter(h => h.planoId === item.id).sort((a, b) => b.km - a.km);
                    const ultimoKmFeito = ultimos.length > 0 ? ultimos[0].km : 0;
                    kmFaltante = (ultimoKmFeito + item.intervaloKm) - kmAtual;
                    if (kmFaltante < menorKmFaltante) menorKmFaltante = kmFaltante;
                }
                return { ...item, custo: item.custoEstimado || 0, taxa: taxaItem, kmFaltante: Math.max(0, kmFaltante) };
            });

            statusItens.sort((a, b) => a.kmFaltante - b.kmFaltante);
            let saldoVirtual = saldoDisponivel;
            let taxaInteligente = 0;

            statusItens.forEach(item => {
                if (saldoVirtual >= item.custo) {
                    saldoVirtual -= item.custo;
                } else {
                    saldoVirtual = 0; 
                    taxaInteligente += item.taxa;
                }
            });

            meta.valorTotal = custoTotalEstimado;
            meta.valorPorKm = taxaInteligente;
            if (meta.tipo === 'poupanca' && taxaInteligente > 0) {
                meta.tipo = 'poupanca_km';
            }
            if (kmMetaDiaria > 0 && menorKmFaltante !== Infinity) {
                const diasParaVencer = menorKmFaltante / kmMetaDiaria;
                const dataPrevista = new Date();
                dataPrevista.setDate(dataPrevista.getDate() + Math.floor(diasParaVencer));
                meta.dataVencimento = Utils.formatarDataParaChave(dataPrevista);
            }
            if (!meta.descricao.includes('(Auto)')) {
                meta.descricao += ' (Auto)';
            }
            Storage.salvarConfiguracoes();
        },

        atualizarCustoKmManutencao: () => {
            const { planoManutencao, metasFinanceiras } = AppState.configuracoes;
            const acumuladores = {}; 
            planoManutencao.forEach(item => {
                if (item.metaId && item.intervaloKm > 0 && item.custoEstimado > 0) {
                    const custoKmItem = item.custoEstimado / item.intervaloKm;
                    if (!acumuladores[item.metaId]) acumuladores[item.metaId] = 0;
                    acumuladores[item.metaId] += custoKmItem;
                }
            });
            metasFinanceiras.forEach(meta => {
                if (acumuladores[meta.id] !== undefined && meta.tipo === 'poupanca_km') {
                    meta.valorPorKm = acumuladores[meta.id];
                    if (!meta.descricao.includes('(Auto)')) {
                        meta.descricao += ' (Auto)';
                    }
                }
            });
        },

        calcularCustoManutencaoRateadoDiario: () => {
            const { planoManutencao, diasTrabalhoSemana, kmMetaDiaria } = AppState.configuracoes;
            let custoTotalDiario = 0;
            if (kmMetaDiaria <= 0 || planoManutencao.length === 0) return 0;
            
            const diasNum = Array.isArray(diasTrabalhoSemana) ? diasTrabalhoSemana.length : 5;
            const diasTrabalhoRatio = diasNum / 7;

            planoManutencao.forEach(itemPlano => {
                const ultimoHistorico = AppState.historicoManutencao.filter(h => h.planoId === itemPlano.id).sort((a, b) => new Date(b.data) - new Date(a.data))[0];
                const custoManutencao = ultimoHistorico ? ultimoHistorico.valor : 0;
                if (custoManutencao > 0 && itemPlano.intervaloKm > 0) {
                    const custoPorKm = custoManutencao / itemPlano.intervaloKm;
                    const custoDiarioBasico = custoPorKm * kmMetaDiaria;
                    let custoDiarioPonderado = custoDiarioBasico;
                    if (diasNum < 7 && diasNum > 0) {
                        custoDiarioPonderado = custoDiarioBasico / diasTrabalhoRatio;
                    }
                    custoTotalDiario += custoDiarioPonderado;
                }
            });
            return custoTotalDiario;
        },

// --- C√ÅLCULO H√çBRIDO: PV REAL (CORRE√á√ÉO DO "EFEITO CATRACA") ---
        atualizarProgressoFinanciamentos: () => {
            const { metasFinanceiras } = AppState.configuracoes;
            const historico = AppState.historicoTransacoes;
            const hoje = new Date();
            hoje.setHours(12, 0, 0, 0); 

            metasFinanceiras.forEach(meta => {
                if (meta.tipo !== 'parcelamento' || !meta.financiamento) return;
                
                const fin = meta.financiamento;
                if (!fin.valorFinanciado) return;

                // 1. VARREDURA DO HIST√ìRICO (A Verdade Real)
                const pagamentos = historico.filter(t => 
                    t.contaId === meta.id && t.tipo === 'entrada'
                );

                let qtdPagasHist = 0;
                let valorPagoHist = 0;
                
                pagamentos.forEach(t => {
                    valorPagoHist += t.valor;
                    let qtd = 0;
                    if (t.detalhes && t.detalhes.qtdParcelas) qtd = t.detalhes.qtdParcelas;
                    else {
                        // Fallback para registros antigos
                        const match = t.descricao.match(/\((\d+)\s*[xpcls]/);
                        if (match) qtd = parseInt(match[1]);
                        else if (fin.valorParcela > 0 && Math.abs(t.valor - fin.valorParcela) < 5) qtd = 1;
                    }
                    qtdPagasHist += qtd;
                });

                // >>> CORRE√á√ÉO AQUI <<<
                // Se houver transa√ß√µes, o hist√≥rico sobrescreve o valor salvo.
                // Isso permite que o valor DIMINUA se voc√™ fizer um estorno.
                if (pagamentos.length > 0) {
                    fin.parcelasPagas = qtdPagasHist;
                    fin.totalAmortizado = valorPagoHist;
                } else {
                    // Se n√£o houver hist√≥rico (migra√ß√£o ou manual), mant√©m o que estava salvo
                    fin.parcelasPagas = fin.parcelasPagas || 0;
                    fin.totalAmortizado = fin.totalAmortizado || 0;
                }
                // ---------------------

                // 2. PREPARA TABELA FINANCEIRA
                const P = fin.valorFinanciado;
                const i_mensal = Math.pow(1 + (fin.taxaJurosAnual / 100), 1 / 12) - 1;
                const i_m_percent = i_mensal * 100;
                const r_daily = Math.pow(1 + (fin.taxaJurosAnual / 100), 1 / 365) - 1;
                const dataInicio = new Date(fin.dataInicioFinanciamento + "T12:00:00");
                
                const info = (fin.metodoAmortizacao === 'price') 
                    ? Utils.genPriceSchedule(P, i_m_percent, fin.totalParcelas, dataInicio, fin.valorParcela)
                    : Utils.genSAC(P, i_m_percent, fin.totalParcelas, dataInicio);
                
                // 3. FILTRA E CALCULA
                const parcelasRestantesArr = info.schedule.filter(p => p.num > fin.parcelasPagas);
                let saldoQuitacao = 0;
                let proximoVencimento = null;

                if (parcelasRestantesArr.length > 0) {
                    proximoVencimento = parcelasRestantesArr[0].due;
                    saldoQuitacao = parcelasRestantesArr.reduce((acc, p) => {
                        const days = Utils.daysBetween(hoje, p.due);
                        const fatorDesconto = days > 0 ? Math.pow(1 + r_daily, days) : 1;
                        return acc + (p.pmt / fatorDesconto);
                    }, 0);
                }

                const saldoFluxoCaixa = parcelasRestantesArr.reduce((acc, p) => acc + p.pmt, 0);
                const totalContratoFluxo = info.schedule.reduce((acc, p) => acc + p.pmt, 0);

                // 4. SALVA NA META
                meta.valorTotal = totalContratoFluxo;
                meta.valorAtual = totalContratoFluxo - saldoFluxoCaixa;
                
                meta.dadosExtras = {
                    saldoFluxo: saldoFluxoCaixa,
                    saldoQuitacao: saldoQuitacao,
                    parcelasRestantes: parcelasRestantesArr.length
                };

                meta.dataVencimento = proximoVencimento ? Utils.formatarDataParaChave(proximoVencimento) : null;
            });
        },

      // ---------------------------------------------------------
        // 5. CAIXINHAS E D√âBITOS (RESTAURADO)
        // ---------------------------------------------------------
        inicializarCaixinhasAutomaticas: () => {
            const { metasFinanceiras, proLabore } = AppState.configuracoes;
            // const findOrCreate = (id, defaults) => {
                // let meta = metasFinanceiras.find(m => m.id === id);
                // if (!meta) {
                    // meta = { id: id, valorTotal: 0, ...defaults };
                    // metasFinanceiras.push(meta);
                // } else {
                    // if (defaults.incluirComoCustoDiario !== undefined) {
                        // meta.incluirComoCustoDiario = defaults.incluirComoCustoDiario;
                    // }
                // }
                // return meta;
            // };
                            const findOrCreate = (id, defaults = {}) => {
                            let meta = metasFinanceiras.find(m => m.id === id);
                            if (!meta) {
                            meta = Object.assign({ id: id, valorTotal: 0 }, defaults);
                            metasFinanceiras.push(meta);
                            } else {
                            if (defaults.incluirComoCustoDiario !== undefined) {
                            meta.incluirComoCustoDiario = defaults.incluirComoCustoDiario;
                            }
                            }
                            return meta;
                            };
            findOrCreate('AUTO_ID_CARTEIRA', { descricao: 'üíµ Carteira (Caixa Di√°rio)', tipo: 'caixa', isLocked: true, incluirComoCustoDiario: false });
            const metaProLabore = findOrCreate('AUTO_ID_PROLABORE', { descricao: 'üí∞ Pro-Labore (Sal√°rio)', tipo: 'poupanca', isLocked: true, incluirComoCustoDiario: false });
            metaProLabore.valorTotal = proLabore || 0; 
            findOrCreate('AUTO_ID_RESERVA_LUCRO', { descricao: 'üìà Reserva de Lucro (Extra)', tipo: 'poupanca', isLocked: true, incluirComoCustoDiario: false });
            findOrCreate('META_CUSTOS_MENSAIS', { descricao: 'üìâ Custos Fixos Mensais', tipo: 'poupanca', isLocked: true, incluirComoCustoDiario: true });
            if (typeof BusinessLogic !== 'undefined' && BusinessLogic.atualizarMetaCustosMensais) {
                BusinessLogic.atualizarMetaCustosMensais();
            }
        },

        debitarDaCarteira: (valorDebito, descricaoCusto, categoria, jornadaId = null, isCustoOperacional = true) => {
            if (valorDebito <= 0) return { sucesso: true };
            
            const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
            let saldoContasPessoais = 0;
            
            if (isCustoOperacional === false) {
                AppState.configuracoes.contasBancarias.filter(c => c.tipo !== 'credito').forEach(c => {
                    saldoContasPessoais += BusinessLogic.calcularSaldoConta(c.id);
                });
            }
            
            const saldoReserva = BusinessLogic.calcularSaldoConta('AUTO_ID_RESERVA_LUCRO');
            const saldoProLabore = BusinessLogic.calcularSaldoConta('AUTO_ID_PROLABORE');
            
            let saldoTotalDisponivel = 0;
            if (isCustoOperacional) {
                saldoTotalDisponivel = saldoCarteira + saldoReserva + saldoProLabore;
            } else {
                saldoTotalDisponivel = saldoCarteira + saldoContasPessoais;
            }

            if (saldoTotalDisponivel < valorDebito) {
                return { sucesso: false, saldoTotal: saldoTotalDisponivel };
            }
            
            let valorRestante = valorDebito;
            const transacoesDebito = [];
            const dataAgora = Date.now();
            
            // 1. Carteira
            const debitoCarteira = Math.min(saldoCarteira, valorRestante);
            if (debitoCarteira > 0) {
                transacoesDebito.push({
                    id: crypto.randomUUID(), data: dataAgora,
                    contaId: 'AUTO_ID_CARTEIRA', tipo: 'saida', valor: debitoCarteira,
                    descricao: descricaoCusto, categoria: categoria, isCustoOperacional: isCustoOperacional,
                    jornadaId: jornadaId
                });
                valorRestante -= debitoCarteira;
            }

            // 2. Reservas (Se operacional)
            if (isCustoOperacional && valorRestante > 0) {
                const debitoReserva = Math.min(saldoReserva, valorRestante);
                if (debitoReserva > 0) {
                    transacoesDebito.push({
                        id: crypto.randomUUID(), data: dataAgora,
                        contaId: 'AUTO_ID_RESERVA_LUCRO', tipo: 'saida', valor: debitoReserva,
                        descricao: `Cobertura Custo: ${descricaoCusto}`, categoria: categoria, isCustoOperacional: true,
                        jornadaId: jornadaId
                    });
                    valorRestante -= debitoReserva;
                }
                if (valorRestante > 0) {
                    const debitoProLabore = Math.min(saldoProLabore, valorRestante);
                    if (debitoProLabore > 0) {
                        transacoesDebito.push({
                            id: crypto.randomUUID(), data: dataAgora,
                            contaId: 'AUTO_ID_PROLABORE', tipo: 'saida', valor: debitoProLabore,
                            descricao: `Cobertura Custo: ${descricaoCusto}`, categoria: categoria, isCustoOperacional: true,
                            jornadaId: jornadaId
                        });
                        valorRestante -= debitoProLabore;
                    }
                }
            }
            // 3. Contas Pessoais (Aviso)
            else if (!isCustoOperacional && valorRestante > 0) {
                console.warn("L√≥gica de d√©bito de contas pessoais n√£o implementada em debitarDaCarteira");
            }
            
            AppState.historicoTransacoes.push(...transacoesDebito);
            Storage.salvarConfiguracoes();
            return { sucesso: true };
        },

        // ---------------------------------------------------------
        // 6. GPS, CONSUMO E M√âDIAS (RESTAURADO)
        // ---------------------------------------------------------
// --- BUSCA INTELIGENTE DO √öLTIMO ABASTECIMENTO (ROBUSTA) ---
        findLastRefuelData: (targetDate) => {
            const targetChave = Utils.formatarDataParaChave(targetDate);
            const sortedKeys = Object.keys(AppState.jornadas).sort().reverse();
            
            for (const key of sortedKeys) {
                // Ignora datas futuras ou o pr√≥prio dia
                if (key >= targetChave) continue; 
                
                const jornada = AppState.jornadas[key];
                const abastecimento = jornada.custos?.abastecimento;
                
                // Verifica se houve abastecimento naquele dia
                if (abastecimento && (abastecimento.litros > 0 || abastecimento.km > 0)) {
                    let kmValido = abastecimento.km;
                    
                    // Se n√£o salvou o KM no abastecimento, tenta o KM Final do dia
                    if (!kmValido || kmValido <= 0) {
                        kmValido = jornada.kmFinal;
                    }

                    // Se encontrou um KM v√°lido, retorna esse ponto como refer√™ncia
                    if (kmValido > 0) {
                        return { 
                            ...abastecimento, 
                            km: kmValido, 
                            litrosRestantes: abastecimento.litrosRestantes || 0 
                        };
                    }
                }
            }
            return null;
        },
// --- C√ÅLCULO DE M√âDIA BLINDADO ---
        calcularMediaConsumo: (jornadaAtual, dataAtual) => {
            const { veiculo } = AppState.configuracoes;
            const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
            const isEV = tipoCombustivel.toLowerCase().includes('el√©trico');
            const unidade = isEV ? 'km/kWh' : 'km/L';

            const abast = jornadaAtual.custos.abastecimento || {};
            
            // 1. Dados Atuais
            const kmAtual = Number(abast.km) || Number(jornadaAtual.kmFinal) || 0;
            const litrosAbastecidos = Number(abast.litros) || 0;
            const litrosRestantes = Number(abast.litrosRestantes) || 0;
            const litrosPainel = Number(abast.litrosConsumidosPainel) || 0;

            // 2. Tenta calcular pelo PAINEL (Se o usu√°rio digitou)
            if (litrosPainel > 0 && kmAtual > 0) {
                const abastAnterior = BusinessLogic.findLastRefuelData(dataAtual);
                const kmAnterior = abastAnterior ? (abastAnterior.km || 0) : 0;
                const kmRodados = Math.max(0, kmAtual - kmAnterior);

                if (kmRodados > 0) {
                    return { media: kmRodados / litrosPainel, kmRodados, litrosConsumidos: litrosPainel, tipo: 'Painel' };
                }
            }

            // 3. C√°lculo pelo TANQUE (N√≠vel)
            if (kmAtual <= 0 || litrosAbastecidos <= 0) {
                // Sem dados suficientes
                return { media: 0, kmRodados: 0, litrosConsumidos: 0, tipo: unidade };
            }

            const abastecimentoAnterior = BusinessLogic.findLastRefuelData(dataAtual);

            // Se √© o primeiro abastecimento da vida do app
            if (!abastecimentoAnterior) {
                return { media: 0, kmRodados: 0, litrosConsumidos: 0, tipo: unidade };
            }

            const kmAnterior = Number(abastecimentoAnterior.km) || 0;
            const litrosRestantesAnterior = Number(abastecimentoAnterior.litrosRestantes) || 0;

            if (kmAtual <= kmAnterior) {
                // Erro de od√¥metro (KM atual menor que anterior)
                return { media: 0, kmRodados: 0, litrosConsumidos: 0, tipo: unidade };
            }

            const kmRodados = kmAtual - kmAnterior;

            // F√ìRMULA: (O que tinha + O que coloquei) - O que sobrou
            let litrosConsumidos = (litrosRestantesAnterior + litrosAbastecidos) - litrosRestantes;
            
            // --- FALLBACK DE SEGURAN√áA ---
            // Se a conta der negativo ou zero (ex: esqueceu de por o restante anterior),
            // assumimos que consumiu exatamente o que abasteceu (l√≥gica de completar tanque).
            if (litrosConsumidos <= 0.1) {
                litrosConsumidos = litrosAbastecidos;
            }

            const mediaCalculada = kmRodados / litrosConsumidos;
            
            return {
                media: mediaCalculada,
                kmRodados,
                litrosConsumidos,
                tipo: unidade
            };
        },
        findLastRefuelKm: (beforeDate) => {
            const beforeDateStr = Utils.formatarDataParaChave(beforeDate);
            const sortedKeys = Object.keys(AppState.jornadas).sort().reverse();
            for (const key of sortedKeys) {
                if (key >= beforeDateStr) continue;
                const jornada = AppState.jornadas[key];
                if (jornada.custos && jornada.custos.abastecimento && jornada.custos.abastecimento.km > 0) {
                    return jornada.custos.abastecimento.km;
                }
            }
            return 0;
        },
        
        // =============================================================
        // BUSINESS LOGIC: CALCULAR M√âDIA GLOBAL (PADR√ÉO OURO V35.7)
        // =============================================================
        calcularConsumoMedio: () => {
            // 1. Busca todos os abastecimentos v√°lidos no hist√≥rico
            const abastecimentos = AppState.historicoTransacoes.filter(t => 
                t.categoria === 'Abastecimento' && 
                !t.invalida && 
                t.detalhes && t.detalhes.km > 0 && t.detalhes.litros > 0
            );

            // Ordena do mais antigo para o mais novo
            abastecimentos.sort((a, b) => new Date(a.data) - new Date(b.data));

            if (abastecimentos.length < 2) return 0;

            // 2. C√°lculo entre o primeiro e o √∫ltimo registro do hist√≥rico
            const primeiro = abastecimentos[0];
            const ultimo = abastecimentos[abastecimentos.length - 1];

            const kmTotalRodado = ultimo.detalhes.km - primeiro.detalhes.km;
            
            // Soma todos os litros abastecidos (exceto os do primeiro registro, 
            // pois eles foram usados para rodar at√© o segundo registro)
            const totalLitros = abastecimentos.slice(1).reduce((acc, t) => acc + (t.detalhes.litros || 0), 0);

            if (kmTotalRodado <= 0 || totalLitros <= 0) return 0;

            return (kmTotalRodado / totalLitros).toFixed(2);
        },
        // --- L√ìGICA RESTAURADA (DO ARQUIVO VELHO) ---
   

    getHistoricoMediasConsumo: (limite = 30) => {
            const medias = [];
            const sortedKeys = Object.keys(AppState.jornadas).sort().reverse();
            for (const key of sortedKeys) {
                if (medias.length >= limite) break;
                const jornada = AppState.jornadas[key];
                if (jornada.custos && jornada.custos.abastecimento && jornada.custos.abastecimento.mediaCalculada > 0) {
                    medias.push({ media: jornada.custos.abastecimento.mediaCalculada, data: key });
                }
            }
            return medias.reverse();
        },

// --- CORRE√á√ÉO: Filtra apenas as marcadas para incluir ---
        calcularCustoProvisionamentoKm: (kmTotal) => {
            if (kmTotal <= 0) return 0;
            const { metasFinanceiras } = AppState.configuracoes;
            let custoProvisionamentoTotal = 0;
            
            metasFinanceiras
                .filter(meta => 
                    meta.tipo === 'poupanca_km' && 
                    meta.valorPorKm > 0 && 
                    meta.incluirComoCustoDiario !== false // <--- O FILTRO IMPORTANTE
                )
                .forEach(meta => {
                    custoProvisionamentoTotal += (meta.valorPorKm * kmTotal);
                });
            
            return custoProvisionamentoTotal;
        },

        // ---------------------------------------------------------
        // 7. JORNADA, SA√öDE E RELAT√ìRIOS (RESTAURADO)
        // ---------------------------------------------------------
        
        getJornadaAtiva: () => {
            if (AppState.activeJornadaChave && AppState.jornadas[AppState.activeJornadaChave]) {
                const jornada = AppState.jornadas[AppState.activeJornadaChave];
                if (jornada.status === 'ativa' || jornada.status === 'em_pausa') return jornada;
            }
            AppState.activeJornadaChave = null;
            Storage.salvarJornadaAtiva();
            return null;
        },
        
        getJornadaDoDia: (data) => {
            const chave = Utils.formatarDataParaChave(data);
            if (!AppState.jornadas[chave]) {
                AppState.jornadas[chave] = {
                    status: 'inativa', inicioJornada: null, fimJornada: null, 
                    pausas: [], atividades: [], servicosEmAndamento: [], 
                    metaHoras: null, kmInicial: null, kmFinal: null,
                    metaAlcancadaNotificada: false, tempoInativoAcumulado: 0, kmProvisionado: 0,
                    custos: { abastecimento: { litros: 0, valor: 0, km: 0, litrosRestantes: 0, mediaCalculada: 0 }, outros: [] },
                    kmGps: 0, custosFixosProvisionadosDia: null
                };
            }
            // Higieniza√ß√£o
            if (!AppState.jornadas[chave].custos) AppState.jornadas[chave].custos = { abastecimento: { litros: 0, valor: 0, km: null }, outros: [] };
            if (!AppState.jornadas[chave].custos.abastecimento) AppState.jornadas[chave].custos.abastecimento = { litros: 0, valor: 0, km: null };
            if (AppState.jornadas[chave].custos.abastecimento.litros === undefined) AppState.jornadas[chave].custos.abastecimento = { litros: 0, valor: 0, km: null };
            if (!AppState.jornadas[chave].custos.outros) AppState.jornadas[chave].custos.outros = [];
            if (!AppState.jornadas[chave].tempoInativoAcumulado) AppState.jornadas[chave].tempoInativoAcumulado = 0;
            if (AppState.jornadas[chave].kmProvisionado === undefined) AppState.jornadas[chave].kmProvisionado = 0;
            return AppState.jornadas[chave];
        },

        getUltimoKmRegistrado: () => {
            const jornada = BusinessLogic.getJornadaDoDia(new Date());
            let ultimoKm = Number(jornada.kmFinal) || 0;
            if (jornada.custos && jornada.custos.abastecimento && jornada.custos.abastecimento.km > ultimoKm) {
                ultimoKm = jornada.custos.abastecimento.km;
            }
            if (jornada.atividades.length > 0) {
                const atividadesOrdenadas = jornada.atividades.slice().sort((a, b) => new Date(b.fim) - new Date(a.fim));
                const kmUltimaAtividade = Number(atividadesOrdenadas[0].kmFinalServico) || 0;
                if (kmUltimaAtividade > ultimoKm) ultimoKm = kmUltimaAtividade;
            }
            return ultimoKm > 0 ? ultimoKm : (Number(jornada.kmInicial) || null);
        },
        
        getKmFinalDiaAnterior: () => {
            let dataAnterior = new Date();
            dataAnterior.setDate(dataAnterior.getDate() - 1);
            for (let i = 0; i < 30; i++) {
                const chaveAnterior = Utils.formatarDataParaChave(dataAnterior);
                if (AppState.jornadas[chaveAnterior]) {
                    const jornadaAnterior = AppState.jornadas[chaveAnterior];
                    let kmFinalDoDia = 0;
                    if (jornadaAnterior.kmFinal && jornadaAnterior.kmFinal > 0) kmFinalDoDia = jornadaAnterior.kmFinal;
                    if (jornadaAnterior.custos?.abastecimento?.km > kmFinalDoDia) kmFinalDoDia = jornadaAnterior.custos.abastecimento.km;
                    if (jornadaAnterior.atividades.length > 0) {
                         const ultimaAtividadeKm = jornadaAnterior.atividades.reduce((maxKm, at) => Math.max(maxKm, at.kmFinalServico || 0), 0);
                         if (ultimaAtividadeKm > kmFinalDoDia) kmFinalDoDia = ultimaAtividadeKm;
                    }
                    if (kmFinalDoDia > 0) return kmFinalDoDia;
                    if (jornadaAnterior.kmInicial > 0) return jornadaAnterior.kmInicial;
                }
                dataAnterior.setDate(dataAnterior.getDate() - 1);
            }
            return null;
        },
// Cole isso dentro de BusinessLogic, substituindo a antiga
    calcularMediaHistoricaGeral: () => {
        if (!AppState || !AppState.jornadas) return 0;
        const lista = Object.values(AppState.jornadas);
        if (lista.length === 0) return 0;

        let totalGanhos = 0;
        let diasContados = 0;

        lista.forEach(j => {
            if (!j) return;
            let valorDia = 0;

            // Compatibilidade V8 (Novo Formato)
            if (j.financeiroFinal) {
                valorDia = (Number(j.financeiroFinal.totalRessarcido) || 0) + 
                           (Number(j.financeiroFinal.totalDistribuido) || 0) + 
                           (Number(j.financeiroFinal.saldoFinal) || 0);
            }
            // Compatibilidade V7
            else if (j.ganhos && typeof j.ganhos.bruto === 'number') {
                valorDia = j.ganhos.bruto;
            }
            // Compatibilidade Antiga (AQUI ESTAVA O ERRO)
            else if (j.atividades && Array.isArray(j.atividades)) {
                valorDia = j.atividades.reduce((acc, item) => acc + (Number(item.valor) || 0), 0);
            }

            if (valorDia > 0) {
                totalGanhos += valorDia;
                diasContados++;
            }
        });

        return diasContados > 0 ? (totalGanhos / diasContados) : 0;
    },




        predizerConclusaoMeta: (metaId) => {
            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
            if (!meta || (meta.valorTotal || 0) <= 0) return null;
            const saldoAtual = BusinessLogic.calcularSaldoConta(metaId);
            const falta = meta.valorTotal - saldoAtual;
            if (falta <= 0) return { status: "Conclu√≠da", meses: 0 };
            
            const ultimosPagamentos = AppState.historicoTransacoes.filter(t => {
                const isEntradaDireta = t.contaId === metaId && t.tipo === 'entrada';
                const isTransferenciaRecebida = t.tipo === 'transferencia' && t.destino && t.destino.id === metaId;
                return isEntradaDireta || isTransferenciaRecebida;
            }).sort((a, b) => b.data - a.data).slice(0, 5);

            if (ultimosPagamentos.length === 0) return { status: "Sem dados", meses: 0 };
            const somaPagamentos = ultimosPagamentos.reduce((acc, t) => acc + t.valor, 0);
            const mediaPagamento = somaPagamentos / ultimosPagamentos.length;
            if (mediaPagamento <= 0) return { status: "Estagnada", meses: 0 };
            
            const mesesRestantes = falta / mediaPagamento;
            const dataPrevista = new Date();
            dataPrevista.setMonth(dataPrevista.getMonth() + Math.ceil(mesesRestantes));
            
            return { status: "Em andamento", meses: Math.ceil(mesesRestantes), data: dataPrevista, media: mediaPagamento };
        },
       

/*        
// ============================================================================
    // C√ÅLCULO RESUMO DIA (V131 - FUSION: MATH V81 + L√ìGICA V130)
    // ============================================================================
    calcularResumoDia: (jornada, data = new Date()) => {
        if (!jornada) return {}; // Retorna vazio se n√£o houver jornada

        // --- HELPER 1: Sanitiza√ß√£o Num√©rica (Mantido V81) ---
        const toNum = (val) => {
            const n = Number(val);
            return Number.isFinite(n) ? n : 0;
        };

        // --- HELPER 2: Divis√£o Segura (Mantido V81) ---
        const safeDiv = (numerador, denominador) => {
            const num = toNum(numerador);
            const den = toNum(denominador);
            return den !== 0 ? num / den : 0;
        };

        // [GUARD] Normaliza√ß√£o
        if (typeof BusinessLogic.normalizeExtras === 'function') {
            BusinessLogic.normalizeExtras(jornada);
        }

        // PREPARA√á√ÉO PARA O SUPER FILTRO V130
        const dataJornadaStr = new Date(jornada.data).toLocaleDateString('pt-BR');
        const modoReal = AppState.modoDRE === 'real';

        // Fun√ß√£o de Filtro Universal (Resolve o Bug da Meia-Noite)
        const pertenceAJornada = (t) => {
            if (t.invalida) return false;
            
            // 1. Data Econ√¥mica (Prioridade)
            const dataRef = t.dataEconomica ? new Date(t.dataEconomica) : new Date(t.data);
            const mesmaDataEconomica = dataRef.toLocaleDateString('pt-BR') === dataJornadaStr;

            // 2. ID da Jornada (V√≠nculo direto)
            const mesmoID = t.jornadaId === jornada.id;

            return mesmoID || mesmaDataEconomica;
        };

        // =============================================================
        // 1. GANHOS (Agora usa o Filtro Inteligente tamb√©m)
        // =============================================================
        const ganhosFinalizados = AppState.historicoTransacoes
            .filter(t => 
                pertenceAJornada(t) &&
                t.tipo === 'entrada' &&
                !t.isAjusteInterno &&
                t.categoria !== 'Estorno'
            )
            .reduce((acc, t) => acc + toNum(t.valor), 0);

        // B√¥nus (Mantido l√≥gica original, mas com filtro novo se tiver ID)
        // Nota: B√¥nus geralmente n√£o tem ID de jornada, ent√£o confiamos na data
        const bonusPromocoes = AppState.historicoTransacoes
            .filter(t => 
                pertenceAJornada(t) &&
                t.tipo === 'entrada' &&
                t.descricao?.startsWith('B√¥nus:')
            )
            .reduce((acc, t) => acc + toNum(t.valor), 0);

        const totalGanhosFinalizados = ganhosFinalizados + bonusPromocoes;

        const totalGanhosPendentes = (jornada.servicosEmAndamento || [])
            .filter(s => s.statusPagamento === 'pendente')
            .reduce((acc, s) => acc + toNum(s.valor), 0);

        // =============================================================
        // 2. TEMPO (L√≥gica V81 Intacta)
        // =============================================================
        const duracaoPausas = (jornada.pausas || []).reduce((acc, p) => {
            const fim = p.fim || Date.now();
            return acc + (fim - new Date(p.inicio));
        }, 0);

        const fimJornada = jornada.status === 'finalizada' ? jornada.fimJornada : Date.now();
        const duracaoJornada = jornada.inicioJornada ? fimJornada - new Date(jornada.inicioJornada) : 0;

        const tempoLiquido = Math.max(0, duracaoJornada - duracaoPausas - toNum(jornada.tempoInativoAcumulado));

        // =============================================================
        // 3. KM (L√≥gica V81 Intacta - Otimizado/Lata)
        // =============================================================
        const kmInicial = toNum(jornada.kmInicial);
        const kmFinal = toNum(jornada.kmFinal);
        const kmTotal = kmFinal > kmInicial ? kmFinal - kmInicial : 0;

        let kmProdutivo = 0;
        const intervalos = [];

        (jornada.atividades || []).forEach(a => {
            const kmi = toNum(a.kmInicialServico);
            const kmf = toNum(a.kmFinalServico);
            if (kmf > kmi) {
                kmProdutivo += (kmf - kmi);
                intervalos.push({ start: kmi, end: kmf });
            }
        });

        // --- KM Otimizado ---
        let kmOtimizado = 0;
        if (intervalos.length > 1) {
            const pontos = [];
            intervalos.forEach(i => {
                pontos.push({ km: i.start, type: 'start' });
                pontos.push({ km: i.end, type: 'end' });
            });
            pontos.sort((a, b) => a.km !== b.km ? a.km - b.km : a.type === 'start' ? -1 : 1);

            let ativos = 0;
            let ultimoKm = pontos[0].km;
            for (const p of pontos) {
                if (p.km > ultimoKm && ativos >= 2) kmOtimizado += (p.km - ultimoKm);
                ativos += p.type === 'start' ? 1 : -1;
                ultimoKm = p.km;
            }
        }

        let kmLata;
        if (AppState.configuracoes.manterCalculoKmAntigo) {
            kmLata = Math.max(0, kmTotal - kmProdutivo);
        } else {
            kmLata = Math.max(0, kmTotal - (kmProdutivo - kmOtimizado));
        }

        // =============================================================
        // 4. CUSTOS VARI√ÅVEIS (ATUALIZADO PARA V130)
        // =============================================================
        let custoVariavelTotal = 0;
        let custoAbastecimento = 0;

        // Abastecimento direto da Jornada
        if (jornada.custos?.abastecimento) {
            custoAbastecimento = toNum(jornada.custos.abastecimento.valor);
            custoVariavelTotal += custoAbastecimento;
        }

        // üî• O PULO DO GATO: Filtro Inteligente
        const outrosCustos = AppState.historicoTransacoes
            .filter(t => 
                pertenceAJornada(t) && // Usa ID ou Data Econ√¥mica
                t.tipo === 'saida' &&
                t.isCustoOperacional === true &&
                t.categoria !== 'Abastecimento' &&
                // Se modo Real, ignora provis√µes (caixinha)
                (modoReal ? t.impactaResultado !== false : true)
            )
            .reduce((acc, t) => acc + toNum(t.valor), 0);

        custoVariavelTotal += outrosCustos;

        // Provisionamento KM (Virtual)
        if (typeof BusinessLogic.calcularCustoProvisionamentoKm === 'function') {
            const custoProv = BusinessLogic.calcularCustoProvisionamentoKm(kmTotal);
            custoVariavelTotal += custoProv;
        }

        // =============================================================
        // 5. CUSTOS FIXOS
        // =============================================================
        const custosFixos = (typeof BusinessLogic.calcularCustosFixosDiarios === 'function')
            ? BusinessLogic.calcularCustosFixosDiarios(data)
            : { operacional: 0, proLaboreDiario: 0, metaAutonomaDiaria: 0 };
        
        const custoOperacionalTotal = custoVariavelTotal + toNum(custosFixos.operacional);

        // =============================================================
        // 6. M√âTRICAS FINAIS
        // =============================================================
        const lucroReal = totalGanhosFinalizados - custoOperacionalTotal;

        const ganhoBrutoPorKm = safeDiv(totalGanhosFinalizados, kmTotal);
        const custoOperacionalPorKm = safeDiv(custoOperacionalTotal, kmTotal);

        const modoTempo = AppState.configuracoes.modoCronometro || 'liquido';
        let tempoParaCalculoMedia = tempoLiquido;
        if (modoTempo === 'bruto') tempoParaCalculoMedia = duracaoJornada;
        else if (modoTempo === 'hibrido') tempoParaCalculoMedia = Math.max(0, duracaoJornada - duracaoPausas);

        const horasCalculo = Math.max(0.1, tempoParaCalculoMedia / 3600000);
        const mediaHoraDia = safeDiv(totalGanhosFinalizados, horasCalculo);

        const mediaConsumoDia = toNum(jornada.custos?.abastecimento?.mediaCalculada);

        // =============================================================
        // 7. RETORNO FINAL
        // =============================================================
        return {
            totalGanhosFinalizados,
            totalGanhosPendentes,
            tempoLiquido,
            duracaoPausas,
            tempoConsideradoMedia: tempoParaCalculoMedia,

            kmTotal,
            kmProdutivo,
            kmOtimizado,
            kmLata,

            custoVariavelTotal,
            custoAbastecimento,
            custoProvisionamentoKm: (custoVariavelTotal - custoAbastecimento - outrosCustos),
            custoFixoOperacionalDiario: toNum(custosFixos.operacional),
            custoOperacionalTotal,

            lucroReal,
            ganhoBrutoPorKm,
            custoOperacionalPorKm,
            mediaHoraDia,
            mediaConsumoDia,

            custoProLaboreDiario: toNum(custosFixos.proLaboreDiario),
            custoMetaAutonomaDiaria: toNum(custosFixos.metaAutonomaDiaria)
        };
    },


 */
 
// =========================================================================
    // C√ÅLCULO DE RESUMO DO DIA (V210 - FIX: PAUSA EM TEMPO REAL)
    // =========================================================================
    calcularResumoDia: (jornadaInput, dataReferencia = new Date()) => {
        // 1. Defini√ß√£o da Jornada Alvo
        let jornada = jornadaInput;
        const hojeChave = Utils.formatarDataParaChave(new Date());
        const refChave = Utils.formatarDataParaChave(dataReferencia);
        
        if (refChave === hojeChave && AppState.jornadaAtiva) {
            jornada = AppState.jornadaAtiva;
        }

        if (!jornada) return { 
            totalGanhos: 0, totalGanhosFinalizados: 0, totalGanhosPendentes: 0,
            custoOperacionalTotal: 0, lucroLiquido: 0, 
            kmTotal: 0, kmProdutivo: 0, kmLata: 0, kmOtimizado: 0,
            tempoLiquido: 0, totalTempoPausa: 0
        };

        // 2. Tratamento de Datas e Tempo
        const inicio = new Date(jornada.inicioJornada || jornada.inicio || dataReferencia);
        const fim = (jornada.status === 'ativa' || jornada.status === 'em_pausa') 
            ? new Date() 
            : (jornada.fimJornada ? new Date(jornada.fimJornada) : new Date());

        const duracaoTotalMs = Math.max(0, fim - inicio);
        
        // --- CORRE√á√ÉO DO TEMPO DE PAUSA (L√≥gica Robusta) ---
        let duracaoPausasMs = 0;

        if (jornada.pausas && Array.isArray(jornada.pausas)) {
            // M√©todo Novo: Itera sobre o array de pausas
            duracaoPausasMs = jornada.pausas.reduce((acc, p) => {
                const iniPausa = new Date(p.inicio).getTime();
                // Se a pausa n√£o tem fim, usa AGORA (Pausa em andamento)
                const fimPausa = p.fim ? new Date(p.fim).getTime() : Date.now();
                return acc + (fimPausa - iniPausa);
            }, 0);
        } else {
            // M√©todo Legado (Fallback)
            duracaoPausasMs = jornada.tempoPausaTotal || 0;
            if (jornada.status === 'em_pausa' && jornada.inicioPausa) {
                duracaoPausasMs += (Date.now() - new Date(jornada.inicioPausa).getTime());
            }
        }

        const tempoLiquidoMs = Math.max(0, duracaoTotalMs - duracaoPausasMs);
        const tempoLiquidoHoras = tempoLiquidoMs / (1000 * 60 * 60);

        // 3. C√°lculos Financeiros (Atividades)
        const atividades = jornada.atividades || [];
        let totalGanhosFinalizados = 0;
        let totalGanhosPendentes = 0;
        let kmProdutivo = 0;
        let kmOtimizado = 0;

        atividades.forEach(ativ => {
            const valor = parseFloat(ativ.valor) || 0;
            if (ativ.statusPagamento === 'pendente') totalGanhosPendentes += valor;
            else totalGanhosFinalizados += valor;

            const kmServico = (ativ.kmFinalServico && ativ.kmInicialServico) 
                ? (ativ.kmFinalServico - ativ.kmInicialServico) 
                : (ativ.kmRodado || 0);
            
            if (kmServico > 0) kmProdutivo += kmServico;
            if (ativ.isOtimizado || ativ.tipo === 'retorno_pago') kmOtimizado += kmServico;
        });

        // 4. Custos Operacionais (Sync com Hist√≥rico)
        let custoAbastecimento = 0;
        let custosVariaveis = 0;
        
        if (AppState.historicoTransacoes) {
            // Filtra custos vinculados a esta jornada ou data
            AppState.historicoTransacoes.forEach(t => {
                if (t.jornadaId === jornada.id && t.tipo === 'saida') {
                    if (t.categoria === 'Abastecimento') custoAbastecimento += t.valor;
                    else if (t.isCustoOperacional) custosVariaveis += t.valor;
                }
            });
        }

        const custosFixosObj = BusinessLogic.calcularCustosFixosDiarios ? BusinessLogic.calcularCustosFixosDiarios(new Date()) : { operacional: 0 };
        const custoFixoTotal = custosFixosObj.operacional || 0;
        const custoOperacionalTotal = custoAbastecimento + custosVariaveis + custoFixoTotal;

        // 5. KM Lata e Totais
        const kmInicial = parseFloat(jornada.kmInicial) || 0;
        let kmFinal = parseFloat(jornada.kmFinal) || 0;
        
        // Estima KM Final pelo GPS se estiver zerado e ativo
        if (kmFinal === 0 && AppState.gpsCurrentOdometer && AppState.gpsCurrentOdometer > kmInicial) {
            kmFinal = AppState.gpsCurrentOdometer;
        }
        
        let kmTotal = 0;
        if (kmFinal > kmInicial) {
            kmTotal = kmFinal - kmInicial;
        } else {
            // Se n√£o fechou KM, assume pelo menos o que rodou produtivo
            kmTotal = Math.max(0, kmProdutivo); 
        }

        const kmLata = Math.max(0, kmTotal - kmProdutivo);
        const lucroLiquido = (totalGanhosFinalizados + totalGanhosPendentes) - custoOperacionalTotal;
        
        return {
            totalGanhos: totalGanhosFinalizados + totalGanhosPendentes,
            totalGanhosFinalizados,
            totalGanhosPendentes,
            custoOperacionalTotal,
            custoVariavelTotal: custoAbastecimento + custosVariaveis,
            custoFixoOperacionalDiario: custoFixoTotal,
            lucroLiquido,
            lucroReal: lucroLiquido,
            tempoLiquido: tempoLiquidoMs,
            totalTempoPausa: duracaoPausasMs,
            kmTotal, kmProdutivo, kmLata, kmOtimizado,
            ganhoBrutoPorKm: kmTotal > 0 ? (totalGanhosFinalizados / kmTotal) : 0,
            custoOperacionalPorKm: kmTotal > 0 ? (custoOperacionalTotal / kmTotal) : 0,
            mediaHoraDia: tempoLiquidoHoras > 0 ? (totalGanhosFinalizados / tempoLiquidoHoras) : 0,
            mediaConsumoDia: 0 // Implementar m√©dia real se necess√°rio
        };
    },
/* 
// --- C√ÅLCULO DO RESUMO DO DIA (CORRIGIDO: Prioriza Input da Jornada) ---
        calcularResumoDia: (jornada, data = new Date()) => {
             BusinessLogic.normalizeExtras(jornada);
            const totalGanhosFinalizados = jornada.atividades.reduce((acc, curr) => acc + curr.valor, 0);
            const chaveDia = Utils.formatarDataParaChave(data);
           
            const bonusPromocoes = AppState.historicoTransacoes
                .filter(t => t.jornadaId === chaveDia && t.tipo === 'entrada' && t.descricao && t.descricao.startsWith('B√¥nus:'))
                .reduce((acc, t) => acc + t.valor, 0);
            
            const totalGanhosComBonus = totalGanhosFinalizados + bonusPromocoes;
            const totalGanhosPendentes = jornada.servicosEmAndamento.reduce((acc, s) => acc + s.valor, 0);
            
            const duracaoPausas = jornada.pausas.reduce((acc, p) => {
                const fimPausa = p.fim || (jornada.status === 'em_pausa' ? Date.now() : (jornada.status === 'finalizada' ? jornada.fimJornada : p.inicio));
                return acc + (new Date(fimPausa) - new Date(p.inicio));
            }, 0);
            
            const fimTimestamp = jornada.status === 'finalizada' ? jornada.fimJornada : Date.now();
            const duracaoJornada = jornada.inicioJornada ? fimTimestamp - new Date(jornada.inicioJornada) : 0;
            const tempoLiquido = Math.max(0, duracaoJornada - duracaoPausas - (jornada.tempoInativoAcumulado || 0));
            
            const kmInicial = Number(jornada.kmInicial) || 0;
            const kmFinal = Number(jornada.kmFinal) || 0;
            const kmTotal = kmFinal > kmInicial ? kmFinal - kmInicial : 0;
            const kmProdutivo = jornada.atividades.reduce((acc, at) => {
                const kmServico = (at.kmFinalServico && at.kmInicialServico && at.kmFinalServico > at.kmInicialServico) ? (at.kmFinalServico - at.kmInicialServico) : 0;
                return acc + kmServico;
            }, 0);
            
            const intervalos = jornada.atividades.filter(at => at.kmInicialServico && at.kmFinalServico && at.kmFinalServico > at.kmInicialServico).map(at => ({ start: at.kmInicialServico, end: at.kmFinalServico }));
            let kmOtimizado = 0;
            if (intervalos.length > 1) {
                const points = [];
                intervalos.forEach(i => { points.push({ km: i.start, type: 'start' }); points.push({ km: i.end, type: 'end' }); });
                points.sort((a, b) => { if (a.km !== b.km) return a.km - b.km; return a.type === 'start' ? -1 : 1; });
                let activeServices = 0; let lastKm = points[0].km;
                for (const p of points) {
                    if (p.km > lastKm && activeServices >= 2) kmOtimizado += p.km - lastKm;
                    if (p.type === 'start') activeServices++; else activeServices--;
                    lastKm = p.km;
                }
            }
            
            let kmLata;
            if (AppState.configuracoes.manterCalculoKmAntigo) kmLata = Math.max(0, kmTotal - kmProdutivo);
            else kmLata = Math.max(0, kmTotal - (kmProdutivo - kmOtimizado));
            
            // >>> CORRE√á√ÉO 1: PRIORIDADE AO INPUT DA JORNADA <<<
            // Se digitou na tela, usa o valor da tela. Se n√£o, busca no financeiro.
            let custoAbastecimento = 0;
            if (jornada.custos && jornada.custos.abastecimento && jornada.custos.abastecimento.valor > 0) {
                custoAbastecimento = jornada.custos.abastecimento.valor;
            } else {
                custoAbastecimento = AppState.historicoTransacoes
                    .filter(t => t.jornadaId === chaveDia && t.tipo === 'saida' && t.categoria === 'Abastecimento')
                    .reduce((acc, t) => acc + t.valor, 0);
            }

            // Outros Custos
            let outrosCustosVariaveis = 0;
            if (jornada.custos && jornada.custos.outros) {
                outrosCustosVariaveis += jornada.custos.outros.reduce((acc, c) => acc + c.valor, 0);
            }
            const outrosDoFinanceiro = AppState.historicoTransacoes
                .filter(t => t.jornadaId === chaveDia && t.tipo === 'saida' && t.isCustoOperacional === true && t.categoria !== 'Abastecimento')
                .reduce((acc, t) => acc + t.valor, 0);
            
            if (outrosDoFinanceiro > outrosCustosVariaveis) outrosCustosVariaveis = outrosDoFinanceiro;

            const custoProvisionamentoKm = BusinessLogic.calcularCustoProvisionamentoKm(kmTotal);
            const custoVariavelTotal = custoAbastecimento + outrosCustosVariaveis + custoProvisionamentoKm;
            const custosFixos = BusinessLogic.calcularCustosFixosDiarios(data);
            const custoOperacionalTotal = custoVariavelTotal + custosFixos.operacional;
            
            const lucroReal = totalGanhosComBonus - custoOperacionalTotal;
            const ganhoBrutoPorKm = kmTotal > 0 ? totalGanhosComBonus / kmTotal : 0;
            const custoOperacionalPorKm = kmTotal > 0 ? custoOperacionalTotal / kmTotal : 0;
            const tempoLiquidoHoras = tempoLiquido / 3600000;
            const mediaHoraDia = tempoLiquidoHoras > 0 ? totalGanhosComBonus / tempoLiquidoHoras : 0;
            
            // Recupera a m√©dia calculada
            const mediaConsumoDia = jornada.custos && jornada.custos.abastecimento ? (jornada.custos.abastecimento.mediaCalculada || 0) : 0;
            const mediaGlobal = BusinessLogic.calcularConsumoMedio();
            return { 
                totalGanhosFinalizados: totalGanhosComBonus, totalGanhosPendentes, tempoLiquido, duracaoPausas,
                kmTotal, kmProdutivo, kmLata, kmOtimizado, custoVariavelTotal, custoAbastecimento, outrosCustosVariaveis,
                custoFixoOperacionalDiario: custosFixos.operacional, custoOperacionalTotal, lucroReal,
                ganhoBrutoPorKm, custoOperacionalPorKm, mediaHoraDia, mediaConsumoDia,
                custoProLaboreDiario: custosFixos.proLaboreDiario, custoMetaAutonomaDiaria: custosFixos.metaAutonomaDiaria
            };
        },
  */     
// Quando voc√™ termina uma corrida/entrega e o KM sobe, o custo deve subir junto.
/* 
      finalizarServico: (servicoId, tempoFinal, kmInfo) => {
            const jornada = BusinessLogic.getJornadaAtiva();
            if (!jornada) return;
            const servicoIndex = jornada.servicosEmAndamento.findIndex(s => s.id === servicoId);
            if (servicoIndex === -1) return;
            const [servicoFinalizado] = jornada.servicosEmAndamento.splice(servicoIndex, 1);
            const fim = tempoFinal || Date.now();
            
            if (servicoFinalizado.categoria === 'Particular' && servicoFinalizado.statusPagamento === 'pendente') {
                servicoFinalizado.idJornada = AppState.activeJornadaChave; 
                servicoFinalizado.idAtividade = servicoFinalizado.id; 
                AppState.configuracoes.pagamentosPendentes = AppState.configuracoes.pagamentosPendentes
                    .filter(p => p.idAtividade !== servicoFinalizado.idAtividade);
                AppState.configuracoes.pagamentosPendentes.push(servicoFinalizado);
                Storage.salvarConfiguracoes();
            }
            
            if (servicoFinalizado.statusPagamento !== 'pendente' && servicoFinalizado.valor > 0) {
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: fim, 
                    contaId: 'AUTO_ID_CARTEIRA', 
                    tipo: 'entrada',
                    valor: servicoFinalizado.valor,
                    descricao: `Servi√ßo: ${servicoFinalizado.descricao || servicoFinalizado.categoria}`,
                    categoria: servicoFinalizado.categoria, 
                    jornadaId: AppState.activeJornadaChave
                });
                Storage.salvarConfiguracoes();
            }

            jornada.atividades.push({
                ...servicoFinalizado,
                fim: fim,
                duracaoMs: fim - new Date(servicoFinalizado.inicio),
                kmInicialServico: kmInfo.inicial,
                kmFinalServico: kmInfo.final
            });
            
            if (kmInfo.final && kmInfo.final > (jornada.kmFinal || 0)) {
                jornada.kmFinal = kmInfo.final;
            }

            if (servicoFinalizado.descricao && servicoFinalizado.descricao.trim() !== '') {
                const categoria = servicoFinalizado.categoria;
                if (categoria === 'Entrega' || categoria === 'Outro') {
                    AppState.lastDescriptions[categoria] = servicoFinalizado.descricao;
                    Storage.salvarUltimaDescricao();
                }
            }
        },

 */
 // 3. FINALIZAR SERVI√áO (V180 - CORRIGIDO: ATUALIZA SALDO E HIST√ìRICO)
    finalizarServico: (servicoId, tempoFinal, kmInfo) => {
        const jornada = BusinessLogic.getJornadaAtiva();
        if (!jornada) return;

        const servicoIndex = jornada.servicosEmAndamento.findIndex(s => s.id === servicoId);
        if (servicoIndex === -1) return;

        const [servicoFinalizado] = jornada.servicosEmAndamento.splice(servicoIndex, 1);
        const fim = tempoFinal || Date.now();
        
        // 1. L√≥gica de Pendentes (Mantida)
        if (servicoFinalizado.categoria === 'Particular' && servicoFinalizado.statusPagamento === 'pendente') {
            servicoFinalizado.idJornada = AppState.activeJornadaChave; 
            servicoFinalizado.idAtividade = servicoFinalizado.id; 
            AppState.configuracoes.pagamentosPendentes = AppState.configuracoes.pagamentosPendentes
                .filter(p => p.idAtividade !== servicoFinalizado.idAtividade);
            AppState.configuracoes.pagamentosPendentes.push(servicoFinalizado);
        }
        
        // 2. Transa√ß√£o Financeira (A CORRE√á√ÉO EST√Å AQUI üëá)
        if (servicoFinalizado.statusPagamento !== 'pendente' && servicoFinalizado.valor > 0) {
            // A) Cria o Registro no Hist√≥rico
            AppState.historicoTransacoes.push({
                id: crypto.randomUUID(),
                data: fim, 
                contaId: 'AUTO_ID_CARTEIRA', 
                tipo: 'entrada',
                valor: servicoFinalizado.valor,
                descricao: `Receita: ${servicoFinalizado.descricao || servicoFinalizado.categoria}`,
                categoria: servicoFinalizado.categoria, 
                jornadaId: AppState.activeJornadaChave,
                impactaResultado: true // Importante para o DRE
            });

            // B) DEPOSITA O DINHEIRO NA CARTEIRA (Isso faltava!) üí∞
            const carteira = AppState.configuracoes.contasBancarias.find(c => c.id === 'AUTO_ID_CARTEIRA');
            if (carteira) {
                // Se o saldo for undefined ou texto, zera antes de somar
                if (typeof carteira.saldo !== 'number') carteira.saldo = 0;
                carteira.saldo += servicoFinalizado.valor;
            }

            // C) Salva TUDO (Transa√ß√µes E Configura√ß√µes onde fica o saldo)
            Storage.salvarTransacoes();     // Salva o hist√≥rico novo
            Storage.salvarConfiguracoes();  // Salva o saldo novo
        }

        // 3. Atualiza Atividade na Jornada
        jornada.atividades.push({
            ...servicoFinalizado,
            fim: fim,
            duracaoMs: fim - new Date(servicoFinalizado.inicio),
            kmInicialServico: kmInfo.inicial,
            kmFinalServico: kmInfo.final
        });
        
        // 4. Atualiza KM Final da Jornada
        if (kmInfo.final && kmInfo.final > (jornada.kmFinal || 0)) {
            jornada.kmFinal = kmInfo.final;
        }

        // 5. Gatilhos Extras
        if (AppState.activeJornadaChave) {
            BusinessLogic.recalcularCustosAbastecimentoJornada(AppState.activeJornadaChave);
        }

        if (servicoFinalizado.descricao && servicoFinalizado.descricao.trim() !== '') {
            const categoria = servicoFinalizado.categoria;
            if (categoria === 'Entrega' || categoria === 'Outro') {
                AppState.lastDescriptions[categoria] = servicoFinalizado.descricao;
                Storage.salvarUltimaDescricao();
            }
        }
        
        Storage.salvarJornadas();
        
        // 6. Atualiza a tela imediatamente para ver o saldo subir
        UIRenderer.render(); 
    },
 
 
 /*
 // 3. FINALIZAR SERVI√áO (MANTIDO DA V77 - GATILHO NECESS√ÅRIO)
    finalizarServico: (servicoId, tempoFinal, kmInfo) => {
        const jornada = BusinessLogic.getJornadaAtiva();
        if (!jornada) return;

        const servicoIndex = jornada.servicosEmAndamento.findIndex(s => s.id === servicoId);
        if (servicoIndex === -1) return;

        const [servicoFinalizado] = jornada.servicosEmAndamento.splice(servicoIndex, 1);
        const fim = tempoFinal || Date.now();
        
        // Pendentes
        if (servicoFinalizado.categoria === 'Particular' && servicoFinalizado.statusPagamento === 'pendente') {
            servicoFinalizado.idJornada = AppState.activeJornadaChave; 
            servicoFinalizado.idAtividade = servicoFinalizado.id; 
            AppState.configuracoes.pagamentosPendentes = AppState.configuracoes.pagamentosPendentes
                .filter(p => p.idAtividade !== servicoFinalizado.idAtividade);
            AppState.configuracoes.pagamentosPendentes.push(servicoFinalizado);
            Storage.salvarConfiguracoes();
        }
        
        // Transa√ß√£o Financeira
        if (servicoFinalizado.statusPagamento !== 'pendente' && servicoFinalizado.valor > 0) {
            AppState.historicoTransacoes.push({
                id: crypto.randomUUID(),
                data: fim, 
                contaId: 'AUTO_ID_CARTEIRA', 
                tipo: 'entrada',
                valor: servicoFinalizado.valor,
                descricao: `Servi√ßo: ${servicoFinalizado.descricao || servicoFinalizado.categoria}`,
                categoria: servicoFinalizado.categoria, 
                jornadaId: AppState.activeJornadaChave
            });
            Storage.salvarConfiguracoes();
        }

        // Atualiza Atividade
        jornada.atividades.push({
            ...servicoFinalizado,
            fim: fim,
            duracaoMs: fim - new Date(servicoFinalizado.inicio),
            kmInicialServico: kmInfo.inicial,
            kmFinalServico: kmInfo.final
        });
        
        // Atualiza KM Final da Jornada
        if (kmInfo.final && kmInfo.final > (jornada.kmFinal || 0)) {
            jornada.kmFinal = kmInfo.final;
        }

        // üî• GATILHO V79: Recalcula o custo operacional imediatamente
        if (AppState.activeJornadaChave) {
            BusinessLogic.recalcularCustosAbastecimentoJornada(AppState.activeJornadaChave);
        }

        // Salva Descri√ß√£o
        if (servicoFinalizado.descricao && servicoFinalizado.descricao.trim() !== '') {
            const categoria = servicoFinalizado.categoria;
            if (categoria === 'Entrega' || categoria === 'Outro') {
                AppState.lastDescriptions[categoria] = servicoFinalizado.descricao;
                Storage.salvarUltimaDescricao();
            }
        }
        
        Storage.salvarJornadas(); 
    },
/**/
// ========================================================================
        // C√ÅLCULO DE RESUMO V-FINAL (GOLD: SEM√ÇNTICA + ESTRUTURAL + BLINDADA)
        // ========================================================================
        calcularResumoPeriodo: (ano, mes, arg3 = -1, arg4 = null) => {
            let dia = arg3;
            let filter = arg4;
            if (typeof arg3 === 'object' && arg3 !== null) { filter = arg3; dia = -1; }

            // Helper de Blindagem
            const safeVal = (v) => (typeof v === 'number' && Number.isFinite(v)) ? v : 0;
            const _fmt = (s) => String(s || '').trim().toLowerCase();

            const resumo = {
                totalGanhos: 0, totalCustos: 0, totalLucro: 0, totalKm: 0,
                diasTrabalhados: 0, totalTempoLiquido: 0, totalTempoPausa: 0,
                ganhosPorCategoria: {}, custosPorCategoria: {},
                dadosDiarios: [], dadosCombustivel: [], dadosKmL: [], 
                mediaPorKm: 0, totalGanhosBrutosParaTaxa: 0, totalTaxaValor: 0, taxaMediaPercent: 0,
                totalKmL: 0, countKmL: 0, mediaKmL: 0,
                totalGorjetas: 0, totalTaxasExplicitas: 0 
            };
            
            // Seguran√ßa Config
            const config = AppState.configuracoes || {};
            const veiculo = config.veiculo || { valor: 0, vidaUtil: 5, combustivel: '' };
            const custosFixos = config.custosFixos || [];
            const metasFinanceiras = config.metasFinanceiras || [];

            const isPassado = (ano < new Date().getFullYear()) || (ano === new Date().getFullYear() && mes !== -1 && mes < new Date().getMonth());

            // 1. JORNADAS (L√≥gica Operacional Preservada)
            if (AppState.jornadas) {
                for (const chave in AppState.jornadas) {
                    try {
                        // Blindagem de Data
                        const dataJornada = new Date(chave + 'T12:00:00');
                        if (isNaN(dataJornada.getTime())) continue;

                        const isAnoMatch = dataJornada.getFullYear() === ano;
                        const isMesMatch = (mes === -1) || (dataJornada.getMonth() === mes);
                        const isDiaMatch = (dia === -1) || (dataJornada.getDate() === dia);

                        if (isAnoMatch && isMesMatch && isDiaMatch) {
                            const jornada = AppState.jornadas[chave];
                            if (!jornada) continue;
                            if (jornada.status === 'inativa' && (!jornada.atividades || jornada.atividades.length === 0)) continue;

                            // Normaliza√ß√£o de Estrutura
                            if (!jornada.atividades) jornada.atividades = [];
                            if (!jornada.custos) jornada.custos = {};
                            if (!jornada.custos.abastecimento) jornada.custos.abastecimento = { litros: 0, valor: 0 };
                            if (!jornada.custos.outros) jornada.custos.outros = [];

                            // Chama o calculador di√°rio (assumindo que ele exista no BusinessLogic)
                            const resumoDia = (filter && BusinessLogic.calcularResumoDiaComFiltro) 
                                ? BusinessLogic.calcularResumoDiaComFiltro(jornada, filter, dataJornada)
                                : (BusinessLogic.calcularResumoDia ? BusinessLogic.calcularResumoDia(jornada, dataJornada) : { totalGanhosFinalizados: 0, custoOperacionalTotal: 0 });

                            const diaTeveMovimento = (safeVal(resumoDia.totalGanhosFinalizados) > 0 || safeVal(resumoDia.custoOperacionalTotal) > 0);

                            if (diaTeveMovimento) {
                                resumo.totalGanhos += safeVal(resumoDia.totalGanhosFinalizados); 
                                resumo.totalCustos += safeVal(resumoDia.custoOperacionalTotal);
                                resumo.totalLucro += safeVal(resumoDia.lucroReal);
                                resumo.totalKm += safeVal(resumoDia.kmTotal);
                                resumo.totalTempoLiquido += safeVal(resumoDia.tempoLiquido);
                                if (!filter) resumo.totalTempoPausa += safeVal(resumoDia.duracaoPausas);
                                resumo.diasTrabalhados++;
                                
                                if (!filter) {
                                    resumo.dadosDiarios.push({ 
                                        dia: dataJornada.getDate(), mes: dataJornada.getMonth(), 
                                        ganhos: safeVal(resumoDia.totalGanhosFinalizados), custos: safeVal(resumoDia.custoOperacionalTotal) 
                                    });
                                    resumo.dadosCombustivel.push({ dia: dataJornada.getDate(), mes: dataJornada.getMonth(), custo: safeVal(resumoDia.custoAbastecimento) });
                                    if (safeVal(resumoDia.mediaConsumoDia) > 0) {
                                        resumo.dadosKmL.push({ dia: dataJornada.getDate(), mes: dataJornada.getMonth(), media: resumoDia.mediaConsumoDia });
                                        resumo.totalKmL += resumoDia.mediaConsumoDia;
                                        resumo.countKmL++;
                                    }
                                }
                            }

                            if (!filter || filter.type === 'receita') {
                                jornada.atividades.forEach(at => {
                                    if (!at) return;
                                    const cat = at.categoria || 'Outro';
                                    const sub = at.subcategoria || 'N/A';
                                    const val = safeVal(at.valor);
                                    const valBruto = safeVal(at.valorBruto);
                                    
                                    if (!resumo.ganhosPorCategoria[cat]) resumo.ganhosPorCategoria[cat] = { total: 0, sub: {}, totalBruto: 0, totalTaxa: 0 };
                                    resumo.ganhosPorCategoria[cat].total += val;
                                    if (!resumo.ganhosPorCategoria[cat].sub[sub]) resumo.ganhosPorCategoria[cat].sub[sub] = { total: 0, totalBruto: 0, totalTaxa: 0 };
                                    resumo.ganhosPorCategoria[cat].sub[sub].total += val;

                                    if (valBruto > val) {
                                        const taxa = valBruto - val;
                                        resumo.ganhosPorCategoria[cat].totalBruto += valBruto;
                                        resumo.ganhosPorCategoria[cat].totalTaxa += taxa;
                                        resumo.ganhosPorCategoria[cat].sub[sub].totalBruto += valBruto;
                                        resumo.ganhosPorCategoria[cat].sub[sub].totalTaxa += taxa;
                                        if (!filter || (filter.type === 'receita')) {
                                            resumo.totalGanhosBrutosParaTaxa += valBruto;
                                            resumo.totalTaxaValor += taxa;
                                            resumo.totalTaxasExplicitas += taxa;
                                        }
                                    }
                                });
                            }
                            
                            if (!filter || filter.type === 'custo') {
                                const helperAddCusto = (cCat, cSub, cVal) => {
                                     const v = safeVal(cVal);
                                     if (v === 0) return;
                                     const cat = cCat || 'Outro';
                                     const sub = cSub || 'N/A';
                                     if (!resumo.custosPorCategoria[cat]) resumo.custosPorCategoria[cat] = { total: 0, sub: {} };
                                     resumo.custosPorCategoria[cat].total += v;
                                     resumo.custosPorCategoria[cat].sub[sub] = (resumo.custosPorCategoria[cat].sub[sub] || 0) + v;
                                };

                                // Combust√≠vel (Vem limpo da Jornada V40)
                                if (jornada.custos.abastecimento && safeVal(jornada.custos.abastecimento.valor) > 0) {
                                     const subAbast = (veiculo.combustivel || '').includes('El√©trico') ? 'Energia (kWh)' : 'Combust√≠vel';
                                     helperAddCusto('Abastecimento', subAbast, jornada.custos.abastecimento.valor);
                                }
                                // Outros Custos Vari√°veis
                                if (jornada.custos.outros) {
                                    jornada.custos.outros.forEach(c => {
                                        if(c) helperAddCusto(c.categoria || 'Outro C. Vari√°vel', c.subcategoria || c.descricao, c.valor);
                                    });
                                }
                                
                                // Custos Fixos / Deprecia√ß√£o / Metas (L√≥gica Cont√°bil)
                                if (!isPassado) {
                                     const diasTrabalho = BusinessLogic.calcularDiasTrabalhoNoMes ? BusinessLogic.calcularDiasTrabalhoNoMes(dataJornada.getFullYear(), dataJornada.getMonth()) : 25; // Fallback 25 dias
                                     if (diasTrabalho > 0) {
                                         if (veiculo.valor > 0) helperAddCusto('Deprecia√ß√£o', 'Ve√≠culo', ((veiculo.valor / (veiculo.vidaUtil || 5)) / 12) / diasTrabalho);
                                         
                                         custosFixos.forEach(cf => {
                                             if(cf) helperAddCusto(cf.categoria || 'Outro C. Fixo', cf.subcategoria || cf.descricao, safeVal(cf.valor) / diasTrabalho);
                                         });
                                         
                                         metasFinanceiras.filter(m => m && m.incluirComoCustoDiario !== false).forEach(m => {
                                             const valMeta = (BusinessLogic.calcularCustoDiarioMeta) ? BusinessLogic.calcularCustoDiarioMeta(m, dataJornada) : 0;
                                             if (valMeta > 0) helperAddCusto('Manuten√ß√£o (Prov.)', m.descricao, valMeta);
                                         });
                                     }
                                }
                            }
                        }
                    } catch (e) {
                        console.warn(`Erro ao processar jornada ${chave}:`, e);
                    }
                }
            }
            
            // 2. FINANCEIRO (TRANSA√á√ïES SOLTAS / EXTRAS / TAXAS)
            // Aqui mantemos a l√≥gica Gold para capturar coisas que n√£o est√£o nas jornadas
            if ((!filter || filter.type === 'custo' || filter.type === 'receita') && AppState.historicoTransacoes) {
                AppState.historicoTransacoes.forEach(t => {
                    // üõ°Ô∏è BLINDAGEM CONTRA ZUMBIS (A Corre√ß√£o do Erro)
                    if (!t || typeof t !== 'object') return;
                    
                    // üîí REGRA 1: O "Escudo"! Ignora ajustes internos (transfer√™ncia de lucro) no relat√≥rio
                    if (t.isAjusteInterno === true) return;
                    
                    if (!t.data) return;

                    const d = new Date(typeof t.data === 'number' ? t.data : t.data);
                    if (isNaN(d.getTime())) return;

                    if (d.getFullYear() === ano && (mes === -1 || d.getMonth() === mes) && (dia === -1 || d.getDate() === dia)) {
                        
                        const valor = safeVal(t.valor);

                        // Filtro de Entradas (Extras / Gorjetas fora da jornada)
                        if (t.tipo === 'entrada') {
                            const cat = _fmt(t.categoria);
                            const desc = _fmt(t.descricao);
                            
                            const isStructuralExtra = t.isExtra === true || (t.detalhes && t.detalhes.isExtra === true);
                            const isSemanticExtra = cat.includes('gorjeta') || cat.includes('promo√ß√£o') || 
                                                    cat.includes('b√¥nus') || cat.includes('extra') ||
                                                    desc.includes('gorjeta') || desc.includes('promo√ß√£o') || 
                                                    desc.includes('b√¥nus') || desc.includes('extra');

                            if (isStructuralExtra || isSemanticExtra) {
                                resumo.totalGorjetas += valor;
                            }
                        }

                        // Filtro de Sa√≠das (Taxas Avulsas / Custos n√£o operacionais)
                        if (t.tipo === 'saida') {
                            const catLower = _fmt(t.categoria);
                            if (catLower.includes('taxa') || catLower.includes('imposto') || catLower.includes('plataforma')) {
                                resumo.totalTaxasExplicitas += valor;
                            }
                            
                            // Se estamos olhando para o passado, somamos custos financeiros reais
                            // (Cuidado para n√£o duplicar o que veio da Jornada)
                            if (isPassado && (!filter || filter.type === 'custo')) {
                                let ehCustoFixo = t.contaId === 'META_CUSTOS_MENSAIS' || 
                                    ['manuten√ß√£o', 'impostos', 'administrativo', 'outro c. fixo'].includes(catLower);
                                
                                if (ehCustoFixo) {
                                    const cat = t.categoria || 'Outro C. Fixo';
                                    const sub = t.subcategoria || t.descricao;
                                    if (!resumo.custosPorCategoria[cat]) resumo.custosPorCategoria[cat] = { total: 0, sub: {} };
                                    resumo.custosPorCategoria[cat].total += valor;
                                    resumo.custosPorCategoria[cat].sub[sub] = (resumo.custosPorCategoria[cat].sub[sub] || 0) + valor;
                                    
                                    // Adiciona ao total global se for passado (pois n√£o temos deprecia√ß√£o simulada no passado)
                                    resumo.totalCustos += valor;
                                }
                            }
                        }
                    }
                });
            }

            // 3. RECONCILIA√á√ÉO CONT√ÅBIL
            resumo.totalGanhos += resumo.totalGorjetas;

            // Recalcula Lucro
            if (!filter) {
                resumo.totalLucro = resumo.totalGanhos - resumo.totalCustos;
            } else if (filter.type === 'receita') {
                resumo.totalLucro = resumo.totalGanhos;
            } else {
                resumo.totalLucro = -resumo.totalCustos;
            }

            // M√©tricas
            resumo.mediaPorKm = resumo.totalKm > 0 ? resumo.totalGanhos / resumo.totalKm : 0;
            if (resumo.countKmL > 0) resumo.mediaKmL = resumo.totalKmL / resumo.countKmL;
            
            if (resumo.totalGanhosBrutosParaTaxa > 0) {
                resumo.taxaMediaPercent = (resumo.totalTaxaValor / resumo.totalGanhosBrutosParaTaxa) * 100;
            }

            // Agrupamento Visual
            if (!filter) {
                const agruparDados = (dados) => {
                    const agrupado = {};
                    dados.forEach(d => {
                        const k = d.dia;
                        if (!agrupado[k]) { agrupado[k] = { ganhos: 0, custos: 0, custoCombustivel: 0, mediaKmL: 0, countKmL: 0 }; }
                        agrupado[k].ganhos += d.ganhos || 0;
                        agrupado[k].custos += d.custos || 0;
                        agrupado[k].custoCombustivel += d.custo || 0;
                        if (d.media > 0) { agrupado[k].mediaKmL += d.media; agrupado[k].countKmL++; }
                    });
                    const resultado = [];
                    for (const k in agrupado) {
                        const item = { ...agrupado[k] };
                        if (item.countKmL > 0) { item.mediaKmL = item.mediaKmL / item.countKmL; }
                        resultado.push({ [mes === -1 ? 'mes' : 'dia']: parseInt(k), ...item });
                    }
                    return resultado.sort((a, b) => (mes === -1 ? a.mes - b.mes : a.dia - b.dia));
                };
                resumo.dadosDiarios = agruparDados([...resumo.dadosDiarios]);
                resumo.dadosCombustivel = agruparDados([...resumo.dadosCombustivel]);
                resumo.dadosKmL = agruparDados([...resumo.dadosKmL]);
            }

            // Formata√ß√£o final de seguran√ßa
            resumo.totalGanhos = parseFloat(resumo.totalGanhos.toFixed(2));
            resumo.totalCustos = parseFloat(resumo.totalCustos.toFixed(2));
            resumo.totalLucro = parseFloat(resumo.totalLucro.toFixed(2));

            return resumo;
        },





    calcularResumoFiltrado: (mes, ano, type, category, subcategory) => {
            const resumoBase = BusinessLogic.calcularResumoPeriodo(ano, mes, -1);
            if (!category) return resumoBase; 
            // A l√≥gica detalhada de filtro j√° foi migrada para calcularResumoPeriodo
            return resumoBase; 
        },
        
        calcularResumoGAM: () => {
            const historico = AppState.historicoManutencao;
            const resumo = { custosPorCategoria: {}, totalGasto: 0, primeiroKm: 0, ultimoKm: 0 };
            if (historico.length === 0) return resumo;
            let minKm = Infinity; let maxKm = 0;
            historico.forEach(item => {
                const categoria = item.categoria || 'Outro';
                const valor = item.valor || 0;
                resumo.custosPorCategoria[categoria] = (resumo.custosPorCategoria[categoria] || 0) + valor;
                resumo.totalGasto += valor;
                const kmItem = item.km || 0;
                if (kmItem > 0) {
                    if (kmItem < minKm) minKm = kmItem;
                    if (kmItem > maxKm) maxKm = kmItem;
                }
            });
            resumo.primeiroKm = (minKm === Infinity) ? 0 : minKm;
            resumo.ultimoKm = maxKm;
            return resumo;
        },
        
calcularSaudeVeiculo: (odometroAtual) => {
            const planoMestre = AppState.configuracoes.planoManutencao;
            const historico = AppState.historicoManutencao;
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); 
            const { veiculo, litrosRestantes } = AppState.configuracoes;
            const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
            const isEV = tipoCombustivel.toLowerCase().includes('el√©trico');
            const autonomiaBase = veiculo.autonomia || 0;

            if (planoMestre.length === 0 && litrosRestantes <= 0) return { score: 100, itens: [] };
            let piorUrgencia = 0;
            const itensSaude = [];

            // Alerta de Combust√≠vel (Reserva)
            if (litrosRestantes > 0 && litrosRestantes <= 5 && !isEV) {
                const urgencia = (litrosRestantes <= 2) ? 1.1 : 0.9;
                itensSaude.push({
                    id: 'ALERTA_COMBUSTIVEL', descricao: `Ve√≠culo na reserva (${litrosRestantes.toFixed(1)} L). Abaste√ßa em breve.`,
                    categoria: 'Combust√≠vel', urgencia: urgencia, status: urgencia > 1 ? 'Vencido' : 'Aten√ß√£o',
                    kmRestante: (autonomiaBase > 0) ? (litrosRestantes * autonomiaBase) : 0, diasRestantes: Infinity
                });
                piorUrgencia = Math.max(piorUrgencia, urgencia);
            }

            planoMestre.forEach(itemPlano => {
                const historicoDoItem = historico.filter(h => h.planoId === itemPlano.id).sort((a, b) => new Date(b.data) - new Date(a.data));
                const ultimoServico = historicoDoItem[0];
                const ultimoKm = ultimoServico ? (ultimoServico.km || 0) : 0;
                const ultimaData = ultimoServico ? new Date(ultimoServico.data + "T12:00:00") : null;
                
                let urgencia = 0; 
                let status = 'Em dia'; 
                let kmRestante = Infinity; 
                let diasRestantes = Infinity;

                // 1. C√ÅLCULO POR KM
                if (itemPlano.intervaloKm > 0 && odometroAtual > 0) {
                    // Se nunca fez (ultimoKm 0), assume que est√° valendo desde o KM 0 do carro
                    // Se o carro n√£o for zero, o usu√°rio deve lan√ßar um "hist√≥rico inicial" para calibrar
                    const proximoKm = ultimoKm + itemPlano.intervaloKm;
                    kmRestante = proximoKm - odometroAtual;
                    
                    const kmRodadosDesdeUltima = Math.max(0, odometroAtual - ultimoKm);
                    const percentualKm = (kmRodadosDesdeUltima / itemPlano.intervaloKm);
                    urgencia = Math.max(urgencia, percentualKm);
                }

                // 2. C√ÅLCULO POR TEMPO (MESES)
                if (itemPlano.intervaloMeses > 0) {
                    if (ultimaData) {
                        // Cen√°rio A: J√° existe hist√≥rico
                        const proximaData = new Date(ultimaData);
                        proximaData.setMonth(proximaData.getMonth() + itemPlano.intervaloMeses);
                        
                        const totalDiasIntervalo = (proximaData - ultimaData) / (1000 * 60 * 60 * 24);
                        diasRestantes = (proximaData - hoje) / (1000 * 60 * 60 * 24);
                        const diasPassados = Math.max(0, (hoje - ultimaData) / (1000 * 60 * 60 * 24));
                        
                        if (totalDiasIntervalo > 0) {
                            const percentualTempo = (diasPassados / totalDiasIntervalo);
                            urgencia = Math.max(urgencia, percentualTempo);
                        }
                    } else {
                        // >>> CORRE√á√ÉO DO BUG <<<
                        // Cen√°rio B: NUNCA foi feito (Sem hist√≥rico)
                        // Antes: urgencia = 1 (Vencido)
                        // Agora: urgencia = 0 (Novo / Aguardando 1¬∫ registro)
                        // Assumimos que se n√£o tem registro, o ciclo de tempo ainda n√£o come√ßou a contar
                        // ou o item acabou de ser adicionado.
                        urgencia = Math.max(urgencia, 0); 
                        status = 'Novo'; // Status visual informativo
                    }
                }

                // Defini√ß√£o do Status Final
                if (urgencia >= 1) status = 'Vencido'; 
                else if (urgencia >= 0.85) status = 'Aten√ß√£o';
                
                itensSaude.push({
                    id: itemPlano.id, descricao: itemPlano.descricao, categoria: itemPlano.categoria,
                    urgencia: urgencia, status: status, kmRestante: kmRestante, diasRestantes: diasRestantes
                });
                piorUrgencia = Math.max(piorUrgencia, urgencia);
            });

            // Score de Sa√∫de (0 a 100)
            const score = Math.round((1 - Math.min(piorUrgencia, 1.5) / 1.5) * 100);
            itensSaude.sort((a, b) => b.urgencia - a.urgencia);
            
            return { score: score, itens: itensSaude };
        },


// =============================================================
// ATUALIZA√á√ÉO: LIVRO CAIXA COM DETALHAMENTO (AUDITORIA)
// =============================================================
// =============================================================
// ATUALIZA√á√ÉO BLINDADA: LIVRO CAIXA E MEI (PRECIS√ÉO DECIMAL)
// =============================================================

gerarLivroCaixa: (startDate, endDate) => {
    // Inicializa zerado
    const livroCaixaData = { receitas: 0, despesas: 0, lucroTributavel: 0, itens: [] };
    
    const transacoes = AppState.historicoTransacoes.filter(t => { 
        const data = new Date(t.data); 
        return data >= startDate && data <= endDate; 
    });
    
    // LISTA BRANCA: Categorias aceitas (Incluindo as novas)
    const catsDedutiveis = [
        'Manuten√ß√£o', 'Motor', 'Freios', 'Pneus', 'Suspens√£o', 'El√©trico', 
        'Arrefecimento', '√ìleo', 'Filtros', 'Revis√£o', 'Funilaria', 
        'Abastecimento', 'Lavagem', 'Limpeza', 'Est√©tica', 
        'Alimenta√ß√£o', 'Estacionamento', 'Ped√°gio', 
        'Impostos', 'Seguro', 'Administrativo', 'Internet', 
        'Outro C. Vari√°vel', 'Outro C. Fixo'
    ];

    transacoes.forEach(t => {
        // --- A) RECEITAS ---
        if (t.tipo === 'entrada' && !t.detalhes?.leg) {
            const metaDestino = AppState.configuracoes.metasFinanceiras.find(m => m.id === t.contaId);
            const ehEmprestimo = metaDestino && metaDestino.tipo === 'parcelamento';
            
            if (!ehEmprestimo && ['Corrida', 'Entrega', 'Particular', 'Gorjeta', 'Outro'].includes(t.categoria)) {
                // NORMALIZA√á√ÉO: Soma segura
                livroCaixaData.receitas = Utils.somarCentavos(livroCaixaData.receitas, t.valor);
                
                // Adiciona √† lista de detalhes
                livroCaixaData.itens.push({ ...t, tipoItem: 'receita' });
            }
        }

        // --- B) DESPESAS ---
        if (t.tipo === 'saida' && !t.detalhes?.leg) {
            let ehDespesaValida = false;

            if (t.isCustoOperacional === true) ehDespesaValida = true;
            if (catsDedutiveis.includes(t.categoria)) ehDespesaValida = true;
            if (t.descricao && t.descricao.toLowerCase().includes('manut:')) ehDespesaValida = true;

            // Bloqueios (D√≠vidas e Pessoais)
            if (t.detalhes && (t.detalhes.tipo === 'amortizacao_saida' || t.detalhes.tipo === 'amortizacao_saida_banco')) ehDespesaValida = false;
            if (t.contaId && t.contaId.startsWith('META_') && !t.contaId.includes('CUSTOS')) {
                 const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === t.contaId);
                 if (meta && meta.tipo === 'parcelamento') ehDespesaValida = false;
            }
            if (['Lazer', 'Educa√ß√£o', 'Roupas', 'Sa√∫de', 'Moradia'].includes(t.categoria) && !t.isCustoOperacional) ehDespesaValida = false;

            if (ehDespesaValida) {
                // NORMALIZA√á√ÉO: Soma segura
                livroCaixaData.despesas = Utils.somarCentavos(livroCaixaData.despesas, t.valor);
                
                // Adiciona √† lista de detalhes
                livroCaixaData.itens.push({ ...t, tipoItem: 'despesa' });
            }
        }
    });

    // NORMALIZA√á√ÉO: Subtra√ß√£o segura (soma com negativo)
    livroCaixaData.lucroTributavel = Math.max(0, Utils.somarCentavos(livroCaixaData.receitas, -livroCaixaData.despesas));
    
    // Ordena por data (mais recente primeiro)
    livroCaixaData.itens.sort((a, b) => b.data - a.data);
    
    return livroCaixaData;
},

// --- SIMULADOR MEI (CORRIGIDO E NORMALIZADO) ---
gerarSimuladorMEI: (startDate, endDate) => {
    const { perfilFiscal } = AppState.configuracoes;
    
    // Chama o Livro Caixa (j√° normalizado acima)
    const livroCaixaData = BusinessLogic.gerarLivroCaixa(startDate, endDate);
    
    const faturamentoBruto = livroCaixaData.receitas;
    const despesasComprovadas = livroCaixaData.despesas;
    
    // Lucro Real (Cont√°bil) - Normalizado
    const lucroEvidenciado = Utils.somarCentavos(faturamentoBruto, -despesasComprovadas);
    
    // Isen√ß√£o (Presun√ß√£o do Governo)
    const percentual = (perfilFiscal.meiPercentual || 32) / 100;
    
    // C√°lculo de percentual pode gerar d√≠zima, ent√£o arredondamos manualmente para 2 casas
    const parcelaIsentaCalculada = faturamentoBruto * percentual;
    const parcelaIsenta = Math.round(parcelaIsentaCalculada * 100) / 100;
    
    // Base de C√°lculo do IRPF - Normalizado
    const rendimentoTributavel = Math.max(0, Utils.somarCentavos(lucroEvidenciado, -parcelaIsenta));
    
    return { 
        faturamentoBruto, 
        despesasComprovadas, 
        lucroEvidenciado, 
        parcelaIsenta, 
        rendimentoTributavel 
    };
},
        finalizarRegistroManutencao: (planoId, servico, km, mostrarAlerta) => {
            Storage.salvarConfiguracoes();
            UIRenderer.renderHistoricoServicos();
            UIRenderer.renderGamDashboard();
            UIElements.histDataInput.value = '';
            UIElements.histKmInput.value = '';
            UIElements.histServicoInput.value = '';
            UIElements.histLocalInput.value = '';
            UIElements.histValorInput.value = '';
            UIElements.histPlanoMestreItemSelect.value = '';
            const elRetro = document.getElementById('histRegistroRetroativo');
            if(elRetro) elRetro.checked = false; 
            UIElements.histCategoriaSelect.disabled = false;
            UIElements.histServicoInput.disabled = false;
            if (mostrarAlerta) {
                 UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Servi√ßo registrado com sucesso!', type: 'success' });
            }
        }
   };
// ============================================================================
    // SERVI√áO DE COMBUST√çVEL (GOLD MASTER - SINGLE SOURCE OF TRUTH)
    // ============================================================================
    const FuelService = {

        /**
         * üß† O C√âREBRO: Garante consist√™ncia de dados para a UI.
         * Resolve o problema do "Zero Falso" e unifica dados Legados/Novos.
         */
        getUltimoRegistro: (jornada) => {
            // 1. Guard Clause: Se n√£o tem estrutura, retorna nulo seguro
            if (!jornada || !jornada.custos || !jornada.custos.abastecimento) {
                return null;
            }

            const abast = jornada.custos.abastecimento;
            const hist = abast.historico || [];

            // 2. PRIORIDADE 1: Raiz (Dados "Quentes")
            // Se o usu√°rio acabou de salvar e a tela n√£o recarregou, o dado est√° aqui.
            // Usamos verifica√ß√£o expl√≠cita (> 0) para n√£o cair no bug do zero.
            if (abast.litrosRestantes > 0 || abast.litrosConsumidosPainel > 0) {
                return {
                    tanque: Number(abast.litrosRestantes || 0),
                    painel: Number(abast.litrosConsumidosPainel || 0),
                    origem: 'Raiz (Hot Data)'
                };
            }

            // 3. PRIORIDADE 2: Hist√≥rico (Dados Persistidos)
            if (hist.length > 0) {
                const ultimo = hist[hist.length - 1];
                
                // COALESC√äNCIA DE DADOS (Resolve Legado vs Novo)
                // Procura: chave nova ?? chave antiga ?? chave alternativa ?? zero
                const valorTanque = ultimo.tanque ?? ultimo.leitura ?? ultimo.litrosRestantes ?? 0;
                const valorPainel = ultimo.painel ?? ultimo.consumoPainel ?? ultimo.consumo ?? 0;

                return {
                    tanque: Number(valorTanque),
                    painel: Number(valorPainel),
                    origem: 'Hist√≥rico (Cold Data)'
                };
            }

            // 4. Default Seguro (Evita undefined na UI)
            return null;
        },

        // ========================================================================
        // GRAVA√á√ÉO PADRONIZADA (MANT√âM O CONTRATO DE ESCRITA)
        // ========================================================================
        sincronizarJornada: (dataIso, litros, valorTotal, kmAtual, leituraTanque, consumoPainel, operacao = 'adicionar', autoSave = true, idEspecifico = null) => {
            const dataObj = new Date(dataIso);
            if (isNaN(dataObj.getTime())) return null;

            const jornada = BusinessLogic.getJornadaDoDia(dataObj);
            if (!jornada) return null;

            // Inicializa√ß√£o (Garante que getUltimoRegistro nunca falhe por null pointer)
            if (!jornada.custos) jornada.custos = {};
            if (!jornada.custos.abastecimento || typeof jornada.custos.abastecimento !== 'object') {
                jornada.custos.abastecimento = { 
                    valor: 0, litros: 0, kmAbastecimento: 0, mediaCalculada: 0, 
                    litrosRestantes: 0, litrosConsumidosPainel: 0, historico: [] 
                };
            }
            const abs = jornada.custos.abastecimento;
            if (!Array.isArray(abs.historico)) abs.historico = [];

            // Sanitiza√ß√£o de Inputs (Evita NaN)
            const val = parseFloat(String(valorTotal).replace(',', '.')) || 0;
            const lit = parseFloat(String(litros).replace(',', '.')) || 0;
            const km = parseFloat(String(kmAtual).replace(',', '.')) || 0;
            const tanque = parseFloat(String(leituraTanque).replace(',', '.')) || 0;
            const painel = parseFloat(String(consumoPainel).replace(',', '.')) || 0;

            let resultId = null;

            if (operacao === 'adicionar') {
                // Atualiza Acumuladores
                abs.valor = Utils.Money.add(abs.valor, val);
                abs.litros += lit;
                
                // Atualiza Raiz (Para leitura r√°pida)
                if (tanque > 0) abs.litrosRestantes = tanque;
                if (painel > 0) abs.litrosConsumidosPainel = painel;
                if (km > 0) abs.kmAbastecimento = km;

                // Grava no Hist√≥rico (Fonte da Verdade)
                const novoId = crypto.randomUUID();
                resultId = novoId;
                abs.historico.push({
                    id: novoId,
                    timestamp: Date.now(),
                    hora: new Date().toLocaleTimeString(),
                    km: km,
                    litros: lit,
                    valor: val,
                    tanque: tanque,  // Chave oficial
                    painel: painel,  // Chave oficial
                    origem: 'FuelService'
                });

            } else if (operacao === 'remover') {
                // ... (L√≥gica de remo√ß√£o mantida igual ao anterior) ...
                abs.valor = Math.max(0, Utils.Money.subtract(abs.valor, val));
                abs.litros = Math.max(0, abs.litros - lit);
                
                let index = -1;
                if (idEspecifico) index = abs.historico.findIndex(h => h.id === idEspecifico);
                if (index === -1) index = abs.historico.findIndex(h => h.valor === val && h.litros === lit);
                if (index !== -1) abs.historico.splice(index, 1);
                
                // Rollback de estado
                const ultimo = abs.historico[abs.historico.length - 1];
                if (ultimo) {
                    abs.litrosRestantes = ultimo.tanque || 0;
                    abs.litrosConsumidosPainel = ultimo.painel || 0;
                    abs.kmAbastecimento = ultimo.km || 0;
                } else {
                    abs.litrosRestantes = 0;
                    abs.litrosConsumidosPainel = 0;
                    abs.kmAbastecimento = 0;
                }
            }

            // M√©dia
            const kmInicial = jornada.kmInicial || 0;
            const kmFinalRef = abs.kmAbastecimento || kmInicial;
            if (kmFinalRef > kmInicial && abs.litros > 0) {
                abs.mediaCalculada = (kmFinalRef - kmInicial) / abs.litros;
            } else if (abs.historico.length === 0) {
                abs.mediaCalculada = 0;
            }

            if (autoSave) Storage.salvarJornadas();
            
            // Trigger de UI seguro
            if (typeof UIRenderer !== 'undefined' && UIRenderer.renderCustosJornada) {
                UIRenderer.renderCustosJornada(jornada);
            }
            
            return { id: resultId };
        }
    };



// =============================================================
    // ======================= UI RENDERER =========================
    // =============================================================
    const UIRenderer = {
        _renderPending: false, // Flag de controle para o freio de m√£o

    // 1. O FILTRO (A fun√ß√£o que as 80 linhas chamam)
    render: function() {
        if (this._renderPending) return; // Se j√° houver um render na fila, ignora

        this._renderPending = true;

        // requestAnimationFrame: Sincroniza com o monitor (60fps) e evita lag
        requestAnimationFrame(() => {
            try {
                this._executarRenderReal();
            } finally {
                // Libera para o pr√≥ximo render apenas ap√≥s o t√©rmino deste
                this._renderPending = false;
            }
        });
    },

    // 2. A L√ìGICA REAL (Sua fun√ß√£o original renomeada)
    _executarRenderReal: function() {
        const jornadaDoDia = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
        const jornadaAtiva = BusinessLogic.getJornadaAtiva();
        
        AppState.isToday = Utils.formatarDataParaChave(new Date()) === Utils.formatarDataParaChave(AppState.dataSelecionada);
        
        const jornadaParaRender = AppState.isToday ? (jornadaAtiva || jornadaDoDia) : jornadaDoDia;

        // --- 1. Controles Gerais ---
        try {
            UIRenderer.renderControlesGerais(jornadaParaRender);
        } catch (e) { console.error("Erro ao renderizar controles:", e); }

        // For√ßa atualiza√ß√£o de categorias
        if (jornadaParaRender.status !== 'inativa') {
            try { EventHandlers.handleCategoriaChange(); } catch(e) {}
        }

        // --- 2. Servi√ßos em Andamento ---
        try {
            UIRenderer.renderServicosEmAndamento(jornadaAtiva);
        } catch (e) { console.error("Erro ao renderizar servi√ßos:", e); }

        // --- 3. Custos ---
        try {
            UIRenderer.renderCustos(jornadaParaRender);
        } catch (e) { console.error("Erro ao renderizar custos:", e); }

        // --- 4. Fluxo Financeiro ---
        try {
            const jornadaSegura = jornadaParaRender || { status: 'inativa', custos: {}, metas: {}, ganhos: {} };
            UIRenderer.renderResumoDia(jornadaSegura);
            UIRenderer.renderPainelFinanceiro(jornadaSegura);
        } catch (e) { console.error("Erro no fluxo financeiro:", e); }

        // --- 5. Alertas de Ve√≠culo ---
        try {
            if (typeof UIRenderer.renderAlertasJornada === 'function') {
                UIRenderer.renderAlertasJornada(jornadaParaRender);
            }
        } catch (e) { console.error("Erro ao renderizar alertas:", e); }

        // --- 6. Lista de Atividades ---
        try {
            UIRenderer.renderListaAtividades(jornadaParaRender);
        } catch (e) { console.error("Erro ao renderizar lista:", e); }

        // --- 7. Bot√£o Toggle ---
        try {
            UIRenderer.renderToggleStatusButton();
        } catch (e) {}

        // --- 8. Configura√ß√µes ---
        try {
            UIRenderer.renderConfiguracoes();
            UIRenderer.renderPlanoMestre();
            UIRenderer.renderSubcategorias();
        } catch (e) { console.error("Erro ao renderizar configura√ß√µes:", e); }

        // --- 9. Retorno de Pausa ---
        if (AppState.servicoFinalizadoEmPausa) {
            AppState.servicoFinalizadoEmPausa = false;
            UIRenderer.abrirModal('confirmacao', {
                titulo: 'Servi√ßo Finalizado',
                mensagem: 'Deseja voltar para a pausa?',
                confirmClass: 'bg-amber-600 hover:bg-amber-700',
                callback: () => {
                    EventHandlers.handlePausa();
                }
            });
        }
        UIRenderer.renderAlertasContasRecorrentes();
    },
    
// ============================================================================
    // CONTROLADOR FINANCEIRO (V134 - O BOT√ÉO QUE FALTAVA)
    // ============================================================================
renderBotaoAlternarModo: (jornada) => {
    const container = document.getElementById('painel-financeiro-container');
    if (!container) return;

    // üõ°Ô∏è Fallback de seguran√ßa para evitar o log 'undefined'
    if (!AppState.modoDRE) {
        console.warn("‚ö†Ô∏è [UI] modoDRE estava undefined. For√ßando 'presumido'.");
        AppState.modoDRE = 'presumido';
    }

    console.log("üîÑ Modo atual no Render:", AppState.modoDRE);
    const isReal = AppState.modoDRE === 'real';
        const corCorpo = isReal ? 'border-blue-500/30 bg-blue-500/5' : 'border-amber-500/30 bg-amber-500/5';
        const corBotao = isReal ? 'bg-blue-600' : 'bg-amber-600';
        const textoBotao = isReal ? 'üìä MODO REAL (Lucro L√≠quido)' : 'üëÅÔ∏è MODO CAIXA (Dinheiro no Bolso)';

        container.innerHTML = `
            <div class="border ${corCorpo} rounded-lg p-3 mb-4 transition-all animate-fade-in">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Vis√£o Financeira</span>
                    <button onclick="window.alternarModoFinanceiro()" 
                            class="${corBotao} text-white text-[10px] font-black py-1 px-4 rounded-full shadow-lg active:scale-95 transition-all">
                        ${textoBotao}
                    </button>
                </div>
                <p class="text-[9px] text-slate-500 mt-2">
                    ${isReal ? 'Exibindo lucro operacional puro. (Ignorando o que voc√™ guardou).' : 'Exibindo saldo dispon√≠vel. (Considerando caixinhas como custo).'}
                </p>
            </div>
        `;
    },
        renderAlertaCombustivel: () => {
            const { alertaCombustivelContainer } = UIElements;
            const { litrosRestantes } = AppState.configuracoes;
            const isEV = AppState.configuracoes.veiculo.combustivel.toLowerCase().includes('el√©trico');
            
            alertaCombustivelContainer.innerHTML = ''; // Limpa o container
            alertaCombustivelContainer.classList.add('hidden'); // Esconde por padr√£o

            // L√≥gica de Alerta de Combust√≠vel
            if (litrosRestantes > 0 && litrosRestantes <= 5 && !isEV) {
                alertaCombustivelContainer.classList.remove('hidden');
                
                const liInnerHTML = `
                    <div class="flex items-start gap-3 p-2 bg-red-900/50 border border-red-500 rounded-md pulse-fast">
                        <div class="text-red-400 font-bold text-xl flex-shrink-0">‚ö†Ô∏è</div>
                        <div>
                            <span class="font-bold text-red-200">Ve√≠culo na Reserva!</span>
                            <span class="text-slate-300 text-sm block">Restam apenas ${litrosRestantes.toFixed(1)}L. Abaste√ßa logo.</span>
                        </div>
                    </div>
                `;
                alertaCombustivelContainer.innerHTML = liInnerHTML;
            }
        },


renderPlanoMestre: () => {
            const planoMestre = AppState.configuracoes.planoManutencao;
            const listaPlanoMestre = UIElements.listaPlanoMestre;
            
            // Atualiza select do modal
            const metaSelect = UIElements.planoMetaVinculadaSelect;
            const metasPoupanca = AppState.configuracoes.metasFinanceiras.filter(m => m.tipo === 'poupanca' || m.tipo === 'poupanca_km');
            
            if (metaSelect) {
                metaSelect.innerHTML = `<option value="">Nenhuma (Recomendado vincular)</option>`;
                metasPoupanca.forEach(meta => {
                    metaSelect.innerHTML += `<option value="${meta.id}">${Utils.escapeHTML(meta.descricao)}</option>`;
                });
            }

            listaPlanoMestre.innerHTML = '';
            if (UIElements.planoCountSpan) UIElements.planoCountSpan.textContent = planoMestre.length;
            
            if (planoMestre.length === 0) {
                listaPlanoMestre.innerHTML = `<li class="text-center text-slate-400 italic">Nenhum item no Plano Mestre.</li>`;
                return;
            }
            
            planoMestre.sort((a, b) => (a.categoria || '').localeCompare(b.categoria || ''));
            
            planoMestre.forEach(item => {
                const metaVinculada = metasPoupanca.find(m => m.id === item.metaId);
                const metaNome = metaVinculada ? `<span class="text-emerald-400 font-medium">${Utils.escapeHTML(metaVinculada.descricao)}</span>` : `<span class="text-slate-500">N√£o Vinculada</span>`;
                
                let frequenciaStr = '';
                if (item.intervaloKm > 0) frequenciaStr += `${item.intervaloKm.toLocaleString('pt-BR')} KM`;
                if (item.intervaloKm > 0 && item.intervaloMeses > 0) frequenciaStr += ' OU ';
                if (item.intervaloMeses > 0) frequenciaStr += `${item.intervaloMeses} meses`;
                
                // Sanitiza√ß√£o aplicada aqui
                const categoriaHTML = item.categoria ? `<span class="text-xs bg-cyan-900 text-cyan-200 px-2 py-0.5 rounded-full mr-2 border border-cyan-700">${Utils.escapeHTML(item.categoria)}</span>` : '';
                const acaoHTML = item.acao ? `<span class="text-xs text-slate-300 uppercase font-bold mr-1">[${Utils.escapeHTML(item.acao)}]</span>` : '';
                const custoHTML = item.custoEstimado > 0 ? `<span class="text-amber-300 text-xs ml-2 font-bold">Est: ${Utils.formatarMoeda(item.custoEstimado)}</span>` : '';
                const obsIcon = item.observacao ? `<span class="text-red-400 ml-2" title="${Utils.escapeHTML(item.observacao)}">‚ö†Ô∏è</span>` : '';
                const obsTexto = item.observacao ? `<p class="text-xs text-red-300/80 mt-1 italic truncate">Obs: ${Utils.escapeHTML(item.observacao)}</p>` : '';

                const li = document.createElement('li');
                li.className = 'p-3 bg-slate-800 rounded-lg shadow border-l-4 border-slate-600 flex justify-between items-center transition hover:bg-slate-700';
                li.innerHTML = `
                    <div class="flex-grow min-w-0 pr-4">
                        <div class="flex items-center flex-wrap mb-1">
                            ${categoriaHTML}
                            <p class="font-semibold text-white truncate">${acaoHTML} ${Utils.escapeHTML(item.descricao)}${obsIcon}</p>
                        </div>
                        <div class="flex items-center flex-wrap gap-x-4 gap-y-1">
                            <p class="text-xs text-slate-400">Freq: <b class="text-white">${frequenciaStr}</b></p>
                            <p class="text-xs text-slate-400">Caixa: ${metaNome}</p>
                            ${custoHTML}
                        </div>
                        ${obsTexto}
                    </div>
                    <div class="flex items-center gap-3">
                        <button data-id="${item.id}" class="btn-editar-plano text-cyan-400 hover:text-cyan-300 transition text-xs bg-slate-700/50 px-2 py-1 rounded">Editar</button>
                        <button data-id="${item.id}" class="btn-remover-plano text-red-500 hover:text-red-400 text-lg p-1 transition duration-200">√ó</button>
                    </div>
                `;
                listaPlanoMestre.appendChild(li);
            });
        },



// Vari√°vel de controle de pagina√ß√£o
        _paginacaoHistorico: 1,
        _isLoadingHistorico: false,

        renderHistoricoTransacoes: function(reset = true) {
            const lista = document.getElementById('lista-historico-transacoes');
            if (!lista) return;

            // Se for reset, LIMPA E MOSTRA LOADER IMEDIATAMENTE (S√≠ncrono)
            if (reset) {
                this._paginacaoHistorico = 1;
                // Feedback visual instant√¢neo (antes de qualquer l√≥gica)
                lista.innerHTML = `
                    <div id="loader-historico" class="py-10 text-center flex flex-col items-center justify-center space-y-3 animate-pulse">
                        <div class="w-10 h-10 border-4 border-slate-600 border-t-cyan-500 rounded-full animate-spin"></div>
                        <span class="text-sm text-slate-400 font-medium tracking-wide">Carregando transa√ß√µes...</span>
                    </div>
                `;
                
                // Reinicia listener de scroll
                lista.onscroll = null;
                lista.addEventListener('scroll', (e) => {
                    const el = e.target;
                    // Gatilho do Scroll Infinito (chegou perto do fim)
                    if (el.scrollTop + el.clientHeight >= el.scrollHeight - 100) {
                        this.renderHistoricoTransacoes(false);
                    }
                });
            }

            // Evita chamadas duplas se j√° estiver processando
            if (this._isLoadingHistorico) return;
            this._isLoadingHistorico = true;

            if (!reset) {
                // Loader pequeno para scroll infinito
                lista.insertAdjacentHTML('beforeend', `
                    <li id="loader-scroll-infinito" class="py-4 text-center">
                        <span class="inline-block w-5 h-5 border-2 border-slate-600 border-t-cyan-500 rounded-full animate-spin"></span>
                    </li>
                `);
            }

            // --- A M√ÅGICA DA PERFORMANCE ---
            // requestAnimationFrame: "Navegador, prepara a tela com o HTML que eu acabei de mudar (o loader)"
            // setTimeout: "Agora joga o processamento pesado para o final da fila"
            requestAnimationFrame(() => {
                setTimeout(() => {
                    try {
                        const ITENS_POR_PAGINA = 50;
                        const inicio = (this._paginacaoHistorico - 1) * ITENS_POR_PAGINA;
                        const fim = inicio + ITENS_POR_PAGINA;

                        // 1. Processamento Pesado (Sort)
                        // Dica: Se isso ainda travar, podemos mover o sort para fora ou cachear
                        const todosDados = [...AppState.historicoTransacoes].sort((a, b) => new Date(b.data) - new Date(a.data));
                        
                        // 2. Fatia
                        const fatia = todosDados.slice(inicio, fim);

                        // 3. Remove Loaders Visuais
                        if (reset) {
                            lista.innerHTML = ''; 
                        } else {
                            const loaderScroll = document.getElementById('loader-scroll-infinito');
                            if(loaderScroll) loaderScroll.remove();
                        }

                        // 4. Se lista vazia
                        if (fatia.length === 0) {
                            if (reset) lista.innerHTML = '<li class="text-center text-slate-500 p-8 text-xs italic">Nenhum lan√ßamento encontrado.</li>';
                            return;
                        }

                        // 5. Montagem do HTML (Buffer em Mem√≥ria)
                        let htmlBuffer = '';
                        fatia.forEach(t => {
                            const dataObj = new Date(t.data);
                            const dia = String(dataObj.getDate()).padStart(2, '0');
                            const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
                            
                            // Chama a fun√ß√£o centralizada do Utils (DRY)
                            const origemNome = Utils.getNomeConta(t.contaId);

                            const corValor = t.tipo === 'entrada' ? 'text-green-400' : 'text-red-400';
                            const sinal = t.tipo === 'entrada' ? '+' : '-';
                            const bordaCor = t.tipo === 'entrada' ? 'border-green-500' : 'border-red-500';

                            htmlBuffer += `
                                <li class="bg-slate-800 p-3 mb-2 rounded border-l-4 ${bordaCor} flex justify-between items-center shadow-sm hover:bg-slate-750 transition-colors">
                                    <div class="overflow-hidden pr-2">
                                        <div class="font-bold text-white text-sm truncate">${Utils.escapeHTML(t.descricao)}</div>
                                        <div class="text-[11px] text-slate-400 flex gap-2 mt-0.5">
                                            <span class="font-mono">${dia}/${mes}</span>
                                            <span class="text-cyan-600 font-bold tracking-wide">${Utils.escapeHTML(origemNome)}</span>
                                        </div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="font-bold ${corValor} text-base font-mono">${sinal}${Utils.formatarMoeda(t.valor)}</div>
                                        <button onclick="EventHandlers.handleExcluirTransacao('${t.id}')" class="text-[10px] text-red-500/60 hover:text-red-400 underline cursor-pointer mt-1 transition-colors">Excluir</button>
                                    </div>
                                </li>
                            `;
                        });

                        // 6. Inje√ß√£o R√°pida (Apenas um reflow)
                        lista.insertAdjacentHTML('beforeend', htmlBuffer);

                    } catch (e) {
                        console.error("Erro render hist√≥rico:", e);
                        lista.innerHTML = '<li class="text-center text-red-400 p-4 text-xs">Erro ao carregar lista.</li>';
                    } finally {
                        this._isLoadingHistorico = false;
                    }
                }, 50); // Delay de 50ms para garantir que o loader apareceu
            });
        },




renderHistoricoServicos: () => {
            const historico = AppState.historicoManutencao;
            const listaHistorico = UIElements.listaHistoricoServicos;
            const caixinhaSelect = UIElements.histPagarComCaixinhaSelect;
            const planoSelect = UIElements.histPlanoMestreItemSelect;
            const contadorSpan = UIElements.historicoCountSpan;

            // 1. Popula o Select de "Pagar com Caixinha" (COM SALDO REAL)
            const metasPoupanca = AppState.configuracoes.metasFinanceiras
                                    .filter(m => m.tipo === 'poupanca' || m.tipo === 'poupanca_km');
                                    
            caixinhaSelect.innerHTML = `<option value="">N√£o usar (Lan√ßar Custo Avulso)</option>`;
            metasPoupanca.forEach(meta => {
                const saldoMeta = BusinessLogic.calcularSaldoConta(meta.id);
                caixinhaSelect.innerHTML += `<option value="${meta.id}">${meta.descricao} (Saldo: ${Utils.formatarMoeda(saldoMeta)})</option>`;
            });
            
            // 2. Popula o Select de "Vincular ao Plano Mestre"
            const planoMestre = AppState.configuracoes.planoManutencao;
            planoSelect.innerHTML = `<option value="">Nenhum (Registrar Servi√ßo Avulso)</option>`;
            
            if (planoMestre && planoMestre.length > 0) {
                planoMestre.forEach(item => {
                    planoSelect.innerHTML += `<option value="${item.id}" data-categoria="${item.categoria}" data-descricao="${item.descricao}">${item.categoria} - ${item.descricao}</option>`;
                });
            }

            // 3. Prepara a Lista
            listaHistorico.innerHTML = '';
            if (contadorSpan) contadorSpan.textContent = historico.length;

            if (historico.length === 0) {
                listaHistorico.innerHTML = `<li class="text-center text-slate-400 italic text-sm py-4">Nenhum servi√ßo registrado.</li>`;
                return;
            }

            // 4. Ordena (Mais recente primeiro)
            historico.sort((a, b) => new Date(b.data) - new Date(a.data));

            // 5. Renderiza os Itens
            historico.forEach(item => {
                const dataFormatada = Utils.formatarDataParaDisplay(new Date(item.data + "T12:00:00"));
                
                // Verifica se foi pago com caixinha
                const metaUsada = metasPoupanca.find(m => m.id === item.metaId);
                const infoPagamento = metaUsada 
                    ? `<span class="text-xs text-emerald-400 block mt-1">Pago com: ${metaUsada.descricao}</span>` 
                    : `<span class="text-xs text-red-400 block mt-1">Custo Avulso</span>`;
                
                const categoriaHTML = item.categoria ? `<span class="text-[10px] bg-cyan-900 text-cyan-200 px-2 py-0.5 rounded-full mr-2 border border-cyan-700 uppercase font-bold tracking-wide">${item.categoria}</span>` : '';

                const li = document.createElement('li');
                li.className = 'p-3 bg-slate-800 rounded-lg shadow-md border-l-4 border-slate-600 flex justify-between items-center transition hover:bg-slate-750';
                
                li.innerHTML = `
                    <div class="flex-grow min-w-0 pr-4">
                        <div class="flex justify-between items-start mb-1">
                             <div class="flex items-center flex-wrap gap-y-1">
                                ${categoriaHTML}
                                <span class="font-bold text-white truncate text-sm">${item.servico}</span>
                             </div>
                            <span class="font-bold text-base text-amber-300 ml-2 flex-shrink-0">${Utils.formatarMoeda(item.valor)}</span>
                        </div>
                        <div class="text-xs text-slate-400 flex flex-wrap gap-x-3">
                            <span>üìÖ ${dataFormatada}</span>
                            <span>üìç ${Utils.formatarDistancia(item.km)}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-0.5 truncate">${item.local || 'Local n√£o informado'}</p>
                        ${infoPagamento}
                    </div>
                    <button data-id="${item.id}" class="btn-remover-historico text-slate-500 hover:text-red-500 p-2 transition duration-200" title="Excluir Registro">
                        &times;
                    </button>
                `;
                listaHistorico.appendChild(li);
            });
        },
    
        // --- ADICIONE ESTA NOVA FUN√á√ÉO (PILAR 3) ---
        renderCotaServicos: () => {
            const cotacoes = AppState.cotaManutencao;
            const listaCota = UIElements.listaCota;
            
            listaCota.innerHTML = '';
            UIElements.cotaCountSpan.textContent = cotacoes.length;

            if (cotacoes.length === 0) {
                listaCota.innerHTML = `<li class="text-center text-slate-400 italic">Nenhuma cota√ß√£o salva.</li>`;
                return;
            }

            cotacoes.sort((a, b) => (a.valor || 0) - (b.valor || 0)); // Mais baratas primeiro

            cotacoes.forEach(item => {
                const validadeStr = item.validade 
                    ? `<span class="text-xs text-slate-400 block">V√°lido at√©: ${Utils.formatarDataParaDisplay(new Date(item.validade + "T12:00:00"))}</span>` 
                    : '';

                const li = document.createElement('li');
                li.className = 'p-3 bg-slate-700 rounded-lg shadow flex justify-between items-center transition hover:bg-slate-600';
                li.innerHTML = `
                    <div class="flex-grow min-w-0 pr-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-white truncate">${item.servico}</span>
                            <span class="font-bold text-lg text-cyan-300 ml-2">${Utils.formatarMoeda(item.valor)}</span>
                        </div>
                        <p class="text-sm text-slate-400">Local: ${item.local || 'N/A'}</p>
                        ${validadeStr}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                         <button data-id="${item.id}" class="btn-aprovar-cota bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 rounded-lg transition">
                            Aprovar
                         </button>
                         <button data-id="${item.id}" class="btn-remover-cota text-red-500 hover:text-red-400 text-lg p-1 transition duration-200">
                            &times;
                         </button>
                    </div>
                `;
                listaCota.appendChild(li);
            });
        },
        
        // --- ADICIONE ESTA NOVA FUN√á√ÉO (PILAR 4) ---
        renderGamDashboard: () => {
            // Destr√≥i o gr√°fico anterior, se existir
            if (AppState.graficos.gamDashboard) {
                AppState.graficos.gamDashboard.destroy();
            }
            
            // 1. Obter os dados calculados
            const resumo = BusinessLogic.calcularResumoGAM();
            const { custosPorCategoria, totalGasto, primeiroKm, ultimoKm } = resumo;
            
            const labels = Object.keys(custosPorCategoria);
            const data = Object.values(custosPorCategoria);

            // 2. Renderizar o Gr√°fico de Pizza
            const chartCanvas = UIElements.gamDashboardChart;
            if (labels.length > 0) {
                chartCanvas.style.display = 'block';
                AppState.graficos.gamDashboard = new Chart(chartCanvas, {
                    type: 'doughnut', // Gr√°fico de Pizza (Rosca)
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Custo Total',
                            data: data,
                            // Cores baseadas na sua ideia original
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.7)', // Azul (Motor)
                                'rgba(34, 197, 94, 0.7)',  // Verde (Freios)
                                'rgba(249, 115, 22, 0.7)', // Laranja (Suspens√£o)
                                'rgba(239, 68, 68, 0.7)',  // Vermelho (Pneus)
                                'rgba(139, 92, 246, 0.7)', // Roxo (El√©trico)
                                'rgba(234, 179, 8, 0.7)',  // Amarelo (Ar-cond.)
                                'rgba(161, 98, 7, 0.7)',   // Marrom (Arref.)
                                'rgba(100, 116, 139, 0.7)' // Cinza (Revis√£o/Outro)
                            ],
                            borderColor: '#1e293b', // Cor de fundo
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { position: 'top', labels: { color: '#cbd5e1' } } 
                        }
                    }
                });
            } else {
                chartCanvas.style.display = 'none';
            }

            // 3. Renderizar Tabela de Resumo
            const summaryContainer = UIElements.gamDashboardSummary;
            summaryContainer.innerHTML = '<h4 class="text-lg font-semibold text-slate-300 text-center">Resumo de Custos (Tabela)</h4>';
            
            if (labels.length > 0) {
                let tableHTML = `<ul class="space-y-2 mt-3">`;
                const sortedCategorias = labels.sort((a, b) => custosPorCategoria[b] - custosPorCategoria[a]);
                
                sortedCategorias.forEach(cat => {
                    const valor = custosPorCategoria[cat];
                    const percentual = totalGasto > 0 ? (valor / totalGasto) * 100 : 0;
                    tableHTML += `
                        <li class="p-2 bg-slate-800 rounded-md flex justify-between items-center text-sm">
                            <span class="font-medium text-white">${cat}</span>
                            <div>
                                <span class="font-bold text-amber-300">${Utils.formatarMoeda(valor)}</span>
                                <span class="text-xs text-slate-400 w-16 text-right inline-block">(${percentual.toFixed(1)}%)</span>
                            </div>
                        </li>`;
                });
                tableHTML += `
                    <li class="p-2 bg-slate-700 rounded-md flex justify-between items-center text-base mt-4">
                        <span class="font-bold text-white">CUSTO TOTAL</span>
                        <span class="font-bold text-amber-300">${Utils.formatarMoeda(totalGasto)}</span>
                    </li>
                </ul>`;
                summaryContainer.innerHTML += tableHTML;
            } else {
                summaryContainer.innerHTML += `<p class="text-center text-slate-400 italic">Nenhum custo de manuten√ß√£o registrado no hist√≥rico.</p>`;
            }

            // 4. Renderizar KPIs (Custo/KM) 
            const kpiContainer = UIElements.gamDashboardKpi;
            kpiContainer.innerHTML = '';
            const kmRodados = ultimoKm - primeiroKm;
            
            if (totalGasto > 0 && kmRodados > 0) {
                const custoPorKm = totalGasto / kmRodados;
                kpiContainer.innerHTML = `
                    <h4 class="text-lg font-semibold text-slate-300 text-center">Indicador Chave (KPI)</h4>
                    <p class="text-slate-400">Custo Real de Manuten√ß√£o / KM</p>
                    <p class="font-bold text-3xl text-cyan-400">${Utils.formatarMoedaPorKm(custoPorKm)}</p>
                    <p class="text-xs text-slate-500">(${Utils.formatarMoeda(totalGasto)} gastos ao longo de ${Utils.formatarDistancia(kmRodados)})</p>
                `;
            } else if (totalGasto > 0) {
                 kpiContainer.innerHTML = `<p class="text-center text-slate-400 italic">Registre servi√ßos com KMs diferentes para calcular o Custo/KM.</p>`;
            }
        },
renderContasBancarias: () => {
    // =================================================================
    // üõ°Ô∏è 1. VACINA: RESET DE ESTADO (UI CLEANUP)
    // =================================================================
    if (typeof contaEmEdicaoId !== 'undefined') contaEmEdicaoId = null;
    
    // Reset Visual dos Bot√µes
    const uiBtns = {
        add: document.getElementById('btnAdicionarConta'),
        salvar: document.getElementById('btnSalvarEdicaoConta'),
        cancelar: document.getElementById('btnCancelarEdicaoConta')
    };
    if (uiBtns.add) uiBtns.add.classList.remove('hidden');
    if (uiBtns.salvar) uiBtns.salvar.classList.add('hidden');
    if (uiBtns.cancelar) uiBtns.cancelar.classList.add('hidden');

    // Limpa Inputs
    ['nomeContaInput', 'tipoContaSelect', 'saldoInicialInput', 'limiteContaInput', 'diaVencimentoInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    // =================================================================
    // üöÄ 2. PREPARA√á√ÉO DE DADOS
    // =================================================================
    const { contasBancarias } = AppState.configuracoes;
    const listaContas = UIElements.finListaContas;
    const saldoConsolidadoEl = UIElements.finSaldoConsolidado;
    
    if (!listaContas) return; 

    listaContas.innerHTML = '';
    let saldoConsolidadoTotal = 0; // Representa LIQUIDEZ (Dinheiro Dispon√≠vel)

    const iconMap = {
        default: 'üè¶', nubank: 'üü£', inter: 'üü†', itau: 'üüß', bradesco: 'üü•',
        santander: '‚ô®Ô∏è', bb: 'üü°', caixa: 'üîµ', sicoob: 'üü¢', xp: '‚ö´',
        c6: '‚ö´', invest: 'üìà', carteira: 'üíµ', credito: 'üí≥', picpay: 'üü¢', mercado: 'ü§ù'
    };

    // =================================================================
    // üíµ 3. RENDERIZA A CARTEIRA (CAIXA F√çSICO)
    // =================================================================
    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
    saldoConsolidadoTotal += saldoCarteira;
    
    const liCarteira = document.createElement('li');
    liCarteira.className = 'flex justify-between items-center bg-slate-700/80 p-3 rounded-md text-sm border-l-4 border-emerald-500 mb-2 shadow-sm';
    liCarteira.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl bg-slate-800 w-10 h-10 flex items-center justify-center rounded-full shadow-inner">üíµ</span>
            <div>
                <span class="font-bold text-white text-base">Carteira</span>
                <span class="text-[10px] text-slate-400 block uppercase tracking-wide">Dinheiro F√≠sico</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="font-bold text-lg ${saldoCarteira >= 0 ? 'text-emerald-400' : 'text-red-400'}">${Utils.formatarMoeda(saldoCarteira)}</span>
            <div class="flex gap-1">
                <button data-id="AUTO_ID_CARTEIRA" class="btn-abrir-transferencia text-indigo-400 hover:text-white hover:bg-indigo-600 transition text-[10px] font-bold border border-indigo-500/30 px-2 py-1 rounded">TRANSF.</button>
                <button data-id="AUTO_ID_CARTEIRA" class="btn-ver-extrato-conta text-cyan-400 hover:text-white hover:bg-cyan-600 transition text-[10px] font-bold border border-cyan-500/30 px-2 py-1 rounded">EXTRATO</button>
            </div>
        </div>
    `;
    listaContas.appendChild(liCarteira);

    // =================================================================
    // üè¶ 4. RENDERIZA BANCOS E CART√ïES
    // =================================================================
    if (!contasBancarias || contasBancarias.length === 0) {
        listaContas.innerHTML += `<li class="text-center text-slate-500 italic text-xs py-4">Nenhuma conta banc√°ria cadastrada.</li>`;
    } else {
        // Ordena: Contas Correntes primeiro, Cart√µes depois
        const contasOrdenadas = [...contasBancarias].sort((a, b) => (a.tipo === 'credito') - (b.tipo === 'credito'));

        contasOrdenadas.forEach(conta => {
            // Ignora duplicidade da carteira se ela estiver salva no array errado
            if (conta.id === 'AUTO_ID_CARTEIRA' || conta.tipo === 'carteira') return;

            // C√ÅLCULO PELO MOTOR V36.0 (Saldo ou Fatura)
            const saldoReal = BusinessLogic.calcularSaldoConta(conta.id);
            
            let iconeHTML = '';
            let infoSaldoHTML = '';
            
            // Tratamento de √çcone
            const iconeKey = (conta.icone || 'default').toLowerCase();
            if (iconeKey.includes('http') || iconeKey.includes('data:image')) {
                iconeHTML = `<img src="${conta.icone}" alt="icon" class="w-10 h-10 rounded-full object-cover border border-slate-600 shadow-sm">`;
            } else {
                const emoji = iconMap[iconeKey] || (conta.tipo === 'credito' ? 'üí≥' : 'üè¶');
                iconeHTML = `<span class="text-2xl w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full shadow-inner">${emoji}</span>`;
            }

            // L√≥gica de Exibi√ß√£o (Cr√©dito vs D√©bito)
            if (conta.tipo === 'credito') {
                // Para cart√£o: saldoReal = Valor da Fatura Aberta (Positivo = D√≠vida)
                const limite = parseFloat(conta.limite || 0);
                const faturaAtual = saldoReal; 
                const disponivel = limite - faturaAtual;
                
                // Visualiza√ß√£o de Cores
                const corDisp = disponivel < 0 ? 'text-red-400' : 'text-emerald-400';
                const percent = limite > 0 ? (faturaAtual / limite) * 100 : 0;
                
                infoSaldoHTML = `
                    <div class="text-right flex flex-col items-end">
                        <span class="font-bold text-base ${corDisp} leading-none">${Utils.formatarMoeda(disponivel)}</span>
                        <span class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mb-0.5">Limite Disp.</span>
                        
                        <div class="flex items-center gap-1 bg-slate-900/50 px-1.5 py-0.5 rounded border border-slate-700">
                             <span class="text-[9px] text-slate-400">Fatura:</span>
                             <span class="text-[10px] ${faturaAtual > 0 ? 'text-rose-400' : 'text-slate-300'} font-bold">${Utils.formatarMoeda(faturaAtual)}</span>
                        </div>
                    </div>
                `;
            } else {
                // Para Conta Corrente
                saldoConsolidadoTotal += saldoReal;
                const corSaldo = saldoReal >= 0 ? 'text-white' : 'text-red-400';
                
                infoSaldoHTML = `
                     <div class="text-right">
                        <span class="font-bold text-lg ${corSaldo}">${Utils.formatarMoeda(saldoReal)}</span>
                        <span class="text-[9px] text-slate-500 block uppercase tracking-wider">Saldo Atual</span>
                     </div>
                `;
            }

            // Renderiza o Item
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-slate-700/40 hover:bg-slate-700/60 transition p-2.5 rounded-md mb-2 border border-slate-700/50';
            
            // Bot√£o de Transferir (Escondido para Cr√©dito)
            const btnTransferir = conta.tipo !== 'credito' 
                ? `<button data-id="${conta.id}" title="Transferir" class="btn-abrir-transferencia text-slate-400 hover:text-indigo-400 p-1.5 hover:bg-slate-600 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg></button>` 
                : '';

            li.innerHTML = `
                <div class="flex items-center gap-3">
                    ${iconeHTML}
                    <div>
                        <span class="font-bold text-slate-200 text-sm block">${conta.nome}</span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wide bg-slate-800/50 px-1.5 py-0.5 rounded">
                            ${conta.tipo === 'credito' ? `Vence dia ${conta.diaVencimento || '??'}` : 'Conta Corrente'}
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    ${infoSaldoHTML}
                    <div class="flex items-center border-l border-slate-600 pl-2 gap-1">
                        ${btnTransferir}
                        <button data-id="${conta.id}" title="Extrato" class="btn-ver-extrato-conta text-slate-400 hover:text-cyan-400 p-1.5 hover:bg-slate-600 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        </button>
                        <button data-id="${conta.id}" title="Editar" class="btn-editar-conta text-slate-400 hover:text-amber-400 p-1.5 hover:bg-slate-600 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            listaContas.appendChild(li);
        });
    }

    // 5. ATUALIZA SALDO CONSOLIDADO (TOPO)
    if (saldoConsolidadoEl) {
        saldoConsolidadoEl.textContent = Utils.formatarMoeda(saldoConsolidadoTotal);
        // B√¥nus visual: Se o saldo total for negativo, fica vermelho
        if (saldoConsolidadoTotal < 0) {
            saldoConsolidadoEl.classList.remove('text-emerald-400', 'text-white');
            saldoConsolidadoEl.classList.add('text-red-400');
        } else {
            saldoConsolidadoEl.classList.remove('text-red-400');
            saldoConsolidadoEl.classList.add('text-emerald-400');
        }
    }
},

/* 
renderContasBancarias: () => {
    // üõ°Ô∏è VACINA: RESET DE ESTADO (BLINDAGEM)
    // Garante que ao desenhar a lista, o formul√°rio volte para "Adicionar"
    if (typeof contaEmEdicaoId !== 'undefined') {
        contaEmEdicaoId = null;
    }
    
    // Reset Visual dos Bot√µes
    const btnAdd = document.getElementById('btnAdicionarConta');
    const btnSalvar = document.getElementById('btnSalvarEdicaoConta'); // Se existir no seu HTML
    const btnCancelar = document.getElementById('btnCancelarEdicaoConta'); // Se existir no seu HTML

    if (btnAdd) btnAdd.classList.remove('hidden');
    if (btnSalvar) btnSalvar.classList.add('hidden');
    if (btnCancelar) btnCancelar.classList.add('hidden');

    // Limpa os inputs tamb√©m para n√£o sobrar lixo visual
    const inputs = ['nomeContaInput', 'tipoContaSelect', 'saldoInicialInput', 'limiteContaInput', 'diaVencimentoInput'];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });

    
    
    
    
            const { contasBancarias } = AppState.configuracoes;
            const listaContas = UIElements.finListaContas;
            const saldoConsolidadoEl = UIElements.finSaldoConsolidado;
            
            if (!listaContas) return; 

            listaContas.innerHTML = '';
            let saldoConsolidadoTotal = 0;

            const iconMap = {
                default: 'üè¶', nubank: 'üü£', inter: 'üü†', itau: 'üüß', bradesco: 'üü•',
                santander: 'üü•', bb: 'üü°', caixa: 'üîµ', sicoob: 'üü¢', xp: '‚ö´',
                c6: '‚ö´', invest: 'üìà', carteira: 'üíµ', credito: 'üí≥'
            };

            // 1. RENDERIZA A CARTEIRA (DINHEIRO) - C√ÅLCULO DIN√ÇMICO V35.5
            const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
            saldoConsolidadoTotal += saldoCarteira;
            
            const liCarteira = document.createElement('li');
            liCarteira.className = 'flex justify-between items-center bg-slate-700/80 p-3 rounded-md text-sm border-l-4 border-green-500 mb-2';
            liCarteira.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üíµ</span>
                    <div>
                        <span class="font-bold text-white text-base">Carteira (Dinheiro)</span>
                        <span class="text-xs text-slate-400 block">Caixa F√≠sico</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-bold text-lg text-green-400">${Utils.formatarMoeda(saldoCarteira)}</span>
                    <div>
                        <button data-id="AUTO_ID_CARTEIRA" class="btn-abrir-transferencia text-indigo-400 hover:text-indigo-300 transition text-xs font-bold border border-indigo-500/30 px-2 py-1 rounded mr-1">Transferir</button>
                        <button data-id="AUTO_ID_CARTEIRA" class="btn-ver-extrato-conta text-cyan-400 hover:text-cyan-300 transition text-xs font-bold border border-cyan-500/30 px-2 py-1 rounded">Extrato</button>
                    </div>
                </div>
            `;
            listaContas.appendChild(liCarteira);

            // 2. RENDERIZA OS BANCOS E CART√ïES CADASTRADOS
            if (contasBancarias.length === 0) {
                listaContas.innerHTML += `<li class="text-center text-slate-500 italic text-sm py-2">Nenhuma conta banc√°ria extra.</li>`;
            } else {
                contasBancarias.forEach(conta => {
                    
                                    // üõ°Ô∏è BLINDAGEM: nunca renderizar ou somar a Carteira aqui
                    if (conta.id === 'AUTO_ID_CARTEIRA' || conta.tipo === 'carteira') {
                        console.warn('‚ö†Ô∏è Conta Carteira ignorada em contasBancarias:', conta);
                        return;
                    }
                    // C√ÅLCULO PELO MOTOR V35.5 (Fonte da Verdade)
                    const saldoReal = BusinessLogic.calcularSaldoConta(conta.id);
                    
                    let iconeHTML = '';
                    let saldoHTML = '';

                    // L√≥gica de √çcone (Resolve o erro do undefined)
                    const iconeValor = conta.icone || 'default';
                    if (iconeValor.startsWith('http') || iconeValor.startsWith('data:image')) {
                        iconeHTML = `<img src="${iconeValor}" alt="√çcone" class="w-8 h-8 rounded-full object-cover flex-shrink-0 border border-slate-600">`;
                    } else {
                        const emoji = iconMap[conta.tipo === 'credito' ? 'credito' : iconeValor] || 'üè¶';
                        iconeHTML = `<span class="text-2xl w-8 h-8 flex-shrink-0 flex items-center justify-center bg-slate-800 rounded-full">${emoji}</span>`;
                    }

                    // L√≥gica de Exibi√ß√£o de Saldo vs Limite
                    if (conta.tipo === 'credito') {
                        const limite = parseFloat(conta.limite || 0);
                        const divida = saldoReal; // No V35.5 saldoReal j√° √© o valor positivo da fatura
                        const disponivel = limite - divida;
                        
                        const corTexto = disponivel < 0 ? 'text-red-500' : 'text-amber-400';
                        
                        saldoHTML = `
                            <div class="text-right">
                                <span class="font-bold text-base ${corTexto} block">${Utils.formatarMoeda(disponivel)}</span>
                                <span class="text-[10px] text-slate-500 uppercase">Limite Disp.</span>
                                <div class="text-[9px] text-slate-400">Fatura: ${Utils.formatarMoeda(divida)}</div>
                            </div>
                        `;
                    } else {
                        saldoConsolidadoTotal += saldoReal;
                        saldoHTML = `<span class="font-bold text-lg text-white">${Utils.formatarMoeda(saldoReal)}</span>`;
                    }

                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm mb-2';
                    
                    const btnTransferir = conta.tipo !== 'credito' 
                        ? `<button data-id="${conta.id}" class="btn-abrir-transferencia text-indigo-400 hover:text-indigo-300 transition text-xs mr-2">Transferir</button>` 
                        : '';

                    li.innerHTML = `
                        <div class="flex items-center gap-2">
                            ${iconeHTML}
                            <div>
                                <span class="font-bold text-slate-200">${conta.nome}</span>
                                <span class="text-[10px] text-slate-500 block uppercase font-bold">${conta.tipo === 'credito' ? `Venc. dia ${conta.diaVencimento || 'N/A'}` : conta.tipo}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            ${saldoHTML}
                            <div>
                                ${btnTransferir}
                                <button data-id="${conta.id}" class="btn-ver-extrato-conta text-cyan-400 hover:text-cyan-300 transition text-xs mr-2">Extrato</button>
                                <button data-id="${conta.id}" class="btn-editar-conta text-slate-500 hover:text-white transition text-xs">‚úèÔ∏è</button>
                            </div>
                        </div>
                    `;
                    listaContas.appendChild(li);
                });
            }

            // Atualiza o Saldo Consolidado no topo da aba
            if (saldoConsolidadoEl) {
                saldoConsolidadoEl.textContent = Utils.formatarMoeda(saldoConsolidadoTotal);
            }
        },

 */

  // --- IN√çCIO: SUPER-PASSO D (NOVA FUN√á√ÉO RENDER DRE) ---
// --- RENDERIZA√á√ÉO DO DRE (ATUALIZADO PARA EMPR√âSTIMOS) ---
// =============================================================
// ATUALIZA√á√ÉO UI RENDERER - DRE GERENCIAL
// =============================================================

renderDRE: (dreData) => {
    const { dreTableBody } = UIElements;
    if (!dreTableBody) return;
    
    // Cores din√¢micas
    const corLucroOp = dreData.lucroOperacional >= 0 ? 'text-green-400' : 'text-red-400';
    const corCaixa = dreData.resultadoCaixa >= 0 ? 'text-cyan-400' : 'text-red-500';

    dreTableBody.innerHTML = `
        <tr class="border-b border-slate-700 bg-slate-800/50">
            <td class="py-2 font-medium text-slate-300">(+) Receita Bruta</td>
            <td class="py-2 text-right font-bold text-white">${Utils.formatarMoeda(dreData.receitaBruta)}</td>
        </tr>
        <tr class="border-b border-slate-700">
            <td class="py-1 pl-4 text-xs text-slate-400">(-) Custos Vari√°veis (Combust√≠vel/Taxas)</td>
            <td class="py-1 text-right text-xs text-red-300">(${Utils.formatarMoeda(dreData.custosVariaveis)})</td>
        </tr>
        <tr class="border-b border-slate-600">
            <td class="py-2 font-bold text-slate-200">(=) Margem de Contribui√ß√£o</td>
            <td class="py-2 text-right font-bold text-amber-300">${Utils.formatarMoeda(dreData.margemContribuicao)}</td>
        </tr>
        
        <tr class="border-b border-slate-700">
            <td class="py-1 pl-4 text-xs text-slate-400">(-) Custos Fixos & Manuten√ß√£o</td>
            <td class="py-1 text-right text-xs text-red-300">(${Utils.formatarMoeda(dreData.custosFixos + dreData.manutencao)})</td>
        </tr>
        <tr class="border-b border-slate-700">
            <td class="py-1 pl-4 text-xs text-slate-400">(-) Juros e Multas (Despesa Financeira)</td>
            <td class="py-1 text-right text-xs text-red-300">(${Utils.formatarMoeda(dreData.jurosMultas)})</td>
        </tr>
        <tr class="border-b border-slate-700 bg-red-900/10">
            <td class="py-1 pl-4 text-xs text-orange-300 italic">(-) Deprecia√ß√£o (Desgaste do Carro)</td>
            <td class="py-1 text-right text-xs text-orange-300">(${Utils.formatarMoeda(dreData.depreciacao)})</td>
        </tr>
        
        <tr class="border-b-2 border-slate-500 bg-slate-700/30">
            <td class="py-3 font-bold text-white text-sm">(=) LUCRO ECON√îMICO (Viabilidade)</td>
            <td class="py-3 text-right font-bold text-lg ${corLucroOp}">${Utils.formatarMoeda(dreData.lucroOperacional)}</td>
        </tr>
        
        <tr>
            <td colspan="2" class="pt-3 pb-1 text-[10px] text-center text-slate-500 uppercase tracking-widest">Ajustes de Caixa (Bolso)</td>
        </tr>
        <tr class="border-b border-slate-800">
            <td class="py-1 pl-4 text-xs text-green-300">(+) Estorno Deprecia√ß√£o (N√£o saiu $)</td>
            <td class="py-1 text-right text-xs text-green-300">${Utils.formatarMoeda(dreData.depreciacao)}</td>
        </tr>
        <tr class="border-b border-slate-800">
            <td class="py-1 pl-4 text-xs text-slate-400">(-) Pagamento D√≠vidas (Principal)</td>
            <td class="py-1 text-right text-xs text-red-300">(${Utils.formatarMoeda(dreData.amortizacaoDividas)})</td>
        </tr>
        <tr class="border-b border-slate-800">
            <td class="py-1 pl-4 text-xs text-slate-400">(-) Pr√≥-Labore (Seu Sal√°rio)</td>
            <td class="py-1 text-right text-xs text-cyan-300">(${Utils.formatarMoeda(dreData.proLabore)})</td>
        </tr>

        <tr class="border-t-2 border-cyan-500 bg-cyan-900/20">
            <td class="py-3 font-bold text-white text-sm">(=) RESULTADO DE CAIXA (Livre)</td>
            <td class="py-3 text-right font-bold text-xl ${corCaixa}">${Utils.formatarMoeda(dreData.resultadoCaixa)}</td>
        </tr>
    `;
},
      // --- FIM: SUPER-PASSO D ---

// =============================================================
// ATUALIZA√á√ÉO VISUAL: LIVRO CAIXA AGRUPADO (COM CHECKBOX 40%)
// =============================================================

renderLivroCaixa: (livroCaixaData) => {
    const isPF = AppState.configuracoes.perfilFiscal.tipo === 'pf'; // Verifica se √© PF

    // 1. Inserir Checkbox de Dedu√ß√£o 40% (Apenas para PF)
    if (isPF && UIElements.lcLucroTributavel) {
        // Procura se j√° existe o container do checkbox, se n√£o, cria
        let checkContainer = document.getElementById('container-check-deducao');
        
        if (!checkContainer) {
            // Insere antes do container de detalhes ou em um local apropriado no cabe√ßalho
            const headerContainer = UIElements.lcLucroTributavel.closest('.bg-slate-800') || UIElements.lcLucroTributavel.parentElement.parentElement;
            
            checkContainer = document.createElement('div');
            checkContainer.id = 'container-check-deducao';
            checkContainer.className = 'mt-3 mb-2 flex justify-end px-4';
            checkContainer.innerHTML = `
                <label class="flex items-center space-x-2 cursor-pointer bg-slate-700/50 px-3 py-1 rounded-md border border-slate-600 hover:bg-slate-700 transition">
                    <input type="checkbox" id="chk-deducao-40" class="form-checkbox h-4 w-4 text-purple-500 rounded border-gray-500 bg-slate-800 focus:ring-purple-500">
                    <span class="text-xs text-purple-200 font-medium">Usar Dedu√ß√£o Presumida (40%)</span>
                </label>
            `;
            
            // Insere ap√≥s o bloco de totais
            headerContainer.after(checkContainer);

            // Adiciona Event Listener
            const chk = checkContainer.querySelector('#chk-deducao-40');
            chk.addEventListener('change', (e) => {
                // Recalcula visualmente
                const usar40 = e.target.checked;
                const receita = livroCaixaData.receitas;
                const despesaReal = livroCaixaData.despesas;
                
                let despesaConsiderada = despesaReal;
                let lucroFinal = livroCaixaData.lucroTributavel;

                if (usar40) {
                    // Regra: 40% da receita √© isento/despesa presumida
                    // Lucro Tribut√°vel = 60% da Receita
                    despesaConsiderada = receita * 0.40;
                    lucroFinal = receita - despesaConsiderada;
                    
                    // Atualiza texto das despesas para indicar que √© presumido
                    if (UIElements.lcDespesas) {
                        UIElements.lcDespesas.textContent = `(${Utils.formatarMoeda(despesaConsiderada)})*`;
                        UIElements.lcDespesas.classList.add('text-purple-400');
                        UIElements.lcDespesas.classList.remove('text-red-400', 'text-slate-500');
                    }
                } else {
                    // Volta ao original (Real)
                    if (UIElements.lcDespesas) {
                        const corDespesa = despesaReal > 0 ? 'text-red-400' : 'text-slate-500';
                        UIElements.lcDespesas.textContent = `(${Utils.formatarMoeda(despesaReal)})`;
                        UIElements.lcDespesas.className = `py-2 text-right font-bold ${corDespesa}`;
                    }
                }

                // Atualiza o Valor do Lucro Tribut√°vel na UI
                if (UIElements.lcLucroTributavel) {
                    UIElements.lcLucroTributavel.textContent = Utils.formatarMoeda(lucroFinal);
                    
                    // Atualiza tamb√©m o card de resultado final l√° embaixo
                    const resultCard = document.querySelector('#livrocaixa-result-final');
                    if (resultCard) resultCard.textContent = Utils.formatarMoeda(lucroFinal);
                }
            });
        }
    }

    // 2. Atualiza o Cabe√ßalho Geral (Totais Iniciais - Padr√£o Real)
    if (UIElements.lcReceitaBruta && UIElements.lcDespesas && UIElements.lcLucroTributavel) {
        UIElements.lcReceitaBruta.textContent = Utils.formatarMoeda(livroCaixaData.receitas);
        
        // Reseta para o estado inicial (Real) caso tenha sido renderizado antes
        const chk = document.getElementById('chk-deducao-40');
        const usar40 = chk ? chk.checked : false;
        
        let despesaExibida = livroCaixaData.despesas;
        let lucroExibido = livroCaixaData.lucroTributavel;

        // Se o checkbox j√° existir e estiver marcado (num re-render), mant√©m a l√≥gica
        if (usar40) {
            despesaExibida = livroCaixaData.receitas * 0.40;
            lucroExibido = livroCaixaData.receitas - despesaExibida;
            
            UIElements.lcDespesas.textContent = `(${Utils.formatarMoeda(despesaExibida)})*`;
            UIElements.lcDespesas.classList.add('text-purple-400');
        } else {
            const corDespesa = livroCaixaData.despesas > 0 ? 'text-red-400' : 'text-slate-500';
            UIElements.lcDespesas.className = `py-2 text-right font-bold ${corDespesa}`;
            UIElements.lcDespesas.textContent = `(${Utils.formatarMoeda(livroCaixaData.despesas)})`;
        }
        
        UIElements.lcLucroTributavel.textContent = Utils.formatarMoeda(lucroExibido);
    }

    // 3. Renderiza o Detalhamento Agrupado (Mantido igual, apenas ajustando o container)
    const tabContent = document.getElementById('report-tab-content-livrocaixa');
    if (!tabContent) return;

    let containerDetalhes = document.getElementById('livrocaixa-detalhes-container');
    if (!containerDetalhes) {
        containerDetalhes = document.createElement('div');
        containerDetalhes.id = 'livrocaixa-detalhes-container';
        containerDetalhes.className = 'mt-4 border-t border-slate-700 pt-4 animate-fade-in grid grid-cols-1 sm:grid-cols-2 gap-4';
        tabContent.appendChild(containerDetalhes);
    }

    // --- L√ìGICA DE AGRUPAMENTO (SOMA POR CATEGORIA) ---
    const agrupado = {
        receita: {},
        despesa: {}
    };

    livroCaixaData.itens.forEach(item => {
        const tipo = item.tipoItem; // 'receita' ou 'despesa'
        const categoria = item.categoria || 'Outro';
        
        if (!agrupado[tipo][categoria]) {
            agrupado[tipo][categoria] = { total: 0, qtd: 0 };
        }
        
        agrupado[tipo][categoria].total += item.valor;
        agrupado[tipo][categoria].qtd++;
    });

    // Fun√ß√£o Auxiliar para Gerar HTML das Listas
    const gerarListaHtml = (titulo, dados, corValor) => {
        const chaves = Object.keys(dados);
        chaves.sort((a, b) => dados[b].total - dados[a].total);

        let listaHtml = `
            <div class="bg-slate-800/50 rounded-lg border border-slate-700 p-3">
                <h5 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-700 pb-1">${titulo}</h5>
                <ul class="space-y-2">
        `;

        if (chaves.length === 0) {
            listaHtml += `<li class="text-[10px] text-slate-500 italic">Nenhum registro.</li>`;
        } else {
            chaves.forEach(cat => {
                const item = dados[cat];
                listaHtml += `
                    <li class="flex justify-between items-center text-xs">
                        <div class="flex items-center gap-2">
                            <span class="bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded text-[10px] font-bold">${cat}</span>
                            <span class="text-slate-500 text-[10px]">(${item.qtd}x)</span>
                        </div>
                        <span class="font-mono font-bold ${corValor}">${Utils.formatarMoeda(item.total)}</span>
                    </li>
                `;
            });
        }
        listaHtml += `</ul></div>`;
        return listaHtml;
    };

    const htmlReceitas = gerarListaHtml('Receitas (Entradas)', agrupado.receita, 'text-green-400');
    const htmlDespesas = gerarListaHtml('Despesas Dedut√≠veis (Sa√≠das)', agrupado.despesa, 'text-red-400');

    containerDetalhes.innerHTML = htmlReceitas + htmlDespesas;
    
    // Adiciona o Resultado Final (que ser√° atualizado pelo JS do checkbox)
    // Calcula o valor inicial com base no checkbox (se j√° existir) ou padr√£o
    const chk = document.getElementById('chk-deducao-40');
    const valorInicial = (chk && chk.checked) 
        ? (livroCaixaData.receitas * 0.60) 
        : livroCaixaData.lucroTributavel;

    const resultadoHtml = `
        <div class="col-span-1 sm:col-span-2 mt-2 pt-2 border-t border-slate-700 text-center">
            <span class="text-xs text-slate-500 uppercase">Resultado L√≠quido do Per√≠odo</span>
            <div id="livrocaixa-result-final" class="text-2xl font-bold text-cyan-400">${Utils.formatarMoeda(valorInicial)}</div>
        </div>
    `;
    
    containerDetalhes.innerHTML += resultadoHtml;
},

renderSimuladorMEI: (meiData) => {
            // Verifica se os elementos da UI existem para evitar erros
            if (UIElements.meiFaturamentoBruto) {
                
                // 1. Preenche os valores b√°sicos
                UIElements.meiFaturamentoBruto.textContent = Utils.formatarMoeda(meiData.faturamentoBruto);
                UIElements.meiDespesas.textContent = `(${Utils.formatarMoeda(meiData.despesasComprovadas)})`;
                UIElements.meiLucroEvidenciado.textContent = Utils.formatarMoeda(meiData.lucroEvidenciado);
                UIElements.meiParcelaIsenta.textContent = Utils.formatarMoeda(meiData.parcelaIsenta);
                
                // Elemento do Rendimento Tribut√°vel (o mais importante)
                const tributavelEl = UIElements.meiRendimentoTributavel;
                tributavelEl.textContent = Utils.formatarMoeda(meiData.rendimentoTributavel);
                
                // --- L√ìGICA DE ALERTAS VISUAIS ---
                
                // Limite de Isen√ß√£o Mensal do IRPF (Base 2024/2025: ~R$ 2.259,20)
                // Se o rendimento tribut√°vel do m√™s passar disso, acende o alerta.
                // Nota: O c√°lculo exato do IR √© anual, mas esse alerta mensal ajuda a prevenir sustos.
                const limiteIsencaoMensalIR = 2259.20;
                
                // Limpa classes de cor anteriores
                tributavelEl.classList.remove('text-amber-400', 'text-red-400', 'text-green-400', 'font-extrabold');
                
                // Remove mensagens de alerta antigas se houver
                const alertaAntigo = tributavelEl.parentNode.querySelector('.alerta-irpf');
                if (alertaAntigo) alertaAntigo.remove();

                if (meiData.rendimentoTributavel > limiteIsencaoMensalIR) {
                    // CEN√ÅRIO 1: PERIGO (Acima da isen√ß√£o)
                    tributavelEl.classList.add('text-red-400', 'font-extrabold');
                    
                    // Adiciona um aviso visual logo abaixo do valor
                    const aviso = document.createElement('span');
                    aviso.className = "alerta-irpf text-xs block mt-1 text-red-300 font-bold animate-pulse";
                    aviso.innerHTML = "‚ö†Ô∏è Acima da faixa de isen√ß√£o do IRPF!";
                    tributavelEl.parentNode.appendChild(aviso);
                    
                } else if (meiData.rendimentoTributavel > 0) {
                    // CEN√ÅRIO 2: ATEN√á√ÉO (Tem rendimento, mas ainda isento)
                    tributavelEl.classList.add('text-amber-400');
                    
                } else {
                    // CEN√ÅRIO 3: TRANQUILO (Zerado ou coberto pela isen√ß√£o)
                    tributavelEl.classList.add('text-green-400');
                }
            }
        },
        // --- FIM: SUPER-PASSO F ---
        
        // --- IN√çCIO: SUPER-PASSO K (VERS√ÉO BLINDADA) ---
renderContasRecorrentes: () => {
    // 1. Verifica se temos dados
    const { contasRecorrentes } = AppState.configuracoes;
    
    // 2. Tenta pegar o elemento via UIElements OU busca direto pelo ID seguro
    const lista = UIElements.listaContasRecorrentes || document.getElementById('lista-contas-recorrentes-ul');
    
    // 3. SE N√ÉO ACHAR A LISTA, N√ÉO FAZ NADA (Evita erros no console)
    if (!lista) return;

    // 4. LIMPEZA SEGURA (Limpa s√≥ a UL, n√£o o container pai)
    lista.innerHTML = '';

    if (contasRecorrentes.length === 0) {
        lista.innerHTML = `<li class="text-center text-slate-500 italic text-sm py-2">Nenhuma conta cadastrada.</li>`;
        return;
    }

    // 5. RENDERIZA√á√ÉO
    contasRecorrentes.sort((a, b) => a.vencimento - b.vencimento);

    contasRecorrentes.forEach(conta => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm border border-slate-600/30';
        li.innerHTML = `
            <div>
                <span class="font-medium text-slate-200">${conta.descricao}</span>
                <span class="text-[10px] text-slate-400 block uppercase tracking-wide">${conta.categoria} ‚Ä¢ Dia ${conta.vencimento}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="font-bold text-amber-400">${Utils.formatarMoeda(conta.valor)}</span>
                <div class="flex gap-2">
                    <button onclick="BusinessLogic.editarConta('${conta.id}')" class="text-cyan-400 hover:text-cyan-300 transition" title="Editar">‚úèÔ∏è</button>
                    <button onclick="BusinessLogic.excluirConta('${conta.id}')" class="text-red-500 hover:text-red-400 transition" title="Excluir">üóëÔ∏è</button>
                </div>
            </div>
        `;
        lista.appendChild(li);
    });
},
      /*  
        // --- IN√çCIO: SUPER-PASSO K (NOVA FUN√á√ÉO) ---
renderContasRecorrentes: () => {
            const { contasRecorrentes } = AppState.configuracoes;
            const lista = UIElements.listaContasRecorrentes;
            if (!lista) return;

            lista.innerHTML = '';
            if (contasRecorrentes.length === 0) {
                lista.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhuma conta recorrente cadastrada.</li>`;
                return;
            }

            contasRecorrentes.sort((a, b) => a.vencimento - b.vencimento); // Ordena por dia

            contasRecorrentes.forEach(conta => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm';
                li.innerHTML = `
                    <div>
                        <span>${conta.descricao}</span>
                        <span class="text-xs text-slate-400 block">${conta.categoria} - Vence dia ${conta.vencimento}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold">${Utils.formatarMoeda(conta.valor)}</span>
                        <div>
                            <button data-id="${conta.id}" class="btn-editar-conta-recorrente text-cyan-400 hover:text-cyan-300 transition text-xs mr-2">Editar</button>
                            <button data-id="${conta.id}" class="btn-excluir-conta-recorrente text-red-500 hover:text-red-400 transition">&times;</button>
                        </div>
                    </div>
                `;
                lista.appendChild(li);
            });
        },
  */
  // --- FIM: SUPER-PASSO K ---
renderListaCustosFixos: () => {
            console.log(">>> Renderizando Lista Custos Fixos...");
            
            // Busca o elemento no DOM (pode ter sido recriado se a aba mudou)
            const lista = document.getElementById('listaCustosFixos');
            
            if (!lista) {
                console.warn(">>> Lista n√£o encontrada no DOM.");
                return;
            }

            const { custosFixos } = AppState.configuracoes;
            
            // Limpa visualmente
            lista.innerHTML = '';
            
            if (!custosFixos || custosFixos.length === 0) {
                lista.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum custo fixo adicionado.</li>`;
            } else {
                // Renderiza itens
                custosFixos.forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm mb-2';
                    
                    const categoriaInfo = custo.categoria 
                        ? `<span class="text-xs text-slate-400 block">${custo.categoria}${custo.subcategoria && custo.subcategoria !== 'N/A' ? ' ('+custo.subcategoria+')' : ''}</span>` 
                        : '';
                    
                    const vencimentoInfo = custo.vencimento ? `<span class="text-xs text-amber-400 ml-2">Dia ${custo.vencimento}</span>` : '';

                    li.innerHTML = `
                        <div>
                            <span>${custo.descricao} ${vencimentoInfo}</span>
                            ${categoriaInfo}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold">${Utils.formatarMoeda(custo.valor)}</span>
                            <div>
                                <button type="button" data-id="${custo.id}" class="btn-editar-custo-fixo text-cyan-400 hover:text-cyan-300 transition text-xs mr-2">Editar</button>
                                <button type="button" data-id="${custo.id}" class="btn-excluir-custo-fixo text-red-500 hover:text-red-400 transition">&times;</button>
                            </div>
                        </div>
                    `;
                    lista.appendChild(li); // Adiciona ao DOM
                });
            }
            console.log(">>> Lista atualizada com", custosFixos.length, "itens.");
        },
 

 // --- ADICIONE ESTA NOVA FUN√á√ÉO (PILAR 4 - HEALTH SCORE) ---
        renderSaudeVeiculo: () => {
            // 1. Obter o Od√¥metro Atual da aba Jornada
            const kmFinal = parseFloat(UIElements.kmFinalInput.value) || 0;
            const kmInicial = parseFloat(UIElements.kmInicialInput.value) || 0;
            const odometroAtual = kmFinal > kmInicial ? kmFinal : kmInicial;

            const warningEl = UIElements.gamHealthOdometerWarning;
            if (odometroAtual <= 0) {
                // Se n√£o tem KM, mostra aviso e esconde o resto
                if(warningEl) warningEl.classList.remove('hidden');
                UIElements.gamHealthScoreGauge.classList.add('hidden');
                UIElements.gamHealthItemsList.innerHTML = `<li class="text-center text-slate-400 italic">Insira o KM Inicial ou Final na aba "Jornada".</li>`;
                return;
            }
            if(warningEl) warningEl.classList.add('hidden');
            UIElements.gamHealthScoreGauge.classList.remove('hidden');

            // 2. Calcular os dados
            const { score, itens } = BusinessLogic.calcularSaudeVeiculo(odometroAtual);
            
            // 3. Renderizar o Gauge (Medidor)
            const gaugeContainer = UIElements.gamHealthScoreGauge;
            const textContainer = UIElements.gamHealthScoreText;
            
            // Remove o canvas antigo se existir
            const oldCanvas = gaugeContainer.querySelector('canvas');
            if (oldCanvas) oldCanvas.remove();
            
            const newCanvas = document.createElement('canvas');
            newCanvas.id = 'gamHealthScoreCanvas';
            gaugeContainer.appendChild(newCanvas);
            
            const scoreColor = score <= 50 ? '#ef4444' : (score <= 85 ? '#f97316' : '#22c55e');

            new Chart(newCanvas, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: [scoreColor, '#334155'], // Cor / Fundo
                        borderColor: ['#1e293b'],
                        borderWidth: 2,
                        circumference: 180, // Meia-lua
                        rotation: -90, // Come√ßa de baixo
                    }]
                },
                options: {
                    responsive: true,
                    aspectRatio: 1,
                    cutout: '80%',
                    plugins: { tooltip: { enabled: false }, legend: { enabled: false } },
                    animation: { animateRotate: false }
                }
            });

            // 3.1 Renderizar o Texto do Gauge
            textContainer.innerHTML = `
                <span class="text-2xl font-bold" style="color: ${scoreColor};">${score}</span>
                <span class="text-lg font-semibold text-slate-400 -mt-2">Sa√∫de</span>
            `;

            // 4. Renderizar a Lista de Itens
            const listaEl = UIElements.gamHealthItemsList;
            listaEl.innerHTML = '';
            if (itens.length === 0) {
                listaEl.innerHTML = `<li class="text-center text-slate-400 italic">Nenhum item cadastrado no Plano Mestre.</li>`;
                return;
            }

            itens.forEach(item => {
                let progresso = Math.min(100, item.urgencia * 100);
                let corProgresso = '#22c55e'; // Verde
                if (item.status === 'Vencido') {
                    corProgresso = '#ef4444'; // Vermelho
                } else if (item.status === 'Aten√ß√£o') {
                    corProgresso = '#f97316'; // Laranja
                }

                let statusTexto = '';
                if (item.status === 'Vencido') {
                    if (item.kmRestante < 0) {
                        statusTexto = `<span class="font-bold" style="color:${corProgresso};">Vencido (KM)</span>`;
                    } else {
                        statusTexto = `<span class="font-bold" style="color:${corProgresso};">Vencido (Data)</span>`;
                    }
                } else {
                    const kmFaltam = (item.kmRestante !== Infinity) ? `${Utils.formatarDistancia(item.kmRestante)}` : '';
                    const diasFaltam = (item.diasRestantes !== Infinity) ? `${Math.round(item.diasRestantes)} dias` : '';
                    
                    statusTexto = (kmFaltam && diasFaltam) 
                                ? `${kmFaltam} / ${diasFaltam}`
                                : (kmFaltam || diasFaltam || 'OK');
                }

                const li = document.createElement('li');
                li.className = 'p-3 bg-slate-800 rounded-lg shadow space-y-2';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-white">${item.categoria} - ${item.descricao}</span>
                        <span class="text-sm text-slate-300 flex-shrink-0 ml-2">${statusTexto}</span>
                    </div>
                    <div class="w-full h-3 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-500" style="width: ${progresso}%; background-color: ${corProgresso};"></div>
                    </div>
                `;
                listaEl.appendChild(li);
            });
        },
      
// =================================================================
// RENDER METAS FINANCEIRAS V191 (FIX: TEXTO OBRIGAT√ìRIO RESTAURADO)
// =================================================================
renderMetasFinanceiras: () => {
    // 1. Atualiza√ß√£o de Progresso
    if (BusinessLogic && BusinessLogic.atualizarProgressoFinanciamentos) {
        BusinessLogic.atualizarProgressoFinanciamentos();
    }

    const UI = UIElements || {};

    // --- HELPER: MAESTRO DE VISIBILIDADE DO FORMUL√ÅRIO ---
    const atualizarVisibilidadeForm = () => {
        const { 
            metaTipoSelect, metaJurosCheckbox, metaTipoDividaSelect,
            containerValorTotal, containerValorObjetivo, containerDataVencimento, 
            containerPrazoMeses, containerPoupanca, containerPoupancaKm, 
            containerFinanciamento, containerJurosCheckbox, containerTipoDivida, 
            containerConsorcio, metaContribuicaoMensalInput, metaValorObjetivoInput
        } = UI;

        const safeToggle = (el, show) => { if(el && el.classList) el.classList.toggle('hidden', !show); };
        const safeLabel = (el, txt) => { if(el) { const l = el.querySelector('label'); if(l) l.textContent = txt; } };
        
        const tipo = metaTipoSelect ? metaTipoSelect.value : 'poupanca';
        const usaJuros = metaJurosCheckbox ? metaJurosCheckbox.checked : false;
        const tipoDivida = metaTipoDividaSelect ? metaTipoDividaSelect.value : '';

        [containerDataVencimento, containerValorObjetivo, containerPrazoMeses, 
         containerPoupanca, containerPoupancaKm, containerFinanciamento, 
         containerJurosCheckbox, containerTipoDivida, containerConsorcio].forEach(el => safeToggle(el, false));

        if (tipo === 'poupanca') {
            safeToggle(containerValorObjetivo, true);
            safeToggle(containerPrazoMeses, true);
            safeToggle(containerPoupanca, true);
            safeLabel(containerValorTotal, 'Valor Inicial (R$)');
            
            if (metaValorObjetivoInput && metaContribuicaoMensalInput) {
                metaValorObjetivoInput.readOnly = false;
                metaContribuicaoMensalInput.readOnly = false;
            }

        } else if (tipo === 'parcelamento') { 
            safeToggle(containerDataVencimento, true);
            safeToggle(containerJurosCheckbox, true);
            safeLabel(containerValorTotal, 'Valor Total / Saldo Devedor (R$)');

            if (usaJuros) {
                safeToggle(containerTipoDivida, true);
                if (tipoDivida === 'financiamento' || tipoDivida === 'emprestimo') safeToggle(containerFinanciamento, true);
                else if (tipoDivida === 'consorcio') safeToggle(containerConsorcio, true);
            }

        } else if (tipo === 'poupanca_km') { 
            safeToggle(containerPoupancaKm, true);
            safeLabel(containerValorTotal, 'Valor Inicial (R$)');
        }
    };

    // --- RENDERIZA√á√ÉO DAS LISTAS (C√≥digo Otimizado V190 Mantido) ---
    const { 
        listaMetasAtivas, listaMetasConcluidas, listaMetasManutencaoPlano, 
        listaMetasManutencaoKm, listaMetasManutencaoConcluidas,
        metaBancoVinculado, btnAdicionarMeta, btnSalvarEdicaoMeta, btnCancelarEdicaoMeta 
    } = UI;

    const { metasFinanceiras, planoManutencao, contasBancarias } = AppState.configuracoes;

    // Dropdown Bancos
    if (metaBancoVinculado && contasBancarias) {
        const contasValidas = contasBancarias.filter(c => c.id !== 'AUTO_ID_CARTEIRA');
        if (metaBancoVinculado.options.length <= 1) {
             contasValidas.forEach(conta => {
                metaBancoVinculado.innerHTML += `<option value="${conta.id}">${conta.nome}</option>`;
            });
        }
    }

    // Limpeza
    [listaMetasAtivas, listaMetasConcluidas, listaMetasManutencaoPlano, 
     listaMetasManutencaoKm, listaMetasManutencaoConcluidas].forEach(el => {
        if (el) el.innerHTML = '';
    });

    // Carteira Monitor
    if (listaMetasAtivas) {
        const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
        const liCarteira = UIRenderer.criarItemListaMeta({
            id: 'AUTO_ID_CARTEIRA', descricao: 'üíµ Carteira (Dinheiro em M√£os)',
            tipo: 'monitor_conta', valorAtual: saldoCarteira, valorTotal: 0, 
            corPersonalizada: saldoCarteira >= 0 ? 'border-emerald-500' : 'border-red-500', isMonitor: true 
        }, true);
        liCarteira.classList.add('mb-4', 'shadow-lg');
        listaMetasAtivas.appendChild(liCarteira);
    }

    // Distribui√ß√£o
    const idsMetasPlanoMestre = new Set((planoManutencao || []).map(item => item.metaId).filter(Boolean));
    const listas = { ativas: [], concluidas: [], manutencaoPlano: [], manutencaoKm: [], manutencaoConcluidas: [] };

    if (metasFinanceiras) {
        metasFinanceiras.forEach(meta => {
            if (meta.id === 'AUTO_ID_CARTEIRA') return;
            if (meta.descricao && meta.descricao.toLowerCase().includes('caixa di√°rio')) return;

            let valorCalculado = meta.valorAtual || 0;
            if (meta.tipo !== 'parcelamento' || !meta.financiamento) {
                valorCalculado = BusinessLogic.calcularSaldoConta(meta.id);
            }
            meta.valorAtual = valorCalculado;

            let isConcluida = false;
            if (!String(meta.id).startsWith('FATURA_')) {
                isConcluida = (meta.valorTotal > 0 && valorCalculado >= meta.valorTotal);
            }

            if (isConcluida) {
                if (meta.tipo === 'poupanca_km' || (meta.tipo === 'poupanca' && idsMetasPlanoMestre.has(meta.id))) 
                    listas.manutencaoConcluidas.push(meta); 
                else listas.concluidas.push(meta);
            } else {
                if (meta.tipo === 'poupanca_km') listas.manutencaoKm.push(meta); 
                else if (meta.tipo === 'poupanca' && idsMetasPlanoMestre.has(meta.id)) listas.manutencaoPlano.push(meta); 
                else listas.ativas.push(meta);
            }
        });
    }

    const appendToList = (el, arr, active) => {
        if (!el) return;
        if (arr.length > 0) arr.forEach(m => el.appendChild(UIRenderer.criarItemListaMeta(m, active)));
        else if (el !== listaMetasAtivas) el.innerHTML = `<li class="text-center text-slate-500 italic text-sm py-2">Nenhuma meta aqui.</li>`;
    };

    appendToList(listaMetasAtivas, listas.ativas, true);
    appendToList(listaMetasManutencaoPlano, listas.manutencaoPlano, true);
    appendToList(listaMetasManutencaoKm, listas.manutencaoKm, true);
    appendToList(listaMetasConcluidas, listas.concluidas, false);
    appendToList(listaMetasManutencaoConcluidas, listas.manutencaoConcluidas, false);

    // Controle de Bot√µes
    const emEdicao = (typeof metaEmEdicaoId !== 'undefined') ? metaEmEdicaoId : null;
    if(btnAdicionarMeta) btnAdicionarMeta.classList.toggle('hidden', emEdicao !== null);
    if(btnSalvarEdicaoMeta) btnSalvarEdicaoMeta.classList.toggle('hidden', emEdicao === null);
    if(btnCancelarEdicaoMeta) btnCancelarEdicaoMeta.classList.toggle('hidden', emEdicao === null);

    // --- üö® A RESTAURA√á√ÉO DO TEXTO EXPLICATIVO (V191) üö® ---
    const containerIncluir = document.getElementById('containerIncluirCustoDiario');
    if (containerIncluir) {
        const label = containerIncluir.querySelector('label');
        if (label) {
            // Insere o HTML com o √≠cone de cadeado e a explica√ß√£o
            label.innerHTML = '<b>üîí Tornar Custo Obrigat√≥rio</b> <span class="text-xs font-normal text-slate-400 block">(Se marcado, aparecer√° bloqueado e ativo nas Configura√ß√µes)</span>';
        }
    }

    // Executa o Maestro
    atualizarVisibilidadeForm();
},

/*      
     // =================================================================
            // RENDER METAS FINANCEIRAS (V58 - CORRE√á√ÉO DE INJE√á√ÉO DE SALDO)
            // =================================================================
            renderMetasFinanceiras: () => {
                // 1. Tenta atualizar progresso se a l√≥gica existir
                if (BusinessLogic && BusinessLogic.atualizarProgressoFinanciamentos) {
                    BusinessLogic.atualizarProgressoFinanciamentos();
                }

                // 2. Garante que UIElements existe
                const UI = UIElements || {};
                
                // ... (Mantive suas fun√ß√µes auxiliares safeToggle, safeClass, etc. iguais) ...
                const safeToggle = (element, shouldShow) => { if (element && element.classList) { if (shouldShow) element.classList.remove('hidden'); else element.classList.add('hidden'); } };
                const safeClass = (element, className, add) => { if (element && element.classList) { if (add) element.classList.add(className); else element.classList.remove(className); } };
                const safeLabelText = (container, text) => { if (container) { const lbl = container.querySelector('label'); if (lbl) lbl.textContent = text; } };

                // 4. Extrai vari√°veis com seguran√ßa
                const { 
                    listaMetasAtivas, listaMetasConcluidas,
                    metaTipoSelect, metaBancoVinculado,
                    containerValorTotal, metaValorTotalInput, 
                    containerValorObjetivo, metaValorObjetivoInput, 
                    containerDataVencimento, containerPrazoMeses,
                    containerPoupanca, containerTaxaJuros, containerContribuicaoMensal,
                    metaPrazoMesesInput, metaTaxaJurosInput, metaContribuicaoMensalInput,
                    containerPoupancaKm,
                    listaMetasManutencaoPlano, 
                    listaMetasManutencaoKm, 
                    listaMetasManutencaoConcluidas,
                    containerJurosCheckbox, metaJurosCheckbox, containerTipoDivida, 
                    metaTipoDividaSelect, containerConsorcio
                } = UI;

                const { metasFinanceiras, planoManutencao, contasBancarias } = AppState.configuracoes;
                AppState.configuracoes.contasBancarias = contasBancarias.filter(c => c.id !== 'AUTO_ID_CARTEIRA' && c.tipo !== 'carteira');
                
                // ... (L√≥gica de Dropdown e Visibilidade mantida igual ao seu c√≥digo) ...
                // (Para economizar espa√ßo, assuma que o bloco 5, 6, 7 e 8 est√£o id√™nticos aqui)

                // 8. Limpeza de listas
                [listaMetasAtivas, listaMetasConcluidas, listaMetasManutencaoPlano, 
                 listaMetasManutencaoKm, listaMetasManutencaoConcluidas].forEach(el => {
                    if (el) el.innerHTML = '';
                });

                // 9. Carteira Monitor (Mantido igual)
                if (listaMetasAtivas) {
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    const metaCarteiraVisual = {
                        id: 'AUTO_ID_CARTEIRA', descricao: 'üíµ Carteira (Dinheiro em M√£os)',
                        tipo: 'monitor_conta', valorAtual: saldoCarteira, valorTotal: 0, 
                        custoDiario: 0, corPersonalizada: saldoCarteira >= 0 ? 'border-emerald-500' : 'border-red-500',
                        isMonitor: true 
                    };
                    const liCarteira = UIRenderer.criarItemListaMeta(metaCarteiraVisual, true);
                    liCarteira.classList.add('mb-4', 'shadow-lg', 'shadow-black/20');
                    const valEl = liCarteira.querySelector('.font-mono'); // Ajuste visual se necess√°rio
                    listaMetasAtivas.appendChild(liCarteira);
                }

                // 10. Distribui√ß√£o das Metas (AQUI EST√Å A CORRE√á√ÉO CR√çTICA)
                const idsMetasPlanoMestre = new Set((planoManutencao || []).map(item => item.metaId).filter(Boolean));
                const listas = { ativas: [], concluidas: [], manutencaoPlano: [], manutencaoKm: [], manutencaoConcluidas: [] };

                if (metasFinanceiras) {
                    metasFinanceiras.forEach(meta => {
                        if (meta.id === 'AUTO_ID_CARTEIRA') return; 
                        if (meta.descricao && meta.descricao.toLowerCase().includes('caixa di√°rio')) return;

                        // 1. CALCULA O VALOR FRESQUINHO USANDO A L√ìGICA V36.0
                        let valorCalculado = 0;
                        
                        if (meta.tipo === 'parcelamento' && meta.financiamento) {
                            valorCalculado = (meta.valorAtual || 0);
                        } else {
                            // Chama o BusinessLogic corrigido que sabe somar cart√£o
                            valorCalculado = BusinessLogic.calcularSaldoConta(meta.id);
                        }
                        
                        // 2. O PULO DO GATO: INJETA O VALOR NO OBJETO
                        // Isso garante que o criarItemListaMeta receba o valor certo!
                        meta.valorAtual = valorCalculado; 

                        const valorTotal = meta.valorTotal || 0;
                        
                        // L√≥gica de Conclus√£o
                        let isConcluida = false;
                        if (String(meta.id).startsWith('FATURA_')) {
                            // Fatura nunca "conclui" da maneira tradicional, ela zera.
                            // Se saldo for <= 0, est√° "em dia".
                            isConcluida = false; 
                        } else {
                            isConcluida = valorTotal > 0 && valorCalculado >= valorTotal;
                        }

                        if (isConcluida) {
                            if (meta.tipo === 'poupanca_km' || (meta.tipo === 'poupanca' && idsMetasPlanoMestre.has(meta.id))) 
                                listas.manutencaoConcluidas.push(meta); 
                            else listas.concluidas.push(meta);
                        } else {
                            if (meta.tipo === 'poupanca_km') listas.manutencaoKm.push(meta); 
                            else if (meta.tipo === 'poupanca' && idsMetasPlanoMestre.has(meta.id)) listas.manutencaoPlano.push(meta); 
                            else listas.ativas.push(meta);
                        }
                    });
                }

                // 11. Renderiza√ß√£o das Listas
                const renderHelper = (listaElement, metasArray, isAtiva) => {
                    if (!listaElement) return;
                    if (metasArray.length > 0) {
                        metasArray.forEach(meta => listaElement.appendChild(UIRenderer.criarItemListaMeta(meta, isAtiva)));
                    } else if (listaElement !== listaMetasAtivas) { 
                        listaElement.innerHTML = `<li class="text-center text-slate-500 italic text-sm py-2">Nenhuma meta aqui.</li>`;
                    }
                };

                renderHelper(listaMetasAtivas, listas.ativas, true);
                renderHelper(listaMetasManutencaoPlano, listas.manutencaoPlano, true);
                renderHelper(listaMetasManutencaoKm, listas.manutencaoKm, true);
                renderHelper(listaMetasConcluidas, listas.concluidas, false);
                renderHelper(listaMetasManutencaoConcluidas, listas.manutencaoConcluidas, false);
                
                // 12. Bot√µes de A√ß√£o
                const emEdicao = (typeof metaEmEdicaoId !== 'undefined') ? metaEmEdicaoId : null;
                safeToggle(UI.btnAdicionarMeta, emEdicao === null); 
                safeToggle(UI.btnSalvarEdicaoMeta, emEdicao !== null); 
                safeToggle(UI.btnCancelarEdicaoMeta, emEdicao !== null);
            },   
    */    
/*         
// =================================================================
        // RENDER METAS FINANCEIRAS (V57 BLINDADA - FINAL)
        // =================================================================
        renderMetasFinanceiras: () => {
            // 1. Tenta atualizar progresso se a l√≥gica existir
            if (BusinessLogic && BusinessLogic.atualizarProgressoFinanciamentos) {
                BusinessLogic.atualizarProgressoFinanciamentos();
            }

            // 2. Garante que UIElements existe
            const UI = UIElements || {};
            
            // 3. Fun√ß√µes Auxiliares de Seguran√ßa (O SEGREDO DA CORRE√á√ÉO)
            const safeToggle = (element, shouldShow) => {
                if (element && element.classList) {
                    if (shouldShow) element.classList.remove('hidden');
                    else element.classList.add('hidden');
                }
            };
            
            const safeClass = (element, className, add) => {
                if (element && element.classList) {
                    if (add) element.classList.add(className);
                    else element.classList.remove(className);
                }
            };

            const safeLabelText = (container, text) => {
                if (container) {
                    const lbl = container.querySelector('label');
                    if (lbl) lbl.textContent = text;
                }
            };

            // 4. Extrai vari√°veis com seguran√ßa
            const { 
                listaMetasAtivas, listaMetasConcluidas,
                metaTipoSelect, metaBancoVinculado,
                containerValorTotal, metaValorTotalInput, 
                containerValorObjetivo, metaValorObjetivoInput, 
                containerDataVencimento, containerPrazoMeses,
                containerPoupanca, containerTaxaJuros, containerContribuicaoMensal,
                metaPrazoMesesInput, metaTaxaJurosInput, metaContribuicaoMensalInput,
                containerPoupancaKm,
                listaMetasManutencaoPlano, 
                listaMetasManutencaoKm, 
                listaMetasManutencaoConcluidas,
                containerJurosCheckbox, metaJurosCheckbox, containerTipoDivida, 
                metaTipoDividaSelect, containerConsorcio
            } = UI;

            const { metasFinanceiras, planoManutencao, contasBancarias } = AppState.configuracoes;
            AppState.configuracoes.contasBancarias =
            contasBancarias.filter(c => c.id !== 'AUTO_ID_CARTEIRA' && c.tipo !== 'carteira');
            // 5. Dropdown Bancos
            if (metaBancoVinculado) {
                const valorSelecionado = metaBancoVinculado.value;
                metaBancoVinculado.innerHTML = '<option value="">Nenhuma (Caixinha Virtual)</option>';
                if (contasBancarias) {
                    contasBancarias.forEach(conta => {
                        metaBancoVinculado.innerHTML += `<option value="${conta.id}">${conta.nome}</option>`;
                    });
                }
                metaBancoVinculado.value = valorSelecionado;
            }

            // 6. Controle de Visibilidade dos Campos
            const tipo = metaTipoSelect ? metaTipoSelect.value : '';
            const containerFinanciamento = document.getElementById('containerFinanciamento');

            // Reseta tudo para escondido primeiro
            [containerDataVencimento, containerValorObjetivo, containerPrazoMeses, 
             containerPoupanca, containerPoupancaKm, containerFinanciamento, 
             containerJurosCheckbox, containerTipoDivida, containerConsorcio].forEach(el => safeToggle(el, false));

            // Aplica visibilidade baseada no tipo
            if (tipo === 'poupanca') {
                safeToggle(containerValorObjetivo, true);
                safeToggle(containerPrazoMeses, true);
                safeToggle(containerPoupanca, true);
                
                safeLabelText(containerValorTotal, 'Valor Inicial (R$)');
                
                // L√≥gica de Readonly (Blindada)
                if (metaValorObjetivoInput && metaContribuicaoMensalInput && metaPrazoMesesInput) {
                    const lastEdited = AppState.lastMetaFieldEdited;
                    const valContrib = Utils.parseMoeda(metaContribuicaoMensalInput.value);
                    const valPrazo = parseInt(metaPrazoMesesInput.value) || 0;
                    const valObjetivo = Utils.parseMoeda(metaValorObjetivoInput.value);

                    if (lastEdited === 'metaContribuicaoMensalInput' || lastEdited === 'metaPrazoMesesInput') {
                         metaValorObjetivoInput.readOnly = (valContrib > 0 && valPrazo > 0);
                         metaContribuicaoMensalInput.readOnly = false;
                    } else if (lastEdited === 'metaValorObjetivoInput' || lastEdited === 'metaPrazoMesesInput') {
                        metaContribuicaoMensalInput.readOnly = (valObjetivo > 0 && valPrazo > 0);
                        metaValorObjetivoInput.readOnly = false;
                    }
                    safeClass(metaContribuicaoMensalInput, 'bg-slate-600', metaContribuicaoMensalInput.readOnly);
                    safeClass(metaValorObjetivoInput, 'bg-slate-600', metaValorObjetivoInput.readOnly);
                }

            } else if (tipo === 'parcelamento') { 
                safeToggle(containerDataVencimento, true);
                safeToggle(containerJurosCheckbox, true);
                
                safeLabelText(containerValorTotal, 'Valor Total (R$)');

                if (metaJurosCheckbox && metaJurosCheckbox.checked) {
                    safeToggle(containerTipoDivida, true);
                    const tipoDivida = metaTipoDividaSelect ? metaTipoDividaSelect.value : '';
                    if (tipoDivida === 'financiamento' || tipoDivida === 'emprestimo') {
                        safeToggle(containerFinanciamento, true);
                    } else if (tipoDivida === 'consorcio') {
                        safeToggle(containerConsorcio, true);
                    }
                }
                
                if (metaContribuicaoMensalInput) { metaContribuicaoMensalInput.readOnly = false; safeClass(metaContribuicaoMensalInput, 'bg-slate-600', false); }
                if (metaValorObjetivoInput) { metaValorObjetivoInput.readOnly = false; safeClass(metaValorObjetivoInput, 'bg-slate-600', false); }

            } else if (tipo === 'poupanca_km') { 
                safeToggle(containerPoupancaKm, true);
                
                safeLabelText(containerValorTotal, 'Valor Inicial (R$)');

                if (metaContribuicaoMensalInput) { metaContribuicaoMensalInput.readOnly = false; safeClass(metaContribuicaoMensalInput, 'bg-slate-600', false); }
                if (metaValorObjetivoInput) { metaValorObjetivoInput.readOnly = false; safeClass(metaValorObjetivoInput, 'bg-slate-600', false); }
            }

            // 7. Texto do Container Opcional
            const containerIncluir = document.getElementById('containerIncluirCustoDiario');
            if (containerIncluir) {
                const label = containerIncluir.querySelector('label');
                if (label) label.innerHTML = '<b>üîí Tornar Custo Obrigat√≥rio</b> <span class="text-xs font-normal text-slate-400 block">(Se marcado, aparecer√° bloqueado e ativo nas Configura√ß√µes)</span>';
            }

            // 8. Limpeza de listas (Blindado)
            [listaMetasAtivas, listaMetasConcluidas, listaMetasManutencaoPlano, 
             listaMetasManutencaoKm, listaMetasManutencaoConcluidas].forEach(el => {
                if (el) el.innerHTML = '';
            });

            // 9. Carteira Monitor
            if (listaMetasAtivas) {
                const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                const metaCarteiraVisual = {
                    id: 'AUTO_ID_CARTEIRA', descricao: 'üíµ Carteira (Dinheiro em M√£os)',
                    tipo: 'monitor_conta', valorAtual: saldoCarteira, valorTotal: 0, 
                    custoDiario: 0, corPersonalizada: saldoCarteira >= 0 ? 'border-emerald-500' : 'border-red-500',
                    isMonitor: true 
                };
                
                const liCarteira = UIRenderer.criarItemListaMeta(metaCarteiraVisual, true);
                liCarteira.classList.add('mb-4', 'shadow-lg', 'shadow-black/20');
                const valEl = liCarteira.querySelector('.font-mono');
                if (valEl && saldoCarteira < 0) {
                    valEl.classList.add('text-red-400');
                    valEl.classList.remove('text-emerald-400');
                }
                listaMetasAtivas.appendChild(liCarteira);
            }

            // 10. Distribui√ß√£o das Metas
            const idsMetasPlanoMestre = new Set((planoManutencao || []).map(item => item.metaId).filter(Boolean));
            const listas = { ativas: [], concluidas: [], manutencaoPlano: [], manutencaoKm: [], manutencaoConcluidas: [] };

            if (metasFinanceiras) {
                metasFinanceiras.forEach(meta => {
                    if (meta.id === 'AUTO_ID_CARTEIRA') return; 
                    if (meta.descricao && meta.descricao.toLowerCase().includes('caixa di√°rio')) return;

                    let valorAtual = (meta.tipo === 'parcelamento' && meta.financiamento) 
                                     ? (meta.valorAtual || 0) 
                                     : BusinessLogic.calcularSaldoConta(meta.id);
                    
                    const valorTotal = meta.valorTotal || 0;
                    let isConcluida = valorTotal > 0 && valorAtual >= valorTotal;

                    if (isConcluida) {
                        if (meta.tipo === 'poupanca_km' || (meta.tipo === 'poupanca' && idsMetasPlanoMestre.has(meta.id))) 
                            listas.manutencaoConcluidas.push(meta); 
                        else listas.concluidas.push(meta);
                    } else {
                        if (meta.tipo === 'poupanca_km') listas.manutencaoKm.push(meta); 
                        else if (meta.tipo === 'poupanca' && idsMetasPlanoMestre.has(meta.id)) listas.manutencaoPlano.push(meta); 
                        else listas.ativas.push(meta);
                    }
                });
            }

            // 11. Renderiza√ß√£o das Listas (Blindado)
            const renderHelper = (listaElement, metasArray, isAtiva) => {
                if (!listaElement) return;
                if (metasArray.length > 0) {
                    metasArray.forEach(meta => listaElement.appendChild(UIRenderer.criarItemListaMeta(meta, isAtiva)));
                } else if (listaElement !== listaMetasAtivas) { 
                    listaElement.innerHTML = `<li class="text-center text-slate-500 italic text-sm py-2">Nenhuma meta aqui.</li>`;
                }
            };

            renderHelper(listaMetasAtivas, listas.ativas, true);
            renderHelper(listaMetasManutencaoPlano, listas.manutencaoPlano, true);
            renderHelper(listaMetasManutencaoKm, listas.manutencaoKm, true);
            renderHelper(listaMetasConcluidas, listas.concluidas, false);
            renderHelper(listaMetasManutencaoConcluidas, listas.manutencaoConcluidas, false);
            
            // 12. Bot√µes de A√ß√£o (Blindado e Toggle Seguro)
            const emEdicao = (typeof metaEmEdicaoId !== 'undefined') ? metaEmEdicaoId : null;
            // L”GICA CORRETA:
            // Se emEdicao È NULL (ninguÈm editando) -> MOSTRA o bot„o Adicionar
            safeToggle(UI.btnAdicionarMeta, emEdicao === null); 
            
            // Se emEdicao TEM VALOR (alguÈm editando) -> MOSTRA os botıes Salvar/Cancelar
            safeToggle(UI.btnSalvarEdicaoMeta, emEdicao !== null); 
            safeToggle(UI.btnCancelarEdicaoMeta, emEdicao !== null);
        },
  
      
    */
   
  // =================================================================
        // CRIAR ITEM LISTA META (CORRIGIDO: LEITURA DE SALDO DIRETA)
        // Substitui o c√°lculo din√¢mico (que lia ajustes) pela leitura do valorAtual salvo
        // =================================================================
        criarItemListaMeta: (meta, isAtiva) => {
            // üõ°Ô∏è BLINDAGEM DE SEGURAN√áA M√ÅXIMA (PATCH VITAL)
            // Impede que a Carteira seja desenhada como uma meta visual
         /*n   if (meta.id === 'AUTO_ID_CARTEIRA' || meta.tipo === 'carteira') {
                const elementoVazio = document.createElement('div');
                elementoVazio.style.display = 'none';
                return elementoVazio;
            }*/
            let detalhesHTML = '';
            
            // 1. C√°lculos B√°sicos (AQUI EST√Å A CORRE√á√ÉO PRINCIPAL)
            let valorAtual = 0;
            
            if (meta.tipo === 'parcelamento') {
                // Para d√≠vidas, usamos o valor j√° amortizado/pago
                valorAtual = meta.valorAtual || 0; 
                // Se tiver financiamento detalhado, usa o totalAmortizado que √© mais preciso
                if (meta.financiamento && meta.financiamento.totalAmortizado > 0) {
                    valorAtual = meta.financiamento.totalAmortizado;
                }
            } else {
                // CORRE√á√ÉO: L√™ direto do objeto, ignorando rec√°lculo de hist√≥rico
                valorAtual = meta.valorAtual || 0;
            }

            // Valor que est√° "na m√£o" para pagar a pr√≥xima parcela (Bolso separado)
            const valorProvisionado = meta.valorProvisionado || 0;

            let valorTotal = meta.valorTotal || 0;
            
            // Ajuste de Total para Financiamento (Contrato Cheio)
            if (meta.tipo === 'parcelamento' && meta.financiamento) {
                if (meta.financiamento.totalParcelas > 0 && meta.financiamento.valorParcela > 0) {
                    valorTotal = meta.financiamento.totalParcelas * meta.financiamento.valorParcela;
                } else if (meta.financiamento.valorFinanciado > 0) {
                    valorTotal = meta.financiamento.valorFinanciado;
                }
            }

            // Porcentagem (Progresso da Meta/D√≠vida)
            let percent = 0;
            if (meta.tipo === 'caixa') percent = 0;
            else if (valorTotal > 0) percent = Math.min(100, (valorAtual / valorTotal) * 100);

            // 2. Estilos e √çcones
            let corTema = 'cyan'; 
            let icone = 'üéØ';
            let textoValorPrincipal = 'Saldo Atual';
            
            const isFatura = meta.id.startsWith('FATURA_');
            const isAuto = meta.descricao.includes('(Auto)') || meta.tipo === 'poupanca_km';

            if (isFatura) {
                corTema = 'red'; icone = 'üí≥'; textoValorPrincipal = 'Fatura Aberta';
                const idContaMae = meta.id.replace('FATURA_', '');
                const contaMae = AppState.configuracoes.contasBancarias.find(c => c.id === idContaMae);
                if (contaMae && contaMae.icone) {
                    if (contaMae.icone.startsWith('http') || contaMae.icone.startsWith('data:image')) {
                        icone = `<img src="${contaMae.icone}" class="w-8 h-8 rounded-full object-cover">`;
                    } else {
                        const map = { nubank:'üü£', inter:'üü†', itau:'üüß', bradesco:'üü•', bb:'üü°', caixa:'üîµ', santander:'‚ô®Ô∏è' };
                        if (map[contaMae.icone]) icone = map[contaMae.icone];
                    }
                }
            }
            else if (meta.tipo === 'caixa') { corTema = 'emerald'; icone = 'üíµ'; textoValorPrincipal = 'Dispon√≠vel'; } 
            else if (meta.tipo === 'parcelamento') { corTema = 'orange'; icone = 'üìâ'; textoValorPrincipal = 'J√° Pago / Amortizado'; } 
            else if (isAuto) { corTema = 'blue'; icone = 'üîß'; textoValorPrincipal = 'Acumulado'; } 
            else if (meta.id === 'META_CUSTOS_MENSAIS') { corTema = 'amber'; icone = 'üìÖ'; textoValorPrincipal = 'Guardado'; }

            const textCor = `text-${corTema}-400`;
            const bgBarra = `bg-${corTema}-500`;

            // 3. Custo Di√°rio (Info)
            const custoDiario = BusinessLogic.calcularCustoDiarioMeta(meta, new Date());
            const custoDiarioHTML = (isAtiva && custoDiario > 0 && percent < 100 && meta.id !== 'AUTO_ID_PROLABORE' && meta.id !== 'META_CUSTOS_MENSAIS') 
                ? `<div class="flex justify-between items-center mt-1 pt-1 border-t border-slate-700/30">
                     <span class="text-[10px] text-slate-500">Custo Di√°rio (aprox.):</span>
                     <span class="text-xs text-slate-300 font-medium">${Utils.formatarMoeda(custoDiario)}</span>
                   </div>` : '';

            // 4. Detalhes Internos (HTML Espec√≠fico por Tipo)
            let infoExtraHTML = '';
            
            if (meta.tipo === 'parcelamento') {
                const valorRestante = Math.max(0, valorTotal - valorAtual);

                if (meta.tipoDivida === 'consorcio') {
                    infoExtraHTML = `<div class="mt-2 pt-2 border-t border-slate-700/50 flex justify-between text-xs"><span class="text-slate-400">Carta:</span><span class="text-white font-bold">${Utils.formatarMoeda(valorTotal)}</span></div>`;
                } else if (isFatura) {
                    let limiteDisplay = 'N/A';
                    const idContaMae = meta.id.replace('FATURA_', '');
                    const contaMae = AppState.configuracoes.contasBancarias.find(c => c.id === idContaMae);
                    if (contaMae && contaMae.limite) limiteDisplay = Utils.formatarMoeda(contaMae.limite - valorAtual);
                    // infoExtraHTML = `<div class="mt-2 pt-2 border-t border-slate-700/50 flex justify-between text-xs bg-slate-900/30 p-2 rounded"><span class="text-slate-400">Limite Disp.:</span><span class="text-emerald-400 font-bold">${limiteDisplay}</span></div><div class="text-[10px] text-slate-500 text-right mt-1">Vence dia ${contaMae ? contaMae.diaVencimento : '??'}</div>`;
                // Verifica se tem dinheiro na caixinha do cart√£o
                const temGuardado = valorProvisionado > 0.01;

                infoExtraHTML = `
                <div class="mt-2 pt-2 border-t border-slate-700/50 space-y-2">
                    ${temGuardado ? `
                    <div class="flex justify-between items-center bg-emerald-900/20 border border-emerald-500/30 p-2 rounded shadow-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-emerald-400">üê∑</span>
                            <span class="text-[10px] text-emerald-200 font-bold uppercase tracking-wide">Guardado P/ Pagar</span>
                        </div>
                        <span class="text-sm text-emerald-400 font-bold">${Utils.formatarMoeda(valorProvisionado)}</span>
                    </div>` : ''}

                    <div class="flex justify-between text-xs bg-slate-900/30 p-2 rounded">
                        <span class="text-slate-400">Limite Disp.:</span>
                        <span class="text-emerald-400 font-bold">${limiteDisplay}</span>
                    </div>
                    <div class="text-[10px] text-slate-500 text-right">
                        Vence dia ${contaMae ? contaMae.diaVencimento : '??'}
                    </div>
                </div>`;
                } else {
                    // EMPR√âSTIMO / FINANCIAMENTO
                    const dadosExtras = meta.dadosExtras || {};
                    const saldoFluxo = dadosExtras.saldoFluxo !== undefined ? dadosExtras.saldoFluxo : Math.max(0, valorTotal - valorAtual);
                    const pRestantes = dadosExtras.parcelasRestantes !== undefined ? dadosExtras.parcelasRestantes : '?';
                    const saldoQuitacao = dadosExtras.saldoQuitacao || 0;
                    const fin = meta.financiamento;

                    infoExtraHTML = `
                      <div class="mt-3 pt-2 border-t border-slate-700/50 space-y-2">
                        
                        <div class="flex justify-between text-xs">
                             <span class="text-slate-400">Valor Financiado:</span>
                             <span class="text-white font-bold">${fin ? Utils.formatarMoeda(fin.valorFinanciado) : 'R$ 0,00'}</span>
                        </div>

                        <div class="flex justify-between text-xs">
                             <span class="text-slate-400">Total do Contrato:</span>
                             <span class="text-slate-300">${Utils.formatarMoeda(valorTotal)}</span>
                        </div>

                        <div class="flex justify-between text-xs">
                             <span class="text-slate-400">Parcela Mensal:</span>
                             <span class="text-slate-200 font-bold">${fin ? Utils.formatarMoeda(fin.valorParcela) : 'R$ 0,00'}</span>
                        </div>
                        
                        <div class="flex justify-between items-center bg-slate-900/30 p-2 rounded">
                            <span class="text-xs text-orange-400 font-bold">Restam (${pRestantes}x):</span>
                            <span class="text-sm text-orange-400 font-bold">${Utils.formatarMoeda(saldoFluxo)}</span>
                        </div>

                        ${isAtiva && saldoQuitacao > 0 && saldoQuitacao < saldoFluxo ? `
                        <div class="flex justify-between items-center bg-cyan-900/10 border border-cyan-500/20 p-2 rounded mt-1">
                            <span class="text-[10px] text-cyan-400 font-bold">Para Quitar Hoje</span>
                            <span class="text-sm text-cyan-300 font-bold">${Utils.formatarMoeda(saldoQuitacao)}</span>
                        </div>` : ''}
                        
                        <div class="flex justify-between items-center bg-slate-800 border border-emerald-500/50 p-2 rounded mt-2 mb-1 shadow-sm">
                            <span class="text-xs text-emerald-200 font-bold uppercase">üí∞ Guardado na Caixinha</span>
                            <span class="text-base text-emerald-400 font-bold">${Utils.formatarMoeda(valorProvisionado)}</span>
                        </div>
                        ${fin ? `
                        <div class="flex justify-between items-center mt-2 pt-1 border-t border-slate-700/30">
                             <span class="text-[10px] text-slate-400">
                                 Pago L√≠quido: <b class="text-slate-300">${Utils.formatarMoeda(fin.totalAmortizado || 0)}</b>
                             </span>
                             <span class="text-[10px] text-green-400 bg-green-900/20 px-2 py-0.5 rounded border border-green-500/30">
                                 ü§ë Econ: ${Utils.formatarMoeda(fin.totalEconomizado || 0)}
                             </span>
                        </div>` : ''}

                        <div class="text-[10px] text-slate-500 text-right mt-1">
                            ${meta.dataVencimento ? `Vence: ${Utils.formatarDataParaDisplay(new Date(meta.dataVencimento+"T12:00:00"))}` : 'Quitado / Em dia'}
                        </div>
                        ${custoDiarioHTML}
                    </div>`;
                }
            } 
            else if (meta.tipo === 'poupanca_km' && isAtiva) {
                 infoExtraHTML = `<div class="flex justify-between text-xs mt-2 pt-2 border-t border-slate-700/50"><span class="text-slate-400">Taxa: <b class="text-white">${Utils.formatarMoedaPorKmParaInput(meta.valorPorKm)}/km</b></span><span class="text-slate-400">Alvo: <b class="text-white">${Utils.formatarMoeda(valorTotal)}</b></span></div>`;
            } 
            else if (meta.id === 'META_CUSTOS_MENSAIS') {
                 const custoDiarioCM = BusinessLogic.calcularCustoDiarioMeta(meta, new Date());
                 infoExtraHTML = `<div class="flex justify-between text-xs mt-2 pt-2 border-t border-slate-700/50"><span class="text-slate-400">Provisionar Hoje:</span><span class="text-amber-300 font-bold">${Utils.formatarMoeda(custoDiarioCM)}</span></div>`;
            }
            else if (isAtiva && meta.tipo === 'poupanca') {
                infoExtraHTML = `<div class="mt-2">${custoDiarioHTML}</div>`;
            }

            // 5. Bot√µes de A√ß√£o
            let botoesHTML = '';
            if (isAtiva) {
                let btnPrincipal = '';
                
                if (isFatura) {
                    btnPrincipal = `<button data-id="${meta.id}" class="btn-pagar-fatura flex-1 bg-red-600/20 hover:bg-red-600/40 text-red-300 border border-red-600/50 py-2 rounded-lg text-xs font-bold transition">Pagar Fatura</button>`;
                } else if (meta.tipo === 'parcelamento') {
                    // Intelig√™ncia do Bot√£o de D√≠vida
                    const textoBotao = valorProvisionado > 0 ? 'Usar Saldo / Pagar' : 'Simular / Pagar';
                    const classeBotao = valorProvisionado > 0 
                        ? 'bg-emerald-600 hover:bg-emerald-700 border-emerald-500 shadow-lg shadow-emerald-500/20' 
                        : 'bg-slate-700 hover:bg-slate-600 border-slate-600';
                        
                    btnPrincipal = `<button data-id="${meta.id}" class="btn-abrir-amortizacao flex-1 ${classeBotao} text-white py-2 rounded-lg text-xs font-bold transition border">${textoBotao}</button>`;
                } else if (meta.tipo === 'caixa') {
                    btnPrincipal = `<button data-id="${meta.id}" class="btn-editar-meta flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-xs font-bold transition">Ajustar</button>`;
                } else if (meta.id === 'META_CUSTOS_MENSAIS') {
                    btnPrincipal = `<button data-id="${meta.id}" class="btn-visualizar-custos-mensais flex-1 bg-amber-600/20 hover:bg-amber-600/40 text-amber-300 border border-amber-600/50 py-2 rounded-lg text-xs font-bold transition">Gerenciar Contas</button>`;
                } else if (isAuto) {
                    btnPrincipal = `<button data-id="${meta.id}" class="btn-editar-meta flex-1 bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 border border-blue-600/50 py-2 rounded-lg text-xs font-bold transition">Visualizar Detalhes</button>`;
                } else if (meta.id === 'AUTO_ID_PROLABORE' || meta.id === 'AUTO_ID_RESERVA_LUCRO') {
                    btnPrincipal = `<button data-id="${meta.id}" class="btn-abrir-transferencia flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition text-xs">Transferir</button>`;
                } else {
                     btnPrincipal = `<button data-id="${meta.id}" class="btn-usar-saldo-meta flex-1 bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-300 border border-emerald-600/50 py-2 rounded-lg text-xs font-bold transition">Usar Saldo</button>`;
                }

                const btnExtrato = `<button data-id="${meta.id}" class="btn-ver-extrato-meta p-2 text-slate-400 hover:text-white transition rounded hover:bg-slate-700" title="Extrato"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></button>`;
                const showEdit = !meta.isLocked && !isAuto && meta.id !== 'META_CUSTOS_MENSAIS';
                const btnEditar = showEdit ? `<button data-id="${meta.id}" class="btn-editar-meta p-2 text-slate-400 hover:text-cyan-400 transition rounded hover:bg-slate-700" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>` : '';
                const btnExcluir = (!meta.isLocked && meta.id !== 'META_CUSTOS_MENSAIS') ? `<button data-id="${meta.id}" class="btn-excluir-meta p-2 text-slate-400 hover:text-red-400 transition rounded hover:bg-slate-700" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>` : '';

                botoesHTML = `
                    <div class="flex items-center gap-2 mt-3">
                        ${btnPrincipal}
                        <div class="flex border-l border-slate-700 pl-2 ml-1">
                            ${btnExtrato}
                            ${btnEditar}
                            ${btnExcluir}
                        </div>
                    </div>
                `;
            }

            const li = document.createElement('li');
            li.className = `meta-card group ${!isAtiva ? 'opacity-60 grayscale' : ''}`;
            const watermark = `<div class="meta-card-icon-bg">${icone}</div>`;

            const progressBar = meta.tipo !== 'caixa' ? `
                <div class="meta-progress-track">
                    <div class="meta-progress-bar-fill ${bgBarra}" style="width: ${percent}%"></div>
                </div>
                <div class="flex justify-between text-[10px] font-semibold text-slate-400">
                    <span>${percent.toFixed(0)}% ${isFatura ? 'Gasto' : (meta.tipo === 'parcelamento' ? 'Pago' : 'Conclu√≠do')}</span>
                    <span>${isFatura ? 'Limite Total' : Utils.formatarMoeda(valorTotal)}</span>
                </div>
            ` : '';

            li.innerHTML = `
                ${watermark}
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex items-center gap-3">
                            ${icone.startsWith('<img') ? icone : `<span class="text-2xl shadow-sm p-2 bg-slate-800/80 rounded-xl border border-slate-700 flex items-center justify-center w-12 h-12">${icone}</span>`}
                            <div>
                                <h4 class="font-bold text-white text-lg leading-none">${meta.descricao}</h4>
                                ${!isAtiva ? '<span class="text-[10px] text-green-400 font-bold uppercase tracking-widest">Conclu√≠da</span>' : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] uppercase tracking-wide text-slate-500 block font-bold">${textoValorPrincipal}</span>
                            <span class="text-2xl font-bold ${textCor} tracking-tight">${Utils.formatarMoeda(valorAtual)}</span>
                        </div>
                    </div>
                    ${progressBar}
                    ${infoExtraHTML}
                    ${botoesHTML}
                </div>
            `;
            return li;
        },   
// ============================================================================
// RENDERIZADOR CONTROLES GERAIS (V226 - DEBUG MODE üêû)
// ============================================================================
renderControlesGerais: (jornada) => {
    // console.log("üèÅ In√≠cio renderControlesGerais"); // (Descomente se precisar muito detalhe)
    const UI = UIElements;
    
    // --- 1. PROTE√á√ÉO ---
    if (!jornada) {
        console.error("‚ùå Jornada nula!");
        return;
    }
    // Garante estrutura
    if (!jornada.custos) jornada.custos = { abastecimento: {}, outros: [] };
    
    delete AppState.modo;

    // --- 2. RENDERIZA√á√ÉO DE CUSTOS ---
    const renderPainelCustos = () => {
        // console.log("üîß Iniciando renderPainelCustos..."); 
        
        const custosContainer = document.getElementById('custosContainer');
        const btnMostrarCustos = document.getElementById('btnMostrarCustos');
        
        if (!custosContainer) console.error("‚ùå Elemento 'custosContainer' n√£o encontrado!");
        if (!btnMostrarCustos) console.error("‚ùå Elemento 'btnMostrarCustos' n√£o encontrado!");

        // L√≥gica do Bot√£o Toggle
        if (btnMostrarCustos) {
            btnMostrarCustos.textContent = AppState.custosVisiveis 
                ? 'Ocultar Custos Di√°rios' 
                : (AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios');
        }

        if (custosContainer) {
            const estavaOculto = custosContainer.classList.contains('hidden');
            custosContainer.classList.toggle('hidden', !AppState.custosVisiveis);
            // console.log(`üëÅÔ∏è Visibilidade Custos: ${AppState.custosVisiveis} (Antes hidden: ${estavaOculto})`);
        }
        
        // SE N√ÉO ESTIVER VIS√çVEL, O C√ìDIGO PARA AQUI. 
        // Se voc√™ clicou para abrir, AppState.custosVisiveis TEM que ser true.
        if (!AppState.custosVisiveis) return;

        // --- DAQUI PRA BAIXO S√ì RODA SE A ABA ESTIVER ABERTA ---

        const inputsDesabilitados = !AppState.isToday;
        // Pega os inputs novamente para garantir
        const iLitros = document.getElementById('litrosAbastecidos');
        const iValor = document.getElementById('valorAbastecido');
        const iKm = document.getElementById('kmAbastecimentoInput');
        const iRest = document.getElementById('litrosRestantesInput');
        const iDesc = document.getElementById('descricaoCusto');
        const iValCusto = document.getElementById('valorCusto');
        const btnAdd = document.getElementById('btnAdicionarCusto');

        [iLitros, iValor, iKm, iRest, iDesc, iValCusto, btnAdd].forEach(el => { 
            if(el) el.disabled = inputsDesabilitados; 
        });

        // Inje√ß√£o de Categorias
        if (btnAdd) {
            const formCustos = btnAdd.parentElement;
            if (formCustos && !formCustos.querySelector('#categoriaCustoVariavel')) {
                // console.log("üíâ Injetando Select de Categorias...");
                const htmlCategorias = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3"><div><label class="block text-xs font-medium text-slate-400 mb-1">Categoria Custo</label><select id="categoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"><option>Alimenta√ß√£o</option><option>Ve√≠culo</option><option>Pessoal</option><option>Outro C. Vari√°vel</option></select></div><div><label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria (Opc.)</label><input id="subcategoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Ex: Caf√©"></div></div>`;
                const grid = formCustos.querySelector('.grid');
                if (grid) grid.insertAdjacentHTML('afterend', htmlCategorias);
            }
        }

        // Dados
        const abastecimento = jornada.custos.abastecimento || {};
        
        // Helper SafeVal
        const safeVal = (el, val) => { if(el && document.activeElement !== el) el.value = val; };

        // Preenchimento
        safeVal(iLitros, abastecimento.litros > 0 ? String(abastecimento.litros).replace('.', ',') : '');
        safeVal(iValor, abastecimento.valor > 0 ? Utils.formatarMoedaParaInput(abastecimento.valor) : '');
        
        if (iKm && document.activeElement !== iKm) {
            let valorKm = '';
            if (abastecimento.kmAbastecimento > 0) valorKm = abastecimento.kmAbastecimento;
            else if (!iKm.value) valorKm = Math.round(AppState.gpsCurrentOdometer || jornada.kmFinal || jornada.kmInicial || 0);
            if (valorKm > 0) iKm.value = valorKm;
        }

        // --- O PONTO CR√çTICO: RESUMO E BOT√ÉO ---
        const divResumo = document.getElementById('resumoAbastecimento');
        
        if (!divResumo) {
            console.error("‚ùå FATAL: Elemento 'resumoAbastecimento' N√ÉO existe no HTML!");
        } else {
            // console.log("‚úèÔ∏è Desenhando Bot√£o de Gest√£o...");
            
            let htmlFinal = `<div class="space-y-1">`;
            const media = abastecimento.mediaCalculada || 0;
            
            if (media > 0) {
                htmlFinal += `<div>M√©dia Real: <span class="font-bold text-cyan-300">${media.toFixed(2)} km/L</span></div>`;
            }
            if (abastecimento.litros > 0 && abastecimento.valor > 0) {
                const p = abastecimento.valor / abastecimento.litros;
                htmlFinal += `<div>Pre√ßo/Litro: <span class="font-bold text-white">${Utils.formatarMoeda(p)}</span></div>`;
            }
            htmlFinal += `</div>`; 

            // üî• BOT√ÉO INSERIDO NA FOR√áA BRUTA üî•
            htmlFinal += `
                <div class="mt-3 pt-2 border-t border-slate-700/50">
                    <button type="button" id="btn-abrir-gestao-combustivel" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <span class="text-xl">‚õΩ</span> Gest√£o de Combust√≠vel
                    </button>
                </div>
            `;
            
            divResumo.innerHTML = htmlFinal;

            // Re-conecta Listener
            setTimeout(() => {
                const btnGestao = document.getElementById('btn-abrir-gestao-combustivel');
                if (btnGestao) {
                    // console.log("‚úÖ Bot√£o Gest√£o encontrado e Listener ativado.");
                    btnGestao.onclick = (e) => {
                        e.preventDefault();
                        const iLitrosNow = document.getElementById('litrosAbastecidos');
                        const iValorNow = document.getElementById('valorAbastecido');
                        const iKmNow = document.getElementById('kmAbastecimentoInput');
                        const iRestNow = document.getElementById('litrosRestantesInput');

                        UIRenderer.abrirModal('gestaoCombustivel', {
                            litros: iLitrosNow ? iLitrosNow.value : '',
                            valor: iValorNow ? iValorNow.value : '',
                            km: iKmNow ? iKmNow.value : '',
                            leitura: iRestNow ? iRestNow.value : ''
                        });
                    };
                } else {
                    console.error("‚ùå Bot√£o Gest√£o desenhado, mas n√£o encontrado no DOM logo ap√≥s!");
                }
            }, 0);
        }

        // Lista de Custos
        const divLista = document.getElementById('listaCustos');
        if (divLista) {
            divLista.innerHTML = '';
            const outros = jornada.custos.outros || [];
            if (outros.length === 0) {
                divLista.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum outro custo adicionado.</li>`;
            } else {
                outros.forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm';
                    const btnExcluirHTML = AppState.isToday ? `<button onclick="BusinessLogic.removerCusto('${custo.id}')" class="text-red-500 hover:text-red-400 transition font-bold text-lg px-2">&times;</button>` : '';
                    li.innerHTML = `<div><span>${custo.descricao}</span><span class="text-xs text-slate-400 block">${custo.categoria || 'Geral'}</span></div><div class="flex items-center gap-3"><span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>${btnExcluirHTML}</div>`;
                    divLista.appendChild(li);
                });
            }
        }
    };

    renderPainelCustos();

    // --- 3. RESTO DA UI (SEM ALTERA√á√ïES) ---
    const painelJornada = document.getElementById('painelControleJornada');
    const opcoesJornada = document.getElementById('opcoesJornada');
    const controlesOcultaveis = document.getElementById('controlesOcultaveis');
    
    const safeToggle = (el, show) => { if(el) el.classList.toggle('hidden', !show); };
    if (painelJornada) safeToggle(painelJornada, AppState.isStatusVisible);
    if (opcoesJornada) safeToggle(opcoesJornada, AppState.isStatusVisible && jornada.status !== 'inativa');
    if (controlesOcultaveis) safeToggle(controlesOcultaveis, AppState.isStatusVisible);

    const btnJornada = document.getElementById('btnJornada');
    const btnPausa = document.getElementById('btnPausa');
    if(btnJornada) btnJornada.onclick = null;
    if(btnPausa) btnPausa.onclick = null;

    if (jornada.status === 'inativa') {
        if(btnJornada) {
            btnJornada.textContent = 'Iniciar Jornada';
            btnJornada.className = 'w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
            btnJornada.disabled = !AppState.isToday;
            if (AppState.isToday) btnJornada.onclick = () => { BusinessLogic.iniciarJornada(); UIRenderer.render(); };
        }
        if(btnPausa) btnPausa.disabled = true;
        const kmIni = document.getElementById('kmInicialInput');
        if(kmIni) {
            kmIni.disabled = !AppState.isToday;
            if(!kmIni.value && AppState.isToday) kmIni.value = BusinessLogic.getKmFinalDiaAnterior() || '';
        }
    } else if (['ativa', 'em_pausa'].includes(jornada.status)) {
        AppState.modo = 'jornada_ativa';
        AppState.jornadaAtiva = jornada;
        if(btnJornada) {
            btnJornada.textContent = 'Finalizar Jornada';
            btnJornada.className = 'w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
            btnJornada.disabled = false;
            btnJornada.onclick = () => BusinessLogic.finalizarJornada();
        }
        if(btnPausa) {
            btnPausa.disabled = false;
            btnPausa.textContent = jornada.status === 'ativa' ? 'Iniciar Pausa' : 'Retomar Jornada';
            btnPausa.onclick = () => {
                if (jornada.status === 'ativa') BusinessLogic.iniciarPausa();
                else BusinessLogic.retomarJornada();
                UIRenderer.render();
            };
        }
        const kmIni = document.getElementById('kmInicialInput');
        if(kmIni) kmIni.disabled = true;
    } else if (jornada.status === 'finalizada') {
        delete AppState.jornadaAtiva;
        const idHoje = String(Utils.getDataInputHoje()).trim();
        const idLimpo = (jornada.id instanceof Date || String(jornada.id).length > 10) ? new Date(jornada.id).toISOString().split('T')[0] : String(jornada.id).trim();
        if (idLimpo === idHoje) {
            if(btnJornada) {
                btnJornada.textContent = 'Reabrir Jornada';
                btnJornada.className = 'w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg';
                btnJornada.disabled = false;
                btnJornada.onclick = () => BusinessLogic.reabrirJornada();
            }
        } else {
            if(btnJornada) {
                btnJornada.textContent = 'Iniciar Nova Jornada';
                btnJornada.className = 'w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-4 rounded-lg transition';
                btnJornada.disabled = false;
                btnJornada.onclick = () => { AppState.dataSelecionada = idHoje; AppState.isToday = true; BusinessLogic.iniciarJornada(); UIRenderer.render(); };
            }
        }
        if(btnPausa) btnPausa.disabled = true;
    }

    const ensureListener = (el, prop) => {
        if (el && !el._hasAutoSave) {
            el.addEventListener('input', (e) => {
                if (AppState.jornadaAtiva) AppState.jornadaAtiva[prop] = e.target.value;
                else if (jornada) jornada[prop] = e.target.value;
            });
            el._hasAutoSave = true;
        }
    };
    const kmFinalInput = document.getElementById('kmFinalInput');
    const metaHorasInput = document.getElementById('metaHorasInput');
    const safeVal = (el, val) => { if(el && document.activeElement !== el) el.value = val; };
    
    if(kmFinalInput) { ensureListener(kmFinalInput, 'kmFinal'); safeVal(kmFinalInput, jornada.kmFinal || ''); }
    if(metaHorasInput) { ensureListener(metaHorasInput, 'metaHoras'); safeVal(metaHorasInput, jornada.metaHoras || ''); }

    const statusContainer = document.getElementById('statusContainer');
    const statusPausa = document.getElementById('statusPausa');
    const servicosManager = document.getElementById('servicosManager');
    const tempoJornada = document.getElementById('tempoJornada');
    const estaOperacional = ['ativa', 'em_pausa'].includes(jornada.status);

    if(statusContainer) safeToggle(statusContainer, estaOperacional);
    if(statusPausa) safeToggle(statusPausa, jornada.status === 'em_pausa');
    if(servicosManager) safeToggle(servicosManager, estaOperacional);
    if(tempoJornada) tempoJornada.classList.toggle('animate-pulse-fast', jornada.status === 'ativa');

    const kmServ = document.getElementById('kmInicialServicoInput');
    if (estaOperacional && kmServ) {
        if (AppState.configuracoes.usarGpsTracking) {
            kmServ.disabled = true;
            kmServ.value = Math.round(AppState.gpsCurrentOdometer || 0);
        } else {
            if (!kmServ.value || kmServ.value == 0) {
                const sugestaoKm = BusinessLogic.getUltimoKmRegistrado() || jornada.kmInicial || '';
                safeVal(kmServ, sugestaoKm);
            }
        }
    }

    // M√≥dulos Auxiliares
    const listaAlertas = document.getElementById('listaAlertasJornada');
    if (listaAlertas && BusinessLogic.verificarAlertasManutencao) {
        const accordion = document.getElementById('maintenanceAlertAccordion');
        if(accordion) accordion.classList.toggle('hidden', listaAlertas.children.length === 0);
    }
    const alertaComb = document.getElementById('alertaCombustivelContainer');
    if (alertaComb && BusinessLogic.verificarNivelCombustivel) BusinessLogic.verificarNivelCombustivel();
    
    const contasRec = document.getElementById('contasRecorrentesAlertContainer');
    if (contasRec) {
        const temContas = document.getElementById('lista-contas-recorrentes-ul')?.children.length > 0;
        contasRec.classList.toggle('hidden', !temContas);
    }
    const servAndamento = document.getElementById('servicosEmAndamentoContainer');
    if (servAndamento) {
        const temServicos = jornada.servicosEmAndamento && jornada.servicosEmAndamento.length > 0;
        servAndamento.classList.toggle('hidden', !temServicos);
    }
},

/*       
// ============================================================================
        // RENDERIZADOR CONTROLES GERAIS (V89 + PATCH V137 - FINALIZA√á√ÉO SEGURA)
        // ============================================================================
        renderControlesGerais: (jornada) => {
            const {
                btnMostrarCustos, controlesOcultaveis, opcoesJornada,
                btnJornada, btnPausa, kmInicialInput, kmFinalInput,
                metaContainer, metaHorasInput, statusContainer, statusPausa,
                servicosManager, metaHoraResultado, kmInicialServicoInput,
                painelControleJornada
            } = UIElements;

            // --- BOT√ÉO DE CUSTOS ---
            if (AppState.custosVisiveis) {
                btnMostrarCustos.textContent = 'Ocultar Custos Di√°rios';
            } else {
                btnMostrarCustos.textContent = AppState.isToday
                    ? 'Registrar Custos Di√°rios'
                    : 'Visualizar Custos Di√°rios';
            }

            painelControleJornada.classList.toggle('hidden', !AppState.isStatusVisible);
            opcoesJornada.classList.toggle('hidden', AppState.isStatusVisible && jornada.status !== 'inativa');

            // =========================================================================
            // üî• L√ìGICA DOS BOT√ïES DE JORNADA (M√ÅQUINA DE ESTADOS BLINDADA)
            // =========================================================================
            
            // 1. ESTADO: JORNADA AINDA N√ÉO COME√áOU
            if (jornada.status === 'inativa') {
                btnJornada.textContent = 'Iniciar Jornada';
                btnJornada.className = 'w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                
                // S√≥ libera o bot√£o se estivermos visualizando o dia de hoje
                // (Evita iniciar jornada no passado ou futuro sem querer)
                btnJornada.disabled = !AppState.isToday; 
                
                btnPausa.disabled = true;

                if (AppState.isToday) {
                    btnJornada.onclick = () => {
                        BusinessLogic.iniciarJornada();
                        UIRenderer.render();
                    };
                }

            // 2. ESTADO: RODANDO OU EM PAUSA
            } else if (jornada.status === 'ativa' || jornada.status === 'em_pausa') {
                btnJornada.textContent = 'Finalizar Jornada';
                btnJornada.className = 'w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                
                btnJornada.disabled = false;
                
                // üî• SEGURAN√áA: Confirma√ß√£o antes de fechar
                btnJornada.onclick = () => {
                    if(confirm("Confirma o fim do expediente? Isso fechar√° o caixa do dia.")) {
                        BusinessLogic.finalizarJornada();
                        UIRenderer.render();
                    }
                };

                btnPausa.disabled = false;
                btnPausa.textContent = jornada.status === 'ativa' ? 'Iniciar Pausa' : 'Retomar Jornada';
                
                btnPausa.onclick = () => {
                    if (jornada.status === 'ativa') BusinessLogic.iniciarPausa();
                    else BusinessLogic.retomarJornada();
                    UIRenderer.render();
                };

// 3. ESTADO: JORNADA FINALIZADA (Decis√£o: Reabrir ou Nova?)
            } else {
                
// =========================================================
                // üïµÔ∏è DETETIVE DE DATAS (V148 - NORMALIZADOR ISO)
                // =========================================================
                
                // 1. Pega a data de Hoje LIMPA (Ex: "2025-12-29")
                const idHoje = Utils.getDataInputHoje(); 

                // 2. Pega a data da Jornada Suja
                let rawId = jornada.id || AppState.dataSelecionada || idHoje;
                let idJornadaLimpo = rawId;

                // 3. LIMPEZA: Se for uma data longa ou objeto, converte para "YYYY-MM-DD"
                try {
                    // Se for objeto Date ou string longa (com hor√°rio ou GMT)
                    if (rawId instanceof Date || String(rawId).length > 10) {
                        // Converte para data pura ISO (YYYY-MM-DD)
                        // O slice(0,10) pega s√≥ os primeiros 10 caracteres
                        idJornadaLimpo = new Date(rawId).toISOString().split('T')[0];
                    }
                } catch (e) {
                    console.warn("Erro ao normalizar data:", e);
                    idJornadaLimpo = rawId; // Fallback
                }

                // 4. A Compara√ß√£o Justa
                const ehJornadaDeHoje = idJornadaLimpo === idHoje;

                console.log("üîç VERIFICA√á√ÉO V148:", { 
                    Bruto: rawId,
                    Limpo: idJornadaLimpo, 
                    Hoje: idHoje, 
                    Resultado: ehJornadaDeHoje ? "REABRIR" : "NOVA" 
                });

                btnPausa.disabled = true;

                if (ehJornadaDeHoje) {
                    // ‚úÖ CEN√ÅRIO A: √â HOJE -> REABRIR
                    btnJornada.textContent = 'Reabrir Jornada';
                    btnJornada.className = 'w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                    btnJornada.disabled = false;
                    
                    btnJornada.onclick = () => {
                        BusinessLogic.reabrirJornada(); 
                    };

                } else {
                    // ‚ùå CEN√ÅRIO B: √â PASSADO -> NOVA JORNADA
                    btnJornada.textContent = 'Iniciar Nova Jornada';
                    btnJornada.className = 'w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                    btnJornada.disabled = false;
                    
                    btnJornada.onclick = () => {
                        try {
                            AppState.dataSelecionada = Utils.getDataInputHoje();
                            AppState.isToday = true;
                            BusinessLogic.iniciarJornada();
                            UIRenderer.render(); 
                        } catch (e) {
                            console.error("Erro cr√≠tico ao iniciar:", e);
                            location.reload(); 
                        }
                    };
                }
            }
            // =========================================================================
            // --- GPS / KM / INPUTS ---
            // =========================================================================
            const isGpsOn = AppState.configuracoes.usarGpsTracking;

            if (AppState.isToday && jornada.status === 'inativa') {
                kmInicialInput.disabled = false;
                // Tenta puxar o KM final de ontem como sugest√£o
                kmInicialInput.value = jornada.kmInicial || BusinessLogic.getKmFinalDiaAnterior() || '';
            } else {
                kmInicialInput.value = jornada.kmInicial || '';
                kmInicialInput.disabled = true;
            }

            kmFinalInput.value = jornada.kmFinal || '';
            // KM Final s√≥ habilita se for hoje, jornada ativa/pausa e GPS desligado
            kmFinalInput.disabled = !AppState.isToday || jornada.status === 'inativa' || isGpsOn;

            // Estiliza√ß√£o visual de campo desabilitado
            kmInicialInput.classList.toggle('bg-slate-600', kmInicialInput.disabled);
            kmFinalInput.classList.toggle('bg-slate-600', kmFinalInput.disabled);

            // =========================================================================
            // --- METAS E VISUALIZA√á√ÉO ---
            // =========================================================================
            metaContainer.classList.toggle('hidden', jornada.status === 'inativa');

            if (jornada.status !== 'inativa') {
                metaHorasInput.disabled = !AppState.isToday;
                metaHorasInput.value = jornada.metaHoras || '';

                const metaGanhos = AppState.configuracoes.metaAutonoma;
                if (jornada.metaHoras > 0 && metaGanhos > 0) {
                    const mediaHora = metaGanhos / jornada.metaHoras;
                    metaHoraResultado.innerHTML = `Para atingir <b class="text-cyan-300">${Utils.formatarMoeda(metaGanhos)}</b> em ${jornada.metaHoras}h, sua m√©dia precisa ser de <b class="text-cyan-300">${Utils.formatarMoeda(mediaHora)}/h</b>`;
                } else {
                    metaHoraResultado.innerHTML = '';
                }
            }

            // =========================================================================
            // --- STATUS E SERVI√áOS ---
            // =========================================================================
            statusContainer.classList.toggle('hidden', !['ativa', 'em_pausa'].includes(jornada.status));
            statusPausa.classList.toggle('hidden', jornada.status !== 'em_pausa');

            if(UIElements.tempoJornada) UIElements.tempoJornada.classList.toggle('animate-pulse-fast', jornada.status === 'ativa');
            if(UIElements.tempoPausa) UIElements.tempoPausa.classList.toggle('animate-pulse-fast', jornada.status === 'em_pausa');

            servicosManager.classList.toggle('hidden', !['ativa', 'em_pausa'].includes(jornada.status));

            if (!servicosManager.classList.contains('hidden')) {
                const kmInput = UIElements.kmInicialServicoInput;
                if (isGpsOn) {
                    kmInput.disabled = true;
                    kmInput.classList.add('bg-slate-600');
                    kmInput.value = Math.round(AppState.gpsCurrentOdometer || 0);
                } else {
                    kmInput.disabled = false;
                    kmInput.classList.remove('bg-slate-600');
                    // Sugere √∫ltimo KM se estiver vazio
                    if (document.activeElement !== kmInput && (!kmInput.value || kmInput.value == 0)) {
                        const ultimo = BusinessLogic.getUltimoKmRegistrado();
                        if (ultimo > 0) kmInput.value = ultimo;
                    }
                }
            }
        },
*/
/*  
renderControlesGerais: (jornada) => {
            const { btnMostrarCustos, controlesOcultaveis, opcoesJornada, btnJornada, btnPausa, kmInicialInput, kmFinalInput, metaContainer, metaHorasInput, statusContainer, statusPausa, servicosManager, metaHoraResultado, kmInicialServicoInput, painelControleJornada } = UIElements;
            
            // --- ETAPA 5: L√≥gica de Custo Atualizada ---
            // O bot√£o agora SEMPRE abre o modal de custos.
            btnMostrarCustos.textContent = AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios';
            // --- FIM DA ATUALIZA√á√ÉO ---

            painelControleJornada.classList.toggle('hidden', !AppState.isStatusVisible);
            opcoesJornada.classList.toggle('hidden', AppState.isStatusVisible && jornada.status !== 'inativa');

            if (jornada.status === 'inativa') {
                btnJornada.textContent = 'Iniciar Jornada';
                btnJornada.className = 'w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                btnJornada.disabled = !AppState.isToday;
                btnPausa.disabled = true;
            } else if (jornada.status === 'ativa' || jornada.status === 'em_pausa') {
                btnJornada.textContent = 'Finalizar Jornada';
                btnJornada.className = 'w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                btnJornada.disabled = false;
                btnPausa.disabled = false;
                btnPausa.textContent = jornada.status === 'ativa' ? 'Iniciar Pausa' : 'Retomar Jornada';
            } else {
                if (AppState.isToday) {
                    btnJornada.textContent = 'Reabrir Jornada';
                    btnJornada.className = 'w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 text-white font-bold py-3 px-4 rounded-lg transition highlight';
                    btnJornada.disabled = false;
                } else {
                    btnJornada.textContent = 'Jornada Finalizada';
                    btnJornada.className = 'w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg';
                    btnJornada.disabled = true;
                }
                btnPausa.disabled = true;
            }
            
            const isGpsOn = AppState.configuracoes.usarGpsTracking;

            if (AppState.isToday && jornada.status === 'inativa') {
                kmInicialInput.disabled = false;
                if (jornada.kmInicial) {
                    kmInicialInput.value = jornada.kmInicial;
                } 
                else {
                    const kmFinalOntem = BusinessLogic.getKmFinalDiaAnterior();
                    if (kmFinalOntem) {
                        kmInicialInput.value = kmFinalOntem;
                    }
                }
            } else {
                kmInicialInput.value = jornada.kmInicial || '';
                kmInicialInput.disabled = true;
            }

            kmFinalInput.value = jornada.kmFinal || '';
            kmFinalInput.disabled = !AppState.isToday || jornada.status === 'inativa' || isGpsOn;
            kmInicialInput.classList.toggle('bg-slate-600', kmInicialInput.disabled);
            kmFinalInput.classList.toggle('bg-slate-600', kmFinalInput.disabled);
                        
            
            metaContainer.classList.toggle('hidden', !(jornada.status !== 'inativa'));
            if (jornada.status !== 'inativa') {
                metaHorasInput.disabled = !AppState.isToday;
                metaHorasInput.value = jornada.metaHoras || '';
                const metaGanhos = AppState.configuracoes.metaAutonoma;
                if (jornada.metaHoras > 0 && metaGanhos > 0) {
                    const mediaHora = metaGanhos / jornada.metaHoras;
                    metaHoraResultado.innerHTML = `Para atingir <b class="text-cyan-300">${Utils.formatarMoeda(metaGanhos)}</b> em ${jornada.metaHoras}h, sua m√©dia precisa ser de <b class="text-cyan-300">${Utils.formatarMoeda(mediaHora)}/h</b>`;
                } else {
                     metaHoraResultado.innerHTML = '';
                }
            }

            statusContainer.classList.toggle('hidden', !(['ativa', 'em_pausa'].includes(jornada.status)));
            if (['ativa', 'em_pausa'].includes(jornada.status)) {
                statusPausa.classList.toggle('hidden', jornada.status !== 'em_pausa');
                UIElements.tempoJornada.classList.toggle('animate-pulse-fast', jornada.status === 'ativa');
                UIElements.tempoPausa.classList.toggle('animate-pulse-fast', jornada.status === 'em_pausa');
            }
            
            servicosManager.classList.toggle('hidden', !(['ativa', 'em_pausa'].includes(jornada.status)));
//7.4
            if (servicosManager.classList.contains('hidden') === false) { // Se estiver vis√≠vel
                 // --- CORRE√á√ÉO KM INPUT ---
                 const kmInput = UIElements.kmInicialServicoInput;
                 const isGpsOn = AppState.configuracoes.usarGpsTracking;
                 
                 if (isGpsOn) {
                     kmInput.disabled = true;
                     kmInput.classList.add('bg-slate-600');
                     kmInput.value = Math.round(AppState.gpsCurrentOdometer);
                 } else {
                     kmInput.disabled = false;
                     kmInput.classList.remove('bg-slate-600');
                     
                     // S√≥ preenche se o usu√°rio n√£o estiver digitando nele
                     if (document.activeElement !== kmInput && (!kmInput.value || kmInput.value == 0)) {
                         const ultimo = BusinessLogic.getUltimoKmRegistrado();
                         if (ultimo > 0) kmInput.value = ultimo;
                     }
                 }
            }
        }
      
 */

      renderToggleStatusButton: () => {
            const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
            const eyeOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
            UIElements.btnToggleStatusView.innerHTML = AppState.isStatusVisible ? eyeIcon : eyeOffIcon;
        },
        
        renderServicosEmAndamento: (jornadaAtiva) => {
            const { servicosEmAndamentoContainer, tituloServicosEmAndamento, listaServicosEmAndamento } = UIElements;
            const temServicosAtivos = jornadaAtiva && jornadaAtiva.servicosEmAndamento.length > 0;
            servicosEmAndamentoContainer.classList.toggle('hidden', !temServicosAtivos);
            
            tituloServicosEmAndamento.classList.toggle('animate-pulse-title', temServicosAtivos);

            listaServicosEmAndamento.innerHTML = '';
            if (temServicosAtivos) {
                jornadaAtiva.servicosEmAndamento.forEach(servico => {
                    let subcategoriaHTML = '';
                    if (servico.subcategoria) {
                        const subcatConfig = AppState.configuracoes.subcategorias[servico.categoria]?.find(s => s.nome === servico.subcategoria);
                        const cor = subcatConfig ? subcatConfig.cor : '#818cf8';
                        const corTexto = Utils.getContrastingTextColor(cor);
                        subcategoriaHTML = `<span class="text-xs px-2 py-0.5 rounded-full ml-2" style="background-color: ${cor}; color: ${corTexto};">${servico.subcategoria}</span>`;
                    }
                    
                    const li = document.createElement('li');
                    li.className = 'bg-slate-800 p-3 rounded-md flex justify-between items-center fade-in servico-em-andamento';
                    li.innerHTML = `
                        <div>
                            <div class="flex items-center flex-wrap">
                                <span class="font-bold">${servico.valor > 0 ? Utils.formatarMoeda(servico.valor) : 'R√°pido'}</span>
                                <span class="text-xs bg-cyan-800 text-cyan-200 px-2 py-0.5 rounded-full ml-2">${servico.categoria}</span>
                                ${subcategoriaHTML}
                            </div>
                            <span class="text-sm text-slate-400 block mt-1">${servico.descricao || 'Sem descri√ß√£o'}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-mono text-amber-400 servico-em-andamento-timer" data-id="${servico.id}">00:00:00</span>
                            
                            <div class="flex items-center gap-2 mt-1">
                                <button data-id="${servico.id}" class="btn-descartar-servico w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">Descartar</button>
                                <button data-id="${servico.id}" class="btn-finalizar-servico w-full bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">Finalizar</button>
                            </div>
                            </div>
                    `;
                    listaServicosEmAndamento.appendChild(li);
                });
            }
        },
// ============================================================================
// RENDERIZADOR DE CUSTOS (V160 - DEFINITIVO: DATA ECON√îMICA BLINDADA)
// ============================================================================
renderCustos: (jornada) => {
    const {
        custosContainer, litrosAbastecidosInput, valorAbastecidoInput,
        resumoAbastecimento, listaCustos, descricaoCustoInput,
        valorCustoInput, btnAdicionarCusto, kmAbastecimentoInput,
        btnMostrarCustos
    } = UIElements;

    // ------------------------------------------------------------------------
    // 1. SEGURAN√áA E VISIBILIDADE
    // ------------------------------------------------------------------------
    if (!custosContainer || !btnMostrarCustos || !listaCustos) return;

    btnMostrarCustos.textContent = AppState.custosVisiveis
        ? 'Ocultar Custos Di√°rios'
        : (AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios');

    custosContainer.classList.toggle('hidden', !AppState.custosVisiveis);
    if (!AppState.custosVisiveis) return;

    // ------------------------------------------------------------------------
    // 2. TRAVA DE INPUTS (S√ì HOJE √â EDIT√ÅVEL)
    // ------------------------------------------------------------------------
    const bloqueado = !AppState.isToday;
    [
        litrosAbastecidosInput, valorAbastecidoInput,
        kmAbastecimentoInput, descricaoCustoInput,
        valorCustoInput, btnAdicionarCusto
    ].forEach(el => { if (el) el.disabled = bloqueado; });

    // ------------------------------------------------------------------------
    // 3. INJE√á√ÉO DE CAMPOS (CATEGORIA / SUBCATEGORIA)
    // ------------------------------------------------------------------------
    if (btnAdicionarCusto?.parentElement) {
        const form = btnAdicionarCusto.parentElement;

        if (!form.querySelector('#categoriaCustoVariavel')) {
            btnAdicionarCusto.insertAdjacentHTML('beforebegin', `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3 mb-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Categoria</label>
                        <select id="categoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Ve√≠culo">Ve√≠culo</option>
                            <option value="Pessoal">Pessoal</option>
                            <option value="Outras Despesas" selected>Outras Despesas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria</label>
                        <input id="subcategoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Ex: √Ågua, Caf√©‚Ä¶">
                    </div>
                </div>
            `);
        }
    }

    // ------------------------------------------------------------------------
    // 4. ABASTECIMENTO (VISUAL)
    // ------------------------------------------------------------------------
    if (jornada?.custos?.abastecimento) {
        const ab = jornada.custos.abastecimento;

        if (litrosAbastecidosInput && document.activeElement !== litrosAbastecidosInput)
            litrosAbastecidosInput.value = ab.litros > 0 ? String(ab.litros).replace('.', ',') : '';

        if (valorAbastecidoInput && document.activeElement !== valorAbastecidoInput)
            valorAbastecidoInput.value = ab.valor > 0 ? Utils.formatarMoedaParaInput(ab.valor) : '';

        if (resumoAbastecimento) {
            resumoAbastecimento.innerHTML = `
                <div class="space-y-1">
                    ${ab.mediaCalculada > 0
                        ? `<div>M√©dia Real: <b class="text-cyan-300">${ab.mediaCalculada.toFixed(2)} km/L</b></div>`
                        : ''}
                </div>
            `;
        }
    }

// ------------------------------------------------------------------------
    // 5. LISTA DE CUSTOS ‚Äî FILTRO BLINDADO (V172)
    // ------------------------------------------------------------------------
    listaCustos.innerHTML = '';

    // üïí DEFINI√á√ÉO DO ALVO (Meia-noite da data selecionada na navega√ß√£o)
    const dtAlvo = new Date(AppState.dataSelecionada);
    dtAlvo.setHours(0, 0, 0, 0);
    const alvoTimestamp = dtAlvo.getTime();

    const custosDoDia = AppState.historicoTransacoes.filter(t => {
        // Filtros b√°sicos
        if (!t || t.invalida || t.tipo !== 'saida' || !t.isCustoOperacional || t.categoria === 'Abastecimento') return false;

        // üõ°Ô∏è TRAVA AT√ìMICA: Transforma a data da transa√ß√£o em meia-noite
        const tDataDia = t.dataDia ?? (() => {
            const d = new Date(t.dataEconomica || t.data);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        })();

        // S√ì PASSA SE FOR O MESMO MILISSEGUNDO (Fim da viagem no tempo)
        return tDataDia === alvoTimestamp;
    });

    // ------------------------------------------------------------------------
    // 6. RENDERIZA√á√ÉO FINAL
    // ------------------------------------------------------------------------
    if (custosDoDia.length === 0) {
        listaCustos.innerHTML =
            `<li class="text-center text-slate-500 italic text-sm">Nenhum custo di√°rio.</li>`;
        return;
    }

    custosDoDia
        .sort((a, b) => (b.dataEconomica || b.data) - (a.dataEconomica || a.data))
        .forEach(custo => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm mb-2 border-l-4 border-red-500';

            const sub = custo.subcategoria || custo?.detalhes?.subcategoria || '';
            const label = sub
                ? `${custo.categoria} <span class="text-xs text-slate-400">(${sub})</span>`
                : custo.categoria;

            li.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-semibold text-slate-200">${custo.descricao}</span>
                    <span class="text-xs text-slate-400">${label}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>
                    ${AppState.isToday
                        ? `<button onclick="window.excluirTransacaoInteligente('${custo.id}')" class="text-red-400 hover:text-red-300 font-bold">&times;</button>`
                        : ''}
                </div>
            `;
            listaCustos.appendChild(li);
        });
},

/*
            // =================================================================
            // 5. LISTA DE CUSTOS (Leitura Din√¢mica do Hist√≥rico Global)
            // =================================================================
            listaCustos.innerHTML = '';
            
            // Filtra do Hist√≥rico Global (Single Source of Truth)
            const custosDoDia = AppState.historicoTransacoes.filter(t => 
                t.jornadaId === jornada.id &&
                t.tipo === 'saida' &&
                t.isCustoOperacional === true &&
                t.categoria !== 'Abastecimento' &&
                !t.invalida
            );

            if (custosDoDia.length === 0) {
                listaCustos.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum custo extra lan√ßado.</li>`;
            } else {
                // Ordena por hora (recente primeiro)
                custosDoDia.sort((a, b) => b.data - a.data);

                custosDoDia.forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm mb-2 border-l-4 border-red-500';
                    
                    // Bot√£o Excluir
                    const btnX = AppState.isToday 
                        ? `<button onclick="window.excluirTransacaoInteligente('${custo.id}')" class="text-red-500 hover:text-red-400 ml-2 font-bold text-lg leading-none" title="Excluir">&times;</button>` 
                        : '';

                    // Formata√ß√£o Visual
                    let displaySub = custo.categoria;
                    let sub = custo.subcategoria || (custo.detalhes ? custo.detalhes.subcategoria : '') || '';
                    if (sub) displaySub += ` <span class="text-slate-500 text-xs">(${sub})</span>`;

                    const iconCredito = (custo.isCredito || (custo.contaId && String(custo.contaId).includes('FATURA'))) ? 'üí≥ ' : '';

                    li.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-semibold text-slate-200">${iconCredito}${custo.descricao}</span>
                            <span class="text-xs text-slate-400">${displaySub}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>
                            ${btnX}
                        </div>`;
                    listaCustos.appendChild(li);
                });
            }
        },*/
 
 /*      
        
       // ============================================================================
        // RENDERIZADOR DE CUSTOS (V108 - FONTE DE DADOS UNIFICADA COM DRE)
        // ============================================================================
        renderCustos: (jornada) => {
            const { custosContainer, litrosAbastecidosInput, valorAbastecidoInput, resumoAbastecimento, listaCustos, descricaoCustoInput, valorCustoInput, btnAdicionarCusto, kmAbastecimentoInput, btnMostrarCustos } = UIElements;
            
            // Seguran√ßa
            if (!custosContainer || !btnMostrarCustos) return;

            // 1. Visibilidade
            if (AppState.custosVisiveis) {
                btnMostrarCustos.textContent = 'Ocultar Custos Di√°rios';
            } else {
                btnMostrarCustos.textContent = AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios';
            }
            custosContainer.classList.toggle('hidden', !AppState.custosVisiveis);
            if (!AppState.custosVisiveis) return;

            // 2. Trava Inputs
            const inputsDesabilitados = !AppState.isToday;
            const els = [litrosAbastecidosInput, valorAbastecidoInput, kmAbastecimentoInput, descricaoCustoInput, valorCustoInput, btnAdicionarCusto];
            els.forEach(el => { if(el) el.disabled = inputsDesabilitados; });

            // 3. Inje√ß√£o Visual (Select Categoria) - Mantendo a V95
            if (btnAdicionarCusto && btnAdicionarCusto.parentElement) {
                const formCustos = btnAdicionarCusto.parentElement;
                if (!formCustos.querySelector('#categoriaCustoVariavel')) {
                    const htmlCamposExtras = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Categoria Custo</label>
                                <select id="categoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                                    <option value="Ve√≠culo">Ve√≠culo</option>
                                    <option value="Pessoal">Pessoal</option>
                                    <option value="Outras Despesas">Outras Despesas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria (Opc.)</label>
                                <input type="text" id="subcategoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white outline-none focus:ring-1 focus:ring-blue-500" placeholder="Ex: Caf√©, Pneu...">
                            </div>
                        </div>`;
                    btnAdicionarCusto.insertAdjacentHTML('beforebegin', htmlCamposExtras);
                }
            }

            // 4. Abastecimento (Visual)
            const { abastecimento } = jornada.custos;
            if (litrosAbastecidosInput && document.activeElement !== litrosAbastecidosInput) 
                litrosAbastecidosInput.value = abastecimento.litros > 0 ? String(abastecimento.litros).replace('.', ',') : '';
            if (valorAbastecidoInput && document.activeElement !== valorAbastecidoInput) 
                valorAbastecidoInput.value = abastecimento.valor > 0 ? Utils.formatarMoedaParaInput(abastecimento.valor) : '';

            let resumoHTML = `<div class="space-y-1">`;
            const mediaKmPorLitro = abastecimento.mediaCalculada || 0;
            if (mediaKmPorLitro > 0) resumoHTML += `<div>M√©dia Real: <span class="font-bold text-cyan-300">${mediaKmPorLitro.toFixed(2)} km/L</span></div>`;
            resumoHTML += `<div class="mt-3 pt-2 border-t border-slate-700/50"><button type="button" id="btn-abrir-gestao-combustivel" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95 flex items-center justify-center gap-2"><span class="text-xl">‚õΩ</span> Gest√£o de Combust√≠vel</button></div>`;
            resumoAbastecimento.innerHTML = resumoHTML;

            setTimeout(() => {
                const btnGestao = document.getElementById('btn-abrir-gestao-combustivel');
                if (btnGestao) {
                    btnGestao.onclick = (e) => {
                        e.preventDefault();
                        const inpRes = document.getElementById('litrosRestantesInput');
                        UIRenderer.abrirModal('gestaoCombustivel', {
                            litros: litrosAbastecidosInput.value,
                            valor: valorAbastecidoInput.value,
                            km: kmAbastecimentoInput ? kmAbastecimentoInput.value : '',
                            leitura: inpRes ? inpRes.value : ''
                        });
                    };
                }
            }, 0);

            // =================================================================
            // 5. LISTA DE CUSTOS (CORRE√á√ÉO: LENDO DE 'JORNADA.CUSTOS.OUTROS')
            // =================================================================
            listaCustos.innerHTML = '';
            
            // AGORA LEMOS DA MESMA FONTE QUE O DRE/WATERFALL
            const custosDoDia = jornada.custos.outros || [];

            if (custosDoDia.length === 0) {
                listaCustos.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum custo extra lan√ßado.</li>`;
            } else {
                // Inverte a ordem para mostrar os mais recentes primeiro
                [...custosDoDia].reverse().forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm mb-2 border-l-4 border-red-500';
                    
                    // Bot√£o Excluir (V86 Logic)
                    // Note que aqui passamos 'outros' e o ID, para o sistema saber onde apagar
                    const btnX = AppState.isToday 
                        ? `<button onclick="window.excluirCustoJornada('${custo.id}')" class="btn-excluir-custo text-red-500 hover:text-red-400 transition ml-2 text-lg font-bold" title="Excluir">&times;</button>` 
                        : '';

                    // Formata√ß√£o da Subcategoria
                    let displaySub = custo.categoria;
                    if (custo.subcategoria) displaySub += ` <span class="text-slate-500 text-xs">(${custo.subcategoria})</span>`;

                    li.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-semibold text-slate-200">${custo.descricao}</span>
                            <span class="text-xs text-slate-400">${displaySub}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>
                            ${btnX}
                        </div>`;
                    listaCustos.appendChild(li);
                });
            }
        }, 

*/

/*         
// ============================================================================
        // RENDERIZADOR DE CUSTOS (V95 - VISUAL COMPLETO + LISTA + SEM CRASH)
        // ============================================================================
        renderCustos: (jornada) => {
            const { custosContainer, litrosAbastecidosInput, valorAbastecidoInput, resumoAbastecimento, listaCustos, descricaoCustoInput, valorCustoInput, btnAdicionarCusto, kmAbastecimentoInput, btnMostrarCustos } = UIElements;
            
            // Seguran√ßa
            if (!custosContainer || !btnMostrarCustos) return;

            // 1. Textos e Visibilidade
            if (AppState.custosVisiveis) {
                btnMostrarCustos.textContent = 'Ocultar Custos Di√°rios';
            } else {
                btnMostrarCustos.textContent = AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios';
            }

            custosContainer.classList.toggle('hidden', !AppState.custosVisiveis);
            if (!AppState.custosVisiveis) return;

            // 2. Travar Inputs
            const inputsDesabilitados = !AppState.isToday;
            const els = [litrosAbastecidosInput, valorAbastecidoInput, kmAbastecimentoInput, descricaoCustoInput, valorCustoInput, btnAdicionarCusto];
            els.forEach(el => { if(el) el.disabled = inputsDesabilitados; });

            // =================================================================
            // 3. O RESGATE: INJE√á√ÉO DOS CAMPOS CATEGORIA E SUBCATEGORIA
            // =================================================================
            if (btnAdicionarCusto && btnAdicionarCusto.parentElement) {
                const formCustos = btnAdicionarCusto.parentElement;
                
                // S√≥ adiciona se ainda n√£o existirem
                if (!formCustos.querySelector('#categoriaCustoVariavel')) {
                    const htmlCamposExtras = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3 mb-3">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Categoria Custo</label>
                                <select id="categoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white outline-none focus:ring-1 focus:ring-blue-500">
                                    <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                                    <option value="Ve√≠culo">Ve√≠culo</option>
                                    <option value="Pessoal">Pessoal</option>
                                    <option value="Outras Despesas">Outras Despesas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria (Opc.)</label>
                                <input type="text" id="subcategoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white outline-none focus:ring-1 focus:ring-blue-500" placeholder="Ex: Caf√©, Pneu...">
                            </div>
                        </div>`;
                    
                    // Insere AP√ìS os campos de Descri√ß√£o/Valor (que geralmente est√£o numa div .grid ou logo antes do bot√£o)
                    // Vamos tentar inserir logo antes do bot√£o para garantir
                    btnAdicionarCusto.insertAdjacentHTML('beforebegin', htmlCamposExtras);
                }
            }
            // =================================================================

            // 4. Preenche Abastecimento (Visual)
            const { abastecimento } = jornada.custos;
            if (litrosAbastecidosInput && document.activeElement !== litrosAbastecidosInput) 
                litrosAbastecidosInput.value = abastecimento.litros > 0 ? String(abastecimento.litros).replace('.', ',') : '';
            
            if (valorAbastecidoInput && document.activeElement !== valorAbastecidoInput) 
                valorAbastecidoInput.value = abastecimento.valor > 0 ? Utils.formatarMoedaParaInput(abastecimento.valor) : '';

            // 5. Bot√£o Gest√£o Combust√≠vel
            let resumoHTML = `<div class="space-y-1">`;
            const mediaKmPorLitro = abastecimento.mediaCalculada || 0;
            if (mediaKmPorLitro > 0) resumoHTML += `<div>M√©dia Real: <span class="font-bold text-cyan-300">${mediaKmPorLitro.toFixed(2)} km/L</span></div>`;
            
            resumoHTML += `<div class="mt-3 pt-2 border-t border-slate-700/50"><button type="button" id="btn-abrir-gestao-combustivel" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95 flex items-center justify-center gap-2"><span class="text-xl">‚õΩ</span> Gest√£o de Combust√≠vel</button></div>`;
            resumoAbastecimento.innerHTML = resumoHTML;

            setTimeout(() => {
                const btnGestao = document.getElementById('btn-abrir-gestao-combustivel');
                if (btnGestao) {
                    btnGestao.onclick = (e) => {
                        e.preventDefault();
                        const inpRes = document.getElementById('litrosRestantesInput');
                        UIRenderer.abrirModal('gestaoCombustivel', {
                            litros: litrosAbastecidosInput.value,
                            valor: valorAbastecidoInput.value,
                            km: kmAbastecimentoInput ? kmAbastecimentoInput.value : '',
                            leitura: inpRes ? inpRes.value : ''
                        });
                    };
                }
            }, 0);

            // 6. Lista de Custos
            listaCustos.innerHTML = '';
            const custosDoDia = AppState.historicoTransacoes.filter(t => 
                t.jornadaId === jornada.id && t.tipo === 'saida' && t.isCustoOperacional === true && t.categoria !== 'Abastecimento' && !t.invalida
            );

            if (custosDoDia.length === 0) {
                listaCustos.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum custo extra lan√ßado.</li>`;
            } else {
                custosDoDia.forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm';
                    const btnX = AppState.isToday 
                        ? `<button onclick="window.excluirTransacao('${custo.id}')" class="btn-excluir-custo text-red-500 hover:text-red-400 transition ml-2 text-lg font-bold">&times;</button>` 
                        : '';

                    li.innerHTML = `<div><span class="font-semibold text-slate-200">${custo.descricao}</span><span class="text-xs text-slate-400 block">${custo.categoria}</span></div><div class="flex items-center gap-2"><span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>${btnX}</div>`;
                    listaCustos.appendChild(li);
                });
            }
        },

 */
/*         
        
        // ============================================================================
        // RENDERIZADOR DE CUSTOS (LIMPO E ATUALIZADO V82)
        // ============================================================================
        renderCustos: (jornada) => {
            const { custosContainer, litrosAbastecidosInput, valorAbastecidoInput, resumoAbastecimento, listaCustos, descricaoCustoInput, valorCustoInput, btnAdicionarCusto, kmAbastecimentoInput, btnMostrarCustos } = UIElements;
            const inputRestanteReal = document.getElementById('litrosRestantesInput');
            const labelRestanteReal = document.getElementById('label-litros-restantes');

            // 1. Controle de Visibilidade
            btnMostrarCustos.textContent = AppState.custosVisiveis 
                ? 'Ocultar Custos Di√°rios' 
                : (AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios');

            custosContainer.classList.toggle('hidden', !AppState.custosVisiveis);
            if (!AppState.custosVisiveis) return;

            // 2. Estado dos Inputs (Desabilita se n√£o for hoje)
            const inputsDesabilitados = !AppState.isToday;
            [litrosAbastecidosInput, valorAbastecidoInput, kmAbastecimentoInput, inputRestanteReal, descricaoCustoInput, valorCustoInput, btnAdicionarCusto].forEach(el => { if(el) el.disabled = inputsDesabilitados; });

            // 3. Inje√ß√£o de Categorias (Se n√£o existir)
            const formCustos = btnAdicionarCusto.parentElement;
            if (!formCustos.querySelector('#categoriaCustoVariavel')) {
                const h = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="block text-xs font-medium text-slate-400 mb-1">Categoria Custo</label><select id="categoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"><option>Alimenta√ß√£o</option><option>Ve√≠culo</option><option>Pessoal</option><option>Outro C. Vari√°vel</option></select></div><div><label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria (Opc.)</label><input id="subcategoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Ex: Caf√©"></div></div>`;
                formCustos.querySelector('.grid').insertAdjacentHTML('afterend', h);
            }

            const { abastecimento } = jornada.custos;

            // 4. Preenche Inputs de Abastecimento
            if (document.activeElement !== litrosAbastecidosInput) litrosAbastecidosInput.value = abastecimento.litros > 0 ? String(abastecimento.litros).replace('.', ',') : '';
            if (document.activeElement !== valorAbastecidoInput) valorAbastecidoInput.value = abastecimento.valor > 0 ? Utils.formatarMoedaParaInput(abastecimento.valor) : '';
            if (kmAbastecimentoInput && document.activeElement !== kmAbastecimentoInput) {
                kmAbastecimentoInput.value = abastecimento.kmAbastecimento > 0 ? abastecimento.kmAbastecimento : (Math.round(AppState.gpsCurrentOdometer) || '');
            }

            // 5. Leitura Inteligente do Combust√≠vel (FuelService)
            if (inputRestanteReal) {
                const config = AppState.configuracoes || {};
                const modo = config.metodoLeituraCombustivel || 'nivel';
                const ultimoDado = FuelService.getUltimoRegistro(jornada);
                
                let valorParaMostrar = 0;
                let labelTexto = '';
                let placeholderTexto = '';

                if (modo === 'consumo') {
                    labelTexto = 'Consumo Painel (Km/L)';
                    placeholderTexto = "Ex: 12,5";
                    if (ultimoDado) valorParaMostrar = ultimoDado.painel > 0 ? ultimoDado.painel : ultimoDado.tanque;
                } else {
                    labelTexto = 'Restante no Tanque (L)';
                    placeholderTexto = "Ex: 5,0";
                    if (ultimoDado) valorParaMostrar = ultimoDado.tanque > 0 ? ultimoDado.tanque : ultimoDado.painel;
                }

                if (labelRestanteReal) labelRestanteReal.textContent = labelTexto;
                inputRestanteReal.placeholder = placeholderTexto;

                if (document.activeElement !== inputRestanteReal) {
                    inputRestanteReal.value = valorParaMostrar > 0 ? String(valorParaMostrar).replace('.', ',') : '';
                }
            }

            // 6. Resumo Visual do Abastecimento
            const mediaKmPorLitro = abastecimento.mediaCalculada || 0;
            const precoPorLitro = abastecimento.litros > 0 ? abastecimento.valor / abastecimento.litros : 0;
            
            let resumoHTML = `<div class="space-y-1">`;
            if (precoPorLitro > 0) resumoHTML += `<div>Pre√ßo/Litro: <span class="font-bold text-white">${Utils.formatarMoeda(precoPorLitro)}</span></div>`;
            if (mediaKmPorLitro > 0) resumoHTML += `<div>M√©dia Real: <span class="font-bold text-cyan-300">${mediaKmPorLitro.toFixed(2)} km/L</span></div>`;
            
            resumoHTML += `<div class="mt-3 pt-2 border-t border-slate-700/50"><button id="btn-abrir-gestao-combustivel" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95 flex items-center justify-center gap-2"><span class="text-xl">‚õΩ</span> Gest√£o de Combust√≠vel</button></div>`;
            resumoAbastecimento.innerHTML = resumoHTML;

            // Re-liga o bot√£o de gest√£o de combust√≠vel (delay 0 para garantir DOM)
            setTimeout(() => {
                const btn = document.getElementById('btn-abrir-gestao-combustivel');
                if (btn) {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const inpRes = document.getElementById('litrosRestantesInput');
                        const dadosAtuais = {
                            litros: litrosAbastecidosInput.value,
                            valor: valorAbastecidoInput.value,
                            km: kmAbastecimentoInput ? kmAbastecimentoInput.value : '',
                            leitura: inpRes ? inpRes.value : ''
                        };
                        UIRenderer.abrirModal('gestaoCombustivel', dadosAtuais);
                    };
                }
            }, 0);

            // =================================================================
            // 7. LISTA DE CUSTOS ADICIONAIS (ATUALIZADA P/ LER TRANSA√á√ïES V81)
            // =================================================================
            listaCustos.innerHTML = '';
            
            // Filtra do Hist√≥rico Global (Fonte da Verdade)
            const custosDoDia = AppState.historicoTransacoes.filter(t => 
                t.jornadaId === jornada.id && 
                t.tipo === 'saida' && 
                t.isCustoOperacional === true &&
                t.categoria !== 'Abastecimento' && 
                !t.invalida
            );

            if (custosDoDia.length === 0) {
                listaCustos.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum outro custo adicionado.</li>`;
            } else {
                custosDoDia.forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm';
                    
                    // Bot√£o Excluir (S√≥ aparece se for hoje)
                    const btnDelete = AppState.isToday 
                        ? `<button onclick="window.excluirTransacao('${custo.id}')" class="btn-excluir-custo text-red-500 hover:text-red-400 transition ml-2 text-lg font-bold">&times;</button>`
                        : '';

                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-slate-200">${custo.descricao}</span>
                            <span class="text-xs text-slate-400 block">${custo.categoria}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>
                            ${btnDelete}
                        </div>`;
                    listaCustos.appendChild(li);
                });
            }
        },
     

      */
        
/* // ============================================================================
        // RENDERIZADOR DE CUSTOS (FINAL - LEITURA VIA FUELSERVICE)
        // ============================================================================
        renderCustos: (jornada) => {
            const { custosContainer, litrosAbastecidosInput, valorAbastecidoInput, resumoAbastecimento, listaCustos, descricaoCustoInput, valorCustoInput, btnAdicionarCusto, kmAbastecimentoInput, btnMostrarCustos } = UIElements;
            const inputRestanteReal = document.getElementById('litrosRestantesInput');
            const labelRestanteReal = document.getElementById('label-litros-restantes');

            btnMostrarCustos.textContent = AppState.custosVisiveis 
                ? 'Ocultar Custos Di√°rios' 
                : (AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios');

            custosContainer.classList.toggle('hidden', !AppState.custosVisiveis);
            if (!AppState.custosVisiveis) return;

            const inputsDesabilitados = !AppState.isToday;
            [litrosAbastecidosInput, valorAbastecidoInput, kmAbastecimentoInput, inputRestanteReal, descricaoCustoInput, valorCustoInput, btnAdicionarCusto].forEach(el => { if(el) el.disabled = inputsDesabilitados; });

            // Inje√ß√£o de Categorias
            const formCustos = btnAdicionarCusto.parentElement;
            if (!formCustos.querySelector('#categoriaCustoVariavel')) {
                const h = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="block text-xs font-medium text-slate-400 mb-1">Categoria Custo</label><select id="categoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"><option>Alimenta√ß√£o</option><option>Ve√≠culo</option><option>Pessoal</option><option>Outro C. Vari√°vel</option></select></div><div><label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria (Opc.)</label><input id="subcategoriaCustoVariavel" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Ex: Caf√©"></div></div>`;
                formCustos.querySelector('.grid').insertAdjacentHTML('afterend', h);
            }

            const { abastecimento, outros } = jornada.custos;

            // Inputs B√°sicos
            if (document.activeElement !== litrosAbastecidosInput) litrosAbastecidosInput.value = abastecimento.litros > 0 ? String(abastecimento.litros).replace('.', ',') : '';
            if (document.activeElement !== valorAbastecidoInput) valorAbastecidoInput.value = abastecimento.valor > 0 ? Utils.formatarMoedaParaInput(abastecimento.valor) : '';
            if (kmAbastecimentoInput && document.activeElement !== kmAbastecimentoInput) {
                kmAbastecimentoInput.value = abastecimento.kmAbastecimento > 0 ? abastecimento.kmAbastecimento : (Math.round(AppState.gpsCurrentOdometer) || '');
            }

            // LEITURA INTELIGENTE DO CAMPO PAINEL/TANQUE
            if (inputRestanteReal) {
                const config = AppState.configuracoes || {};
                const modo = config.metodoLeituraCombustivel || 'nivel';
                const ultimoDado = FuelService.getUltimoRegistro(jornada);
                
                let valorParaMostrar = 0;
                let labelTexto = '';
                let placeholderTexto = '';

                if (modo === 'consumo') {
                    labelTexto = 'Consumo Painel (Km/L)';
                    placeholderTexto = "Ex: 12,5";
                    if (ultimoDado) valorParaMostrar = ultimoDado.painel > 0 ? ultimoDado.painel : ultimoDado.tanque;
                } else {
                    labelTexto = 'Restante no Tanque (L)';
                    placeholderTexto = "Ex: 5,0";
                    if (ultimoDado) valorParaMostrar = ultimoDado.tanque > 0 ? ultimoDado.tanque : ultimoDado.painel;
                }

                if (labelRestanteReal) labelRestanteReal.textContent = labelTexto;
                inputRestanteReal.placeholder = placeholderTexto;

                if (document.activeElement !== inputRestanteReal) {
                    inputRestanteReal.value = valorParaMostrar > 0 ? String(valorParaMostrar).replace('.', ',') : '';
                }
            }

            // Resumo
            const mediaKmPorLitro = abastecimento.mediaCalculada || 0;
            const precoPorLitro = abastecimento.litros > 0 ? abastecimento.valor / abastecimento.litros : 0;
            
            let resumoHTML = `<div class="space-y-1">`;
            if (precoPorLitro > 0) resumoHTML += `<div>Pre√ßo/Litro: <span class="font-bold text-white">${Utils.formatarMoeda(precoPorLitro)}</span></div>`;
            if (mediaKmPorLitro > 0) resumoHTML += `<div>M√©dia Real: <span class="font-bold text-cyan-300">${mediaKmPorLitro.toFixed(2)} km/L</span></div>`;
            
            resumoHTML += `<div class="mt-3 pt-2 border-t border-slate-700/50"><button id="btn-abrir-gestao-combustivel" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95 flex items-center justify-center gap-2"><span class="text-xl">‚õΩ</span> Gest√£o de Combust√≠vel</button></div>`;
            resumoAbastecimento.innerHTML = resumoHTML;

            setTimeout(() => {
                const btn = document.getElementById('btn-abrir-gestao-combustivel');
                if (btn) {
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const inpRes = document.getElementById('litrosRestantesInput');
                        const dadosAtuais = {
                            litros: litrosAbastecidosInput.value,
                            valor: valorAbastecidoInput.value,
                            km: kmAbastecimentoInput ? kmAbastecimentoInput.value : '',
                            leitura: inpRes ? inpRes.value : ''
                        };
                        UIRenderer.abrirModal('gestaoCombustivel', dadosAtuais);
                    };
                }
            }, 0);
// Listener Adicionar Custo (BLINDADO CONTRA DUPLO CLIQUE)
            btnAdicionarCusto.onclick = async (e) => {
                e.preventDefault();
                
                // 1. Bloqueio Imediato
                if (btnAdicionarCusto.hasAttribute('data-processing')) return;
                btnAdicionarCusto.setAttribute('data-processing', 'true');
                btnAdicionarCusto.disabled = true;
                const textoOriginal = btnAdicionarCusto.innerHTML;
                btnAdicionarCusto.innerHTML = '<span class="animate-spin">‚Üª</span> ...';

                try {
                    const desc = descricaoCustoInput.value.trim();
                    const val = Utils.parseMoeda(valorCustoInput.value);
                    const catSelect = document.getElementById('categoriaCustoVariavel');
                    const subInput = document.getElementById('subcategoriaCustoVariavel');
                    const categoria = catSelect ? catSelect.value : 'Outros';
                    const subcategoria = subInput ? subInput.value.trim() : '';

                    if (!desc || val <= 0) throw new Error("Preencha descri√ß√£o e valor.");

                    // Adiciona ao FuelService/Jornada
                    if (!jornada.custos.outros) jornada.custos.outros = [];
                    
                    const novoCusto = {
                        id: crypto.randomUUID(),
                        descricao: desc,
                        valor: val,
                        categoria: categoria,
                        subcategoria: subcategoria,
                        timestamp: Date.now()
                    };

                    jornada.custos.outros.push(novoCusto);
                    
                    // Cria transa√ß√£o financeira correspondente (Sai da Carteira por padr√£o)
                    const txId = crypto.randomUUID();
                    const transacao = {
                        id: txId,
                        data: Date.now(),
                        tipo: 'saida',
                        valor: val,
                        contaId: 'AUTO_ID_CARTEIRA', // Assume dinheiro do dia
                        categoria: categoria,
                        descricao: desc,
                        jornadaId: Utils.formatarDataParaChave(new Date()),
                        isCustoOperacional: true
                    };
                    
                    // Atualiza saldo da carteira (Permite negativo aqui pois √© custo operacional do dia)
                    const carteira = AppState.configuracoes.contasBancarias.find(c => c.id === 'AUTO_ID_CARTEIRA');
                    if(carteira) carteira.saldo = Utils.Money.subtract(carteira.saldo, val);
                    
                    if(!AppState.historicoTransacoes) AppState.historicoTransacoes = [];
                    AppState.historicoTransacoes.push(transacao);

                    Storage.salvarJornadas();
                    Storage.salvarConfiguracoes();
                    if(Storage.salvarHistoricoTransacoes) Storage.salvarHistoricoTransacoes();

                    // Limpa campos
                    descricaoCustoInput.value = '';
                    valorCustoInput.value = '';
                    if(subInput) subInput.value = '';
                    descricaoCustoInput.focus();

                    UIRenderer.render(); // Re-renderiza para mostrar na lista
                    
                } catch (err) {
                    alert(err.message);
                } finally {
                    // Libera o bot√£o ap√≥s 500ms (evita clique fantasma)
                    setTimeout(() => {
                        if(btnAdicionarCusto) {
                            btnAdicionarCusto.removeAttribute('data-processing');
                            btnAdicionarCusto.disabled = false;
                            btnAdicionarCusto.innerHTML = textoOriginal;
                        }
                    }, 500);
                }
            };  

      // Lista
            listaCustos.innerHTML = '';
            if (outros.length === 0) {
                listaCustos.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhum outro custo adicionado.</li>`;
            } else {
                outros.forEach(custo => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm';
                    li.innerHTML = `<div><span>${custo.descricao}</span><span class="text-xs text-slate-400 block">${custo.categoria}</span></div><div class="flex items-center gap-3"><span class="font-bold text-red-400">-${Utils.formatarMoeda(custo.valor)}</span>${AppState.isToday ? `<button data-id="${custo.id}" class="btn-excluir-custo text-red-500 hover:text-red-400 transition">&times;</button>` : ''}</div>`;
                    listaCustos.appendChild(li);
                });
            }
        }, 
        
 */
 // ============================================================================
// DASHBOARD V8.1 - "THE SURGEON" (ATUALIZA√á√ÉO POR ID)
// ============================================================================

// 1. FUN√á√ÉO MESTRE (Chame esta no seu TimeManager/UIRenderer)
renderResumoDia: (jornada) => {
    // Se n√£o tem nada, cria objeto vazio seguro
    if (!jornada) jornada = { custos: {}, metas: {} };
    if (!jornada.custos) jornada.custos = {};

    // Verifica se a estrutura HTML j√° existe na tela
    const container = document.getElementById('resumoDia');
    if (!container) return;

    // SE N√ÉO TIVER O ESQUELETO, CONSTR√ìI (Roda 1 vez)
    if (!document.getElementById('dash-is-ready')) {
        UIRenderer._construirEsqueletoDashboard(container);
    }

    // SEMPRE ATUALIZA OS VALORES (Roda a cada segundo)
    UIRenderer._atualizarValoresDashboard(jornada);
},

// 2. O CONSTRUTOR (HTML EST√ÅTICO COM IDs)
_construirEsqueletoDashboard: (container) => {
    console.log("üèóÔ∏è Construindo Dashboard Fixo...");
    container.innerHTML = `
        <input type="hidden" id="dash-is-ready" value="true">
        
        <div class="grid grid-cols-4 sm:grid-cols-4 gap-4 text-sm sm:text-base mb-3">
            <div><span class="block text-slate-400">Ganhos Finalizados</span><span id="val-ganhos-fin" class="font-bold text-green-400 text-lg">R$ 0,00</span></div>
            <div><span class="block text-slate-400">Ganhos Pendentes</span><span id="val-ganhos-pend" class="font-bold text-amber-400 text-lg">R$ 0,00</span></div>
            <div><span class="block text-slate-400">Tempo L√≠quido</span><span id="val-tempo-liq" class="font-bold text-lg">00:00:00</span></div>
            <div><span class="block text-slate-400">Tempo em Pausa</span><span id="val-tempo-pausa" class="font-bold text-lg">00:00:00</span></div>
        </div>

        <div class="mt-4 text-center p-3 bg-slate-800 rounded-lg">
            <span class="text-slate-400 block">Seu Lucro L√≠quido do dia √©:</span>
            <span id="val-lucro-real" class="font-bold text-2xl text-white">R$ 0,00</span>
            <p class="text-xs text-slate-500 mt-1">(Ganhos Brutos - Custos Operacionais Totais)</p>
        </div>

        <div class="border-t border-slate-700 pt-3 mt-3">
            <h4 class="text-base font-semibold text-slate-300 mb-3 text-center">Metas e Desempenho do Dia</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div id="card-meta-1" class="bg-slate-800/50 p-3 rounded-lg text-center transition-all">
                    <span class="block text-slate-400 text-xs sm:text-sm">1. Cobrir Custos</span>
                    <span id="val-meta-1-alvo" class="font-bold text-lg text-orange-400">R$ 0,00</span>
                    <p id="txt-meta-1-status" class="text-xs mt-1 text-slate-500">...</p>
                </div>
                <div id="card-meta-2" class="bg-slate-800/50 p-3 rounded-lg text-center transition-all">
                    <span class="block text-slate-400 text-xs sm:text-sm">2. Garantir Pr√≥-labore</span>
                    <span id="val-meta-2-alvo" class="font-bold text-lg text-amber-400">R$ 0,00</span>
                    <p id="txt-meta-2-status" class="text-xs mt-1 text-slate-500">...</p>
                </div>
                <div id="card-meta-3" class="bg-slate-800/50 p-3 rounded-lg text-center transition-all">
                    <span class="block text-slate-400 text-xs sm:text-sm">3. Meta de Ganhos</span>
                    <span id="val-meta-3-alvo" class="font-bold text-lg text-cyan-400">R$ 0,00</span>
                    <p id="txt-meta-3-status" class="text-xs mt-1 text-slate-500">...</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm text-center pt-3 mt-3 border-slate-700/50">
                <div><span class="block text-slate-400">KM Total</span><span id="val-km-total" class="font-bold text-white text-lg">0 km</span></div>
                <div><span class="block text-slate-400">KM Produtivo</span><span id="val-km-prod" class="font-bold text-green-400 text-lg">0 km</span></div>
                <div><span class="block text-slate-400">KM Lata</span><span id="val-km-lata" class="font-bold text-amber-400 text-lg">0 km</span></div>
                <div><span class="block text-slate-400">KM Otimizado</span><span id="val-km-otim" class="font-bold text-cyan-400 text-lg">0 km</span></div>
            </div>
        </div>

        <div class="border-t border-slate-700 pt-3 mt-3">
            <h4 class="text-sm font-semibold text-slate-300 mb-2">Desempenho por Hora</h4>
            <div class="grid grid-cols-2 gap-4 text-sm sm:text-base">
                <div><span class="block text-slate-400">M√©dia Geral (Dia)</span><span id="val-media-dia" class="font-bold text-cyan-400 text-lg">R$ 0,00/h</span></div>
                <div><span class="block text-slate-400">M√©dia Geral (Hist.)</span><span id="val-media-hist" class="font-bold text-violet-400 text-lg">R$ 0,00/h</span></div>
            </div>
            <div class="mt-3 text-xs">
                <p class="font-semibold mb-1 text-slate-300">Valor/Hora M√≠nimo</p>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><span class="block text-orange-400">Custos</span><b id="val-hora-custo" class="text-white">R$ 0,00/h</b></div>
                    <div><span class="block text-amber-400">Pr√≥-L.</span><b id="val-hora-prolabore" class="text-white">R$ 0,00/h</b></div>
                    <div><span class="block text-cyan-400">Meta</span><b id="val-hora-meta" class="text-white">R$ 0,00/h</b></div>
                </div>
            </div>
        </div>

        <div id="bloco-analise-km" class="border-t border-slate-700 pt-3 mt-3 hidden">
            <h4 class="text-base font-semibold text-slate-300 mb-2">An√°lise de Quilometragem</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-center mt-3 pt-3 border-slate-700/50">
                <div><span class="block text-slate-400">Ganho Bruto/KM</span><span id="val-perkm-bruto" class="font-bold text-green-400 text-lg">R$ 0,00</span></div>
                <div><span class="block text-slate-400">Ganho L√≠quido/KM</span><span id="val-perkm-liq" class="font-bold text-cyan-400 text-lg">R$ 0,00</span></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-center mt-3 pt-3 border-slate-700/50">
                <div><span class="block text-slate-400">Custo Op./KM</span><span id="val-perkm-custo" class="font-bold text-orange-400 text-lg">R$ 0,00</span></div>
                <div>
                    <span class="block text-slate-400" id="lbl-consumo-unidade">M√©dia Consumo</span>
                    <span id="val-consumo-medio" class="font-bold text-slate-500 text-lg">--</span>
                    <span id="val-consumo-diff" class="text-xs hidden"></span>
                </div>
            </div>
        </div>
    `;
},

// ============================================================================
// ATUALIZADOR DE VALORES (V160 - FIX: SYNC LIVE DATA)
// ============================================================================
_atualizarValoresDashboard: (jornadaInput) => {
    
    // --- 1. SINCRONIA VITAL (O PULO DO GATO üêà) ---
    // Ignora o parametro de entrada se tivermos uma jornada ativa na mem√≥ria.
    // Isso garante que peguemos a corrida de R$ 30,00 que acabou de ser salva.
    let jornada = jornadaInput;
    
    if (AppState.jornadaAtiva && AppState.jornadaAtiva.status !== 'finalizada') {
        jornada = AppState.jornadaAtiva; 
    } else if (!jornada) {
        jornada = { custos: {}, metas: {} };
    }

    // 2. Recalcula tudo com dados fresquinhos
    const agora = Date.now();
    const resumo = BusinessLogic.calcularResumoDia(jornada, agora);
    const mediaHistoricaGeral = BusinessLogic.calcularMediaHistoricaGeral();

    // Helper pra atualizar texto
    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    const setHtml = (id, val) => { const el = document.getElementById(id); if(el) el.innerHTML = val; };
    const setClass = (id, cls) => { const el = document.getElementById(id); if(el) el.className = cls; };

    // --- A. VALORES PRINCIPAIS ---
    // Agora 'resumo.totalGanhosFinalizados' vai ter os R$ 30,00
    setTxt('val-ganhos-fin', Utils.formatarMoeda(resumo.totalGanhosFinalizados || resumo.totalGanhos || 0));
    setTxt('val-ganhos-pend', Utils.formatarMoeda(resumo.totalGanhosPendentes || 0));
    
    // Tempos
    const duracaoLiq = (typeof resumo.tempoLiquido !== 'undefined') ? resumo.tempoLiquido : (jornada.tempoLiquido || 0);
    const duracaoPausa = jornada.tempoPausaTotal || resumo.totalTempoPausa || 0;
    
    setTxt('val-tempo-liq', Utils.formatarDuracao(duracaoLiq));
    setTxt('val-tempo-pausa', Utils.formatarDuracao(duracaoPausa));

    // Lucro Real (Com Cor Din√¢mica)
    const lucro = resumo.lucroReal || resumo.lucroLiquido || (resumo.totalGanhos - resumo.totalCustos);
    setTxt('val-lucro-real', Utils.formatarMoeda(lucro));
    const corLucro = lucro >= 0 ? 'text-green-300' : 'text-red-400';
    setClass('val-lucro-real', `font-bold text-2xl ${corLucro}`);

    // --- B. METAS ---
    const meta1 = (resumo.custoVariavelTotal || 0) + (resumo.custoFixoOperacionalDiario || 0);
    const meta2 = meta1 + (resumo.custoProLaboreDiario || 0);
    const meta3 = resumo.custoMetaAutonomaDiaria || 0;
    const ganhos = resumo.totalGanhosFinalizados || 0;

    const prog1 = ganhos - meta1;
    const prog2 = ganhos - meta2;
    const prog3 = ganhos - meta3;

    // Atualiza Alvos
    setTxt('val-meta-1-alvo', Utils.formatarMoeda(meta1));
    setTxt('val-meta-2-alvo', Utils.formatarMoeda(meta2));
    setTxt('val-meta-3-alvo', Utils.formatarMoeda(meta3));

    // Atualiza Status
    const renderStatus = (progresso, isLocked) => {
        if(isLocked) return `<span class="text-slate-500">Atingir meta anterior</span>`;
        const txt = progresso >= 0 ? 'Superado' : 'Faltam';
        const cor = progresso >= 0 ? 'text-green-300' : 'text-red-400';
        return `<span class="text-slate-500">${txt}:</span> <b class="${cor}">${Utils.formatarMoeda(Math.abs(progresso))}</b>`;
    };

    setHtml('txt-meta-1-status', renderStatus(prog1, false));
    setHtml('txt-meta-2-status', renderStatus(prog2, prog1 < 0)); // Bloqueia se meta 1 n√£o batida
    setHtml('txt-meta-3-status', renderStatus(prog3, prog2 < 0 && meta3 > 0));

    // Highlight Cards (Efeito Visual)
    ['card-meta-1', 'card-meta-2', 'card-meta-3'].forEach(id => document.getElementById(id)?.classList.remove('active', 'card-simple-pulse-blue'));
    if (prog1 < 0) document.getElementById('card-meta-1')?.classList.add('active', 'card-simple-pulse-blue');
    else if (prog2 < 0) document.getElementById('card-meta-2')?.classList.add('active', 'card-simple-pulse-blue');
    else if (meta3 > 0 && prog3 < 0) document.getElementById('card-meta-3')?.classList.add('active', 'card-simple-pulse-blue');

    // --- C. KM ---
    setTxt('val-km-total', Utils.formatarDistancia(resumo.kmTotal));
    setTxt('val-km-prod', Utils.formatarDistancia(resumo.kmProdutivo));
    setTxt('val-km-lata', Utils.formatarDistancia(resumo.kmLata));
    setTxt('val-km-otim', Utils.formatarDistancia(resumo.kmOtimizado));

    // --- D. M√âDIAS ---
    setTxt('val-media-dia', `${Utils.formatarMoeda(resumo.mediaHoraDia || resumo.ganhoPorHora)}/h`);
    setTxt('val-media-hist', `${Utils.formatarMoeda(mediaHistoricaGeral)}/h`);

    // Metas Hora
    const divisorHoras = jornada.metaHoras || 1;
    setTxt('val-hora-custo', `${Utils.formatarMoeda(meta1 / divisorHoras)}/h`);
    setTxt('val-hora-prolabore', `${Utils.formatarMoeda(meta2 / divisorHoras)}/h`);
    setTxt('val-hora-meta', `${Utils.formatarMoeda((meta3 || meta2) / divisorHoras)}/h`);

    // --- E. AN√ÅLISE KM (Visibilidade) ---
    const blocoKm = document.getElementById('bloco-analise-km');
    if (resumo.kmTotal > 0) {
        if(blocoKm) blocoKm.classList.remove('hidden');
        
        setTxt('val-perkm-bruto', Utils.formatarMoedaPorKm(resumo.ganhoBrutoPorKm));
        setTxt('val-perkm-liq', Utils.formatarMoedaPorKm((resumo.ganhoBrutoPorKm || 0) - (resumo.custoOperacionalPorKm || 0)));
        setTxt('val-perkm-custo', Utils.formatarMoedaPorKm(resumo.custoOperacionalPorKm));

        // Consumo
        const { veiculo } = AppState.configuracoes;
        if(veiculo) {
            const unidade = Utils.formatarEficiencia(0, veiculo.combustivel).split(' ')[1];
            setTxt('lbl-consumo-unidade', `M√©dia Consumo (${unidade})`);

            if (resumo.mediaConsumoDia > 0) {
                setTxt('val-consumo-medio', resumo.mediaConsumoDia.toFixed(2));
                setClass('val-consumo-medio', 'font-bold text-cyan-400 text-lg');
                
                const elDiff = document.getElementById('val-consumo-diff');
                if (elDiff && veiculo.autonomia > 0) {
                    const diff = resumo.mediaConsumoDia - veiculo.autonomia;
                    const texto = (diff >= -0.05) ? `+${diff.toFixed(1)}` : `${diff.toFixed(1)}`;
                    const cor = (diff >= -0.05) ? 'text-green-400' : 'text-red-400';
                    elDiff.innerHTML = `<span class="font-bold ${cor}">(${texto} vs. padr√£o)</span>`;
                    elDiff.classList.remove('hidden');
                }
            }
        }
    } else {
        if(blocoKm) blocoKm.classList.add('hidden');
    }
},

 /*
renderResumoDia: (jornada) => {
        // 1. üõ°Ô∏è TRAVA INICIAL: Se n√£o houver jornada, n√£o tenta renderizar ou usa objeto vazio seguro
            if (!jornada) jornada = { custos: {}, metas: {} };
            if (!jornada.custos) jornada.custos = {};

            UIRenderer.renderBotaoAlternarModo(jornada);
            const resumo = BusinessLogic.calcularResumoDia(jornada, AppState.dataSelecionada);
            const mediaHistoricaGeral = BusinessLogic.calcularMediaHistoricaGeral();
            const { 
                totalGanhosFinalizados, totalGanhosPendentes, tempoLiquido, duracaoPausas,
                kmTotal, kmProdutivo, kmLata, kmOtimizado,
                custoVariavelTotal, custoFixoOperacionalDiario, custoOperacionalTotal, lucroReal,
                ganhoBrutoPorKm, custoOperacionalPorKm, mediaHoraDia, mediaConsumoDia, // <-- ETAPA 5 (NOVO)
                custoProLaboreDiario, custoMetaAutonomaDiaria
            } = resumo;

            // --- ETAPA 5: L√≥gica de KmL/kWh (NOVO) ---
            const { veiculo } = AppState.configuracoes;
            const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
            const autonomiaConfig = veiculo.autonomia || 0;
            const unidadeEficiencia = Utils.formatarEficiencia(0, tipoCombustivel).split(' ')[1]; // km/L ou km/kWh
            let desempenhoKmLHTML = '';

            if (mediaConsumoDia > 0) {
                let comparacaoHTML = '';
                if (autonomiaConfig > 0) {
                    const diff = mediaConsumoDia - autonomiaConfig;
                    const diffTexto = (diff >= -0.05) ? `+${diff.toFixed(1)}` : `${diff.toFixed(1)}`;
                    const corDiff = (diff >= -0.05) ? 'text-green-400' : 'text-red-400';
                    comparacaoHTML = `<span class="font-bold ${corDiff}">(${diffTexto} vs. padr√£o)</span>`;
                }
                
                desempenhoKmLHTML = `
                    <div>
                        <span class="block text-slate-400">M√©dia Consumo (${unidadeEficiencia})</span>
                        <span class="font-bold text-cyan-400 text-lg">${mediaConsumoDia.toFixed(2)}</span>
                        <span class="text-xs ${comparacaoHTML ? '' : 'hidden'}">${comparacaoHTML}</span>
                    </div>
                `;
            } else {
                desempenhoKmLHTML = `
                    <div>
                        <span class="block text-slate-400">M√©dia Consumo (${unidadeEficiencia})</span>
                        <span class="font-bold text-slate-500 text-lg">--</span>
                    </div>
                `;
            }
            // --- FIM DA L√ìGICA KmL ---

            const ganhoLiquidoPorKm = ganhoBrutoPorKm - custoOperacionalPorKm;
            const metaBreakeven = custoVariavelTotal + custoFixoOperacionalDiario;
            const metaSalario = metaBreakeven + custoProLaboreDiario;
            const metaGanhosFinal = custoMetaAutonomaDiaria;

            const progressoBreakeven = totalGanhosFinalizados - metaBreakeven;
            const progressoSalario = totalGanhosFinalizados - metaSalario;
            const progressoGanhosFinal = totalGanhosFinalizados - metaGanhosFinal;

            const renderMetaCard = (id, titulo, valorMeta, valorProgresso, corValorMeta) => {
                if (valorMeta <= 0 && titulo !== '1. Cobrir Custos') return '';
                const statusTexto = valorProgresso >= 0 ? 'Superado' : 'Faltam';
                const corProgresso = valorProgresso >= 0 ? 'text-green-300' : 'text-red-400';
                let isDisabled = false;
                if ((titulo === '2. Garantir Pr√≥-labore' && progressoBreakeven < 0) || (titulo === '3. Meta de Ganhos do Dia' && valorMeta > 0 && progressoSalario < 0)) {
                    isDisabled = true;
                }
                return `
                    <div id="${id}" class="bg-slate-800/50 p-3 rounded-lg text-center transition-all ${isDisabled ? 'opacity-50' : ''}">
                        <span class="block text-slate-400 text-xs sm:text-sm">${titulo}</span>
                        <span class="font-bold text-lg ${corValorMeta}">${Utils.formatarMoeda(valorMeta)}</span>
                        <p class="text-xs mt-1">
                            ${isDisabled ? 
                            `<span class="text-slate-500">Atingir meta anterior</span>` :
                            `<span class="text-slate-500">${statusTexto}:</span>
                            <b class="${corProgresso}">${Utils.formatarMoeda(Math.abs(valorProgresso))}</b>`
                            }
                        </p>
                    </div>
                `;
            };

            // 2. üõ°Ô∏è CORRE√á√ÉO DO ERRO DE ABASTECIMENTO
                const abastecimentoDoDia = jornada?.custos?.abastecimento; // Usa ?. para n√£o travar
                const autonomiaPrevista = (abastecimentoDoDia && abastecimentoDoDia.litros > 0 && autonomiaConfig > 0) 
                    ? abastecimentoDoDia.litros * autonomiaConfig 
                    : 0;

            let metasKmHTML = '';
            if (autonomiaPrevista > 0) {
                const meta1 = custoOperacionalTotal;
                const meta2 = meta1 + custoProLaboreDiario;
                const meta3 = custoMetaAutonomaDiaria > 0 ? custoMetaAutonomaDiaria : meta2;
                metasKmHTML = `
                    <div class="mt-3 text-xs">
                        <p class="font-semibold mb-1 text-slate-300">
                            Valor/KM M√≠nimo (Baseado no Abastecimento)
                        </p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <span class="block text-orange-400">Custos</span>
                                <b class="text-white">${Utils.formatarMoedaPorKm(meta1 / autonomiaPrevista)}</b>
                            </div>
                            <div>
                                <span class="block text-amber-400">Pr√≥-L.</span>
                                <b class="text-white">${Utils.formatarMoedaPorKm(meta2 / autonomiaPrevista)}</b>
                            </div>
                            <div>
                                <span class="block text-cyan-400">Meta</span>
                                <b class="text-white">${Utils.formatarMoedaPorKm(meta3 > 0 ? meta3 / autonomiaPrevista : 0)}</b>
                            </div>
                        </div>
                    </div>
                `;
            }

            let metasPorHoraHTML = '';
            if (jornada.metaHoras > 0) {
                const metaSalarioHora = metaSalario / jornada.metaHoras;
                const metaGanhosHora = metaGanhosFinal > 0 ? metaGanhosFinal / jornada.metaHoras : metaSalarioHora;
                metasPorHoraHTML = `
                    <div class="mt-3 text-xs">
                        <p class="font-semibold mb-1 text-slate-300">
                            Valor/Hora M√≠nimo (Baseado no Hor√°rio Di√°rio Definido)
                        </p>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <span class="block text-orange-400">Custos</span>
                                <b class="text-white">${Utils.formatarMoeda(metaBreakeven / jornada.metaHoras)}/h</b>
                            </div>
                            <div>
                                <span class="block text-amber-400">Pr√≥-L.</span>
                                <b class="text-white">${Utils.formatarMoeda(metaSalarioHora)}/h</b>
                            </div>
                            <div>
                                <span class="block text-cyan-400">Meta</span>
                                <b class="text-white">${Utils.formatarMoeda(metaGanhosHora)}/h</b>
                            </div>
                        </div>
                    </div>
                `;
            }

            UIElements.resumoDia.innerHTML = `
                <div class="grid grid-cols-4 sm:grid-cols-4 gap-4 text-sm sm:text-base mb-3">
                    <div><span class="block text-slate-400">Ganhos Finalizados</span><span class="font-bold text-green-400 text-lg">${Utils.formatarMoeda(totalGanhosFinalizados)}</span></div>
                    <div><span class="block text-slate-400">Ganhos Pendentes</span><span class="font-bold text-amber-400 text-lg">${Utils.formatarMoeda(totalGanhosPendentes)}</span></div>
                    <div><span class="block text-slate-400">Tempo L√≠quido</span><span class="font-bold text-lg">${Utils.formatarDuracao(tempoLiquido)}</span></div>
                    <div><span class="block text-slate-400">Tempo em Pausa</span><span class="font-bold text-lg">${Utils.formatarDuracao(duracaoPausas)}</span></div>
                </div>
                <div class="mt-4 text-center p-3 bg-slate-800 rounded-lg">
                    <span class="text-slate-400 block">Seu Lucro L√≠quido do dia √©:</span>
                    <span class="font-bold text-2xl ${lucroReal >= 0 ? 'text-green-300' : 'text-red-400'}">${Utils.formatarMoeda(lucroReal)}</span>
                    <p class="text-xs text-slate-500 mt-1">(Ganhos Brutos - Custos Operacionais Totais)</p>
                </div>
                <div class="border-t border-slate-700 pt-3 mt-3">
                    <h4 class="text-base font-semibold text-slate-300 mb-3 text-center">Metas e Desempenho do Dia</h4>
                    <p class="text-xs text-slate-500 text-center -mt-3 mb-3">(Custo Operacional agora inclui suas Metas Financeiras/D√≠vidas)</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        ${renderMetaCard('metaCard1', '1. Cobrir Custos', metaBreakeven, progressoBreakeven, 'text-orange-400')}
                        ${renderMetaCard('metaCard2', '2. Garantir Pr√≥-labore', metaSalario, progressoSalario, 'text-amber-400')}
                        ${renderMetaCard('metaCard3', '3. Meta de Ganhos do Dia', metaGanhosFinal, progressoGanhosFinal, 'text-cyan-400')}
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm text-center pt-3 mt-3 border-slate-700/50">
                        <div><span class="block text-slate-400">KM Total</span><span class="font-bold text-white text-lg">${Utils.formatarDistancia(kmTotal)}</span></div>
                        <div><span class="block text-slate-400">KM Produtivo</span><span class="font-bold text-green-400 text-lg">${Utils.formatarDistancia(kmProdutivo)}</span></div>
                        <div><span class="block text-slate-400">KM Lata</span><span class="font-bold text-amber-400 text-lg">${Utils.formatarDistancia(kmLata)}</span></div>
                        <div><span class="block text-slate-400">KM Otimizado</span><span class="font-bold text-cyan-400 text-lg">${Utils.formatarDistancia(kmOtimizado)}</span></div>
                    </div>
                </div>

                <div class="border-t border-slate-700 pt-3 mt-3">
                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Desempenho por Hora</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm sm:text-base">
                       <div><span class="block text-slate-400">M√©dia Geral (Dia)</span><span class="font-bold text-cyan-400 text-lg">${Utils.formatarMoeda(mediaHoraDia)}/h</span></div>
                       <div><span class="block text-slate-400">M√©dia Geral (Hist.)</span><span class="font-bold text-violet-400 text-lg">${Utils.formatarMoeda(mediaHistoricaGeral)}/h</span></div>
                    </div>
                    ${metasPorHoraHTML}
                </div>

                ${kmTotal > 0 ? `
                <div class="border-t border-slate-700 pt-3 mt-3">
                    <h4 class="text-base font-semibold text-slate-300 mb-2">An√°lise de Quilometragem</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-center mt-3 pt-3 border-slate-700/50">
                        <div><span class="block text-slate-400">Ganho Bruto/KM</span><span class="font-bold text-green-400 text-lg">${Utils.formatarMoedaPorKm(ganhoBrutoPorKm)}</span></div>
                        <div><span class="block text-slate-400">Ganho L√≠quido/KM</span><span class="font-bold text-cyan-400 text-lg">${Utils.formatarMoedaPorKm(ganhoLiquidoPorKm)}</span></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-center mt-3 pt-3 border-slate-700/50">
                        <div><span class="block text-slate-400">Custo Op./KM</span><span class="font-bold text-orange-400 text-lg">${Utils.formatarMoedaPorKm(custoOperacionalPorKm)}</span></div>
                        ${desempenhoKmLHTML}
                    </div>
                    ${metasKmHTML}
                </div>
                ` : ''}
            `;

            const metaCard1 = document.getElementById('metaCard1');
            const metaCard2 = document.getElementById('metaCard2');
            const metaCard3 = document.getElementById('metaCard3');
            [metaCard1, metaCard2, metaCard3].forEach(card => card?.classList.remove('active', 'card-simple-pulse-blue'));

            if (progressoBreakeven < 0) {
                metaCard1?.classList.add('active', 'card-simple-pulse-blue');
            } else if (progressoSalario < 0) {
                metaCard2?.classList.add('active', 'card-simple-pulse-blue');
            } else if (metaGanhosFinal > 0 && progressoGanhosFinal < 0) {
                metaCard3?.classList.add('active', 'card-simple-pulse-blue');
            }
        },
  */      
        
        renderAlertasJornada: (jornada) => {
            const { listaAlertasJornada } = UIElements;
            const accordion = document.getElementById('maintenanceAlertAccordion');
            const summary = document.getElementById('maintenanceAlertSummary');
            
            if (!accordion || !summary || !listaAlertasJornada) return; 

            // 1. Obter o KM atual (o maior entre inicial e final)
            const kmFinal = parseFloat(jornada.kmFinal) || 0;
            const kmInicial = parseFloat(jornada.kmInicial) || 0;
            const odometroAtual = kmFinal > kmInicial ? kmFinal : kmInicial;

            // 2. Calcular a Sa√∫de
            const { itens } = BusinessLogic.calcularSaudeVeiculo(odometroAtual);

            // 3. Filtrar apenas itens Vencidos ou em Aten√ß√£o
            const alertasUrgentes = itens.filter(item => item.status === 'Vencido' || item.status === 'Aten√ß√£o');

            if (alertasUrgentes.length === 0) {
                accordion.classList.add('hidden');
                AppState.alertaManutencaoVistoHoje = false; // Reseta o status de "visto" para o pr√≥ximo dia
                return; // Esconde se estiver tudo em dia e sai da fun√ß√£o
            }

            // 4. Mostrar o painel e construir a lista
            accordion.classList.remove('hidden');
            listaAlertasJornada.innerHTML = '';

            // Pega apenas os 3 mais urgentes para n√£o poluir a tela
            alertasUrgentes.slice(0, 3).forEach(item => {
                const isVencido = item.status === 'Vencido';
                const corIcone = isVencido ? 'text-red-400' : 'text-amber-300';

                // Recupera a observa√ß√£o do item original, caso exista
                const itemOriginal = AppState.configuracoes.planoManutencao.find(p => p.id === item.id);
                const obsTexto = itemOriginal ? itemOriginal.observacao : '';
                const obsHTML = obsTexto 
                    ? `<p class="text-xs text-red-300 italic mt-1">‚ö†Ô∏è ${obsTexto}</p>` 
                    : '';

                const li = document.createElement('li');
                
                // Passo 4.B: Adiciona o fundo escuro (bg-slate-800)
                li.className = 'flex items-start gap-3 p-2 bg-slate-800 rounded-md mb-2'; 

                li.innerHTML = `
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${corIcone} flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.332-.213 3.03-1.742 3.03H4.42c-1.53 0-2.493-1.698-1.742-3.03l5.58-9.92zM10 13a1 1 0 100-2 1 1 0 000 2zm-1-3a1 1 0 001 1h.01a1 1 0 100-2H10a1 1 0 00-1 1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <span class="font-semibold ${isVencido ? 'text-red-400' : 'text-amber-300'}">${item.status}:</span>
                        <span class="text-slate-200">${item.descricao}</span>
                        ${obsHTML}
                    </div>
                `;
                listaAlertasJornada.appendChild(li);
            });
            
            // 5. Controlar a Anima√ß√£o de Pulso (L√≥gica Restaurada)
            accordion.classList.remove('pulse-fast', 'pulse-slow');
            
            if (AppState.alertaManutencaoVistoHoje) {
                // Se j√° foi visto (clicado), pulsa lento (sutil)
                accordion.classList.add('pulse-slow');
            } else {
                // Se ainda n√£o foi visto, pulsa r√°pido (chama aten√ß√£o)
                accordion.classList.add('pulse-fast');
            }

            // 6. Adicionar o listener para parar o pulso r√°pido ao clicar
            // Usa uma flag 'listenerAdded' no elemento DOM para evitar adicionar m√∫ltiplos eventos iguais
            if (!summary.listenerAdded) {
                summary.addEventListener('click', () => {
                    AppState.alertaManutencaoVistoHoje = true; // Marca como "visto"
                    accordion.classList.remove('pulse-fast'); // Remove o pulso r√°pido imediatamente
                    accordion.classList.add('pulse-slow'); // Adiciona o pulso lento
                });
                summary.listenerAdded = true; 
            }
        },
        
// ============================================================================
// RENDERIZADOR DO DRE (V136.0 - FIX VISUAL & ANTI-COLAPSO)
// ============================================================================
renderPainelFinanceiro: (jornadaInput) => {
    const container = document.getElementById('painel-financeiro-container');
    if (!container) {
        console.error("‚ùå Container do DRE n√£o encontrado!");
        return;
    }

    // üõ°Ô∏è FOR√áA A VISIBILIDADE (Corre√ß√£o do "Pisca e Some")
    container.style.display = 'block';
    container.classList.remove('hidden');

    // 1. PREPARA√á√ÉO DE DADOS
    let rawData = jornadaInput?.data || AppState.dataSelecionada;
    let dataChave = "";
    
    // Normaliza√ß√£o de Data
    if (rawData instanceof Date) dataChave = Utils.formatarDataParaChave(rawData);
    else if (typeof rawData === 'string') dataChave = rawData.split('T')[0];
    else dataChave = new Date().toISOString().split('T')[0];

    // Busca dados
    let jornada = jornadaInput;
    if (!jornada?.ganhos) {
        jornada = AppState.jornadas[dataChave] || BusinessLogic.getJornadaDoDia(dataChave);
    }

    // Receita
    const ganhos = jornada?.ganhos || {};
    const totalReceita = (Number(ganhos.totalApp) || 0) + (Number(ganhos.totalParticular) || 0);

    // Custos Extras (Filtro Blindado)
    const listaTransacoes = AppState.historicoTransacoes || [];
    const custosFiltrados = listaTransacoes.filter(t => {
        if (!t || t.invalida || t.isAjusteInterno) return false;
        
        let tData = t.dataEconomica || t.data;
        if (typeof tData === 'number') tData = new Date(tData).toISOString().split('T')[0];
        else if (typeof tData === 'string') tData = tData.split('T')[0];

        const mesmaData = tData === dataChave;
        const mesmoID = jornada?.id && t.jornadaId === jornada.id;
        const tipo = (t.tipo || '').toLowerCase();
        const ehSaida = ['saida', 'ajuste', 'despesa', 'custo'].includes(tipo);

        return (mesmaData || mesmoID) && ehSaida;
    });

    // Modo Real vs Presumido
    window.toggleModoDRE = (e) => {
        // üõë O PULO DO GATO: Impede que o clique feche o painel
        if(e) e.stopPropagation(); 
        
        AppState.modoDRE = (AppState.modoDRE === 'presumido') ? 'real' : 'presumido';
        UIRenderer.render(); 
    };
    
    const isReal = AppState.modoDRE === 'real';
    let custosFinais = custosFiltrados;
    let valorProvisoes = 0;

    if (isReal) {
        custosFinais = custosFiltrados.filter(c => {
            const termos = ['meta', 'caixinha', 'investimento', 'reserva', 'guardar'];
            const txt = ((c.categoria||'') + (c.descricao||'')).toLowerCase();
            const ehProvisao = c.impactaResultado === false || termos.some(t => txt.includes(t));
            if (ehProvisao) valorProvisoes += (Number(c.valor)||0);
            return !ehProvisao;
        });
    }

    // Abastecimento e Totais
    let totalAbastecimento = 0;
    if (jornada?.custos?.abastecimento) {
        const abs = jornada.custos.abastecimento;
        if (Array.isArray(abs)) totalAbastecimento = abs.reduce((acc, i) => acc + (Number(i.valor)||0), 0);
        else totalAbastecimento = Number(abs.valor) || 0;
    }

    const totalCustosExtras = custosFinais.reduce((acc, c) => acc + (Number(c.valor)||0), 0);
    const totalCustos = totalAbastecimento + totalCustosExtras;
    const lucroLiquido = totalReceita - totalCustos;

    // Visual
    const corLucro = lucroLiquido >= 0 ? 'text-emerald-400' : 'text-red-400';
    const bgLucro = lucroLiquido >= 0 ? 'bg-emerald-500/10' : 'bg-red-500/10';
    const corBotao = isReal ? 'bg-blue-600' : 'bg-amber-600';
    const labelModo = isReal ? 'üìä Modo Real' : 'üëÅÔ∏è Modo Caixa';

    // 2. RENDERIZA√á√ÉO COM PROTE√á√ÉO DE CLIQUE
    container.innerHTML = `
        <div class="space-y-4 animate-fade-in" style="display: block !important;">
            
            <div class="flex flex-col items-end mb-2">
                <button 
                    onclick="window.toggleModoDRE(event)" 
                    class="${corBotao} text-white text-[10px] font-bold py-1 px-3 rounded-full shadow flex items-center gap-2"
                >
                    ${labelModo}
                </button>
            </div>

            <div class="${bgLucro} border border-slate-700 rounded-xl p-5 text-center shadow-lg relative">
                <h3 class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">Lucro L√≠quido</h3>
                <div class="text-4xl font-black ${corLucro} my-2 font-mono tracking-tight">
                    ${Utils.formatarMoeda(lucroLiquido)}
                </div>
                
                <div class="text-xs text-slate-500 mt-2 flex justify-center gap-4">
                    <span>üí∞ Bruto: <span class="text-slate-300">${Utils.formatarMoeda(totalReceita)}</span></span>
                    <span>üîª Custos: <span class="text-red-300">-${Utils.formatarMoeda(totalCustos)}</span></span>
                </div>
            </div>

            <div class="bg-slate-800/50 rounded-lg p-4 text-xs space-y-2 border border-slate-700/50">
                ${totalAbastecimento > 0 ? `
                    <div class="flex justify-between text-red-400/80">
                        <span>(-) Abastecimento</span>
                        <span>-${Utils.formatarMoeda(totalAbastecimento)}</span>
                    </div>` : ''}

                ${custosFinais.map(c => `
                    <div class="flex justify-between text-slate-400 border-b border-slate-700/30 pb-1">
                        <span>${c.descricao || c.categoria}</span>
                        <span class="text-red-400">-${Utils.formatarMoeda(c.valor)}</span>
                    </div>
                `).join('')}

                <div class="flex justify-between pt-2 font-bold text-sm border-t border-slate-700">
                    <span class="text-slate-200">(=) Resultado</span>
                    <span class="${corLucro}">${Utils.formatarMoeda(lucroLiquido)}</span>
                </div>
            </div>
        </div>
    `;
},
 /*    
        
     // ============================================================================
    // RENDERIZADOR DO DRE (V130.2 - FIX: ESTABILIDADE E DATA AT√îMICA)
    // ============================================================================
    renderPainelFinanceiro: (jornada) => {
        const container = document.getElementById('painel-financeiro-container');
        if (!container) return;

        // üõ°Ô∏è CORRE√á√ÉO 1: Fun√ß√£o global chama o render mestre para persist√™ncia
        window.toggleModoDRE = () => {
            AppState.modoDRE = (AppState.modoDRE === 'presumido') ? 'real' : 'presumido';
            UIRenderer.render(); 
        };

        const isReal = AppState.modoDRE === 'real';
        const labelModo = isReal ? 'üìä Modo Real (Cont√°bil)' : 'üëÅÔ∏è Modo Presumido (Caixa)';
        const corBotao = isReal ? 'bg-blue-600 hover:bg-blue-500' : 'bg-amber-600 hover:bg-amber-500';
        const descModo = isReal ? 'Ignora transfer√™ncias (Lucro econ√¥mico).' : 'Considera transfer√™ncias/caixinhas como Gasto.';

// 1. Receitas (Ganhos da Jornada)
// 1. Receitas - SINCRONIA TOTAL COM O RESUMO DE CIMA
        const receitas = jornada?.ganhos || {};
        
        // Se a jornada tem o totalApp e totalParticular, usamos eles (√© o que os cards de cima usam)
        const totalReceita = (receitas.totalApp || 0) + (receitas.totalParticular || 0);

        // 2. Custos - FILTRO REFINADO
        const dataJornadaChave = Utils.formatarDataParaChave(new Date(jornada.data || AppState.dataSelecionada));
        
        const custosDRE = AppState.historicoTransacoes.filter(t => {
            // Filtro rigoroso: apenas sa√≠das, operacionais e que N√ÉO sejam ajustes
            if (t.tipo !== 'saida' || !t.isCustoOperacional || t.invalida || t.isAjusteInterno) return false;

            const tDataChave = Utils.formatarDataParaChave(t.dataEconomica || t.data);
            
            // PRIORIDADE: Se a transa√ß√£o tem o ID desta jornada espec√≠fica
            if (t.jornadaId && jornada.id && t.jornadaId === jornada.id) return true;
            
            // FALLBACK: Se n√£o tem ID, mas a data √© EXATAMENTE a mesma (sem transbordar de outros dias)
            return (!t.jornadaId && tDataChave === dataJornadaChave);
        });

        // 3. Filtro de Natureza (Real vs Presumido)
        let valorProvisoesIgnoradas = 0;
        let custosFinais = custosDRE;

        if (AppState.modoDRE === 'real') {
            custosFinais = custosDRE.filter(c => {
                const termosProvisao = ['meta', 'investimento', 'poupanca', 'poupan√ßa', 'caixinha', 'reserva'];
                const catLower = (c.categoria || '').toLowerCase();
                const descLower = (c.descricao || '').toLowerCase();
                
                const ehProvisao = c.impactaResultado === false || 
                                 termosProvisao.some(t => catLower.includes(t) || descLower.includes(t));
                
                if (ehProvisao) valorProvisoesIgnoradas += c.valor;
                return !ehProvisao;
            });
        }

        const totalAbastecimento = (jornada?.custos?.abastecimento?.valor || 0);
        const totalCustosExtras = custosFinais.reduce((acc, c) => acc + c.valor, 0);
        const totalCustos = totalAbastecimento + totalCustosExtras;
        const lucroLiquido = totalReceita - totalCustos;
        
        const corLucro = lucroLiquido >= 0 ? 'text-emerald-400' : 'text-red-400';
        const bgLucro = lucroLiquido >= 0 ? 'bg-emerald-500/10' : 'bg-red-500/10';
        const borderLucro = lucroLiquido >= 0 ? 'border-emerald-500/30' : 'border-red-500/30';

        container.innerHTML = `
            <div class="space-y-4 animate-fade-in">
                <div class="flex flex-col items-end mb-2">
                    <button onclick="window.toggleModoDRE()" class="${corBotao} text-white text-[10px] font-bold py-1 px-3 rounded-full shadow transition flex items-center gap-2">
                        ${labelModo}
                    </button>
                    <span class="text-[9px] text-slate-500 mt-1 text-right">${descModo}</span>
                </div>

                <div class="${bgLucro} border ${borderLucro} rounded-xl p-5 text-center shadow-lg relative overflow-hidden">
                    <h3 class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">Lucro L√≠quido do Dia</h3>
                    <div class="text-4xl font-black ${corLucro} my-2 font-mono tracking-tight">
                        ${Utils.formatarMoeda(lucroLiquido)}
                    </div>
                    
                    <div class="text-xs text-slate-500 mt-2 flex justify-center gap-4">
                        <span>üí∞ Bruto: <span class="text-slate-300">${Utils.formatarMoeda(totalReceita)}</span></span>
                        <span>üîª Custos: <span class="text-red-300">-${Utils.formatarMoeda(totalCustos)}</span></span>
                    </div>

                    ${valorProvisoesIgnoradas > 0 ? `
                        <div class="mt-3 pt-2 border-t border-slate-700/30 text-[10px] text-cyan-400">
                            ‚ÑπÔ∏è R$ ${Utils.formatarMoeda(valorProvisoesIgnoradas)} em Provis√µes (n√£o descontados).
                        </div>
                    ` : ''}
                </div>

                <div class="bg-slate-800/50 rounded-lg p-4 text-xs space-y-2 border border-slate-700/50">
                    <div class="flex justify-between border-b border-slate-700 pb-1">
                        <span class="text-slate-400">(+) Ganhos Totais</span>
                        <span class="text-emerald-400 font-bold">${Utils.formatarMoeda(totalReceita)}</span>
                    </div>
                    
                    ${totalAbastecimento > 0 ? `
                    <div class="flex justify-between text-red-400/80">
                        <span>(-) Abastecimento</span>
                        <span>-${Utils.formatarMoeda(totalAbastecimento)}</span>
                    </div>` : ''}

                    <div class="flex justify-between text-red-400/80 border-b border-slate-700 pb-1">
                        <span>(-) Custos Vari√°veis (${isReal ? 'Real' : 'Presumido'})</span>
                        <span>-${Utils.formatarMoeda(totalCustosExtras)}</span>
                    </div>

                    <div class="flex justify-between pt-1 font-bold text-sm">
                        <span class="text-slate-200">(=) Resultado Final</span>
                        <span class="${corLucro}">${Utils.formatarMoeda(lucroLiquido)}</span>
                    </div>
                </div>
            </div>
        `;
    },   
 */       
        /*
        
 // ============================================================================
    // RENDERIZADOR DO DRE (V130.1 - FIX: INTERRUPTOR GLOBAL)
    // ============================================================================
    renderPainelFinanceiro: (jornada) => {
        const container = document.getElementById('painel-financeiro-container');
        if (!container) return;

        // --- FIX: DEFINI√á√ÉO GLOBAL DO INTERRUPTOR (Para evitar ReferenceError) ---
        window.toggleModoDRE = () => {
            AppState.modoDRE = (AppState.modoDRE === 'presumido') ? 'real' : 'presumido';
            // Re-renderiza o painel para atualizar os n√∫meros na tela
            UIRenderer.renderPainelFinanceiro(jornada);
        };

        const labelModo = AppState.modoDRE === 'presumido' ? 'üëÅÔ∏è Modo Presumido (Caixa)' : 'üìä Modo Real (Cont√°bil)';
        const corBotao = AppState.modoDRE === 'presumido' ? 'bg-amber-600 hover:bg-amber-500' : 'bg-blue-600 hover:bg-blue-500';
        const descModo = AppState.modoDRE === 'presumido' 
            ? 'Considera transfer√™ncias/caixinhas como Gasto.' 
            : 'Ignora transfer√™ncias (Mostra lucro econ√¥mico).';

        // 2. Receitas
        const receitas = jornada.ganhos || {};
        const totalReceita = (receitas.totalApp || 0) + (receitas.totalParticular || 0);

        // üß† SUPER FILTRO V130 (DATA ECON√îMICA)
        const dataJornadaStr = new Date(jornada.data).toLocaleDateString('pt-BR');
        const custosDRE = AppState.historicoTransacoes.filter(t => {
            if (t.tipo !== 'saida' || !t.isCustoOperacional || t.invalida) return false;
            const dataRef = t.dataEconomica ? new Date(t.dataEconomica) : new Date(t.data);
            return (t.jornadaId === jornada.id) || (dataRef.toLocaleDateString('pt-BR') === dataJornadaStr);
        });

        // üî• FILTRO DE NATUREZA (REAL vs PRESUMIDO)
        let custosFiltrados = custosDRE;
        let valorProvisoesIgnoradas = 0;

        if (AppState.modoDRE === 'real') {
            custosFiltrados = custosDRE.filter(c => {
                if (c.impactaResultado !== undefined) {
                    if (c.impactaResultado === false) {
                        valorProvisoesIgnoradas += c.valor;
                        return false; 
                    }
                    return true;
                }
                const termosProvisao = ['meta', 'investimento', 'poupanca', 'poupan√ßa', 'caixinha', 'reserva'];
                const catLower = (c.categoria || '').toLowerCase();
                const descLower = (c.descricao || '').toLowerCase();
                const ehProvisao = termosProvisao.some(t => catLower.includes(t) || descLower.includes(t));
                if (ehProvisao) valorProvisoesIgnoradas += c.valor;
                return !ehProvisao;
            });
        }

        const totalAbastecimento = (jornada.custos?.abastecimento?.valor || 0);
        const totalCustosExtras = custosFiltrados.reduce((acc, c) => acc + c.valor, 0);
        const totalCustos = totalAbastecimento + totalCustosExtras;
        const lucroLiquido = totalReceita - totalCustos;
        const corLucro = lucroLiquido >= 0 ? 'text-emerald-400' : 'text-red-400';
        const bgLucro = lucroLiquido >= 0 ? 'bg-emerald-500/10' : 'bg-red-500/10';
        const borderLucro = lucroLiquido >= 0 ? 'border-emerald-500/30' : 'border-red-500/30';

        // HTML (Usando o toggleModoDRE global no onclick)
        container.innerHTML = `
            <div class="space-y-4 animate-fade-in mb-6">
                <div class="flex flex-col items-end mb-2">
                    <button onclick="window.toggleModoDRE()" class="${corBotao} text-white text-[10px] font-bold py-1 px-3 rounded-full shadow transition flex items-center gap-2">
                        ${labelModo}
                    </button>
                    <span class="text-[9px] text-slate-500 mt-1 text-right">${descModo}</span>
                </div>

                <div class="${bgLucro} border ${borderLucro} rounded-xl p-5 text-center shadow-lg relative overflow-hidden">
                    <h3 class="text-slate-400 text-xs font-medium uppercase tracking-wider mb-1">Lucro L√≠quido do Dia</h3>
                    <div class="text-4xl font-black ${corLucro} my-2 font-mono tracking-tight">
                        ${Utils.formatarMoeda(lucroLiquido)}
                    </div>
                    
                    <div class="text-xs text-slate-500 mt-2 flex justify-center gap-4">
                        <span>üí∞ Bruto: <span class="text-slate-300">${Utils.formatarMoeda(totalReceita)}</span></span>
                        <span>üîª Custos: <span class="text-red-300">-${Utils.formatarMoeda(totalCustos)}</span></span>
                    </div>

                    ${valorProvisoesIgnoradas > 0 ? `
                        <div class="mt-3 pt-2 border-t border-slate-700/30 text-[10px] text-cyan-400">
                            ‚ÑπÔ∏è R$ ${Utils.formatarMoeda(valorProvisoesIgnoradas)} em Provis√µes (n√£o descontados).
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    },       
*/

/*         
       // ============================================================================
    // RENDERIZADOR DO DRE (V130 - FINAL: DATA ECON√îMICA + IMPACTA RESULTADO)
    // ============================================================================
    renderPainelFinanceiro: (jornada) => {
        const container = document.getElementById('painel-financeiro-container');
        if (!container) return;

        // 1. Interruptor (Mantido)
        const toggleModo = () => {
            AppState.modoDRE = (AppState.modoDRE === 'presumido') ? 'real' : 'presumido';
            UIRenderer.renderPainelFinanceiro(jornada);
        };
        window.toggleModoDRE = toggleModo;

        const labelModo = AppState.modoDRE === 'presumido' ? 'üëÅÔ∏è Modo Presumido (Caixa)' : 'üìä Modo Real (Cont√°bil)';
        const corBotao = AppState.modoDRE === 'presumido' ? 'bg-amber-600 hover:bg-amber-500' : 'bg-blue-600 hover:bg-blue-500';
        const descModo = AppState.modoDRE === 'presumido' 
            ? 'Considera transfer√™ncias/caixinhas como Gasto.' 
            : 'Ignora transfer√™ncias (Mostra lucro econ√¥mico).';

        // 2. Receitas
        const receitas = jornada.ganhos || {};
        const totalReceita = (receitas.totalApp || 0) + (receitas.totalParticular || 0);

        // =================================================================
        // üß† SUPER FILTRO V130 (CONSIST√äNCIA TOTAL)
        // 1. Usa Data Econ√¥mica (Compet√™ncia)
        // 2. Usa Impacta Resultado (Natureza)
        // =================================================================
        const dataJornadaStr = new Date(jornada.data).toLocaleDateString('pt-BR');
        
        // Busca do Hist√≥rico Global
        const custosDRE = AppState.historicoTransacoes.filter(t => {
            // A. Valida√ß√£o B√°sica
            if (t.tipo !== 'saida' || !t.isCustoOperacional || t.invalida) return false;

            // B. Valida√ß√£o Temporal (Compet√™ncia)
            // Se tem dataEconomica, usa. Se n√£o, usa data f√≠sica.
            const dataRef = t.dataEconomica ? new Date(t.dataEconomica) : new Date(t.data);
            const mesmaDataEconomica = dataRef.toLocaleDateString('pt-BR') === dataJornadaStr;
            
            // Entra se: Tem o Crach√° (ID) OU se pertence √† Data Econ√¥mica desta jornada
            return (t.jornadaId === jornada.id) || mesmaDataEconomica;
        });

        // =================================================================
        // üî• FILTRO DE NATUREZA (REAL vs PRESUMIDO)
        // =================================================================
        let custosFiltrados = custosDRE;
        let valorProvisoesIgnoradas = 0;

        if (AppState.modoDRE === 'real') {
            custosFiltrados = custosDRE.filter(c => {
                // REGRA 1: Bandeira Expl√≠cita (V124+)
                if (c.impactaResultado !== undefined) {
                    if (c.impactaResultado === false) {
                        valorProvisoesIgnoradas += c.valor;
                        return false; 
                    }
                    return true;
                }

                // REGRA 2: Fallback Legado (Categoria)
                const termosProvisao = ['meta', 'investimento', 'poupanca', 'poupan√ßa', 'caixinha', 'reserva'];
                const catLower = (c.categoria || '').toLowerCase();
                const descLower = (c.descricao || '').toLowerCase();
                const ehProvisao = termosProvisao.some(t => catLower.includes(t) || descLower.includes(t));
                
                if (ehProvisao) valorProvisoesIgnoradas += c.valor;
                return !ehProvisao;
            });
        }

        // C√°lculos Finais (Mantidos)
        const totalAbastecimento = (jornada.custos?.abastecimento?.valor || 0);
        const totalCustosExtras = custosFiltrados.reduce((acc, c) => acc + c.valor, 0);
        const totalCustos = totalAbastecimento + totalCustosExtras;
        const lucroLiquido = totalReceita - totalCustos;
        
        // Cores
        const corLucro = lucroLiquido >= 0 ? 'text-emerald-400' : 'text-red-400';
        const bgLucro = lucroLiquido >= 0 ? 'bg-emerald-500/10' : 'bg-red-500/10';
        const borderLucro = lucroLiquido >= 0 ? 'border-emerald-500/30' : 'border-red-500/30';

        // HTML (Mantido)
        container.innerHTML = `
            <div class="space-y-4 animate-fade-in">
                <div class="flex flex-col items-end mb-2">
                    <button onclick="window.toggleModoDRE()" class="${corBotao} text-white text-xs font-bold py-1 px-3 rounded-full shadow transition flex items-center gap-2">
                        ${labelModo}
                    </button>
                    <span class="text-[10px] text-slate-500 mt-1 text-right">${descModo}</span>
                </div>

                <div class="${bgLucro} border ${borderLucro} rounded-xl p-5 text-center shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent ${lucroLiquido >= 0 ? 'via-emerald-500' : 'via-red-500'} to-transparent opacity-50"></div>
                    
                    <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Lucro L√≠quido do Dia</h3>
                    <div class="text-4xl font-black ${corLucro} my-2 font-mono tracking-tight">
                        ${Utils.formatarMoeda(lucroLiquido)}
                    </div>
                    
                    <div class="text-xs text-slate-500 mt-2 flex justify-center gap-4">
                        <span>üí∞ Bruto: <span class="text-slate-300">${Utils.formatarMoeda(totalReceita)}</span></span>
                        <span>üîª Custos: <span class="text-red-300">-${Utils.formatarMoeda(totalCustos)}</span></span>
                    </div>

                    ${valorProvisoesIgnoradas > 0 ? `
                        <div class="mt-3 pt-2 border-t border-slate-700/30 text-xs text-cyan-400">
                            ‚ÑπÔ∏è R$ ${Utils.formatarMoeda(valorProvisoesIgnoradas)} em Provis√µes (n√£o descontados).
                        </div>
                    ` : ''}
                </div>

                <div class="bg-slate-800 rounded-lg p-4 text-xs space-y-2 border border-slate-700">
                    <div class="flex justify-between border-b border-slate-700 pb-1">
                        <span class="text-slate-400">(+) Ganhos Totais</span>
                        <span class="text-emerald-400 font-bold">${Utils.formatarMoeda(totalReceita)}</span>
                    </div>
                    
                    ${totalAbastecimento > 0 ? `
                    <div class="flex justify-between text-red-400/80">
                        <span>(-) Abastecimento</span>
                        <span>-${Utils.formatarMoeda(totalAbastecimento)}</span>
                    </div>` : ''}

                    <div class="flex justify-between text-red-400/80 border-b border-slate-700 pb-1">
                        <span>(-) Custos Vari√°veis (${AppState.modoDRE === 'real' ? 'Real' : 'Presumido'})</span>
                        <span>-${Utils.formatarMoeda(totalCustosExtras)}</span>
                    </div>

                    <div class="flex justify-between pt-1 font-bold text-sm">
                        <span class="text-slate-200">(=) Resultado Final</span>
                        <span class="${corLucro}">${Utils.formatarMoeda(lucroLiquido)}</span>
                    </div>
                </div>
            </div>
        `;
    },


 */
renderAlertasContasRecorrentes: () => {
            // 1. OBTEN√á√ÉO DOS DADOS
            const { contasRecorrentes } = AppState.configuracoes;
            const todasTransacoes = AppState.historicoTransacoes || []; 
            
            const hoje = new Date();
            const hojeZerado = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const diasAlertaAntecedencia = 5;

            // Define qual √© o "Carimbo" que estamos cobrando AGORA (M√™s Atual)
            // Se hoje √© Janeiro/2024, buscamos o carimbo "2024-01"
            const carimboAtualNecessario = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;

            // --- PERFORMANCE: OTIMIZA√á√ÉO (Filtra transa√ß√µes antigas) ---
            // S√≥ olha transa√ß√µes dos √∫ltimos 60 dias para n√£o pesar o loop
            const dataLimitePerformance = new Date();
            dataLimitePerformance.setDate(dataLimitePerformance.getDate() - 60);
            const transacoesRecentes = todasTransacoes.filter(t => new Date(t.data) > dataLimitePerformance);

            let alertasHTML = '';
            let temAlertas = false;

            // 2. PROCESSAR CADA CONTA RECORRENTE
            contasRecorrentes.forEach(conta => {
                let foiPagoEsteMes = false;

                // --- CHECK 1: O CONTADOR OCULTO (Inteligente) ---
                // Se a conta j√° tem o carimbo deste m√™s (mesmo que pago m√™s passado), est√° paga.
                if (conta.ultimoMesReferenciaPago === carimboAtualNecessario) {
                    foiPagoEsteMes = true;
                }

                // --- CHECK 2: Compatibilidade / Fallback Visual ---
                // Verifica a data simples caso o carimbo n√£o exista (migra√ß√£o)
                if (!foiPagoEsteMes && conta.dataUltimoPagamento) {
                    const mesPagamento = conta.dataUltimoPagamento.substring(0, 7);
                    if (mesPagamento === carimboAtualNecessario) {
                        foiPagoEsteMes = true;
                    }
                }

                // --- CHECK 3: Varredura no Extrato (Performance Otimizada) ---
                // Se ainda acha que n√£o pagou, confere o extrato recente
                if (!foiPagoEsteMes) {
                    const pagamentoEncontrado = transacoesRecentes.some(t => {
                        const valT = parseFloat(t.valor);
                        const valC = parseFloat(conta.valor);
                        // Match de Valor
                        if (Math.abs(valT - valC) > 0.10) return false;
                        
                        // Match de Nome
                        const nT = (t.descricao || '').toLowerCase();
                        const nC = (conta.descricao || '').toLowerCase();
                        return nT.includes(nC) || nC.includes(nT);
                    });

                    if (pagamentoEncontrado) {
                        foiPagoEsteMes = true;
                        // Auto-Repair: Grava o carimbo para ficar r√°pido na pr√≥xima
                        conta.ultimoMesReferenciaPago = carimboAtualNecessario;
                        conta.dataUltimoPagamento = Utils.formatarDataParaChave(hoje);
                    }
                }

                // --- RENDERIZA√á√ÉO ---
                if (!foiPagoEsteMes) {
                    let dataVencimentoAtual = new Date(hoje.getFullYear(), hoje.getMonth(), conta.vencimento);
                    
                    const diffTime = dataVencimentoAtual - hojeZerado;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                    if (diffDays <= diasAlertaAntecedencia) {
                        temAlertas = true;
                        const isVencido = diffDays < 0;
                        
                        const textoStatus = isVencido 
                            ? `<span class="text-red-400 font-bold">Venceu dia ${conta.vencimento}</span>` 
                            : `<span class="text-amber-400">Vence dia ${conta.vencimento} (Faltam ${diffDays} dias)</span>`;

                        const corBorda = isVencido ? 'border-red-500/50' : 'border-amber-500/50';

                        alertasHTML += `
                            <div class="flex items-center justify-between p-3 bg-slate-800 border ${corBorda} rounded-lg shadow-sm mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üìÖ</span>
                                    <div>
                                        <p class="font-bold text-white text-sm">${conta.descricao}</p>
                                        <p class="text-xs text-slate-400">${textoStatus} ‚Ä¢ ${Utils.formatarMoeda(conta.valor)}</p>
                                    </div>
                                </div>
                                <button data-id="${conta.id}" 
                                        data-valor="${conta.valor}"
                                        data-descricao="${conta.descricao}"
                                        data-categoria="${conta.categoria}"
                                        class="btn-pagar-recorrente px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-bold uppercase rounded transition">
                                    Pagar
                                </button>
                            </div>
                        `;
                    }
                }
            });

            // 3. INJE√á√ÉO NO DOM (Somente Financeiro)
            const tabFinanceiro = document.getElementById('tab-content-financeiro');
            let targetContainer = document.getElementById('alertas-financeiro-injetado');
            
            if (tabFinanceiro) {
                if (!targetContainer) {
                    targetContainer = document.createElement('div');
                    targetContainer.id = 'alertas-financeiro-injetado';
                    targetContainer.className = 'w-full max-w-md mx-auto mb-4';
                    tabFinanceiro.insertBefore(targetContainer, tabFinanceiro.firstChild);
                }

                targetContainer.innerHTML = alertasHTML;
                
                if (temAlertas) {
                    targetContainer.classList.remove('hidden');
                } else {
                    targetContainer.classList.add('hidden');
                    targetContainer.innerHTML = '';
                }
            }
        },
renderCardBonus: (item) => {
            // Define √≠cone e texto
            let labelTipo = 'Promo√ß√£o';
            let icone = 'üéÅ'; 

            // Sanitiza√ß√£o
            const descricaoSafe = Utils.escapeHTML(item.descricao);

            if (item.descricao && item.descricao.includes('Extra Manual')) {
                labelTipo = 'Gorjeta';
                icone = 'üí∞'; 
            } else if (item.descricao && item.descricao.toLowerCase().includes('caixinha')) {
                labelTipo = 'Caixinha';
                icone = 'üê∑'; 
            }

            return `
            <li class="bg-green-900/20 border-l-4 border-green-500 rounded-r-lg p-3 mb-2 flex justify-between items-center animate-fade-in shadow-md">
                <div class="flex items-center gap-3">
                    <div class="bg-green-900/50 p-2 rounded-full text-green-400 h-10 w-10 flex items-center justify-center shadow-inner">
                        <span class="text-xl">${icone}</span>
                    </div>
                    <div>
                        <h4 class="font-bold text-green-400 text-sm leading-tight">${descricaoSafe}</h4>
                        <span class="text-[10px] text-slate-400 flex items-center gap-1">
                            <span>‚è∞ ${new Date(item.data).toLocaleTimeString().slice(0,5)}</span>
                            <span>‚Ä¢ ${labelTipo}</span>
                        </span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block font-bold text-green-400 text-lg">+${Utils.formatarMoeda(item.valor)}</span>
                    
                    <button data-id="${item.id}" class="btn-excluir-transacao text-[10px] text-red-400 hover:text-red-200 underline cursor-pointer mt-1">
                        Remover
                    </button>
                </div>
            </li>`;
        },

// 2. AUXILIAR: CARD DE VIAGEM (COM PROTE√á√ÉO XSS)
        renderCardAtividade: (item, indexOriginal) => {
            const inicio = new Date(item.inicio);
            const fim = new Date(item.fim);
            
            const diffMs = fim - inicio;
            const duracaoTexto = (diffMs > 0) 
                ? (Utils.formatarDuracao ? Utils.formatarDuracao(diffMs) : new Date(diffMs).toISOString().substr(11, 8))
                : '00:00:00';

            const duracaoHoras = diffMs > 0 ? diffMs / 3600000 : 0;
            const valorPorHora = duracaoHoras > 0 ? item.valor / duracaoHoras : 0;

            let kmPercorrido = 0;
            if (item.kmFinalServico != null && item.kmInicialServico != null) {
                kmPercorrido = (item.kmFinalServico - item.kmInicialServico);
            }
            const ganhoKm = kmPercorrido > 0 ? item.valor / kmPercorrido : 0;

            // --- PROTE√á√ÉO XSS APLICADA AQUI ---
            const descPrincipal = Utils.escapeHTML(item.descricao || 'Sem descri√ß√£o');
            const nomeSubOriginal = (typeof item.subcategoria === 'object') ? item.subcategoria.nome : item.subcategoria;
            const nomeSub = Utils.escapeHTML(nomeSubOriginal);
            // ----------------------------------
            
            let iconHTML = '';
            let iconeVisual = null;
            
            if (nomeSubOriginal) iconeVisual = Utils.getIconeSubcategoria(item.categoria, nomeSubOriginal);
            
            if (!iconeVisual) {
                if (item.categoria === 'Corrida') iconeVisual = 'üöó';
                else if (item.categoria === 'Entrega') iconeVisual = 'üì¶';
                else iconeVisual = '‚öôÔ∏è';
            }

            if (iconeVisual.includes('<img')) {
                iconHTML = `<div class="flex-shrink-0">${iconeVisual.replace('w-6 h-6', 'w-8 h-8')}</div>`;
            } else {
                iconHTML = `<div class="flex-shrink-0 w-8 h-8 bg-slate-700/50 rounded-full flex items-center justify-center text-xl shadow-sm border border-slate-600">${iconeVisual}</div>`;
            }

            let taxaHTML = '';
            const valorGorjeta = item.valorGorjeta || 0;
            const valorLiquidoOriginal = item.valor - valorGorjeta; 
            let valorBrutoViagem = 0;
            let valorTaxaPaga = 0;

            if (item.valorBruto && item.valorBruto > 0) {
                valorBrutoViagem = item.valorBruto;
                valorTaxaPaga = valorBrutoViagem - valorLiquidoOriginal;
            } else if (item.taxaAppOriginal && item.taxaAppOriginal > 0) {
                valorTaxaPaga = item.taxaAppOriginal;
                valorBrutoViagem = valorLiquidoOriginal + valorTaxaPaga;
            }
            
            if (valorBrutoViagem > 0 && valorTaxaPaga > 0) {
                const percent = (valorTaxaPaga / valorBrutoViagem) * 100;
                taxaHTML = `<div class="text-red-400 text-xs font-bold mb-1">Taxa: ${percent.toFixed(1)}% (${Utils.formatarMoeda(valorTaxaPaga)})</div>`;
            }

            let badgeHTML = '';

            if (nomeSub) {
                let corSub = '#818cf8'; 
                if (AppState.configuracoes && AppState.configuracoes.subcategorias) {
                    const listaCat = AppState.configuracoes.subcategorias[item.categoria];
                    if (Array.isArray(listaCat)) {
                        const achou = listaCat.find(s => (typeof s === 'string' ? s : s.nome) === nomeSubOriginal);
                        if (achou && achou.cor) corSub = achou.cor;
                    }
                }
                if (typeof item.subcategoria === 'object' && item.subcategoria.cor) {
                    corSub = item.subcategoria.cor;
                }

                const corTexto = Utils.getContrastingTextColor(corSub);
                badgeHTML = `<span class="text-[10px] px-2 py-0.5 rounded-full font-bold border border-white/10" style="background-color: ${corSub}; color: ${corTexto};">${nomeSub}</span>`;
            }

            const showIcon = AppState.visualSettings.showIconsInCards;
            const elementToDisplay = showIcon ? iconHTML : badgeHTML;

            return `
            <li class="bg-slate-800 p-4 rounded-lg fade-in mb-3 shadow-lg border-l-4 border-cyan-500 relative group">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0 pr-2 sm:pr-4">
                        <div class="flex text-lg items-center flex-wrap mb-1">
                            <span class="text-xs text-cyan-400 font-bold uppercase">${item.categoria}</span>
                        </div>
                        <div class="block mb-0.5">
                            <span class="font-bold text-lg text-white">${Utils.formatarMoeda(item.valor)}</span>
                        </div>
                    </div>
                    
                    <div class="text-center mx-2 bg-slate-900/50 p-1 rounded px-2">
                        <span class="block text-slate-500 text-[10px] uppercase font-bold">M√©dia/Hora</span>
                        <span class="text-xl font-bold text-[20px] text-cyan-400">${Utils.formatarMoeda(valorPorHora)}</span>
                    </div>

                    <div class="flex-1 min-w-0 pl-2 sm:pl-4 text-right text-sm">
                        <div class="text-slate-400 text-xs space-y-0.5"> 
                            <div><span class="font-semibold text-slate-500">In√≠cio:</span> ${inicio.toLocaleTimeString().slice(0,5)}</div>
                            <div><span class="font-semibold text-slate-500">Fim:</span> ${fim.toLocaleTimeString().slice(0,5)}
                            <div class="font-bold text-white mt-1">‚è±Ô∏è${duracaoTexto}</div></div>
                        </div>
                    </div>
                </div>
                <div class="mt-0 pt-0 border-slate-700/50">
                    <p class="text-sm text-slate-400 block mt-1 truncate">${descPrincipal}</p>
                </div>
                ${kmPercorrido > 0 ? `
                <div class="mt-3 pt-2 border-t border-slate-700/50 text-xs text-slate-300 flex justify-between px-2 bg-slate-900/30 rounded py-1">
                    <span>KM Rodados: <b class="text-white">${kmPercorrido.toFixed(1)} km</b></span>
                    <span>Ganho/KM: <b class="text-green-400">${Utils.formatarMoeda(ganhoKm)}/km</b></span>
                </div>` : ''}
                        
                <div class="flex justify-between items-center mt-3 pt-2 border-t border-slate-700/50">
                    <div class="flex items-center gap-2">
                         ${elementToDisplay}
                         <span class="text-xs pt-0.5">${taxaHTML}</span>
                    </div>
                  
                    <div class="flex items-center gap-3">
                        <button data-id="${item.id}" data-index="${indexOriginal}" class="btn-extra text-xs text-green-400 hover:text-green-300 font-bold transition uppercase">
                            <span>Extra</span> 
                        </button>
                        <button data-id="${item.id}" data-index="${indexOriginal}" class="btn-editar-atividade text-xs text-cyan-400 hover:text-cyan-300 font-bold transition uppercase">
                            Editar
                        </button>
                        <button data-id="${item.id}" data-index="${indexOriginal}" class="btn-excluir-atividade text-xs text-red-500 hover:text-red-400 font-bold transition uppercase">
                            Excluir
                        </button>
                    </div>
                </div>
            </li>`;
        },

// 3. FUN√á√ÉO PRINCIPAL (RENDERIZA A LISTA MISTA) - CORRIGIDA
        renderListaAtividades: (jornada) => {
            const { dataAtualHistorico, proximoDiaBtn, btnExcluirDia, btnDownloadDia, listaAtividades } = UIElements;
            
            // ATUALIZA A DATA E AS SETAS
            if (dataAtualHistorico) dataAtualHistorico.textContent = Utils.formatarDataParaDisplay(AppState.dataSelecionada);
            if (proximoDiaBtn) proximoDiaBtn.disabled = Utils.formatarDataParaChave(AppState.dataSelecionada) >= Utils.formatarDataParaChave(new Date());

            // Usa a Data Selecionada REAL, n√£o tenta adivinhar pelo objeto jornada
            const chaveDia = Utils.formatarDataParaChave(AppState.dataSelecionada);
            
            const hasData = AppState.jornadas[chaveDia] && (AppState.jornadas[chaveDia].atividades.length > 0 || AppState.jornadas[chaveDia].status !== 'inativa');
            
            if (btnExcluirDia) btnExcluirDia.disabled = !hasData;
            if (btnDownloadDia) btnDownloadDia.disabled = !hasData;

            const container = document.getElementById('historicoServicosLista') || (UIElements ? UIElements.listaAtividades : null);
            if (!container) return;

            container.innerHTML = '';

            // A. Lista Original (Para os √≠ndices funcionarem)
            const atividades = (jornada && Array.isArray(jornada.atividades)) ? jornada.atividades : [];

            // B. B√¥nus (CORRE√á√ÉO AQUI: Usa chaveDia baseada no calend√°rio, n√£o no objeto)
            let bonusDoDia = [];
            if (AppState.historicoTransacoes) {
                bonusDoDia = AppState.historicoTransacoes.filter(t => 
                    t.jornadaId === chaveDia && // Agora busca a data certa!
                    t.tipo === 'entrada' && 
                    t.descricao && String(t.descricao).startsWith('B√¥nus:')
                );
            }

            // C. Mistura e Ordena
            const listaMista = [...atividades, ...bonusDoDia].sort((a, b) => {
                const timeA = new Date(a.fim || a.data || 0).getTime();
                const timeB = new Date(b.fim || b.data || 0).getTime();
                return timeB - timeA; 
            });

            if (listaMista.length === 0) {
                container.innerHTML = '<li class="text-center text-slate-500 py-6 text-sm flex flex-col items-center"><span class="text-2xl opacity-30 mb-2">üì≠</span>Nenhuma atividade neste dia.</li>';
                return;
            }

            let html = '';
            listaMista.forEach((item) => {
                if (item.contaId) { 
                    // √â um B√¥nus/Transa√ß√£o
                    html += UIRenderer.renderCardBonus(item);
                } else {
                    // √â uma Corrida
                    const indexReal = atividades.indexOf(item);
                    html += UIRenderer.renderCardAtividade(item, indexReal);
                }
            });

            container.innerHTML = html;
            
            if (UIElements.historicoCountSpan) UIElements.historicoCountSpan.textContent = listaMista.length;
        },
        
renderConfiguracoes: () => {
            const { 
                proLaboreInput, metaAutonomaInput, valorVeiculoInput, 
                vidaUtilVeiculoInput, autonomiaVeiculoInput, tipoCombustivelSelect, 
                manterCalculoKmAntigo, kmMetaDiariaInput, incluirPrevisaoManutencao, 
                // rateioDinamicoCustos, // <-- Removido daqui pois pegamos via getElementById para garantir
                reciboNomeMotorista, reciboDocumento, 
                reciboPlacaVeiculo, usarGpsTracking, configTipoDeclaracao, 
                configMeiPercentual, containerConfigMei, btnAdicionarCustoFixo 
            } = UIElements;

            const { veiculo, proLabore, metaAutonoma, perfilFiscal, diaPagamentoProLabore, diasTrabalhoSemana, metasFinanceiras } = AppState.configuracoes;

            // =================================================================
            // 1. CONFIGURA√á√ÉO DE CRON√îMETRO (H√çBRIDO / PREMIUM)
            // =================================================================
            // Definimos aqui para usar em todo o escopo da fun√ß√£o
            const chkRateioAntigo = document.getElementById('rateioDinamicoCustos'); 
            let containerCronometro = document.getElementById('containerCronometroModo');

            if (chkRateioAntigo && !containerCronometro) {
                containerCronometro = document.createElement('div');
                containerCronometro.id = 'containerCronometroModo';
                containerCronometro.className = "p-4 bg-slate-900 rounded-lg border border-slate-700 mt-4";
                
                const parentBlock = chkRateioAntigo.closest('.p-4.bg-slate-900');
                if (parentBlock) {
                    parentBlock.appendChild(containerCronometro);
                }
            }

            if (containerCronometro) {
                const modoAtual = AppState.configuracoes.cronometroModo || 'liquido';
                const descricoes = {
                    'liquido': 'Padr√£o: O rel√≥gio para visualmente nas pausas. Calcula o tempo produtivo exato.',
                    'bruto': 'Corrido: O rel√≥gio nunca para. Mostra o tempo total que voc√™ est√° na rua.',
                    'hibrido': 'Alta Performance: Visual Corrido (leve) durante o dia. Economiza bateria. Precis√£o no final.'
                };

                containerCronometro.innerHTML = `
                    <h3 class="text-sm font-bold text-slate-300 mb-3 text-center">Modo do Cron√¥metro</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex flex-col items-center p-2 rounded-lg border-2 ${modoAtual === 'liquido' ? 'border-cyan-500 bg-cyan-900/20' : 'border-slate-600'} cursor-pointer hover:bg-slate-700 transition-all">
                            <input type="radio" name="cronometroModo" value="liquido" class="hidden" ${modoAtual === 'liquido' ? 'checked' : ''}>
                            <span class="text-lg mb-1">‚è±Ô∏è</span>
                            <span class="font-semibold text-[10px] sm:text-xs text-white text-center">L√≠quido</span>
                        </label>

                        <label class="flex flex-col items-center p-2 rounded-lg border-2 ${modoAtual === 'hibrido' ? 'border-cyan-500 bg-cyan-900/20' : 'border-slate-600'} cursor-pointer hover:bg-slate-700 transition-all">
                            <input type="radio" name="cronometroModo" value="hibrido" class="hidden" ${modoAtual === 'hibrido' ? 'checked' : ''}>
                            <span class="text-lg mb-1">‚ö°</span>
                            <span class="font-semibold text-[10px] sm:text-xs text-white text-center">H√≠brido</span>
                        </label>

                        <label class="flex flex-col items-center p-2 rounded-lg border-2 ${modoAtual === 'bruto' ? 'border-cyan-500 bg-cyan-900/20' : 'border-slate-600'} cursor-pointer hover:bg-slate-700 transition-all">
                            <input type="radio" name="cronometroModo" value="bruto" class="hidden" ${modoAtual === 'bruto' ? 'checked' : ''}>
                            <span class="text-lg mb-1">üèÉ</span>
                            <span class="font-semibold text-[10px] sm:text-xs text-white text-center">Bruto</span>
                        </label>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-md mt-2 min-h-[50px] flex items-center justify-center border border-slate-700">
                         <p id="crono-help-text" class="text-xs text-slate-300 text-center italic transition-all duration-300">
                             ${descricoes[modoAtual]}
                         </p>
                    </div>
                `;

                containerCronometro.querySelectorAll('input[name="cronometroModo"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const val = e.target.value;
                        AppState.configuracoes.cronometroModo = val;
                        EventHandlers.handleConfigInputChange();
                        
                        containerCronometro.querySelectorAll('label').forEach(l => {
                            l.classList.remove('border-cyan-500', 'bg-cyan-900/20');
                            l.classList.add('border-slate-600');
                        });
                        e.target.parentElement.classList.add('border-cyan-500', 'bg-cyan-900/20');
                        e.target.parentElement.classList.remove('border-slate-600');

                        const textoEl = document.getElementById('crono-help-text');
                        if (textoEl) {
                            textoEl.style.opacity = '0';
                            setTimeout(() => {
                                textoEl.textContent = descricoes[val];
                                textoEl.style.opacity = '1';
                            }, 150);
                        }
                    });
                });
            }

            // =================================================================
            // 2. CONFIGURA√á√ïES B√ÅSICAS (DIAS, KM, ETC)
            // =================================================================
            let diasAtivos = [];
            if (Array.isArray(diasTrabalhoSemana)) { diasAtivos = diasTrabalhoSemana; } 
            else { diasAtivos = [1, 2, 3, 4, 5]; AppState.configuracoes.diasTrabalhoSemana = diasAtivos; }

            const botoesDias = document.querySelectorAll('.btn-dia-semana');
            if (botoesDias) {
                botoesDias.forEach(btn => {
                    const dia = parseInt(btn.dataset.dia);
                    if (diasAtivos.includes(dia)) {
                        btn.classList.remove('bg-slate-600', 'text-slate-400');
                        btn.classList.add('bg-cyan-600', 'text-white', 'shadow-lg', 'scale-110'); 
                    } else {
                        btn.classList.add('bg-slate-600', 'text-slate-400');
                        btn.classList.remove('bg-cyan-600', 'text-white', 'shadow-lg', 'scale-110'); 
                    }
                });
            }
            if (UIElements.diasTrabalhoSemanaInput) UIElements.diasTrabalhoSemanaInput.value = diasAtivos.length;

            if (manterCalculoKmAntigo) manterCalculoKmAntigo.checked = AppState.configuracoes.manterCalculoKmAntigo;
            if (metaAutonomaInput) metaAutonomaInput.value = metaAutonoma > 0 ? Utils.formatarMoedaParaInput(metaAutonoma) : '';
            if (valorVeiculoInput) valorVeiculoInput.value = veiculo.valor > 0 ? Utils.formatarMoedaParaInput(veiculo.valor) : '';
            if (UIElements.kmMetaDiariaInput) UIElements.kmMetaDiariaInput.value = AppState.configuracoes.kmMetaDiaria || '';
            if (incluirPrevisaoManutencao) incluirPrevisaoManutencao.checked = AppState.configuracoes.incluirPrevisaoManutencao;
            if (usarGpsTracking) usarGpsTracking.checked = AppState.configuracoes.usarGpsTracking;

            // Inje√ß√£o Pr√≥-Labore e Dia
            const containerProLabore = document.getElementById('proLaboreInput')?.closest('.grid');
            let diaInput = document.getElementById('proLaboreDiaInput');
            if (containerProLabore && !diaInput) {
                const divDia = document.createElement('div');
                divDia.innerHTML = `<label for="proLaboreDiaInput" class="block text-sm font-medium text-slate-300 mb-1">Dia do Pagamento (1-31)</label><input type="number" id="proLaboreDiaInput" placeholder="Ex: 5" min="1" max="31" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">`;
                const wrapperValor = document.getElementById('proLaboreInput').parentElement;
                wrapperValor.insertAdjacentElement('afterend', divDia);
                diaInput = document.getElementById('proLaboreDiaInput');
                diaInput.addEventListener('input', EventHandlers.handleConfigInputChange);
            }
            let msgAlerta = document.getElementById('msg-alerta-dia-pagamento');
            if (containerProLabore && !msgAlerta) {
                msgAlerta = document.createElement('div');
                msgAlerta.id = 'msg-alerta-dia-pagamento';
                msgAlerta.className = "col-span-1 sm:col-span-2 text-[10px] text-amber-400 italic hidden mt-1 bg-amber-900/30 p-1 rounded border border-amber-800/50 text-center";
                containerProLabore.appendChild(msgAlerta);
            }
            if (UIElements.proLaboreInput) UIElements.proLaboreInput.value = proLabore > 0 ? Utils.formatarMoedaParaInput(proLabore) : '';
            if (diaInput) {
                diaInput.value = diaPagamentoProLabore || '';
                if (msgAlerta) {
                    if (diaPagamentoProLabore >= 29) {
                        msgAlerta.innerHTML = `‚ö†Ô∏è <b>Nota:</b> Se o m√™s n√£o tiver dia ${diaPagamentoProLabore}, o c√°lculo usar√° o <b>√∫ltimo dia</b>.`;
                        msgAlerta.classList.remove('hidden');
                    } else { msgAlerta.classList.add('hidden'); }
                }
            }

            // Perfil, Deprecia√ß√£o e Combust√≠vel
            if (reciboNomeMotorista) {
                reciboNomeMotorista.value = AppState.configuracoes.perfilRecibo.nome || '';
                reciboDocumento.value = AppState.configuracoes.perfilRecibo.documento || '';
                reciboPlacaVeiculo.value = AppState.configuracoes.perfilRecibo.placa || '';
            }
            if (configTipoDeclaracao) {
                configTipoDeclaracao.value = perfilFiscal.tipo || 'pf';
                if(configMeiPercentual) configMeiPercentual.value = perfilFiscal.meiPercentual || 16;
                if(containerConfigMei) containerConfigMei.classList.toggle('hidden', perfilFiscal.tipo !== 'mei');
            }
            if (autonomiaVeiculoInput) autonomiaVeiculoInput.value = veiculo.autonomia > 0 ? String(veiculo.autonomia).replace('.', ',') : '';
            if (tipoCombustivelSelect) tipoCombustivelSelect.value = veiculo.combustivel || 'Gasolina Comum';
            
            // =================================================================
            // 3. DEPRECIA√á√ÉO BLINDADA (SEM LOOP INFINITO)
            // =================================================================
            const parentDiv = document.getElementById('vidaUtilContainer');
            const vidaUtilInputElem = UIElements.vidaUtilVeiculoInput; 
            
            if (parentDiv && !parentDiv.querySelector('#percentualDepreciacaoInput')) {
                // Visual Compacto (Seu Design)
                parentDiv.classList.add('grid', 'grid-cols-2', 'gap-2', 'items-end');
                const w1 = document.createElement('div'); w1.appendChild(parentDiv.querySelector('label')); w1.appendChild(vidaUtilInputElem); vidaUtilInputElem.classList.add('w-full');
                const w2 = document.createElement('div'); w2.innerHTML = `<label class="block text-sm font-medium text-slate-300 mb-1">Taxa Anual (%)</label><input type="text" inputmode="decimal" id="percentualDepreciacaoInput" placeholder="Ex: 20" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">`;
                parentDiv.innerHTML = ''; parentDiv.appendChild(w1); parentDiv.appendChild(w2);
                const alertP = document.createElement('p'); alertP.className = 'text-xs text-slate-500 text-center col-span-2 pt-1'; alertP.textContent = 'Padr√£o Receita Federal: 5 anos (20%) para ve√≠culos.'; parentDiv.appendChild(alertP);
                UIElements.percentualDepreciacaoInput = document.getElementById('percentualDepreciacaoInput');

                // L√≥gica Segura (Try/Finally + Flag)
                let isCalculating = false; 

                vidaUtilInputElem.addEventListener('input', () => {
                    if (isCalculating) return;
                    isCalculating = true;
                    try {
                        const v = parseFloat(vidaUtilInputElem.value.replace(',', '.')); 
                        if(v > 0 && UIElements.percentualDepreciacaoInput) { 
                            UIElements.percentualDepreciacaoInput.value = ((1/v)*100).toFixed(2).replace('.',','); 
                        } 
                        EventHandlers.handleConfigInputChange();
                    } finally { isCalculating = false; }
                });

                UIElements.percentualDepreciacaoInput.addEventListener('input', () => {
                    if (isCalculating) return;
                    isCalculating = true;
                    try {
                        const v = Utils.parseMoeda(UIElements.percentualDepreciacaoInput.value); 
                        if(v > 0) { 
                            vidaUtilInputElem.value = (100/v).toFixed(1).replace('.',','); 
                        } 
                        EventHandlers.handleConfigInputChange();
                    } finally { isCalculating = false; }
                });
            }
            
            if(vidaUtilInputElem) vidaUtilInputElem.value = String(veiculo.vidaUtil || 5).replace('.', ',');
            if(UIElements.percentualDepreciacaoInput && veiculo.vidaUtil > 0) { UIElements.percentualDepreciacaoInput.value = ((1/parseFloat(veiculo.vidaUtil))*100).toFixed(2).replace('.',','); }

            // =================================================================
            // 4. PROVISIONAMENTO (COM CORRE√á√ÉO DE REFERENCE ERROR)
            // =================================================================
            // Declara√ß√£o segura no topo do bloco - usa a vari√°vel j√° definida no topo da fun√ß√£o
            let containerProvisionamento = document.getElementById('containerModoProvisionamento');
            
            if (chkRateioAntigo) {
                const wrapperOld = chkRateioAntigo.closest('.flex.items-center.justify-between');
                if (wrapperOld) wrapperOld.classList.add('hidden');
                
                if (!containerProvisionamento) {
                    containerProvisionamento = document.createElement('div');
                    containerProvisionamento.id = 'containerModoProvisionamento';
                    containerProvisionamento.className = "bg-slate-900 rounded-lg border border-slate-700 mt-4 overflow-hidden transition-all duration-300";
                    wrapperOld.insertAdjacentElement('afterend', containerProvisionamento);
                }
            } else if (!containerProvisionamento) {
                // Fallback caso o switch n√£o exista na tela (primeira carga)
                // Procura um ponto de ancoragem alternativo
                const anchor = document.getElementById('listaMetasFinanceirasContainer') || document.getElementById('tab-content-configuracoes');
                if(anchor) {
                    containerProvisionamento = document.createElement('div');
                    containerProvisionamento.id = 'containerModoProvisionamento';
                    containerProvisionamento.className = "bg-slate-900 rounded-lg border border-slate-700 mt-4 overflow-hidden transition-all duration-300";
                    if(anchor.id === 'listaMetasFinanceirasContainer') anchor.insertAdjacentElement('afterend', containerProvisionamento);
                    else anchor.appendChild(containerProvisionamento);
                }
            }

            if (containerProvisionamento) {
                const isGlobalDinamico = AppState.configuracoes.rateioDinamicoCustos;
                const isDinamico = isGlobalDinamico; 

                const styleAtivoP = 'border-cyan-500 bg-cyan-900/20 ring-1 ring-cyan-500 text-white';
                const styleInativoP = 'border-slate-600 text-slate-400 hover:bg-slate-800 hover:border-slate-500';
                
                const renderRow = (meta, label, corTexto) => {
                    const isObrigatorio = meta.isObrigatorio === true; 
                    const isChecked = isObrigatorio ? true : (meta.incluirComoCustoDiario !== false);
                    
                    const isItemDinamico = meta.modoProvisionamento === 'dinamico';
                    const showToggle = !isGlobalDinamico; 
                    
                    const disabledAttr = isObrigatorio ? 'disabled' : '';
                    const cursorClass = isObrigatorio ? 'cursor-not-allowed opacity-80' : 'cursor-pointer';
                    const lockIcon = isObrigatorio ? '<span class="text-[10px] ml-1">üîí</span>' : '';

                    let btnDinamicoHTML = '';
                    if (showToggle) {
                        const btnClass = isItemDinamico 
                            ? 'bg-amber-500 text-white border-amber-600 shadow-lg shadow-amber-500/20' 
                            : 'bg-slate-700 text-slate-500 border-slate-600 hover:border-slate-500';
                        const icon = isItemDinamico ? '‚ö°' : 'üîí';
                        const text = isItemDinamico ? 'Din√¢mico' : 'Fixo';

                        btnDinamicoHTML = `<button class="btn-toggle-item-dinamico flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold border transition-all ${btnClass}" data-id="${meta.id}" data-status="${isItemDinamico ? 'dinamico' : 'fixo'}"><span>${icon}</span> <span>${text}</span></button>`;
                    }

                    return `
                    <div class="flex items-center justify-between p-2 bg-slate-800/40 rounded border border-transparent hover:border-slate-700 transition mb-1">
                        <label class="flex items-center gap-3 ${cursorClass} flex-1">
                            <input type="checkbox" class="chk-prov-item h-4 w-4 rounded bg-slate-700 border-slate-600 ${corTexto} focus:ring-offset-0" 
                                data-id="${meta.id}" ${isChecked ? 'checked' : ''} ${disabledAttr}>
                            <span class="text-sm text-slate-200">${label} ${lockIcon}</span>
                        </label>
                        ${btnDinamicoHTML}
                    </div>`;
                };

                let htmlAtivos = '';
                let htmlInativos = '';

                // 1. Custos Fixos
                const metaCustos = metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                if (metaCustos) htmlAtivos += renderRow(metaCustos, 'Custos Fixos Mensais', 'text-amber-500');

                // 2. Pr√≥-Labore
                const metaPL = metasFinanceiras.find(m => m.id === 'AUTO_ID_PROLABORE');
                if (metaPL) {
                    if(metaPL.incluirComoCustoDiario !== false) htmlAtivos += renderRow(metaPL, 'Pr√≥-Labore (Sal√°rio)', 'text-green-500');
                    else htmlInativos += renderRow(metaPL, 'Pr√≥-Labore (Sal√°rio)', 'text-slate-500');
                }

                // 3. Outras Metas (COM FILTRO DE CONCLU√çDAS)
                metasFinanceiras.filter(m => !m.id.startsWith('AUTO_ID_') && m.id !== 'META_CUSTOS_MENSAIS').forEach(m => {
                    // Corre√ß√£o: Se conclu√≠da e n√£o marcada explicitamente, n√£o mostra nem nos inativos
                    const concluida = m.valorTotal > 0 && (m.valorAtual || 0) >= m.valorTotal;
                    if (concluida && m.incluirComoCustoDiario === false) return;

                    const cor = m.tipo === 'parcelamento' ? 'text-orange-500' : 'text-cyan-500';
                    if (m.incluirComoCustoDiario !== false) {
                        htmlAtivos += renderRow(m, m.descricao, cor);
                    } else {
                        htmlInativos += renderRow(m, m.descricao, 'text-slate-500');
                    }
                });

                let accordionHTML = '';
                if (htmlInativos) {
                    accordionHTML = `
                        <details class="group mt-2">
                            <summary class="flex items-center gap-2 cursor-pointer p-2 bg-slate-800/30 rounded text-xs text-slate-400 hover:text-slate-200 transition select-none">
                                <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                                ‚ûï Mostrar Outras Caixinhas Dispon√≠veis (${(htmlInativos.match(/<input/g) || []).length})
                            </summary>
                            <div class="pl-2 mt-2 border-l-2 border-slate-700 space-y-1 fade-in">
                                ${htmlInativos}
                            </div>
                        </details>`;
                }

                containerProvisionamento.innerHTML = `
                    <div class="p-4 bg-slate-800 border-b border-slate-700">
                        <h3 class="text-sm font-bold text-slate-300 mb-3 text-center">Modo de Provisionamento (Metas)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex flex-col items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${!isDinamico ? styleAtivoP : styleInativoP}">
                                <input type="radio" name="modoProvisionamentoConfig" value="fixo" class="hidden" ${!isDinamico ? 'checked' : ''}>
                                <span class="text-xl mb-1">üîí</span>
                                <span class="font-semibold text-xs">Fixo</span>
                            </label>
                            <label class="flex flex-col items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${isDinamico ? styleAtivoP : styleInativoP}">
                                <input type="radio" name="modoProvisionamentoConfig" value="dinamico" class="hidden" ${isDinamico ? 'checked' : ''}>
                                <span class="text-xl mb-1">üìà</span>
                                <span class="font-semibold text-xs">Din√¢mico</span>
                            </label>
                        </div>
                        <div class="bg-slate-800 p-3 rounded-md mt-2 min-h-[40px] flex items-center justify-center">
                            <p class="text-xs text-slate-300 text-center italic transition-all duration-300">
                                ${isDinamico 
                                    ? '<b>Din√¢mico:</b> Recalcula todo dia. Se folgar hoje, amanh√£ fica mais caro.' 
                                    : '<b>Fixo:</b> Valor constante (Total √∑ Dias). Use o ‚ö° abaixo para exce√ß√µes.'}
                            </p>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-slate-900 space-y-1">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 mt-1">Itens Inclu√≠dos no Dia</h4>
                        ${htmlAtivos}
                        ${accordionHTML}
                    </div>
                `;

                containerProvisionamento.querySelectorAll('input[name="modoProvisionamentoConfig"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const val = e.target.value;
                        AppState.configuracoes.rateioDinamicoCustos = (val === 'dinamico');
                        EventHandlers.handleConfigInputChange();
                        UIRenderer.renderConfiguracoes();
                        UIRenderer.render();
                    });
                });

                containerProvisionamento.querySelectorAll('.chk-prov-item').forEach(chk => {
                    chk.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
                        if (meta) {
                            if (meta.isObrigatorio) {
                                e.target.checked = true; 
                                meta.incluirComoCustoDiario = true;
                            } else {
                                meta.incluirComoCustoDiario = e.target.checked;
                            }
                            Storage.salvarConfiguracoes();
                            UIRenderer.renderConfiguracoes(); 
                            UIRenderer.render();
                        }
                    });
                });

                containerProvisionamento.querySelectorAll('.btn-toggle-item-dinamico').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const id = e.target.closest('button').dataset.id;
                        const statusAtual = e.target.closest('button').dataset.status;
                        const novoStatus = statusAtual === 'fixo' ? 'dinamico' : 'fixo';
                        
                        const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
                        if (meta) {
                            meta.modoProvisionamento = novoStatus;
                            Storage.salvarConfiguracoes();
                            UIRenderer.renderConfiguracoes();
                            UIRenderer.render();
                        }
                    });
                });
            }

            // =================================================================
            // 5. INJE√á√ïES FINAIS (ZONA DE PERIGO)
            // =================================================================
            if (btnAdicionarCustoFixo && btnAdicionarCustoFixo.parentElement) {
                const formCustosFixos = btnAdicionarCustoFixo.parentElement;
                if (!formCustosFixos.querySelector('#categoriaCustoFixo')) {
                     const categoriaCustoHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="block text-xs font-medium text-slate-400 mb-1">Categoria Custo</label><select id="categoriaCustoFixo" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"><option value="Ve√≠culo">Ve√≠culo</option><option value="Administrativo">Administrativo</option><option value="Impostos">Impostos</option><option value="Outro C. Fixo">Outro</option></select></div><div><label class="block text-xs font-medium text-slate-400 mb-1">Subcategoria</label><input type="text" id="subcategoriaCustoFixo" placeholder="Ex: Seguro" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"></div></div>`;
                    formCustosFixos.querySelector('.grid').insertAdjacentHTML('afterend', categoriaCustoHTML);
                }
            }
            const containerBackup = document.getElementById('btnExportarDados')?.parentElement?.parentElement;
            if (containerBackup && !document.getElementById('zone-danger-container')) {
                const divDanger = document.createElement('div');
                divDanger.id = 'zone-danger-container'; 
                divDanger.className = "hidden p-4 bg-red-900/20 border border-red-900/50 rounded-lg space-y-4 mt-6 transition-all duration-500";
                
                divDanger.innerHTML = `
                    <h3 class="text-lg font-bold text-center text-red-500">Zona de Perigo</h3>
                    <p class="text-xs text-slate-400 text-center">A√ß√µes irrevers√≠veis.</p>
                    
                    <button id="btn-sanear-dados" class="w-full bg-blue-900/20 border border-blue-600 text-blue-400 hover:bg-blue-600 hover:text-white font-bold py-3 px-4 rounded-lg transition duration-300 mb-2">
                        üõ†Ô∏è Sanear Base de Dados (Novo Motor)
                    </button>

                    <button id="btn-factory-reset" class="w-full bg-transparent border border-red-600 text-red-500 hover:bg-red-600 hover:text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        üóëÔ∏è Apagar Todos os Dados (Reset)
                    </button>
                `;
                
                containerBackup.insertAdjacentElement('afterend', divDanger);

                // Timeout para garantir que o DOM renderizou
                setTimeout(() => {
                    const btnSanear = document.getElementById('btn-sanear-dados');
                    const btnReset = document.getElementById('btn-factory-reset');

                    if (btnSanear) {
                        btnSanear.onclick = EventHandlers.handleSanearDados;
                    }
                    
                    if (btnReset) {
                        btnReset.onclick = EventHandlers.handleFactoryReset;
                    }
                }, 0);
            }
            if (containerBackup) {
                const titleBackup = containerBackup.querySelector('h3');
                if (titleBackup && !titleBackup.querySelector('#trigger-dados')) {
                     titleBackup.innerHTML = titleBackup.innerHTML.replace('Dados', '<span id="trigger-dados" class="cursor-pointer select-none active:text-red-500 transition">Dados</span>');
                     let clickCount = 0; let resetTimer = null;
                     const trigger = titleBackup.querySelector('#trigger-dados');
                     trigger.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation(); clickCount++; trigger.classList.add('text-red-400');
                        setTimeout(() => trigger.classList.remove('text-red-400'), 150);
                        if (resetTimer) clearTimeout(resetTimer); resetTimer = setTimeout(() => { clickCount = 0; }, 2000);
                        if (clickCount >= 7) { document.getElementById('zone-danger-container').classList.remove('hidden'); clickCount = 0; UIRenderer.abrirModal('alerta', { titulo: 'Modo Avan√ßado', mensagem: '‚ö†Ô∏è Zona de Perigo liberada!', type: 'success' }); }
                     });
                }
            }

            UIRenderer.renderListaCustosFixos(); 
            UIRenderer.renderMetasFinanceiras();
        },


renderSubcategorias: () => {
            const { listaSubcategorias } = UIElements;
            const { subcategorias } = AppState.configuracoes;
            listaSubcategorias.innerHTML = '';
            
            let hasSubcat = false;
            Object.keys(subcategorias).forEach(cat => {
                if (subcategorias[cat].length > 0) {
                    hasSubcat = true;
                    subcategorias[cat].forEach(sub => {
                        // Tratamento para dados antigos (string) vs novos (objeto)
                        const nome = typeof sub === 'string' ? sub : sub.nome;
                        const cor = (typeof sub === 'object' && sub.cor) ? sub.cor : '#818cf8';
                        // Recupera √≠cone (l√≥gica simples visual)
                        const iconeVisual = Utils.getIconeSubcategoria(cat, nome);

                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-slate-700/50 p-2 rounded-md text-sm mb-2';
                        li.innerHTML = `
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${iconeVisual}</span>
                                <div>
                                    <span class="block font-bold text-white">${nome}</span>
                                    <span class="text-xs text-slate-400">${cat}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-cat="${cat}" data-nome="${nome}" class="btn-editar-subcategoria text-cyan-400 hover:text-cyan-300 transition p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
                                </button>
                                <button data-cat="${cat}" data-nome="${nome}" class="btn-excluir-subcategoria text-red-500 hover:text-red-400 transition p-1">
                                    &times;
                                </button>
                            </div>
                        `;
                        listaSubcategorias.appendChild(li);
                    });
                }
            });

            if (!hasSubcat) {
                listaSubcategorias.innerHTML = `<li class="text-center text-slate-500 italic text-sm">Nenhuma subcategoria adicionada.</li>`;
            }
        },
/*         
renderDashboard: () => {
            // --- ETAPA 5 (CORRE√á√ÉO): L√≥gica de filtro movida para o TOPO ---
            // Isso corrige o bug do dashboard "vazio" e "zerado" no carregamento.
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            const mesAtual = hoje.getMonth(); // 0-11
            
            // Popula Anos (se ainda n√£o populado)
            if (UIElements.selectAno.options.length === 0) {
                for (let i = 0; i < 3; i++) {
                    const ano = anoAtual - i;
                    UIElements.selectAno.innerHTML += `<option value="${ano}">${ano}</option>`;
                }
                UIElements.selectAno.value = anoAtual;
            }
            
            // Popula Meses (se ainda n√£o populado)
            if (UIElements.selectMes.options.length === 0) {
                const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                UIElements.selectMes.innerHTML = `<option value="-1">Ano Inteiro</option>`;
                meses.forEach((mes, index) => {
                    UIElements.selectMes.innerHTML += `<option value="${index}">${mes}</option>`;
                });
                UIElements.selectMes.value = mesAtual;
            }
            
            // Popula Dias (Din√¢mico)
            const anoSelecionado = parseInt(UIElements.selectAno.value);
            const mesSelecionado = parseInt(UIElements.selectMes.value);
            let diaSelecionado = parseInt(UIElements.selectDia.value) || -1; // Garante que n√£o seja NaN
            
            UIElements.selectDia.innerHTML = `<option value="-1">M√™s Inteiro</option>`;
            if (mesSelecionado > -1) {
                const diasNoMes = Utils.getDaysInMonth(anoSelecionado, mesSelecionado);
                for (let i = 1; i <= diasNoMes; i++) {
                    UIElements.selectDia.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
                }
                if (diaSelecionado > diasNoMes) {
                    diaSelecionado = -1;
                }
                UIElements.selectDia.value = diaSelecionado;
            } else {
                UIElements.selectDia.value = -1;
                diaSelecionado = -1;
            }
            // --- FIM DA CORRE√á√ÉO DE FILTRO ---

            // --- L√ìGICA DO ROADMAP ---
            if (AppState.dashboardState.isRoadmapVisible) {
                document.getElementById('graficoGanhosCustosContainer').classList.add('hidden');
                document.getElementById('graficoCustoCombustivelContainer').classList.add('hidden');
                document.getElementById('graficoMediaKmLContainer').classList.add('hidden');
                document.getElementById('graficoCategoriasContainer').classList.add('hidden');
                document.getElementById('graficoCustosContainer').classList.add('hidden');
                document.getElementById('graficoMetasContainer').classList.add('hidden');
                document.getElementById('graficoDrilldownContainer').classList.add('hidden');
                document.getElementById('graficoDrilldownKmContainer').classList.add('hidden');
                UIElements.dashboardResumoCards.classList.add('hidden');
                
                RoadmapRenderer.render(); // Chama o renderizador do Roadmap
                return; // Para a execu√ß√£o aqui
            }
            // --- FIM DA L√ìGICA DO ROADMAP ---
            
            UIElements.roadmapContainer.classList.add('hidden');
            UIElements.dashboardResumoCards.classList.remove('hidden');

            const filter = AppState.dashboardState.drilldown.active ? AppState.dashboardState.drilldown : null;
            
            // Chama o resumo com os filtros (agora corretos)
            const resumo = BusinessLogic.calcularResumoPeriodo(anoSelecionado, mesSelecionado, diaSelecionado, filter);
            
            const mediaPausaDiaria = resumo.diasTrabalhados > 0 ? resumo.totalTempoPausa / resumo.diasTrabalhados : 0;
            
            const { veiculo } = AppState.configuracoes;
            const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
            const unidadeEficiencia = Utils.formatarEficiencia(0, tipoCombustivel).split(' ')[1]; // km/L ou km/kWh
            let mediaKmLDisplay = "--";
            if (resumo.countKmL > 0) {
                const mediaTotal = resumo.totalKmL / resumo.countKmL;
                mediaKmLDisplay = mediaTotal.toFixed(2);
            }

            UIElements.dashboardResumoCards.className = 'grid grid-cols-2 sm:grid-cols-4 gap-3 text-center';
            
            UIElements.dashboardResumoCards.innerHTML = `
                <div class="bg-slate-800 p-2 rounded-lg">
                    <span class="block text-xs text-slate-400">Lucro L√≠quido</span>
                    <span class="font-bold text-lg ${resumo.totalLucro >= 0 ? 'text-green-400' : 'text-red-400'}">${Utils.formatarMoeda(resumo.totalLucro)}</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg">
                    <span class="block text-xs text-slate-400">Ganhos Brutos</span>
                    <span class="font-bold text-lg text-cyan-400">${Utils.formatarMoeda(resumo.totalGanhos)}</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg">
                    <span class="block text-xs text-slate-400">Custos Totais</span>
                    <span class="font-bold text-lg text-amber-400">${Utils.formatarMoeda(resumo.totalCustos)}</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg">
                    <span class="block text-xs text-slate-400">Taxa m√©dia</span>
                    <span class="font-bold text-lg text-red-400">${resumo.taxaMediaPercent.toFixed(1)}%</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                    <span class="block text-xs text-slate-400">KM Rodados (${mesSelecionado === -1 ? 'Ano' : 'M√™s'})</span>
                    <span class="font-bold text-lg text-sky-400">${Utils.formatarDistancia(resumo.totalKm)}</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg">
                    <span class="block text-xs text-slate-400">M√©dia Bruta/KM</span>
                    <span class="font-bold text-lg text-green-400">${Utils.formatarMoedaPorKm(resumo.mediaPorKm)}</span>
                </div>
                <div id="mediaKmLCard" class="bg-slate-800 p-2 rounded-lg">
                    <span class="block text-xs text-slate-400">M√©dia Consumo (${unidadeEficiencia})</span>
                    <span class="font-bold text-lg text-cyan-400">${mediaKmLDisplay}</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                    <span class="block text-xs text-slate-400">Horas Trab.</span>
                    <span class="font-bold text-lg text-white">${Utils.formatarDuracao(resumo.totalTempoLiquido, false)}</span>
                </div>
                <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                    <span class="block text-xs text-slate-400">M√©dia Pausa/Dia</span>
                    <span class="font-bold text-lg text-slate-300">${Utils.formatarDuracao(mediaPausaDiaria, false)}</span>
                </div>
            `;
            
            if (AppState.dashboardState.drilldown.active) {
                document.getElementById('graficoGanhosCustosContainer').classList.add('hidden');
                document.getElementById('graficoCustoCombustivelContainer').classList.add('hidden');
                document.getElementById('graficoMediaKmLContainer').classList.add('hidden');
                UIElements.graficoMetasContainer.classList.add('hidden');
                document.getElementById('graficoCategoriasContainer').classList.add('hidden');
                document.getElementById('graficoCustosContainer').classList.add('hidden');
                
                UIRenderer.renderDrilldownChart();

            } else {
                document.getElementById('graficoDrilldownContainer').classList.add('hidden');
                document.getElementById('graficoDrilldownKmContainer').classList.add('hidden');
                
                document.getElementById('graficoGanhosCustosContainer').classList.remove('hidden');
                document.getElementById('graficoCustoCombustivelContainer').classList.remove('hidden');
                document.getElementById('graficoMediaKmLContainer').classList.remove('hidden');
                document.getElementById('graficoCategoriasContainer').classList.remove('hidden');
                document.getElementById('graficoCustosContainer').classList.remove('hidden');
                
                const isMonthly = (mesSelecionado === -1);
                const periodLength = isMonthly ? 12 : Utils.getDaysInMonth(anoSelecionado, mesSelecionado);
                const labelType = isMonthly ? 'mes' : 'dia';

                UIRenderer.renderGraficoGanhosCustos(resumo.dadosDiarios, periodLength, labelType);
                UIRenderer.renderGraficoCustoCombustivel(resumo.dadosCombustivel, periodLength, labelType);
                UIRenderer.renderGraficoMediaKmL(resumo.dadosKmL, periodLength, labelType);
                UIRenderer.renderGraficoCategorias(resumo.ganhosPorCategoria);
                UIRenderer.renderGraficoCustos(resumo.custosPorCategoria);
                UIRenderer.renderGraficoMetasFinanceiras();
            }
        },

 */
 // ============================================================================
// DASHBOARD RENDERER V155 (FIX: SYNC MEM√ìRIA RAM)
// ============================================================================
renderDashboard: () => {
    // 1. POPULA FILTROS (Inicializa√ß√£o)
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const mesAtual = hoje.getMonth(); 

    // Garante popula√ß√£o dos selects se estiverem vazios
    if (UIElements.selectAno.options.length === 0) {
        for (let i = 0; i < 3; i++) {
            const ano = anoAtual - i;
            UIElements.selectAno.innerHTML += `<option value="${ano}">${ano}</option>`;
        }
        UIElements.selectAno.value = anoAtual;
    }
    
    if (UIElements.selectMes.options.length === 0) {
        const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        UIElements.selectMes.innerHTML = `<option value="-1">Ano Inteiro</option>`;
        meses.forEach((mes, index) => UIElements.selectMes.innerHTML += `<option value="${index}">${mes}</option>`);
        UIElements.selectMes.value = mesAtual;
    }

    // 2. RECUPERA VALORES SELECIONADOS
    const anoSelecionado = parseInt(UIElements.selectAno.value);
    const mesSelecionado = parseInt(UIElements.selectMes.value);
    
    // L√≥gica inteligente de dias do m√™s
    const lastMes = UIElements.selectDia.getAttribute('data-last-mes');
    if (lastMes !== String(mesSelecionado)) {
        let diaSalvo = parseInt(UIElements.selectDia.value);
        UIElements.selectDia.innerHTML = `<option value="-1">M√™s Inteiro</option>`;
        if (mesSelecionado > -1) {
            const diasNoMes = Utils.getDaysInMonth(anoSelecionado, mesSelecionado);
            for (let i = 1; i <= diasNoMes; i++) {
                UIElements.selectDia.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
            }
        }
        // Tenta manter o dia selecionado ou vai para hoje se coincidir
        if (!diaSalvo || diaSalvo === -1 || isNaN(diaSalvo)) {
            // Se for o m√™s atual, seleciona o dia de hoje automaticamente
            if (anoSelecionado === anoAtual && mesSelecionado === mesAtual) {
                diaSalvo = hoje.getDate();
            } else {
                diaSalvo = -1;
            }
        }
        UIElements.selectDia.value = diaSalvo;
        UIElements.selectDia.setAttribute('data-last-mes', mesSelecionado);
    }
    
    let diaSelecionado = parseInt(UIElements.selectDia.value);

    // 3. ROADMAP CHECK
    if (AppState.dashboardState.isRoadmapVisible) {
        ['graficoGanhosCustosContainer', 'graficoCustoCombustivelContainer', 'graficoMediaKmLContainer',
         'graficoCategoriasContainer', 'graficoCustosContainer', 'graficoMetasContainer',
         'graficoDrilldownContainer', 'graficoDrilldownKmContainer'].forEach(id => {
             const el = document.getElementById(id); if(el) el.classList.add('hidden');
         });
        UIElements.dashboardResumoCards.classList.add('hidden');
        RoadmapRenderer.render();
        return;
    }

    UIElements.roadmapContainer.classList.add('hidden');
    UIElements.dashboardResumoCards.classList.remove('hidden');

    // 4. C√ÅLCULO DE DADOS
    const filter = AppState.dashboardState.drilldown.active ? AppState.dashboardState.drilldown : null;
    
    // --- 4A. FOR√áA BRUTA (SYNC) - AQUI EST√Å A CORRE√á√ÉO ---
    // Se estivermos vendo o dia de hoje e temos uma jornada ativa na mem√≥ria,
    // for√ßamos o resumo a usar essa jornada viva, em vez de buscar no "banco de dados".
    let resumo;
    const isViewingToday = (anoSelecionado === anoAtual && mesSelecionado === mesAtual && diaSelecionado === hoje.getDate());
    
    if (isViewingToday && AppState.jornadaAtiva) {
        // Usa a jornada da mem√≥ria RAM (que tem os R$ 30,00 que voc√™ acabou de fazer)
        resumo = BusinessLogic.calcularResumoDia(AppState.jornadaAtiva, hoje);
    } else {
        // Usa o m√©todo padr√£o para hist√≥rico ou per√≠odos longos
        resumo = BusinessLogic.calcularResumoPeriodo(anoSelecionado, mesSelecionado, diaSelecionado, filter);
    }

    // C√°lculos Auxiliares
    const mediaPausaDiaria = resumo.diasTrabalhados > 0 ? resumo.totalTempoPausa / resumo.diasTrabalhados : 0;
    const { veiculo } = AppState.configuracoes;
    const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
    const unidadeEficiencia = Utils.formatarEficiencia(0, tipoCombustivel).split(' ')[1];
    let mediaKmLDisplay = "--";
    if (resumo.countKmL > 0) {
        mediaKmLDisplay = (resumo.totalKmL / resumo.countKmL).toFixed(2);
    }

    // 5. RENDERIZA√á√ÉO DOS CARDS (Create Once, Update Often)
    if (!document.getElementById('dash-card-lucro')) {
        console.log("üèóÔ∏è Construindo Cards do Dashboard...");
        UIElements.dashboardResumoCards.className = 'grid grid-cols-2 sm:grid-cols-4 gap-3 text-center';
        UIElements.dashboardResumoCards.innerHTML = `
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Lucro L√≠quido</span>
                <span id="dash-card-lucro" class="font-bold text-lg">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Ganhos Brutos</span>
                <span id="dash-card-ganhos" class="font-bold text-lg text-cyan-400">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Custos Totais</span>
                <span id="dash-card-custos" class="font-bold text-lg text-amber-400">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Taxa m√©dia</span>
                <span id="dash-card-taxa" class="font-bold text-lg text-red-400">0.0%</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                <span class="block text-xs text-slate-400" id="dash-card-km-label">KM Rodados</span>
                <span id="dash-card-km" class="font-bold text-lg text-sky-400">0 km</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">M√©dia Bruta/KM</span>
                <span id="dash-card-mediakm" class="font-bold text-lg text-green-400">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">M√©dia Consumo (${unidadeEficiencia})</span>
                <span id="dash-card-consumo" class="font-bold text-lg text-cyan-400">--</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                <span class="block text-xs text-slate-400">Horas Trab.</span>
                <span id="dash-card-horas" class="font-bold text-lg text-white">00:00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                <span class="block text-xs text-slate-400">M√©dia Pausa/Dia</span>
                <span id="dash-card-pausa" class="font-bold text-lg text-slate-300">00:00</span>
            </div>
        `;
    }

    // 6. ATUALIZA√á√ÉO DOS VALORES
    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    const setClass = (id, cls) => { const el = document.getElementById(id); if(el) el.className = cls; };

    // Aqui os valores corretos da mem√≥ria RAM ser√£o injetados
    setTxt('dash-card-lucro', Utils.formatarMoeda(resumo.totalLucro || resumo.lucroLiquido || 0)); // Fallback de nomes de propriedade
    setClass('dash-card-lucro', `font-bold text-lg ${(resumo.totalLucro || resumo.lucroLiquido) >= 0 ? 'text-green-400' : 'text-red-400'}`);
    
    setTxt('dash-card-ganhos', Utils.formatarMoeda(resumo.totalGanhos || resumo.totalGanhosFinalizados || 0));
    setTxt('dash-card-custos', Utils.formatarMoeda(resumo.totalCustos || resumo.custoOperacionalTotal || 0));
    setTxt('dash-card-taxa', `${(resumo.taxaMediaPercent || 0).toFixed(1)}%`);
    
    setTxt('dash-card-km-label', `KM Rodados (${mesSelecionado === -1 ? 'Ano' : 'M√™s'})`);
    setTxt('dash-card-km', Utils.formatarDistancia(resumo.totalKm || resumo.kmTotal || 0));
    setTxt('dash-card-mediakm', Utils.formatarMoedaPorKm(resumo.mediaPorKm || resumo.ganhoBrutoPorKm || 0));
    setTxt('dash-card-consumo', mediaKmLDisplay);
    
    // Tempo L√≠quido (Verificando propriedade correta)
    const tempoLiq = (typeof resumo.totalTempoLiquido !== 'undefined') ? resumo.totalTempoLiquido : (resumo.tempoLiquido || 0);
    setTxt('dash-card-horas', Utils.formatarDuracao(tempoLiq, false));
    setTxt('dash-card-pausa', Utils.formatarDuracao(mediaPausaDiaria, false));

    // 7. GR√ÅFICOS E DRILLDOWN (Mantido)
    if (AppState.dashboardState.drilldown.active) {
        ['graficoGanhosCustosContainer', 'graficoCustoCombustivelContainer', 'graficoMediaKmLContainer', 
         'graficoMetasContainer', 'graficoCategoriasContainer', 'graficoCustosContainer'].forEach(id => {
             const el = document.getElementById(id); if(el) el.classList.add('hidden');
         });
        UIRenderer.renderDrilldownChart();
    } else {
        document.getElementById('graficoDrilldownContainer').classList.add('hidden');
        document.getElementById('graficoDrilldownKmContainer').classList.add('hidden');
        
        ['graficoGanhosCustosContainer', 'graficoCustoCombustivelContainer', 'graficoMediaKmLContainer', 
         'graficoCategoriasContainer', 'graficoCustosContainer'].forEach(id => {
             const el = document.getElementById(id); if(el) el.classList.remove('hidden');
         });

        const isMonthly = (mesSelecionado === -1);
        const periodLength = isMonthly ? 12 : Utils.getDaysInMonth(anoSelecionado, mesSelecionado);
        const labelType = isMonthly ? 'mes' : 'dia';

        // Garante que os dados dos gr√°ficos venham do resumo correto
        UIRenderer.renderGraficoGanhosCustos(resumo.dadosDiarios || [], periodLength, labelType);
        UIRenderer.renderGraficoCustoCombustivel(resumo.dadosCombustivel || [], periodLength, labelType);
        UIRenderer.renderGraficoMediaKmL(resumo.dadosKmL || [], periodLength, labelType);
        UIRenderer.renderGraficoCategorias(resumo.ganhosPorCategoria || {});
        UIRenderer.renderGraficoCustos(resumo.custosPorCategoria || {});
        UIRenderer.renderGraficoMetasFinanceiras();
    }
},
 /*ultima vers√£o
 renderDashboard: () => {
    // 1. POPULA FILTROS (L√≥gica de Inicializa√ß√£o - Mantida)
    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const mesAtual = hoje.getMonth(); 

    if (UIElements.selectAno.options.length === 0) {
        for (let i = 0; i < 3; i++) {
            const ano = anoAtual - i;
            UIElements.selectAno.innerHTML += `<option value="${ano}">${ano}</option>`;
        }
        UIElements.selectAno.value = anoAtual;
    }
    
    if (UIElements.selectMes.options.length === 0) {
        const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        UIElements.selectMes.innerHTML = `<option value="-1">Ano Inteiro</option>`;
        meses.forEach((mes, index) => UIElements.selectMes.innerHTML += `<option value="${index}">${mes}</option>`);
        UIElements.selectMes.value = mesAtual;
    }

    // 2. RECUPERA VALORES SELECIONADOS
    const anoSelecionado = parseInt(UIElements.selectAno.value);
    const mesSelecionado = parseInt(UIElements.selectMes.value);
    let diaSelecionado = parseInt(UIElements.selectDia.value) || -1;

    // Popula Dias (Din√¢mico)
    // Nota: Essa parte mexe no DOM, mas √© necess√°rio quando muda o m√™s.
    // Otimiza√ß√£o: S√≥ recria se o m√™s mudou.
    const lastMes = UIElements.selectDia.getAttribute('data-last-mes');
    if (lastMes !== String(mesSelecionado)) {
        UIElements.selectDia.innerHTML = `<option value="-1">M√™s Inteiro</option>`;
        if (mesSelecionado > -1) {
            const diasNoMes = Utils.getDaysInMonth(anoSelecionado, mesSelecionado);
            for (let i = 1; i <= diasNoMes; i++) {
                UIElements.selectDia.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
            }
        }
        UIElements.selectDia.value = (diaSelecionado > 0) ? diaSelecionado : -1;
        UIElements.selectDia.setAttribute('data-last-mes', mesSelecionado);
    }

    // 3. ROADMAP CHECK
    if (AppState.dashboardState.isRoadmapVisible) {
        // Esconde tudo e mostra Roadmap
        ['graficoGanhosCustosContainer', 'graficoCustoCombustivelContainer', 'graficoMediaKmLContainer',
         'graficoCategoriasContainer', 'graficoCustosContainer', 'graficoMetasContainer',
         'graficoDrilldownContainer', 'graficoDrilldownKmContainer'].forEach(id => {
             document.getElementById(id).classList.add('hidden');
         });
        UIElements.dashboardResumoCards.classList.add('hidden');
        RoadmapRenderer.render();
        return;
    }

    UIElements.roadmapContainer.classList.add('hidden');
    UIElements.dashboardResumoCards.classList.remove('hidden');

    // 4. C√ÅLCULO DE DADOS (Business Logic Pura)
    const filter = AppState.dashboardState.drilldown.active ? AppState.dashboardState.drilldown : null;
    const resumo = BusinessLogic.calcularResumoPeriodo(anoSelecionado, mesSelecionado, diaSelecionado, filter);
    
    // C√°lculos Auxiliares
    const mediaPausaDiaria = resumo.diasTrabalhados > 0 ? resumo.totalTempoPausa / resumo.diasTrabalhados : 0;
    const { veiculo } = AppState.configuracoes;
    const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
    const unidadeEficiencia = Utils.formatarEficiencia(0, tipoCombustivel).split(' ')[1];
    let mediaKmLDisplay = "--";
    if (resumo.countKmL > 0) {
        mediaKmLDisplay = (resumo.totalKmL / resumo.countKmL).toFixed(2);
    }

    // 5. RENDERIZA√á√ÉO INTELIGENTE DOS CARDS (O Segredo)
    // Verifica se os cards j√° existem. Se n√£o, cria o esqueleto.
    if (!document.getElementById('dash-card-lucro')) {
        console.log("üèóÔ∏è Construindo Cards do Dashboard...");
        UIElements.dashboardResumoCards.className = 'grid grid-cols-2 sm:grid-cols-4 gap-3 text-center';
        UIElements.dashboardResumoCards.innerHTML = `
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Lucro L√≠quido</span>
                <span id="dash-card-lucro" class="font-bold text-lg">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Ganhos Brutos</span>
                <span id="dash-card-ganhos" class="font-bold text-lg text-cyan-400">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Custos Totais</span>
                <span id="dash-card-custos" class="font-bold text-lg text-amber-400">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">Taxa m√©dia</span>
                <span id="dash-card-taxa" class="font-bold text-lg text-red-400">0.0%</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                <span class="block text-xs text-slate-400" id="dash-card-km-label">KM Rodados</span>
                <span id="dash-card-km" class="font-bold text-lg text-sky-400">0 km</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">M√©dia Bruta/KM</span>
                <span id="dash-card-mediakm" class="font-bold text-lg text-green-400">R$ 0,00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg">
                <span class="block text-xs text-slate-400">M√©dia Consumo (${unidadeEficiencia})</span>
                <span id="dash-card-consumo" class="font-bold text-lg text-cyan-400">--</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                <span class="block text-xs text-slate-400">Horas Trab.</span>
                <span id="dash-card-horas" class="font-bold text-lg text-white">00:00</span>
            </div>
            <div class="bg-slate-800 p-2 rounded-lg col-span-2">
                <span class="block text-xs text-slate-400">M√©dia Pausa/Dia</span>
                <span id="dash-card-pausa" class="font-bold text-lg text-slate-300">00:00</span>
            </div>
        `;
    }

    // 6. ATUALIZA√á√ÉO DOS VALORES (R√°pida e Segura)
    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    const setClass = (id, cls) => { const el = document.getElementById(id); if(el) el.className = cls; };

    setTxt('dash-card-lucro', Utils.formatarMoeda(resumo.totalLucro));
    setClass('dash-card-lucro', `font-bold text-lg ${resumo.totalLucro >= 0 ? 'text-green-400' : 'text-red-400'}`);
    
    setTxt('dash-card-ganhos', Utils.formatarMoeda(resumo.totalGanhos));
    setTxt('dash-card-custos', Utils.formatarMoeda(resumo.totalCustos));
    setTxt('dash-card-taxa', `${resumo.taxaMediaPercent.toFixed(1)}%`);
    
    setTxt('dash-card-km-label', `KM Rodados (${mesSelecionado === -1 ? 'Ano' : 'M√™s'})`);
    setTxt('dash-card-km', Utils.formatarDistancia(resumo.totalKm));
    setTxt('dash-card-mediakm', Utils.formatarMoedaPorKm(resumo.mediaPorKm));
    setTxt('dash-card-consumo', mediaKmLDisplay);
    
    setTxt('dash-card-horas', Utils.formatarDuracao(resumo.totalTempoLiquido, false));
    setTxt('dash-card-pausa', Utils.formatarDuracao(mediaPausaDiaria, false));

    // 7. GR√ÅFICOS E DRILLDOWN (Mantido Igual)
    if (AppState.dashboardState.drilldown.active) {
        ['graficoGanhosCustosContainer', 'graficoCustoCombustivelContainer', 'graficoMediaKmLContainer', 
         'graficoMetasContainer', 'graficoCategoriasContainer', 'graficoCustosContainer'].forEach(id => {
             const el = document.getElementById(id); if(el) el.classList.add('hidden');
         });
        
        UIRenderer.renderDrilldownChart();
    } else {
        document.getElementById('graficoDrilldownContainer').classList.add('hidden');
        document.getElementById('graficoDrilldownKmContainer').classList.add('hidden');
        
        ['graficoGanhosCustosContainer', 'graficoCustoCombustivelContainer', 'graficoMediaKmLContainer', 
         'graficoCategoriasContainer', 'graficoCustosContainer'].forEach(id => {
             const el = document.getElementById(id); if(el) el.classList.remove('hidden');
         });

        const isMonthly = (mesSelecionado === -1);
        const periodLength = isMonthly ? 12 : Utils.getDaysInMonth(anoSelecionado, mesSelecionado);
        const labelType = isMonthly ? 'mes' : 'dia';

        UIRenderer.renderGraficoGanhosCustos(resumo.dadosDiarios, periodLength, labelType);
        UIRenderer.renderGraficoCustoCombustivel(resumo.dadosCombustivel, periodLength, labelType);
        UIRenderer.renderGraficoMediaKmL(resumo.dadosKmL, periodLength, labelType);
        UIRenderer.renderGraficoCategorias(resumo.ganhosPorCategoria);
        UIRenderer.renderGraficoCustos(resumo.custosPorCategoria);
        UIRenderer.renderGraficoMetasFinanceiras();
    }
},
*/

renderGraficoGanhosCustos: (dados, periodLength, labelType = 'dia') => {
    // 1. Prepara os dados (Igual antes)
    let labels = [];
    const ganhosData = new Array(periodLength).fill(0);
    const custosData = new Array(periodLength).fill(0);

    if (labelType === 'mes') {
        labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        dados.forEach(dado => {
            ganhosData[dado.mes] = dado.ganhos;
            custosData[dado.mes] = dado.custos;
        });
    } else { 
        labels = Array.from({ length: periodLength }, (_, i) => i + 1);
        dados.forEach(dado => {
            ganhosData[dado.dia - 1] = dado.ganhos;
            custosData[dado.dia - 1] = dado.custos;
        });
    }

    // 2. L√ìGICA INTELIGENTE: Atualiza ou Cria
    if (AppState.graficos.ganhosCustos) {
        // Se j√° existe, s√≥ atualiza os dados
        const chart = AppState.graficos.ganhosCustos;
        chart.data.labels = labels;
        chart.data.datasets[0].data = ganhosData;
        chart.data.datasets[1].data = custosData;
        chart.update(); // Anima√ß√£o suave
    } else {
        // Se n√£o existe, cria do zero
        AppState.graficos.ganhosCustos = new Chart(UIElements.graficoGanhosCustos, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ganhos',
                    data: ganhosData,
                    borderColor: '#22d3ee',
                    backgroundColor: 'rgba(34, 211, 238, 0.2)',
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'Custos',
                    data: custosData,
                    borderColor: '#fb923c',
                    backgroundColor: 'rgba(251, 146, 60, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#cbd5e1' } } },
                scales: {
                    y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
                }
            }
        });
    }
},
renderGraficoCustoCombustivel: (dados, periodLength, labelType = 'dia') => {
    let labels = [];
    const custoData = new Array(periodLength).fill(0);

    if (labelType === 'mes') {
        labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        dados.forEach(dado => {
            custoData[dado.mes] = dado.custoCombustivel;
        });
    } else {
        labels = Array.from({ length: periodLength }, (_, i) => i + 1);
        dados.forEach(dado => {
            custoData[dado.dia - 1] = dado.custoCombustivel;
        });
    }

    const { veiculo } = AppState.configuracoes;
    const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
    const label = tipoCombustivel.toLowerCase().includes('el√©trico') ? 'Custo Energia (kWh)' : 'Custo Combust√≠vel';

    if (AppState.graficos.custoCombustivel) {
        const chart = AppState.graficos.custoCombustivel;
        chart.data.labels = labels;
        chart.data.datasets[0].label = label;
        chart.data.datasets[0].data = custoData;
        chart.update();
    } else {
        AppState.graficos.custoCombustivel = new Chart(UIElements.graficoCustoCombustivel, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: custoData,
                    backgroundColor: '#fb923c',
                    borderColor: '#f97316',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${Utils.formatarMoeda(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
                }
            }
        });
    }
},

renderGraficoMediaKmL: (dados, periodLength, labelType = 'dia') => {
    let labels = [];
    const mediaData = new Array(periodLength).fill(null);

    if (labelType === 'mes') {
        labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        dados.forEach(dado => {
            mediaData[dado.mes] = dado.mediaKmL > 0 ? dado.mediaKmL : null;
        });
    } else {
        labels = Array.from({ length: periodLength }, (_, i) => i + 1);
        dados.forEach(dado => {
            mediaData[dado.dia - 1] = dado.mediaKmL > 0 ? dado.mediaKmL : null;
        });
    }
    
    const { veiculo } = AppState.configuracoes;
    const tipoCombustivel = veiculo.combustivel || 'Gasolina Comum';
    const unidadeEficiencia = Utils.formatarEficiencia(0, tipoCombustivel).split(' ')[1];
    const autonomiaBase = veiculo.autonomia || 0;
    
    UIElements.tituloGraficoMediaKmL.textContent = `M√©dia de Consumo (${unidadeEficiencia})`;
    const autonomiaData = autonomiaBase > 0 ? new Array(periodLength).fill(autonomiaBase) : [];

    if (AppState.graficos.mediaKmL) {
        const chart = AppState.graficos.mediaKmL;
        chart.data.labels = labels;
        chart.data.datasets[0].label = `M√©dia ${unidadeEficiencia}`;
        chart.data.datasets[0].data = mediaData;
        chart.data.datasets[1].label = `Padr√£o (${autonomiaBase} ${unidadeEficiencia})`;
        chart.data.datasets[1].data = autonomiaData;
        chart.update();
    } else {
        AppState.graficos.mediaKmL = new Chart(UIElements.graficoMediaKmL, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                {
                    label: `M√©dia ${unidadeEficiencia}`,
                    data: mediaData,
                    borderColor: '#22d3ee',
                    backgroundColor: 'rgba(34, 211, 238, 0.2)',
                    fill: false,
                    tension: 0.3,
                    spanGaps: true
                },
                {
                    label: `Padr√£o (${autonomiaBase} ${unidadeEficiencia})`,
                    data: autonomiaData,
                    borderColor: '#475569',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { 
                    legend: { labels: { color: '#cbd5e1' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toFixed(2)} ${unidadeEficiencia}`;
                            }
                        }
                    }
                },
                scales: {
                    y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
                }
            }
        });
    }
}, 
renderGraficoCategorias: (ganhosData) => {
            // 1. Prepara Labels e Dados com base no N√≠vel Atual
            let labels = [];
            let data = [];
            let title = 'Receita por Categoria';
            
            // L√≥gica do bot√£o voltar (Mantida igual)
            if (!UIElements.btnVoltarGraficoCat) {
                const chartContainer = UIElements.graficoCategorias.parentElement.parentElement;
                const titleElement = chartContainer.querySelector('h4');
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-center relative';
                const backButton = document.createElement('button');
                backButton.id = 'btnVoltarGraficoCat';
                backButton.className = 'absolute left-0 top-0 bg-slate-700 hover:bg-slate-600 text-white py-1 px-3 rounded-lg text-sm hidden';
                backButton.innerHTML = '‚Üê Voltar';
                wrapper.appendChild(backButton);
                const newTitle = titleElement.cloneNode(true);
                wrapper.appendChild(newTitle);
                chartContainer.replaceChild(wrapper, titleElement.parentElement);
                UIElements.btnVoltarGraficoCat = backButton;
                UIElements.tituloGraficoCategorias = newTitle;
                UIElements.btnVoltarGraficoCat.addEventListener('click', () => {
                    AppState.dashboardState.graficoCategoriaNivel = 'categoria';
                    AppState.dashboardState.graficoCategoriaPai = null;
                    UIRenderer.renderDashboard();
                });
            }
            
            const { btnVoltarGraficoCat, tituloGraficoCategorias } = UIElements;
            
            if (AppState.dashboardState.graficoCategoriaNivel === 'categoria') {
                labels = Object.keys(ganhosData);
                data = Object.values(ganhosData).map(d => d.total);
                title = 'Receita por Categoria';
                btnVoltarGraficoCat.classList.add('hidden');
            } else { 
                const subData = ganhosData[AppState.dashboardState.graficoCategoriaPai]?.sub || {};
                labels = Object.keys(subData);
                data = Object.values(subData).map(d => d.total);
                title = `Receita: ${AppState.dashboardState.graficoCategoriaPai}`;
                btnVoltarGraficoCat.classList.remove('hidden');
            }
            
            tituloGraficoCategorias.textContent = title;

            if(labels.length === 0 || data.reduce((a, b) => a + b, 0) === 0) {
                UIElements.graficoCategorias.style.display = 'none';
                return;
            }
            UIElements.graficoCategorias.style.display = 'block';

            // --- CORRE√á√ÉO DEFINITIVA: MATA O GR√ÅFICO ANTIGO ---
            // Removemos a otimiza√ß√£o de update() para garantir que o evento onClick
            // seja recriado com o escopo (labels) atualizado.
            if (AppState.graficos.categorias) {
                AppState.graficos.categorias.destroy();
                AppState.graficos.categorias = null;
            }

            // Cria do zero com o contexto correto (N√≠vel 1 ou N√≠vel 2)
            AppState.graficos.categorias = new Chart(UIElements.graficoCategorias, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ganhos',
                        data: data,
                        backgroundColor: ['#22d3ee', '#818cf8', '#f472b6', '#fb923c', '#a3e635', '#f87171', '#fbbf24'],
                        borderColor: '#1e293b',
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Importante para layout responsivo
                    plugins: {
                        legend: { position: 'top', labels: { color: '#cbd5e1' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${Utils.formatarMoeda(context.raw)}`;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length === 0) return;
                        
                        const index = elements[0].index;
                        // AQUI ESTAVA O ERRO: labels[index] agora √© garantido ser do n√≠vel atual
                        const clickedName = labels[index]; 

                        if (AppState.dashboardState.graficoCategoriaNivel === 'categoria') {
                            // N√≠vel 1 -> Vai para N√≠vel 2 (Subcategorias) ou Drilldown direto
                            const subData = ganhosData[clickedName]?.sub || {};
                            const subKeys = Object.keys(subData);
                            
                            // Se tem subcategorias reais, entra nelas
                            if (subKeys.length > 1 || (subKeys.length === 1 && subKeys[0] !== 'N/A')) {
                                AppState.dashboardState.graficoCategoriaNivel = 'subcategoria';
                                AppState.dashboardState.graficoCategoriaPai = clickedName;
                                UIRenderer.renderDashboard(); // Re-renderiza para criar o novo gr√°fico
                            } else {
                                // Se n√£o tem sub, vai direto pro gr√°fico de barras
                                AppState.dashboardState.drilldown = { active: true, type: 'receita', category: clickedName, subcategory: null };
                                UIRenderer.renderDashboard();
                            }
                        } else {
                            // N√≠vel 2 -> Vai para Drilldown (Gr√°fico de Barras)
                            const categoriaPai = AppState.dashboardState.graficoCategoriaPai;
                            // Aqui clickedName √© a subcategoria (ex: Uber)
                            AppState.dashboardState.drilldown = { active: true, type: 'receita', category: categoriaPai, subcategory: clickedName };
                            UIRenderer.renderDashboard();
                        }
                    }
                }
            });
        },

renderGraficoCustos: (custosData) => {
            // L√≥gica do bot√£o voltar (Mantida)
            if (!UIElements.btnVoltarGraficoCusto) {
                 const chartContainer = UIElements.graficoCustos.parentElement.parentElement;
                 const titleElement = chartContainer.querySelector('h4');
                 const wrapper = document.createElement('div');
                 wrapper.className = 'flex items-center justify-center relative';
                 const backButton = document.createElement('button');
                 backButton.id = 'btnVoltarGraficoCusto';
                 backButton.className = 'absolute left-0 top-0 bg-slate-700 hover:bg-slate-600 text-white py-1 px-3 rounded-lg text-sm hidden';
                 backButton.innerHTML = '‚Üê Voltar';
                 wrapper.appendChild(backButton);
                 const newTitle = titleElement.cloneNode(true);
                 newTitle.id = 'tituloGraficoCustos';
                 wrapper.appendChild(newTitle);
                 chartContainer.replaceChild(wrapper, titleElement.parentElement);
                 UIElements.btnVoltarGraficoCusto = backButton;
                 UIElements.tituloGraficoCustos = newTitle;
                 UIElements.btnVoltarGraficoCusto.addEventListener('click', () => {
                     AppState.dashboardState.graficoCustoNivel = 'categoria';
                     AppState.dashboardState.graficoCustoPai = null;
                     UIRenderer.renderDashboard();
                 });
            }

            let labels = [];
            let data = [];
            let title = 'Despesas por Categoria';
            const { btnVoltarGraficoCusto, tituloGraficoCustos } = UIElements;

            if (AppState.dashboardState.graficoCustoNivel === 'categoria') {
                labels = Object.keys(custosData);
                data = Object.values(custosData).map(d => d.total);
                title = 'Despesas por Categoria';
                btnVoltarGraficoCusto.classList.add('hidden');
            } else { 
                const subData = custosData[AppState.dashboardState.graficoCustoPai]?.sub || {};
                labels = Object.keys(subData);
                data = Object.values(subData);
                title = `Despesas: ${AppState.dashboardState.graficoCustoPai}`;
                btnVoltarGraficoCusto.classList.remove('hidden');
            }
            
            tituloGraficoCustos.textContent = title;

            if(labels.length === 0 || data.reduce((a, b) => a + b, 0) === 0) {
                UIElements.graficoCustos.style.display = 'none';
                return;
            }
            UIElements.graficoCustos.style.display = 'block';

            // --- CORRE√á√ÉO DEFINITIVA: SEMPRE DESTR√ìI O ANTIGO ---
            if (AppState.graficos.custos) {
                AppState.graficos.custos.destroy();
                AppState.graficos.custos = null;
            }

            AppState.graficos.custos = new Chart(UIElements.graficoCustos, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Custos',
                        data: data,
                        backgroundColor: ['#fb923c', '#f87171', '#fbbf24', '#a3e635', '#4ade80', '#22d3ee', '#818cf8', '#f472b6'],
                        borderColor: '#1e293b',
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: '#cbd5e1' } } },
                    onClick: (event, elements) => {
                        if (elements.length === 0) return;
                        
                        const index = elements[0].index;
                        const clickedName = labels[index]; // Agora pega o label correto do n√≠vel atual!

                        if (AppState.dashboardState.graficoCustoNivel === 'categoria') {
                            const subData = custosData[clickedName]?.sub || {};
                            const subKeys = Object.keys(subData);
                            if (subKeys.length > 1 || (subKeys.length === 1 && subKeys[0] !== 'N/A')) {
                                AppState.dashboardState.graficoCustoNivel = 'subcategoria';
                                AppState.dashboardState.graficoCustoPai = clickedName;
                                UIRenderer.renderDashboard();
                            } else {
                                AppState.dashboardState.drilldown = { active: true, type: 'custo', category: clickedName, subcategory: null };
                                UIRenderer.renderDashboard();
                            }
                        } else {
                            const categoriaPai = AppState.dashboardState.graficoCustoPai;
                            AppState.dashboardState.drilldown = { active: true, type: 'custo', category: categoriaPai, subcategory: clickedName };
                            UIRenderer.renderDashboard();
                        }
                    }
                }
            });
        },


renderGraficoMetasFinanceiras: () => {
    const { metasFinanceiras } = AppState.configuracoes;
    const metasAtivas = metasFinanceiras
        .filter(m => (m.valorTotal || 0) > 0)
        .map(m => ({
            ...m,
            valorAtual: BusinessLogic.calcularSaldoConta(m.id)
        }));
    
    if (metasAtivas.length === 0) {
        UIElements.graficoMetasContainer.classList.add('hidden');
        return;
    }
    
    UIElements.graficoMetasContainer.classList.remove('hidden');

    const labels = metasAtivas.map(m => m.descricao);
    const dataValorAtual = metasAtivas.map(m => m.valorAtual || 0);
    const dataValorRestante = metasAtivas.map(m => Math.max(0, (m.valorTotal || 0) - (m.valorAtual || 0)));

    if (AppState.graficos.metasFinanceiras) {
        const chart = AppState.graficos.metasFinanceiras;
        chart.data.labels = labels;
        chart.data.datasets[0].data = dataValorAtual;
        chart.data.datasets[1].data = dataValorRestante;
        chart.update();
    } else {
        AppState.graficos.metasFinanceiras = new Chart(UIElements.graficoMetasFinanceiras, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Progresso Atual',
                        data: dataValorAtual,
                        backgroundColor: '#22d3ee',
                        borderColor: '#06b6d4',
                        borderWidth: 1
                    },
                    {
                        label: 'Valor Restante',
                        data: dataValorRestante,
                        backgroundColor: 'rgba(71, 85, 105, 0.5)',
                        borderColor: '#475569',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#cbd5e1' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${Utils.formatarMoeda(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
                    y: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
                }
            }
        });
    }
},    

renderDrilldownChart: () => {
            // 1. Limpeza e Prepara√ß√£o
            if (AppState.graficos.drilldown) {
                AppState.graficos.drilldown.destroy();
            }
            // Limpa gr√°ficos secund√°rios se existirem
            if (AppState.graficos.drilldownKm) AppState.graficos.drilldownKm.destroy();
            if (AppState.graficos.drilldownValue) AppState.graficos.drilldownValue.destroy(); // <--- NOVO

            const { type, category, subcategory } = AppState.dashboardState.drilldown;
            if (!type || !category) return;

            const ano = parseInt(UIElements.selectAno.value);
            const mes = parseInt(UIElements.selectMes.value);

            if (mes === -1) {
                UIRenderer.abrirModal('alerta', { titulo: 'Vis√£o Mensal', mensagem: 'O detalhamento di√°rio s√≥ est√° dispon√≠vel ao selecionar um m√™s espec√≠fico.' });
                EventHandlers.handleVoltarDrilldown();
                return;
            }

            const drilldownContainer = document.getElementById('graficoDrilldownContainer');
            const drilldownTitle = document.getElementById('tituloGraficoDrilldown');
            const drilldownBackBtn = document.getElementById('btnVoltarGraficoDrilldown');
            const canvasDrilldown = document.getElementById('graficoDrilldown');

            // T√≠tulo e Bot√£o Voltar
            let chartTitle = `Di√°rio: ${category}`;
            if (subcategory) chartTitle += ` (${subcategory})`;
            drilldownTitle.textContent = chartTitle;
            drilldownTitle.classList.add('mt-8'); 
            
            // Recria bot√£o voltar para limpar listeners antigos
            const newBtn = drilldownBackBtn.cloneNode(true);
            drilldownBackBtn.parentNode.replaceChild(newBtn, drilldownBackBtn);
            newBtn.addEventListener('click', EventHandlers.handleVoltarDrilldown);
            newBtn.classList.remove('hidden');
            UIElements.btnVoltarDrilldown = newBtn; 

            // 2. Prepara√ß√£o dos Dados
            const daysInMonth = new Date(ano, mes + 1, 0).getDate();
            const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            
            // Arrays de Dados
            const dataTempo = new Array(daysInMonth).fill(0); // Tempo (Minutos)
            const dataValor = new Array(daysInMonth).fill(0); // Valor (R$) - NOVO
            const dataKm = new Array(daysInMonth).fill(0);    // KM (Para receitas)

            let barColor = type === 'receita' ? '#22d3ee' : '#fb923c';
            if (type === 'receita' && AppState.configuracoes.subcategorias[category]) {
                const subcatConfig = AppState.configuracoes.subcategorias[category].find(s => s.nome === (subcategory || category));
                if (subcatConfig) barColor = subcatConfig.cor;
            }

            const diasTrabalhoMes = BusinessLogic.calcularDiasTrabalhoNoMes(ano, mes);
            let temDados = false;

            // 3. Loop de C√°lculo (Preenche Arrays)
            for (const chave in AppState.jornadas) {
                const dataJornada = new Date(chave + 'T12:00:00');
                if (dataJornada.getFullYear() !== ano || dataJornada.getMonth() !== mes) continue;
                
                const diaIndex = dataJornada.getDate() - 1;
                const jornada = AppState.jornadas[chave];
                
                // Dados para c√°lculo de tempo de trabalho
                const resumoDia = BusinessLogic.calcularResumoDia(jornada, dataJornada);
                const tempoLiquidoMinutos = (resumoDia.tempoLiquido || 0) / 60000;
                const ganhoPorMinuto = (tempoLiquidoMinutos > 0 && resumoDia.totalGanhosFinalizados > 0) 
                                     ? resumoDia.totalGanhosFinalizados / tempoLiquidoMinutos 
                                     : 0;
                
                if (type === 'receita') {
                    // ... (L√≥gica de Receita mantida igual) ...
                    jornada.atividades.forEach(at => {
                        let subcatMatch = false;
                        if (!subcategory) subcatMatch = true;
                        else if (subcategory === 'N/A') subcatMatch = !at.subcategoria;
                        else subcatMatch = (at.subcategoria === subcategory);

                        if (at.categoria === category && subcatMatch) {
                            dataValor[diaIndex] += at.valor; // Valor R$
                            dataTempo[diaIndex] += 0; // Receita n√£o usa tempo de custo
                            const km = (at.kmFinalServico && at.kmInicialServico && at.kmFinalServico > at.kmInicialServico) ? (at.kmFinalServico - at.kmInicialServico) : 0;
                            dataKm[diaIndex] += km;
                            temDados = true;
                        }
                    });
                } else { 
                    // L√ìGICA DE CUSTOS (MODIFICADA PARA PEGAR VALOR REAL)
                    let custoTotalDoDiaEmValor = 0;
                    
                    // A) Vari√°veis (Jornada)
                    if (category === 'Abastecimento' && (!subcategory || subcategory === 'Combust√≠vel')) {
                        custoTotalDoDiaEmValor += jornada.custos.abastecimento.valor || 0;
                    }
                    jornada.custos.outros.forEach(custo => {
                        const custoCat = custo.categoria || 'Outro C. Vari√°vel';
                        const pieSubcat = (custo.subcategoria && custo.subcategoria !== 'N/A') ? custo.subcategoria : (custo.descricao || 'N/A');
                        let subcatMatch = !subcategory || (pieSubcat === subcategory);
                        if (custoCat === category && subcatMatch) custoTotalDoDiaEmValor += custo.valor;
                    });
                    
                    // B) Fixos e Metas (Rateados)
                    if (category === 'Deprecia√ß√£o' && (!subcategory || subcategory === 'Ve√≠culo')) {
                        const { veiculo } = AppState.configuracoes;
                        if (veiculo.valor > 0 && diasTrabalhoMes > 0) {
                            custoTotalDoDiaEmValor += ((veiculo.valor / (veiculo.vidaUtil || 5)) / 12) / diasTrabalhoMes;
                        }
                    }
                    AppState.configuracoes.custosFixos.forEach(custo => {
                        const custoCat = custo.categoria || 'Outro C. Fixo';
                        const pieSubcat = (custo.subcategoria && custo.subcategoria !== 'N/A') ? custo.subcategoria : (custo.descricao || 'N/A');
                        let subcatMatch = !subcategory || (pieSubcat === subcategory);
                        if (custoCat === category && subcatMatch && diasTrabalhoMes > 0) {
                            custoTotalDoDiaEmValor += (custo.valor / diasTrabalhoMes);
                        }
                    });
                    if (category === 'Metas Financeiras') {
                        AppState.configuracoes.metasFinanceiras
                            .filter(meta => meta.incluirComoCustoDiario !== false)
                            .forEach(meta => {
                                if (!subcategory || meta.descricao === subcategory) {
                                    custoTotalDoDiaEmValor += BusinessLogic.calcularCustoDiarioMeta(meta, dataJornada);
                                }
                            });
                    }
                    
                    // SALVA OS DADOS
                    if (custoTotalDoDiaEmValor > 0) {
                        temDados = true;
                        dataValor[diaIndex] = custoTotalDoDiaEmValor; // Valor Real (R$)
                        
                        if (ganhoPorMinuto > 0) {
                            dataTempo[diaIndex] = custoTotalDoDiaEmValor / ganhoPorMinuto; // Tempo (Minutos)
                        }
                    }
                }
            }

            // Sem dados? Limpa e volta
            if (!temDados) {
                drilldownContainer.classList.remove('hidden');
                const ctx = canvasDrilldown.getContext('2d');
                ctx.clearRect(0, 0, canvasDrilldown.width, canvasDrilldown.height);
                ctx.save(); ctx.font = "16px sans-serif"; ctx.fillStyle = "#94a3b8"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText("Sem dados registrados.", canvasDrilldown.width / 2, canvasDrilldown.height / 2); ctx.restore();
                return;
            }

            drilldownContainer.classList.remove('hidden');

            // 4. Renderiza Gr√°fico Principal (Tempo ou Receita)
            // Se for Custo, o gr√°fico principal √© TEMPO (como voc√™ j√° tinha)
            // Se for Receita, o gr√°fico principal √© VALOR
            const dadosPrincipal = type === 'receita' ? dataValor : dataTempo;
            const labelPrincipal = type === 'receita' ? category : 'Tempo Trabalhado para Pagar';
            
            AppState.graficos.drilldown = new Chart(canvasDrilldown, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelPrincipal,
                        data: dadosPrincipal,
                        backgroundColor: barColor,
                        borderColor: Utils.getContrastingTextColor(barColor),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            callbacks: { 
                                label: (c) => type === 'receita' ? Utils.formatarMoeda(c.raw) : `${Math.round(c.raw)} min`
                            } 
                        }
                    },
                    scales: {
                        y: { 
                            ticks: { color: '#94a3b8' }, 
                            grid: { color: 'rgba(148, 163, 184, 0.2)' } 
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
                    }
                }
            });

            // 5. GR√ÅFICO SECUND√ÅRIO: VALOR (R$) - S√ì PARA CUSTOS
            // Se for receita, j√° mostramos valor no principal. Se for custo, mostramos o R$ agora.
            const containerKm = document.getElementById('graficoDrilldownKmContainer');
            
            if (type === 'custo') {
                // Cria dinamicamente se n√£o existir ou reutiliza o de KM
                // Vamos reutilizar o container do KM para desenhar o Valor, mudando o t√≠tulo
                containerKm.classList.remove('hidden');
                
                // T√≠tulo din√¢mico
                const titleKm = document.getElementById('tituloGraficoDrilldownKm');
                if(titleKm) titleKm.textContent = `Custo Real (R$) - ${category}`;
                
                // Renderiza Gr√°fico de Valor
                const ctxVal = document.getElementById('graficoDrilldownKm'); // Reusa canvas
                if (ctxVal) {
                    AppState.graficos.drilldownValue = new Chart(ctxVal, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Valor (R$)',
                                data: dataValor, // <--- AQUI ENTRA O VALOR R$
                                backgroundColor: '#f87171', // Vermelho claro
                                borderColor: '#ef4444',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => Utils.formatarMoeda(c.raw) } } },
                            scales: { y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }, x: { display: false } }
                        }
                    });
                }
            } 
            // GR√ÅFICO SECUND√ÅRIO: KM (PARA RECEITAS)
            else if (type === 'receita') {
                containerKm.classList.remove('hidden');
                UIRenderer.renderDrilldownKmChart(labels, dataKm, barColor, `KM Produtivo - ${category}`);
            }
        },

// --- FUN√á√ÉO AUXILIAR PARA O GR√ÅFICO DE KM ---
renderDrilldownKmChart: (labels, dataKm, barColor, title) => {
    const ctx = document.getElementById('graficoDrilldownKm');
    const titleEl = document.getElementById('tituloGraficoDrilldownKm');
    
    if (titleEl) titleEl.textContent = title;

    AppState.graficos.drilldownKm = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'KM',
                data: dataKm,
                backgroundColor: barColor, // Usa a mesma cor, mas com opacidade
                borderColor: barColor,
                borderWidth: 1,
                opacity: 0.7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: { 
                    callbacks: { 
                        label: (c) => `${Utils.formatarDistancia(c.raw)}` 
                    } 
                }
            },
            scales: {
                y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
            }
        }
    });
},

  // --- IN√çCIO: NOVA FUN√á√ÉO (GR√ÅFICO DE KM) ---
        /**
         * Renderiza o gr√°fico de barras de drilldown di√°rio (KM Produtivo).
         */
        renderDrilldownKmChart: (labels, dataKm, barColor, categoryTitle) => {
            const drilldownKmContainer = document.getElementById('graficoDrilldownKmContainer');
            const drilldownKmChart = document.getElementById('graficoDrilldownKm');
            const drilldownKmTitle = document.getElementById('tituloGraficoDrilldownKm');

            // Se n√£o houver KM para mostrar, esconde o gr√°fico e sai
            const totalKm = dataKm.reduce((a, b) => a + b, 0);
            if (totalKm === 0) {
                drilldownKmContainer.classList.add('hidden');
                if (AppState.graficos.drilldownKm) {
                    AppState.graficos.drilldownKm.destroy();
                    AppState.graficos.drilldownKm = null;
                }
                return;
            }

            // Destr√≥i gr√°fico anterior
            if (AppState.graficos.drilldownKm) {
                AppState.graficos.drilldownKm.destroy();
            }

            drilldownKmContainer.classList.remove('hidden');
            drilldownKmTitle.textContent = `${categoryTitle.replace('Di√°rio:', 'KM Produtivo:')}`;

            // Renderiza o novo gr√°fico
            AppState.graficos.drilldownKm = new Chart(drilldownKmChart, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'KM Produtivo',
                        data: dataKm,
                        backgroundColor: barColor,
                        borderColor: Utils.getContrastingTextColor(barColor),
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${Utils.formatarDistancia(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } }
                    }
                }
            });
        },
        // --- FIM: NOVA FUN√á√ÉO (GR√ÅFICO DE KM) ---

        // --- FIM DO NOVO TRECHO ---
      
      
   abrirModal: (type, options) => {
   SystemLog.info('UI', `Abrindo Modal: ${type}`);
            let modalHTML = '';
            
            // --- LISTA DE PRESERVA√á√ÉO DE CONTEXTO ---
            // Impede que o sistema limpe os dados da simula√ß√£o ao abrir sub-modais
            const tiposQueMantemContexto = ['criarCaixinhaAmortizacao', 'selecionarFontePagamento', 'alerta', 'confirmacao'];
            
            if (!tiposQueMantemContexto.includes(type)) {
                AppState.currentScheduleModal = null;
            }
            if (!tiposQueMantemContexto.includes(type)) {
                AppState.modalContext = null;
            }

            switch(type) {
                
// 6. SELECIONAR FONTE DE PAGAMENTO (CORRIGIDO: BOT√ÉO VOLTAR FUNCIONAL)
                case 'selecionarFontePagamento': {
                    const { pv, parcelas, dataRef } = options;
                    const qtdParcelas = parcelas ? String(parcelas).split(',').length : 0;
                    
                    // Recupera ID da meta
                    const metaDividaId = AppState.itemParaEditarId; 
                    const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                    const fontes = [];
                    
                    // 1. Caixinha Pr√≥pria
                    const metaDivida = metasFinanceiras.find(m => m.id === metaDividaId);
                    if (metaDivida && metaDivida.valorProvisionado > 0) {
                        fontes.push({ 
                            id: 'PROVISIONADO_PROPRIO', 
                            nome: `Saldo da Caixinha (${metaDivida.descricao})`, 
                            tipo: 'Caixinha', 
                            saldo: metaDivida.valorProvisionado, 
                            destaque: true 
                        });
                    }
                    // 2. Bancos
                    contasBancarias.forEach(c => {
                        if (c.tipo !== 'credito') {
                            const saldo = BusinessLogic.calcularSaldoConta(c.id);
                            fontes.push({ id: c.id, nome: c.nome, tipo: 'Banco', saldo });
                        }
                    });
                    // 3. Outras Caixinhas
                    metasFinanceiras.forEach(m => {
                        if ((m.tipo === 'poupanca' || m.tipo === 'poupanca_km') && m.id !== metaDividaId) {
                            const saldo = BusinessLogic.calcularSaldoConta(m.id);
                            fontes.push({ id: m.id, nome: m.descricao, tipo: 'Caixinha', saldo });
                        }
                    });
                    // 4. Carteira
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    fontes.push({ id: 'AUTO_ID_CARTEIRA', nome: 'Carteira (Dinheiro)', tipo: 'Caixa', saldo: saldoCarteira });

                    // Ordena√ß√£o
                    fontes.sort((a, b) => (a.destaque ? -1 : b.saldo - a.saldo));
                    
                    // HTML Lista Simples
                    let listaSimplesHTML = '<ul id="lista-fonte-simples" class="space-y-2 max-h-40 overflow-y-auto scrollable-content p-2 bg-slate-900 rounded-md">';
                    fontes.forEach((f, idx) => {
                        const corSaldo = f.saldo < pv ? 'text-red-400' : 'text-emerald-400';
                        const destaqueClass = f.destaque ? 'border-cyan-500/50 bg-cyan-900/20' : 'border-slate-600 bg-slate-700';
                        const checked = idx === 0 ? 'checked' : '';
                        listaSimplesHTML += `<li><label class="fonte-pagamento-item flex items-center justify-between p-3 rounded-md transition border cursor-pointer hover:bg-slate-600 ${destaqueClass}"><div><span class="font-bold text-white block text-sm">${f.nome}</span><span class="text-xs text-slate-400">${f.tipo} (Saldo: <span class="${corSaldo}">${Utils.formatarMoeda(f.saldo)}</span>)</span></div><input type="radio" name="fontePagamento" value="${f.id}" class="h-5 w-5 text-cyan-600 bg-slate-800 border-slate-500 focus:ring-cyan-500" ${checked}></label></li>`;
                    });
                    listaSimplesHTML += '</ul>';

                    // HTML Options Misto
                    const optionsSelect = fontes.map(f => `<option value="${f.id}">${f.nome} (${Utils.formatarMoeda(f.saldo)})</option>`).join('');

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4 flex flex-col">
                            <div class="text-center border-b border-slate-700 pb-3">
                                <h3 class="text-lg font-bold text-white">Confirmar Amortiza√ß√£o</h3>
                                <p class="text-slate-400 text-xs mt-1">Antecipando <b>${qtdParcelas}</b> parcela(s)</p>
                            </div>
                            
                            <div class="bg-slate-900 p-3 rounded text-center">
                                <span class="text-xs text-slate-500 uppercase tracking-wider">Valor Real a Pagar</span>
                                <div class="relative mt-1 max-w-[200px] mx-auto">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">R$</span>
                                    <input type="text" inputmode="decimal" id="amort-valor-real" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 pl-8 text-emerald-400 text-2xl font-bold text-center focus:border-emerald-500 focus:outline-none" value="${Utils.formatarMoedaParaInput(pv)}">
                                </div>
                            </div>

                            <div id="container-modo-simples" class="space-y-2">
                                <p class="text-xs font-bold text-slate-300 ml-1">Debitar de:</p>
                                ${listaSimplesHTML}
                            </div>

                            <div id="container-modo-misto" class="hidden space-y-3 bg-slate-900/50 p-3 rounded border border-slate-700">
                                <p class="text-xs font-bold text-cyan-400 uppercase">Pagamento Dividido</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="amort-conta-1" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsSelect}</select>
                                    <input type="text" id="amort-valor-1" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs text-right" placeholder="R$ 0,00">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="amort-conta-2" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsSelect}</select>
                                    <input type="text" id="amort-valor-2" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-slate-300 text-xs text-right cursor-not-allowed" readonly placeholder="Restante">
                                </div>
                            </div>

                            <div class="flex justify-between items-center pt-2">
                                <label class="flex items-center gap-2 cursor-pointer bg-slate-700/50 px-2 py-1 rounded hover:bg-slate-700">
                                    <input type="checkbox" id="chk-amort-misto" class="rounded bg-slate-800 border-slate-500 text-cyan-500">
                                    <span class="text-xs text-slate-300 font-bold">Dividir em 2 fontes</span>
                                </label>
                            </div>
                            
                            <div class="bg-slate-700/30 p-2 rounded border border-slate-600/50 mt-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chk-amort-retroativo" class="rounded bg-slate-700 border-slate-500 text-cyan-500">
                                    <span class="text-xs text-slate-300 font-bold">Pagamento Retroativo?</span>
                                </label>
                                <div id="container-amort-retro" class="hidden mt-2 animate-fade-in">
                                    <input type="date" id="amort-data-retro" value="${dataRef || Utils.getDataInputHoje()}" class="w-full bg-slate-800 border border-slate-500 rounded p-2 text-white text-sm">
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 pt-2">
                                <button id="btn-voltar-simulacao" class="bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-2 px-4 rounded-lg transition text-sm">Voltar</button>
                                
                                <button class="btn-confirmar-pagamento-amortizacao bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-lg text-sm" data-qtd="${qtdParcelas}" ${fontes.length === 0 ? 'disabled' : ''}>Confirmar Pagamento</button>
                            </div>
                        </div>`;
                        
                    setTimeout(() => {
                        const chkMisto = document.getElementById('chk-amort-misto');
                        const boxSimples = document.getElementById('container-modo-simples');
                        const boxMisto = document.getElementById('container-modo-misto');
                        const inputTotal = document.getElementById('amort-valor-real');
                        const inputVal1 = document.getElementById('amort-valor-1');
                        const inputVal2 = document.getElementById('amort-valor-2');

                        chkMisto.addEventListener('change', () => {
                            boxSimples.classList.toggle('hidden', chkMisto.checked);
                            boxMisto.classList.toggle('hidden', !chkMisto.checked);
                            if (chkMisto.checked) { inputVal1.value = inputTotal.value; inputVal2.value = '0,00'; }
                        });

                        const recalcularRestante = () => {
                            const total = Utils.parseMoeda(inputTotal.value);
                            const v1 = Utils.parseMoeda(inputVal1.value);
                            const resto = Math.max(0, total - v1);
                            inputVal2.value = Utils.formatarMoedaParaInput(resto);
                        };
                        inputVal1.addEventListener('input', recalcularRestante);
                        inputTotal.addEventListener('input', recalcularRestante);

                        const chkRetro = document.getElementById('chk-amort-retroativo');
                        const boxRetro = document.getElementById('container-amort-retro');
                        chkRetro.addEventListener('change', () => boxRetro.classList.toggle('hidden', !chkRetro.checked));
                        if (dataRef && dataRef !== Utils.getDataInputHoje()) chkRetro.click();
                        
                        document.querySelectorAll('input[name="fontePagamento"]').forEach(r => {
                            r.addEventListener('change', (e) => {
                                document.querySelectorAll('.fonte-pagamento-item').forEach(l => {
                                    l.classList.remove('border-cyan-500', 'bg-slate-600');
                                    const isDestaque = l.querySelector('span').textContent.includes('Saldo da Caixinha');
                                    l.classList.add('border-slate-600', isDestaque ? 'bg-cyan-900/20' : 'bg-slate-700');
                                    if(isDestaque) l.classList.add('border-cyan-500/50');
                                });
                                const label = e.target.closest('label');
                                if(label) {
                                    label.classList.remove('border-slate-600', 'bg-slate-700', 'bg-cyan-900/20', 'border-cyan-500/50');
                                    label.classList.add('border-cyan-500', 'bg-slate-600');
                                }
                            });
                        });
                        
                        // >>> CORRE√á√ÉO BLINDADA DO BOT√ÉO VOLTAR <<<
                        const btnVoltar = document.getElementById('btn-voltar-simulacao');
                        if (btnVoltar) {
                            btnVoltar.addEventListener('click', (e) => {
                                e.preventDefault(); // Impede o fechamento padr√£o
                                e.stopPropagation(); 

                                // Recupera a meta do contexto global
                                const metaId = AppState.itemParaEditarId;
                                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                                
                                if (meta) {
                                    // 1. Reabre o modal anterior (Simulador)
                                    UIRenderer.abrirModal('amortizacaoFinanciamento', { meta: meta });
                                    
                                    // 2. Aguarda a renderiza√ß√£o e clica em "Gerar" para repopular a tabela
                                    setTimeout(() => {
                                        const btnGerar = document.getElementById('btn-gerar-cronograma-modal');
                                        if(btnGerar) btnGerar.click();
                                    }, 300); // Tempo seguro para o DOM
                                } else {
                                    // Se por algum motivo bizarro perdeu a meta, fecha tudo
                                    UIRenderer.fecharModal();
                                }
                            });
                        }
                    }, 100);
                    break;
                }

        // 26. CONFIGURAR HIST√ìRICO RETROATIVO (IMPORTA√á√ÉO DE D√çVIDA)
                case 'configurarHistoricoRetroativo': {
                    const { meta } = options;
                    const fin = meta.financiamento;
                    
                    // Recalcula tabela te√≥rica desde o in√≠cio
                    const i_mensal = Math.pow(1 + (fin.taxaJurosAnual / 100), 1 / 12) - 1;
                    const dataInicio = new Date(fin.dataInicioFinanciamento + "T12:00:00");
                    const info = (fin.metodoAmortizacao === 'price') 
                        ? Utils.genPriceSchedule(fin.valorFinanciado, i_mensal*100, fin.totalParcelas, dataInicio, fin.valorParcela)
                        : Utils.genSAC(fin.valorFinanciado, i_mensal*100, fin.totalParcelas, dataInicio);

                    // Filtra apenas parcelas que J√Å VENCERAM at√© hoje
                    const hoje = new Date();
                    const passadas = info.schedule.filter(p => p.due < hoje);
                    
                    let listaHTML = '';
                    if (passadas.length === 0) {
                        listaHTML = '<p class="text-center text-slate-500 italic p-4">Nenhuma parcela vencida encontrada antes de hoje.</p>';
                    } else {
                        listaHTML = '<ul class="space-y-2 max-h-80 overflow-y-auto scrollable-content p-1">';
                        
                        passadas.forEach(p => {
                            // Verifica se j√° existe transa√ß√£o para esta data/valor aproximado
                            // (L√≥gica simples de verifica√ß√£o visual)
                            const jaRegistrado = fin.parcelasPagas >= p.num;
                            const statusClass = jaRegistrado ? 'opacity-50 pointer-events-none border-green-900/50' : 'border-slate-600';
                            const checkState = jaRegistrado ? 'checked disabled' : '';
                            const textoStatus = jaRegistrado ? '<span class="text-green-500 text-xs font-bold">J√° Registrado</span>' : '';

                            listaHTML += `
                                <li class="bg-slate-800 p-3 rounded border ${statusClass} flex flex-col gap-2">
                                    <div class="flex justify-between items-center">
                                        <label class="flex items-center gap-3 cursor-pointer">
                                            <input type="checkbox" class="chk-retro-parcela h-5 w-5 rounded bg-slate-700 text-cyan-600" 
                                                   data-num="${p.num}" data-valor="${p.pmt.toFixed(2)}" data-data="${Utils.formatarDataParaChave(p.due)}" ${checkState}>
                                            <div>
                                                <span class="font-bold text-white">Parcela ${p.num}</span>
                                                <span class="text-xs text-slate-400 block">Vencimento: ${Utils.formatarDataParaDisplay(p.due)}</span>
                                            </div>
                                        </label>
                                        <div class="text-right">
                                            <span class="block font-bold text-amber-400">${Utils.formatarMoeda(p.pmt)}</span>
                                            ${textoStatus}
                                        </div>
                                    </div>
                                    
                                    ${!jaRegistrado ? `
                                    <div class="grid grid-cols-2 gap-2 pl-8 text-xs">
                                        <div>
                                            <label class="text-slate-500 block">Pago em:</label>
                                            <input type="date" id="retro-data-${p.num}" value="${Utils.formatarDataParaChave(p.due)}" class="w-full bg-slate-900 border border-slate-700 rounded p-1 text-white">
                                        </div>
                                        <div>
                                            <label class="text-slate-500 block">Valor Real:</label>
                                            <input type="text" id="retro-valor-${p.num}" value="${Utils.formatarMoedaParaInput(p.pmt)}" class="w-full bg-slate-900 border border-slate-700 rounded p-1 text-white text-right">
                                        </div>
                                    </div>` : ''}
                                </li>`;
                        });
                        listaHTML += '</ul>';
                    }

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                                <h3 class="text-lg font-bold text-white">Registro Retroativo</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
                            </div>
                            <p class="text-xs text-slate-400 bg-amber-900/20 p-3 rounded border border-amber-700/30">
                                ‚ö†Ô∏è Use esta tela apenas para registrar pagamentos que voc√™ fez <b>antes de usar o App</b>. 
                                Esses valores ser√£o somados √† d√≠vida paga, mas <b>n√£o ser√£o descontados</b> do seu saldo atual.
                            </p>
                            
                            ${listaHTML}

                            <div class="flex justify-end gap-3 pt-2">
                                <button class="btn-cancelar bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded-lg text-sm">Cancelar</button>
                                <button id="btn-confirmar-retroativo-lote" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg">
                                    Registrar Selecionados
                                </button>
                            </div>
                        </div>`;
                    
                    setTimeout(() => {
                        document.getElementById('btn-confirmar-retroativo-lote').addEventListener('click', EventHandlers.handleSalvarRetroativoLote);
                    }, 100);
                    break;
                }
                
                // 25. MODAL DE CONTESTA√á√ÉO (SIMULA√á√ÉO BANC√ÅRIA)
                case 'analiseContestacao': {
                    const { transacao } = options;
                    
                    modalHTML = `
                        <div class="bg-slate-900 rounded-lg p-6 w-full max-w-sm shadow-2xl text-center border border-slate-700">
                            <div class="flex justify-center mb-4">
                                <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center border-2 border-slate-600">
                                    <span class="text-3xl">üõ°Ô∏è</span>
                                </div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-white mb-1">Contestar Transa√ß√£o</h3>
                            <p class="text-xs text-slate-400 mb-4">ID: ${transacao.id.slice(0,8)}...</p>
                            
                            <div class="bg-slate-800 p-3 rounded-lg text-left mb-4 border border-slate-700">
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-slate-400">Valor</span>
                                    <span class="text-sm font-bold text-white">${Utils.formatarMoeda(transacao.valor)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-xs text-slate-400">Data</span>
                                    <span class="text-sm text-white">${Utils.formatarDataParaDisplay(new Date(transacao.data))}</span>
                                </div>
                                <div class="mt-2 pt-2 border-t border-slate-600/50 text-xs text-slate-300 italic">
                                    "${transacao.descricao}"
                                </div>
                            </div>

                            <div id="contestacao-fase-1" class="space-y-3">
                                <label class="block text-left text-xs text-slate-300 mb-1">Qual o problema?</label>
                                <select id="motivo-contestacao" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-sm">
                                    <option value="erro">Pagamento Indevido / Errado</option>
                                    <option value="duplicidade">Cobran√ßa Duplicada</option>
                                    <option value="desacordo">Servi√ßo n√£o realizado</option>
                                    <option value="cancelamento">Cancelei a compra</option>
                                </select>
                                
                                <button id="btn-iniciar-analise" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition mt-2 shadow-lg">
                                    Solicitar Estorno
                                </button>
                                <button class="btn-cancelar w-full text-slate-500 text-xs mt-2 hover:text-slate-300">Cancelar</button>
                            </div>

                            <div id="contestacao-fase-2" class="hidden py-6">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-400 mx-auto mb-3"></div>
                                <p class="text-cyan-400 font-bold text-sm blink">Analisando solicita√ß√£o...</p>
                                <p class="text-xs text-slate-500 mt-1">Verificando saldo e contrato...</p>
                            </div>

                            <div id="contestacao-fase-3" class="hidden space-y-3">
                                <div class="text-green-400 text-5xl mb-2">‚úì</div>
                                <h4 class="text-lg font-bold text-white">Estorno Aprovado!</h4>
                                <p class="text-sm text-slate-300">
                                    O valor de <b class="text-green-400">${Utils.formatarMoeda(transacao.valor)}</b> ser√° devolvido para sua conta.
                                </p>
                                
                                ${transacao.descricao.includes('Amortiza√ß√£o') ? 
                                `<p class="text-xs text-amber-400 bg-amber-900/20 p-2 rounded border border-amber-900/50">
                                    Aten√ß√£o: A d√≠vida ser√° restaurada ao valor original.
                                 </p>` : ''}

                                <button id="btn-confirmar-estorno-final" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg" data-id="${transacao.id}">
                                    Confirmar Reembolso
                                </button>
                            </div>
                        </div>`;
                    
                    // L√≥gica da Anima√ß√£o
                    setTimeout(() => {
                        const btnIniciar = document.getElementById('btn-iniciar-analise');
                        const fase1 = document.getElementById('contestacao-fase-1');
                        const fase2 = document.getElementById('contestacao-fase-2');
                        const fase3 = document.getElementById('contestacao-fase-3');

                        btnIniciar.addEventListener('click', () => {
                            fase1.classList.add('hidden');
                            fase2.classList.remove('hidden');
                            
                            // Simula tempo de an√°lise do banco (1.5 segundos)
                            setTimeout(() => {
                                fase2.classList.add('hidden');
                                fase3.classList.remove('hidden');
                            }, 1500);
                        });
                        
                        document.getElementById('btn-confirmar-estorno-final').addEventListener('click', (e) => {
                            const id = e.target.dataset.id;
                            // Chama a fun√ß√£o real de exclus√£o/estorno
                            EventHandlers.executarEstornoReal(id);
                        });
                    }, 100);
                    break;
                }
                
                
/*                 
                
// NOVO MODAL: PAGAMENTO DE FATURA (COM OP√á√ÉO RETROATIVA)
                case 'pagarFaturaDetalhado': {
                    const { meta, saldoDevedor } = options;
                    
                    // Fontes de Pagamento
                    const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                    let optionsFontes = '<option value="">Selecione a origem...</option>';
                    optionsFontes += `<option value="AUTO_ID_CARTEIRA">üíµ Carteira (Dinheiro)</option>`;

                    contasBancarias.forEach(c => {
                        if (c.tipo !== 'credito') {
                             optionsFontes += `<option value="${c.id}">Banco: ${c.nome} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(c.id))})</option>`;
                        }
                    });
                    
                    metasFinanceiras.forEach(m => {
                        if ((m.tipo === 'poupanca' || m.tipo === 'poupanca_km') && m.id !== meta.id) {
                             optionsFontes += `<option value="${m.id}">Caixinha: ${m.descricao} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(m.id))})</option>`;
                        }
                    });

                    modalHTML = `
                        <div class="bg-slate-900 rounded-lg w-full max-w-md shadow-xl flex flex-col max-h-[90vh]">
                            
                            <div class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700 flex-shrink-0">
                                <div>
                                    <h3 class="text-xl font-bold text-white">Pagar Fatura</h3>
                                    <span class="text-xs text-slate-400">${meta.descricao}</span>
                                </div>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
                            </div>

                            <div class="p-6 overflow-y-auto scrollable-content">
                                
                                <div class="bg-slate-800 p-4 rounded-lg text-center border border-slate-700 mb-4">
                                    <span class="text-xs text-slate-400 uppercase tracking-wide">Saldo da Fatura</span>
                                    <div class="text-3xl font-bold text-white mt-1">${Utils.formatarMoeda(saldoDevedor)}</div>
                                    <input type="hidden" id="pgto-fatura-id" value="${meta.id}">
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-300 mb-1">Valor a Pagar (Principal)</label>
                                        <input type="text" inputmode="decimal" id="pgto-fatura-principal" 
                                               class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white text-lg font-bold focus:border-green-500 focus:ring-1 focus:ring-green-500" 
                                               value="${Utils.formatarMoedaParaInput(saldoDevedor)}">
                                    </div>

                                    <div class="bg-red-900/20 border border-red-900/50 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" id="chk-add-juros" class="rounded bg-slate-800 border-slate-600 text-red-500">
                                                <span class="text-xs font-bold text-red-300">Adicionar Juros/Multa?</span>
                                            </label>
                                        </div>
                                        
                                        <div id="container-juros-fatura" class="grid grid-cols-2 gap-3 hidden">
                                            <div>
                                                <label class="block text-[10px] text-slate-400 mb-1">Multa (%)</label>
                                                <div class="relative">
                                                    <input type="number" id="pgto-multa-percent" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-right pr-6" placeholder="2">
                                                    <span class="absolute right-2 top-2 text-slate-500">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-400 mb-1">Juros Mora (R$)</label>
                                                <input type="text" inputmode="decimal" id="pgto-juros-valor" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-right" placeholder="0,00">
                                            </div>
                                            <div class="col-span-2 text-right border-t border-red-900/30 pt-2">
                                                <span class="text-xs text-slate-400">Total Encargos: </span>
                                                <span id="pgto-total-encargos" class="text-red-400 font-bold">R$ 0,00</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex flex-col gap-2 bg-slate-800/50 p-2 rounded border border-slate-700/50">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="chk-pgto-retroativo" class="rounded bg-slate-700 border-slate-500 text-cyan-500">
                                            <span class="text-xs text-slate-300">Pagamento Retroativo?</span>
                                        </label>
                                        
                                        <div id="container-data-retroativa" class="hidden mt-1">
                                            <label class="block text-[10px] text-slate-400 mb-1">Data do Pagamento</label>
                                            <input type="date" id="pgto-data-retro" value="${Utils.getDataInputHoje()}" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white text-sm">
                                        </div>
                                    </div>
                                    <div class="p-3 bg-slate-800 rounded border border-slate-700 flex justify-between items-center">
                                        <span class="text-sm text-slate-300">Sai da Conta:</span>
                                        <span id="pgto-total-final" class="text-xl font-bold text-amber-400">${Utils.formatarMoeda(saldoDevedor)}</span>
                                    </div>

                                    <div id="info-restante-fatura" class="text-center text-xs text-slate-500 hidden">
                                        Restar√° na fatura: <b class="text-white" id="val-restante-fatura">R$ 0,00</b>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-slate-300 mb-1">Origem do Pagamento</label>
                                        <select id="pgto-fatura-origem" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white">
                                            ${optionsFontes}
                                        </select>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-xs font-medium text-slate-300">Descri√ß√£o (Opcional)</label>
                                        <input type="text" id="pgto-fatura-desc" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white" 
                                               value="Pagamento Fatura">
                                    </div>

                                    <button id="btn-confirmar-pgto-fatura" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg mt-2">
                                        Confirmar Pagamento
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    
                    // L√≥gica Visual
                    setTimeout(() => {
                        const inputPrincipal = document.getElementById('pgto-fatura-principal');
                        const chkJuros = document.getElementById('chk-add-juros');
                        const boxJuros = document.getElementById('container-juros-fatura');
                        const inputMulta = document.getElementById('pgto-multa-percent');
                        const inputJurosVal = document.getElementById('pgto-juros-valor');
                        const spanEncargos = document.getElementById('pgto-total-encargos');
                        const spanTotalFinal = document.getElementById('pgto-total-final');
                        const infoRestante = document.getElementById('info-restante-fatura');
                        const spanRestante = document.getElementById('val-restante-fatura');
                        
                        // Toggle Retroativo
                        const chkRetro = document.getElementById('chk-pgto-retroativo');
                        const boxRetro = document.getElementById('container-data-retroativa');
                        
                        chkRetro.addEventListener('change', () => {
                            boxRetro.classList.toggle('hidden', !chkRetro.checked);
                        });

                        const recalcular = () => {
                            const principal = Utils.parseMoeda(inputPrincipal.value);
                            let encargos = 0;

                            if (chkJuros.checked) {
                                const multaPercent = parseFloat(inputMulta.value) || 0;
                                const jurosValor = Utils.parseMoeda(inputJurosVal.value);
                                
                                const valorMulta = principal * (multaPercent / 100);
                                encargos = valorMulta + jurosValor;
                            }

                            const totalPagar = principal + encargos;
                            const restante = saldoDevedor - principal;

                            spanEncargos.textContent = Utils.formatarMoeda(encargos);
                            spanTotalFinal.textContent = Utils.formatarMoeda(totalPagar);
                            
                            if (restante > 0.01) {
                                infoRestante.classList.remove('hidden');
                                spanRestante.textContent = Utils.formatarMoeda(restante);
                                spanRestante.className = 'text-white';
                            } else if (restante < -0.01) {
                                infoRestante.classList.remove('hidden');
                                spanRestante.innerHTML = `Cr√©dito: ${Utils.formatarMoeda(Math.abs(restante))}`;
                                spanRestante.className = 'text-green-400';
                            } else {
                                infoRestante.classList.add('hidden');
                            }
                        };

                        inputPrincipal.addEventListener('input', recalcular);
                        inputMulta.addEventListener('input', recalcular);
                        inputJurosVal.addEventListener('input', recalcular);
                        
                        chkJuros.addEventListener('change', () => {
                            boxJuros.classList.toggle('hidden', !chkJuros.checked);
                            recalcular();
                        });
                        
                        document.getElementById('btn-confirmar-pgto-fatura').addEventListener('click', EventHandlers.handleSalvarPagamentoFatura);
                        
                    }, 100);
                    break;
                }
                
            
 */

// NOVO MODAL: PAGAMENTO DE FATURA (COM OP√á√ÉO DE USAR PROVIS√ÉO)
                case 'pagarFaturaDetalhado': {
                    const { meta, saldoDevedor } = options;
                    
                    // 1. Verifica se tem dinheiro guardado especificamente para este cart√£o
                    const valorGuardado = meta.valorProvisionado || 0;
                    const temGuardado = valorGuardado > 0;

                    // Fontes de Pagamento
                    const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                    let optionsFontes = '<option value="">Selecione a origem...</option>';

                    // --- NOVA OP√á√ÉO: USAR SALDO GUARDADO (PRIORIDADE) ---
                    if (temGuardado) {
                        optionsFontes += `<option value="USE_PROVISIONADO" selected>üê∑ Usar Saldo Guardado (${Utils.formatarMoeda(valorGuardado)})</option>`;
                    }

                    // Op√ß√µes Padr√£o
                    optionsFontes += `<option value="AUTO_ID_CARTEIRA" ${!temGuardado ? 'selected' : ''}>üíµ Carteira (Dinheiro)</option>`;

                    contasBancarias.forEach(c => {
                        if (c.tipo !== 'credito') {
                             optionsFontes += `<option value="${c.id}">Banco: ${c.nome} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(c.id))})</option>`;
                        }
                    });
                    
                    metasFinanceiras.forEach(m => {
                        if ((m.tipo === 'poupanca' || m.tipo === 'poupanca_km') && m.id !== meta.id) {
                             optionsFontes += `<option value="${m.id}">Caixinha: ${m.descricao} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(m.id))})</option>`;
                        }
                    });

                    modalHTML = `
                        <div class="bg-slate-900 rounded-lg w-full max-w-md shadow-xl flex flex-col max-h-[90vh]">
                            
                            <div class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700 flex-shrink-0">
                                <div>
                                    <h3 class="text-xl font-bold text-white">Pagar Fatura</h3>
                                    <span class="text-xs text-slate-400">${meta.descricao}</span>
                                </div>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
                            </div>

                            <div class="p-6 overflow-y-auto scrollable-content">
                                
                                <div class="bg-slate-800 p-4 rounded-lg text-center border border-slate-700 mb-4">
                                    <span class="text-xs text-slate-400 uppercase tracking-wide">Saldo da Fatura</span>
                                    <div class="text-3xl font-bold text-white mt-1 mb-2">${Utils.formatarMoeda(saldoDevedor)}</div>
                                    
                                    ${temGuardado ? `
                                        <div class="bg-emerald-900/30 border border-emerald-500/30 p-2 rounded text-xs text-emerald-300 flex justify-between items-center px-4">
                                            <span>üê∑ Guardado:</span>
                                            <span class="font-bold text-emerald-400">${Utils.formatarMoeda(valorGuardado)}</span>
                                        </div>
                                    ` : ''}

                                    <input type="hidden" id="pgto-fatura-id" value="${meta.id}">
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-300 mb-1">Valor a Pagar (Principal)</label>
                                        <input type="text" inputmode="decimal" id="pgto-fatura-principal" 
                                               class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white text-lg font-bold focus:border-green-500 focus:ring-1 focus:ring-green-500" 
                                               value="${Utils.formatarMoedaParaInput(temGuardado ? Math.min(saldoDevedor, valorGuardado) : saldoDevedor)}">
                                    </div>

                                    <div class="bg-red-900/20 border border-red-900/50 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" id="chk-add-juros" class="rounded bg-slate-800 border-slate-600 text-red-500">
                                                <span class="text-xs font-bold text-red-300">Adicionar Juros/Multa?</span>
                                            </label>
                                        </div>
                                        
                                        <div id="container-juros-fatura" class="grid grid-cols-2 gap-3 hidden">
                                            <div>
                                                <label class="block text-[10px] text-slate-400 mb-1">Multa (%)</label>
                                                <div class="relative">
                                                    <input type="number" id="pgto-multa-percent" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-right pr-6" placeholder="2">
                                                    <span class="absolute right-2 top-2 text-slate-500">%</span>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-[10px] text-slate-400 mb-1">Juros Mora (R$)</label>
                                                <input type="text" inputmode="decimal" id="pgto-juros-valor" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-right" placeholder="0,00">
                                            </div>
                                            <div class="col-span-2 text-right border-t border-red-900/30 pt-2">
                                                <span class="text-xs text-slate-400">Total Encargos: </span>
                                                <span id="pgto-total-encargos" class="text-red-400 font-bold">R$ 0,00</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex flex-col gap-2 bg-slate-800/50 p-2 rounded border border-slate-700/50">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="chk-pgto-retroativo" class="rounded bg-slate-700 border-slate-500 text-cyan-500">
                                            <span class="text-xs text-slate-300">Pagamento Retroativo?</span>
                                        </label>
                                        
                                        <div id="container-data-retroativa" class="hidden mt-1">
                                            <label class="block text-[10px] text-slate-400 mb-1">Data do Pagamento</label>
                                            <input type="date" id="pgto-data-retro" value="${Utils.getDataInputHoje()}" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white text-sm">
                                        </div>
                                    </div>
                                    <div class="p-3 bg-slate-800 rounded border border-slate-700 flex justify-between items-center">
                                        <span class="text-sm text-slate-300">Sai da Conta:</span>
                                        <span id="pgto-total-final" class="text-xl font-bold text-amber-400">${Utils.formatarMoeda(saldoDevedor)}</span>
                                    </div>

                                    <div id="info-restante-fatura" class="text-center text-xs text-slate-500 hidden">
                                        Restar√° na fatura: <b class="text-white" id="val-restante-fatura">R$ 0,00</b>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-slate-300 mb-1">Origem do Pagamento</label>
                                        <select id="pgto-fatura-origem" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-green-500">
                                            ${optionsFontes}
                                        </select>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <label class="block text-xs font-medium text-slate-300">Descri√ß√£o (Opcional)</label>
                                        <input type="text" id="pgto-fatura-desc" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white" 
                                               value="Pagamento Fatura">
                                    </div>

                                    <button id="btn-confirmar-pgto-fatura" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg mt-2">
                                        Confirmar Pagamento
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    
                    // L√≥gica Visual
                    setTimeout(() => {
                        const inputPrincipal = document.getElementById('pgto-fatura-principal');
                        const chkJuros = document.getElementById('chk-add-juros');
                        const boxJuros = document.getElementById('container-juros-fatura');
                        const inputMulta = document.getElementById('pgto-multa-percent');
                        const inputJurosVal = document.getElementById('pgto-juros-valor');
                        const spanEncargos = document.getElementById('pgto-total-encargos');
                        const spanTotalFinal = document.getElementById('pgto-total-final');
                        const infoRestante = document.getElementById('info-restante-fatura');
                        const spanRestante = document.getElementById('val-restante-fatura');
                        
                        // Toggle Retroativo
                        const chkRetro = document.getElementById('chk-pgto-retroativo');
                        const boxRetro = document.getElementById('container-data-retroativa');
                        
                        chkRetro.addEventListener('change', () => {
                            boxRetro.classList.toggle('hidden', !chkRetro.checked);
                        });

                        const recalcular = () => {
                            const principal = Utils.parseMoeda(inputPrincipal.value);
                            let encargos = 0;

                            if (chkJuros.checked) {
                                const multaPercent = parseFloat(inputMulta.value) || 0;
                                const jurosValor = Utils.parseMoeda(inputJurosVal.value);
                                
                                const valorMulta = principal * (multaPercent / 100);
                                encargos = valorMulta + jurosValor;
                            }

                            const totalPagar = principal + encargos;
                            const restante = saldoDevedor - principal;

                            spanEncargos.textContent = Utils.formatarMoeda(encargos);
                            spanTotalFinal.textContent = Utils.formatarMoeda(totalPagar);
                            
                            if (restante > 0.01) {
                                infoRestante.classList.remove('hidden');
                                spanRestante.textContent = Utils.formatarMoeda(restante);
                                spanRestante.className = 'text-white';
                            } else if (restante < -0.01) {
                                infoRestante.classList.remove('hidden');
                                spanRestante.innerHTML = `Cr√©dito: ${Utils.formatarMoeda(Math.abs(restante))}`;
                                spanRestante.className = 'text-green-400';
                            } else {
                                infoRestante.classList.add('hidden');
                            }
                        };

                        inputPrincipal.addEventListener('input', recalcular);
                        inputMulta.addEventListener('input', recalcular);
                        inputJurosVal.addEventListener('input', recalcular);
                        
                        chkJuros.addEventListener('change', () => {
                            boxJuros.classList.toggle('hidden', !chkJuros.checked);
                            recalcular();
                        });
                        
                        // Executa c√°lculo inicial
                        recalcular();

                        document.getElementById('btn-confirmar-pgto-fatura').addEventListener('click', EventHandlers.handleSalvarPagamentoFatura);
                        
                    }, 100);
                    break;
                }

            case 'gestaoCombustivel': {
                const opts = options || {}; 
                
                // --- CONFIGURA√á√ÉO INICIAL E ESTADO ---
                const { metodoLeituraCombustivel, veiculo } = AppState.configuracoes;
                const isConsumo = metodoLeituraCombustivel === 'consumo';
                const tipoPadrao = veiculo.combustivel || 'Gasolina Comum';
                
                // Textos de apoio din√¢micos
                const labelLeitura = isConsumo ? 'Consumido (Painel)' : 'Restante (Tanque)';
                const placeholderLeitura = isConsumo ? 'Ex: 8,5' : 'Ex: 5,0';
                const infoMetodo = {
                    'nivel': 'Modo N√≠vel: Digite o que sobrou no tanque (visual).',
                    'consumo': 'Modo Painel: Digite o consumo m√©dio do computador de bordo.'
                };

                // Estiliza√ß√£o condicional
                const styleAtivo = 'border-cyan-500 bg-cyan-900/20 ring-1 ring-cyan-500 text-white';
                const styleInativo = 'border-slate-600 text-slate-400 hover:bg-slate-800 hover:border-slate-500';

                // Prepara√ß√£o de Dados para UI
                const postosSalvos = AppState.postosCombustivel || [];
                // Gera options limpos para o datalist
                const optionsPostos = postosSalvos.map(p => `<option value="${p.nome}">${p.bandeira || 'Outros'}</option>`).join('');

                // L√≥gica de KM Inicial (Fallback Inteligente)
                let kmParaModal = opts.km; 
                if (!kmParaModal || kmParaModal == 0 || kmParaModal === '') {
                    kmParaModal = BusinessLogic.getUltimoKmRegistrado() || 
                                  BusinessLogic.getKmFinalDiaAnterior() || 
                                  Math.round(AppState.gpsCurrentOdometer) || '';
                }

                // --- RENDERIZA√á√ÉO DO MODAL ---
                modalHTML = `
                    <div class="bg-slate-900 rounded-lg w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        
                        <div class="bg-slate-800 p-4 flex justify-between items-center border-b border-slate-700 flex-shrink-0">
                            <div><h3 class="text-xl font-bold text-amber-400 flex items-center gap-2"><span>‚õΩ</span> Gest√£o de Combust√≠vel</h3></div>
                            <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
                        </div>

                        <div class="flex bg-slate-800 border-b border-slate-700 flex-shrink-0">
                            <button class="fuel-tab-button flex-1 py-3 text-sm font-bold text-amber-400 border-b-2 border-amber-400 bg-slate-700/50" data-tab="registrar">Registrar</button>
                            <button class="fuel-tab-button flex-1 py-3 text-sm font-bold text-slate-400 hover:text-slate-200" data-tab="historico">An√°lise</button>
                            <button class="fuel-tab-button flex-1 py-3 text-sm font-bold text-slate-400 hover:text-slate-200" data-tab="postos">Postos & Config</button>
                        </div>

                        <div class="p-6 overflow-y-auto scrollable-content flex-1 min-h-0">
                            
                            <div id="fuel-content-registrar" class="fuel-tab-pane space-y-5">
                                
                                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                                    <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="document.getElementById('calc-flex-body').classList.toggle('hidden')">
                                        <h4 class="text-sm font-bold text-cyan-300">‚öñÔ∏è Calculadora Flex</h4><span class="text-xs text-slate-500">‚ñº</span>
                                    </div>
                                    <div id="calc-flex-body" class="grid grid-cols-2 gap-3 hidden">
                                        <div><label class="text-[10px] text-slate-400">Gasolina</label><input type="text" inputmode="decimal" id="calc-flex-gas" class="w-full bg-slate-900 border-slate-600 rounded p-1 text-white text-sm" placeholder="Ex: 5,59"></div>
                                        <div><label class="text-[10px] text-slate-400">Etanol</label><input type="text" inputmode="decimal" id="calc-flex-eta" class="w-full bg-slate-900 border-slate-600 rounded p-1 text-white text-sm" placeholder="Ex: 3,49"></div>
                                        <div class="col-span-2 text-center bg-slate-900 rounded p-2 mt-1"><span id="calc-flex-result" class="text-xs font-bold text-white">Preencha para comparar...</span></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-medium text-slate-400 mb-1">Data</label><input type="date" id="fuel-data" value="${Utils.getDataInputHoje()}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"></div>
                                    <div><label class="block text-xs font-medium text-slate-400 mb-1">Hora</label><input type="time" id="fuel-hora" value="${new Date().toTimeString().slice(0,5)}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white"></div>
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">Posto</label>
                                    <div class="relative">
                                        <input type="text" list="postos-list-id" id="fuel-posto" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Selecione..." autocomplete="off">
                                        <datalist id="postos-list-id">${optionsPostos}</datalist>
                                        <span class="absolute right-2 top-2 text-xl cursor-pointer" onclick="EventHandlers.handleBuscarPostoGPS()">üìç</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-medium text-slate-400 mb-1">Combust√≠vel</label>
                                    <select id="fuel-tipo" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                    ${['Gasolina Comum', 'Gasolina Aditivada', 'Etanol', 'Diesel', 'GNV', 'El√©trico'].map(tipo => 
                                        `<option value="${tipo}" ${tipo === tipoPadrao ? 'selected' : ''}>${tipo}</option>`
                                    ).join('')}
                                    </select></div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-400 mb-1">KM Painel</label>
                                        <input type="number" id="fuel-km" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" value="${kmParaModal}">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-amber-300 mb-1" id="label-fuel-leitura">${labelLeitura} <span class="text-slate-500">(Opcional)</span></label>
                                    <input type="text" inputmode="decimal" id="fuel-leitura" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="${placeholderLeitura}" value="${opts.leitura || ''}">
                                </div>

                                <div class="p-3 bg-slate-800 border border-slate-600 rounded-lg">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="block text-xs font-bold text-amber-400 mb-1">Total (R$)</label><input type="text" inputmode="decimal" id="fuel-valor" class="w-full bg-slate-900 border border-amber-500/50 rounded-lg p-3 text-white text-lg font-bold" value="${opts.valor || ''}"></div>
                                        <div><label class="block text-xs font-bold text-slate-300 mb-1">Litros</label><input type="text" inputmode="decimal" id="fuel-litros" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white text-lg" value="${opts.litros || ''}"></div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700">
                                    <span class="text-xs text-slate-400">Avalia√ß√£o:</span>
                                    <div id="fuel-rating-stars" class="flex gap-1 cursor-pointer">
                                        <span class="star text-xl text-slate-600 hover:text-yellow-400 transition" data-val="1">‚òÖ</span>
                                        <span class="star text-xl text-slate-600 hover:text-yellow-400 transition" data-val="2">‚òÖ</span>
                                        <span class="star text-xl text-slate-600 hover:text-yellow-400 transition" data-val="3">‚òÖ</span>
                                        <span class="star text-xl text-slate-600 hover:text-yellow-400 transition" data-val="4">‚òÖ</span>
                                        <span class="star text-xl text-slate-600 hover:text-yellow-400 transition" data-val="5">‚òÖ</span>
                                    </div>
                                    <input type="hidden" id="fuel-rating-value" value="0">
                                </div>

                                <div class="flex items-center justify-between text-xs text-slate-400">
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fuel-tanque-cheio" class="rounded bg-slate-700 border-slate-600 text-amber-500">Completei o tanque</label>
                                </div>
                                
                                <button id="btn-salvar-abastecimento-pro" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-3 rounded-lg shadow-lg transition">Registrar Abastecimento</button>
                            </div>

                            <div id="fuel-content-historico" class="fuel-tab-pane space-y-6 hidden">
                                <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                                    <div class="p-3 bg-slate-700/50 flex justify-between items-center cursor-pointer" onclick="document.getElementById('fuel-analytics-body').classList.toggle('hidden')">
                                        <h4 class="font-bold text-cyan-300">üìä An√°lise de Consumo</h4><span class="text-xs text-slate-400">‚ñº</span>
                                    </div>
                                    <div id="fuel-analytics-body" class="p-4 space-y-6 hidden">
                                        <div class="h-40"><canvas id="chart-fuel-mix"></canvas></div>
                                        <div class="border-t border-slate-700 pt-4 h-48"><canvas id="chart-fuel-trend"></canvas></div>
                                    </div>
                                </div>
                                <ul id="lista-historico-combustivel" class="space-y-3"></ul>
                            </div>

                            <div id="fuel-content-postos" class="fuel-tab-pane hidden space-y-6">
                                
                                <div class="p-3 bg-slate-800 rounded border border-slate-700">
                                    <h4 class="text-sm font-bold text-white mb-2">M√©todo de Leitura</h4>
                                    <div class="grid grid-cols-2 gap-3" id="container-metodo-leitura">
                                        <label id="lbl-metodo-nivel" class="flex flex-col items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${!isConsumo ? styleAtivo : styleInativo}">
                                            <input type="radio" name="metodoLeituraConfig" value="nivel" class="hidden" ${!isConsumo ? 'checked' : ''}>
                                            <span class="text-2xl mb-1">üéöÔ∏è</span>
                                            <span class="font-bold text-xs">N√≠vel (Tanque)</span>
                                        </label>
                                        <label id="lbl-metodo-consumo" class="flex flex-col items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${isConsumo ? styleAtivo : styleInativo}">
                                            <input type="radio" name="metodoLeituraConfig" value="consumo" class="hidden" ${isConsumo ? 'checked' : ''}>
                                            <span class="text-2xl mb-1">üìü</span>
                                            <span class="font-bold text-xs">Painel (Pro)</span>
                                        </label>
                                    </div>
                                    <p id="fuel-config-help" class="text-[10px] text-slate-400 mt-2 italic text-center transition-all duration-500">${infoMetodo[metodoLeituraCombustivel]}</p>
                                </div>

                                <div id="view-lista-postos">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-sm font-bold text-slate-300">Meus Postos Favoritos</h4>
                                        <button id="btn-novo-posto" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded transition">+ Novo</button>
                                    </div>
                                    <ul id="lista-meus-postos" class="space-y-2"></ul>
                                    
                                    <div id="form-novo-posto" class="hidden p-4 bg-slate-800 rounded border border-slate-700 space-y-3 mt-4 fade-in">
                                        <h5 class="font-bold text-white text-sm">Cadastrar Novo Posto</h5>
                                        <input type="text" id="posto-nome" class="w-full bg-slate-900 border-slate-600 rounded p-2 text-white text-sm" placeholder="Nome (Ex: Shell Centro)">
                                        <input type="text" id="posto-bandeira" class="w-full bg-slate-900 border-slate-600 rounded p-2 text-white text-sm" placeholder="Bandeira">
                                        <input type="text" id="posto-endereco" class="w-full bg-slate-900 border-slate-600 rounded p-2 text-white text-sm" placeholder="Endere√ßo (Google Maps)">
                                        
                                        <div class="space-y-2">
                                            <label class="block text-xs text-slate-400">Imagem do Posto</label>
                                            
                                            <div class="flex items-center gap-2">
                                                <input type="file" id="posto-img-upload" accept="image/*" class="flex-1 w-full bg-slate-900 border-slate-600 rounded p-2 text-white text-sm file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                                            </div>

                                            <div class="mt-1">
                                                <input type="text" id="posto-img-url" class="w-full bg-slate-900/50 border-slate-700 rounded p-2 text-slate-400 text-xs focus:text-white focus:border-slate-500 transition" placeholder="Ou cole URL (https://...)">
                                            </div>

                                            <img id="preview-novo-posto" class="w-full h-32 object-cover rounded hidden mt-2 border border-slate-600 bg-slate-800">
                                            <p id="status-img-processing" class="text-[10px] text-amber-400 hidden animate-pulse">Otimizando imagem...</p>
                                        </div>
                                        
                                        <div class="flex justify-end gap-2 pt-2">
                                            <button class="btn-cancelar-posto text-xs text-slate-400 hover:text-white px-3 py-2">Cancelar</button>
                                            <button id="btn-salvar-posto" class="text-xs bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold transition disabled:opacity-50 disabled:cursor-not-allowed">Salvar</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="view-detalhes-posto" class="hidden space-y-4 fade-in">
                                    <button id="btn-voltar-lista-postos" class="text-xs text-slate-400 hover:text-white mb-2">‚Üê Voltar para lista</button>
                                    <div class="bg-slate-800 p-0 rounded-lg border border-slate-700 text-center overflow-hidden">
                                        <div id="detalhe-posto-img-container" class="h-32 w-full bg-slate-700 hidden relative">
                                            <img id="detalhe-posto-img" src="" class="w-full h-full object-cover opacity-60">
                                        </div>
                                        <div class="p-4">
                                            <h3 id="detalhe-posto-nome" class="text-xl font-bold text-white"></h3>
                                            <p id="detalhe-posto-end" class="text-xs text-slate-400 mb-3"></p>
                                            <div class="flex justify-center gap-4 text-sm">
                                                <div><span class="block text-slate-500 text-[10px]">Total Gasto</span><b id="detalhe-total-gasto" class="text-amber-400"></b></div>
                                                <div><span class="block text-slate-500 text-[10px]">Visitas</span><b id="detalhe-visitas" class="text-white"></b></div>
                                            </div>
                                        </div>
                                    </div>
                                    <h5 class="text-xs font-bold text-slate-500 uppercase">Hist√≥rico neste local</h5>
                                    <ul id="lista-historico-posto-especifico" class="space-y-2 max-h-60 overflow-y-auto"></ul>
                                </div>
                            </div>

                        </div>
                    </div>`;
                
                setTimeout(() => {
                    // --- 1. CONFIGURA√á√ÉO DE ABAS E NAVEGA√á√ÉO ---
                    const tabs = document.querySelectorAll('.fuel-tab-button');
                    tabs.forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            tabs.forEach(t => { t.classList.remove('text-amber-400', 'border-amber-400', 'bg-slate-700/50'); t.classList.add('text-slate-400'); });
                            e.target.classList.add('text-amber-400', 'border-b-2', 'border-amber-400', 'bg-slate-700/50');
                            e.target.classList.remove('text-slate-400');
                            document.querySelectorAll('.fuel-tab-pane').forEach(p => p.classList.add('hidden'));
                            document.getElementById(`fuel-content-${e.target.dataset.tab}`).classList.remove('hidden');
                            if(e.target.dataset.tab === 'historico') { EventHandlers.renderFuelCharts(); EventHandlers.renderFuelHistoryList(); }
                            if(e.target.dataset.tab === 'postos') { document.getElementById('view-lista-postos').classList.remove('hidden'); document.getElementById('view-detalhes-posto').classList.add('hidden'); EventHandlers.renderPostosList(); }
                        });
                    });
                    
                    const listaHist = document.getElementById('lista-historico-combustivel');
                    if (listaHist) {
                        listaHist.addEventListener('click', (e) => {
                            const btnExcluir = e.target.closest('.btn-excluir-transacao');
                            const btnEditar = e.target.closest('.btn-editar-transacao');
                            if (btnExcluir) { EventHandlers.handleExcluirTransacao(btnExcluir.dataset.id); setTimeout(() => EventHandlers.renderFuelHistoryList(), 500); }
                            if (btnEditar) { EventHandlers.handleCarregarEdicaoCombustivel(btnEditar.dataset.id); }
                        });
                    }

                    // --- 2. CALCULADORA FLEX E AVALIA√á√ÉO ---
                    const calcGas = document.getElementById('calc-flex-gas');
                    const calcEta = document.getElementById('calc-flex-eta');
                    const calcRes = document.getElementById('calc-flex-result');
                    const calcFlex = () => { const g = Utils.parseMoeda(calcGas.value); const e = Utils.parseMoeda(calcEta.value); if(g > 0 && e > 0) { const res = FuelManager.calcularVantagem(g, e); const cor = res.melhor === 'Etanol' ? 'text-green-400' : 'text-orange-400'; calcRes.innerHTML = `<span class="${cor}">Melhor: ${res.melhor}</span> (${Math.abs(res.economia).toFixed(1)}%)`; } };
                    calcGas.addEventListener('input', calcFlex); calcEta.addEventListener('input', calcFlex);

                    const stars = document.querySelectorAll('.star');
                    const ratingInput = document.getElementById('fuel-rating-value');
                    stars.forEach(s => {
                        s.addEventListener('click', (e) => {
                            const val = parseInt(e.target.dataset.val) || 0; // Sanitiza√ß√£o V9
                            ratingInput.value = val;
                            stars.forEach(st => { st.classList.remove('text-yellow-400'); st.classList.add('text-slate-600'); if (st.dataset.val <= val) { st.classList.remove('text-slate-600'); st.classList.add('text-yellow-400'); } });
                        });
                    });
                    
                    // --- 3. L√ìGICA DE POSTOS H√çBRIDA (AUDITADA V9) ---
                    let imagemFinal = null; 
                    let isProcessing = false;

                    const inputUpload = document.getElementById('posto-img-upload');
                    const inputURL = document.getElementById('posto-img-url');
                    const preview = document.getElementById('preview-novo-posto');
                    const statusProc = document.getElementById('status-img-processing');
                    const btnSalvar = document.getElementById('btn-salvar-posto');

                    const updatePreview = (src) => {
                        if (src) { preview.src = src; preview.classList.remove('hidden'); } else { preview.classList.add('hidden'); }
                    };

                    if (inputUpload) {
                        inputUpload.addEventListener('change', function(e) {
                            const file = e.target.files[0];
                            if (file) {
                                isProcessing = true;
                                btnSalvar.disabled = true;
                                statusProc.classList.remove('hidden');
                                inputURL.value = ''; 
                                updatePreview(URL.createObjectURL(file));

                                Utils.otimizarImagem(file, (base64) => {
                                    imagemFinal = base64; 
                                    isProcessing = false;
                                    btnSalvar.disabled = false;
                                    statusProc.classList.add('hidden');
                                    updatePreview(base64);
                                });
                            }
                        });
                    }

                    if (inputURL) {
                        inputURL.addEventListener('input', (e) => {
                            const url = e.target.value;
                            if (url && url.length > 8) {
                                inputUpload.value = '';
                                imagemFinal = url; 
                                updatePreview(url);
                            } else if (!inputUpload.files[0]) {
                                imagemFinal = null;
                                updatePreview(null);
                            }
                        });
                    }

                    document.getElementById('btn-novo-posto').addEventListener('click', () => {
                        document.getElementById('form-novo-posto').classList.remove('hidden');
                        imagemFinal = null;
                        isProcessing = false;
                        btnSalvar.disabled = false;
                        if(preview) preview.classList.add('hidden');
                        if(inputUpload) inputUpload.value = '';
                        if(inputURL) inputURL.value = '';
                    });

                    document.querySelector('.btn-cancelar-posto').addEventListener('click', () => document.getElementById('form-novo-posto').classList.add('hidden'));
                    
                    document.getElementById('btn-salvar-posto').addEventListener('click', () => {
                        if (isProcessing) return;

                        const nome = document.getElementById('posto-nome').value.trim();
                        const bandeira = document.getElementById('posto-bandeira').value;
                        const end = document.getElementById('posto-endereco').value;
                        
                        if(nome) { 
                            if(!AppState.postosCombustivel) AppState.postosCombustivel = []; 
                            
                            AppState.postosCombustivel.push({ 
                                id: Utils.gerarUUID(), 
                                nome, 
                                bandeira, 
                                endereco: end, 
                                imagem: imagemFinal // Estrutura H√≠brida Aceita
                            }); 
                            
                            Storage.salvarConfiguracoes(); 
                            EventHandlers.renderPostosList(); 
                            document.getElementById('form-novo-posto').classList.add('hidden'); 
                            
                            // Re-renderiza o dropdown para evitar duplica√ß√£o (Corre√ß√£o V9)
                            const dl = document.getElementById('postos-list-id'); 
                            if(dl) {
                                dl.innerHTML = AppState.postosCombustivel.map(p => `<option value="${p.nome}">${p.bandeira || 'Outros'}</option>`).join('');
                            }
                        }
                    });

                    // --- 4. VALIDA√á√ÉO DE NEG√ìCIO DO REGISTRO (AUDITORIA V9) ---
                    document.getElementById('btn-salvar-abastecimento-pro').addEventListener('click', () => {
                        // Pr√©-Valida√ß√£o antes de chamar o Handler
                        const val = Utils.parseMoeda(document.getElementById('fuel-valor').value);
                        const lit = Utils.parseMoeda(document.getElementById('fuel-litros').value);
                        const kmAtual = parseInt(document.getElementById('fuel-km').value) || 0;
                        
                        if (val <= 0 || lit <= 0) {
                            UIRenderer.abrirModal('alerta', { titulo: 'Erro Cont√°bil', mensagem: 'Valor e Litros devem ser maiores que zero.' });
                            return;
                        }
                        
                        const ultimoKm = BusinessLogic.getUltimoKmRegistrado();
                        if (ultimoKm > 0 && kmAtual > 0 && kmAtual < ultimoKm) {
                            if (!confirm(`‚ö†Ô∏è KM INCONSISTENTE!\n\nAtual: ${kmAtual}\nAnterior: ${ultimoKm}\n\nO od√¥metro est√° menor que o registro anterior. Confirmar assim mesmo?`)) {
                                return;
                            }
                        }

                        EventHandlers.handleSalvarAbastecimentoPro();
                    });

                    document.getElementById('btn-voltar-lista-postos').addEventListener('click', () => { document.getElementById('view-detalhes-posto').classList.add('hidden'); document.getElementById('view-lista-postos').classList.remove('hidden'); });

                    // --- 5. SINCRONIZA√á√ÉO DE CONFIGURA√á√ÉO ---
                    const radiosConfig = document.querySelectorAll('input[name="metodoLeituraConfig"]');
                    radiosConfig.forEach(r => {
                        r.addEventListener('change', (e) => {
                            const novoModo = e.target.value;
                            AppState.configuracoes.metodoLeituraCombustivel = novoModo;
                            Storage.salvarConfiguracoes();

                            const inputLeitura = document.getElementById('fuel-leitura');
                            const labelLeitura = document.getElementById('label-fuel-leitura');
                            if (inputLeitura && labelLeitura) {
                                if (novoModo === 'consumo') {
                                    labelLeitura.innerHTML = 'Consumido (Painel) <span class="text-slate-500">(Opcional)</span>';
                                    inputLeitura.placeholder = 'Ex: 8,5';
                                } else {
                                    labelLeitura.innerHTML = 'Restante (Tanque) <span class="text-slate-500">(Opcional)</span>';
                                    inputLeitura.placeholder = 'Ex: 5,0';
                                }
                            }

                            const lblNivel = document.getElementById('lbl-metodo-nivel');
                            const lblConsumo = document.getElementById('lbl-metodo-consumo');
                            const classAtivo = 'border-cyan-500 bg-cyan-900/20 ring-1 ring-cyan-500 text-white';
                            const classInativo = 'border-slate-600 text-slate-400 hover:bg-slate-800 hover:border-slate-500';

                            lblNivel.className = `flex flex-col items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${novoModo === 'nivel' ? classAtivo : classInativo}`;
                            lblConsumo.className = `flex flex-col items-center p-3 rounded-lg border-2 cursor-pointer transition-all ${novoModo === 'consumo' ? classAtivo : classInativo}`;

                            const helpText = document.getElementById('fuel-config-help');
                            if (helpText) {
                                helpText.textContent = infoMetodo[novoModo];
                                helpText.classList.remove('text-slate-400');
                                helpText.classList.add('text-green-400');
                                setTimeout(() => {
                                    helpText.classList.remove('text-green-400');
                                    helpText.classList.add('text-slate-400');
                                }, 600);
                            }

                            const radiosMain = document.querySelectorAll('input[name="metodoLeituraCombustivel"]');
                            radiosMain.forEach(mainRadio => {
                                if (mainRadio.value === novoModo) mainRadio.checked = true;
                            });
                        });
                    });

                }, 100);
                break;
            } 

// NOVO MODAL: ABASTECIMENTO RETROATIVO (COM SELETOR DE CONTA)
                case 'registroAbastecimentoRetroativo': {
                    const hoje = new Date().toISOString().split('T')[0];
                    const { metodoLeituraCombustivel, contasBancarias } = AppState.configuracoes;
                    const isConsumo = metodoLeituraCombustivel === 'consumo';
                    const labelLeitura = isConsumo ? 'Litros Consumidos (Painel)' : 'Litros Restantes (Tanque)';
                    const placeholderLeitura = isConsumo ? 'Ex: 8,5' : 'Ex: 15,0';

                    // Gera op√ß√µes de conta
                    let optionsContas = `<option value="AUTO_ID_CARTEIRA">üíµ Carteira (Dinheiro)</option>`;
                    contasBancarias.forEach(c => {
                        if (c.tipo !== 'credito') {
                            optionsContas += `<option value="${c.id}">${c.nome}</option>`;
                        }
                    });

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <h3 class="text-lg font-bold text-amber-400">Abastecimento Retroativo</h3>
                            <p class="text-xs text-slate-400">Registre os dados para corrigir a m√©dia.</p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Data</label>
                                    <input type="date" id="retro-data" max="${hoje}" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Conta Pagto</label>
                                    <select id="retro-conta-id" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white">
                                        ${optionsContas}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Litros</label>
                                    <input type="text" inputmode="decimal" id="retro-litros" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Valor (R$)</label>
                                    <input type="text" inputmode="decimal" id="retro-valor" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs text-slate-400 mb-1 text-cyan-300">${labelLeitura}</label>
                                <input type="text" inputmode="decimal" id="retro-leitura" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white font-bold" placeholder="${placeholderLeitura}">
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">KM no momento (Opcional)</label>
                                <input type="number" id="retro-km" class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-white">
                            </div>

                            <div class="flex justify-end gap-4 pt-2">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                                <button id="btn-salvar-retroativo" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                            </div>
                        </div>`;
                    
                    // Listener direto
                    setTimeout(() => {
                        document.getElementById('btn-salvar-retroativo').onclick = (e) => {
                            e.preventDefault(); EventHandlers.handleSalvarRetroativo(); // Chama a nova fun√ß√£o
                        };
                    }, 50);
                    break;
                }

              // 1. CONFIGURA√á√ÉO DE PROVISIONAMENTO (NOVO)
                case 'configurarProvisionamento': {
                    const prefs = AppState.configuracoes.itensProvisionamento || { incluirCustosFixos: true, incluirProLabore: false, incluirMetas: false };
                    
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                                <h3 class="text-xl font-bold text-cyan-400">Provisionamento Di√°rio</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <p class="text-sm text-slate-400">Selecione o que deve ser descontado automaticamente da sua meta di√°ria:</p>
                            <div class="space-y-3 bg-slate-900 p-4 rounded-lg">
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" id="prov-custos-fixos" class="mt-1 h-5 w-5 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-cyan-500" ${prefs.incluirCustosFixos ? 'checked' : ''}>
                                    <div><span class="block font-bold text-white">Custos Fixos Mensais</span><span class="block text-xs text-slate-500">Aluguel, Seguro (Prioridade Alta)</span></div>
                                </label>
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" id="prov-prolabore" class="mt-1 h-5 w-5 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-cyan-500" ${prefs.incluirProLabore ? 'checked' : ''}>
                                    <div><span class="block font-bold text-white">Pr√≥-Labore (Sal√°rio)</span><span class="block text-xs text-slate-500">Garantir seu sal√°rio no custo</span></div>
                                </label>
                                <label class="flex items-start gap-3 cursor-pointer">
                                    <input type="checkbox" id="prov-metas" class="mt-1 h-5 w-5 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-cyan-500" ${prefs.incluirMetas ? 'checked' : ''}>
                                    <div><span class="block font-bold text-white">Outras Metas/D√≠vidas</span><span class="block text-xs text-slate-500">Caixinhas opcionais</span></div>
                                </label>
                            </div>
                            <div class="flex justify-end gap-4 pt-2">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                                <button id="btn-salvar-config-provisionamento" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Confirmar</button>
                            </div>
                        </div>`;
                    break;
                }
// --- NOVO: ANTECIPAR PARCELAS (CART√ÉO) ---
                case 'anteciparParcela': {
                    const { transacaoId, valorTotal, numParcelas, descricaoItem, contaFaturaId } = options;
                    const valorParcela = valorTotal / numParcelas;
                    
                    // Lista de Fontes (Bancos e Caixinhas com saldo)
                    const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                    let optionsFontes = '<option value="">Selecione a origem...</option>';
                    
                    contasBancarias.forEach(c => {
                        if (c.tipo !== 'credito') {
                             optionsFontes += `<option value="${c.id}">Banco: ${c.nome} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(c.id))})</option>`;
                        }
                    });
                    metasFinanceiras.forEach(m => {
                        if (m.tipo === 'poupanca' || m.tipo === 'poupanca_km') {
                             optionsFontes += `<option value="${m.id}">Caixinha: ${m.descricao} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(m.id))})</option>`;
                        }
                    });

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <h3 class="text-xl font-bold text-white">Antecipar Parcelas</h3>
                            <p class="text-sm text-slate-400 bg-slate-900 p-3 rounded">
                                Item: <b class="text-white">${descricaoItem}</b><br>
                                Restante Original: ${Utils.formatarMoeda(valorTotal)} (${numParcelas}x de ${Utils.formatarMoeda(valorParcela)})
                            </p>
                            
                            <input type="hidden" id="antecipar-transacao-id" value="${transacaoId}">
                            <input type="hidden" id="antecipar-fatura-id" value="${contaFaturaId}">
                            <input type="hidden" id="antecipar-valor-parcela-base" value="${valorParcela}">

                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Quantas parcelas antecipar?</label>
                                <select id="antecipar-qtd-parcelas" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                    ${Array.from({length: numParcelas}, (_, i) => `<option value="${i+1}">${i+1}x (Base: ${Utils.formatarMoeda(valorParcela * (i+1))})</option>`).join('')}
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-3 pt-2 border-t border-slate-700">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Valor a Pagar (R$)</label>
                                    <input type="text" inputmode="decimal" id="antecipar-valor-pagar" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white font-bold text-green-400">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Desconto (%)</label>
                                    <div class="relative">
                                        <input type="number" id="antecipar-desconto-percent" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white text-right pr-6">
                                        <span class="absolute right-2 top-2 text-slate-400">%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="antecipar-info-economia" class="text-center text-xs text-green-400 hidden">
                                Economia de <span id="val-economia">R$ 0,00</span>
                            </div>

                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Pagar com:</label>
                                <select id="antecipar-fonte-id" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                    ${optionsFontes}
                                </select>
                            </div>

                            <div class="flex justify-end gap-4 pt-2">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                                <button id="btn-confirmar-antecipacao" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition">Pagar e Antecipar</button>
                            </div>
                        </div>`;
                    
                    // L√ìGICA DE C√ÅLCULO BIDIRECIONAL (IGUAL DEPRECIA√á√ÉO)
                    setTimeout(() => {
                        const qtdSelect = document.getElementById('antecipar-qtd-parcelas');
                        const inputValor = document.getElementById('antecipar-valor-pagar');
                        const inputPercent = document.getElementById('antecipar-desconto-percent');
                        const infoEconomia = document.getElementById('antecipar-info-economia');
                        const spanEconomia = document.getElementById('val-economia');
                        const baseParcela = parseFloat(document.getElementById('antecipar-valor-parcela-base').value);

                        const atualizarCalculos = (origem) => {
                            const qtd = parseInt(qtdSelect.value);
                            const valorBaseTotal = baseParcela * qtd;
                            
                            if (origem === 'qtd') {
                                // Reseta
                                inputPercent.value = ''; 
                                inputValor.value = Utils.formatarMoedaParaInput(valorBaseTotal);
                            }
                            
                            if (origem === 'valor') {
                                const valorPago = Utils.parseMoeda(inputValor.value);
                                if (valorPago > 0 && valorBaseTotal > 0) {
                                    const desconto = 100 - ((valorPago / valorBaseTotal) * 100);
                                    inputPercent.value = desconto.toFixed(2).replace('.', ',');
                                }
                            }
                            
                            if (origem === 'percent') {
                                const percent = Utils.parseMoeda(inputPercent.value) || 0;
                                const valorComDesconto = valorBaseTotal * (1 - (percent / 100));
                                inputValor.value = Utils.formatarMoedaParaInput(valorComDesconto);
                            }

                            // Atualiza info de economia
                            const valorFinal = Utils.parseMoeda(inputValor.value);
                            const economia = valorBaseTotal - valorFinal;
                            if (economia > 0.01) {
                                infoEconomia.classList.remove('hidden');
                                spanEconomia.textContent = Utils.formatarMoeda(economia);
                            } else {
                                infoEconomia.classList.add('hidden');
                            }
                        };

                        qtdSelect.addEventListener('change', () => atualizarCalculos('qtd'));
                        inputValor.addEventListener('input', () => atualizarCalculos('valor'));
                        inputPercent.addEventListener('input', () => atualizarCalculos('percent'));
                        
                        // Inicializa
                        atualizarCalculos('qtd');

                    }, 100);
                    break;
                }
                
// =================================================================
            // CASE: NOVA TRANSA√á√ÉO AVULSA (V116 - FUS√ÉO V92 UX + V97 FINANCEIRO)
            // =================================================================
            case 'novaTransacaoAvulsa': {
                // 1. RECUPERA√á√ÉO DE ESTADO (Combust√≠vel Pendente - L√≥gica V92 Restaurada)
                const pendingFuel = JSON.parse(localStorage.getItem('temp_abastecimento_pendente') || 'null');
                
                if (pendingFuel && !AppState.tempAbastecimento) {
                    console.info("‚ôªÔ∏è Estado de abastecimento restaurado.");
                    AppState.tempAbastecimento = pendingFuel;
                    AppState.modalContext = 'pagamento_abastecimento';
                    if(!options) options = {};
                    options.defaultCategoria = 'Abastecimento';
                    
                    // RESTAURADO: Descri√ß√£o Rica (Litros + Nome do Posto)
                    const descLitros = pendingFuel.litros ? `(${pendingFuel.litros}L)` : '';
                    const descPosto = pendingFuel.postoNome ? ` - ${pendingFuel.postoNome}` : '';
                    options.defaultDescricao = `Abastecimento ${descLitros}${descPosto}`;
                }
                
                // 2. DESESTRUTURA√á√ÉO
                const { 
                    defaultTipo, defaultValor, defaultCategoria, defaultSubcategoria, 
                    defaultDescricao, defaultRecorrenteId, jornadaId, 
                    isCustoOperacional, isReadonly, defaultData, defaultContaId, context 
                } = options || {};
                
                const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                
                // 3. OP√á√ïES DE CONTA (Estrutura V97 - Mais Limpa)
                let optionsContas = `<option value="AUTO_ID_CARTEIRA">üíµ Carteira (Saldo: ${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA'))})</option>`;
                
                contasBancarias.forEach(c => {
                    if (c.tipo !== 'credito') {
                        optionsContas += `<option value="${c.id}">${c.nome} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(c.id))})</option>`;
                    } else {
                        const disp = (c.limite || 0) - BusinessLogic.calcularSaldoConta(`FATURA_${c.id}`);
                        optionsContas += `<option value="${c.id}" data-credito="true">üí≥ ${c.nome} (Disp: ${Utils.formatarMoeda(disp)})</option>`;
                    }
                });

                if (metasFinanceiras) {
                    optionsContas += `<optgroup label="Caixinhas e Metas">`;
                    metasFinanceiras.forEach(m => {
                        if (!m.id.startsWith('FATURA_') && ['poupanca', 'poupanca_km', 'caixa', 'parcelamento'].includes(m.tipo)) {
                            const saldo = (m.tipo === 'parcelamento') ? (m.valorProvisionado || 0) : (m.valorAtual || 0);
                            optionsContas += `<option value="${m.id}">üì¶ ${m.descricao} (${Utils.formatarMoeda(saldo)})</option>`;
                        }
                    });
                    optionsContas += `</optgroup>`;
                }

                // 4. CATEGORIAS
                const categoriasSaida = [
                    'Manuten√ß√£o', 'Ve√≠culo', 'Abastecimento', 'Alimenta√ß√£o', 
                    'Administrativo', 'Impostos', 'Seguro', 
                    'Moradia', 'Transporte', 'Sa√∫de', 'Lazer', 'Educa√ß√£o', 'Roupas', 
                    'Outras Despesas', 'Custos Fixos', 'Metas Financeiras'
                ];
                const optionsSaida = categoriasSaida.map(c => `<option value="${c}">${c}</option>`).join('');
                
                // =============================================================
                // üõ†Ô∏è FIX DE DATA (V130): Converte Timestamp -> YYYY-MM-DD
                // =============================================================
                let dataInicial;
                if (defaultData) {
                    // Cria data a partir do timestamp recebido (HOJE)
                    const d = new Date(defaultData);
                    // Ajusta o fuso para que o .toISOString() n√£o pegue o dia anterior (UTC)
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    // Pega s√≥ a parte da data: "2025-12-29"
                    dataInicial = d.toISOString().split('T')[0];
                } else {
                    dataInicial = Utils.getDataInputHoje();
                }
                // =============================================================

                const valorFormatado = defaultValor ? Utils.formatarMoedaParaInput(defaultValor) : '';
                const checkCustoOperacional = (isCustoOperacional === true) ? 'checked' : '';

                // 5. HTML DO MODAL (Layout V97 - Melhor para Cr√©dito)
                modalHTML = `
                    <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4 border border-slate-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-blue-400">Nova Transa√ß√£o</h3>
                            <button id="btn-modal-close-x" class="text-slate-400 hover:text-white text-2xl">√ó</button>
                        </div>
                        
                        <input type="hidden" id="trans-recorrente-id" value="${defaultRecorrenteId || ''}">
                        <input type="hidden" id="trans-jornada-id" value="${jornadaId || ''}">
                        <input type="hidden" id="trans-context" value="${context || ''}">

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Tipo</label>
                                <select id="trans-tipo" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none" ${isReadonly ? 'disabled' : ''}>
                                    <option value="saida">Sa√≠da (Gasto)</option>
                                    <option value="entrada">Entrada (Ganho)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Data</label>
                                <input type="date" id="trans-data" value="${dataInicial}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Valor Total (R$)</label>
                            <input type="text" inputmode="decimal" id="trans-valor" value="${valorFormatado}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white text-lg font-bold text-center focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="0,00" ${isReadonly ? 'readonly' : ''}>
                        </div>

                        <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                            <div id="container-conta-unica">
                                <label class="block text-xs text-slate-400 mb-1">Conta / Origem do Pagamento</label>
                                <select id="trans-conta-id" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white font-bold text-sm outline-none">
                                    ${optionsContas}
                                </select>
                            </div>
                            
                            <div id="container-conta-mista" class="hidden space-y-2">
                                <p class="text-[10px] text-cyan-400 font-bold uppercase mb-1">Pagamento Dividido</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="trans-conta-1" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsContas}</select>
                                    <input type="text" id="trans-valor-1" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs text-right font-mono" placeholder="Valor 1">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="trans-conta-2" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsContas}</select>
                                    <input type="text" id="trans-valor-2" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-slate-300 text-xs text-right cursor-not-allowed font-mono" readonly placeholder="Restante">
                                </div>
                            </div>

                            <div class="mt-2 flex justify-between items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chk-trans-misto" class="rounded bg-slate-700 border-slate-500 text-cyan-500 focus:ring-0">
                                    <span class="text-xs text-slate-300">Usar 2 formas de pagamento</span>
                                </label>
                                
                                <div id="container-parcelas" class="hidden flex items-center gap-2 bg-slate-700/50 px-2 py-1 rounded border border-slate-600">
                                    <span class="text-xs text-cyan-400 font-bold">Qtd:</span>
                                    <input type="number" id="trans-parcelas" value="1" min="1" max="99" class="w-12 bg-slate-800 border-slate-500 rounded p-1 text-center text-white text-xs font-bold focus:outline-none focus:border-cyan-500">
                                    <span id="info-parcela-calc" class="text-[10px] text-amber-300 font-mono ml-1 hidden"></span>
                                </div>
                            </div>
                        </div>

                        <div><label class="block text-xs text-slate-400 mb-1">Categoria</label><select id="trans-categoria" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white outline-none" ${isReadonly ? 'disabled' : ''}>${optionsSaida}</select></div>
                        <div><label class="block text-xs text-slate-400 mb-1">Descri√ß√£o</label><input type="text" id="trans-descricao" value="${defaultDescricao || ''}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white outline-none" placeholder="Ex: Mercado, Gasolina..."></div>
                        
                        <div class="pt-2">
                            <label class="flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg cursor-pointer border border-slate-700/50 hover:border-slate-600 transition">
                                <div class="relative flex items-center">
                                    <input type="checkbox" id="trans-is-custo-operacional" class="peer sr-only" ${checkCustoOperacional}>
                                    <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </div>
                                <span class="text-sm text-slate-300">Custo Operacional? <span class="text-[10px] text-slate-500 block">(Abater do lucro da jornada)</span></span>
                            </label>
                        </div>

                        <div class="flex justify-end gap-4 pt-4 border-t border-slate-700 mt-2">
                            <button id="btn-modal-close-cancel" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                            <button id="btn-salvar-transacao-avulsa" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition flex items-center gap-2">
                                <span>Salvar</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    </div>`;
                
                // 6. EVENTOS
                setTimeout(() => {
                    const selTipo = document.getElementById('trans-tipo');
                    const selCategoria = document.getElementById('trans-categoria');
                    const inputDescricao = document.getElementById('trans-descricao');
                    const chkMisto = document.getElementById('chk-trans-misto');
                    const boxUnico = document.getElementById('container-conta-unica');
                    const boxMisto = document.getElementById('container-conta-mista');
                    const selConta = document.getElementById('trans-conta-id');
                    const c1 = document.getElementById('trans-conta-1');
                    const c2 = document.getElementById('trans-conta-2');
                    const divParcelas = document.getElementById('container-parcelas');
                    const inputTotal = document.getElementById('trans-valor');
                    const inputVal1 = document.getElementById('trans-valor-1');
                    const inputVal2 = document.getElementById('trans-valor-2');
                    const inputParcelas = document.getElementById('trans-parcelas');
                    const infoParcela = document.getElementById('info-parcela-calc');

                    // --- BRIDGE DE DADOS (Restaurado Defensivo V92) ---
                    if (defaultTipo) selTipo.value = defaultTipo;
                    else selTipo.value = 'saida';

                    if (defaultCategoria && selCategoria) {
                        selCategoria.value = defaultCategoria;
                        // RESTAURADO: Fallback mais robusto para 'Vari√°vel'
                        if (!selCategoria.value) {
                             if(defaultCategoria.includes('Vari√°vel')) selCategoria.value = 'Outras Despesas';
                             else if(defaultCategoria.includes('Alimenta√ß√£o')) selCategoria.value = 'Alimenta√ß√£o';
                             else selCategoria.value = 'Outras Despesas';
                        }
                    }

                    if (defaultSubcategoria && inputDescricao && !inputDescricao.value.includes(defaultSubcategoria)) {
                        inputDescricao.value = `${inputDescricao.value} (${defaultSubcategoria})`;
                    }
                    // ----------------------------

                    // Listeners de Fechar (RESTAURADO: Navega√ß√£o Inteligente V92)
                    const btnX = document.getElementById('btn-modal-close-x');
                    const btnCancel = document.getElementById('btn-modal-close-cancel');
                    
                    const acaoVoltar = (e) => {
                        if (e) e.preventDefault();
                        const ctxInput = document.getElementById('trans-context');
                        const ctxVal = ctxInput ? ctxInput.value : '';
                        const catVal = selCategoria ? selCategoria.value : '';

                        // Se veio do fluxo de abastecimento, volta para l√° ao cancelar
                        if (ctxVal === 'gestao_combustivel' || ctxVal === 'pagamento_abastecimento' || catVal === 'Abastecimento') {
                            UIRenderer.abrirModal('gestaoCombustivel');
                        } else {
                            UIRenderer.fecharModal();
                        }
                    };

                    if (btnX) btnX.onclick = acaoVoltar;
                    if (btnCancel) btnCancel.onclick = acaoVoltar;

                    // Salvar
                    document.getElementById('btn-salvar-transacao-avulsa').onclick = (e) => {
                        e.preventDefault(); 
                        EventHandlers.handleSalvarTransacaoAvulsa();
                    };

                    // M√°scaras e Parcelamento (L√≥gica Moderna V97)
                    inputTotal.addEventListener('input', (e) => Utils.mascaraMoeda(e.target));
                    inputVal1.addEventListener('input', (e) => Utils.mascaraMoeda(e.target));

                    const atualizarInfoParcela = () => {
                        const total = Utils.parseMoeda(inputTotal.value);
                        const qtd = parseInt(inputParcelas.value) || 1;
                        if (total > 0 && qtd > 1) {
                            const valorParc = total / qtd;
                            infoParcela.textContent = `(${Utils.formatarMoeda(valorParc)}/m√™s)`;
                            infoParcela.classList.remove('hidden');
                        } else {
                            infoParcela.classList.add('hidden');
                        }
                    };

                    chkMisto.addEventListener('change', () => {
                        boxUnico.classList.toggle('hidden', chkMisto.checked);
                        boxMisto.classList.toggle('hidden', !chkMisto.checked);
                        if(chkMisto.checked) {
                            inputVal1.value = inputTotal.value;
                            inputVal2.value = '0,00';
                            if (defaultContaId && [...c1.options].some(o => o.value === defaultContaId)) {
                                c1.value = defaultContaId;
                            }
                        }
                        checkCredito();
                    });

                    inputVal1.addEventListener('input', () => {
                        const total = Utils.parseMoeda(inputTotal.value);
                        const v1 = Utils.parseMoeda(inputVal1.value);
                        const resto = Math.max(0, total - v1);
                        inputVal2.value = Utils.formatarMoedaParaInput(resto);
                    });

                    const checkCredito = () => {
                        let isCredito = false;
                        if (chkMisto.checked) {
                            const opt1 = c1.options[c1.selectedIndex];
                            const opt2 = c2.options[c2.selectedIndex];
                            if ((opt1?.getAttribute('data-credito') === 'true') || (opt2?.getAttribute('data-credito') === 'true')) isCredito = true;
                        } else {
                            const opt = selConta.options[selConta.selectedIndex];
                            if (opt?.getAttribute('data-credito') === 'true') isCredito = true;
                        }

                        const deveMostrar = isCredito && selTipo.value === 'saida';
                        divParcelas.classList.toggle('hidden', !deveMostrar);
                        if (deveMostrar) atualizarInfoParcela();
                        else { inputParcelas.value = 1; infoParcela.classList.add('hidden'); }
                    };

                    inputTotal.addEventListener('input', () => {
                        if(chkMisto.checked) inputVal1.value = inputTotal.value;
                        atualizarInfoParcela();
                    });
                    inputParcelas.addEventListener('input', atualizarInfoParcela);
                    selConta.addEventListener('change', checkCredito);
                    c1.addEventListener('change', checkCredito);
                    c2.addEventListener('change', checkCredito);
                    selTipo.addEventListener('change', checkCredito);

                    // Sele√ß√£o Inicial de Conta
                    if(defaultContaId && [...selConta.options].some(o => o.value === defaultContaId)) {
                        selConta.value = defaultContaId;
                    }
                    
                    checkCredito(); // Roda uma vez para garantir

                }, 100);
                break;
            }        
  /*              
      // 2. NOVA TRANSA√á√ÉO AVULSA (V92 - COM BRIDGE DE DADOS PARA CUSTOS)
            case 'novaTransacaoAvulsa': {
                // =============================================================
                // üõ†Ô∏è STATE RECOVERY V33.3 (RECUPERA√á√ÉO DE ESTADO NA UI)
                // =============================================================
                const pendingFuel = JSON.parse(localStorage.getItem('temp_abastecimento_pendente') || 'null');
                
                if (pendingFuel && !AppState.tempAbastecimento) {
                    console.info("‚ôªÔ∏è Estado de abastecimento restaurado do disco para a mem√≥ria.");
                    AppState.tempAbastecimento = pendingFuel;
                    AppState.modalContext = 'pagamento_abastecimento';
                    if(!options) options = {};
                    options.defaultCategoria = 'Abastecimento';
                    const descLitros = pendingFuel.litros ? `(${pendingFuel.litros}L)` : '';
                    const descPosto = pendingFuel.postoNome ? ` - ${pendingFuel.postoNome}` : '';
                    options.defaultDescricao = `Abastecimento ${descLitros}${descPosto}`;
                }
                
                // Desestrutura√ß√£o dos dados recebidos
                const { 
                    defaultTipo, defaultValor, defaultCategoria, defaultSubcategoria, 
                    defaultDescricao, defaultRecorrenteId, jornadaId, 
                    isCustoOperacional, isReadonly, defaultData, defaultContaId, context 
                } = options || {};
                
                const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                
                // 1. OP√á√ïES DE CONTA
                let optionsContas = `<option value="AUTO_ID_CARTEIRA">üíµ Carteira (Saldo: ${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA'))})</option>`;
                
                contasBancarias.forEach(c => {
                    if (c.tipo !== 'credito') {
                        optionsContas += `<option value="${c.id}">${c.nome} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(c.id))})</option>`;
                    } else {
                        const disp = (c.limite || 0) - BusinessLogic.calcularSaldoConta(`FATURA_${c.id}`);
                        optionsContas += `<option value="${c.id}" data-credito="true">üí≥ ${c.nome} (Disp: ${Utils.formatarMoeda(disp)})</option>`;
                    }
                });

                if (metasFinanceiras) {
                    optionsContas += `<optgroup label="Caixinhas e Metas">`;
                    const metaCustos = metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                    if (metaCustos) {
                        const saldoCustos = metaCustos.valorAtual || 0;
                        const vinculo = metaCustos.bancoId ? ' (Vinc. Banco)' : '';
                        optionsContas += `<option value="${metaCustos.id}">üìâ ${metaCustos.descricao} [R$ ${Utils.formatarMoeda(saldoCustos)}]${vinculo}</option>`;
                    }
                    metasFinanceiras.forEach(m => {
                        if (m.id !== 'META_CUSTOS_MENSAIS' && !m.id.startsWith('FATURA_')) {
                            if (['poupanca', 'poupanca_km', 'caixa', 'parcelamento'].includes(m.tipo)) {
                                const saldo = (m.tipo === 'parcelamento') ? (m.valorProvisionado || 0) : (m.valorAtual || 0);
                                optionsContas += `<option value="${m.id}">üì¶ ${m.descricao} (${Utils.formatarMoeda(saldo)})</option>`;
                            }
                        }
                    });
                    optionsContas += `</optgroup>`;
                }

                // 2. CATEGORIAS (Lista Padr√£o do Modal)
                const categoriasSaida = [
                    'Manuten√ß√£o', 'Ve√≠culo', 'Abastecimento', 'Alimenta√ß√£o', 
                    'Administrativo', 'Impostos', 'Seguro', 
                    'Moradia', 'Transporte', 'Sa√∫de', 'Lazer', 'Educa√ß√£o', 'Roupas', 
                    'Outras Despesas', 'Custos Fixos', 'Metas Financeiras'
                ];
                // Note: Aqui ele tenta marcar selected, mas se o nome n√£o bater exato, falha. O JS abaixo corrige.
                const optionsSaida = categoriasSaida.map(c => `<option value="${c}" ${c === defaultCategoria ? 'selected' : ''}>${c}</option>`).join('');
                
                const dataInicial = defaultData || Utils.getDataInputHoje();
                const valorFormatado = defaultValor ? Utils.formatarMoedaParaInput(defaultValor) : '';
                const checkCustoOperacional = (isCustoOperacional === true) ? 'checked' : ''; // For√ßa booleano estrito

                // 3. HTML
                modalHTML = `
                    <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4 border border-slate-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-blue-400">Nova Transa√ß√£o</h3>
                            <button id="btn-modal-close-x" class="text-slate-400 hover:text-white text-2xl">√ó</button>
                        </div>
                        
                        <input type="hidden" id="trans-recorrente-id" value="${defaultRecorrenteId || ''}">
                        <input type="hidden" id="trans-jornada-id" value="${jornadaId || ''}">
                        <input type="hidden" id="trans-context" value="${context || ''}">

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Tipo</label>
                                <select id="trans-tipo" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none" ${isReadonly ? 'disabled' : ''}>
                                    <option value="saida" ${defaultTipo === 'saida' ? 'selected' : ''}>Sa√≠da (Gasto)</option>
                                    <option value="entrada" ${defaultTipo === 'entrada' ? 'selected' : ''}>Entrada (Ganho)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Data</label>
                                <input type="date" id="trans-data" value="${dataInicial}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Valor Total (R$)</label>
                            <input type="text" inputmode="decimal" id="trans-valor" value="${valorFormatado}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white text-lg font-bold text-center focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="0,00" ${isReadonly ? 'readonly' : ''}>
                        </div>

                        <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                            <div id="container-conta-unica">
                                <label class="block text-xs text-slate-400 mb-1">Conta / Origem do Pagamento</label>
                                <select id="trans-conta-id" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white font-bold text-sm outline-none">
                                    ${optionsContas}
                                </select>
                            </div>

                            <div id="container-conta-mista" class="hidden space-y-2">
                                <p class="text-[10px] text-cyan-400 font-bold uppercase mb-1">Pagamento Dividido</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="trans-conta-1" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsContas}</select>
                                    <input type="text" id="trans-valor-1" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs text-right font-mono" placeholder="Valor 1">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="trans-conta-2" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsContas}</select>
                                    <input type="text" id="trans-valor-2" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-slate-300 text-xs text-right cursor-not-allowed font-mono" readonly placeholder="Restante">
                                </div>
                            </div>

                            <div class="mt-2 flex justify-between items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chk-trans-misto" class="rounded bg-slate-700 border-slate-500 text-cyan-500 focus:ring-0">
                                    <span class="text-xs text-slate-300">Usar 2 formas de pagamento</span>
                                </label>
                                
                                <div id="container-parcelas" class="hidden flex items-center gap-2 bg-slate-700/50 px-2 py-1 rounded border border-slate-600">
                                    <span class="text-xs text-cyan-400 font-bold">Qtd:</span>
                                    <input type="number" id="trans-parcelas" value="1" min="1" max="99" class="w-12 bg-slate-800 border-slate-500 rounded p-1 text-center text-white text-xs font-bold focus:outline-none focus:border-cyan-500">
                                    <span id="info-parcela-calc" class="text-[10px] text-amber-300 font-mono ml-1 hidden"></span>
                                </div>
                            </div>
                        </div>

                        <div><label class="block text-xs text-slate-400 mb-1">Categoria</label><select id="trans-categoria" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white outline-none" ${isReadonly ? 'disabled' : ''}>${optionsSaida}</select></div>
                        <div><label class="block text-xs text-slate-400 mb-1">Descri√ß√£o</label><input type="text" id="trans-descricao" value="${defaultDescricao || ''}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white outline-none" placeholder="Ex: Mercado, Gasolina..."></div>
                        
                        <div class="pt-2">
                            <label class="flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg cursor-pointer border border-slate-700/50 hover:border-slate-600 transition">
                                <div class="relative flex items-center">
                                    <input type="checkbox" id="trans-is-custo-operacional" class="peer sr-only" ${checkCustoOperacional}>
                                    <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </div>
                                <span class="text-sm text-slate-300">Custo Operacional? <span class="text-[10px] text-slate-500 block">(Abater do lucro da jornada)</span></span>
                            </label>
                        </div>

                        <div class="flex justify-end gap-4 pt-4 border-t border-slate-700 mt-2">
                            <button id="btn-modal-close-cancel" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                            <button id="btn-salvar-transacao-avulsa" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition flex items-center gap-2">
                                <span>Salvar</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    </div>`;
                
                // --- 4. EVENTOS ---
                setTimeout(() => {
                    const selConta = document.getElementById('trans-conta-id');
                    const c1 = document.getElementById('trans-conta-1');
                    const c2 = document.getElementById('trans-conta-2');
                    const divParcelas = document.getElementById('container-parcelas');
                    const selTipo = document.getElementById('trans-tipo');
                    const chkMisto = document.getElementById('chk-trans-misto');
                    const boxUnico = document.getElementById('container-conta-unica');
                    const boxMisto = document.getElementById('container-conta-mista');
                    const inputTotal = document.getElementById('trans-valor');
                    const inputVal1 = document.getElementById('trans-valor-1');
                    const inputVal2 = document.getElementById('trans-valor-2');
                    const inputParcelas = document.getElementById('trans-parcelas');
                    const infoParcela = document.getElementById('info-parcela-calc');
                    const selCategoria = document.getElementById('trans-categoria');
                    const inputDescricao = document.getElementById('trans-descricao');

                    // =========================================================
                    // üöÄ BRIDGE DE DADOS (V92)
                    // Garante que o que veio do Registrar Custo entre nos campos
                    // =========================================================
                    
                    // 1. Categoria: Tenta selecionar. Se n√£o existir na lista, tenta 'Outras Despesas'
                    if (defaultCategoria && selCategoria) {
                        selCategoria.value = defaultCategoria;
                        // Se a categoria vinda n√£o existe na lista fixa do modal, o value fica vazio.
                        // Nesse caso, jogamos para "Outras Despesas" ou "Alimenta√ß√£o" (se for comida)
                        if (!selCategoria.value) {
                             if(defaultCategoria.includes('Vari√°vel')) selCategoria.value = 'Outras Despesas';
                             else if(defaultCategoria.includes('Alimenta√ß√£o')) selCategoria.value = 'Alimenta√ß√£o';
                             else selCategoria.value = 'Outras Despesas';
                        }
                    }

                    // 2. Subcategoria: Concatena na descri√ß√£o se n√£o estiver l√°
                    if (defaultSubcategoria && inputDescricao) {
                        if (!inputDescricao.value.includes(defaultSubcategoria)) {
                             inputDescricao.value = `${defaultDescricao} (${defaultSubcategoria})`;
                        }
                    }
                    // =========================================================

                    const btnX = document.getElementById('btn-modal-close-x');
                    const btnCancel = document.getElementById('btn-modal-close-cancel');

                    const acaoVoltar = (e) => {
                        if (e) e.preventDefault();
                        const ctxInput = document.getElementById('trans-context');
                        let safeContext = ctxInput ? ctxInput.value : '';
                        const catInput = document.getElementById('trans-categoria');
                        if (!safeContext && catInput && catInput.value === 'Abastecimento') {
                            safeContext = 'gestao_combustivel';
                        }
                        
                        if (safeContext === 'gestao_combustivel' || safeContext === 'abastecimento') {
                            UIRenderer.abrirModal('gestaoCombustivel');
                        } else {
                            UIRenderer.fecharModal();
                        }
                    };

                    if (btnX) btnX.onclick = acaoVoltar;
                    if (btnCancel) btnCancel.onclick = acaoVoltar;

                    document.getElementById('btn-salvar-transacao-avulsa').onclick = (e) => {
                        e.preventDefault(); 
                        EventHandlers.handleSalvarTransacaoAvulsa();
                    };

                    inputTotal.addEventListener('input', (e) => Utils.mascaraMoeda(e.target));
                    inputVal1.addEventListener('input', (e) => Utils.mascaraMoeda(e.target));

                    const atualizarInfoParcela = () => {
                        const total = Utils.parseMoeda(inputTotal.value);
                        const qtd = parseInt(inputParcelas.value) || 1;
                        if (total > 0 && qtd > 1) {
                            const valorParc = total / qtd;
                            infoParcela.textContent = `(${Utils.formatarMoeda(valorParc)}/m√™s)`;
                            infoParcela.classList.remove('hidden');
                        } else {
                            infoParcela.textContent = '';
                            infoParcela.classList.add('hidden');
                        }
                    };

                    chkMisto.addEventListener('change', () => {
                        boxUnico.classList.toggle('hidden', chkMisto.checked);
                        boxMisto.classList.toggle('hidden', !chkMisto.checked);
                        if (chkMisto.checked) {
                            inputVal1.value = inputTotal.value;
                            inputVal2.value = '0,00';
                            if (defaultContaId) {
                                if ([...c1.options].some(o => o.value === defaultContaId)) {
                                    c1.value = defaultContaId;
                                }
                                c2.selectedIndex = 0; 
                            }
                        }
                        checkCredito();
                    });

                    inputVal1.addEventListener('input', () => {
                        const total = Utils.parseMoeda(inputTotal.value);
                        const v1 = Utils.parseMoeda(inputVal1.value);
                        const resto = Math.max(0, total - v1);
                        inputVal2.value = Utils.formatarMoedaParaInput(resto);
                    });

                    const checkCredito = () => {
                        let isCredito = false;
                        if (chkMisto.checked) {
                            const opt1 = c1.options[c1.selectedIndex];
                            const opt2 = c2.options[c2.selectedIndex];
                            if ((opt1 && opt1.getAttribute('data-credito') === 'true') || 
                                (opt2 && opt2.getAttribute('data-credito') === 'true')) {
                                isCredito = true;
                            }
                        } else {
                            const opt = selConta.options[selConta.selectedIndex];
                            if (opt && opt.getAttribute('data-credito') === 'true') isCredito = true;
                        }

                        const deveMostrar = isCredito && selTipo.value === 'saida';
                        divParcelas.classList.toggle('hidden', !deveMostrar);
                        if (deveMostrar) {
                            atualizarInfoParcela();
                        } else {
                            inputParcelas.value = 1;
                            infoParcela.textContent = '';
                            infoParcela.classList.add('hidden');
                        }
                    };

                    inputTotal.addEventListener('input', () => {
                        if(chkMisto.checked) inputVal1.value = inputTotal.value;
                        atualizarInfoParcela();
                    });
                    inputParcelas.addEventListener('input', atualizarInfoParcela);

                    selConta.addEventListener('change', checkCredito);
                    c1.addEventListener('change', checkCredito);
                    c2.addEventListener('change', checkCredito);
                    selTipo.addEventListener('change', checkCredito);

                    if(defaultTipo) selTipo.value = defaultTipo;
                    
                    if(defaultContaId && [...selConta.options].some(o => o.value === defaultContaId)) {
                        selConta.value = defaultContaId;
                    }
                    
                    checkCredito();
                }, 100);
                break;
            }          

*/

                 
                
  /*              
// 2. NOVA TRANSA√á√ÉO AVULSA (FINAL - VOLTAR INTELIGENTE COM FALLBACK)
            case 'novaTransacaoAvulsa': {
                // =============================================================
                // üõ†Ô∏è STATE RECOVERY V33.3 (RECUPERA√á√ÉO DE ESTADO NA UI)
                // Se houve refresh/crash, recupera os dados do disco para a RAM
                // ANTES de desenhar a tela.
                // =============================================================
                const pendingFuel = JSON.parse(localStorage.getItem('temp_abastecimento_pendente') || 'null');
                
                // Se existe dado no disco (persistente), mas a mem√≥ria (vol√°til) est√° vazia:
                if (pendingFuel && !AppState.tempAbastecimento) {
                    console.info("‚ôªÔ∏è Estado de abastecimento restaurado do disco para a mem√≥ria.");
                    
                    // Restaura o Estado Global
                    AppState.tempAbastecimento = pendingFuel;
                    AppState.modalContext = 'pagamento_abastecimento';
                    
                    // Auto-preenche as op√ß√µes visuais para o modal j√° abrir correto
                    if(!options) options = {};
                    options.defaultCategoria = 'Abastecimento';
                    // Tenta criar uma descri√ß√£o √∫til
                    const descLitros = pendingFuel.litros ? `(${pendingFuel.litros}L)` : '';
                    const descPosto = pendingFuel.postoNome ? ` - ${pendingFuel.postoNome}` : '';
                    options.defaultDescricao = `Abastecimento ${descLitros}${descPosto}`;
                }
                const { 
                    defaultTipo, defaultValor, defaultCategoria, defaultSubcategoria, 
                    defaultDescricao, defaultRecorrenteId, jornadaId, 
                    isCustoOperacional, isReadonly, defaultData, defaultContaId, context 
                } = options || {};
                
                const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                
                // 1. OP√á√ïES DE CONTA
                let optionsContas = `<option value="AUTO_ID_CARTEIRA">üíµ Carteira (Saldo: ${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA'))})</option>`;
                
                contasBancarias.forEach(c => {
                    if (c.tipo !== 'credito') {
                        optionsContas += `<option value="${c.id}">${c.nome} (${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(c.id))})</option>`;
                    } else {
                        const disp = (c.limite || 0) - BusinessLogic.calcularSaldoConta(`FATURA_${c.id}`);
                        optionsContas += `<option value="${c.id}" data-credito="true">üí≥ ${c.nome} (Disp: ${Utils.formatarMoeda(disp)})</option>`;
                    }
                });

                if (metasFinanceiras) {
                    optionsContas += `<optgroup label="Caixinhas e Metas">`;
                    const metaCustos = metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                    if (metaCustos) {
                        const saldoCustos = metaCustos.valorAtual || 0;
                        const vinculo = metaCustos.bancoId ? ' (Vinc. Banco)' : '';
                        optionsContas += `<option value="${metaCustos.id}">üìâ ${metaCustos.descricao} [R$ ${Utils.formatarMoeda(saldoCustos)}]${vinculo}</option>`;
                    }
                    metasFinanceiras.forEach(m => {
                        if (m.id !== 'META_CUSTOS_MENSAIS' && !m.id.startsWith('FATURA_')) {
                            if (['poupanca', 'poupanca_km', 'caixa', 'parcelamento'].includes(m.tipo)) {
                                const saldo = (m.tipo === 'parcelamento') ? (m.valorProvisionado || 0) : (m.valorAtual || 0);
                                optionsContas += `<option value="${m.id}">üì¶ ${m.descricao} (${Utils.formatarMoeda(saldo)})</option>`;
                            }
                        }
                    });
                    optionsContas += `</optgroup>`;
                }

                // 2. CATEGORIAS
                const categoriasSaida = [
                    'Manuten√ß√£o', 'Ve√≠culo', 'Abastecimento', 'Alimenta√ß√£o', 
                    'Administrativo', 'Impostos', 'Seguro', 
                    'Moradia', 'Transporte', 'Sa√∫de', 'Lazer', 'Educa√ß√£o', 'Roupas', 
                    'Outras Despesas', 'Custos Fixos', 'Metas Financeiras'
                ];
                const optionsSaida = categoriasSaida.map(c => `<option value="${c}" ${c === defaultCategoria ? 'selected' : ''}>${c}</option>`).join('');
                
                const dataInicial = defaultData || Utils.getDataInputHoje();
                const valorFormatado = defaultValor ? Utils.formatarMoedaParaInput(defaultValor) : '';
                const checkCustoOperacional = (isCustoOperacional !== false) ? 'checked' : '';

                // 3. HTML (COM IDs REAIS)
                modalHTML = `
                    <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4 border border-slate-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-blue-400">Nova Transa√ß√£o</h3>
                            <button id="btn-modal-close-x" class="text-slate-400 hover:text-white text-2xl">√ó</button>
                        </div>
                        
                        <input type="hidden" id="trans-recorrente-id" value="${defaultRecorrenteId || ''}">
                        <input type="hidden" id="trans-jornada-id" value="${jornadaId || ''}">
                        <input type="hidden" id="trans-context" value="${context || ''}">

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Tipo</label>
                                <select id="trans-tipo" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none" ${isReadonly ? 'disabled' : ''}>
                                    <option value="saida" ${defaultTipo === 'saida' ? 'selected' : ''}>Sa√≠da (Gasto)</option>
                                    <option value="entrada" ${defaultTipo === 'entrada' ? 'selected' : ''}>Entrada (Ganho)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Data</label>
                                <input type="date" id="trans-data" value="${dataInicial}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Valor Total (R$)</label>
                            <input type="text" inputmode="decimal" id="trans-valor" value="${valorFormatado}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white text-lg font-bold text-center focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="0,00" ${isReadonly ? 'readonly' : ''}>
                        </div>

                        <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                            <div id="container-conta-unica">
                                <label class="block text-xs text-slate-400 mb-1">Conta / Origem do Pagamento</label>
                                <select id="trans-conta-id" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white font-bold text-sm outline-none">
                                    ${optionsContas}
                                </select>
                            </div>

                            <div id="container-conta-mista" class="hidden space-y-2">
                                <p class="text-[10px] text-cyan-400 font-bold uppercase mb-1">Pagamento Dividido</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="trans-conta-1" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsContas}</select>
                                    <input type="text" id="trans-valor-1" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs text-right font-mono" placeholder="Valor 1">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="trans-conta-2" class="col-span-2 w-full bg-slate-700 border-slate-600 rounded p-2 text-white text-xs">${optionsContas}</select>
                                    <input type="text" id="trans-valor-2" class="w-full bg-slate-800 border-slate-600 rounded p-2 text-slate-300 text-xs text-right cursor-not-allowed font-mono" readonly placeholder="Restante">
                                </div>
                            </div>

                            <div class="mt-2 flex justify-between items-center">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chk-trans-misto" class="rounded bg-slate-700 border-slate-500 text-cyan-500 focus:ring-0">
                                    <span class="text-xs text-slate-300">Usar 2 formas de pagamento</span>
                                </label>
                                
                                <div id="container-parcelas" class="hidden flex items-center gap-2 bg-slate-700/50 px-2 py-1 rounded border border-slate-600">
                                    <span class="text-xs text-cyan-400 font-bold">Qtd:</span>
                                    <input type="number" id="trans-parcelas" value="1" min="1" max="99" class="w-12 bg-slate-800 border-slate-500 rounded p-1 text-center text-white text-xs font-bold focus:outline-none focus:border-cyan-500">
                                    <span id="info-parcela-calc" class="text-[10px] text-amber-300 font-mono ml-1 hidden"></span>
                                </div>
                            </div>
                        </div>

                        <div><label class="block text-xs text-slate-400 mb-1">Categoria</label><select id="trans-categoria" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white outline-none" ${isReadonly ? 'disabled' : ''}>${optionsSaida}</select></div>
                        <div><label class="block text-xs text-slate-400 mb-1">Descri√ß√£o</label><input type="text" id="trans-descricao" value="${defaultDescricao || ''}" class="w-full bg-slate-700 border-slate-600 rounded-lg p-3 text-white outline-none" placeholder="Ex: Mercado, Gasolina..."></div>
                        
                        <div class="pt-2">
                            <label class="flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg cursor-pointer border border-slate-700/50 hover:border-slate-600 transition">
                                <div class="relative flex items-center">
                                    <input type="checkbox" id="trans-is-custo-operacional" class="peer sr-only" ${checkCustoOperacional}>
                                    <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </div>
                                <span class="text-sm text-slate-300">Custo Operacional? <span class="text-[10px] text-slate-500 block">(Abater do lucro da jornada)</span></span>
                            </label>
                        </div>

                        <div class="flex justify-end gap-4 pt-4 border-t border-slate-700 mt-2">
                            <button id="btn-modal-close-cancel" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                            <button id="btn-salvar-transacao-avulsa" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition flex items-center gap-2">
                                <span>Salvar</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    </div>`;
                
                // --- 4. EVENTOS ---
                setTimeout(() => {
                    const selConta = document.getElementById('trans-conta-id');
                    const c1 = document.getElementById('trans-conta-1');
                    const c2 = document.getElementById('trans-conta-2');
                    const divParcelas = document.getElementById('container-parcelas');
                    const selTipo = document.getElementById('trans-tipo');
                    const chkMisto = document.getElementById('chk-trans-misto');
                    const boxUnico = document.getElementById('container-conta-unica');
                    const boxMisto = document.getElementById('container-conta-mista');
                    const inputTotal = document.getElementById('trans-valor');
                    const inputVal1 = document.getElementById('trans-valor-1');
                    const inputVal2 = document.getElementById('trans-valor-2');
                    const inputParcelas = document.getElementById('trans-parcelas');
                    const infoParcela = document.getElementById('info-parcela-calc');

                    // ==============================================================
                    // L√ìGICA DE VOLTAR INTELIGENTE (COM FALLBACK DE INFER√äNCIA)
                    // ==============================================================
                    const btnX = document.getElementById('btn-modal-close-x');
                    const btnCancel = document.getElementById('btn-modal-close-cancel');

                    const acaoVoltar = (e) => {
                        if (e) e.preventDefault();
                        
                        // 1. Tenta pegar do input hidden (Fonte da verdade do HTML)
                        const ctxInput = document.getElementById('trans-context');
                        let safeContext = ctxInput ? ctxInput.value : '';

                        // 2. Fallback: Se vazio, olha a categoria
                        const catInput = document.getElementById('trans-categoria');
                        if (!safeContext && catInput && catInput.value === 'Abastecimento') {
                            safeContext = 'gestao_combustivel';
                        }

                        console.log('üîô Bot√£o Cancelar/X acionado. Contexto (DOM):', safeContext);
                        
                        if (safeContext === 'gestao_combustivel' || safeContext === 'abastecimento') {
                            UIRenderer.abrirModal('gestaoCombustivel');
                        } else {
                            UIRenderer.fecharModal();
                        }
                    };

                    if (btnX) btnX.onclick = acaoVoltar;
                    if (btnCancel) btnCancel.onclick = acaoVoltar;
                    // ==============================================================

                    document.getElementById('btn-salvar-transacao-avulsa').onclick = (e) => {
                        e.preventDefault(); 
                        EventHandlers.handleSalvarTransacaoAvulsa();
                    };

                    inputTotal.addEventListener('input', (e) => Utils.mascaraMoeda(e.target));
                    inputVal1.addEventListener('input', (e) => Utils.mascaraMoeda(e.target));

                    const atualizarInfoParcela = () => {
                        const total = Utils.parseMoeda(inputTotal.value);
                        const qtd = parseInt(inputParcelas.value) || 1;
                        if (total > 0 && qtd > 1) {
                            const valorParc = total / qtd;
                            infoParcela.textContent = `(${Utils.formatarMoeda(valorParc)}/m√™s)`;
                            infoParcela.classList.remove('hidden');
                        } else {
                            infoParcela.textContent = '';
                            infoParcela.classList.add('hidden');
                        }
                    };

                    chkMisto.addEventListener('change', () => {
                        boxUnico.classList.toggle('hidden', chkMisto.checked);
                        boxMisto.classList.toggle('hidden', !chkMisto.checked);
                        if (chkMisto.checked) {
                            inputVal1.value = inputTotal.value;
                            inputVal2.value = '0,00';
                            if (defaultContaId) {
                                if ([...c1.options].some(o => o.value === defaultContaId)) {
                                    c1.value = defaultContaId;
                                }
                                c2.selectedIndex = 0; 
                            }
                        }
                        checkCredito();
                    });

                    inputVal1.addEventListener('input', () => {
                        const total = Utils.parseMoeda(inputTotal.value);
                        const v1 = Utils.parseMoeda(inputVal1.value);
                        const resto = Math.max(0, total - v1);
                        inputVal2.value = Utils.formatarMoedaParaInput(resto);
                    });

                    const checkCredito = () => {
                        let isCredito = false;
                        if (chkMisto.checked) {
                            const opt1 = c1.options[c1.selectedIndex];
                            const opt2 = c2.options[c2.selectedIndex];
                            if ((opt1 && opt1.getAttribute('data-credito') === 'true') || 
                                (opt2 && opt2.getAttribute('data-credito') === 'true')) {
                                isCredito = true;
                            }
                        } else {
                            const opt = selConta.options[selConta.selectedIndex];
                            if (opt && opt.getAttribute('data-credito') === 'true') isCredito = true;
                        }

                        const deveMostrar = isCredito && selTipo.value === 'saida';
                        divParcelas.classList.toggle('hidden', !deveMostrar);
                        if (deveMostrar) {
                            atualizarInfoParcela();
                        } else {
                            inputParcelas.value = 1;
                            infoParcela.textContent = '';
                            infoParcela.classList.add('hidden');
                        }
                    };

                    inputTotal.addEventListener('input', () => {
                        if(chkMisto.checked) inputVal1.value = inputTotal.value;
                        atualizarInfoParcela();
                    });
                    inputParcelas.addEventListener('input', atualizarInfoParcela);

                    selConta.addEventListener('change', checkCredito);
                    c1.addEventListener('change', checkCredito);
                    c2.addEventListener('change', checkCredito);
                    selTipo.addEventListener('change', checkCredito);

                    if(defaultTipo) selTipo.value = defaultTipo;
                    
                    if(defaultContaId && [...selConta.options].some(o => o.value === defaultContaId)) {
                        selConta.value = defaultContaId;
                    }
                    
                    checkCredito();
                }, 100);
                break;
            }



 */
     // 3. FINALIZAR SERVI√áO (Com Recibo)
                case 'finalizarServico': {
                    const kmInicialPrioritario = options.item.kmInicialServico || BusinessLogic.getUltimoKmRegistrado();
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-xl space-y-4">
                            <h3 class="text-lg font-bold text-white">${options.titulo}</h3>
                            ${ options.isServicoRapido ? `
                                <p class="text-sm text-slate-400">Servi√ßo: <b class="text-white">${options.item.descricao || 'Servi√ßo R√°pido'}</b></p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Valor L√≠quido</label><input type="text" inputmode="decimal" id="editValor" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                    <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Valor Bruto</label><input type="text" inputmode="decimal" id="editValorBruto" placeholder="Opcional" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                </div>
                                <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Descri√ß√£o</label><input type="text" id="editDescricao" value="${options.item.descricao || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Categoria</label><select id="editCategoria" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"><option value="Corrida" ${options.item.categoria === 'Corrida' ? 'selected' : ''}>Corrida</option><option value="Entrega" ${options.item.categoria === 'Entrega' ? 'selected' : ''}>Entrega</option><option value="Particular">Particular</option><option value="Outro" ${options.item.categoria === 'Outro' ? 'selected' : ''}>Outro</option></select></div>
                                    <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Subcategoria</label><select id="editSubcategoria" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"><option value="">Nenhuma</option></select></div>
                                </div>
                                <div id="containerViagemParticular" class="hidden space-y-4 pt-4 border-t border-slate-700">
                                    <h4 class="text-sm font-semibold text-center text-cyan-400">Detalhes da Viagem Particular</h4>
                                    <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Nome Cliente</label><input type="text" id="editNomeCliente" value="${options.item.nomeCliente || ''}" placeholder="Ex: Sra. Maria" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Pagamento</label><select id="editStatusPagamento" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"><option value="pago">Recebido</option><option value="pendente">Pendente</option></select></div>
                                        <div id="containerDataVencimento" class="hidden"><label class="block text-sm text-left font-medium text-slate-300 mb-1">Vencimento</label><input type="date" id="editDataVencimento" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white" style="color-scheme: dark;"></div>
                                    </div>
                                </div>
                            ` : `
                                <p class="text-sm text-slate-400">Servi√ßo: <b class="text-white">${Utils.formatarMoeda(options.item.valor)}</b></p>
                                <div><label class="block text-sm text-left font-medium text-slate-300 mb-1">Valor Bruto</label><input type="text" inputmode="decimal" id="editValorBruto" placeholder="Opcional" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                            `}
                            ${ AppState.configuracoes.usarGpsTracking ? `
                                <div><label class="block text-sm text-left text-slate-300">KM Inicial (GPS)</label><input type="number" id="inicialKmServico" value="${Math.round(options.item.kmInicialServico || 0)}" class="w-full bg-slate-600 border border-slate-600 rounded-lg p-3 text-white" disabled></div>
                                <div><label class="block text-sm text-left text-slate-300">KM Final (GPS)</label><input type="number" id="finalKmServico" value="${Math.round(AppState.gpsCurrentOdometer)}" class="w-full bg-slate-600 border border-slate-600 rounded-lg p-3 text-white" disabled></div>
                                <input type="checkbox" id="ignorarKmInicial" class="hidden" checked>` : `
                                <div><label class="block text-sm text-left text-slate-300">KM Inicial</label><input type="number" inputmode="numeric" id="inicialKmServico" value="${kmInicialPrioritario || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                <div class="flex items-center"><input type="checkbox" id="ignorarKmInicial" class="h-4 w-4 rounded bg-slate-700 text-cyan-600"><label for="ignorarKmInicial" class="ml-2 text-sm text-slate-400">Ignorar KM inicial</label></div>
                                <div><label class="block text-sm text-left text-slate-300">KM Final</label><input type="number" inputmode="numeric" id="finalKmServico" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                            `}
                            <div class="flex justify-end gap-4">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                                <button class="btn-salvar-finalizacao bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Finalizar</button>
                            </div>
                        </div>`;
                    AppState.itemParaEditarId = options.item.id;
                    break;
                }

                // 4. EDI√á√ÉO ATIVIDADE (Com Recibo)
                case 'edicaoAtividade': {
                    const valorFormatado = options.item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, useGrouping: false}).replace('.', ',');
                    const categorias = ['Corrida', 'Entrega', 'Outro', 'Particular'];
                    const categoriasOptions = categorias.map(c => `<option value="${c}" ${c === options.item.categoria ? 'selected' : ''}>${c}</option>`).join('');
                    
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md text-center shadow-xl space-y-4">
                            <h3 class="text-lg font-bold text-white">${options.titulo}</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm text-left text-slate-300">Valor L√≠quido</label><input type="text" inputmode="decimal" id="editValor" value="${valorFormatado}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                <div><label class="block text-sm text-left text-slate-300">Valor Bruto</label><input type="text" inputmode="decimal" id="editValorBruto" value="${options.item.valorBruto ? Utils.formatarMoedaParaInput(options.item.valorBruto) : ''}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm text-left text-slate-300">Categoria</label><select id="editCategoria" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white">${categoriasOptions}</select></div>
                                <div><label class="block text-sm text-left text-slate-300">Subcategoria</label><select id="editSubcategoria" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></select></div>
                            </div>
                            <div><label class="block text-sm text-left text-slate-300">Descri√ß√£o</label><input type="text" id="editDescricao" value="${options.item.descricao || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm text-left text-slate-300">KM Inicial</label><input type="number" id="editKmInicial" value="${options.item.kmInicialServico || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                                <div><label class="block text-sm text-left text-slate-300">KM Final</label><input type="number" id="editKmFinal" value="${options.item.kmFinalServico || ''}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white"></div>
                            </div>
                            <div class="hidden space-y-4 pt-4 border-t border-slate-700" id="edit-recibo-container">
                                <h4 class="text-sm font-semibold text-center text-cyan-400">Dados para Recibo</h4>
                                <input type="text" id="editNomeCliente" value="${options.item.nomeCliente || ''}" placeholder="Nome Cliente" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                            </div>
                            <div class="flex justify-between items-center gap-4">
                                <button class="btn-gerar-recibo-edicao bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition">Gerar Recibo</button>
                                <div class="flex gap-4">
                                    <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                                    <button class="btn-salvar-edicao-atividade bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition">Salvar</button>
                                </div>
                            </div>
                        </div>`;
                    AppState.itemParaEditarId = options.item.id;
                    break;
                }

                // 5. CRIAR CAIXINHA (SIMULADOR)
// --- 5. CRIAR CAIXINHA (SIMULADOR) - ESTILO RESTAURADO ---
                case 'criarCaixinhaAmortizacao': {
                    const { pvHoje, economia, parcelas, metaDividaId, i_anual } = options;
                    
                    // Salva o contexto COM a taxa de juros correta
                    AppState.modalContext = {
                        type: 'criarCaixinhaAmortizacao',
                        pvHoje: pvHoje,
                        economia: economia,
                        parcelas: parcelas,
                        metaDividaId: metaDividaId,
                        dataRef: new Date(), // Data base para proje√ß√£o
                        i_anual: i_anual || 0 // Mant√©m a taxa para o c√°lculo funcionar
                    };
    
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-lg shadow-xl space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-white">Criar Caixinha para Amortiza√ß√£o</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            
                            <p class="text-sm text-slate-400 bg-slate-900 p-3 rounded-md">
                                O valor para pagar esta amortiza√ß√£o <b class="text-white">hoje</b> √© <b class="text-cyan-400">${Utils.formatarMoeda(pvHoje)}</b>.
                                <br><span class="text-xs opacity-70">Se planeja pagar no futuro, o valor ser√° recalculado considerando o rendimento.</span>
                            </p>
    
                            <div>
                                <label for="meses-para-juntar" class="block text-sm font-medium text-slate-300 mb-1">Em quantos meses voc√™ deseja juntar este valor?</label>
                                <input type="number" id="meses-para-juntar" min="1" value="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white text-center text-lg font-bold focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                            </div>
    
                            <div id="calculo-valor-alvo-container" class="text-center p-3 bg-slate-700/50 rounded-lg space-y-1">
                                <span class="block text-sm text-slate-300">Valor Objetivo (daqui a <span id="display-meses">3</span> meses):</span>
                                <span id="novo-valor-alvo-display" class="block font-bold text-2xl text-cyan-300">${Utils.formatarMoeda(pvHoje)}</span>
                                <span class="block text-xs text-slate-400">(Juros Economizados na D√≠vida: <b class="text-cyan-400">${Utils.formatarMoeda(economia)}</b>)</span>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row justify-end gap-3 pt-3 border-t border-slate-700">
                                <button id="btn-voltar-simulacao" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition order-3 sm:order-1">Voltar</button>
                                
                                <button id="btn-pagar-agora-do-modal" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition order-2 sm:order-2"
                                    data-pv="${pvHoje}" data-economia="${economia}" data-parcelas="${parcelas}">
                                    Pagar ${Utils.formatarMoeda(pvHoje)} Agora
                                </button>
                                
                                <button id="btn-confirmar-criacao-caixinha" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition order-1 sm:order-3"
                                    data-pv-futuro="${pvHoje}" data-economia="${economia}" data-parcelas="${parcelas}" data-meses="3">
                                    Criar Caixinha (Valor Fixo)
                                </button>
                            </div>
                        </div>`;
                    break;
                }
                // 6. SELECIONAR FONTE DE PAGAMENTO (SIMULADOR)
// 6. SELECIONAR FONTE DE PAGAMENTO (AMORTIZA√á√ÉO COM RETROATIVO)
// 6. SELECIONAR FONTE DE PAGAMENTO (COM FEEDBACK VISUAL)
// 6. SELECIONAR FONTE DE PAGAMENTO (VALOR EDIT√ÅVEL E RETROATIVO)
                case 'selecionarFontePagamento': {
                    const { pv, economia, parcelas, dataRef } = options;
                    // Conta quantas parcelas est√£o sendo pagas (conta as v√≠rgulas + 1)
                    const qtdParcelas = parcelas ? String(parcelas).split(',').length : 0;
                    
                    let caixinhasDisponiveis = '';
                    const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                    
                    const fontes = [];
                    
                    // Bancos
                    contasBancarias.forEach(c => {
                        if (c.tipo !== 'credito') {
                            const saldo = BusinessLogic.calcularSaldoConta(c.id);
                            fontes.push({ id: c.id, nome: c.nome, tipo: 'Banco', saldo });
                        }
                    });
                    
                    // Caixinhas
                    metasFinanceiras.forEach(m => {
                        if (m.tipo === 'poupanca' || m.tipo === 'poupanca_km') {
                            const saldo = BusinessLogic.calcularSaldoConta(m.id);
                            fontes.push({ id: m.id, nome: m.descricao, tipo: 'Caixinha', saldo });
                        }
                    });
                    if (m.id === metaDividaId && m.valorProvisionado > 0) {
                             fontes.push({ 
                                 id: 'PROVISIONADO_PROPRIO', // ID Especial
                                 nome: `Saldo Acumulado na Caixinha`, 
                                 tipo: 'Provisionado', 
                                 saldo: m.valorProvisionado 
                             });
                        }
                        // Outras caixinhas
                        else if (m.tipo === 'poupanca' || m.tipo === 'poupanca_km') {
                            const saldo = BusinessLogic.calcularSaldoConta(m.id);
                            fontes.push({ id: m.id, nome: m.descricao, tipo: 'Caixinha', saldo });
                        }
                    // Carteira
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    fontes.push({ id: 'AUTO_ID_CARTEIRA', nome: 'Carteira (Dinheiro)', tipo: 'Caixa', saldo: saldoCarteira });

                    if (fontes.length > 0) {
                        fontes.sort((a, b) => b.saldo - a.saldo);
                        caixinhasDisponiveis = '<ul class="space-y-2 max-h-40 overflow-y-auto scrollable-content p-2 bg-slate-900 rounded-md">';
                        fontes.forEach(f => {
                            const corSaldo = f.saldo < pv ? 'text-red-400' : 'text-emerald-400';
                            caixinhasDisponiveis += `
                                <li>
                                    <label class="fonte-pagamento-item flex items-center justify-between p-3 bg-slate-700 rounded-md transition border border-slate-600 cursor-pointer hover:bg-slate-600">
                                        <div>
                                            <span class="font-bold text-white block text-sm">${f.nome}</span>
                                            <span class="text-xs text-slate-400">${f.tipo} (Saldo: <span class="${corSaldo}">${Utils.formatarMoeda(f.saldo)}</span>)</span>
                                        </div>
                                        <input type="radio" name="fontePagamento" value="${f.id}" class="h-5 w-5 text-cyan-600 bg-slate-800 border-slate-500 focus:ring-cyan-500">
                                    </label>
                                </li>`;
                        });
                        caixinhasDisponiveis += '</ul>';
                    } else {
                        caixinhasDisponiveis = `<div class="p-4 bg-red-900/20 border border-red-500/30 rounded-md text-center"><p class="text-red-300 text-sm font-bold">Nenhuma fonte dispon√≠vel</p></div>`;
                    }

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4 flex flex-col">
                            <div class="text-center border-b border-slate-700 pb-3">
                                <h3 class="text-lg font-bold text-white">Confirmar Amortiza√ß√£o</h3>
                                <p class="text-slate-400 text-xs mt-1">Antecipando <b>${qtdParcelas}</b> parcela(s)</p>
                            </div>
                            
                            <div class="bg-slate-900 p-3 rounded text-center">
                                <span class="text-xs text-slate-500 uppercase tracking-wider">Valor Real a Pagar</span>
                                <div class="relative mt-1 max-w-[200px] mx-auto">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">R$</span>
                                    <input type="text" inputmode="decimal" id="amort-valor-real" 
                                           class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 pl-8 text-emerald-400 text-2xl font-bold text-center focus:border-emerald-500 focus:outline-none"
                                           value="${Utils.formatarMoedaParaInput(pv)}">
                                </div>
                                <div class="text-xs text-slate-500 mt-2 italic">Edite se o valor do banco for diferente.</div>
                            </div>

                            <div class="space-y-2">
                                <p class="text-xs font-bold text-slate-300 ml-1">Debitar de:</p>
                                ${caixinhasDisponiveis}
                            </div>

                            <div class="bg-slate-700/30 p-3 rounded border border-slate-600/50">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="chk-amort-retroativo" class="rounded bg-slate-700 border-slate-500 text-cyan-500">
                                    <span class="text-xs text-slate-300 font-bold">Pagamento Retroativo?</span>
                                </label>
                                <div id="container-amort-retro" class="hidden mt-2 animate-fade-in">
                                    <label class="block text-[10px] text-slate-400 mb-1">Data do Pagamento</label>
                                    <input type="date" id="amort-data-retro" value="${dataRef || Utils.getDataInputHoje()}" class="w-full bg-slate-800 border border-slate-500 rounded p-2 text-white text-sm focus:border-cyan-500 outline-none">
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 pt-2">
                                <button id="btn-voltar-simulacao" class="bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-2 px-4 rounded-lg transition text-sm">Voltar</button>
                                <button class="btn-confirmar-pagamento-amortizacao bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-2 px-6 rounded-lg transition shadow-lg text-sm" 
                                    data-qtd="${qtdParcelas}"
                                    ${fontes.length === 0 ? 'disabled' : ''}>
                                    Confirmar Pagamento
                                </button>
                            </div>
                        </div>`;
                        
                    setTimeout(() => {
                        // Visual de Sele√ß√£o
                        const radios = document.querySelectorAll('input[name="fontePagamento"]');
                        radios.forEach(r => {
                            r.addEventListener('change', (e) => {
                                document.querySelectorAll('.fonte-pagamento-item').forEach(l => {
                                    l.classList.remove('border-cyan-500', 'bg-slate-600');
                                    l.classList.add('border-slate-600', 'bg-slate-700');
                                });
                                const label = e.target.closest('label');
                                if(label) {
                                    label.classList.remove('border-slate-600', 'bg-slate-700');
                                    label.classList.add('border-cyan-500', 'bg-slate-600');
                                }
                            });
                        });

                        // Visual Retroativo
                        const chk = document.getElementById('chk-amort-retroativo');
                        const box = document.getElementById('container-amort-retro');
                        if (chk && box) {
                            if (dataRef && dataRef !== Utils.getDataInputHoje()) {
                                chk.checked = true;
                                box.classList.remove('hidden');
                            }
                            chk.addEventListener('change', () => {
                                box.classList.toggle('hidden', !chk.checked);
                            });
                        }
                        
                        document.getElementById('btn-voltar-simulacao').addEventListener('click', () => {
                            const metaId = AppState.itemParaEditarId;
                            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                            if (meta) {
                                UIRenderer.abrirModal('amortizacaoFinanciamento', { meta: meta });
                                setTimeout(() => document.getElementById('btn-gerar-cronograma-modal')?.click(), 100);
                            } else {
                                UIRenderer.fecharModal();
                            }
                        });
                    }, 100);
                    break;
                }
// 7. SIMULADOR PRINCIPAL (CORRE√á√ÉO VISUAL DO TOTAL)
                case 'amortizacaoFinanciamento': {
                    const metaFin = options.meta;
                    const fin = metaFin.financiamento;
                    const hojeFin = Utils.getDataInputHoje();
                    
                    const parcelasPagas = fin.parcelasPagas || 0;
                    // CORRE√á√ÉO: Mostra o total original do contrato, sem somar as pagas novamente
                    const totalExibido = fin.totalParcelas; 

                    let taxaAnualParaSimulador = 0;
                    if (fin.taxaJurosAnual) {
                        taxaAnualParaSimulador = fin.taxaJurosAnual;
                    } else if (fin.taxaJurosMensal) {
                        taxaAnualParaSimulador = (Math.pow(1 + (fin.taxaJurosMensal / 100), 12) - 1) * 100;
                    }

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-4xl shadow-xl" style="max-height: 90vh; overflow-y: auto;">
                            <div class="flex justify-between items-center mb-4">
                                <button id="btn-configurar-retroativo" class="bg-slate-700 hover:bg-slate-600 text-slate-300 py-2 px-3 rounded-lg transition text-xs border border-slate-600" title="Registrar pagamentos anteriores">
                                    ‚öôÔ∏è Hist√≥rico
                                </button>
                                <h3 class="text-xl font-bold text-cyan-400">Simulador: ${metaFin.descricao}</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
                            </div>
                            
                            <div class="flex justify-between bg-slate-900 p-2 rounded px-4 mb-4 text-xs text-slate-400">
                                <span>J√° pagas: <b class="text-white">${parcelasPagas}</b></span>
                                <span>Total Contrato: <b class="text-white">${totalExibido}</b></span>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 p-3 bg-slate-900 rounded-lg">
                                <input type="hidden" id="simValorFinanciado" value="${fin.valorFinanciado}">
                                <input type="hidden" id="simTaxaAnual" value="${taxaAnualParaSimulador}">
                                <input type="hidden" id="simNTotal" value="${fin.totalParcelas}"> 
                                <input type="hidden" id="simParcelasPagas" value="${parcelasPagas}">
                                <input type="hidden" id="simValorParcelaOpt" value="${fin.valorParcela}">
                                <input type="hidden" id="simDataInicio" value="${fin.dataInicioFinanciamento}">
                                <input type="hidden" id="simMethod" value="${fin.metodoAmortizacao}">
                                <input type="hidden" id="simMetaId" value="${metaFin.id}">

                                <div>
                                    <label for="simDataRef" class="block text-xs font-medium text-slate-400 mb-1">Data de Refer√™ncia</label>
                                    <input type="date" id="simDataRef" value="${hojeFin}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none transition h-[42px]" style="color-scheme: dark;">
                                </div>
                                <div>
                                    <label for="simModoAmort" class="block text-xs font-medium text-slate-400 mb-1">Op√ß√£o de Amortiza√ß√£o</label>
                                    <select id="simModoAmort" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none transition h-[42px]">
                                        <option value="reduzirPrazo">Reduzir prazo (manter parcela)</option>
                                        <option value="reduzirParcela">Reduzir parcela (manter prazo)</option>
                                    </select>
                                </div>
                                <div class="sm:col-span-2 flex items-end">
                                    <button id="btn-gerar-cronograma-modal" class="w-full bg-gradient-to-r from-cyan-600 to-cyan-700 hover:from-cyan-700 hover:to-cyan-800 text-white font-bold py-2 px-4 rounded-lg transition highlight">
                                        Carregar Pr√≥ximas Parcelas
                                    </button>
                                </div>
                            </div>

                            <div id="simInfo" class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center my-3 hidden">
                                <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-slate-400 uppercase tracking-wider mb-1">Pagas</span><span id="simPaidCount" class="block font-bold text-2xl text-white">0</span></div>
                                <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-slate-400 uppercase tracking-wider mb-1">Restam</span><span id="simRemainCount" class="block font-bold text-2xl text-white">0</span></div>
                                <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-slate-400 uppercase tracking-wider mb-1">Saldo Devedor</span><span id="simSaldoAtual" class="block font-bold text-xl text-amber-400">R$ 0,00</span></div>
                                <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-slate-400 uppercase tracking-wider mb-1">Juros Futuros</span><span id="simJurosRest" class="block font-bold text-xl text-red-400">R$ 0,00</span></div>
                            </div>

                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <p class="text-sm text-slate-300 font-medium mb-2">Pr√≥ximas Parcelas (marque para pagar):</p>
                                    <div id="listaParcelasModal" class="parcelas-list-modal scrollable-content">
                                        <p class="text-center text-slate-500 italic p-4">Clique em "Carregar" para ver.</p>
                                    </div>
                                </div>

                                <div class="md:col-span-1">
                                    <div id="resultadoSimModal" class="result-block-modal hidden space-y-4 bg-slate-700/30 p-4 rounded-lg border border-slate-600">
                                        <div><div class="text-xs text-slate-400 uppercase tracking-wider">Pagar Hoje (PV)</div><div id="simPvVal" class="font-bold text-3xl text-white mt-1">R$ 0,00</div></div>
                                        <div><div class="text-xs text-slate-400 uppercase tracking-wider">Economia Juros</div><div id="simEconomiaVal" class="font-bold text-xl text-green-400 mt-1">R$ 0,00</div></div>
                                        <div class="grid grid-cols-2 gap-2 border-t border-slate-600/50 pt-3">
                                            <div><div class="text-[10px] text-slate-400 uppercase">Novo Saldo</div><div id="simNovoSaldo" class="font-bold text-sm text-white">R$ 0,00</div></div>
                                            <div><div class="text-[10px] text-slate-400 uppercase">Novo Cen√°rio</div><div id="simNovoPlano" class="font-bold text-sm text-cyan-300">-</div></div>
                                        </div>
                                        <div id="containerBotoesSimulador" class="space-y-3 pt-2">
                                            <button id="btn-criar-meta-amortizacao" class="w-full bg-gradient-to-r from-violet-600 to-violet-700 hover:from-violet-700 hover:to-violet-800 text-white font-bold py-3 px-4 rounded-lg transition highlight shadow-lg">Criar "Caixinha" para Juntar</button>
                                        </div>
                                    </div>
                                    <div id="resultadoSimVazio" class="text-center text-slate-500 italic p-6 bg-slate-800 rounded-lg border border-slate-700 border-dashed">Selecione parcelas na lista.</div>
                                </div>
                            </div>
                        </div>`;
                        
                    AppState.itemParaEditarId = metaFin.id; 
                    break;
                }
// 7. SIMULADOR PRINCIPAL (CORRE√á√ÉO VISUAL DO TOTAL)

// MODAL: GEST√ÉO DE PROMO√á√ïES (COM FILTRO AUTOM√ÅTICO E BOT√ÉO DE HIST√ìRICO)
case 'gestaoPromocoes': {
    const hojeStr = Utils.formatarDataParaChave(new Date());

    // Separa o joio do trigo
    const ativas = [];
    const historico = [];

    (AppState.promocoesAtivas || []).forEach(p => {
        // Crit√©rio de Hist√≥rico: J√° Conclu√≠da OU Data de Fim j√° passou
        const venceu = p.dataFim < hojeStr;
        const concluiu = p.status === 'concluida';

        if (venceu || concluiu) {
            historico.push(p);
        } else {
            ativas.push(p);
        }
    });

    const listaPromos = ativas.map(p => {
        const fases = p.regras.fases || [];
        let infoProgresso = '';
        let porcentagem = 0;
        let metaAtual = p.regras.metaQtd;

        // L√≥gica Visual
        if (p.tipo === 'escalonada' && fases.length > 0) {
            let idx = 0;
            for(let i=0; i<fases.length; i++) {
                if(p.progresso.qtdAtual < fases[i].qtd) { idx = i; break; }
                idx = i;
            }
            const faseAtual = fases[idx];
            metaAtual = faseAtual.qtd; 
            const feito = p.progresso.qtdAtual;
            
            // Porcentagem Absoluta da Meta Atual
            porcentagem = Math.min(100, Math.round((feito / metaAtual) * 100));

            const faltam = Math.max(0, metaAtual - feito);
            infoProgresso = `
                <div class="flex justify-between text-[10px] mb-1 font-medium">
                    <span class="text-cyan-300">Pr√≥xima Meta: ${Utils.formatarMoeda(faseAtual.valor)}</span>
                    <span class="text-white">${feito}/${metaAtual} <span class="text-amber-400 font-bold">(-${faltam})</span></span>
                </div>
            `;
        }

        let dataFimFmt = '---';
        try { 
            const d = new Date(p.dataFim + 'T00:00:00'); 
            const hora = (p.horarios && p.horarios[0]) ? p.horarios[0].fim : '';
            dataFimFmt = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')} ${hora}`; 
        } catch (e) { }

        return `<li class="bg-slate-800 border-l-4 border-purple-500 p-3 rounded mb-2 shadow-lg relative overflow-hidden group transition hover:bg-slate-750">
            <div class="flex justify-between items-start mt-1">
                <div class="w-full pr-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-white text-sm truncate w-32" title="${p.titulo}">${p.titulo}</span>
                        <span class="text-[9px] bg-slate-700 px-1.5 py-0.5 rounded text-slate-300 uppercase tracking-wider font-bold">${p.app || 'App'}</span>
                    </div>
                    <div class="mt-1">
                        ${infoProgresso}
                        <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden shadow-inner">
                            <div class="bg-gradient-to-r from-cyan-500 to-purple-500 h-full rounded-full transition-all duration-700 ease-out" style="width: ${porcentagem}%"></div>
                        </div>
                    </div>
                    <div class="text-[10px] text-slate-500 mt-2 flex items-center gap-1">
                        <span>‚è∞ Vence em: ${dataFimFmt}</span>
                    </div>
                </div>
                <div class="text-right flex flex-col justify-between h-full pl-3 border-l border-slate-700/50 min-w-max flex-shrink-0">
                    <div class="text-[10px] text-slate-400 uppercase">J√° Ganho</div>
                    <span class="font-bold text-green-400 text-base whitespace-nowrap">+${Utils.formatarMoeda(p.progresso.valorPago || 0)}</span>
                    
                    <div class="flex flex-col gap-1 mt-2">
                        <button class="btn-editar-promo text-cyan-400 hover:text-white transition-colors text-[10px] font-bold uppercase tracking-wide border border-cyan-400/30 px-2 py-0.5 rounded" data-id="${p.id}">
                            Editar
                        </button>
                    </div>
                </div>
            </div>
        </li>`;
    }).join('');

    // Badge de notifica√ß√£o no bot√£o de hist√≥rico
    const badgeHistorico = historico.length > 0 
        ? `<span class="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full ml-2">${historico.length}</span>` 
        : '';

    modalHTML = `
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4" style="max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center sticky top-0 bg-slate-800 pb-2 border-b border-slate-700 z-10">
                 <h3 class="text-xl font-bold text-purple-400">Campanhas Ativas</h3>
                 <button id="btn-abrir-historico-promos" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-200 py-1.5 px-3 rounded flex items-center transition border border-slate-600">
                    üìú Hist√≥rico ${badgeHistorico}
                 </button>
            </div>
            
            <input type="hidden" id="promo-id">
            
            <div class="bg-slate-900/50 rounded-lg p-2 border border-slate-700/50 min-h-[100px]">
                <ul class="space-y-2 max-h-60 overflow-y-auto scrollable-content p-1">
                    ${listaPromos || '<li class="text-center text-slate-500 text-xs py-8 flex flex-col items-center"><span class="text-2xl opacity-20 mb-2">üéØ</span>Nenhuma campanha ativa hoje.<br>Verifique o hist√≥rico.</li>'}
                </ul>
            </div>
            
            <div class="border-t border-slate-700 pt-4 space-y-3">
                <div class="flex justify-between items-center">
                    <h4 class="text-sm font-bold text-white" id="titulo-form-promo">Nova Campanha</h4>
                    <button id="btn-limpar-form-promo" class="text-[10px] text-slate-400 underline hidden">Limpar / Nova</button>
                </div>
                
                <div class="grid grid-cols-4 gap-2 h-32">
                    <label class="col-span-1 flex flex-col items-center justify-center border border-dashed border-slate-500 rounded-lg cursor-pointer hover:bg-slate-700/50 transition bg-slate-800">
                        <span class="text-xl">üì∑</span>
                        <span class="text-[9px] text-slate-400 mt-1">Print</span>
                        <input type="file" id="input-print-promo" class="hidden" accept="image/*">
                    </label>
                    <div class="col-span-3 relative flex flex-col gap-1">
                        <textarea id="input-texto-promo" class="w-full h-1/2 bg-slate-800 border border-slate-600 rounded-lg p-2 text-white text-[10px] resize-none focus:ring-1 focus:ring-purple-500 placeholder:text-slate-600" placeholder="Cole o texto aqui..."></textarea>
                        <textarea id="input-debug-ocr" readonly class="w-full h-1/2 bg-black border border-slate-700 rounded-lg p-2 text-green-400 font-mono text-[9px] resize-none" placeholder="OCR output..."></textarea>
                        <button id="btn-processar-texto" class="absolute top-1 right-1 bg-purple-600 hover:bg-purple-500 text-white text-[9px] px-2 py-1 rounded shadow transition">Ler</button>
                    </div>
                </div>

                <hr class="border-slate-700/50">
                <input type="text" id="promo-titulo" placeholder="T√≠tulo (ex: Uber Quest)" class="w-full bg-slate-700 rounded p-2 text-white text-sm">
                
               <div class="grid grid-cols-2 gap-2">
    <select id="promo-app" class="w-full bg-slate-700 rounded p-2 text-white text-sm h-[38px]">
        <option value="Uber">Uber</option>
        <option value="99">99</option>
        <option value="Lalamove">Lalamove</option>
        <option value="Indriver">Indriver</option>
        <option value="Box Delivery">Box Delivery</option>
        <option value="Ifood">Ifood</option>
        <option value="Outro">Outro</option>
    </select>
    <div class="flex items-center gap-2 bg-slate-900/30 px-2 rounded">
        <input type="checkbox" id="promo-repetir-diariamente" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-purple-600">
        <label for="promo-repetir-diariamente" class="text-[10px] text-slate-300 leading-tight">Meta Di√°ria?</label>
    </div>
</div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] text-slate-400 block mb-1">In√≠cio</label><input type="date" id="promo-data-inicio" class="w-full bg-slate-700 rounded p-2 text-white text-xs h-[38px]"></div>
                    <div><label class="text-[10px] text-slate-400 block mb-1">Fim</label><input type="date" id="promo-data-fim" class="w-full bg-slate-700 rounded p-2 text-white text-xs h-[38px]"></div>
                </div>
                
                <div id="container-horarios-repeticao" class="grid grid-cols-2 gap-2 hidden">
                    <input type="time" id="promo-hora-inicio" value="04:00" class="bg-slate-700 rounded p-2 text-white text-xs">
                    <input type="time" id="promo-hora-fim" value="04:00" class="bg-slate-700 rounded p-2 text-white text-xs">
                </div>

                <div class="text-xs text-slate-400 font-bold mt-2 flex justify-between items-end">
                    <span>Metas e Pr√™mios:</span>
                    <button id="btn-add-fase-manual" class="text-[10px] text-cyan-400 hover:text-white underline">+ Adicionar Fase</button>
                </div>
                
                <div id="container-fases-promo" class="space-y-1 mt-1"></div>
                
                <button id="btn-salvar-promo" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-lg mt-4">Salvar Campanha</button>
            </div>
            <button class="btn-cancelar w-full text-slate-400 text-sm hover:text-white transition py-2 bg-slate-900 rounded border border-slate-700 mt-2">Fechar Janela</button>
        </div>
    `;
    
    // (A parte do setTimeout para os listeners do formul√°rio continua a mesma, 
    // apenas adicione o listener para o novo bot√£o de hist√≥rico abaixo)
    
    setTimeout(() => {
        // ... (Seus listeners antigos de OCR, Salvar, etc) ...

        // NOVO LISTENER: ABRIR HIST√ìRICO
        const btnHist = document.getElementById('btn-abrir-historico-promos');
        if (btnHist) {
            btnHist.onclick = () => UIRenderer.abrirModal('historicoPromocoes');
        }

        // ... (Restante dos listeners de formul√°rio, OCR, fases...) ...
        // Importante manter os c√≥digos de addFaseInput, preencher, etc. aqui dentro.
        // Vou omitir aqui para economizar espa√ßo, mas voc√™ deve manter o bloco do setTimeout original
        // e adicionar apenas o listener do btnHist acima.

        // MANTENHA AQUI A L√ìGICA DE INICIALIZA√á√ÉO DO FORMUL√ÅRIO (addFaseInput, preencher, etc.)
        const addFaseInput = (qtd = '', valor = '') => {
            const container = document.getElementById('container-fases-promo');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-7 gap-2 items-center fase-row bg-slate-900/30 p-1 rounded border border-slate-700/50';
            div.innerHTML = `
                <div class="col-span-3 relative"><input type="number" value="${qtd}" class="input-fase-qtd w-full bg-slate-800 rounded p-2 text-white text-xs border border-slate-600 focus:border-cyan-500" placeholder="Total"><span class="absolute right-2 top-2 text-[8px] text-slate-500">QTD</span></div>
                <div class="col-span-3 relative"><input type="text" value="${valor}" class="input-fase-valor w-full bg-slate-800 rounded p-2 text-green-400 font-bold text-xs border border-slate-600 focus:border-green-500" placeholder="Pr√™mio"><span class="absolute right-2 top-2 text-[8px] text-slate-500">R$</span></div>
                <div class="col-span-1 text-center"><button class="btn-remove-fase text-slate-500 hover:text-red-500 font-bold text-lg leading-none transition">√ó</button></div>
            `;
            div.querySelector('.btn-remove-fase').addEventListener('click', () => div.remove());
            container.appendChild(div);
        };
        document.getElementById('btn-add-fase-manual').addEventListener('click', () => addFaseInput());
        const preencher = (dados) => {
             document.getElementById('promo-id').value = dados.id || '';
             document.getElementById('titulo-form-promo').textContent = dados.id ? 'Editar Campanha' : 'Nova Campanha';
             document.getElementById('btn-limpar-form-promo').classList.toggle('hidden', !dados.id);
             if(dados.app) document.getElementById('promo-app').value = dados.app;
             if(dados.dataInicio) document.getElementById('promo-data-inicio').value = dados.dataInicio;
             if(dados.dataFim) document.getElementById('promo-data-fim').value = dados.dataFim;
             const boxHoras = document.getElementById('container-horarios-repeticao');
             const chkRepetir = document.getElementById('promo-repetir-diariamente');
             if (dados.repetir || (dados.horaInicio && dados.horaInicio !== '00:00')) {
                 chkRepetir.checked = true; boxHoras.classList.remove('hidden');
                 if(dados.horaInicio) document.getElementById('promo-hora-inicio').value = dados.horaInicio;
                 if(dados.horaFim) document.getElementById('promo-hora-fim').value = dados.horaFim;
             } else {
                 chkRepetir.checked = false; boxHoras.classList.add('hidden');
             }
             const containerFases = document.getElementById('container-fases-promo');
             containerFases.innerHTML = '';
             if (dados.fases && dados.fases.length > 0) {
                 dados.fases.forEach(f => addFaseInput(f.qtd, Utils.formatarMoedaParaInput(f.valor)));
             } else { addFaseInput(); }
             document.getElementById('promo-titulo').value = dados.titulo || '';
        };
        const agoraISO = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0,10);
        preencher({ dataInicio: agoraISO, dataFim: agoraISO });
        document.getElementById('btn-limpar-form-promo').onclick = () => preencher({ dataInicio: agoraISO, dataFim: agoraISO });
        document.querySelectorAll('.btn-editar-promo').forEach(btn => {
             btn.addEventListener('click', () => {
                 const id = btn.dataset.id;
                 const promo = AppState.promocoesAtivas.find(p => p.id === id);
                 if (promo) {
                     const dadosParaEditar = {
                         id: promo.id, app: promo.app, titulo: promo.titulo,
                         dataInicio: promo.dataInicio, dataFim: promo.dataFim,
                         repetir: promo.repetirDiariamente,
                         horaInicio: (promo.horarios && promo.horarios[0]) ? promo.horarios[0].inicio : '',
                         horaFim: (promo.horarios && promo.horarios[0]) ? promo.horarios[0].fim : '',
                         fases: promo.regras.fases
                     };
                     preencher(dadosParaEditar);
                 }
             });
        });
        // (Outros listeners OCR e Repetir mantidos...)
        const chkRepetir = document.getElementById('promo-repetir-diariamente');
        const boxHoras = document.getElementById('container-horarios-repeticao');
        if(chkRepetir) chkRepetir.addEventListener('change', () => boxHoras.classList.toggle('hidden', !chkRepetir.checked));
        const btnTexto = document.getElementById('btn-processar-texto');
        if(btnTexto) btnTexto.addEventListener('click', () => { const txt = document.getElementById('input-texto-promo').value; if(txt) preencher(PromotionManager.extrairDadosDoTexto(txt)); });
        const inpFile = document.getElementById('input-print-promo');
        if(inpFile) {
            inpFile.addEventListener('change', (e) => {
                if(e.target.files[0]) {
                    PromotionManager.lerPrintPromocao(e.target.files[0], (dados, textoBruto) => {
                        UIRenderer.abrirModal('gestaoPromocoes'); 
                        setTimeout(() => {
                            document.getElementById('input-debug-ocr').value = textoBruto;
                            preencher(dados);
                        }, 200);
                    });
                }
            });
        }

    }, 100);
    break;
}
// MODAL: EXTRATO DE CAMPANHAS (NOVO)
case 'historicoPromocoes': {
    const hojeStr = Utils.formatarDataParaChave(new Date());
    const anoAtual = new Date().getFullYear();

    // 1. Filtragem de Dados (Passado e Conclu√≠do)
    const historico = (AppState.promocoesAtivas || []).filter(p => {
        return p.status === 'concluida' || p.dataFim < hojeStr;
    });

    // Ordena do mais recente para o mais antigo
    historico.sort((a, b) => new Date(b.dataFim) - new Date(a.dataFim));

    // 2. C√°lculos Financeiros
    let totalGanho = 0;
    let totalPerdido = 0; // Dinheiro deixado na mesa

    let listaHTML = '';

    if (historico.length === 0) {
        listaHTML = `<li class="text-center text-slate-500 italic py-8">Nenhuma campanha finalizada no hist√≥rico.</li>`;
    } else {
        listaHTML = historico.map(p => {
            const ganho = p.progresso.valorPago || 0;
            const objetivoTotal = p.valorObjetivo || p.regras.valorObjetivo || 0;
            const perdido = Math.max(0, objetivoTotal - ganho);
            
            totalGanho += ganho;
            totalPerdido += perdido;

            const statusClass = p.status === 'concluida' ? 'text-green-400' : 'text-slate-400';
            const statusIcon = p.status === 'concluida' ? 'üèÜ' : '‚è∞';
            const statusTexto = p.status === 'concluida' ? 'Conclu√≠da' : 'Expirada';
            
            // Cor da borda baseada no sucesso
            const borderClass = p.status === 'concluida' ? 'border-green-500/50' : (ganho > 0 ? 'border-amber-500/50' : 'border-slate-700');
            
            // Data formatada
            const dFim = new Date(p.dataFim + 'T12:00:00');
            const dataDisplay = `${dFim.getDate()}/${dFim.getMonth()+1}/${dFim.getFullYear()}`;

            return `
                <li class="bg-slate-800 p-3 rounded-lg border ${borderClass} flex justify-between items-center shadow-sm">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-lg">${statusIcon}</span>
                            <div>
                                <span class="font-bold text-white text-sm block leading-tight">${p.titulo}</span>
                                <span class="text-[10px] text-slate-500 uppercase tracking-wide">${p.app} ‚Ä¢ ${dataDisplay}</span>
                            </div>
                        </div>
                        <div class="text-xs text-slate-400 pl-8">
                            Meta: ${p.progresso.qtdAtual}/${p.regras.metaQtd}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-green-400 text-base">+${Utils.formatarMoeda(ganho)}</div>
                        ${perdido > 0 ? `<div class="text-[10px] text-red-400 font-medium">Perdido: ${Utils.formatarMoeda(perdido)}</div>` : '<div class="text-[10px] text-green-600 font-bold">100% Aproveitado</div>'}
                        
                        <button class="btn-excluir-promo text-[10px] text-slate-600 hover:text-red-400 underline mt-1" data-id="${p.id}">Limpar</button>
                    </div>
                </li>
            `;
        }).join('');
    }

    const aproveitamento = (totalGanho + totalPerdido) > 0 
        ? (totalGanho / (totalGanho + totalPerdido)) * 100 
        : 0;

    modalHTML = `
        <div class="bg-slate-900 rounded-lg p-6 w-full max-w-lg shadow-xl border border-slate-700 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">üìú Extrato de Campanhas</h3>
                    <span class="text-xs text-slate-400">Hist√≥rico de B√¥nus e Metas</span>
                </div>
                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <span class="text-xs text-slate-400 uppercase block mb-1">Total Ganho</span>
                    <span class="text-2xl font-bold text-green-400">${Utils.formatarMoeda(totalGanho)}</span>
                </div>
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <span class="text-xs text-slate-400 uppercase block mb-1">Deixado na Mesa</span>
                    <span class="text-2xl font-bold text-red-400">${Utils.formatarMoeda(totalPerdido)}</span>
                </div>
            </div>
            
            <div class="px-2 mb-4">
                <div class="flex justify-between text-xs text-slate-400 mb-1">
                    <span>Taxa de Aproveitamento</span>
                    <span class="${aproveitamento > 80 ? 'text-green-400' : 'text-amber-400'} font-bold">${aproveitamento.toFixed(1)}%</span>
                </div>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-red-500 to-green-500 transition-all duration-1000" style="width: ${aproveitamento}%"></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scrollable-content p-1 bg-slate-900/50 rounded-lg border border-slate-800">
                <ul class="space-y-2">
                    ${listaHTML}
                </ul>
            </div>

            <div class="pt-4 flex justify-end gap-3">
                <button id="btn-voltar-gestao-promo" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">Voltar</button>
            </div>
        </div>
    `;

    setTimeout(() => {
        // Bot√£o Voltar
        document.getElementById('btn-voltar-gestao-promo').onclick = () => {
            UIRenderer.abrirModal('gestaoPromocoes');
        };

        // Bot√µes de Excluir do Hist√≥rico
        document.querySelectorAll('.btn-excluir-promo').forEach(btn => {
            btn.onclick = (e) => {
                const id = e.target.dataset.id;
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Limpar Hist√≥rico?',
                    mensagem: 'Isso remover√° este registro do extrato de campanhas. Os ganhos financeiros (transa√ß√µes) n√£o ser√£o apagados.',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (confirmado) => {
                        if (confirmado) {
                            AppState.promocoesAtivas = AppState.promocoesAtivas.filter(p => p.id !== id);
                            Storage.salvarConfiguracoes();
                            UIRenderer.abrirModal('historicoPromocoes'); // Recarrega
                        }
                    }
                });
            };
        });
    }, 100);
    break;
}
         // 8. CONFIRMA√á√ÉO (Com bot√£o X)
                case 'confirmacao': {
                    const confirmLabel = options.confirmLabel || 'Confirmar';
                    const cancelLabel = options.cancelLabel || 'Cancelar';
                    const confirmClass = options.confirmClass || 'bg-red-600 hover:bg-red-700';
                    let abortBtnHTML = '';
                    if (options.showAbort) abortBtnHTML = `<button class="btn-cancelar bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition mr-auto">X</button>`;

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm text-center shadow-xl">
                            <h3 class="text-lg font-bold text-white">${options.titulo}</h3>
                            <p class="text-slate-400 my-4">${options.mensagem}</p>
                            <div class="flex justify-end gap-4">
                                ${abortBtnHTML}
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">${cancelLabel}</button>
                                <button class="btn-confirmar ${confirmClass} text-white font-bold py-2 px-4 rounded-lg transition">${confirmLabel}</button>
                            </div>
                        </div>`;
                    AppState.onConfirmCallback = options.callback;
                    break;
                }

// 9. ALERTA (CORRIGIDO PARA SALVAR O RETORNO)
                case 'alerta':
                    // >>> ESTA LINHA √â O SEGREDO <<<
                    AppState.onAlertCallback = options.callback; 
                    
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm text-center shadow-xl border border-slate-700">
                            <h3 class="text-lg font-bold ${options.type === 'success' ? 'text-green-400' : 'text-amber-400'}">${options.titulo}</h3>
                            <p class="text-slate-300 my-4 text-sm">${options.mensagem}</p>
                            <div class="flex justify-center">
                                <button class="btn-ok bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg transition">OK</button>
                            </div>
                        </div>`;
                    break;

                // 10. EDI√á√ÉO CUSTO (Vari√°vel da Jornada)
                case 'edicaoCusto': {
                    const { item } = options;
                    const categoriasCusto = ['Alimenta√ß√£o', 'Ve√≠culo', 'Pessoal', 'Outro C. Vari√°vel'];
                    const optionsCategoria = categoriasCusto.map(c => `<option value="${c}" ${c === item.categoria ? 'selected' : ''}>${c}</option>`).join('');
                    modalHTML = `<div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4"><h3 class="text-xl font-bold text-cyan-400">Editar Custo</h3><div><label class="block text-xs text-slate-400">Descri√ß√£o</label><input type="text" id="edit-custo-descricao" value="${item.descricao}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-xs text-slate-400">Valor</label><input type="text" inputmode="decimal" id="edit-custo-valor" value="${Utils.formatarMoedaParaInput(item.valor)}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div><label class="block text-xs text-slate-400">Categoria</label><select id="edit-custo-categoria" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">${optionsCategoria}</select></div></div><div><label class="block text-xs text-slate-400">Subcategoria</label><input type="text" id="edit-custo-subcategoria" value="${item.subcategoria || ''}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div class="flex justify-end gap-4"><button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button><button id="btn-salvar-edicao-custo" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" data-id="${item.id}">Salvar</button></div></div>`;
                    break;
                }

                // 11. EDI√á√ÉO CUSTO FIXO
                case 'edicaoCustoFixo': {
                    const valorFormatado = options.item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2}).replace('.', ',');
                    const cats = ['Ve√≠culo', 'Administrativo', 'Impostos', 'Outro C. Fixo'];
                    const opts = cats.map(c => `<option value="${c}" ${c === options.item.categoria ? 'selected' : ''}>${c}</option>`).join('');
                    modalHTML = `<div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4"><h3 class="text-lg font-bold text-white">Editar Custo Fixo</h3><div><label class="block text-xs text-slate-400">Descri√ß√£o</label><input type="text" id="editDescricao" value="${options.item.descricao}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-slate-400">Valor</label><input type="text" id="editValor" value="${valorFormatado}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div><label class="block text-xs text-slate-400">Vencimento</label><input type="number" id="editVencimento" value="${options.item.vencimento}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-slate-400">Categoria</label><select id="editCategoriaCustoFixo" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">${opts}</select></div><div><label class="block text-xs text-slate-400">Subcategoria</label><input type="text" id="editSubcategoriaCustoFixo" value="${options.item.subcategoria||''}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div></div><div class="flex justify-end gap-4"><button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button><button class="btn-salvar-edicao-custo-fixo bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">Salvar</button></div></div>`;
                    AppState.itemParaEditarId = options.item.id;
                    break;
                }

                // 12. EDI√á√ÉO CONTA RECORRENTE
                case 'edicaoContaRecorrente': {
                    const valF = Utils.formatarMoedaParaInput(options.item.valor);
                    modalHTML = `<div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4"><h3 class="text-lg font-bold text-white">Editar Recorrente</h3><div><label class="block text-xs text-slate-400">Descri√ß√£o</label><input type="text" id="edit-recorrente-descricao" value="${options.item.descricao}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs text-slate-400">Valor</label><input type="text" id="edit-recorrente-valor" value="${valF}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div><label class="block text-xs text-slate-400">Vencimento</label><input type="number" id="edit-recorrente-vencimento" value="${options.item.vencimento}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div></div><div><label class="block text-xs text-slate-400">Categoria</label><select id="edit-recorrente-categoria" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"><option>Moradia</option><option>Transporte</option><option>Outras Despesas</option></select></div><div class="flex justify-end gap-4"><button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button><button class="btn-salvar-edicao-conta-recorrente bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">Salvar</button></div></div>`;
                    break;
                }

// 13. EDITAR CONTA BANC√ÅRIA (COM V√çNCULO DE PAGAMENTO)
                case 'editarConta':
                case 'formConta': {
                    const { conta } = options;
                    
                    // 1. Prepara √≠cones
                    const iconOptions = [{v:'default',t:'Gen√©rico'},{v:'nubank',t:'Nubank'},{v:'inter',t:'Inter'},{v:'itau',t:'Ita√∫'},{v:'bradesco',t:'Bradesco'},{v:'bb',t:'BB'},{v:'caixa',t:'Caixa'},{v:'credito',t:'Cart√£o'}]
                        .map(o => `<option value="${o.v}" ${o.v===conta.icone?'selected':''}>${o.t}</option>`).join('');

                    // 2. Prepara lista de Bancos para V√≠nculo (Exclui cart√µes para evitar ciclo)
                    const bancosDisponiveis = AppState.configuracoes.contasBancarias.filter(c => c.tipo !== 'credito');
                    let optionsBancos = `<option value="">-- Nenhum (Manter na Carteira) --</option>`;
                    bancosDisponiveis.forEach(b => {
                        const selected = conta.contaVinculadaId === b.id ? 'selected' : '';
                        optionsBancos += `<option value="${b.id}" ${selected}>${b.nome}</option>`;
                    });
                    
                    modalHTML = `
                    <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                        <h3 class="text-xl font-bold text-cyan-400">Editar Conta</h3>
                        
                        <div>
                            <label class="block text-xs text-slate-400">Nome</label>
                            <input type="text" id="edit-conta-nome" value="${conta.nome}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400">Tipo</label>
                            <select id="edit-conta-tipo" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">
                                <option value="corrente" ${conta.tipo==='corrente'?'selected':''}>Corrente</option>
                                <option value="poupanca" ${conta.tipo==='poupanca'?'selected':''}>Poupan√ßa</option>
                                <option value="credito" ${conta.tipo==='credito'?'selected':''}>Cr√©dito</option>
                                <option value="carteira" ${conta.tipo==='carteira'?'selected':''}>Carteira</option>
                            </select>
                        </div>

                        <div id="container-campos-credito-edit" class="${conta.tipo==='credito'?'':'hidden'} space-y-3 border-l-2 border-slate-600 pl-3 ml-1">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-400">Limite</label>
                                    <input type="text" id="edit-conta-limite-cartao" value="${Utils.formatarMoedaParaInput(conta.limite||0)}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400">Dia Venc.</label>
                                    <input type="number" id="edit-conta-dia-vencimento" value="${conta.diaVencimento||''}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white">
                                </div>
                            </div>

                            <div id="container-vinculo-banco">
                                <label class="block text-xs font-medium text-emerald-400 mb-1">üè¶ Banco de Pagamento (V√≠nculo)</label>
                                <p class="text-[9px] text-slate-500 mb-1 leading-tight">O dinheiro reservado para a fatura ser√° enviado automaticamente para este banco.</p>
                                <select id="edit-conta-vinculada" class="w-full bg-slate-900 border border-emerald-500/30 rounded p-2 text-white text-sm focus:ring-1 focus:ring-emerald-500">
                                    ${optionsBancos}
                                </select>
                            </div>
                        </div>

                        <div>
                            <label id="label-saldo-edit" class="block text-xs text-slate-400">
                                ${conta.tipo==='credito' ? 'Fatura Atual (D√≠vida)' : 'Saldo Atual'}
                            </label>
                            <input type="number" step="0.01" id="edit-conta-saldo-atual" 
                                value="${conta.tipo==='credito' ? Math.abs(conta.saldo||0) : (conta.saldo||0)}" 
                                class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white font-mono">
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400">√çcone</label>
                            <select id="edit-conta-icone" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">${iconOptions}</select>
                        </div>

                        <div class="pt-3 border-t border-slate-700">
                            <label class="block text-xs text-slate-400">URL √çcone</label>
                            <input type="text" id="edit-conta-icone-url" value="${conta.icone && conta.icone.startsWith('http') ? conta.icone : ''}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white">
                        </div>

                        <div class="flex justify-end gap-4">
                            <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                            <button class="btn-salvar-edicao-conta bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" data-id="${conta.id}">Salvar</button>
                        </div>
                    </div>`;

                    setTimeout(() => {
                        const ts = document.getElementById('edit-conta-tipo');
                        const labelSaldo = document.getElementById('label-saldo-edit');
                        const containerCredito = document.getElementById('container-campos-credito-edit');

                        if(ts) {
                            ts.addEventListener('change', () => {
                                const isCredito = ts.value === 'credito';
                                if(containerCredito) containerCredito.classList.toggle('hidden', !isCredito);
                                if(labelSaldo) labelSaldo.textContent = isCredito ? 'Fatura Atual (D√≠vida)' : 'Saldo Atual';
                            });
                        }
                    }, 0);
                    break;
                }
                
   // =================================================================
            // 21. EXTRATO CONTA (V159: FINAL - DETEC√á√ÉO INTELIGENTE DE CR√âDITO)
            // =================================================================
            case 'extratoConta': {
                // 1. RECUPERA√á√ÉO DE DADOS BLINDADA
                let contaId = options.contaId || 'AUTO_ID_CARTEIRA';
                let contaNome = options.contaNome || 'Conta';
                let mostrarAjustesInternos = true;
                
                // 2. DETEC√á√ÉO REAL DO TIPO (Consulta a Configura√ß√£o)
                // Isso resolve o problema de n√£o saber se √© cart√£o
                const contaConfig = AppState.configuracoes.contasBancarias.find(c => c.id === contaId) ||
                                    AppState.configuracoes.contasBancarias.find(c => c.id === contaId.replace('FATURA_', ''));

                const isFatura = String(contaId).startsWith('FATURA_') || (contaConfig && contaConfig.tipo === 'credito');

                // Se for cart√£o e o ID veio "pelado" (sem FATURA_), adiciona o prefixo para padronizar
                if (isFatura && !String(contaId).startsWith('FATURA_')) {
                    contaId = 'FATURA_' + contaId;
                }
                
                // Pega nome correto se dispon√≠vel
                if (contaConfig) contaNome = contaConfig.nome;

                const saldoFinalExterno = options.saldoFinal; 

                // Define padr√£o datas
                const hoje = new Date();
                const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const defaultInicio = Utils.formatarDataParaChave(primeiroDia);
                const defaultFim = Utils.formatarDataParaChave(hoje);

                const renderExtrato = () => {
                    const elLista = document.getElementById('lista-extrato-filtrada');
                    const elSaldo = document.getElementById('extrato-saldo-atual');
                    const elEntradas = document.getElementById('extrato-entradas');
                    const elSaidas = document.getElementById('extrato-saidas');
                    const elAjustes = document.getElementById('extrato-estornos');

                    // Captura Inputs
                    const valInicio = document.getElementById('extrato-data-inicio').value;
                    const valFim = document.getElementById('extrato-data-fim').value;

                    if (!valInicio || !valFim) return;

                    const [anoIni, mesIni, diaIni] = valInicio.split('-').map(Number);
                    const [anoFim, mesFim, diaFim] = valFim.split('-').map(Number);
                    const rangeInicio = Utils.resolverPeriodo({ tipo: 'dia', ano: anoIni, mes: mesIni - 1, dia: diaIni });
                    const rangeFim = Utils.resolverPeriodo({ tipo: 'dia', ano: anoFim, mes: mesFim - 1, dia: diaFim });
                    const tsInicio = rangeInicio.inicio.getTime();
                    const tsFim = rangeFim.fim.getTime();

                    // ID PURO PARA COMPARA√á√ÉO (Remove FATURA_ para bater com o banco de dados)
                    const idBuscaPuro = String(contaId).replace('FATURA_', '');

                    // 3. FILTRAGEM (Usando l√≥gica V36.5 de ID Matching)
                    let transacoesFiltradas = AppState.historicoTransacoes.filter(t => {
                        try {
                            if (!t || t.invalida) return false;

                            // --- A. L√ìGICA DE PERTENCIMENTO (Sua l√≥gica atual) ---
                            const tOrigem = (typeof t.contaId === 'string') ? t.contaId : (t.conta?.id);
                            const tDestino = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id);
                            const tOrigemPuro = String(tOrigem).replace('FATURA_', '');
                            const tDestinoPuro = String(tDestino).replace('FATURA_', '');
                            const idBuscaPuro = String(contaId).replace('FATURA_', '');

                            let pertence = (tOrigemPuro === idBuscaPuro || tDestinoPuro === idBuscaPuro);
                            if (!pertence) return false;

                            // --- B. FILTRO DE DATA ---
                            const dataRef = t.dataEconomica || t.data;
                            const noPeriodo = dataRef >= tsInicio && dataRef <= tsFim;
                            if (!noPeriodo) return false;

                            // --- C. üõ°Ô∏è FILTRO DE AJUSTES (A NOVIDADE) ---
                            const ehAjuste = t.isAjusteInterno === true || t.categoria === 'Ajuste' || t.categoria === 'Estorno';
                            
                            // Se for um ajuste e o usu√°rio marcou para ocultar, barramos aqui
                            if (ehAjuste && !mostrarAjustesInternos) return false;

                            return true;

                        } catch (e) { return false; }
                    });

                    transacoesFiltradas.sort((a, b) => (b.dataEconomica || b.data) - (a.dataEconomica || a.data));

                    let entradas = 0; let saidas = 0; let ajustes = 0;

                    const listaHTML = transacoesFiltradas.map(t => {
                        const tDestino = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id);
                        const tDestinoPuro = String(tDestino).replace('FATURA_', '');
                        
                        // L√≥gica de Dire√ß√£o
                        const isEntradaNaConta = (tDestinoPuro === idBuscaPuro);
                        
                        const valor = Number(t.valor) || 0; 
                        let corTexto = ''; let sinal = '';

                        const isAjuste = t.categoria === 'Estorno' || t.categoria === 'Ajuste' || t.isAjusteInterno || String(t.descricao).includes('(Anulado)');

                        // L√≥gica Visual Espec√≠fica para Cart√£o
                        if (isFatura) {
                            if (isAjuste) {
                                ajustes += valor; corTexto = 'text-blue-400'; sinal = '';
                            }
                            else if (t.tipo === 'saida') { 
                                // Compra no Cart√£o -> Aumenta Fatura (Vermelho, mas SEM sinal de menos visualmente confuso)
                                saidas += valor; 
                                corTexto = 'text-rose-400'; 
                                sinal = ''; // Removemos o '-' para n√£o parecer estorno
                            } 
                            else if (t.tipo === 'entrada' || isEntradaNaConta) { 
                                // Pagamento da Fatura -> Diminui D√≠vida (Verde)
                                entradas += valor; 
                                corTexto = 'text-emerald-400'; 
                                sinal = '-'; 
                            }
                        } else {
                            // Conta Corrente Normal
                            if (isAjuste) {
                                ajustes += valor; corTexto = 'text-slate-400'; sinal = isEntradaNaConta ? '+' : '-';
                            }
                            else if (isEntradaNaConta || (t.tipo === 'entrada' && String(t.contaId).includes(idBuscaPuro))) {
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '+';
                            } else {
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '-';
                            }
                        }

                        const dataVisual = Utils.formatarDataParaDisplay(t.dataEconomica || t.data);
                        const hora = Utils.formatarHora(t.data); 

                        let badge = '';
                        if (isAjuste) badge = `<span class="ml-auto text-[9px] border border-blue-500/30 text-blue-400 px-1.5 py-0.5 rounded uppercase">Ajuste</span>`;
                        else if (t.jornadaId) badge = `<span class="ml-auto text-[9px] border border-slate-600 text-slate-500 px-1.5 py-0.5 rounded uppercase">Jornada</span>`;

                        return `
                            <li class="bg-slate-700/20 p-3 rounded-lg border border-slate-600/30 flex flex-col gap-1 ${isAjuste ? 'opacity-60' : ''}">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] text-slate-500 font-mono">${dataVisual} ${hora}</span>
                                        <span class="font-bold ${corTexto} text-sm">${sinal} ${Utils.formatarMoeda(valor)}</span>
                                    </div>
                                    ${badge}
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-slate-300 truncate pr-2">${t.descricao || t.categoria}</div>
                                    <button onclick="window.excluirTransacaoInteligente('${t.id}')" class="text-[10px] text-rose-500/50 hover:text-rose-400 font-bold uppercase tracking-wider">Excluir</button>
                                </div>
                            </li>`;
                    }).join('');

                    // 4. ATUALIZA SALDO (Com Corre√ß√£o V36.5)
                    // Aqui for√ßamos o ID correto para o calculador
                    let saldoDisplay = BusinessLogic.calcularSaldoConta(contaId);
                    
                    let corSaldo = saldoDisplay >= 0 ? 'text-white' : 'text-red-400';
                    let labelSaldo = 'SALDO ATUAL';

                    if (isFatura) {
                        corSaldo = 'text-white'; // Fatura √© sempre neutra ou vermelha, mas white fica melhor no dark mode
                        labelSaldo = 'FATURA ABERTA';
                    }

                    if (elSaldo) { 
                        // Atualiza Label
                        const labelEl = elSaldo.previousElementSibling;
                        if(labelEl) labelEl.textContent = labelSaldo;

                        elSaldo.className = `font-bold text-xl ${corSaldo}`; 
                        elSaldo.innerHTML = Utils.formatarMoeda(saldoDisplay); 
                    }
                    if (elEntradas) elEntradas.textContent = Utils.formatarMoeda(entradas);
                    if (elSaidas) elSaidas.textContent = Utils.formatarMoeda(saidas);
                    if (elAjustes) elAjustes.textContent = Utils.formatarMoeda(ajustes);
                    if (elLista) elLista.innerHTML = listaHTML || '<li class="text-center text-slate-500 py-8 text-xs">Nenhuma movimenta√ß√£o neste per√≠odo.</li>';
                };

                modalHTML = `
                    <div class="bg-slate-800 rounded-lg w-full max-w-lg shadow-xl flex flex-col max-h-[90vh]">
                        <div class="p-6 pb-2 flex-shrink-0 space-y-4 border-b border-slate-700/50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold ${isFatura ? 'text-purple-400' : 'text-cyan-400'}">Extrato</h3>
                                    <span class="text-sm text-slate-300 block">${contaNome}</span>
                                </div>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-3xl leading-none">√ó</button>
                            </div>
                            
                            <div class="flex gap-2 justify-center pb-1">
                                <button id="btn-periodo-atual" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] uppercase font-bold text-slate-300 py-2 rounded border border-slate-600 transition">M√™s Atual</button>
                                <button id="btn-periodo-anterior" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] uppercase font-bold text-slate-300 py-2 rounded border border-slate-600 transition">M√™s Anterior</button>
                                <button id="btn-periodo-hoje" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] uppercase font-bold text-slate-300 py-2 rounded border border-slate-600 transition">Hoje</button>
                            </div>
                            <div class="flex justify-center mb-2">
                                <button id="btn-toggle-ajustes" class="w-full text-[10px] py-1 px-3 rounded border border-blue-500/50 text-blue-400 hover:bg-blue-500/10 transition flex items-center justify-center gap-2">
                                    <span id="dot-ajustes" class="w-2 h-2 rounded-full bg-blue-500"></span>
                                    <span id="txt-ajustes">Exibindo Ajustes e Estornos</span>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-3 p-3 bg-slate-900 rounded-lg border border-slate-700">
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase font-bold">In√≠cio</label>
                                    <input type="date" id="extrato-data-inicio" value="${defaultInicio}" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-cyan-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase font-bold">Fim</label>
                                    <input type="date" id="extrato-data-fim" value="${defaultFim}" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-cyan-500 outline-none">
                                </div>
                                
                            </div>

                            <div class="p-3 bg-slate-700/30 border border-slate-600/50 rounded-md flex justify-between items-center">
                                <span class="font-bold text-slate-300 text-sm">SALDO ATUAL</span>
                                <span id="extrato-saldo-atual" class="font-bold text-xl text-white">...</span>
                            </div>
                            
                            <div id="extrato-resumo-periodo" class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-emerald-900/20 border border-emerald-500/30 p-2 rounded"><span class="block text-emerald-200/70 text-[10px] uppercase">${isFatura?'Pagamentos':'Entradas'}</span><span id="extrato-entradas" class="text-emerald-400 font-bold text-sm">...</span></div>
                                <div class="bg-rose-900/20 border border-rose-500/30 p-2 rounded"><span class="block text-rose-200/70 text-[10px] uppercase">${isFatura?'Novos Gastos':'Sa√≠das'}</span><span id="extrato-saidas" class="text-rose-400 font-bold text-sm">...</span></div>
                                <div class="bg-blue-900/20 border border-blue-500/30 p-2 rounded"><span class="block text-blue-200/70 text-[10px] uppercase">Ajustes</span><span id="extrato-estornos" class="text-blue-300 font-bold text-sm">...</span></div>
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 overflow-y-auto scrollable-content p-4 pt-2">
                            <ul id="lista-extrato-filtrada" class="space-y-2"></ul>
                        </div>
                        <div class="p-4 border-t border-slate-700 bg-slate-800 flex-shrink-0">
                            <button class="btn-cancelar w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">Fechar</button>
                        </div>
                    </div>`;

                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = modalHTML;
                    container.classList.remove('hidden');
                    
                    setTimeout(() => {
                        // 1. Defini√ß√£o de Per√≠odos
                        const definirPeriodo = (tipo) => {
                            const h = new Date();
                            let p;
                            if (tipo === 'atual') p = Utils.resolverPeriodo({ tipo: 'mes', ano: h.getFullYear(), mes: h.getMonth() });
                            if (tipo === 'anterior') p = Utils.resolverPeriodo({ tipo: 'mes', ano: h.getFullYear(), mes: h.getMonth() - 1 });
                            if (tipo === 'hoje') p = Utils.resolverPeriodo({ tipo: 'dia', ano: h.getFullYear(), mes: h.getMonth(), dia: h.getDate() });

                            if(p) {
                                document.getElementById('extrato-data-inicio').value = Utils.formatarDataParaChave(p.inicio);
                                document.getElementById('extrato-data-fim').value = Utils.formatarDataParaChave(p.fim);
                                renderExtrato();
                            }
                        };

                        // 2. üõ°Ô∏è EVENTO DO BOT√ÉO DE AJUSTES (NOVIDADE)
                        const btnFiltroAjustes = document.getElementById('btn-toggle-ajustes');
                        if (btnFiltroAjustes) {
                            btnFiltroAjustes.onclick = () => {
                                mostrarAjustesInternos = !mostrarAjustesInternos;
                                
                                // Atualiza o visual do bot√£o
                                const dot = document.getElementById('dot-ajustes');
                                const txt = document.getElementById('txt-ajustes');
                                
                                if (mostrarAjustesInternos) {
                                    dot.classList.replace('bg-slate-500', 'bg-blue-500');
                                    txt.textContent = 'Exibindo Ajustes e Estornos';
                                    btnFiltroAjustes.classList.add('border-blue-500/50');
                                    btnFiltroAjustes.classList.remove('border-slate-600');
                                } else {
                                    dot.classList.replace('bg-blue-500', 'bg-slate-500');
                                    txt.textContent = 'Ocultando Ajustes (Modo Limpo)';
                                    btnFiltroAjustes.classList.remove('border-blue-500/50');
                                    btnFiltroAjustes.classList.add('border-slate-600');
                                }
                                
                                renderExtrato(); // Re-executa o filtro
                            };
                        }

                        // 3. Renderiza√ß√£o Inicial e outros eventos
                        renderExtrato(); 

                        document.getElementById('extrato-data-inicio').onchange = renderExtrato;
                        document.getElementById('extrato-data-fim').onchange = renderExtrato;
                        document.getElementById('btn-periodo-atual').onclick = () => definirPeriodo('atual');
                        document.getElementById('btn-periodo-anterior').onclick = () => definirPeriodo('anterior');
                        document.getElementById('btn-periodo-hoje').onclick = () => definirPeriodo('hoje');

                        container.querySelectorAll('.btn-cancelar').forEach(b => b.onclick = () => UIRenderer.fecharModal());
                    }, 50);
                }
                break;
            }             
                
   /*             
                
// =================================================================
            // 21. EXTRATO CONTA (V158: COM CORRE√á√ÉO DE HOR√ÅRIO E ATALHOS)
            // =================================================================
            case 'extratoConta': {
                const contaId = options.contaId || 'AUTO_ID_CARTEIRA';
                const contaNome = options.contaNome || 'Conta';
                const saldoFinalExterno = options.saldoFinal; 
                const isFatura = String(contaId).startsWith('FATURA_');

                // Define padr√£o inicial: Do dia 1 do m√™s atual at√© hoje
                const hoje = new Date();
                const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                
                // Usamos o Utils para garantir o formato correto logo de cara
                const defaultInicio = Utils.formatarDataParaChave(primeiroDia);
                const defaultFim = Utils.formatarDataParaChave(hoje);

                const renderExtrato = () => {
                    const elLista = document.getElementById('lista-extrato-filtrada');
                    const elSaldo = document.getElementById('extrato-saldo-atual');
                    const elEntradas = document.getElementById('extrato-entradas');
                    const elSaidas = document.getElementById('extrato-saidas');
                    const elAjustes = document.getElementById('extrato-estornos');

                    // 1. CAPTURA DATAS DOS INPUTS
                    const valInicio = document.getElementById('extrato-data-inicio').value;
                    const valFim = document.getElementById('extrato-data-fim').value;

                    if (!valInicio || !valFim) return;

                    // 2. PREPARA√á√ÉO DO PER√çODO (A CORRE√á√ÉO DO SALDO ZERADO EST√Å AQUI!)
                    // Convertemos "2025-12-29" para n√∫meros
                    const [anoIni, mesIni, diaIni] = valInicio.split('-').map(Number);
                    const [anoFim, mesFim, diaFim] = valFim.split('-').map(Number);

                    // Usamos Utils.resolverPeriodo para pegar o COME√áO absoluto e o FIM absoluto
                    // Lembre-se: M√™s no JS come√ßa em 0, por isso subtra√≠mos 1
                    const rangeInicio = Utils.resolverPeriodo({ tipo: 'dia', ano: anoIni, mes: mesIni - 1, dia: diaIni });
                    const rangeFim = Utils.resolverPeriodo({ tipo: 'dia', ano: anoFim, mes: mesFim - 1, dia: diaFim });

                    // Timestamps para compara√ß√£o r√°pida
                    const tsInicio = rangeInicio.inicio.getTime();
                    const tsFim = rangeFim.fim.getTime(); // Este aqui agora √© 23:59:59.999!

                    // 3. FILTRAGEM
                    let transacoesFiltradas = AppState.historicoTransacoes.filter(t => {
                        try {
                            if (!t || t.invalida) return false;

                            // Verifica se a transa√ß√£o pertence a esta conta
                            const tContaId = (typeof t.contaId === 'string') ? t.contaId : (t.conta?.id);
                            const tDestinoId = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id);
                            
                            let pertence = false;
                            if (isFatura) {
                                if (tContaId === contaId || tDestinoId === contaId) pertence = true;
                            } else {
                                if (tContaId === contaId || tDestinoId === contaId) pertence = true;
                            }
                            if (!pertence) return false;

                            // FILTRO DE DATA CORRIGIDO
                            const dataRef = t.dataEconomica || t.data;
                            // Agora comparamos com o range expandido do Utils
                            return dataRef >= tsInicio && dataRef <= tsFim;

                        } catch (e) { return false; }
                    });

                    // Ordena: Recentes primeiro
                    transacoesFiltradas.sort((a, b) => (b.dataEconomica || b.data) - (a.dataEconomica || a.data));

                    // 4. C√ÅLCULO DOS TOTAIS
                    let entradas = 0; let saidas = 0; let ajustes = 0;

                    const listaHTML = transacoesFiltradas.map(t => {
                        const tDestinoId = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id);
                        const isEntradaNaConta = (tDestinoId === contaId) || (t.tipo === 'entrada' && t.contaId === contaId);
                        
                        // Garante que valor seja n√∫mero
                        const valor = Number(t.valor) || 0; 
                        
                        let corTexto = ''; let sinal = '';
                        const isAjuste = t.categoria === 'Estorno' || t.isAjusteInterno || String(t.descricao).includes('(Anulado)');

                        if (isAjuste) {
                            ajustes += valor; corTexto = 'text-slate-400'; sinal = isEntradaNaConta ? '+' : '-';
                        } 
                        else if (isFatura) {
                            if (t.tipo === 'entrada') { 
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '+';
                            } else if (isEntradaNaConta) { 
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '-'; 
                            }
                        } else {
                            if (isEntradaNaConta) {
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '+';
                            } else {
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '-';
                            }
                        }

                        const dataVisual = Utils.formatarDataParaDisplay(t.dataEconomica || t.data);
                        const hora = Utils.formatarHora(t.data); 

                        let badge = '';
                        if (isAjuste) badge = `<span class="ml-auto text-[9px] border border-slate-500/50 text-slate-400 px-1.5 py-0.5 rounded uppercase">Ajuste</span>`;
                        else if (t.jornadaId) badge = `<span class="ml-auto text-[9px] border border-slate-600 text-slate-500 px-1.5 py-0.5 rounded uppercase">Jornada</span>`;

                        return `
                            <li class="bg-slate-700/20 p-3 rounded-lg border border-slate-600/30 flex flex-col gap-1 ${isAjuste ? 'opacity-60' : ''}">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] text-slate-500 font-mono">${dataVisual} ${hora}</span>
                                        <span class="font-bold ${corTexto} text-sm">${sinal} ${Utils.formatarMoeda(valor)}</span>
                                    </div>
                                    ${badge}
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-slate-300 truncate pr-2">${t.descricao || t.categoria}</div>
                                    <button onclick="window.excluirTransacaoInteligente('${t.id}')" class="text-[10px] text-rose-500/50 hover:text-rose-400 font-bold uppercase tracking-wider">Excluir</button>
                                </div>
                            </li>`;
                    }).join('');

                    // 5. ATUALIZA A TELA
                    let saldoDisplay = (saldoFinalExterno !== undefined) ? saldoFinalExterno : BusinessLogic.calcularSaldoConta(contaId);
                    let corSaldo = saldoDisplay >= 0 ? 'text-white' : 'text-red-400';
                    if (isFatura) corSaldo = 'text-red-400';

                    if (elSaldo) { elSaldo.className = `font-bold text-xl ${corSaldo}`; elSaldo.innerHTML = Utils.formatarMoeda(saldoDisplay); }
                    if (elEntradas) elEntradas.textContent = Utils.formatarMoeda(entradas);
                    if (elSaidas) elSaidas.textContent = Utils.formatarMoeda(saidas);
                    if (elAjustes) elAjustes.textContent = Utils.formatarMoeda(ajustes);
                    if (elLista) elLista.innerHTML = listaHTML || '<li class="text-center text-slate-500 py-8 text-xs">Nenhuma movimenta√ß√£o neste per√≠odo.</li>';
                };

                // HTML ATUALIZADO: Com Bot√µes de Atalho acima dos Inputs
                modalHTML = `
                    <div class="bg-slate-800 rounded-lg w-full max-w-lg shadow-xl flex flex-col max-h-[90vh]">
                        <div class="p-6 pb-2 flex-shrink-0 space-y-4 border-b border-slate-700/50">
                            <div class="flex justify-between items-center">
                                <div><h3 class="text-xl font-bold text-cyan-400">Extrato</h3><span class="text-sm text-slate-300 block">${contaNome}</span></div>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-3xl leading-none">√ó</button>
                            </div>
                            
                            <div class="flex gap-2 justify-center pb-1">
                                <button id="btn-periodo-atual" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] uppercase font-bold text-slate-300 py-2 rounded border border-slate-600 transition">M√™s Atual</button>
                                <button id="btn-periodo-anterior" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] uppercase font-bold text-slate-300 py-2 rounded border border-slate-600 transition">M√™s Anterior</button>
                                <button id="btn-periodo-hoje" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] uppercase font-bold text-slate-300 py-2 rounded border border-slate-600 transition">Hoje</button>
                            </div>

                            <div class="grid grid-cols-2 gap-3 p-3 bg-slate-900 rounded-lg border border-slate-700">
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase font-bold">In√≠cio</label>
                                    <input type="date" id="extrato-data-inicio" value="${defaultInicio}" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-cyan-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase font-bold">Fim</label>
                                    <input type="date" id="extrato-data-fim" value="${defaultFim}" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-cyan-500 outline-none">
                                </div>
                            </div>

                            <div class="p-3 bg-slate-700/30 border border-slate-600/50 rounded-md flex justify-between items-center">
                                <span class="font-bold text-slate-300 text-sm">SALDO ATUAL</span>
                                <span id="extrato-saldo-atual" class="font-bold text-xl text-white">...</span>
                            </div>
                            
                            <div id="extrato-resumo-periodo" class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-emerald-900/20 border border-emerald-500/30 p-2 rounded"><span class="block text-emerald-200/70 text-[10px] uppercase">${isFatura?'Pagamentos':'Entradas'}</span><span id="extrato-entradas" class="text-emerald-400 font-bold text-sm">...</span></div>
                                <div class="bg-rose-900/20 border border-rose-500/30 p-2 rounded"><span class="block text-rose-200/70 text-[10px] uppercase">${isFatura?'Fatura':'Sa√≠das'}</span><span id="extrato-saidas" class="text-rose-400 font-bold text-sm">...</span></div>
                                <div class="bg-blue-900/20 border border-blue-500/30 p-2 rounded"><span class="block text-blue-200/70 text-[10px] uppercase">Ajustes</span><span id="extrato-estornos" class="text-blue-300 font-bold text-sm">...</span></div>
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 overflow-y-auto scrollable-content p-4 pt-2">
                            <ul id="lista-extrato-filtrada" class="space-y-2"></ul>
                        </div>
                        <div class="p-4 border-t border-slate-700 bg-slate-800 flex-shrink-0">
                            <button class="btn-cancelar w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">Fechar</button>
                        </div>
                    </div>`;

                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = modalHTML;
                    container.classList.remove('hidden');
                    
                    setTimeout(() => {
                        // Fun√ß√£o interna para os bot√µes de atalho usarem o Utils
                        const definirPeriodo = (tipo) => {
                            const h = new Date();
                            let p;
                            if (tipo === 'atual') p = Utils.resolverPeriodo({ tipo: 'mes', ano: h.getFullYear(), mes: h.getMonth() });
                            if (tipo === 'anterior') p = Utils.resolverPeriodo({ tipo: 'mes', ano: h.getFullYear(), mes: h.getMonth() - 1 });
                            if (tipo === 'hoje') p = Utils.resolverPeriodo({ tipo: 'dia', ano: h.getFullYear(), mes: h.getMonth(), dia: h.getDate() });

                            if(p) {
                                document.getElementById('extrato-data-inicio').value = Utils.formatarDataParaChave(p.inicio);
                                document.getElementById('extrato-data-fim').value = Utils.formatarDataParaChave(p.fim);
                                // Dispara o render automaticamente
                                renderExtrato();
                            }
                        };

                        renderExtrato(); // Renderiza inicial

                        // Listeners Manuais
                        document.getElementById('extrato-data-inicio').onchange = renderExtrato;
                        document.getElementById('extrato-data-fim').onchange = renderExtrato;
                        
                        // Listeners dos Atalhos
                        document.getElementById('btn-periodo-atual').onclick = () => definirPeriodo('atual');
                        document.getElementById('btn-periodo-anterior').onclick = () => definirPeriodo('anterior');
                        document.getElementById('btn-periodo-hoje').onclick = () => definirPeriodo('hoje');

                        container.querySelectorAll('.btn-cancelar').forEach(b => b.onclick = () => UIRenderer.fecharModal());
                    }, 50);
                }
                break;
            }

*/


 /*              
// =================================================================
            // 21. EXTRATO CONTA (V157: DATA RANGE + DATA ECON√îMICA)
            // =================================================================
            case 'extratoConta': {
                const contaId = options.contaId || 'AUTO_ID_CARTEIRA';
                const contaNome = options.contaNome || 'Conta';
                const saldoFinalExterno = options.saldoFinal; 
                const isFatura = String(contaId).startsWith('FATURA_');

                // Define padr√£o: Do dia 1 do m√™s atual at√© hoje
                const hoje = new Date();
                const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                
                const defaultInicio = primeiroDia.toISOString().split('T')[0];
                const defaultFim = hoje.toISOString().split('T')[0];

                const renderExtrato = () => {
                    const elLista = document.getElementById('lista-extrato-filtrada');
                    const elSaldo = document.getElementById('extrato-saldo-atual');
                    const elEntradas = document.getElementById('extrato-entradas');
                    const elSaidas = document.getElementById('extrato-saidas');
                    const elAjustes = document.getElementById('extrato-estornos');

                    // 1. Captura Datas
                    const valInicio = document.getElementById('extrato-data-inicio').value;
                    const valFim = document.getElementById('extrato-data-fim').value;
                    
                    const tsInicio = new Date(valInicio + "T00:00:00").getTime();
                    const tsFim = new Date(valFim + "T23:59:59").getTime();

                    // 2. FILTRAGEM (USANDO DATA ECON√îMICA)
                    let transacoesFiltradas = AppState.historicoTransacoes.filter(t => {
                        try {
                            if (!t || t.invalida) return false;

                            // Verifica Pertin√™ncia
                            const tContaId = (typeof t.contaId === 'string') ? t.contaId : (t.conta?.id);
                            const tDestinoId = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id);
                            
                            // L√≥gica de Fatura vs Conta Corrente
                            let pertence = false;
                            if (isFatura) {
                                // Se √© fatura, aceita contaId 'FATURA_...' ou destino 'FATURA_...'
                                if (tContaId === contaId || tDestinoId === contaId) pertence = true;
                            } else {
                                if (tContaId === contaId || tDestinoId === contaId) pertence = true;
                            }
                            if (!pertence) return false;

                            // O PULO DO GATO: Data Econ√¥mica
                            const dataRef = t.dataEconomica || t.data;
                            return dataRef >= tsInicio && dataRef <= tsFim;

                        } catch (e) { return false; }
                    });

                    // Ordena: Recentes primeiro
                    transacoesFiltradas.sort((a, b) => (b.dataEconomica || b.data) - (a.dataEconomica || a.data));

                    // 3. Totais
                    let entradas = 0; let saidas = 0; let ajustes = 0;

                    const listaHTML = transacoesFiltradas.map(t => {
                        const tDestinoId = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id);
                        // Entrada se o dinheiro est√° INDO para esta conta (destino) ou se √© tipo entrada NA conta
                        const isEntradaNaConta = (tDestinoId === contaId) || (t.tipo === 'entrada' && t.contaId === contaId);
                        const valor = Number(t.valor) || 0;
                        let corTexto = ''; let sinal = '';

                        const isAjuste = t.categoria === 'Estorno' || t.isAjusteInterno || String(t.descricao).includes('(Anulado)');

                        if (isAjuste) {
                            ajustes += valor; corTexto = 'text-slate-400'; sinal = isEntradaNaConta ? '+' : '-';
                        } 
                        else if (isFatura) {
                            if (t.tipo === 'entrada') { 
                                // Compra no Cart√£o -> Aumenta D√≠vida (Vermelho)
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '+';
                            } else if (isEntradaNaConta) { 
                                // Pagamento da Fatura -> Diminui D√≠vida (Verde)
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '-'; 
                            }
                        } else {
                            if (isEntradaNaConta) {
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '+';
                            } else {
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '-';
                            }
                        }

                        // Data Visual
                        const dataVisual = new Date(t.dataEconomica || t.data).toLocaleDateString('pt-BR');
                        const hora = new Date(t.data).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}); // Hora mantemos a real

                        let badge = '';
                        if (isAjuste) badge = `<span class="ml-auto text-[9px] border border-slate-500/50 text-slate-400 px-1.5 py-0.5 rounded uppercase">Ajuste</span>`;
                        else if (t.jornadaId) badge = `<span class="ml-auto text-[9px] border border-slate-600 text-slate-500 px-1.5 py-0.5 rounded uppercase">Jornada</span>`;

                        return `
                            <li class="bg-slate-700/20 p-3 rounded-lg border border-slate-600/30 flex flex-col gap-1 ${isAjuste ? 'opacity-60' : ''}">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] text-slate-500 font-mono">${dataVisual} ${hora}</span>
                                        <span class="font-bold ${corTexto} text-sm">${sinal} ${Utils.formatarMoeda(valor)}</span>
                                    </div>
                                    ${badge}
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-slate-300 truncate pr-2">${t.descricao || t.categoria}</div>
                                    <button onclick="window.excluirTransacaoInteligente('${t.id}')" class="text-[10px] text-rose-500/50 hover:text-rose-400 font-bold uppercase tracking-wider">Excluir</button>
                                </div>
                            </li>`;
                    }).join('');

                    // 4. Atualiza UI
                    let saldoDisplay = (saldoFinalExterno !== undefined) ? saldoFinalExterno : BusinessLogic.calcularSaldoConta(contaId);
                    let corSaldo = saldoDisplay >= 0 ? 'text-white' : 'text-red-400';
                    if (isFatura) corSaldo = 'text-red-400';

                    if (elSaldo) { elSaldo.className = `font-bold text-xl ${corSaldo}`; elSaldo.innerHTML = Utils.formatarMoeda(saldoDisplay); }
                    if (elEntradas) elEntradas.textContent = Utils.formatarMoeda(entradas);
                    if (elSaidas) elSaidas.textContent = Utils.formatarMoeda(saidas);
                    if (elAjustes) elAjustes.textContent = Utils.formatarMoeda(ajustes);
                    if (elLista) elLista.innerHTML = listaHTML || '<li class="text-center text-slate-500 py-8 text-xs">Nenhuma movimenta√ß√£o neste per√≠odo.</li>';
                };

                // HTML ATUALIZADO (Com Inputs de Data em vez de Selects)
                modalHTML = `
                    <div class="bg-slate-800 rounded-lg w-full max-w-lg shadow-xl flex flex-col max-h-[90vh]">
                        <div class="p-6 pb-2 flex-shrink-0 space-y-4 border-b border-slate-700/50">
                            <div class="flex justify-between items-center">
                                <div><h3 class="text-xl font-bold text-cyan-400">Extrato</h3><span class="text-sm text-slate-300 block">${contaNome}</span></div>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-3xl leading-none">√ó</button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 p-3 bg-slate-900 rounded-lg border border-slate-700">
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase font-bold">In√≠cio</label>
                                    <input type="date" id="extrato-data-inicio" value="${defaultInicio}" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-cyan-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-400 uppercase font-bold">Fim</label>
                                    <input type="date" id="extrato-data-fim" value="${defaultFim}" class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600 focus:border-cyan-500 outline-none">
                                </div>
                            </div>

                            <div class="p-3 bg-slate-700/30 border border-slate-600/50 rounded-md flex justify-between items-center">
                                <span class="font-bold text-slate-300 text-sm">SALDO ATUAL</span>
                                <span id="extrato-saldo-atual" class="font-bold text-xl text-white">...</span>
                            </div>
                            
                            <div id="extrato-resumo-periodo" class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-emerald-900/20 border border-emerald-500/30 p-2 rounded"><span class="block text-emerald-200/70 text-[10px] uppercase">${isFatura?'Pagamentos':'Entradas'}</span><span id="extrato-entradas" class="text-emerald-400 font-bold text-sm">...</span></div>
                                <div class="bg-rose-900/20 border border-rose-500/30 p-2 rounded"><span class="block text-rose-200/70 text-[10px] uppercase">${isFatura?'Fatura':'Sa√≠das'}</span><span id="extrato-saidas" class="text-rose-400 font-bold text-sm">...</span></div>
                                <div class="bg-blue-900/20 border border-blue-500/30 p-2 rounded"><span class="block text-blue-200/70 text-[10px] uppercase">Ajustes</span><span id="extrato-estornos" class="text-blue-300 font-bold text-sm">...</span></div>
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 overflow-y-auto scrollable-content p-4 pt-2">
                            <ul id="lista-extrato-filtrada" class="space-y-2"></ul>
                        </div>
                        <div class="p-4 border-t border-slate-700 bg-slate-800 flex-shrink-0">
                            <button class="btn-cancelar w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">Fechar</button>
                        </div>
                    </div>`;

                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = modalHTML;
                    container.classList.remove('hidden');
                    
                    setTimeout(() => {
                        renderExtrato(); // Renderiza inicial

                        // Listeners para atualizar ao mudar a data
                        document.getElementById('extrato-data-inicio').onchange = renderExtrato;
                        document.getElementById('extrato-data-fim').onchange = renderExtrato;
                        
                        container.querySelectorAll('.btn-cancelar').forEach(b => b.onclick = () => UIRenderer.fecharModal());
                    }, 50);
                }
                break;
            }           

*/
/* // =================================================================
            // 21. EXTRATO CONTA (V34: BLINDADO CONTRA ERRO DE ID UNDEFINED)
            // =================================================================
            case 'extratoConta': {
                const contaId = options.contaId || 'AUTO_ID_CARTEIRA';
                const contaNome = options.contaNome || 'Conta';
                const saldoFinalExterno = options.saldoFinal; 

                // Detecta se √© Fatura de Cart√£o
                const isFatura = String(contaId).startsWith('FATURA_');

                const agora = new Date();
                let mesAtual = agora.getMonth();
                let anoAtual = agora.getFullYear();
                let diaFiltro = -1;

                const renderExtrato = () => {
                    let transacoesFiltradas = [];
                    if (options.transacoes) {
                        transacoesFiltradas = options.transacoes;
                    } else {
                        transacoesFiltradas = AppState.historicoTransacoes.filter(t => {
                            if (!t) return false; // Prote√ß√£o b√°sica

                            // --- RESOLU√á√ÉO SEGURA DE IDs (CORRE√á√ÉO DO BUG) ---
                            // Tenta pegar string direta OU propriedade do objeto, com seguran√ßa
                            const tContaId = (typeof t.contaId === 'string') ? t.contaId : (t.conta?.id);
                            const tDestinoId = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id || t.contaDestino?.id);

                            let pertence = false;
                            if (tContaId === contaId) pertence = true;
                            if (tDestinoId === contaId) pertence = true;
                            
                            if (!pertence) return false;

                            const dataT = new Date(t.data);
                            if (dataT.getFullYear() !== anoAtual) return false;
                            if (mesAtual !== -1 && dataT.getMonth() !== mesAtual) return false;
                            if (diaFiltro !== -1 && dataT.getDate() !== diaFiltro) return false;
                            return true;
                        });
                    }
                    transacoesFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));

                    let entradas = 0; let saidas = 0; let ajustes = 0;
                    
                    const listaHTML = transacoesFiltradas.map(t => {
                        // Resolu√ß√£o Segura para o Loop de Renderiza√ß√£o tamb√©m
                        const tContaId = (typeof t.contaId === 'string') ? t.contaId : (t.conta?.id);
                        const tDestinoId = (typeof t.contaDestino === 'string') ? t.contaDestino : (t.destino?.id || t.contaDestino?.id);
                        
                        const isEntradaNaConta = (tDestinoId === contaId) || (t.tipo === 'entrada' && tContaId === contaId);
                        const valor = Number(t.valor) || 0;
                        let corTexto = ''; let sinal = '';

                        if (t.categoria === 'Estorno' || t.isAjusteInterno) {
                            ajustes += valor; corTexto = 'text-slate-400'; sinal = isEntradaNaConta ? '+' : '-';
                        } 
                        else if (isFatura) {
                            // L√ìGICA DE CART√ÉO
                            if (t.tipo === 'entrada') { 
                                // Compra -> Vermelho
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '+';
                            } else if (isEntradaNaConta) { 
                                // Pagamento -> Verde
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '-'; 
                            }
                        } else {
                            // L√ìGICA PADR√ÉO
                            if (isEntradaNaConta) {
                                entradas += valor; corTexto = 'text-emerald-400'; sinal = '+';
                            } else {
                                saidas += valor; corTexto = 'text-rose-400'; sinal = '-';
                            }
                        }

                        const dataObj = new Date(t.data);
                        const hora = dataObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const isAjuste = t.categoria === 'Estorno' || String(t.descricao).includes('(Anulado)');
                        let badge = '';
                        if (isAjuste) badge = `<span class="ml-auto text-[9px] border border-slate-500/50 text-slate-400 px-1.5 py-0.5 rounded uppercase">Ajuste</span>`;
                        else if (t.jornadaId) badge = `<span class="ml-auto text-[9px] border border-slate-600 text-slate-500 px-1.5 py-0.5 rounded uppercase">Jornada</span>`;

                        return `
                            <li class="bg-slate-700/20 p-3 rounded-lg border border-slate-600/30 flex flex-col gap-1 ${isAjuste ? 'opacity-60' : ''}">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2"><span class="text-xs text-slate-400 font-mono">${hora}</span><span class="font-bold ${corTexto} text-sm">${sinal} ${Utils.formatarMoeda(valor)}</span></div>
                                    ${badge}
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="text-xs text-slate-300 truncate pr-2">${t.descricao || 'Sem descri√ß√£o'}</div>
                                    <button onclick="window.excluirTransacaoInteligente('${t.id}')" class="text-[10px] text-rose-500/50 hover:text-rose-400 font-bold uppercase tracking-wider">Excluir</button>
                                </div>
                            </li>`;
                    }).join('');

                    let saldoDisplay = 0;
                    if (saldoFinalExterno !== undefined) saldoDisplay = saldoFinalExterno;
                    else saldoDisplay = BusinessLogic.calcularSaldoConta(contaId);

                    const elSaldo = document.getElementById('extrato-saldo-atual');
                    const elEntradas = document.getElementById('extrato-entradas');
                    const elSaidas = document.getElementById('extrato-saidas');
                    const elAjustes = document.getElementById('extrato-estornos');
                    const elLista = document.getElementById('lista-extrato-filtrada');

                    let corSaldo = saldoDisplay >= 0 ? 'text-white' : 'text-red-400';
                    if (elSaldo) { elSaldo.className = `font-bold text-xl ${corSaldo}`; elSaldo.innerHTML = Utils.formatarMoeda(saldoDisplay); }
                    if (elEntradas) elEntradas.textContent = Utils.formatarMoeda(entradas);
                    if (elSaidas) elSaidas.textContent = Utils.formatarMoeda(saidas);
                    if (elAjustes) elAjustes.textContent = Utils.formatarMoeda(ajustes);
                    if (elLista) elLista.innerHTML = listaHTML || '<li class="text-center text-slate-500 py-4 text-xs">Nenhuma movimenta√ß√£o no per√≠odo.</li>';
                };

                const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const diasOptions = Array.from({length: 31}, (_, i) => `<option value="${i+1}">${String(i+1).padStart(2,'0')}</option>`).join('');
                
                modalHTML = `
                    <div class="bg-slate-800 rounded-lg w-full max-w-lg shadow-xl flex flex-col max-h-[90vh]">
                        <div class="p-6 pb-2 flex-shrink-0 space-y-4 border-b border-slate-700/50">
                            <div class="flex justify-between items-center"><div><h3 class="text-xl font-bold text-cyan-400">Extrato</h3><span class="text-sm text-slate-300 block">${contaNome}</span></div><button class="btn-cancelar text-slate-400 hover:text-white text-3xl leading-none">√ó</button></div>
                            <div class="grid grid-cols-3 gap-2 p-2 bg-slate-900 rounded-lg border border-slate-700">
                                <div><select id="extrato-filtro-dia" class="w-full bg-slate-800 text-white text-xs p-1 rounded border-none"><option value="-1">Todos</option>${diasOptions}</select></div>
                                <div><select id="extrato-filtro-mes" class="w-full bg-slate-800 text-white text-xs p-1 rounded border-none"><option value="-1">Todo o Ano</option>${meses.map((m, i) => `<option value="${i}" ${i === mesAtual ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
                                <div><select id="extrato-filtro-ano" class="w-full bg-slate-800 text-white text-xs p-1 rounded border-none"><option value="${anoAtual}">${anoAtual}</option></select></div>
                            </div>
                            <div class="p-3 bg-slate-700/30 border border-slate-600/50 rounded-md flex justify-between items-center"><span class="font-bold text-slate-300 text-sm">SALDO ATUAL</span><span id="extrato-saldo-atual" class="font-bold text-xl text-white">...</span></div>
                            <div id="extrato-resumo-periodo" class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-emerald-900/20 border border-emerald-500/30 p-2 rounded relative overflow-hidden"><span class="block text-emerald-200/70 text-[10px] uppercase">${isFatura?'Pagamentos':'Entradas'}</span><span id="extrato-entradas" class="text-emerald-400 font-bold text-sm">...</span></div>
                                <div class="bg-rose-900/20 border border-rose-500/30 p-2 rounded relative overflow-hidden"><span class="block text-rose-200/70 text-[10px] uppercase">${isFatura?'Faturamento':'Sa√≠das'}</span><span id="extrato-saidas" class="text-rose-400 font-bold text-sm">...</span></div>
                                <div class="bg-blue-900/20 border border-blue-500/30 p-2 rounded relative overflow-hidden"><span class="block text-blue-200/70 text-[10px] uppercase">Ajustes</span><span id="extrato-estornos" class="text-blue-300 font-bold text-sm">...</span></div>
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 overflow-y-auto scrollable-content p-4 pt-2"><ul id="lista-extrato-filtrada" class="space-y-2"></ul></div>
                        <div class="p-4 border-t border-slate-700 bg-slate-800 flex-shrink-0"><button class="btn-cancelar w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">Fechar</button></div>
                    </div>`;

                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = modalHTML;
                    container.classList.remove('hidden');
                    setTimeout(() => {
                        renderExtrato(); 
                        const update = () => {
                            diaFiltro = Number(document.getElementById('extrato-filtro-dia').value);
                            mesAtual = Number(document.getElementById('extrato-filtro-mes').value);
                            renderExtrato();
                        };
                        document.getElementById('extrato-filtro-dia').onchange = update;
                        document.getElementById('extrato-filtro-mes').onchange = update;
                        container.querySelectorAll('.btn-cancelar').forEach(b => b.onclick = () => UIRenderer.fecharModal());
                    }, 50);
                }
                break;
            }
 */
// --- TRANSFER√äNCIA ---
                case 'transferencia':
                case 'novaTransferencia': {
                    // --- CORRE√á√ÉO DEFINITIVA: LIMPEZA DE SESS√ÉO ANTERIOR ---
                    // Garante que n√£o h√° restos de requestId de tentativas passadas
                    const oldId = document.getElementById('modal-request-id');
                    if (oldId) oldId.remove();
                    // -------------------------------------------------------

                    const { defaultOrigemId, defaultDestinoId } = options;
                    const { contasBancarias, metasFinanceiras } = AppState.configuracoes;
                    
                    let origens = [], destinos = [];
                    
                    // Popula as listas (L√≥gica original mantida)
                    contasBancarias.forEach(c => { 
                        if(c.tipo !== 'credito') origens.push({id:c.id, nome:c.nome}); 
                        destinos.push({id:c.id, nome:c.nome});
                    });
                    
                    metasFinanceiras.forEach(m => { 
                        if(['poupanca','poupanca_km','caixa'].includes(m.tipo)) origens.push({id:m.id, nome:m.descricao});
                        if(m.tipo !== 'caixa') destinos.push({id:m.id, nome:m.descricao});
                    });
                    
                    // Adiciona Carteira nas origens se n√£o tiver
                    if (!origens.some(o => o.id === 'AUTO_ID_CARTEIRA')) {
                        origens.unshift({id: 'AUTO_ID_CARTEIRA', nome: 'Carteira (Dinheiro)'});
                    }

                    const optsOrig = origens.map(o => `<option value="${o.id}" ${o.id === defaultOrigemId ? 'selected' : ''}>${o.nome}</option>`).join('');
                    const optsDest = destinos.map(d => `<option value="${d.id}" ${d.id === defaultDestinoId ? 'selected' : ''}>${d.nome}</option>`).join('');

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-indigo-400">Transfer√™ncia</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">√ó</button>
                            </div>
                            
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">De (Origem)</label>
                                <select id="transf-origem-id" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">
                                    ${optsOrig}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Para (Destino)</label>
                                <select id="transf-destino-id" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white">
                                    ${optsDest}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Valor</label>
                                <input type="text" inputmode="decimal" id="transf-valor" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white font-bold text-lg" placeholder="0,00">
                            </div>
                            
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Descri√ß√£o</label>
                                <input type="text" id="transf-descricao" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white" placeholder="Opcional">
                            </div>
                            
                            <div class="flex justify-end gap-4 pt-2">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                                <button id="btn-confirmar-transferencia" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow-lg transition transform active:scale-95">Confirmar</button>
                            </div>
                        </div>`;
                    break;
                }

                // 16. PAGAR CUSTO MENSAL
                // 16. PAGAR CUSTO MENSAL (ATUALIZADO COM SELETOR DE BANCO)
                case 'pagarCustoMensal': {
                    const meta = options.meta;
                    const { contasBancarias } = AppState.configuracoes;
                    
                    // Gera op√ß√µes de bancos (excluindo cr√©dito, pois custo fixo geralmente √© boleto/pix)
                    let optionsBancos = `<option value="AUTO_ID_CARTEIRA">üíµ Carteira</option>`;
                    contasBancarias.forEach(c => {
                        if(c.tipo !== 'credito') {
                            optionsBancos += `<option value="${c.id}">${c.nome}</option>`;
                        }
                    });

                    let itensPagarHTML = '';
                    
                    if (!meta.custosDetalhados || meta.custosDetalhados.length === 0) {
                        itensPagarHTML = '<p class="text-slate-500 italic text-center">Nenhum custo fixo cadastrado nesta caixinha.</p>';
                    } else {
                        itensPagarHTML = '<ul class="space-y-3 max-h-80 overflow-y-auto scrollable-content p-2 bg-slate-900 rounded-md">';
                        
                        meta.custosDetalhados.forEach(item => {
                            const saldoItem = item.valorGuardado || 0;
                            const objetivoItem = item.valorObjetivo || 0;
                            const progressoPercent = objetivoItem > 0 ? (saldoItem / objetivoItem) * 100 : 0;
                            const podePagar = saldoItem > 0;

                            // Tenta pr√©-selecionar um banco se a meta inteira estiver vinculada (opcional)
                            // Mas como "Custos Mensais" √© geral, deixamos Carteira ou o primeiro banco como padr√£o.

                            itensPagarHTML += `
                                <li class="p-3 bg-slate-700 rounded-md text-sm space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-white">${item.descricao}</span>
                                        <span class="font-bold text-amber-300">${Utils.formatarMoeda(saldoItem)} / ${Utils.formatarMoeda(objetivoItem)}</span>
                                    </div>
                                    <div class="meta-progress-bar flex-1">
                                        <div class="meta-progress-fill" style="width: ${progressoPercent.toFixed(2)}%; background-color: #22d3ee;"></div>
                                    </div>
                                    
                                    <div class="flex flex-wrap justify-end items-center gap-2 pt-2 border-t border-slate-600/50">
                                        <div class="flex-1 min-w-[120px]">
                                            <label class="text-[10px] text-slate-400 block mb-0.5">Pagar via:</label>
                                            <select id="banco-item-${item.idCustoFixo}" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-1 text-white text-xs h-[30px]">
                                                ${optionsBancos}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-slate-400 block mb-0.5">Valor:</label>
                                            <input type="text" inputmode="decimal" id="pagar-item-${item.idCustoFixo}"
                                                class="w-24 bg-slate-800 border border-slate-600 rounded-lg p-1 text-white text-center text-xs h-[30px]" 
                                                placeholder="${Utils.formatarMoedaParaInput(saldoItem)}"
                                                ${!podePagar ? 'disabled' : ''}>
                                        </div>
                                        <div class="flex items-end">
                                            <button data-idcusto="${item.idCustoFixo}" data-max="${saldoItem}" 
                                                    class="btn-registrar-pagamento-item text-xs bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-1 px-3 rounded-lg transition h-[30px]"
                                                    ${!podePagar ? 'disabled' : ''}>
                                                Pagar
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            `;
                        });
                        itensPagarHTML += '</ul>';
                    }

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-lg shadow-xl" style="max-height: 90vh; overflow-y: auto;">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-sky-400">Pagar Custos da Caixinha</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <p class="text-sm text-slate-400 mb-2">O valor sair√° do <b>Banco selecionado</b> e ser√° baixado do <b>Saldo Provisionado</b>.</p>
                            <p class="text-sm text-slate-400 mb-4">Saldo Total Provisionado: <b class="text-green-400">${Utils.formatarMoeda(meta.valorAtual || 0)}</b></p>
                            ${itensPagarHTML}
                        </div>
                    `;
                    AppState.itemParaEditarId = meta.id; 
                    break;
                }

                // 17. CALCULADORAS
                case 'calculadoras': {
                    AppState.modalContext = 'calculadoras';
                    const { metasFinanceiras } = AppState.configuracoes;
                    const custosParaCotacao = metasFinanceiras.filter(m => m.incluirComoCustoDiario === true && m.id !== 'META_CUSTOS_MENSAIS');
                    const metaCustosMensais = metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');

                    let custosCheckboxHTML = '<h5 class="text-sm font-semibold text-slate-300 mb-2">Custos a Incluir no C√°lculo:</h5>';
                    custosCheckboxHTML += '<ul class="space-y-2 max-h-40 overflow-y-auto scrollable-content p-2 bg-slate-900 rounded-md">';
                    custosCheckboxHTML += `
                        <li class="p-2 bg-slate-800 rounded-md">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="cotacao-custo-prolabore" data-custo-tipo="prolabore" class="cotacao-custo-checkbox h-4 w-4 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-cyan-500" checked>
                                <span class="font-bold text-white">Meu Pr√≥-labore (Sal√°rio)</span>
                            </label>
                        </li>
                    `;
                    if (metaCustosMensais && metaCustosMensais.valorTotal > 0) {
                         custosCheckboxHTML += `
                            <li class="p-2 bg-slate-800 rounded-md">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="cotacao-custo-${metaCustosMensais.id}" data-custo-tipo="meta" data-meta-id="${metaCustosMensais.id}" class="cotacao-custo-checkbox h-4 w-4 rounded bg-slate-700 border border-slate-600 text-cyan-600 focus:ring-cyan-500" checked>
                                    <span class="font-bold text-white">Custos Fixos (Di√°rio)</span>
                                </label>
                            </li>
                        `;
                    }
                    custosParaCotacao.forEach(meta => {
                        custosCheckboxHTML += `
                            <li class="p-2 bg-slate-800 rounded-md">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="cotacao-custo-${meta.id}" data-custo-tipo="meta" data-meta-id="${meta.id}" class="cotacao-custo-checkbox h-4 w-4 rounded bg-slate-700 border border-slate-600 text-cyan-600 focus:ring-cyan-500" checked>
                                    <span class="font-bold text-white">${meta.descricao}</span>
                                </label>
                            </li>
                        `;
                    });
                    custosCheckboxHTML += '</ul>';

                    const agora = new Date();
                    agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
                    const dataHoraAtual = agora.toISOString().slice(0, 16);

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-2xl shadow-xl" style="max-height: 90vh; overflow-y: auto;" oninput="EventHandlers.handleRecalcularCotacao()">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-cyan-400">Calculadoras</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            
                            <div class="flex justify-center border-b border-slate-700 text-sm mb-4">
                                <button class="calc-tab-button py-2 px-4 font-semibold" data-tab="cotacao">Cota√ß√£o Particular</button>
                                <button class="calc-tab-button py-2 px-4 font-semibold active" data-tab="troco">Troco</button>
                            </div>

                            <div id="calc-tab-content-cotacao" class="calc-tab-pane space-y-4 hidden">
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    
                                    <div class="space-y-4">
                                        <h4 class="text-lg font-semibold text-slate-300 text-center">Dados da Viagem</h4>
                                        
                                        <div>
                                            <label for="cotacaoNomeCliente" class="block text-xs font-medium text-slate-400 mb-1">Nome Cliente/Empresa</label>
                                            <input type="text" id="cotacaoNomeCliente" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Ex: Sr. Jo√£o / Empresa X">
                                        </div>

                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="cotacaoDataInicio" class="block text-xs font-medium text-slate-400 mb-1">Data/Hora In√≠cio</label>
                                                <input type="datetime-local" id="cotacaoDataInicio" value="${dataHoraAtual}" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white text-xs" style="color-scheme: dark;">
                                            </div>
                                            <div>
                                                <label for="cotacaoDataFim" class="block text-xs font-medium text-slate-400 mb-1">Data/Hora Fim (Opc.)</label>
                                                <input type="datetime-local" id="cotacaoDataFim" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white text-xs" style="color-scheme: dark;">
                                            </div>
                                        </div>

                                        <div id="cotacao-paradas-container" class="space-y-2">
                                            <div>
                                                <label for="cotacaoPonto0" class="block text-xs font-medium text-slate-400 mb-1">Ponto A (Origem)</label>
                                                <input type="text" id="cotacaoPonto0" class="cotacao-parada-input w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Endere√ßo de partida">
                                            </div>
                                            <div>
                                                <label for="cotacaoPonto1" class="block text-xs font-medium text-slate-400 mb-1">Ponto B (Destino)</label>
                                                <input type="text" id="cotacaoPonto1" class="cotacao-parada-input w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Endere√ßo final">
                                            </div>
                                        </div>
                                        <button id="btn-add-parada" class="w-full text-xs bg-slate-700 hover:bg-slate-600 text-cyan-300 font-bold py-1 px-2 rounded-lg transition">+ Adicionar Parada</button>
                                        <p class="text-xs text-slate-500 text-center italic">
                                            Aten√ß√£o: Voc√™ deve preencher o KM Total manualmente abaixo.
                                        </p>

                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="cotacaoDistEmbarque" class="block text-xs font-medium text-slate-400 mb-1">Dist. Embarque (KM)</label>
                                                <input type="number" id="cotacaoDistEmbarque" placeholder="Ex: 5" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                            </div>
                                            <div>
                                                <label for="cotacaoDistViagem" class="block text-xs font-medium text-slate-400 mb-1">Dist. Viagem (KM Total)</label>
                                                <input type="number" id="cotacaoDistViagem" placeholder="Ex: 150" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="cotacaoPedagios" class="block text-xs font-medium text-slate-400 mb-1">Ped√°gios (R$)</label>
                                                <input type="text" inputmode="decimal" id="cotacaoPedagios" placeholder="Ex: 18,40" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                            </div>
                                            <div>
                                                <label for="cotacaoSeguranca" class="block text-xs font-medium text-slate-400 mb-1">Taxa Extra (R$)</label>
                                                <input type="text" inputmode="decimal" id="cotacaoSeguranca" placeholder="Opcional" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <input type="checkbox" id="cotacaoSemRetorno" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-cyan-500">
                                            <label for="cotacaoSemRetorno" class="text-sm text-slate-400">Cobrar retorno (Viagem sem volta)</label>
                                        </div>

                                        <h5 class="text-sm font-semibold text-slate-300 pt-2 border-t border-slate-700">Detalhes (Opcional p/ PDF)</h5>
                                        <div class="grid grid-cols-3 gap-3">
                                            <div>
                                                <label for="cotacaoTipoServico" class="block text-xs font-medium text-slate-400 mb-1">Tipo</label>
                                                <select id="cotacaoTipoServico" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white text-xs">
                                                    <option>Passageiro</option>
                                                    <option>Entrega</option>
                                                    <option>Ambos</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="cotacaoQtdItens" class="block text-xs font-medium text-slate-400 mb-1">Qtd. Itens</label>
                                                <input type="number" id="cotacaoQtdItens" placeholder="Ex: 3" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                            </div>
                                            <div>
                                                <label for="cotacaoPeso" class="block text-xs font-medium text-slate-400 mb-1">Peso (Kg)</label>
                                                <input type="text" inputmode="decimal" id="cotacaoPeso" placeholder="Ex: 15,5" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                            </div>
                                        </div>

                                    </div>

                                    <div class="space-y-4">
                                        <h4 class="text-lg font-semibold text-slate-300 text-center">C√°lculo de Valores</h4>
                                        
                                        ${custosCheckboxHTML}

                                        <div class="p-3 bg-slate-900 rounded-lg space-y-3">
                                            <button id="btn-sugerir-cotacao-custos" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">Sugerir (Baseado nos Custos)</button>
                                            <button id="btn-sugerir-cotacao-desempenho" class="w-full bg-slate-700 hover:bg-slate-600 text-cyan-300 font-bold py-1 px-2 rounded-lg transition text-xs">Sugerir (Baseado no Desempenho/Metas)</button>
                                            
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label for="cotacaoValorKm" class="block text-xs font-medium text-slate-400 mb-1">Valor/KM Viagem (R$)</label>
                                                    <input type="text" inputmode="decimal" id="cotacaoValorKm" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white">
                                                </div>
                                                <div>
                                                    <label for="cotacaoValorKmRetorno" class="block text-xs font-medium text-slate-400 mb-1">Valor/KM Retorno (R$)</label>
                                                    <input type="text" inputmode="decimal" id="cotacaoValorKmRetorno" class="w-full bg-slate-600 border border-slate-600 rounded-lg p-2 text-white" disabled>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="text-center p-4 bg-slate-900 rounded-lg space-y-2">
                                            <span class="text-slate-400 text-lg">Total a ser Cobrado:</span>
                                            <h3 id="calc-resultado-cotacao" class="text-3xl font-bold text-green-400">R$ 0,00</h3>
                                            <button id="btn-pdf-cotacao" class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition mt-2">Gerar PDF da Cota√ß√£o</button>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div id="calc-tab-content-troco" class="calc-tab-pane space-y-4">
                                <h4 class="text-lg font-semibold text-slate-300 text-center">Calcular Troco</h4>
                                <div>
                                    <label for="calcValorCorrida" class="block text-sm font-medium text-slate-300 mb-1">Valor da Corrida (R$)</label>
                                    <input type="text" inputmode="decimal" id="calcValorCorrida" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label for="calcValorRecebido" class="block text-sm font-medium text-slate-300 mb-1">Valor Recebido (R$)</label>
                                    <input type="text" inputmode="decimal" id="calcValorRecebido" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                                </div>
                                <button id="btn-calcular-troco" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition">Calcular</button>
                                <div class="text-center p-4 bg-slate-900 rounded-lg">
                                    <span class="text-slate-400 text-lg">Troco a devolver:</span>
                                    <h3 id="calc-resultado-troco" class="text-3xl font-bold text-green-400">R$ 0,00</h3>
                                </div>
                            </div>

                        </div>
                    `;
                    break;
                }

                // 18. AJUSTE DE SALDO
                // --- REINSERINDO: MODAL DE AJUSTE ---
                case 'ajusteSaldo': {
                    const { contaId, nomeConta, saldoAtual } = options;
                    
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-xl text-center space-y-4 border border-slate-700">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                                <h3 class="text-lg font-bold text-white">Ajuste Manual</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            
                            <div class="bg-slate-900 p-3 rounded-lg">
                                <p class="text-xs text-slate-400 mb-1">Conta:</p>
                                <p class="font-bold text-white text-sm">${nomeConta}</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-400 mb-1">Saldo Atual</label>
                                    <div class="w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-slate-300 font-mono">
                                        ${Utils.formatarMoeda(saldoAtual)}
                                    </div>
                                </div>
                                <div>
                                    <label for="ajuste-novo-saldo" class="block text-xs font-medium text-cyan-400 mb-1 font-bold">Novo Saldo Real</label>
                                    <input type="text" inputmode="decimal" id="ajuste-novo-saldo" 
                                           class="w-full bg-slate-800 border border-cyan-500 rounded-lg p-2 text-white font-bold text-center focus:ring-2 focus:ring-cyan-500 focus:outline-none transition" 
                                           placeholder="R$ 0,00">
                                </div>
                            </div>
                            
                            <input type="hidden" id="ajuste-conta-id" value="${contaId}">
                            <input type="hidden" id="ajuste-saldo-anterior" value="${saldoAtual}">

                            <p class="text-[10px] text-slate-500 italic">
                                O sistema criar√° uma transa√ß√£o de "Ajuste" para corrigir a diferen√ßa.
                            </p>

                            <div class="flex justify-end gap-3 pt-2">
                                <button class="btn-cancelar bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">Cancelar</button>
                                <button id="btn-salvar-ajuste-saldo" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition shadow-lg">
                                    Salvar Corre√ß√£o
                                </button>
                            </div>
                        </div>`;
                    break;
                }

                // 19. ADICIONAR EXTRA
                case 'adicionarExtra': {
    const atividadeId = (options && options.atividadeId) || AppState.itemParaEditarId;
    
    if (!atividadeId) {
        return UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'N√£o foi poss√≠vel identificar a atividade para adicionar o extra.' });
    }

    modalHTML = `
        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-sm shadow-xl space-y-4">
            <h3 class="text-xl font-bold text-green-400">Adicionar Valor Extra</h3>
            <p class="text-sm text-slate-400">Gorjeta, b√¥nus ou ajuste de valor para a atividade selecionada.</p>
            
            <input type="hidden" id="input-atividade-id" value="${atividadeId}">

            <div>
                <label for="input-valor-extra" class="block text-sm font-medium text-white mb-1">Valor a Adicionar (R$)</label>
                <input type="text" inputmode="decimal" id="input-valor-extra" placeholder="Ex: 5,00" class="w-full bg-slate-700 border border-slate-600 rounded p-3 text-white text-lg focus:ring-green-500 focus:border-green-500">
            </div>

            <div class="flex justify-end gap-3 pt-3">
                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancelar</button>
                <button id="btn-salvar-extra" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Salvar Extra</button>
            </div>
        </div>`;
    break;
}
// =================================================================
            // ALOCA√á√ÉO METAS (V76 - VISUAL CONGELADO + FIX HIST√ìRICO EXTRATO)
            // =================================================================
            case 'alocacaoMetas': {
                console.log("üîç [DEBUG] Aloca√ß√£o V76: Visual V71.1 | Fix Hist√≥rico Extrato...");

                let jornadaAtiva = BusinessLogic.getJornadaAtiva();
                let chaveJornada = jornadaAtiva ? jornadaAtiva.id : null;

                if (!chaveJornada) {
                    chaveJornada = Utils.formatarDataParaChave(new Date());
                    if (AppState.jornadas && AppState.jornadas[chaveJornada]) {
                        jornadaAtiva = AppState.jornadas[chaveJornada];
                    }
                }

                const transacoesDoDia = AppState.historicoTransacoes.filter(t => {
                    if (t.jornadaId === chaveJornada) return true;
                    if (t.data) {
                        const dataT = typeof t.data === 'string' ? t.data : new Date(t.data).toISOString();
                        if (dataT.startsWith(chaveJornada)) return true;
                    }
                    return false;
                });

                const isContaCredito = (id) => {
                    if (!id) return false;
                    const idStr = String(id).toLowerCase();
                    if (idStr.startsWith('fatura_') || idStr.includes('credito') || idStr.includes('cr√©dito')) return true;
                    const conta = AppState.configuracoes.contasBancarias.find(c => c.id === id);
                    if (conta && conta.tipo === 'credito') return true;
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
                    if (meta && meta.tipo === 'credito') return true;
                    return false;
                };

                const getBancoVinculado = (cartaoId) => {
                    if (!cartaoId) return null;
                    const idLimpo = String(cartaoId).replace('FATURA_', '');
                    if (idLimpo === 'LIVRO_CAIXA_DESPESA_CREDITO') {
                        const contaCreditoConfigurada = AppState.configuracoes.contasBancarias.find(c => c.tipo === 'credito' && c.contaVinculadaId);
                        if (contaCreditoConfigurada) {
                            return AppState.configuracoes.contasBancarias.find(c => c.id === contaCreditoConfigurada.contaVinculadaId);
                        }
                    }
                    const conta = AppState.configuracoes.contasBancarias.find(c => c.id === idLimpo || c.id === cartaoId);
                    if (conta && conta.contaVinculadaId) return AppState.configuracoes.contasBancarias.find(c => c.id === conta.contaVinculadaId);
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === cartaoId || m.contaVinculadaId === cartaoId || (m.tipo === 'credito' && isContaCredito(cartaoId)));
                    if (meta && meta.contaVinculadaId) return AppState.configuracoes.contasBancarias.find(c => c.id === meta.contaVinculadaId);
                    return null;
                };

                const ganhosReaisDoDia = transacoesDoDia
                    .filter(t => t.tipo === 'entrada' && !t.invalida && !String(t.descricao).includes('Estorno') && (typeof t.contaId === 'string' ? t.contaId : t.conta?.id) === 'AUTO_ID_CARTEIRA')
                    .reduce((acc, t) => acc + (Number(t.valor) || 0), 0);

                const custosDinheiro = transacoesDoDia
                    .filter(t => t.tipo === 'saida' && !t.invalida && !t.isAjusteInterno && (typeof t.contaId === 'string' ? t.contaId : t.conta?.id) === 'AUTO_ID_CARTEIRA')
                    .reduce((acc, t) => acc + (Number(t.valor) || 0), 0);

                const dividaCartaoDia = transacoesDoDia
                    .filter(t => {
                        if (t.invalida || t.isAjusteInterno) return false;
                        const cId = typeof t.contaId === 'string' ? t.contaId : t.conta?.id;
                        return t.tipo === 'saida' && isContaCredito(cId);
                    })
                    .reduce((acc, t) => acc + (Number(t.valor) || 0), 0);

                const listaRessarcimentosP0 = transacoesDoDia.filter(t => {
                    if (t.invalida || t.isAjusteInterno || t.ressarcida === true) return false;
                    const cId = typeof t.contaId === 'string' ? t.contaId : t.conta?.id;
                    if (isContaCredito(cId) || cId === 'LIVRO_CAIXA_DESPESA_CREDITO') return false;
                    if (t.tipo === 'saida' && cId !== 'AUTO_ID_CARTEIRA') return true;
                    return false;
                });
                const totalRessarcimento = listaRessarcimentosP0.reduce((acc, t) => acc + (Number(t.valor) || 0), 0);

                const lucroOperacionalCaixa = Math.max(0, ganhosReaisDoDia - custosDinheiro);
                const valorParaP0 = Math.min(lucroOperacionalCaixa, totalRessarcimento);
                const sobraPosP0 = Math.max(0, lucroOperacionalCaixa - valorParaP0);
                const valorParaCartao = Math.min(sobraPosP0, dividaCartaoDia);
                const lucroLiquidoReal = Math.max(0, sobraPosP0 - valorParaCartao);

                const metasParaAnalise = AppState.configuracoes.metasFinanceiras
                    .filter(m => m.id !== 'AUTO_ID_CARTEIRA' && m.tipo !== 'carteira' && m.id !== 'AUTO_ID_RESERVA_LUCRO') 
                    .map(meta => {
                        let custo = 0;
                        if (meta.tipo === 'credito' && dividaCartaoDia > 0) {
                            custo = valorParaCartao;
                            meta.incluirComoCustoDiario = true;
                            meta._valorTotalDividaDia = dividaCartaoDia;
                        } else {
                            if (meta.tipo === 'poupanca_km' && jornadaAtiva) {
                                const km = (jornadaAtiva.kmFinal || 0) - (jornadaAtiva.kmInicial || 0);
                                if (km > 0 && meta.valorPorKm > 0) custo = km * meta.valorPorKm;
                            } else {
                                custo = BusinessLogic.calcularCustoDiarioMeta(meta, new Date());
                            }
                        }
                        const concluida = meta.valorTotal > 0 && (meta.valorAtual || 0) >= meta.valorTotal;
                        if (concluida && meta.tipo !== 'poupanca_km' && meta.id !== 'META_CUSTOS_MENSAIS') custo = 0;
                        return { ...meta, custoDiario: custo };
                    });

                const dataFormatadaSegura = chaveJornada ? chaveJornada.split('-').reverse().join('/') : 'Hoje';
                let textoDestinoCartao = "Manter na Carteira";
                if (dividaCartaoDia > 0) {
                    const cartaoUsado = transacoesDoDia.find(t => t.tipo === 'saida' && isContaCredito(typeof t.contaId === 'string' ? t.contaId : t.conta?.id));
                    if (cartaoUsado) {
                        const idCartao = typeof cartaoUsado.contaId === 'string' ? cartaoUsado.contaId : cartaoUsado.conta?.id;
                        const bancoVinculado = getBancoVinculado(idCartao); 
                        if (bancoVinculado) textoDestinoCartao = `Depositar em: ${bancoVinculado.nome}`;
                    }
                }

                modalHTML = `
                    <div class="bg-slate-800 rounded-xl w-full max-w-md shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]">
                        <div class="bg-slate-900/80 p-4 border-b border-slate-700 text-center relative">
                            <h3 class="text-lg font-bold text-white">Fechamento de Caixa</h3>
                            <p class="text-xs text-slate-400">Jornada: ${dataFormatadaSegura}</p>
                        </div>
                        <div class="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-lg border border-slate-700 text-center relative overflow-hidden shadow-inner mb-4">
                                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                                <div class="flex justify-between text-[10px] text-slate-400 uppercase tracking-wider font-bold mb-1">
                                    <span>Entradas</span><span>${Utils.formatarMoeda(ganhosReaisDoDia)}</span>
                                </div>
                                <div class="flex justify-between text-[10px] text-red-400 uppercase tracking-wider font-bold mb-1">
                                    <span>Custos (Din)</span><span>- ${Utils.formatarMoeda(custosDinheiro)}</span>
                                </div>
                                ${totalRessarcimento > 0 ? `<div class="flex justify-between text-[10px] text-amber-400 uppercase tracking-wider font-bold mb-1"><span>Ressarcimento (D√©bito)</span><span>- ${Utils.formatarMoeda(valorParaP0)}</span></div>` : ''}
                                ${dividaCartaoDia > 0 ? `
                                <div class="mt-2 mb-2 bg-slate-800/50 rounded border border-slate-700/50 p-1.5">
                                    <div class="flex justify-between text-[10px] text-slate-400 font-bold"><span>Gasto Cart√£o (Dia):</span><span class="text-red-300">${Utils.formatarMoeda(dividaCartaoDia)}</span></div>
                                    <div class="flex justify-between text-[10px] text-emerald-400 font-bold mt-0.5"><span>‚Ü≥ Provis√£o Hoje:</span><span>- ${Utils.formatarMoeda(valorParaCartao)}</span></div>
                                    <div class="text-[9px] text-right text-cyan-400 text-slate-500 italic mt-0.5">${textoDestinoCartao}</div>
                                    ${(dividaCartaoDia - valorParaCartao) > 0.01 ? `<div class="text-[9px] text-right text-orange-400 italic mt-0.5">Faltam ${Utils.formatarMoeda(dividaCartaoDia - valorParaCartao)}</div>` : ''}
                                </div>` : ''}
                                <div class="border-t border-slate-600 my-1"></div>
                                <p class="text-slate-300 text-[10px] uppercase mt-1">Livre para Metas</p>
                                <b class="text-3xl text-white tracking-tight">${Utils.formatarMoeda(lucroLiquidoReal)}</b>
                            </div>
                            <div class="flex items-center justify-end mb-2 px-1">
                                <label class="flex items-center cursor-pointer">
                                    <span class="text-[10px] text-slate-400 mr-2">Modo Fiscal (N√£o negativar)</span>
                                    <input type="checkbox" id="chk-modo-fiscal" class="form-checkbox h-3 w-3 text-cyan-600 bg-slate-700 border-slate-600 rounded focus:ring-0" ${AppState.configuracoes.usarModoFiscal !== false ? 'checked' : ''}>
                                </label>
                            </div>
                            <div id="container-lista-metas"><p class="text-center text-slate-500 text-xs py-4">Carregando prioridades...</p></div>
                        </div>
                        <div class="bg-slate-900 p-4 border-t border-slate-700 shrink-0">
                            <div class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded-lg border border-slate-700">
                                <span class="text-slate-400 text-xs font-medium">Resultado Final</span>
                                <span id="valor-sobra-dinamica" class="text-lg font-bold text-white transition-colors">...</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="btn-cancelar py-3 rounded-lg border border-slate-600 text-slate-300 font-medium hover:bg-slate-800 transition">Cancelar</button>
                                <button id="btn-finalizar-cascata" class="py-3 rounded-lg bg-green-600 text-white font-bold hover:bg-green-500 transition shadow-lg flex justify-center items-center gap-2">Confirmar</button>
                            </div>
                        </div>
                    </div>`;

                setTimeout(() => {
                    const containerLista = document.getElementById('container-lista-metas');
                    const displaySobra = document.getElementById('valor-sobra-dinamica');
                    const chkModoFiscal = document.getElementById('chk-modo-fiscal');

                    const getWeight = (meta) => {
                        if (meta.tipo === 'credito') return 200; 
                        if (meta.id === 'META_CUSTOS_MENSAIS') return 100;
                        if (meta.tipo === 'poupanca_km') return 90;
                        if (meta.incluirComoCustoDiario === true) return 70;
                        if (meta.id === 'AUTO_ID_PROLABORE') return 50;
                        return 10;
                    };

                    const renderLista = () => {
                        const prioridades = metasParaAnalise.filter(m => getWeight(m) >= 50 && m.custoDiario > 0);
                        const opcionais = metasParaAnalise.filter(m => getWeight(m) < 50);
                        prioridades.sort((a, b) => getWeight(b) - getWeight(a));
                        opcionais.sort((a, b) => getWeight(b) - getWeight(a));

                        const criarItemHTML = (meta, isPriority) => {
                            const saude = BusinessLogic.diagnosticarSaudeMeta(meta);
                            const isChecked = isPriority; 
                            const isDisabled = isPriority; 
                            let tipoLabel = 'Poupan√ßa'; let corBorda = 'border-slate-600'; let corBadge = 'text-blue-300 bg-blue-500/10 border-blue-500/20';
                            if (meta.tipo === 'credito') { tipoLabel = 'Fatura Dia'; corBorda = 'border-red-500/80'; corBadge = 'text-red-300 bg-red-500/20 border-red-500/30'; }
                            else if (meta.tipo === 'parcelamento') { tipoLabel = 'D√≠vida'; corBorda = 'border-red-500/60'; corBadge = 'text-red-300 bg-red-500/10 border-red-500/20'; } 
                            else if (meta.id === 'AUTO_ID_PROLABORE') { tipoLabel = 'Sal√°rio'; corBorda = 'border-emerald-500/60'; corBadge = 'text-emerald-300 bg-emerald-500/10 border-emerald-500/20'; } 
                            else if (meta.tipo === 'poupanca_km') { tipoLabel = 'Manuten√ß√£o'; corBorda = 'border-amber-500/60'; corBadge = 'text-amber-300 bg-amber-500/10 border-amber-500/20'; }
                            if (saude && (saude.status === 'ATRASADO' || saude.status === 'ALERTA') && meta.tipo !== 'credito') { if (meta.tipo === 'parcelamento') corBorda = 'border-red-500'; else corBorda = 'border-amber-400'; }
                            let badgeExtra = isPriority ? `<span class="ml-2 text-[9px] px-1.5 py-0.5 rounded border border-purple-500/30 bg-purple-500/10 text-purple-300 flex items-center gap-1">Autom√°tico</span>` : `<span class="ml-2 text-[9px] px-1.5 py-0.5 rounded border border-slate-600 bg-slate-700 text-slate-400">Opcional</span>`;
                            let htmlAlerta = '';
                            if (meta.tipo === 'credito') htmlAlerta = `<div class="mt-2 pt-2 border-t border-slate-700/50 flex flex-col gap-1"><div class="flex items-center gap-1.5"><span class="text-xs">üí≥</span><span class="text-[10px] text-red-200 font-medium flex-1 leading-tight">Prioridade: Reposi√ß√£o de gasto no cart√£o.</span></div></div>`;
                            else if (saude && (saude.status === 'ATRASADO' || saude.status === 'ALERTA')) {
                                const btnHTML = meta.modoProvisionamento !== 'dinamico' ? `<button type="button" class="btn-corrigir-meta text-[9px] font-bold text-amber-400 underline hover:text-amber-200 transition cursor-pointer z-50 relative px-2 py-1 bg-slate-800/50 rounded border border-amber-500/30 shadow-sm" data-meta-id="${meta.id}">Corrigir Agora</button>` : `<span class="text-[9px] text-green-400 font-mono border border-green-900/50 bg-green-900/20 px-1.5 py-0.5 rounded">Din√¢mico ON</span>`;
                                htmlAlerta = `<div class="mt-2 pt-2 border-t border-slate-700/50 flex flex-col gap-1 animate-pulse-slow"><div class="flex items-center gap-1.5"><span class="text-xs">‚ö†Ô∏è</span><span class="text-[10px] text-amber-200 font-medium flex-1 leading-tight">${saude.msg}</span></div><div class="flex justify-between items-center pl-4"><span class="text-[9px] text-slate-500 italic">${saude.sugestao}</span>${btnHTML}</div></div>`;
                            }
                            return `<li class="rounded-lg border-2 ${corBorda} bg-slate-800 mb-2 p-2"><label class="flex items-start gap-3 cursor-pointer ${isDisabled ? 'opacity-90 cursor-not-allowed' : ''} h-full w-full"><div class="pt-0.5"><input type="checkbox" data-id="${meta.id}" data-custo="${meta.custoDiario}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} class="w-5 h-5 rounded bg-slate-700 border-slate-600 text-cyan-600 checkbox-meta"></div><div class="flex-1"><div class="flex justify-between items-start mb-1"><span class="font-bold text-white text-sm leading-tight mr-2">${meta.descricao}</span><span class="text-xs font-mono font-bold text-cyan-300 whitespace-nowrap">${Utils.formatarMoeda(meta.custoDiario)}</span></div><div class="flex flex-wrap items-center"><span class="text-[9px] px-1.5 py-0.5 rounded border ${corBadge} uppercase">${tipoLabel}</span>${badgeExtra}</div>${htmlAlerta}</div></label></li>`;
                        };

                        let html = `<div class="mb-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wide mb-2 pl-1 flex items-center gap-2">‚ú® Aloca√ß√£o Flex√≠vel</p><ul class="space-y-2">${opcionais.length > 0 ? opcionais.map(m => criarItemHTML(m, false)).join('') : '<div class="p-4 text-center text-slate-500 italic text-sm">Nada pendente.</div>'}</ul></div>`;
                        if (prioridades.length > 0) html += `<details class="group bg-slate-900/50 rounded-lg border border-slate-700/50" open><summary class="flex justify-between items-center font-bold cursor-pointer list-none p-3 text-xs text-slate-500 uppercase tracking-wide hover:text-white transition select-none"><span>üîí Prioridades Autom√°ticas</span><span class="transition group-open:rotate-180">‚ñº</span></summary><ul class="p-2 border-t border-slate-700/30">${prioridades.map(m => criarItemHTML(m, true)).join('')}</ul></details>`;
                        containerLista.innerHTML = html;
                        containerLista.querySelectorAll('.checkbox-meta').forEach(cb => cb.addEventListener('change', atualizarRodape));
                        containerLista.querySelectorAll('.btn-corrigir-meta').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const metaId = e.target.getAttribute('data-meta-id'); const metaRef = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId); if (metaRef) { metaRef.modoProvisionamento = 'dinamico'; Storage.salvarConfiguracoes(); renderLista(); atualizarRodape(); } }));
                        atualizarRodape();
                    };

                    const atualizarRodape = () => {
                        let saldo = lucroLiquidoReal;
                        const checkboxes = Array.from(containerLista.querySelectorAll('.checkbox-meta:checked')).filter(cb => { const m = AppState.configuracoes.metasFinanceiras.find(meta => meta.id === cb.dataset.id); return m && m.tipo !== 'credito'; });
                        checkboxes.sort((a, b) => { const mA = AppState.configuracoes.metasFinanceiras.find(m => m.id === a.dataset.id); const mB = AppState.configuracoes.metasFinanceiras.find(m => m.id === b.dataset.id); return getWeight(mB) - getWeight(mA); });
                        checkboxes.forEach(cb => { let custo = parseFloat(cb.dataset.custo || 0); if (chkModoFiscal.checked) { if (saldo <= 0) custo = 0; else if (saldo < custo) custo = saldo; } saldo -= custo; });
                        displaySobra.textContent = Utils.formatarMoeda(saldo);
                        displaySobra.className = saldo >= 0 ? "text-lg font-bold text-emerald-400" : "text-lg font-bold text-red-400";
                    };

                    if(chkModoFiscal) chkModoFiscal.addEventListener('change', () => { AppState.configuracoes.usarModoFiscal = chkModoFiscal.checked; atualizarRodape(); });
                    renderLista();

                    const btnSalvar = document.getElementById('btn-finalizar-cascata');
                    if(btnSalvar) {
                      btnSalvar.onclick = (e) => {
                            e.preventDefault();
                            
                            // 1. Feedback Visual e Bloqueio (Para n√£o clicar 2x)
                            btnSalvar.innerHTML = '<span class="animate-spin inline-block mr-1">‚öôÔ∏è</span> Processando...';
                            btnSalvar.disabled = true;

                            try {
                                // 2. Coleta APENAS quem deve ser pago (Checkboxes)
                                const checkboxesMarcados = Array.from(containerLista.querySelectorAll('.checkbox-meta:checked'));
                                const metasSelecionadasIDs = checkboxesMarcados.map(cb => cb.dataset.id);
                                
                                // 3. Pega o valor visual (apenas para log/refer√™ncia)
                                const lucroVisual = displaySobra.textContent; 

                                // 4. CHAMA O MOTOR V141
                                // O Motor vai:
                                //  - Liquidar custos do bolso (Ressarcimento)
                                //  - Pagar Cart√£o (Prioridade 100)
                                //  - Pagar Metas (Waterfall)
                                //  - Jogar sobra na Reserva
                                //  - Matar o Zumbi e Recarregar a p√°gina
                                setTimeout(() => {
                                    if (typeof FechamentoJornada !== 'undefined') {
                                        FechamentoJornada.executar(metasSelecionadasIDs, lucroVisual);
                                    } else {
                                        throw new Error("Motor FechamentoJornada n√£o carregado.");
                                    }
                                }, 100);

                            } catch (err) {
                                console.error("Erro ao fechar:", err);
                                alert("Ocorreu um erro: " + err.message);
                                btnSalvar.innerHTML = "Tentar Novamente";
                                btnSalvar.disabled = false;
                            }
                        };
                    }  
                        /*
                        btnSalvar.onclick = (e) => {
                            e.preventDefault(); btnSalvar.innerHTML = "Processando..."; btnSalvar.disabled = true;
                            try {
                                const toCents = (v) => Math.round(Number(v) * 100); const toMoney = (c) => c / 100; const agora = new Date().toISOString(); let totalAlocado = 0; const listaPagamentosAlerta = [];
                                
                                listaRessarcimentosP0.forEach(t => {
                                    const destId = typeof t.contaId === 'string' ? t.contaId : t.conta?.id;
                                    if (destId && destId !== 'AUTO_ID_CARTEIRA') {
                                        // üõ°Ô∏è ENTRADA NO BANCO (FIX EXTRATO)
                                        AppState.historicoTransacoes.push({ id: 'in-'+Date.now()+Math.random(), data: agora, tipo: 'entrada', valor: t.valor, contaId: destId, categoria: 'Ressarcimento', descricao: `Ressarcimento: ${t.descricao}`, jornadaId: chaveJornada, isAjusteInterno: true });
                                        t.ressarcida = true; t.dataRessarcimento = agora;
                                        const c = AppState.configuracoes.contasBancarias.find(x => x.id === destId);
                                        if (c) c.saldo = toMoney(toCents(c.saldo||0) + toCents(t.valor));
                                    }
                                });

                                if (valorParaCartao > 0) {
                                    const cartaoUsado = transacoesDoDia.find(t => t.tipo === 'saida' && isContaCredito(typeof t.contaId === 'string' ? t.contaId : t.conta?.id));
                                    let bancoDestino = null;
                                    if (cartaoUsado) {
                                        const idCartao = typeof cartaoUsado.contaId === 'string' ? cartaoUsado.contaId : cartaoUsado.conta?.id;
                                        bancoDestino = getBancoVinculado(idCartao);
                                    }

                                    if (bancoDestino) {
                                        // üõ°Ô∏è SA√çDA DA CARTEIRA
                                        AppState.historicoTransacoes.push({ id: 'out-cart-'+Date.now(), data: agora, tipo: 'saida', valor: valorParaCartao, contaId: 'AUTO_ID_CARTEIRA', descricao: `Provis√£o Fatura: ${bancoDestino.nome}`, jornadaId: chaveJornada, isAutomatico: true });
                                        // üõ°Ô∏è ENTRADA NO BANCO (FIX EXTRATO)
                                        AppState.historicoTransacoes.push({ id: 'in-bank-'+Date.now()+'-'+Math.random().toString(36).slice(2,6), data: agora, tipo: 'entrada', valor: valorParaCartao, contaId: bancoDestino.id, descricao: `Dep√≥sito Fatura (Do Dia)`, jornadaId: chaveJornada, isAutomatico: true });
                                        
                                        bancoDestino.saldo = toMoney(toCents(bancoDestino.saldo || 0) + toCents(valorParaCartao));
                                        listaPagamentosAlerta.push({nome: `Dep√≥sito (${bancoDestino.nome})`, valor: valorParaCartao});
                                    } else {
                                        listaPagamentosAlerta.push({nome: `Cart√£o (Mantido em Carteira)`, valor: valorParaCartao});
                                    }
                                    totalAlocado += valorParaCartao;
                                }

                                const saldoRestanteRealCents = toCents(lucroLiquidoReal); let saldoAtualCents = saldoRestanteRealCents;
                                if (saldoAtualCents > 0) {
                                    const metasReais = metasParaAnalise.filter(m => m.tipo !== 'credito');
                                    metasReais.sort((a,b) => getWeight(b) - getWeight(a));
                                    metasReais.forEach(meta => {
                                        if (saldoAtualCents <= 0) return;
                                        let valor = meta.custoDiario;
                                        let valorCents = toCents(valor);
                                        if (saldoAtualCents < valorCents) { valorCents = saldoAtualCents; valor = toMoney(valorCents); }
                                        saldoAtualCents -= valorCents;
                                        if (valor > 0) {
                                            meta.valorAtual = toMoney(toCents(meta.valorAtual||0) + valorCents);
                                            // üõ°Ô∏è TRANSFER√äNCIA EXPL√çCITA
                                            AppState.historicoTransacoes.push({ id: 'out-tx-'+Date.now(), data: agora, tipo: 'saida', valor: valor, contaId: 'AUTO_ID_CARTEIRA', descricao: `Aloca√ß√£o: ${meta.descricao}`, jornadaId: chaveJornada });
                                            AppState.historicoTransacoes.push({ id: 'in-tx-'+Date.now()+1, data: agora, tipo: 'entrada', valor: valor, contaId: meta.id, descricao: `Recebido da Carteira`, jornadaId: chaveJornada });
                                            listaPagamentosAlerta.push({nome: meta.descricao, valor: valor});
                                            totalAlocado += valor;
                                        }
                                    });
                                }

                                if (jornadaAtiva) { jornadaAtiva.status = 'finalizada'; jornadaAtiva.fimJornada = agora; }
                                Storage.salvarJornadas(); Storage.salvarConfiguracoes();
                                if(Storage.salvarTransacoes) Storage.salvarTransacoes();
                                AppState.activeJornadaChave = null; Storage.salvarJornadaAtiva();
                                localStorage.removeItem('driver_app_jornada_ativa');
                                const format = (v) => Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                                let msg = `\nüì¶ Distribui√ß√£o Realizada:\n`;
                                listaPagamentosAlerta.forEach(d => msg += `‚úÖ ${d.nome}: ${format(d.valor)}\n`);
                                alert(`üèÅ Jornada Finalizada!\n\nüí∞ Lucro L√≠quido: ${Utils.formatarMoeda(lucroLiquidoReal)}\nüì¶ Total Alocado: ${Utils.formatarMoeda(totalAlocado)}` + msg);
                                location.reload();
                            } catch (err) { alert(err); location.reload(); }
                        };
                   
                    
                    
                    }*/
                
                }, 100);
                break;
            }
   
   // 21. EDI√á√ÉO PLANO MESTRE (COMPLETO)
                case 'edicaoPlanoMestre': {
                    const item = options.item;
                    const catOpts = ['Motor','Freios','Pneus','Suspens√£o','El√©trico','Outro'].map(c => `<option ${c===item.categoria?'selected':''}>${c}</option>`).join('');
                    const acaoOpts = ['Trocar','Verificar','Limpar'].map(a => `<option ${a===item.acao?'selected':''}>${a}</option>`).join('');
                    const metasPoupanca = AppState.configuracoes.metasFinanceiras.filter(m => m.tipo==='poupanca'||m.tipo==='poupanca_km').map(m => `<option value="${m.id}" ${m.id===item.metaId?'selected':''}>${m.descricao}</option>`).join('');
                    
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-lg text-center shadow-xl space-y-4">
                            <h3 class="text-lg font-bold text-white">Editar Item do Plano</h3>
                            <div class="grid grid-cols-2 gap-3 text-left">
                                <div><label class="block text-xs text-slate-400">Categoria</label><select id="editPlanoCategoria" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white">${catOpts}</select></div>
                                <div><label class="block text-xs text-slate-400">A√ß√£o</label><select id="editPlanoAcao" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white">${acaoOpts}</select></div>
                            </div>
                            <div class="text-left"><label class="block text-xs text-slate-400">Descri√ß√£o</label><input type="text" id="editPlanoDescricao" value="${item.descricao}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white"></div>
                            <div class="grid grid-cols-2 gap-3 text-left">
                                <div><label class="block text-xs text-slate-400">Custo Est.</label><input type="text" id="editPlanoCusto" value="${Utils.formatarMoedaParaInput(item.custoEstimado)}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white"></div>
                                <div><label class="block text-xs text-slate-400">Vincular Caixinha</label><select id="editPlanoMetaVinculada" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white"><option value="">Nenhuma</option>${metasPoupanca}</select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-left">
                                <div><label class="block text-xs text-slate-400">Freq. KM</label><input type="number" id="editPlanoIntervaloKm" value="${item.intervaloKm}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white"></div>
                                <div><label class="block text-xs text-slate-400">Freq. Meses</label><input type="number" id="editPlanoIntervaloMeses" value="${item.intervaloMeses}" class="w-full bg-slate-700 border-slate-600 rounded p-2 text-white"></div>
                            </div>
                            <div class="text-left"><label class="block text-xs text-red-300">Observa√ß√£o</label><input type="text" id="editPlanoObservacao" value="${item.observacao||''}" class="w-full bg-slate-700 border-red-900/50 rounded p-2 text-white"></div>
                            <div class="flex justify-end gap-4 pt-2"><button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button><button class="btn-salvar-edicao-plano bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">Salvar</button></div>
                        </div>`;
                    AppState.itemParaEditarId = item.id;
                    break;
                }

                // 22. EDI√á√ÉO MANUTEN√á√ÉO SIMPLES
                case 'edicaoManutencao': {
                    const { item } = options;
                    modalHTML = `<div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4"><h3 class="text-lg font-bold text-white">Editar Alerta</h3><div><label class="block text-xs text-slate-400">Descri√ß√£o</label><input type="text" id="editManutencaoDescricao" value="${item.descricao}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div><label class="block text-xs text-slate-400">√öltimo KM</label><input type="number" id="editManutencaoUltimoKm" value="${item.ultimoKm}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div><label class="block text-xs text-slate-400">Intervalo</label><input type="number" id="editManutencaoIntervalo" value="${item.intervalo}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white"></div><div class="flex justify-end gap-4"><button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button><button class="btn-salvar-edicao-manutencao bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">Salvar</button></div></div>`;
                    AppState.itemParaEditarId = item.id;
                    break;
                }
// NOVO MODAL INTELIGENTE
// NOVO MODAL: VISUALIZAR CAIXINHA DE MANUTEN√á√ÉO (COMPLETO)
                case 'visualizarMetaManutencao': {
                    const { meta } = options;
                    
                    // 1. For√ßa sincroniza√ß√£o para garantir dados atualizados
                    BusinessLogic.sincronizarMetaManutencao(meta.id);
                    
                    // 2. Busca dados atualizados
                    const itens = AppState.configuracoes.planoManutencao.filter(i => i.metaId === meta.id);
                    const saldoTotal = BusinessLogic.calcularSaldoConta(meta.id);
                    
                    // 3. Prepara dados para a lista (C√°lculo de KM Faltante)
                    const historico = AppState.historicoManutencao;
                    const jornadaHoje = BusinessLogic.getJornadaDoDia(new Date());
                    const kmAtual = parseFloat(jornadaHoje.kmFinal || jornadaHoje.kmInicial) || 0;

                    // Mapeia e calcula status de cada item
                    const statusItens = itens.map(item => {
                        let kmFaltante = item.intervaloKm; // Valor padr√£o (se nunca foi feito)
                        
                        if (item.intervaloKm > 0 && kmAtual > 0) {
                            // Busca √∫ltimo servi√ßo deste tipo
                            const ultimos = historico
                                .filter(h => h.planoId === item.id)
                                .sort((a, b) => b.km - a.km);
                            
                            const ultimoKmFeito = ultimos.length > 0 ? ultimos[0].km : 0;
                            
                            // Calcula quanto falta
                            const kmProximaTroca = ultimoKmFeito + item.intervaloKm;
                            kmFaltante = kmProximaTroca - kmAtual;
                        }
                        
                        return { 
                            ...item, 
                            kmFaltante: kmFaltante, // Pode ser negativo se venceu
                            custo: item.custoEstimado || 0 
                        };
                    });

                    // 4. Ordena por Urg√™ncia (Menor KM Faltante primeiro)
                    // Isso √© vital para a l√≥gica Waterfall visual funcionar igual ao c√°lculo
                    statusItens.sort((a, b) => a.kmFaltante - b.kmFaltante);

                    // 5. Gera o HTML da Lista com L√≥gica Waterfall Visual
                    let saldoParaDistribuir = saldoTotal;
                    let itensHTML = '';

                    if (statusItens.length === 0) {
                        itensHTML = '<p class="text-center text-slate-500 italic py-4">Nenhum item vinculado a esta caixinha.</p>';
                    } else {
                        itensHTML = '<ul class="space-y-3 max-h-80 overflow-y-auto scrollable-content p-1">';
                        
                        statusItens.forEach(item => {
                            // Define quanto do saldo cobre este item
                            let coberto = 0;
                            if (saldoParaDistribuir >= item.custo) {
                                coberto = item.custo;
                                saldoParaDistribuir -= item.custo;
                            } else {
                                coberto = saldoParaDistribuir;
                                saldoParaDistribuir = 0;
                            }
                            
                            // Calcula porcentagem da barra
                            const percent = item.custo > 0 ? (coberto / item.custo) * 100 : 0;
                            
                            // Define cores e textos baseados no status
                            const isFull = percent >= 100;
                            const isVencido = item.kmFaltante < 0;
                            
                            let corBarra = isFull ? 'bg-emerald-500' : 'bg-amber-500';
                            let corTexto = isFull ? 'text-emerald-400' : 'text-amber-400';
                            let textoStatus = isFull ? 'Coberto' : 'Acumulando';
                            
                            if (isVencido) {
                                textoStatus = 'VENCIDO';
                                corTexto = 'text-red-400';
                            }

                            // Formata KM restante
                            let textoKm = '';
                            if (item.intervaloKm > 0) {
                                if (item.kmFaltante < 0) {
                                    textoKm = `Passou ${Utils.formatarDistancia(Math.abs(item.kmFaltante))}`;
                                } else {
                                    textoKm = `Faltam ${Utils.formatarDistancia(item.kmFaltante)}`;
                                }
                            } else {
                                textoKm = 'Sem controle de KM';
                            }

                            itensHTML += `
                                <li class="bg-slate-700 p-3 rounded-md text-sm relative overflow-hidden">
                                    <div class="flex justify-between items-center mb-1 relative z-10">
                                        <span class="font-bold text-white truncate w-2/3">${item.descricao}</span>
                                        <span class="text-xs ${corTexto} font-bold uppercase">${textoStatus}</span>
                                    </div>
                                    
                                    <div class="flex justify-between text-xs text-slate-300 mb-2 relative z-10">
                                        <span>${textoKm}</span>
                                        <span class="font-mono">${Utils.formatarMoeda(coberto)} / ${Utils.formatarMoeda(item.custo)}</span>
                                    </div>
                                    
                                    <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden relative z-10">
                                        <div class="h-full transition-all duration-500 ${corBarra}" style="width: ${percent}%"></div>
                                    </div>
                                    
                                    ${isVencido ? '<div class="absolute inset-0 border-2 border-red-500/30 rounded-md pointer-events-none"></div>' : ''}
                                </li>
                            `;
                        });
                        itensHTML += '</ul>';
                    }

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                                <h3 class="text-xl font-bold text-cyan-400 truncate pr-4">${meta.descricao}</h3>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="bg-slate-900 p-3 rounded-lg">
                                    <span class="text-xs text-slate-400 block">Saldo Atual</span>
                                    <span class="text-xl font-bold text-green-400">${Utils.formatarMoeda(saldoTotal)}</span>
                                </div>
                                <div class="bg-slate-900 p-3 rounded-lg">
                                    <span class="text-xs text-slate-400 block">Objetivo Total (Soma)</span>
                                    <span class="text-xl font-bold text-white">${Utils.formatarMoeda(meta.valorTotal)}</span>
                                </div>
                            </div>
                            
                            <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg flex justify-between items-center">
                                <span class="text-sm text-indigo-200">Taxa de Ac√∫mulo Atual:</span>
                                <span class="text-lg font-bold text-white">${Utils.formatarMoedaPorKm(meta.valorPorKm)}</span>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-semibold text-slate-300 mb-2">Status dos Itens (Ordem de Urg√™ncia):</h4>
                                ${itensHTML}
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg">Fechar</button>
                            </div>
                        </div>`;
                    break;
                } 
               // NOVO MODAL: OP√á√ïES DE IMPORTA√á√ÉO
                case 'importacaoOpcoes': {
                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4 text-center">
                            <div class="mb-4">
                                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-cyan-900/50 mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-white">Importar Dados</h3>
                                <p class="text-sm text-slate-400 mt-2">O arquivo foi lido. O que voc√™ deseja fazer?</p>
                            </div>
                            
                            <div class="space-y-3">
                                <button id="btn-importar-mesclar" class="w-full bg-gradient-to-r from-cyan-600 to-cyan-700 hover:from-cyan-700 hover:to-cyan-800 text-white font-bold py-3 px-4 rounded-lg transition highlight flex flex-col items-center justify-center">
                                    <span class="flex items-center gap-2">üîÑ Mesclar Dados (Recomendado)</span>
                                    <span class="text-[10px] font-normal opacity-80 mt-1">Mant√©m o que voc√™ j√° tem e adiciona o que falta.</span>
                                </button>
                                
                                <button id="btn-importar-substituir" class="w-full bg-slate-700 hover:bg-red-900/80 text-white font-bold py-3 px-4 rounded-lg transition flex flex-col items-center justify-center border border-slate-600 hover:border-red-500/50">
                                    <span class="flex items-center gap-2">‚ö†Ô∏è Substituir Tudo</span>
                                    <span class="text-[10px] font-normal opacity-80 mt-1">Apaga TUDO o que est√° na tela e usa o backup.</span>
                                </button>
                                
                                <button class="btn-cancelar w-full bg-transparent hover:bg-slate-700 text-slate-400 py-2 px-4 rounded-lg transition text-sm">
                                    Cancelar
                                </button>
                            </div>
                        </div>`;
                    break;
                }
// =================================================================
            // 23. VISUALIZAR CUSTOS MENSAIS (V12: POL√çTICA DE TRANSA√á√ÉO SEM√ÇNTICA)
            // =================================================================
            case 'visualizarCustosMensais': {
                AppState.modalContext = 'custosMensais';
                
                const metaId = options.meta ? options.meta.id : 'META_CUSTOS_MENSAIS';
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                const { contasBancarias } = AppState.configuracoes;

                if (!meta) return;

                // --- üõ°Ô∏è POL√çTICA DE TRANSA√á√ÉO (O PORTEIRO DE FERRO) ---
                // Define o que comp√µe o SALDO REAL DISPON√çVEL.
                // Tudo que for ajuste, estorno ou anula√ß√£o √© ignorado semanticamente aqui.
                const isTransacaoValida = (t) => {
                    if (!t) return false;

                    // 1. Flags de Sistema (Prioridade M√°xima)
                    if (t.invalida === true) return false;
                    if (t.anulada === true) return false;
                    if (t.isAjusteInterno === true) return false; // Flag nova (futuro)

                    // 2. Classifica√ß√£o Sem√¢ntica
                    // Se for um Estorno expl√≠cito, n√£o comp√µe saldo de provisionamento
                    // (Serve apenas para anular uma entrada anterior contabilmente)
                    if (t.categoria === 'Estorno') return false;
                    if (t.origem === 'ajuste') return false;

                    // 3. Tratamento de Texto (Legado/Visual)
                    const desc = t.descricao || '';
                    if (desc.includes('(Anulado)')) return false;
                    if (desc.includes('(Inv√°lido)')) return false;
                    if (desc.includes('Estorno de Reabertura')) return false; // Garante exclus√£o pelo nome

                    return true;
                };

                // --- üßÆ C√ÅLCULO DO SALDO REAL (Baseado na Pol√≠tica) ---
                const calcularSaldoRealDaMeta = (idMeta) => {
                    if (!AppState.historicoTransacoes) return 0;
                    
                    return AppState.historicoTransacoes
                        .filter(t => {
                            const ehDestaMeta = t.contaDestino === idMeta || t.contaId === idMeta;
                            // S√≥ passa se for dessa meta E passar na pol√≠tica de transa√ß√£o
                            return ehDestaMeta && isTransacaoValida(t);
                        })
                        .reduce((acc, t) => {
                            const valor = Number(t.valor) || 0;
                            // Entrada Real (Dep√≥sito/Aloca√ß√£o v√°lida)
                            if (t.contaDestino === idMeta) return acc + valor; 
                            // Sa√≠da Real (Pagamento de conta v√°lido)
                            if (t.contaId === idMeta) return acc - valor;      
                            return acc;
                        }, 0);
                };

                // 1. GERA√á√ÉO DO HTML
                let optionsBancos = `<option value="">-- Selecionar Banco Padr√£o --</option>`;
                optionsBancos += `<option value="AUTO_ID_CARTEIRA" ${meta.bancoId === 'AUTO_ID_CARTEIRA' ? 'selected' : ''}>üíµ Carteira (Dinheiro)</option>`;
                
                contasBancarias.forEach(c => {
                    if (c.tipo !== 'credito') {
                        const selected = meta.bancoId === c.id ? 'selected' : '';
                        optionsBancos += `<option value="${c.id}" ${selected}>${c.nome}</option>`;
                    }
                });

                modalHTML = `
                    <div class="bg-slate-800 rounded-lg p-6 w-full max-w-4xl shadow-xl flex flex-col max-h-[90vh]">
                        
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 border-b border-slate-700 pb-3 flex-shrink-0">
                            <div>
                                <h3 class="text-xl font-bold text-sky-400">üìâ Custos Fixos Mensais</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-slate-400">Pagar via:</span>
                                    <select id="select-banco-vinculado-custos" class="bg-slate-700 border border-slate-600 text-white text-xs rounded p-1 focus:ring-sky-500 focus:border-sky-500">
                                        ${optionsBancos}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-2 text-lg font-semibold bg-slate-900/50 px-3 py-1 rounded-full">
                                    <button id="btn-custo-mes-ant" class="p-1 text-slate-400 hover:text-white transition">‚Üê</button>
                                    <span id="custo-mes-ano-display" class="text-sm min-w-[100px] text-center">M√™s Atual</span>
                                    <button id="btn-custo-mes-prox" class="p-1 text-slate-400 hover:text-white transition">‚Üí</button>
                                </div>
                                <button class="btn-cancelar text-slate-400 hover:text-white text-2xl ml-2">√ó</button>
                            </div>
                        </div>

                        <div class="flex justify-center border-b border-slate-700 text-sm mb-4 flex-shrink-0">
                            <button class="custo-modal-tab-button py-2 px-4 font-semibold active border-b-2 border-sky-400 text-sky-400" data-tab="resumo">Resumo</button>
                            <button class="custo-modal-tab-button py-2 px-4 font-semibold text-slate-400 hover:text-white" data-tab="itens">Itens & Pesos</button>
                            <button class="custo-modal-tab-button py-2 px-4 font-semibold text-slate-400 hover:text-white" data-tab="detalhado">Detalhado</button>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                            
                            <div id="custo-modal-content-resumo" class="custo-modal-tab-pane space-y-4">
                                <div class="grid grid-cols-2 gap-3 text-center">
                                    <div class="bg-slate-700 p-3 rounded"><span class="block text-sm text-slate-400">Saldo Real</span><span id="custo-resumo-real" class="font-bold text-3xl text-green-400">...</span></div>
                                    <div class="bg-slate-700 p-3 rounded"><span class="block text-sm text-slate-400">Saldo Esperado</span><span id="custo-resumo-esperado" class="font-bold text-3xl text-cyan-400">...</span></div>
                                    <div class="bg-slate-700 p-3 rounded"><span class="block text-xs text-slate-400">Total Previsto</span><span id="custo-resumo-previsto" class="font-bold text-lg text-white">...</span></div>
                                    <div class="bg-slate-700 p-3 rounded"><span class="block text-xs text-slate-400">Total Sa√≠das</span><span id="custo-resumo-saidas" class="font-bold text-lg text-amber-400">...</span></div>
                                </div>
                                <div id="acelerador-container" class="p-4 bg-slate-700/50 rounded space-y-3 hidden"></div>
                            </div>
                            
                            <div id="custo-modal-content-itens" class="custo-modal-tab-pane space-y-4 hidden">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-white">Itens Fixos</h4>
                                    <button id="btn-add-item-custo-novo" class="text-xs bg-sky-600 hover:bg-sky-500 text-white px-3 py-1 rounded transition">+ Novo Item</button>
                                </div>
                                <ul id="lista-itens-custos-nova" class="space-y-2"></ul>
                            </div>

                            <div id="custo-modal-content-detalhado" class="custo-modal-tab-pane space-y-4 hidden">
                                <div class="flex justify-between items-center mb-2">
                                     <h4 class="text-sm font-bold text-white">Extrato Recente (V√°lidos)</h4>
                                     <button id="btn-ver-extrato-completo-custos" class="text-xs text-sky-400 hover:text-white underline">Ver Extrato Completo</button>
                                </div>
                                <ul id="lista-detalhada-custos" class="space-y-2 text-xs"></ul>
                            </div>
                        </div>
                        
                        <div class="p-4 border-t border-slate-700 flex justify-end gap-3 flex-shrink-0 mt-2">
                             <button class="btn-cancelar py-2 px-4 rounded bg-slate-700 text-white hover:bg-slate-600 transition">Fechar</button>
                        </div>
                    </div>`;
                
                AppState.itemParaEditarId = meta.id;

                const container = document.getElementById('modalContainer');
                if (container) {
                    container.innerHTML = modalHTML;
                    container.classList.remove('hidden');

                    setTimeout(() => {
                        const safeSetText = (id, text) => {
                            const el = document.getElementById(id);
                            if (el) el.textContent = text;
                        };

                        // 1. TABS
                        const tabs = container.querySelectorAll('.custo-modal-tab-button');
                        const panes = container.querySelectorAll('.custo-modal-tab-pane');
                        tabs.forEach(tab => {
                            tab.onclick = () => {
                                tabs.forEach(t => {
                                    t.classList.remove('active', 'border-b-2', 'border-sky-400', 'text-sky-400');
                                    t.classList.add('text-slate-400');
                                });
                                tab.classList.add('active', 'border-b-2', 'border-sky-400', 'text-sky-400');
                                tab.classList.remove('text-slate-400');
                                
                                panes.forEach(p => p.classList.add('hidden'));
                                const target = document.getElementById(`custo-modal-content-${tab.dataset.tab}`);
                                if(target) target.classList.remove('hidden');
                            };
                        });

                        // 2. PREENCHIMENTO DE DADOS (USANDO POL√çTICA SEM√ÇNTICA)
                        const saldoRealCalculado = calcularSaldoRealDaMeta(meta.id);
                        
                        // IMPORTANTE: N√£o atualizamos o estado global aqui para evitar efeitos colaterais (leitura pura)
                        
                        const hoje = new Date();
                        const diasNoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).getDate();
                        const diaAtual = hoje.getDate();
                        
                        const itens = meta.itens || [];
                        const totalMensal = itens.reduce((acc, i) => acc + (Number(i.valor)||0), 0);
                        
                        const custoDiario = totalMensal / diasNoMes;
                        
                        // Ajuste inteligente: Saldo Esperado nunca deve ser maior que o Total
                        const esperadoHoje = Math.min(totalMensal, custoDiario * diaAtual);
                        
                        // Atualiza UI
                        safeSetText('custo-resumo-real', Utils.formatarMoeda(saldoRealCalculado));
                        safeSetText('custo-resumo-esperado', Utils.formatarMoeda(esperadoHoje));
                        safeSetText('custo-resumo-previsto', Utils.formatarMoeda(totalMensal));
                        
                        // 3. LISTA DE ITENS
                        const listaItens = document.getElementById('lista-itens-custos-nova');
                        if (listaItens) {
                            listaItens.innerHTML = itens.length ? itens.map((item, idx) => `
                                <li class="flex justify-between items-center bg-slate-700/30 p-2 rounded border border-slate-700">
                                    <span class="text-white text-sm">${item.descricao}</span>
                                    <div class="flex gap-3 items-center">
                                        <span class="font-bold text-amber-100">${Utils.formatarMoeda(item.valor)}</span>
                                        <button class="text-slate-500 hover:text-red-400 btn-del-item" data-idx="${idx}">&times;</button>
                                    </div>
                                </li>
                            `).join('') : '<li class="text-center text-slate-500">Nenhum item cadastrado.</li>';
                            
                            const btnAdd = document.getElementById('btn-add-item-custo-novo');
                            if(btnAdd) {
                                btnAdd.onclick = () => {
                                    const desc = prompt("Nome do Custo:");
                                    const valStr = prompt("Valor Mensal:");
                                    if(desc && valStr) {
                                        const val = Utils.parseMoeda(valStr);
                                        if(!meta.itens) meta.itens = [];
                                        meta.itens.push({descricao: desc, valor: val});
                                        meta.valorTotal = meta.itens.reduce((acc, i) => acc + i.valor, 0);
                                        Storage.salvarConfiguracoes();
                                        UIRenderer.abrirModal('visualizarCustosMensais', { meta });
                                    }
                                };
                            }
                            
                            container.querySelectorAll('.btn-del-item').forEach(btn => {
                                btn.onclick = (e) => {
                                    if(confirm("Remover este custo fixo?")) {
                                        meta.itens.splice(e.target.dataset.idx, 1);
                                        meta.valorTotal = meta.itens.reduce((acc, i) => acc + i.valor, 0);
                                        Storage.salvarConfiguracoes();
                                        UIRenderer.abrirModal('visualizarCustosMensais', { meta });
                                    }
                                };
                            });
                        }

                        // 4. DETALHADO (Usa a mesma regra de valida√ß√£o)
                        const listaDetalhada = document.getElementById('lista-detalhada-custos');
                        if(listaDetalhada) {
                            const transacoesRecentes = AppState.historicoTransacoes
                                .filter(t => {
                                    const ehDestaMeta = t.contaDestino === meta.id || t.contaId === meta.id;
                                    return ehDestaMeta && isTransacaoValida(t); // Filtra visualmente tamb√©m
                                })
                                .slice(-10).reverse();
                                
                            listaDetalhada.innerHTML = transacoesRecentes.length ? transacoesRecentes.map(t => {
                                const isEntrada = t.contaDestino === meta.id;
                                const cor = isEntrada ? 'text-green-400' : 'text-red-400';
                                return `<li class="flex justify-between border-b border-slate-700/50 pb-1">
                                    <span>${Utils.formatarDataParaDisplay(new Date(t.data))} - ${t.descricao}</span>
                                    <span class="${cor}">${isEntrada ? '+' : '-'} ${Utils.formatarMoeda(t.valor)}</span>
                                </li>`;
                            }).join('') : '<li class="text-center text-slate-500">Sem movimenta√ß√µes v√°lidas recentes.</li>';
                            
                            // Bot√£o Extrato Completo (Tamb√©m usa a pol√≠tica)
                            const btnExtratoFull = document.getElementById('btn-ver-extrato-completo-custos');
                            if(btnExtratoFull) {
                                btnExtratoFull.onclick = () => {
                                    UIRenderer.fecharModal();
                                    
                                    // Filtra usando a MESMA pol√≠tica do porteiro
                                    const transacoesFiltradas = AppState.historicoTransacoes.filter(t => {
                                        const ehDestaMeta = t.contaDestino === meta.id || t.contaId === meta.id;
                                        return ehDestaMeta && isTransacaoValida(t);
                                    });

                                    UIRenderer.abrirModal('extratoConta', {
                                        contaId: 'META_CUSTOS_MENSAIS',
                                        contaNome: 'üìâ Custos Fixos Mensais',
                                        transacoes: transacoesFiltradas, // Passa limpo
                                        saldoFinal: saldoRealCalculado   // Passa calculado
                                    });
                                };
                            }
                        }

                        // 5. CANCELAR E BANCOS
                        container.querySelectorAll('.btn-cancelar').forEach(b => b.onclick = () => UIRenderer.fecharModal());
                        const selectBanco = document.getElementById('select-banco-vinculado-custos');
                        if (selectBanco) {
                            selectBanco.addEventListener('change', (e) => {
                                meta.bancoId = e.target.value;
                                Storage.salvarConfiguracoes();
                            });
                        }

                    }, 50);
                }
                break;
            }



// NOVO CASE: CRIAR/EDITAR SUBCATEGORIA (COM URL)
// Substitua o case 'salvarSubcategoria' dentro de abrirModal:
                case 'salvarSubcategoria': {
                    const { categoriaPai, nomeAtual, iconeAtual, corAtual, isEdicao } = options; // <--- RECEBE corAtual
                    
                    // Verifica se √© URL
                    const isUrl = (iconeAtual && (iconeAtual.startsWith('http') || iconeAtual.startsWith('data:image')));
                    const urlValue = isUrl ? iconeAtual : '';
                    const selectValue = isUrl ? '' : (iconeAtual || '');

                    // √çcones padr√£o
                    const iconesOpcoes = [
                        {v: '', t: 'Padr√£o da Categoria'}, 
                        {v: '‚≠ê', t: 'Estrela'}, {v: '‚ù§Ô∏è', t: 'Cora√ß√£o'}, 
                        {v: 'üíµ', t: 'Dinheiro'}, {v: 'üí≥', t: 'Cart√£o'},
                        {v: 'üöó', t: 'Carro'}, {v: 'üèçÔ∏è', t: 'Moto'},
                        {v: 'üì¶', t: 'Caixa'}, {v: 'üçî', t: 'Comida'},
                        {v: 'üè†', t: 'Casa'}, {v: 'üè¢', t: 'Escrit√≥rio'},
                        {v: 'üë§', t: 'Particular'}, {v: '‚úàÔ∏è', t: 'Aeroporto'}
                    ];
                    
                    const iconesHTML = iconesOpcoes.map(opt => 
                        `<option value="${opt.v}" ${opt.v === selectValue ? 'selected' : ''}>${opt.v} ${opt.t}</option>`
                    ).join('');
                    
                    const titulo = isEdicao ? 'Editar Subcategoria' : 'Nova Subcategoria';
                    const corPadrao = '#818cf8';
                    const valorCor = corAtual || corPadrao; // <--- Cor atual ou padr√£o

                    modalHTML = `
                        <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl space-y-4">
                            <h3 class="text-xl font-bold text-white">${titulo}</h3>
                            
                            <input type="hidden" id="sub-is-edicao" value="${isEdicao ? 'true' : 'false'}">
                            <input type="hidden" id="sub-nome-original" value="${nomeAtual || ''}">
                            
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Categoria Pai</label>
                                <select id="sub-categoria-pai" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white" ${isEdicao ? 'disabled' : ''}>
                                    <option value="Corrida" ${categoriaPai === 'Corrida' ? 'selected' : ''}>Corrida</option>
                                    <option value="Entrega" ${categoriaPai === 'Entrega' ? 'selected' : ''}>Entrega</option>
                                    <option value="Outro" ${categoriaPai === 'Outro' ? 'selected' : ''}>Outro</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-4 gap-3">
                                <div class="col-span-3">
                                    <label class="block text-xs text-slate-400 mb-1">Nome</label>
                                    <input type="text" id="sub-nome" value="${nomeAtual || ''}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white" placeholder="Ex: Uber Black">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Cor</label>
                                    <input type="color" id="sub-cor" value="${valorCor}" class="w-full h-[46px] bg-slate-700 border-slate-600 rounded p-1 cursor-pointer">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 gap-3 pt-2 border-t border-slate-700">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">√çcone (Lista R√°pida)</label>
                                    <select id="sub-icone-select" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white h-[50px]">
                                        ${iconesHTML}
                                    </select>
                                </div>
                                <div class="text-center text-xs text-slate-500 font-bold">- OU -</div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">URL de Imagem (Priorit√°rio)</label>
                                    <input type="text" id="sub-icone-url" value="${urlValue}" class="w-full bg-slate-700 border-slate-600 rounded p-3 text-white" placeholder="https://exemplo.com/logo.png">
                                </div>
                            </div>

                            <div class="flex justify-end gap-4 pt-2">
                                <button class="btn-cancelar bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                                <button id="btn-confirmar-salvar-sub" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">Salvar</button>
                            </div>
                        </div>`;
                    break;
                }
                // --- DEFAULT ---
                default:
                    console.log("Tipo de modal desconhecido:", type);
                    return;
            }

            if (modalHTML) {
                UIElements.modalContainer.innerHTML = modalHTML;
                UIElements.modalContainer.classList.remove('hidden');
                setTimeout(() => {
                    const input = UIElements.modalContainer.querySelector('input');
                    if (input) input.focus();
                    
                    // Re-inject listeners
                    if (type === 'finalizarServico' || type === 'edicaoAtividade') {
                         const editCategoriaSelect = document.getElementById('editCategoria');
                         const editSubcategoriaSelect = document.getElementById('editSubcategoria');
                         if (editCategoriaSelect && editSubcategoriaSelect) {
                             const updateSub = () => {
                                 const subs = AppState.configuracoes.subcategorias[editCategoriaSelect.value] || [];
                                 editSubcategoriaSelect.innerHTML = '<option value="">Nenhuma</option>';
                                 subs.forEach(s => editSubcategoriaSelect.innerHTML += `<option value="${s.nome}">${s.nome}</option>`);
                                 if(type === 'finalizarServico') {
                                     const part = document.getElementById('containerViagemParticular');
                                     if(part) part.classList.toggle('hidden', editCategoriaSelect.value !== 'Particular');
                                 }
                                 if(type === 'edicaoAtividade') {
                                     const partRecibo = document.getElementById('edit-recibo-container');
                                     if(partRecibo) partRecibo.classList.toggle('hidden', editCategoriaSelect.value !== 'Particular');
                                 }
                             };
                             editCategoriaSelect.addEventListener('change', updateSub);
                             updateSub();
                             if (options.item.subcategoria) editSubcategoriaSelect.value = options.item.subcategoria;
                         }
                    }
                }, 300);
            }
            // --- L√≥gica de listeners p√≥s-renderiza√ß√£o ---

            if (type === 'calculadoras') {
                const tabs = document.querySelectorAll('.calc-tab-button');
                tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        tabs.forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('.calc-tab-pane').forEach(pane => pane.classList.add('hidden'));
                        document.getElementById(`calc-tab-content-${e.target.dataset.tab}`).classList.remove('hidden');
                    });
                });
                const btnAddParada = document.getElementById('btn-add-parada');
                if (btnAddParada) {
                    btnAddParada.addEventListener('click', EventHandlers.handleAddParadaCotacao);
                }
            }
            
            if (type === 'finalizarServico' && options.isServicoRapido) {
                const editCategoriaSelect = document.getElementById('editCategoria');
                const editSubcategoriaSelect = document.getElementById('editSubcategoria');
            
                const updateSubcatOptions = () => {
                    const selectedCat = editCategoriaSelect.value;
                    const subcatContainer = editSubcategoriaSelect.parentElement; 
                    const subcats = AppState.configuracoes.subcategorias[selectedCat] || [];
                    
                    if (selectedCat === 'Particular') {
                        subcatContainer.classList.add('hidden');
                    } else {
                        subcatContainer.classList.remove('hidden');
                        editSubcategoriaSelect.innerHTML = '<option value="">Nenhuma</option>';
                        subcats.forEach(s => {
                            editSubcategoriaSelect.innerHTML += `<option value="${s.nome}">${s.nome}</option>`;
                        });
                    }
                };
            
                const particularContainer = document.getElementById('containerViagemParticular');
                const statusPagamentoSelect = document.getElementById('editStatusPagamento');
                const vencimentoContainer = document.getElementById('containerDataVencimento');
                const btnSalvar = document.querySelector('.btn-salvar-finalizacao');

                const toggleParticularFields = () => {
                    if (editCategoriaSelect.value === 'Particular') {
                        particularContainer.classList.remove('hidden');
                        toggleVencimentoField();
                    } else {
                        particularContainer.classList.add('hidden');
                    }
                };

                const toggleVencimentoField = () => {
                    const isPendente = statusPagamentoSelect.value === 'pendente';
                    const isParticular = editCategoriaSelect.value === 'Particular';

                    vencimentoContainer.classList.toggle('hidden', !isPendente);

                    if (isPendente) {
                        btnSalvar.textContent = 'Salvar Pend√™ncia';
                        btnSalvar.classList.replace('bg-red-600', 'bg-amber-600');
                        btnSalvar.classList.replace('hover:bg-red-700', 'hover:bg-amber-700');
                    } else {
                        btnSalvar.textContent = isParticular ? 'Finalizar e Recibo' : 'Finalizar';
                        btnSalvar.classList.replace('bg-amber-600', 'bg-red-600');
                        btnSalvar.classList.replace('hover:bg-amber-700', 'hover:bg-red-700');
                    }
                };
                
                editCategoriaSelect.addEventListener('change', () => {
                    updateSubcatOptions();
                    toggleParticularFields();
                });
                statusPagamentoSelect.addEventListener('change', toggleVencimentoField);

                updateSubcatOptions();
                toggleParticularFields();
            }

            if (type === 'edicaoAtividade') {
                const editCategoriaSelect = document.getElementById('editCategoria');
                const editSubcategoriaSelect = document.getElementById('editSubcategoria');
                
                const updateSubcatOptions = () => {
                    const selectedCat = editCategoriaSelect.value;
                    const subcats = AppState.configuracoes.subcategorias[selectedCat] || [];
                    editSubcategoriaSelect.innerHTML = '<option value="">Nenhuma</option>';
                    subcats.forEach(s => {
                        const selected = s.nome === options.item.subcategoria ? 'selected' : '';
                        editSubcategoriaSelect.innerHTML += `<option value="${s.nome}" ${selected}>${s.nome}</option>`;
                    });
                };
                updateSubcatOptions();
                editCategoriaSelect.addEventListener('change', updateSubcatOptions);
            }

            const ignorarCheckbox = document.getElementById('ignorarKmInicial');
            const inicialKmInput = document.getElementById('inicialKmServico');

            if (ignorarCheckbox && inicialKmInput) {
                ignorarCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    inicialKmInput.disabled = isChecked;
                    inicialKmInput.classList.toggle('opacity-50', isChecked);
                    inicialKmInput.classList.toggle('cursor-not-allowed', isChecked);
                });
            }
        },
       
       
       fecharModal: () => {
            // --- CORRE√á√ÉO SIST√äMICA: LIMPEZA DE SESS√ÉO ---
            // Remove o ID de idempot√™ncia ao fechar o modal (sucesso ou cancelamento)
            // Isso garante que a pr√≥xima abertura gere um novo ID limpo.
            const oldId = document.getElementById('modal-request-id');
            if (oldId) oldId.remove();

            UIElements.modalContainer.classList.add('hidden');
            UIElements.modalContainer.innerHTML = '';
            AppState.onConfirmCallback = null;
            AppState.itemParaEditarId = null;
            AppState.modalContext = null;
            
            // Remove classes de processamento caso o modal tenha sido fechado for√ßadamente
            const btns = document.querySelectorAll('[data-processing]');
            btns.forEach(btn => {
                btn.removeAttribute('data-processing');
                btn.classList.remove('opacity-50', 'cursor-wait');
            });
        },
    }
// ============================================================================
    // TIME MANAGER ‚Äî GOLD v8.1 (DELTA CORE + SEM√ÇNTICA H√çBRIDA + COMPATIBILIDADE)
    // ============================================================================
    const TimeManager = {
        interval: null,

        iniciarCronometro: () => {
            if (TimeManager.interval) clearInterval(TimeManager.interval);

            // Marco Zero absoluto (Delta Time - Imune a pausas)
            if (!AppState.jornadaInicio) {
                const saved = localStorage.getItem('jornada_inicio_timestamp');
                if (saved) {
                    AppState.jornadaInicio = parseInt(saved);
                } else {
                    const j = BusinessLogic.getJornadaAtiva();
                    if (j && j.inicioJornada) {
                        AppState.jornadaInicio = new Date(j.inicioJornada).getTime();
                        localStorage.setItem('jornada_inicio_timestamp', AppState.jornadaInicio);
                    }
                }
            }

            const tick = () => {
                const jornada = BusinessLogic.getJornadaAtiva();
                if (!jornada || !AppState.jornadaInicio) {
                    TimeManager.pararCronometro();
                    return;
                }

                const agora = Date.now();
                const modo = AppState.configuracoes.cronometroModo || 'liquido';

                // --- BASE DELTA ---
                const tempoTotal = agora - AppState.jornadaInicio;

                let tempoPausado = 0;
                if (jornada.pausas && jornada.pausas.length > 0) {
                    tempoPausado = jornada.pausas.reduce((acc, p) => {
                        const ini = new Date(p.inicio).getTime();
                        const fim = p.fim ? new Date(p.fim).getTime() : agora;
                        return acc + (fim - ini);
                    }, 0);
                }

                let tempoCalculado;

                // --- CAMADA SEM√ÇNTICA ---
                if (modo === 'liquido') {
                    tempoCalculado = tempoTotal - tempoPausado - (jornada.tempoInativoAcumulado || 0);
                    TimeManager._setVisual('liquido', jornada.status);
                } 
                else if (modo === 'hibrido') {
                    tempoCalculado = tempoTotal - tempoPausado;
                    TimeManager._setVisual('hibrido', jornada.status);
                } 
                else { // bruto
                    tempoCalculado = tempoTotal;
                    TimeManager._setVisual('bruto', jornada.status);
                }

                tempoCalculado = Math.max(0, tempoCalculado);

                if (UIElements.tempoJornada) {
                    UIElements.tempoJornada.textContent = Utils.formatarDuracao(tempoCalculado);
                }

                // --- REL√ìGIO DE PAUSA ---
                if (jornada.status === 'em_pausa') {
                    // Compatibilidade: usa length-1 em vez de at(-1)
                    const pausaAtual = jornada.pausas[jornada.pausas.length - 1];
                    if (pausaAtual && UIElements.tempoPausa) {
                        UIElements.tempoPausa.textContent = Utils.formatarDuracao(agora - new Date(pausaAtual.inicio));
                    }
                }

                // --- SERVI√áOS ---
                if (jornada.servicosEmAndamento && jornada.servicosEmAndamento.length > 0) {
                    jornada.servicosEmAndamento.forEach(s => {
                        const el = document.querySelector(`.servico-em-andamento-timer[data-id="${s.id}"]`);
                        if (el) el.textContent = Utils.formatarDuracao(agora - new Date(s.inicio));
                    });
                }

                // --- DASHBOARD (OTIMIZADO) ---
                if (!document.hidden && AppState.isToday) {
                    const deveAtualizar = modo === 'liquido' || Math.floor(agora / 1000) % 10 === 0;
                    if (deveAtualizar) {
                        UIRenderer.renderResumoDia(jornada);
                    }
                }
            };

            tick();
            TimeManager.interval = setInterval(tick, 1000);
        },

        pararCronometro: () => {
            if (TimeManager.interval) clearInterval(TimeManager.interval);
            TimeManager.interval = null;

            const jornada = BusinessLogic.getJornadaAtiva();
            if (!jornada) {
                AppState.jornadaInicio = null;
                localStorage.removeItem('jornada_inicio_timestamp');
            }
        },

        handleVisibilityChange: () => {
            if (!document.hidden) {
                // VOLTOU: Recalcula Delta Imediatamente
                TimeManager.iniciarCronometro();
                UIRenderer.render();

                const j = BusinessLogic.getJornadaAtiva();
                if (j && j.status === 'ativa' && AppState.configuracoes.usarGpsTracking) {
                    const ultimoKm = j.kmFinal || j.kmInicial || 0;
                    GpsTracker.startTracking(ultimoKm);
                }
            } else {
                // SAIU: Para o loop visual (mas o Delta continua valendo)
                TimeManager.pararCronometro();
                if (AppState.isGpsTracking) GpsTracker.stopTracking();
            }
        },

        _setVisual: (modo, status) => {
            if (!UIElements.tempoJornada) return;
            
            // Limpa tudo
            UIElements.tempoJornada.classList.remove('text-green-400', 'text-cyan-400', 'text-white', 'text-yellow-400');

            // Prioridade: Status Pausa Amarelo
            if (status === 'em_pausa') {
                UIElements.tempoJornada.classList.add('text-yellow-400');
                return;
            }

            if (modo === 'liquido') UIElements.tempoJornada.classList.add('text-green-400');
            else if (modo === 'hibrido') UIElements.tempoJornada.classList.add('text-cyan-400');
            else UIElements.tempoJornada.classList.add('text-white');
        }
    };
    
// =============================================================
    // ROADMAP RENDERER V45.1 (MASTER RELEASE - FULL CODE)
    // =============================================================
    const RoadmapRenderer = {
        
        // --- 1. BIBLIOTECA DE √çCONES (SVGs) ---
        icons: {
            fuel: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.75 2a.75.75 0 00-.75.75V4.5h-3A2.75 2.75 0 009.25 7.25v2.663c0 .326.03.65.088.965l-3.27 3.27a.75.75 0 000 1.06l.884.884a.75.75 0 001.06 0l3.27-3.27c.315.058.64.088.965.088h2.663A2.75 2.75 0 0017.75 10v-3A2.75 2.75 0 0015 4.25V2.75a.75.75 0 00-.75-.75h-1.5zM12 5.75V4.5h1.25A1.25 1.25 0 0114.5 5.75v3A1.25 1.25 0 0113.25 10h-2.663c-.11 0-.218-.014-.324-.04L13.5 6.724a.75.75 0 00-1.06-1.06L9.217 8.888A4.232 4.232 0 019.25 8.75h3A1.25 1.25 0 0113.5 7.5v-3A1.25 1.25 0 0112.25 3H12v2.75z" clip-rule="evenodd" /><path d="M4.09 10.09a2.25 2.25 0 103.182 3.182 2.25 2.25 0 00-3.182-3.182Zm1.06 2.122a.75.75 0 111.06-1.06.75.75 0 01-1.06 1.06Z" /></svg>`,
            service: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 4H4v7h12V8z" clip-rule="evenodd" /></svg>`,
            maintenance: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.835 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.835 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.835-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>`,
            future: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>`
        },

        iconMap: {
            'default': '‚öôÔ∏è', 'servico-Corrida': 'üöó', 'servico-Entrega': 'üì¶', 'servico-Outro': 'SERVICE', 'servico-Particular': 'üë§',
            'saida-Abastecimento': 'FUEL', 'saida-Alimenta√ß√£o': 'üçî', 'saida-Ve√≠culo': 'WRENCH', 'saida-Pessoal': 'üõçÔ∏è',
            'manutencao-Motor': 'ENGINE', 'manutencao-Freios': 'BRAKE', 'manutencao-Pneus': 'TIRE', 'manutencao-Suspens√£o': 'SUSPENSION',
            'manutencao-El√©trico': 'üîã', 'manutencao-Arrefecimento': 'TEMP', 'servico-Gorjeta': 'COIN', 
            'transferencia-caixinha-META_CUSTOS_MENSAIS': 'LIST', 'transferencia-banco': 'EXCHANGE', 'ajuste-saldo-AUTO_ID_CARTEIRA': 'ADJUST'
        },

        svgIcons: {
            FUEL: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.75 2a.75.75 0 00-.75.75V4.5h-3A2.75 2.75 0 009.25 7.25v2.663c0 .326.03.65.088.965l-3.27 3.27a.75.75 0 000 1.06l.884.884a.75.75 0 001.06 0l3.27-3.27c.315.058.64.088.965.088h2.663A2.75 2.75 0 0017.75 10v-3A2.75 2.75 0 0015 4.25V2.75a.75.75 0 00-.75-.75h-1.5zM12 5.75V4.5h1.25A1.25 1.25 0 0114.5 5.75v3A1.25 1.25 0 0113.25 10h-2.663c-.11 0-.218-.014-.324-.04L13.5 6.724a.75.75 0 00-1.06-1.06L9.217 8.888A4.232 4.232 0 019.25 8.75h3A1.25 1.25 0 0113.5 7.5v-3A1.25 1.25 0 0112.25 3H12v2.75z" clip-rule="evenodd" /><path d="M4.09 10.09a2.25 2.25 0 103.182 3.182 2.25 2.25 0 00-3.182-3.182Zm1.06 2.122a.75.75 0 111.06-1.06.75.75 0 01-1.06 1.06Z" /></svg>`,
            WRENCH: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.835 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.835 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.835-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>`,
            SERVICE: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 4H4v7h12V8z" clip-rule="evenodd" /></svg>`,
            ENGINE: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 10.84V14a.75.75 0 0 1-1.5 0v-3.16c0-.36.18-.69.49-.88l1.76-1.07a.75.75 0 1 1 .7 1.22l-1.16.7c-.12.07-.2.2-.2.33Z" /><path fill-rule="evenodd" d="M9.664 1.632a.75.75 0 0 1 .672 0l6.25 2.5a.75.75 0 0 1 .45 1.025l-2.5 6.25a.75.75 0 0 1-1.025.45l-6.25-2.5a.75.75 0 0 1-.45-1.025l2.5-6.25a.75.75 0 0 1 .853-.45Zm.93 1.254L4.75 5.313 7.03 10.9l5.844-2.427L10.593 2.886Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M5.5 13.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 0 1.5h-3.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M3 10a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5A.75.75 0 0 1 3 10Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M15.25 10.75a.75.75 0 0 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5h1.5Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M12 13.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 0 1.5h-3.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M8.75 16a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg>`,
            BRAKE: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12ZM8.5 10a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5Z" clip-rule="evenodd" /><path d="M10 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 10 3Zm0 13a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Zm-5-6.5a.5.5 0 0 0-.5.5h-1a.5.5 0 0 0 0 1h1a.5.5 0 0 0 .5-.5Zm10 0a.5.5 0 0 1 .5.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5Z" /></svg>`,
            TIRE: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7.41 17.518C8.58 18.49 9.98 19 11.5 19c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5c0 1.14.38 2.19.99 3.018l-4.14 2.65A9.95 9.95 0 0 1 1.5 14C1.5 8.2 6.2 3.5 12 3.5s10.5 4.7 10.5 10.5c0 2.22-.69 4.28-1.86 6.018l-4.22-2.698Z" /><path d="M11.5 17c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3Z" /></svg>`,
            SUSPENSION: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.75a.75.75 0 0 0-1.5 0v2.434l-3.32-1.423a.75.75 0 0 0-.911.213l-1.75 2.5a.75.75 0 0 0 .322 1.014l3.32 1.423v2.172l-3.32 1.423a.75.75 0 0 0-.322 1.014l1.75 2.5a.75.75 0 0 0 .911.213l3.32-1.423v2.434a.75.75 0 0 0 1.5 0v-2.434l3.32 1.423a.75.75 0 0 0 .911-.213l1.75-2.5a.75.75 0 0 0-.322-1.014l-3.32-1.423V9.934l3.32-1.423a.75.75 0 0 0 .322-1.014l-1.75-2.5a.75.75 0 0 0-.911-.213L10 6.184V3.75Z" /></svg>`,
            TEMP: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.12 3.28C10.82 2.49 11.9 2 13 2c2.21 0 4 1.79 4 4 0 1.04-.4 1.98-1.07 2.73l-4.06 4.64a.75.75 0 0 1-1.12 0L6.7 8.73C6.04 7.98 5.64 7.04 5.64 6c0-2.21 1.79-4 4-4 .99 0 1.93.36 2.64 1.01l-.16.17Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10.88 12.72a.75.75 0 0 1-1.12 0l-4.06-4.64C5.02 7.15 4.14 6.16 4.14 5c0-3.04 2.46-5.5 5.5-5.5 1.57 0 3.02.66 4.03 1.73l-.17.17C12.52.4 11.3 0 10 0 6.96 0 4.5 2.46 4.5 5.5c0 1.05.5 2.08 1.28 2.92l4.06 4.64a.75.75 0 0 0 1.12 0l4.06-4.64c.78-.84 1.28-1.87 1.28-2.92 0-3.04-2.46-5.5-5.5-5.5-1.19 0-2.3.38-3.27 1.01l-.16-.17A5.46 5.46 0 0 1 10 1.5c1.4 0 2.68.53 3.64 1.4l.17.17A5.46 5.46 0 0 1 17.5 8.5c0 1.12-.53 2.18-1.4 3.01l-4.06 4.64Z" clip-rule="evenodd" /><path d="M10 18a.5.5 0 0 1-.5-.5v-6.5a.5.5 0 0 1 1 0v6.5a.5.5 0 0 1-.5-.5Z" /><path d="M8.5 17.5a.5.5 0 0 1-.5-.5v-2.5a.5.5 0 0 1 1 0v2.5a.5.5 0 0 1-.5-.5Z" /><path d="M11.5 17.5a.5.5 0 0 1-.5-.5v-2.5a.5.5 0 0 1 1 0v2.5a.5.5 0 0 1-.5-.5Z" /></svg>`,
            WALLET: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5V6h18v-.5A1.5 1.5 0 0017.5 4h-15zM19 8.5H1v6A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-6zM3 13.25a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>`,
            CHART: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd" /></svg>`,
            LIST: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 003 3.5v13A1.5 1.5 0 004.5 18h11a1.5 1.5 0 001.5-1.5V7.621a1.5 1.5 0 00-.44-1.06l-4.12-4.122A1.5 1.5 0 0011.378 2H4.5zm2.25 8.5a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 3a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5z" clip-rule="evenodd" /></svg>`,
            EXCHANGE: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.24 6.8a.75.75 0 001.06-.04l1.95-2.1v8.59a.75.75 0 001.5 0V4.66l1.95 2.1a.75.75 0 101.1-1.02l-3.25-3.5a.75.75 0 00-1.1 0L2.2 5.74a.75.75 0 00.04 1.06zm8 6.4a.75.75 0 00-.04 1.06l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75a.75.75 0 00-1.5 0v8.59l-1.95-2.1a.75.75 0 00-1.06-.04z" clip-rule="evenodd" /></svg>`,
            ADJUST: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>`,
            COIN: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v12M16 9.5c0-1.38-1.79-2.5-4-2.5s-4 1.12-4 2.5 1.79 2.5 4 2.5 4 1.12 4 2.5-1.79 2.5-4 2.5-4-1.12-4-2.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
        },

        iconMap: {
            'default': '‚öôÔ∏è', 'servico-Corrida': 'üöó', 'servico-Entrega': 'üì¶', 'servico-Outro': 'SERVICE', 'servico-Particular': 'üë§',
            'saida-Abastecimento': 'FUEL', 'saida-Alimenta√ß√£o': 'üçî', 'saida-Ve√≠culo': 'WRENCH', 'saida-Pessoal': 'üõçÔ∏è',
            'manutencao-Motor': 'ENGINE', 'manutencao-Freios': 'BRAKE', 'manutencao-Pneus': 'TIRE', 'manutencao-Suspens√£o': 'SUSPENSION',
            'manutencao-El√©trico': 'üîã', 'manutencao-Arrefecimento': 'TEMP', 'servico-Gorjeta': 'COIN', 
            'transferencia-caixinha-META_CUSTOS_MENSAIS': 'LIST', 'transferencia-banco': 'EXCHANGE', 'ajuste-saldo-AUTO_ID_CARTEIRA': 'ADJUST'
        },

        // --- 2. HELPERS ---
        getIcon: (tipo, categoria) => {
            const { contasBancarias } = AppState.configuracoes;
            const tipoSafe = String(tipo || 'default');
            const catSafe = String(categoria || 'default');

            let iconKey = `${tipoSafe}-${catSafe}`;
            let icon = RoadmapRenderer.iconMap[iconKey] || RoadmapRenderer.iconMap['default'];
            
            if (RoadmapRenderer.svgIcons && RoadmapRenderer.svgIcons[icon]) {
                icon = RoadmapRenderer.svgIcons[icon];
            } else if (tipoSafe === 'futuro-manutencao' || iconKey === 'saida-Ve√≠culo') {
                icon = RoadmapRenderer.svgIcons.WRENCH || 'üîß';
            }

            if (tipoSafe === 'transferencia-banco') {
                const conta = contasBancarias ? contasBancarias.find(c => c.id === categoria) : null; 
                if (conta && conta.icone) {
                    const iconBanco = RoadmapRenderer.iconMap[`banco-${conta.icone}`];
                    if (iconBanco) icon = iconBanco;
                } else {
                    icon = RoadmapRenderer.iconMap['banco-default'] || 'üè¶';
                }
            }
            
            if (!icon) icon = '‚öôÔ∏è';
            if (typeof icon === 'string' && icon.includes('<svg')) return icon;
            return `<span class="emoji-icon">${icon}</span>`;
        },

        // --- 3. RENDERIZA√á√ÉO PRINCIPAL ---
        render: () => {
            const { roadmapContainer, roadmapProximosEventos, roadmapTimeline, roadmapResumoFinanceiro } = UIElements;
            
            if (!roadmapContainer || !AppState.dashboardState.isRoadmapVisible) {
                if(roadmapContainer) roadmapContainer.classList.add('hidden');
                return;
            }
            
            roadmapContainer.classList.remove('hidden');

            const kmDiaAnterior = BusinessLogic.getKmFinalDiaAnterior();
            const jornadaHoje = BusinessLogic.getJornadaDoDia(new Date());
            const kmAtualJornada = parseFloat(jornadaHoje.kmFinal || jornadaHoje.kmInicial) || 0;
            const odometroAtual = (kmAtualJornada > kmDiaAnterior) ? kmAtualJornada : (kmDiaAnterior || 0);

            if (odometroAtual === 0) {
                roadmapContainer.innerHTML = '<p class="text-center text-slate-400 italic py-4">Registre o KM na aba "Jornada" para ativar o Roadmap.</p>';
                return;
            }

            let ano = parseInt(UIElements.selectAno.value);
            let mes = parseInt(UIElements.selectMes.value);
            let dia = parseInt(UIElements.selectDia.value);
            
            // Default para data atual se inv√°lido
            if (isNaN(ano) || isNaN(mes) || mes === -1) {
                const dataAtual = new Date();
                ano = dataAtual.getFullYear();
                mes = dataAtual.getMonth();
            }

            // --- 3A. CARD DE RESUMO FINANCEIRO (ASS√çNCRONO) ---
            setTimeout(() => {
                // C√°lculo de Ganhos/Taxas
                const jornadasDoPeriodo = RoadmapRenderer.getJornadasDoPeriodo(ano, mes, dia);
                let totalGanhosLiquidosComExtra = 0; 
                let totalGorjetas = 0;
                let totalTaxas = 0;
                let totalOutrosCustos = 0;

                jornadasDoPeriodo.forEach(jornada => {
                    if (BusinessLogic.getTotalGanhos) totalGanhosLiquidosComExtra = Math.round((totalGanhosLiquidosComExtra * 100) + (BusinessLogic.getTotalGanhos(jornada) * 100)) / 100;
                    if (BusinessLogic.getGorjetaTotalDaJornada) totalGorjetas = Math.round((totalGorjetas * 100) + (BusinessLogic.getGorjetaTotalDaJornada(jornada) * 100)) / 100;
                    if (BusinessLogic.getTaxaTotalDaJornada) totalTaxas = Math.round((totalTaxas * 100) + (BusinessLogic.getTaxaTotalDaJornada(jornada) * 100)) / 100;
                });

                // Soma Gorjetas "Soltas" do Hist√≥rico (que n√£o est√£o em jornadas)
                if (AppState.historicoTransacoes) {
                    AppState.historicoTransacoes.forEach(t => {
                        // üõ°Ô∏è BLINDAGEM 1: Ignora transa√ß√µes inv√°lidas (ex: de jornadas reabertas)
                        if (!t || t.invalida) return;

                        // üîí BLINDAGEM 2: Ignora ajustes internos
                        if (t.isAjusteInterno === true) return;
                        // Normaliza√ß√£o de Data para filtro
                        if (!t.data) return;
                        const d = new Date(typeof t.data === 'number' ? t.data : t.data);
                        if (isNaN(d.getTime())) return;

                        const mesmoAno = d.getFullYear() === ano;
                        const mesmoMes = (mes === -1) || (d.getMonth() === mes);
                        const mesmoDia = (dia === -1) || isNaN(dia) || (d.getDate() === dia);

                        if (mesmoAno && mesmoMes && mesmoDia) {
                            if (t.tipo === 'entrada' && t.categoria === 'Gorjeta' && t.descricao && !t.descricao.includes('Extra Manual')) {
                                totalGanhosLiquidosComExtra += t.valor;
                                totalGorjetas += t.valor;
                            }
                        }
                    });
                }
                
                // C√°lculo de Custos
                const resumoCustos = BusinessLogic.calcularResumoPeriodo(ano, mes, dia, null);
                totalOutrosCustos = resumoCustos.totalCustos || 0;
                const totalLiquidoViagens = totalGanhosLiquidosComExtra - totalGorjetas;

                if (roadmapResumoFinanceiro) {
                    roadmapResumoFinanceiro.classList.remove('hidden');
                    const totalBrutoEstimado = totalLiquidoViagens + totalTaxas;
                    const percentTaxa = totalBrutoEstimado > 0 ? (totalTaxas / totalBrutoEstimado) * 100 : 0;

                    roadmapResumoFinanceiro.innerHTML = `
                        <div class="bg-slate-700/50 rounded-lg p-3 mb-3">
                             <div class="text-xs text-slate-400 mb-1">Ganhos L√≠quidos (Viagem)</div>
                             <div class="text-2xl font-bold text-cyan-300">${Utils.formatarMoeda(totalLiquidoViagens)}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                             <div class="bg-slate-700/30 p-2 rounded">
                                 <div class="text-[10px] text-slate-400">Extras / B√¥nus</div>
                                 <div class="text-green-400 font-bold">${Utils.formatarMoeda(totalGorjetas)}</div>
                             </div>
                             <div class="bg-slate-700/30 p-2 rounded">
                                 <div class="text-[10px] text-slate-400">Taxas Pagas</div>
                                 <div class="text-red-400 font-bold">${Utils.formatarMoeda(totalTaxas)}</div>
                                 <div class="text-[10px] text-slate-500 text-right">${percentTaxa.toFixed(1)}%</div>
                             </div>
                        </div>
                        <div class="flex justify-between items-center text-sm text-slate-300 border-t border-slate-700 pt-2 mt-2">
                             <span>Total Entradas:</span>
                             <span class="font-bold text-white">${Utils.formatarMoeda(totalGanhosLiquidosComExtra)}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-slate-400 mt-1">
                             <span>Total Sa√≠das:</span>
                             <span class="font-bold text-red-400">-${Utils.formatarMoeda(totalOutrosCustos)}</span>
                        </div>
                    `;
                }
            }, 0);

            // --- 3B. PR√ìXIMOS EVENTOS (FUTURO) ---
            const proximosEventos = RoadmapRenderer.getProximosEventos(odometroAtual).slice(0, 2);
            roadmapProximosEventos.innerHTML = proximosEventos.length > 0 ? '' : '<p class="text-center text-slate-500 italic text-sm">Nenhum evento futuro previsto.</p>';
            
            const fragmentFuturo = document.createDocumentFragment();
            proximosEventos.forEach(evento => {
                fragmentFuturo.appendChild(RoadmapRenderer.createRoadmapCard(evento, true));
            });
            roadmapProximosEventos.appendChild(fragmentFuturo);

            // --- 3C. TIMELINE HIST√ìRICO (FONTE DA VERDADE) ---
            const historicoEventos = RoadmapRenderer.getHistoricoEventos(ano, mes, dia);
            roadmapTimeline.innerHTML = '';
            
            if (historicoEventos.length === 0) {
                 const dataLegivel = (dia !== -1 && !isNaN(dia)) 
                    ? `${String(dia).padStart(2,'0')}/${String(mes+1).padStart(2,'0')}` 
                    : `${String(mes+1).padStart(2,'0')}/${ano}`;
                roadmapTimeline.innerHTML = `<p class="text-center text-slate-500 italic text-sm py-4">Nenhum evento registrado em ${dataLegivel}.</p>`;
                roadmapTimeline.classList.add('future-road'); 
            } else {
                const itensParaRenderizar = historicoEventos.slice(0, 50);
                const fragmentHistorico = document.createDocumentFragment();
                let hasPastEvents = false;
                itensParaRenderizar.forEach(evento => {
                    if (evento.tipo !== 'futuro') hasPastEvents = true;
                    fragmentHistorico.appendChild(RoadmapRenderer.createRoadmapCard(evento, false));
                });
                roadmapTimeline.appendChild(fragmentHistorico);
                if (hasPastEvents) {
                    roadmapTimeline.classList.remove('future-road');
                } else {
                    roadmapTimeline.classList.add('future-road');
                }
            }
        },

        // --- 4. FETCHING DE DADOS ---
        getJornadasDoPeriodo: (ano, mes, dia) => {
            const todasJornadas = AppState.jornadas || {}; 
            const jornadasFiltradas = [];
            let inicioIntervalo, fimIntervalo;

            if (dia !== -1) {
                inicioIntervalo = new Date(ano, mes, dia, 0, 0, 0).getTime();
                fimIntervalo = new Date(ano, mes, dia, 23, 59, 59).getTime();
            } else {
                inicioIntervalo = new Date(ano, mes, 1, 0, 0, 0).getTime();
                fimIntervalo = new Date(ano, mes + 1, 0, 23, 59, 59).getTime();
            }

            for (const dataChave in todasJornadas) {
                const dataJornada = new Date(dataChave + "T12:00:00");
                if (!isNaN(dataJornada.getTime())) {
                    const diaJornadaInicio = new Date(dataJornada.getFullYear(), dataJornada.getMonth(), dataJornada.getDate(), 0, 0, 0).getTime();
                    if (diaJornadaInicio >= inicioIntervalo && diaJornadaInicio <= fimIntervalo) {
                        jornadasFiltradas.push(todasJornadas[dataChave]);
                    }
                }
            }
            return jornadasFiltradas;
        },

getHistoricoEventos: (ano, mes, dia) => {
    const eventos = [];
    let inicio, fim;

    // 1. Defini√ß√£o do Per√≠odo (Dia Espec√≠fico ou M√™s Inteiro)
    if (dia !== -1 && !isNaN(dia)) {
        inicio = new Date(ano, mes, dia, 0, 0, 0).getTime();
        fim = new Date(ano, mes, dia, 23, 59, 59).getTime();
    } else {
        inicio = new Date(ano, mes, 1, 0, 0, 0).getTime();
        fim = new Date(ano, mes + 1, 0, 23, 59, 59).getTime();
    }
// ========================================================
    // RENDERIZA√á√ÉO DO HIST√ìRICO (Bloco Visual Corrigido)
    // ========================================================
    
    // Filtra e prepara os eventos para exibi√ß√£o
    if (AppState.historicoTransacoes) {
        AppState.historicoTransacoes.forEach(t => {
            // --- BLINDAGEM DE DADOS ---
            if (!t.data) return;
            const dataTs = new Date(typeof t.data === 'number' ? t.data : t.data).getTime();
            
            // Filtro de per√≠odo (assumindo que as vari√°veis inicio/fim existem no escopo)
            if (isNaN(dataTs) || dataTs < inicio || dataTs > fim) return;

            const descSafe = t.descricao || ''; 

            // A. ABASTECIMENTO
            if (t.categoria === 'Abastecimento') {
                if (t.detalhes && t.detalhes.litros > 0) {
                    const kmAbastecimento = t.detalhes.km || 0;
                    const valorTotal = (t.detalhes.valorEvento !== undefined) ? t.detalhes.valorEvento : t.valor;

                    eventos.push({
                        tipo: 'saida',
                        categoria: 'Abastecimento',
                        data: dataTs,
                        km: kmAbastecimento,
                        titulo: `Abastecimento: ${Utils.formatarMoeda(valorTotal)}`,
                        descricao: descSafe || 'Combust√≠vel',
                        valor: -valorTotal
                    });
                }
            }
            
            // B. TRANSFER√äNCIAS E MOVIMENTA√á√ïES (VISUAL HUMANO üß†)
            else if (t.tipo === 'transferencia' || (t.tipo === 'saida' && t.detalhes?.leg === 'source')) {
                let titulo = 'Transfer√™ncia';
                let iconeTipo = 'transferencia-banco';
                let categoriaIcone = 'default';
                
                // 1. Resolu√ß√£o Inteligente de Nomes (Origem)
                let nomeOrigem = t.contaOrigem || (t.origem && t.origem.nome) || 'Carteira';
                if (nomeOrigem === 'AUTO_ID_CARTEIRA') nomeOrigem = 'Carteira';

                // 2. Resolu√ß√£o Inteligente de Nomes (Destino)
                let nomeDestino = t.contaDestino || (t.destino && t.destino.nome) || 'Destino';
                
                // üßπ FAXINA NO UUID DA FATURA
                if (nomeDestino.includes('FATURA_')) {
                    const idReal = nomeDestino.replace('FATURA_', '');
                    // Tenta achar o nome do cart√£o original
                    const contaReal = AppState.configuracoes.contasBancarias.find(c => c.id === idReal);
                    nomeDestino = contaReal ? `Fatura ${contaReal.nome}` : 'Fatura Cart√£o';
                }

                // 3. Subtipos Visuais e T√≠tulos
                if (t.destino?.tipo === 'caixinha' || (t.contaDestino && t.contaDestino.startsWith('meta_'))) {
                    iconeTipo = 'transferencia-caixinha';
                    categoriaIcone = t.destino?.id || t.contaDestino; 
                    titulo = `Guardado: ${t.destino?.nome || 'Reserva'}`;
                } 
                else if (t.destino?.tipo === 'fatura' || (t.contaDestino && t.contaDestino.includes('FATURA'))) {
                    iconeTipo = 'transferencia-fatura';
                    titulo = `Pgto Fatura`; // T√≠tulo curto e limpo
                } 
                else if (descSafe.includes('Amortiza√ß√£o')) {
                     titulo = `Amortiza√ß√£o D√≠vida`;
                     iconeTipo = 'manutencao'; 
                } 
                else {
                    titulo = `Transfer√™ncia`;
                }

                // 4. MONTAGEM DA DESCRI√á√ÉO (AQUI EST√Å O QUE VOC√ä PEDIU)
                let descricaoVisual = `${nomeOrigem} ‚ûî ${nomeDestino}`;
                
                // Se a transa√ß√£o tem uma descri√ß√£o espec√≠fica (ex: "Ped√°gio") que n√£o √© gen√©rica, usamos como Ref.
                const descricoesGenericas = ['Transfer√™ncia', 'Pgto Fatura', 'Sa√≠da', 'Entrada'];
                const temDescricaoUtil = t.descricao && !descricoesGenericas.some(g => t.descricao.includes(g));

                if (temDescricaoUtil) {
                    // Ex: Carteira ‚ûî Fatura Nubank (Ref. Ped√°gio Dultra)
                    descricaoVisual = `${nomeOrigem} ‚ûî ${nomeDestino} <span class="text-cyan-200 opacity-80">(Ref. ${t.descricao})</span>`;
                }

                eventos.push({
                    tipo: 'transferencia',
                    categoria: categoriaIcone,
                    iconeOverride: iconeTipo,
                    data: dataTs,
                    km: 0,
                    titulo: titulo,
                    // Injeta HTML na descri√ß√£o para ficar bonito
                    descricao: descricaoVisual, 
                    valor: -t.valor
                });
            }
      /*      // B. TRANSFER√äNCIAS E MOVIMENTA√á√ïES (VISUAL INTELIGENTE)
            else if (t.tipo === 'transferencia' || (t.tipo === 'saida' && t.detalhes?.leg === 'source')) {
                let titulo = 'Transfer√™ncia';
                let iconeTipo = 'transferencia-banco';
                let categoriaIcone = 'default';
                
                // Resolu√ß√£o Inteligente de Nomes
                const nomeOrigem = t.contaOrigem || (t.origem && t.origem.nome) || 'Carteira';
                const nomeDestino = t.contaDestino || (t.destino && t.destino.nome) || 'Destino';

                // Subtipos Visuais
                if (t.destino?.tipo === 'caixinha' || t.contaDestino?.startsWith('meta_')) {
                    iconeTipo = 'transferencia-caixinha';
                    categoriaIcone = t.destino?.id || t.contaDestino; 
                    titulo = `Guardado em: ${t.destino?.nome || 'Reserva'}`;
                } else if (t.destino?.tipo === 'fatura' || t.contaDestino?.startsWith('FATURA_')) {
                    iconeTipo = 'transferencia-fatura';
                    titulo = `Pgto Fatura: ${t.destino?.nome || 'Cart√£o'}`;
                } else if (descSafe.includes('Amortiza√ß√£o')) {
                     titulo = `Amortiza√ß√£o D√≠vida`;
                     iconeTipo = 'manutencao'; 
                } else {
                    titulo = `Transfer√™ncia: ${Utils.formatarMoeda(t.valor)}`;
                }

                eventos.push({
                    tipo: 'transferencia',
                    categoria: categoriaIcone,
                    iconeOverride: iconeTipo, // Passa dica pro renderizador CSS
                    data: dataTs,
                    km: 0,
                    titulo: titulo,
                    descricao: `${nomeOrigem} ‚ûî ${nomeDestino}`, 
                    valor: -t.valor
                });
            }*/

            // C. OUTROS CUSTOS E SA√çDAS
            else if (t.tipo === 'saida' && !t.detalhes?.leg && t.tipo !== 'transferencia') { 
                 // Ignora perna t√©cnica de destino
                 if (t.detalhes?.leg === 'destination') return;

                 eventos.push({
                    tipo: 'saida',
                    categoria: t.categoria || 'Outro',
                    data: dataTs,
                    km: 0,
                    titulo: `Gasto: ${descSafe}`,
                    descricao: t.categoria,
                    valor: -t.valor
                });
            }

            // D. ENTRADAS, EXTRAS E GORJETAS
            else if (t.tipo === 'entrada') {
                 let tituloEntrada = `Entrada: ${Utils.formatarMoeda(t.valor)}`;
                 let tipoEvento = 'entrada';
                 
                 if (t.categoria === 'Gorjeta' || descSafe.includes('Extra:')) {
                     tipoEvento = 'servico'; // Cor verde diferente
                     tituloEntrada = `Extra: ${Utils.formatarMoeda(t.valor)}`;
                 }

                 eventos.push({
                    tipo: tipoEvento,
                    categoria: t.categoria || 'Entrada',
                    data: dataTs,
                    km: 0,
                    titulo: tituloEntrada,
                    descricao: t.descricao || 'Entrada avulsa',
                    valor: t.valor
                });
            }
        });
    }

/* 
    // 2. Processa Transa√ß√µes Financeiras (Onde estava o problema)
    if (AppState.historicoTransacoes) {
        AppState.historicoTransacoes.forEach(t => {
            // --- BLINDAGEM DE DADOS ---
            if (!t.data) return;
            // Garante timestamp num√©rico (corrige bugs de data string)
            const dataTs = new Date(typeof t.data === 'number' ? t.data : t.data).getTime();
            
            // Filtro de per√≠odo
            if (isNaN(dataTs) || dataTs < inicio || dataTs > fim) return;

            const descSafe = t.descricao || ''; 

            // A. ABASTECIMENTO (L√≥gica Original Mantida)
            if (t.categoria === 'Abastecimento') {
                if (t.detalhes && t.detalhes.litros > 0) {
                    const kmAbastecimento = t.detalhes.km || 
                                            (t.jornadaId && AppState.jornadas[t.jornadaId]?.custos?.abastecimento?.km) || 
                                            0;

                    const valorTotal = (t.detalhes.valorEvento !== undefined) ? t.detalhes.valorEvento : t.valor;

                    eventos.push({
                        tipo: 'saida', // Renderizador usa isso para cor vermelha
                        categoria: 'Abastecimento',
                        data: dataTs,
                        km: kmAbastecimento,
                        titulo: `Abastecimento: ${Utils.formatarMoeda(valorTotal)}`,
                        descricao: descSafe || 'Combust√≠vel',
                        valor: -valorTotal
                    });
                }
            }
            
            // B. TRANSFER√äNCIAS E MOVIMENTA√á√ïES CONT√ÅBEIS (CORRE√á√ÉO APLICADA AQUI)
            // Prioridade: Captura 'transferencia' antes que caia no 'else' gen√©rico
            else if (t.tipo === 'transferencia' || (t.tipo === 'saida' && t.detalhes?.leg === 'source')) {
                let titulo = 'Transfer√™ncia';
                let iconeTipo = 'transferencia-banco'; // √çcone padr√£o üè¶
                let categoriaIcone = 'default';
                
                // --- RESOLU√á√ÉO INTELIGENTE DE NOMES (CORRE√á√ÉO DO ? ‚ûî ?) ---
                // Tenta pegar o nome da string nova (contaOrigem) OU do objeto antigo (origem.nome)
                const nomeOrigem = t.contaOrigem || (t.origem && t.origem.nome) || 'Carteira';
                const nomeDestino = t.contaDestino || (t.destino && t.destino.nome) || 'Destino';

                // Subtipos de Transfer√™ncia
                if (t.destino?.tipo === 'caixinha') {
                    iconeTipo = 'transferencia-caixinha';
                    categoriaIcone = t.destino.id; 
                    titulo = `Guardado em: ${t.destino.nome}`;
                } else if (t.destino?.tipo === 'fatura') {
                    iconeTipo = 'transferencia-fatura';
                    categoriaIcone = 'default';
                    titulo = `Pgto Fatura: ${t.destino.nome}`;
                } else if (descSafe.includes('Amortiza√ß√£o')) {
                     titulo = `Amortiza√ß√£o D√≠vida`;
                     iconeTipo = 'manutencao'; 
                } else {
                    // Caso Cl√°ssico (R$ 20,00)
                    titulo = `Transfer√™ncia: ${Utils.formatarMoeda(t.valor)}`;
                }

                eventos.push({
                    tipo: 'transferencia', // For√ßa o tipo correto para o CSS/√çcone
                    categoria: categoriaIcone,
                    data: dataTs,
                    km: 0,
                    titulo: titulo,
                    // AQUI EST√Å A M√ÅGICA: Usa os nomes resolvidos, nunca mais '?'
                    descricao: `${nomeOrigem} ‚ûî ${nomeDestino}`, 
                    valor: -t.valor
                });
            }

            // C. OUTROS CUSTOS (GEN√âRICO)
            // Adicionado filtro && t.tipo !== 'transferencia' para BLINDAR
            else if (t.tipo === 'saida' && !t.detalhes?.leg && t.tipo !== 'transferencia') { 
                 // Filtro anti-duplicidade de Fatura
                 if (t.detalhes?.leg === 'destination' && t.contaId && t.contaId.startsWith('FATURA_')) {
                     // Permite passar
                 } else if (t.detalhes?.leg === 'destination') {
                     return; // Ignora perna de destino t√©cnica
                 }

                 eventos.push({
                    tipo: 'saida',
                    categoria: t.categoria || 'Outro',
                    data: dataTs,
                    km: 0,
                    titulo: `Gasto: ${descSafe}`,
                    descricao: t.categoria,
                    valor: -t.valor
                });
            }

            // D. ENTRADAS / EXTRAS
            else if (t.tipo === 'entrada' && (t.categoria === 'Gorjeta' || descSafe.includes('Extra:'))) {
                 eventos.push({
                    tipo: 'servico',
                    categoria: 'Gorjeta',
                    data: dataTs,
                    km: 0,
                    titulo: `Extra: ${Utils.formatarMoeda(t.valor)}`,
                    descricao: t.descricao,
                    valor: t.valor
                });
            }

            // E. AJUSTE MANUAL
            else if (descSafe === 'Ajuste manual de saldo') {
                let nomeConta = t.contaId;
                if (t.contaId === 'AUTO_ID_CARTEIRA') nomeConta = 'Carteira (Caixa)';
                else {
                    const conta = AppState.configuracoes.contasBancarias.find(c => c.id === t.contaId);
                    if (conta) nomeConta = conta.nome;
                }
                eventos.push({
                    tipo: 'ajuste',
                    categoria: 'ajuste-saldo', 
                    data: dataTs,
                    km: 0,
                    titulo: `Ajuste: ${t.tipo === 'entrada' ? '+' : '-'} ${Utils.formatarMoeda(t.valor)}`,
                    descricao: `Em: ${nomeConta}`, 
                    valor: t.tipo === 'entrada' ? t.valor : -t.valor
                });
            }
        });
    }

 */

    // 3. Processa Atividades (Jornadas) - Mantido Original
    const jornadasFiltradas = RoadmapRenderer.getJornadasDoPeriodo(ano, mes, dia);
    jornadasFiltradas.forEach(jornada => {
        if (jornada && jornada.atividades) {
            jornada.atividades.forEach(at => {
                if (!at.fim) return;
                const dataEvento = new Date(at.fim).getTime();
                if (isNaN(dataEvento)) return;

                const gorjeta = at.valorGorjeta || 0;
                const valorBase = at.valor - gorjeta;
                let valorTaxa = 0;
                if (at.taxaAppOriginal && at.taxaAppOriginal > 0) valorTaxa = at.taxaAppOriginal;
                else if (at.valorBruto && at.valorBruto > valorBase) valorTaxa = at.valorBruto - valorBase;

                eventos.push({
                    tipo: 'servico',
                    categoria: at.categoria, 
                    subcategoria: at.subcategoria,
                    data: dataEvento,
                    km: at.kmFinalServico || at.kmInicialServico || 0,
                    titulo: `${at.categoria}: ${at.descricao || 'Finalizado'}`,
                    descricao: `Dura√ß√£o: ${Utils.formatarDuracao ? Utils.formatarDuracao(at.duracaoMs) : ''}`,
                    valor: valorBase,
                    taxa: valorTaxa
                });
            });
        }
    });

    // 4. Processa Manuten√ß√µes - Mantido Original
    if (AppState.historicoManutencao) {
        AppState.historicoManutencao.forEach(manutencao => {
            const dataStr = manutencao.data.includes('T') ? manutencao.data : `${manutencao.data}T12:00:00`;
            const dataTs = new Date(dataStr).getTime();
            
            if (!isNaN(dataTs) && dataTs >= inicio && dataTs <= fim) {
                eventos.push({
                    tipo: 'manutencao', 
                    categoria: manutencao.categoria || 'Outro', 
                    data: dataTs,
                    km: manutencao.km,
                    titulo: `Manuten√ß√£o: ${manutencao.servico}`,
                    descricao: `Categoria: ${manutencao.categoria}. ${manutencao.local || ''}`,
                    valor: -Math.abs(manutencao.valor || 0),
                });
            }
        });
    }

    // 5. Ordena√ß√£o Final (Dia > KM > Hora)
    return eventos.sort((a, b) => {
        const diaA = new Date(a.data).setHours(0,0,0,0);
        const diaB = new Date(b.data).setHours(0,0,0,0);
        if (diaA !== diaB) return diaB - diaA; // Mais recente primeiro
        
        // Se ambos tem KM, o maior KM vem primeiro
        if (a.km > 0 && b.km > 0 && a.km !== b.km) return b.km - a.km;
        
        // Desempate por hora exata
        return b.data - a.data;
    });
},
        getProximosEventos: (odometroAtual) => {
            const { planoManutencao } = AppState.configuracoes;
            const historico = AppState.historicoManutencao;
            const eventos = [];

            planoManutencao.forEach(item => {
                if (item.intervaloKm <= 0) return;
                
                const ultimoServico = historico
                    .filter(h => h.planoId === item.id && h.km > 0)
                    .sort((a, b) => b.km - a.km)[0];
                
                const ultimoKm = ultimoServico ? ultimoServico.km : 0;
                const proximoKm = ultimoKm + item.intervaloKm;
                const kmFaltantes = proximoKm - odometroAtual;

                if (kmFaltantes < (item.intervaloKm * 1.5)) {
                    const isAtrasado = kmFaltantes < 0;
                    const textoDescricao = isAtrasado 
                        ? `ATEN√á√ÉO: Venceu h√° ${Math.abs(kmFaltantes).toLocaleString('pt-BR')} km!` 
                        : `Pr√≥xima manuten√ß√£o prevista em ${proximoKm.toLocaleString('pt-BR')} km.`;

                    eventos.push({
                        tipo: 'futuro-manutencao',
                        categoria: item.categoria,
                        data: null,
                        km: proximoKm,
                        kmFaltantes: kmFaltantes,
                        titulo: item.descricao,
                        descricao: textoDescricao,
                        valor: 0,
                        atrasado: isAtrasado
                    });
                }
            });
            
            const { veiculo, litrosRestantes } = AppState.configuracoes;
            if (veiculo.autonomia > 0 && litrosRestantes > 0) {
                const kmAutonomia = litrosRestantes * veiculo.autonomia;
                const proximoKm = odometroAtual + kmAutonomia;
                eventos.push({
                    tipo: 'futuro-combustivel',
                    categoria: 'Abastecimento',
                    data: null,
                    km: proximoKm,
                    kmFaltantes: kmAutonomia,
                    titulo: 'Pr√≥ximo Abastecimento (Estimado)',
                    descricao: `Autonomia de ~${kmAutonomia.toFixed(0)} km (${litrosRestantes.toFixed(1)}L).`,
                    valor: 0
                });
            }

            return eventos.sort((a, b) => a.kmFaltantes - b.kmFaltantes).slice(0, 2);
        },

        // --- 5. RENDERIZA√á√ÉO DE CARD ---
        createRoadmapCard: (evento, isFuturo) => {
            const div = document.createElement('div');
            div.className = 'timeline-item bg-slate-800 rounded-lg shadow-md relative overflow-hidden mb-4 p-0'; 
            
            const iconInterno = RoadmapRenderer.getIcon(evento.tipo, evento.categoria);
            const categoriaSlug = evento.categoria ? evento.categoria.toLowerCase().replace(/[^a-z0-9]/g, '-') : 'default';
            
            let classeEspec√≠fica = `watermark-${categoriaSlug}`;
            if (evento.categoria === 'Abastecimento') classeEspec√≠fica = 'watermark-abastecimento';
            else if (evento.tipo.includes('manutencao')) classeEspec√≠fica = 'watermark-manutencao';
            else if (evento.categoria === 'Gorjeta') classeEspec√≠fica = 'watermark-gorjeta';

            const watermarkHTML = `
                <div class="timeline-watermark-mask">
                    <div class="timeline-icon-watermark ${classeEspec√≠fica}">
                        ${iconInterno}
                    </div>
                </div>
            `;

            let iconWrapperHTML = ''; 
            let contentHTML = '';

            if (isFuturo) {
                const corTexto = evento.atrasado ? 'text-red-400' : 'text-cyan-300';
                const textoFaltam = evento.atrasado ? 'VENCEU' : 'Faltam';
                const valorFaltam = Math.abs(evento.kmFaltantes).toFixed(0);
                
                div.className += ' border-l-4 ' + (evento.atrasado ? 'border-red-500' : 'border-yellow-500');
                div.classList.add('opacity-90');

                contentHTML = `
                    <div class="flex p-6 relative z-10 items-center">
                        <div class="mr-4 p-3 rounded-full bg-slate-700 text-slate-300 shadow-inner">
                            ${iconInterno}
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-white text-sm">${evento.titulo}</div>
                            <div class="text-xs text-slate-400 mt-1 truncate">${evento.descricao}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] uppercase text-slate-500 font-bold">${textoFaltam}</div>
                            <div class="${corTexto} font-bold text-lg">${valorFaltam} km</div>
                        </div>
                    </div>
                `;
            } 
            else {
                let valorHTML = '';
                if (evento.valor > 0) {
                    valorHTML = `<span class="item-value positive block">${Utils.formatarMoeda(evento.valor)}</span>`;
                } else if (evento.valor < 0) {
                    valorHTML = `<span class="item-value negative block">${Utils.formatarMoeda(evento.valor)}</span>`;
                }

                let badgeAppHTML = '';
                if (evento.subcategoria) {
                    const subcatConfig = AppState.configuracoes.subcategorias[evento.categoria]?.find(s => s.nome === evento.subcategoria);
                    const cor = subcatConfig ? subcatConfig.cor : '#818cf8';
                    const corTexto = Utils.getContrastingTextColor(cor);
                    badgeAppHTML = `<span class="text-[10px] px-2 py-0.5 rounded-full inline-block mt-1 font-bold tracking-wide uppercase" style="background-color: ${cor}; color: ${corTexto}; border: 1px solid rgba(255,255,255,0.2);">${evento.subcategoria}</span>`;
                }

                let taxaHTML = '';
                if (evento.taxa && evento.taxa > 0) {
                    const valorBrutoEstimado = evento.valor + evento.taxa;
                    let percentString = '';
                    if (valorBrutoEstimado > 0) {
                        const percent = (evento.taxa / valorBrutoEstimado) * 100;
                        percentString = ` <span class="opacity-75">(${percent.toFixed(1)}%)</span>`;
                    }
                    taxaHTML = `<div class="text-xs text-red-400 font-medium mt-1">Taxa: -${Utils.formatarMoeda(evento.taxa)}${percentString}</div>`;
                }

                let iconColorClass = 'icon-default';
                if (evento.categoria === 'Gorjeta') iconColorClass = 'icon-coin';
                else if (evento.valor > 0 || evento.tipo === 'servico') iconColorClass = 'icon-service';
                else if (evento.tipo.includes('manutencao')) iconColorClass = 'icon-maintenance';
                else if (evento.tipo.includes('combustivel') || evento.categoria === 'Abastecimento' || evento.tipo === 'saida') iconColorClass = 'icon-fuel';
                else if (evento.tipo.includes('transferencia')) iconColorClass = 'icon-transfer';
                
                const iconDaVia = RoadmapRenderer.getIcon(evento.tipo, evento.categoria);
                
                iconWrapperHTML = `<div class="timeline-icon ${iconColorClass}">${iconDaVia}</div>`;
                
                let borderClass = 'border-slate-600'; 
                if (evento.valor > 0) borderClass = 'border-cyan-500'; 
                if (evento.categoria === 'Gorjeta') borderClass = 'border-green-500'; 
                if (evento.valor < 0) borderClass = 'border-red-500'; 

                div.className += ` border-l-4 ${borderClass}`;

                contentHTML = `
                    <div class="timeline-content p-2">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-2">
                                <div class="item-title">${evento.titulo}</div>
                                <div class="item-desc mt-1 text-sm text-slate-400 leading-snug">${evento.descricao}</div>
                            </div>
                            <div class="text-right ml-2 flex-shrink-0 flex flex-col items-end" style="min-width: 80px;">
                                ${valorHTML}
                                ${badgeAppHTML}
                                ${taxaHTML}
                            </div>
                        </div>
                        <div class="item-meta mt-2 pt-2 border-t border-slate-700/50 flex gap-3">
                            ${evento.km > 0 ? `<span>${evento.km.toLocaleString('pt-BR')} km</span>` : ''}
                            ${evento.data ? `<span class="font-bold ml-auto">${Utils.formatarHora(evento.data)}</span>` : ''}
                        </div>
                    </div>
                `;
            }
            
            div.innerHTML = iconWrapperHTML + contentHTML + watermarkHTML;
            return div;
        }
    }; 

const buildUniqueDescriptionHistory = (categoria) => {
        const descriptions = [];
        const sortedKeys = Object.keys(AppState.jornadas).sort().reverse();
        for (const key of sortedKeys) {
            const jornada = AppState.jornadas[key];
            if (jornada && jornada.atividades) {
                for (let i = jornada.atividades.length - 1; i >= 0; i--) {
                    const at = jornada.atividades[i];
                    if (at.categoria === categoria && at.descricao && at.descricao.trim() !== '') {
                        descriptions.push(at.descricao.trim());
                    }
                }
            }
        }
        const uniqueDescriptions = [...new Set(descriptions)];
        return uniqueDescriptions;
    };
    
// =============================================================
    // ======================= FUEL MANAGER (NOVO) =================
    // =============================================================
    const FuelManager = {
        
        // 1. Regra dos 70% (Com ajuste de rendimento pessoal)
        calcularVantagem: (precoGasolina, precoEtanol) => {
            if (!precoGasolina || !precoEtanol) return null;
            
            const ratioPreco = precoEtanol / precoGasolina;
            // Padr√£o de mercado √© 0.7, mas poderia ser ajustado pelo rendimento do carro
            let ratioRendimento = 0.7; 

            // Se o √°lcool custar menos que 70% da gasolina, vale a pena.
            const compensaEtanol = ratioPreco < ratioRendimento;
            const economiaPercent = (1 - (ratioPreco / ratioRendimento)) * 100;
            
            return {
                melhor: compensaEtanol ? 'Etanol' : 'Gasolina',
                economia: Math.abs(economiaPercent),
                ratio: ratioPreco
            };
        },

        // 2. Previs√£o de Gastos (Linha Piloto)
        gerarPrevisaoGastos: () => {
            const transacoes = AppState.historicoTransacoes.filter(t => t.categoria === 'Abastecimento');
            if (transacoes.length < 2) return null;

            // Agrupa por m√™s
            const gastosPorMes = {};
            transacoes.forEach(t => {
                const data = new Date(t.data);
                const chave = `${data.getMonth() + 1}/${data.getFullYear()}`;
                gastosPorMes[chave] = (gastosPorMes[chave] || 0) + t.valor;
            });

            const labels = Object.keys(gastosPorMes); 
            const valores = Object.values(gastosPorMes);

            // C√°lculo simples de tend√™ncia (M√©dia dos √∫ltimos 3 meses)
            const ultimos3 = valores.slice(-3);
            const mediaRecente = ultimos3.reduce((a, b) => a + b, 0) / ultimos3.length;
            
            // Projeta o pr√≥ximo m√™s
            const proximoMesLabel = "Pr√≥x. M√™s (Est.)";
            
            return {
                labels: [...labels, proximoMesLabel],
                valoresReais: [...valores, null], // O √∫ltimo √© null no real
                valoresProjetados: Array(valores.length).fill(null).concat([mediaRecente]) // S√≥ o √∫ltimo tem valor
            };
        },

        // 3. Dados para Gr√°fico de Pizza (Mix de Combust√≠vel)
        gerarMixCombustivel: () => {
            const mix = {};
            const transacoes = AppState.historicoTransacoes.filter(t => t.categoria === 'Abastecimento');
            
            transacoes.forEach(t => {
                // Tenta extrair o tipo da descri√ß√£o "Abastecimento: Gasolina Comum..."
                // A regex busca o texto entre "Abastecimento: " e " ("
                const match = t.descricao.match(/Abastecimento:\s*(.*?)\s*\(/);
                const tipo = match ? match[1] : (t.subcategoria || 'Indefinido');
                
                mix[tipo] = (mix[tipo] || 0) + t.valor;
            });

            return {
                labels: Object.keys(mix),
                data: Object.values(mix)
            };
        }
    };
   // =============================================================
    // ======================= DATA REPAIR (MOTOR DE CORRE√á√ÉO) =====
    // =============================================================
    const DataRepair = {
        reconstruirSaldos: () => {
            console.log("Iniciando reconstru√ß√£o de saldos...");
            
            // A) Zera saldos atuais
            AppState.configuracoes.contasBancarias.forEach(c => c.saldo = 0); 
            AppState.configuracoes.metasFinanceiras.forEach(m => {
                if (m.tipo !== 'parcelamento') m.valorAtual = 0;
                
                if (m.tipo === 'parcelamento') {
                    m.valorAtual = 0; 
                    m.valorProvisionado = 0; 
                    if (m.financiamento) {
                        m.financiamento.totalAmortizado = 0;
                        m.financiamento.parcelasPagas = 0;
                    }
                }
                m.saidas = [];
            });

            // B) Ordena transa√ß√µes
            const transacoesOrdenadas = [...AppState.historicoTransacoes].sort((a, b) => {
                const dA = new Date(a.data).getTime();
                const dB = new Date(b.data).getTime();
                return dA - dB;
            });

            // C) Processa transa√ß√µes
            transacoesOrdenadas.forEach(t => {
                const valor = Utils.parseMoeda(t.valor); 
                
                if (t.tipo === 'entrada' || t.tipo === 'saida') {
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === t.contaId);
                    if (meta) {
                        if (t.tipo === 'entrada') {
                            meta.valorAtual = Utils.somarCentavos(meta.valorAtual || 0, valor);
                            if (meta.tipo === 'parcelamento' && meta.financiamento) {
                                meta.financiamento.totalAmortizado = Utils.somarCentavos(meta.financiamento.totalAmortizado || 0, valor);
                                if (t.detalhes && t.detalhes.qtdParcelas) {
                                    meta.financiamento.parcelasPagas = (meta.financiamento.parcelasPagas || 0) + t.detalhes.qtdParcelas;
                                } else if (t.descricao && t.descricao.match(/\((\d+)\s*x\)/)) {
                                    meta.financiamento.parcelasPagas++;
                                }
                            }
                        } else {
                            meta.valorAtual = Math.max(0, Utils.somarCentavos(meta.valorAtual || 0, -valor));
                            if (!meta.saidas) meta.saidas = [];
                            meta.saidas.push({ id: t.id, data: t.data, valor: valor, descricao: t.descricao });
                        }
                    }
                }

                if (t.tipo === 'transferencia') {
                    const origemId = t.origem ? t.origem.id : null;
                    const destinoId = t.destino ? t.destino.id : null;
                    const metaOrigem = AppState.configuracoes.metasFinanceiras.find(m => m.id === origemId);
                    const metaDestino = AppState.configuracoes.metasFinanceiras.find(m => m.id === destinoId);

                    if (metaOrigem) metaOrigem.valorAtual = Math.max(0, Utils.somarCentavos(metaOrigem.valorAtual || 0, -valor));
                    if (metaDestino) {
                        metaDestino.valorAtual = Utils.somarCentavos(metaDestino.valorAtual || 0, valor);
                        if (metaDestino.tipo === 'parcelamento' && metaDestino.financiamento) {
                            metaDestino.financiamento.totalAmortizado = Utils.somarCentavos(metaDestino.financiamento.totalAmortizado || 0, valor);
                        }
                    }
                }
            });
            console.log("Saldos reconstru√≠dos.");
        },

// 2. Recalcula m√©dias de consumo e litros (CORRIGIDO)
        recalcularHistoricoCombustivel: () => {
             console.log("Recalculando hist√≥rico de combust√≠vel (Litros e M√©dias)...");
             const jornadasOrdenadas = Object.keys(AppState.jornadas).sort();
             
             // Reinicia tanque virtual se necess√°rio (opcional)
             // if (AppState.configuracoes.litrosRestantes < 0) AppState.configuracoes.litrosRestantes = 0;

             jornadasOrdenadas.forEach(chave => {
                 const jornada = AppState.jornadas[chave];
                 
                 // Garante estrutura
                 if (!jornada.totais) jornada.totais = { km: 0, combustivel: 0, outros: 0 };
                 
                 let totalComb = 0;
                 let totalLitros = 0;

                 // Soma itens de abastecimento
                 if (jornada.abastecimentos && Array.isArray(jornada.abastecimentos)) {
                     jornada.abastecimentos.forEach(a => { 
                         totalComb += (a.valorTotal || 0);
                         totalLitros += (a.litros || 0);
                     });
                 }
                 
                 // Atualiza Totais
                 jornada.totais.combustivel = Utils.somarCentavos(0, totalComb);
                 jornada.litrosAbastecidos = Math.round(totalLitros * 100) / 100;

                 // --- O PULO DO GATO: RECALCULAR A M√âDIA ---
                 if (jornada.totais.km > 0 && jornada.litrosAbastecidos > 0) {
                     jornada.mediaKmL = Math.round((jornada.totais.km / jornada.litrosAbastecidos) * 100) / 100;
                 } else {
                     jornada.mediaKmL = 0;
                 }
             });
             
             console.log("Hist√≥rico de combust√≠vel recalculado com sucesso.");
        }
    };
// =============================================================
    // ======================= FUEL AUDITOR (V36.1) ================
    // =============================================================
    const FuelAuditor = {
        // 1. SCORE DE EFICI√äNCIA
        calcularScore: (kmRodados, litros, veiculoConfig) => {
            if (!kmRodados || !litros || !veiculoConfig?.autonomia) return { score: 'N/A', classe: 'text-slate-500', nivel: 0 };
            const mediaReal = kmRodados / litros;
            const mediaEsperada = veiculoConfig.autonomia; 
            const variacao = (mediaReal - mediaEsperada) / mediaEsperada; 

            if (variacao >= 0.20) return { score: 'üèÜ Excelente', classe: 'text-emerald-400', nivel: 5, obs: 'Dire√ß√£o econ√¥mica' };
            if (variacao >= 0.05) return { score: '‚úÖ Bom', classe: 'text-green-400', nivel: 4, obs: 'Acima da meta' };
            if (variacao >= -0.05) return { score: '‚öñÔ∏è Normal', classe: 'text-slate-300', nivel: 3, obs: 'Dentro do esperado' };
            if (variacao >= -0.20) return { score: '‚ö†Ô∏è Aten√ß√£o', classe: 'text-orange-400', nivel: 2, obs: 'Consumo elevado' };
            return { score: 'üö® Cr√≠tico', classe: 'text-red-500', nivel: 1, obs: 'Verificar motor/pneus' };
        },

        // 2. DETEC√á√ÉO DE ANOMALIAS (CORRIGIDO PARA PARCELAMENTO/MISTO)
        detectarAnomalias: (dadosAtual, historico) => {
            const alertas = [];
            const { litros, precoPorLitro, kmAtual } = dadosAtual;
            
            // Filtra apenas abastecimentos reais (Categoria + Litros)
            const ultimos = [...historico]
                .filter(t => t.categoria === 'Abastecimento' && t.detalhes && t.detalhes.litros > 0)
                .sort((a, b) => new Date(b.data).getTime() - new Date(a.data).getTime())
                .slice(0, 3);

            // AN√ÅLISE DE PRE√áO (M√©dia M√≥vel)
            if (ultimos.length > 0) {
                const somaPreco = ultimos.reduce((acc, t) => {
                    const l = t.detalhes.litros || 1;
                    
                    // PATCH V36.1: Usa o Valor do Evento se existir (Misto/Parcelado)
                    // Se n√£o existir (Legado ou Simples), usa o Valor da Transa√ß√£o.
                    // Isso evita que parcelas gerem falso alerta de "pre√ßo muito baixo".
                    const valorReal = (t.detalhes.valorEvento !== undefined) ? t.detalhes.valorEvento : t.valor;
                    
                    const p = valorReal / l;
                    return acc + p;
                }, 0);
                
                const mediaPreco = somaPreco / ultimos.length;

                // A. Pre√ßo Alto (+20%)
                if (precoPorLitro > mediaPreco * 1.20) {
                    alertas.push(`üí∞ Pre√ßo R$ ${precoPorLitro.toFixed(2)}/L suspeito (+20% da m√©dia: R$ ${mediaPreco.toFixed(2)}).`);
                }

                // B. Pre√ßo Baixo (-30%)
                if (precoPorLitro < mediaPreco * 0.70) {
                    alertas.push(`üìâ Pre√ßo R$ ${precoPorLitro.toFixed(2)}/L suspeito (muito abaixo da m√©dia: R$ ${mediaPreco.toFixed(2)}). Verifique se digitou o valor total.`);
                }
            }

            // AN√ÅLISE DE VOLUME
            const tanqueMax = AppState.configuracoes.veiculo?.capacidadeTanque || 55;
            if (litros > tanqueMax * 1.1) {
                alertas.push(`üõ¢Ô∏è Volume (${litros}L) excede tanque (${tanqueMax}L).`);
            }

            return alertas;
        },

        // 3. ENRIQUECIMENTO
        enrichTransaction: (transacao, usuario = 'Motorista', isNew = false) => {
            const now = Date.now();
            if (!transacao._audit) transacao._audit = { createdAt: now, createdBy: usuario, log: [] };
            transacao._audit.updatedAt = now;
            transacao._audit.log.push({
                action: isNew ? 'CREATE' : 'UPDATE',
                ts: now,
                summary: `Valor: ${transacao.valor}, Litros: ${transacao.detalhes?.litros || 0}`
            });
            return transacao;
        }
    };
 // ===================== EVENT HANDLERS ========================
    // =============================================================
    const EventHandlers = {
        
setupListenersJornada: () => {
    const inputMeta = document.getElementById('metaHorasInput');
    
    if (inputMeta) {
        // Remove listener antigo para n√£o duplicar (se houver l√≥gica de refresh)
        const novoInput = inputMeta.cloneNode(true);
        inputMeta.parentNode.replaceChild(novoInput, inputMeta);
        
        // 1. SALVAR AO DIGITAR (Evento 'input')
        novoInput.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            const jornada = BusinessLogic.getJornadaAtiva();
            
            if (jornada) {
                jornada.metaHoras = val; // Salva na mem√≥ria RAM
                Storage.salvarJornadas(); // Salva no Disco
                
                // Calcula feedback visual na hora (opcional)
                const resultadoEl = document.getElementById('metaHoraResultado');
                if (resultadoEl && val > 0) {
                    // Exemplo: Atualiza texto de previs√£o
                    resultadoEl.textContent = `Meta: ${val}h`; 
                }
            }
        });
    }
},

// =========================================================================
    // LISTENER ESPEC√çFICO PARA O FORMUL√ÅRIO FINANCEIRO (NOVO) üÜï
    // =========================================================================
    setupListenersFormularioMetas: () => {
        // IDs dos campos que alteram o layout do formul√°rio
        const idsGatilho = [
            'metaTipoSelect',        // Poupan√ßa vs D√≠vida
            'metaJurosCheckbox',     // Calcular Juros?
            'metaTipoDividaSelect'   // Financiamento vs Cons√≥rcio
        ];

        idsGatilho.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // 1. Limpeza de listeners antigos (T√©cnica do Clone que voc√™ j√° usa)
                const novoEl = el.cloneNode(true);
                el.parentNode.replaceChild(novoEl, el);

                // 2. O Listener M√°gico ü™Ñ
                // Quando mudar (change), chama o Render para ele aplicar o 'hidden' ou n√£o
                novoEl.addEventListener('change', () => {
                    console.log(`üîÑ Altera√ß√£o detectada em ${id}. Atualizando form...`);
                    UIRenderer.renderMetasFinanceiras(); 
                });
            }
        });
    },
        // =================================================================
        // REALIZAR TRANSFER√äNCIA (L√≥gica Matem√°tica)
        // =================================================================
        handleRealizarTransferencia: (origemId, destinoId, valor) => {
            try {
                if (valor <= 0) throw new Error("Valor inv√°lido.");

                // 1. Identificar Origem e Destino
                let nomeOrigem = '';
                let nomeDestino = '';

                // Fun√ß√£o auxiliar para buscar e debitar/creditar
                const processarConta = (id, tipoOperacao) => {
                    // √â a Carteira?
                    if (id === 'AUTO_ID_CARTEIRA') {
                        // Carteira n√£o tem saldo armazenado fixo no AppState antigo, 
                        // mas vamos permitir a sa√≠da registrando a transa√ß√£o.
                        return 'Carteira';
                    }

                    // √â uma Meta?
                    let meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
                    if (meta) {
                        if (tipoOperacao === 'debito') {
                            if ((meta.valorAtual || 0) < valor) throw new Error(`Saldo insuficiente na meta: ${meta.descricao}`);
                            meta.valorAtual -= valor;
                        } else {
                            meta.valorAtual = (meta.valorAtual || 0) + valor;
                        }
                        return meta.descricao;
                    }

                    // √â uma Conta Banc√°ria?
                    let conta = AppState.configuracoes.contasBancarias.find(c => c.id === id);
                    if (conta) {
                        // Contas banc√°rias geralmente n√£o controlam saldo no app, servem s√≥ de destino/origem visual
                        // Mas se tiver campo de saldo, atualizamos:
                        if (conta.saldo !== undefined) {
                             if (tipoOperacao === 'debito') conta.saldo -= valor;
                             else conta.saldo += valor;
                        }
                        return conta.nome;
                    }

                    throw new Error("Conta/Meta n√£o encontrada.");
                };

                // 2. Executa a Movimenta√ß√£o
                nomeOrigem = processarConta(origemId, 'debito');
                nomeDestino = processarConta(destinoId, 'credito');

                // 3. Registra no Hist√≥rico (Para aparecer no extrato)
                const novaTransacao = {
                    id: Utils.gerarIdUnico(),
                    data: Date.now(),
                    tipo: 'transferencia', // Tipo novo
                    valor: valor,
                    contaId: origemId,      // De onde saiu
                    contaDestino: destinoId,// Para onde foi
                    categoria: 'Transfer√™ncia',
                    descricao: `Transf. de ${nomeOrigem} para ${nomeDestino}`,
                    detalhes: {
                        origem: nomeOrigem,
                        destino: nomeDestino
                    }
                };

                AppState.historicoTransacoes.push(novaTransacao);

                // 4. Salva e Atualiza
                Storage.salvarConfiguracoes();
                Storage.salvarHistoricoTransacoes();
                
                alert(`‚úÖ Sucesso!\n\nTransferido ${Utils.formatarMoeda(valor)}\nDe: ${nomeOrigem}\nPara: ${nomeDestino}`);
                
                UIRenderer.render(); // Atualiza a tela para ver os saldos novos

            } catch (error) {
                console.error(error);
                alert("Erro na transfer√™ncia: " + error.message);
            }
        },
        
// --- EXECUTAR ESTORNO REAL (VERSION: PLATINUM / PRODUCTION) ---
        // Implementa: Atomicidade, Consist√™ncia Financeira, Feedback de UI e Prote√ß√£o de Storage
        executarEstornoReal: (id) => {
            const transacao = AppState.historicoTransacoes.find(t => t.id === id);
            
            // 1. FEEDBACK DE UI E AUTOCURA (Caso a transa√ß√£o j√° n√£o exista)
            if (!transacao) {
                console.warn(`Tentativa de estorno em transa√ß√£o inexistente ou j√° removida: ${id}`);
                const el = document.querySelector(`button[data-id="${id}"]`)?.closest('li');
                
                if(el) {
                    el.remove(); // Autocura: remove o elemento visual "fantasma"
                    
                    // Feedback visual para o usu√°rio n√£o ficar confuso
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-5 right-5 bg-amber-600 text-white px-6 py-4 rounded-lg shadow-xl z-50 font-bold fade-in';
                    toast.innerHTML = `‚ö†Ô∏è Transa√ß√£o n√£o encontrada (provavelmente j√° removida). A lista foi atualizada.`;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                return;
            }

            console.log("Processando estorno completo para:", transacao.descricao);
            const batchId = transacao.detalhes?.batchId;
            const isFuel = transacao.categoria === 'Abastecimento';
            let afetouCustos = false;

            // --- BLOCO L√ìGICO DE NEG√ìCIO ---
            try {
                // A) Estorno de D√≠vida (Amortiza√ß√£o de Financiamento)
                if (transacao.categoria === 'Metas Financeiras' && transacao.descricao.includes('Amortiza√ß√£o')) {
                    const metas = AppState.configuracoes.metasFinanceiras;
                    const meta = metas.find(m => transacao.descricao.includes(m.descricao));

                    if (meta && meta.financiamento) {
                        // Revers√£o segura usando Integer Math
                        meta.financiamento.totalAmortizado = Math.max(0, Utils.Money.subtract(meta.financiamento.totalAmortizado || 0, transacao.valor));
                        
                        const matchParcelas = transacao.descricao.match(/\((\d+)\s*pcls\)/) || transacao.descricao.match(/\((\d+)\s*x\)/);
                        if (matchParcelas) {
                            const qtdDevolver = parseInt(matchParcelas[1]);
                            if(typeof meta.financiamento.parcelasPagas !== 'undefined') {
                                meta.financiamento.parcelasPagas = Math.max(0, meta.financiamento.parcelasPagas - qtdDevolver);
                            }
                        }
                    }
                }

                // B) Estorno de Combust√≠vel (Delega√ß√£o para FuelService - SRP)
                if (isFuel) {
                    const dataJornada = new Date(transacao.data);
                    
                    // Dados recuperados com seguran√ßa (Nullish Coalescing)
                    const litrosParaRemover = transacao.detalhes?.litros ?? 0;
                    const kmRegistrado = transacao.detalhes?.km ?? null; 
                    const leituraRegistrada = transacao.detalhes?.leitura ?? null;
                    
                    // 1. Revers√£o Matem√°tica e Estat√≠stica
                    if (typeof FuelService !== 'undefined' && FuelService.sincronizarJornada) {
                        // O servi√ßo sabe como remover (flag 'remover')
                        FuelService.sincronizarJornada(dataJornada, litrosParaRemover, transacao.valor, kmRegistrado, leituraRegistrada, 'remover');
                    } else {
                        // Fallback defensivo extremo (apenas tanque virtual)
                        AppState.configuracoes.litrosRestantes = Math.max(0, (AppState.configuracoes.litrosRestantes || 0) - litrosParaRemover);
                    }

                    // 2. Limpeza Visual do Registro na Jornada
                    const jornadaKey = Utils.formatarDataParaChave(dataJornada);
                    const jornada = AppState.jornadas[jornadaKey];
                    
                    if (jornada && Array.isArray(jornada.abastecimentos)) {
                        const lenAntes = jornada.abastecimentos.length;
                        jornada.abastecimentos = jornada.abastecimentos.filter(a => {
                            // Match exato por ID (Ideal)
                            if (a.txId && a.txId === transacao.id) return false;
                            // Match heur√≠stico seguro (Fallback para dados legados)
                            if (!a.txId && Math.abs(a.valorTotal - transacao.valor) < 0.01 && Math.abs(a.litros - litrosParaRemover) < 0.01) return false;
                            return true;
                        });
                        if (jornada.abastecimentos.length < lenAntes) {
                            console.log("Registro visual de abastecimento removido da jornada.");
                        }
                    }
                }

                // C) Custos Mensais (Meta Autom√°tica)
                const metaCustos = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                if (metaCustos) {
                    // Se o dinheiro saiu da caixinha, ele volta pra caixinha
                    if (transacao.contaId === 'META_CUSTOS_MENSAIS' && transacao.tipo === 'saida') {
                        metaCustos.valorAtual = Utils.Money.add(metaCustos.valorAtual, transacao.valor);
                        afetouCustos = true;
                    }
                    // Remove do log de sa√≠das para permitir novo pagamento
                    if (metaCustos.saidas) {
                        const lenAntes = metaCustos.saidas.length;
                        metaCustos.saidas = metaCustos.saidas.filter(s => s.id !== id && s.descricao !== transacao.descricao);
                        if (metaCustos.saidas.length < lenAntes) afetouCustos = true;
                    }
                }

                // D) Remo√ß√£o Financeira (ATOMICIDADE DE BATCH)
                if (batchId) {
                    // REGRA DE OURO: Se tem batchId, removemos TODAS as pernas da transa√ß√£o.
                    // Isso mant√©m o princ√≠pio de "Partidas Dobradas" (Double Entry).
                    AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !t.detalhes || t.detalhes.batchId !== batchId);
                } else {
                    AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => t.id !== id);
                }

                // E) Limpeza Visual de Outros Custos na Jornada
                if (!isFuel && (transacao.isCustoOperacional || transacao.jornadaId)) {
                    const dataT = new Date(transacao.data);
                    const jornadaKey = transacao.jornadaId || Utils.formatarDataParaChave(dataT);
                    const jornada = AppState.jornadas[jornadaKey];
                    if (jornada && jornada.custos && jornada.custos.outros) {
                        jornada.custos.outros = jornada.custos.outros.filter(c => c.id !== id);
                    }
                }

                // --- BLOCO DE PERSIST√äNCIA (SAFETY NET) ---
                try {
                    Storage.salvarConfiguracoes();
                    Storage.salvarJornadas(); // Essencial para persistir remo√ß√£o de custos/abastecimentos
                } catch (storageError) {
                    console.error("CRITICAL: Falha ao salvar estado ap√≥s estorno", storageError);
                    // Alerta cr√≠tico: O estado em mem√≥ria mudou, mas o disco n√£o.
                    alert("‚ö†Ô∏è ERRO DE ARMAZENAMENTO: O estorno foi calculado, mas n√£o p√¥de ser salvo (disco cheio?). Verifique o armazenamento do navegador.");
                }

                // --- UI UPDATE & SUCESSO ---
                UIRenderer.fecharModal(); 
                UIRenderer.render();
                
                // Recalcula barras de progresso
                if (typeof BusinessLogic.atualizarProgressoFinanciamentos === 'function') {
                    BusinessLogic.atualizarProgressoFinanciamentos();
                }
                
                // Feedback de Sucesso
                const toast = document.createElement('div');
                toast.className = 'fixed top-5 right-5 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 font-bold fade-in';
                toast.innerHTML = `‚úÖ Estorno de ${Utils.formatarMoeda(transacao.valor)} realizado com sucesso!`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
                
                // Se afetou a tela de Custos Mensais e ela estiver aberta, recarrega
                if (afetouCustos && AppState.modalContext === 'custosMensais') {
                    setTimeout(() => {
                        UIRenderer.abrirModal('visualizarCustosMensais', { meta: metaCustos });
                        if (EventHandlers.handleRenderModalCustos) EventHandlers.handleRenderModalCustos(new Date());
                    }, 500);
                }

            } catch (error) {
                // Catch-all para erros l√≥gicos imprevistos
                console.error("Erro fatal durante processo de estorno:", error);
                alert("‚ùå Ocorreu um erro ao processar o estorno. Por seguran√ßa, recarregue a p√°gina para validar os saldos.");
            }
        },
handleCarregarEdicaoCombustivel: (id) => {
            const transacao = AppState.historicoTransacoes.find(t => t.id === id);
            if (!transacao) return;

            // 1. Extrai dados b√°sicos da Transa√ß√£o Financeira
            const detalhes = transacao.detalhes || {};
            let litros = detalhes.litros || 0;
            let posto = detalhes.posto || '';
            
            // Fallbacks de Regex (caso os detalhes n√£o existam)
            if (litros === 0) {
                const matchL = transacao.descricao.match(/\(([\d,.]+)L\)/);
                litros = matchL ? parseFloat(matchL[1].replace(',', '.')) : 0;
            }
            if (!posto) {
                const parts = transacao.descricao.split(') no ');
                posto = parts.length > 1 ? parts[1] : '';
            }
            
            const tipoMatch = transacao.descricao.match(/Abastecimento: (.*?) \(/);
            const tipo = tipoMatch ? tipoMatch[1] : 'Gasolina Comum';

            // 2. >>> CORRE√á√ÉO: BUSCA DADOS T√âCNICOS NA JORNADA <<<
            let kmNoAto = 0;
            let leituraNoAto = 0;
            
            // Tenta achar a jornada pelo ID salvo ou pela data
            const idJornada = transacao.jornadaId || Utils.formatarDataParaChave(new Date(transacao.data));
            const jornada = AppState.jornadas[idJornada];

            if (jornada && jornada.custos && jornada.custos.abastecimento) {
                const abast = jornada.custos.abastecimento;
                kmNoAto = abast.km || 0;
                
                // Decide qual leitura pegar com base no modo configurado ou disponibilidade
                if (abast.litrosConsumidosPainel > 0) {
                    leituraNoAto = abast.litrosConsumidosPainel;
                } else {
                    leituraNoAto = abast.litrosRestantes || 0;
                }
            }
            // -----------------------------------------------------

            // 3. Preenche o formul√°rio
            document.getElementById('fuel-data').value = new Date(transacao.data).toISOString().split('T')[0];
            document.getElementById('fuel-hora').value = new Date(transacao.data).toTimeString().slice(0,5);
            document.getElementById('fuel-posto').value = posto;
            document.getElementById('fuel-tipo').value = tipo;
            document.getElementById('fuel-valor').value = Utils.formatarMoedaParaInput(transacao.valor);
            document.getElementById('fuel-litros').value = String(litros).replace('.', ',');
            
            // Preenche os campos recuperados da jornada
            document.getElementById('fuel-km').value = kmNoAto > 0 ? kmNoAto : '';
            document.getElementById('fuel-leitura').value = leituraNoAto > 0 ? String(leituraNoAto).replace('.', ',') : '';
            
            // Rating
            const rating = detalhes.rating || 0;
            document.getElementById('fuel-rating-value').value = rating;
            const stars = document.querySelectorAll('.star');
            stars.forEach(st => {
                st.classList.remove('text-yellow-400');
                st.classList.add('text-slate-600');
                if (st.dataset.val <= rating) {
                    st.classList.remove('text-slate-600');
                    st.classList.add('text-yellow-400');
                }
            });

            // 4. Configura estado de edi√ß√£o
            AppState.itemParaEditarId = id; 

            // 5. Muda para a aba Registrar e ajusta bot√£o
            document.querySelector('.fuel-tab-button[data-tab="registrar"]').click();
            
            const btnSalvar = document.getElementById('btn-salvar-abastecimento-pro');
            btnSalvar.textContent = 'Salvar Altera√ß√£o (Substituir)';
            btnSalvar.classList.remove('from-amber-600', 'to-orange-600');
            btnSalvar.classList.add('from-cyan-600', 'to-blue-600');
        },

handleDiaSemanaClick: (btn) => {
            const dia = parseInt(btn.dataset.dia);
            let diasAtivos = AppState.configuracoes.diasTrabalhoSemana;
            
            // CORRE√á√ÉO: Se 'diasAtivos' estiver corrompido (ex: n√∫mero 31), reseta para array vazio
            if (!Array.isArray(diasAtivos)) {
                diasAtivos = []; 
            }

            // Toggle (Adiciona ou Remove)
            if (diasAtivos.includes(dia)) {
                diasAtivos = diasAtivos.filter(d => d !== dia);
            } else {
                diasAtivos.push(dia);
            }
            
            // Salva a lista correta
            AppState.configuracoes.diasTrabalhoSemana = diasAtivos;
            Storage.salvarConfiguracoes();
            
            // Atualiza Visual
            UIRenderer.renderConfiguracoes();
            UIRenderer.render();
        },


// --- SALVAR PAGAMENTO DE FATURA (VERS√ÉO H√çBRIDA: PROVIS√ÉO + LOCK + AUDITORIA) ---
        handleSalvarPagamentoFatura: () => {
            const btn = document.getElementById('btn-confirmar-pgto-fatura');
            
            // 1. TRAVA DE UI
            if (btn.hasAttribute('data-processing')) return;
            btn.setAttribute('data-processing', 'true');
            const textoOriginal = btn.textContent;
            btn.textContent = "Processando...";
            btn.classList.add('opacity-50', 'cursor-wait');

            // Vari√°veis de Escopo para Rollback
            let snapshot = null;
            let pushedTxIds = [];
            let lockOwner = null; 

            const LOCK_KEY = 'app_payment_lock';
            
            const acquireLock = () => {
                const now = Date.now();
                const lockRaw = localStorage.getItem(LOCK_KEY);
                const myId = crypto.randomUUID();
                
                if (lockRaw) {
                    try {
                        const lock = JSON.parse(lockRaw);
                        if (now - lock.ts > 5000) {
                            lockOwner = myId;
                            localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: lockOwner, ts: now }));
                            return true;
                        }
                        return false; 
                    } catch {
                        lockOwner = myId;
                        localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: lockOwner, ts: now }));
                        return true;
                    }
                }
                
                lockOwner = myId;
                localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: lockOwner, ts: now }));
                return true;
            };

            const releaseLock = () => {
                try {
                    const raw = localStorage.getItem(LOCK_KEY);
                    if (!raw) return;
                    const lock = JSON.parse(raw);
                    if (lockOwner && lock.owner === lockOwner) {
                        localStorage.removeItem(LOCK_KEY);
                    }
                } catch {
                    localStorage.removeItem(LOCK_KEY); 
                }
            };

            if (!acquireLock()) {
                btn.removeAttribute('data-processing');
                btn.textContent = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-wait');
                UIRenderer.abrirModal('alerta', { titulo: 'Sistema Ocupado', mensagem: 'Outra opera√ß√£o est√° em andamento. Tente novamente.' });
                return;
            }

            try {
                const faturaId = document.getElementById('pgto-fatura-id').value;
                const origemId = document.getElementById('pgto-fatura-origem').value;
                const principal = Utils.parseMoeda(document.getElementById('pgto-fatura-principal').value);
                const descricaoManual = document.getElementById('pgto-fatura-desc').value.trim();
                
                // --- IDEMPOT√äNCIA ---
                let requestIdElem = document.getElementById('modal-request-id');
                if (!requestIdElem) {
                    const modalContainer = document.getElementById('modalContainer') || document.body;
                    requestIdElem = document.createElement('input');
                    requestIdElem.type = 'hidden';
                    requestIdElem.id = 'modal-request-id';
                    requestIdElem.value = crypto.randomUUID();
                    modalContainer.appendChild(requestIdElem);
                }
                const requestId = requestIdElem.value;

                if (AppState.historicoTransacoes.some(t => t.requestId === requestId)) {
                    throw new Error('DUPLICATE_REQUEST_SILENT');
                }

                // --- VALIDA√á√ÉO ---
                const faturaMeta = AppState.configuracoes.metasFinanceiras.find(m => m.id === faturaId);
                if (!faturaMeta) throw new Error('Fatura de destino n√£o encontrada.');

                // C√°lculos
                let encargos = 0;
                if (document.getElementById('chk-add-juros').checked) {
                    const multaPercent = parseFloat(document.getElementById('pgto-multa-percent').value) || 0;
                    const jurosValor = Utils.parseMoeda(document.getElementById('pgto-juros-valor').value);
                    encargos = (principal * (multaPercent / 100)) + jurosValor;
                }
                const totalPagar = principal + encargos;

                if (totalPagar <= 0) throw new Error('O valor total deve ser maior que zero.');
                if (!origemId) throw new Error('Selecione a origem do pagamento.');

                // üåü L√ìGICA DE ORIGEM (COM SUPORTE A PROVIS√ÉO)
                let origemRef = null;
                let origemTipo = 'conta';
                let origemNome = 'Origem';
                let usarProvisionado = false; // Flag nova

                if (origemId === 'USE_PROVISIONADO') {
                    // O dinheiro sai da PR√ìPRIA meta (do bolso provisionado dela)
                    origemRef = faturaMeta;
                    origemTipo = 'caixinha_interna';
                    origemNome = 'Saldo Guardado (Provis√£o)';
                    usarProvisionado = true;
                }
                else if (origemId === 'AUTO_ID_CARTEIRA') {
                    origemTipo = 'caixa';
                    origemNome = 'Carteira (Dinheiro)';
                } else {
                    const conta = AppState.configuracoes.contasBancarias.find(c => c.id === origemId);
                    if (conta) {
                        origemRef = conta;
                        origemNome = conta.nome;
                    } else {
                        const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === origemId);
                        if (meta) {
                            origemRef = meta;
                            origemTipo = 'caixinha';
                            origemNome = meta.descricao;
                        }
                    }
                }

                // Valida Saldo
                let saldoOrigem = 0;
                if (usarProvisionado) {
                    saldoOrigem = faturaMeta.valorProvisionado || 0;
                } else if (origemTipo === 'caixinha') {
                    saldoOrigem = (origemRef.tipo === 'parcelamento') ? (origemRef.valorProvisionado || 0) : (origemRef.valorAtual || 0);
                } else {
                    saldoOrigem = BusinessLogic.calcularSaldoConta(origemId);
                }

                if (saldoOrigem < totalPagar) throw new Error(`Saldo insuficiente em "${origemNome}".`);

                // Data
                let dataTimestamp = Date.now();
                const isRetroativo = document.getElementById('chk-pgto-retroativo').checked;
                if (isRetroativo) {
                    const dataRetroStr = document.getElementById('pgto-data-retro').value;
                    if (dataRetroStr) dataTimestamp = new Date(dataRetroStr + "T12:00:00").getTime();
                }

                const descFinal = descricaoManual || `Pagamento Fatura`;

                // 2. SNAPSHOT (Para Rollback)
                snapshot = {
                    origem: (origemTipo === 'caixinha' || usarProvisionado) ? { 
                        id: origemRef.id, 
                        valorAtual: origemRef.valorAtual, 
                        valorProvisionado: origemRef.valorProvisionado 
                    } : null,
                    destino: { // Snapshot do destino tamb√©m, pois vamos mexer nele
                        id: faturaMeta.id,
                        valorAtual: faturaMeta.valorAtual,
                        valorProvisionado: faturaMeta.valorProvisionado
                    }
                };

                // 3. MUTA√á√ÉO DE STATE (ATUALIZA√á√ÉO DE SALDOS)
                
                // A) Origem (Tira o dinheiro)
                if (usarProvisionado) {
                    // Tira do provisionado da pr√≥pria fatura
                    faturaMeta.valorProvisionado = Math.max(0, (faturaMeta.valorProvisionado || 0) - totalPagar);
                } else if (origemTipo === 'caixinha') {
                    if (origemRef.tipo === 'parcelamento') {
                        origemRef.valorProvisionado = Math.max(0, (origemRef.valorProvisionado || 0) - totalPagar);
                    } else {
                        origemRef.valorAtual = Math.max(0, (origemRef.valorAtual || 0) - totalPagar);
                    }
                }
                // Se for Conta/Carteira, o saldo √© calculado dinamicamente pelo hist√≥rico, ent√£o n√£o mudamos state direto.

                // B) Destino (Abate a D√≠vida/Valor Atual)
                // Se o pagamento for do Principal, a d√≠vida diminui
                if (principal > 0) {
                    faturaMeta.valorAtual = Math.max(0, (faturaMeta.valorAtual || 0) - principal);
                }

                // 4. REGISTRO CONT√ÅBIL
                
                // A) Principal
                if (principal > 0) {
                    const idSaida = crypto.randomUUID();
                    const txSaida = {
                        id: idSaida,
                        data: dataTimestamp,
                        tipo: 'saida',
                        // Se usar provisionado, a sa√≠da √© registrada na pr√≥pria meta para fins de auditoria, 
                        // mas com uma flag especial para n√£o duplicar no extrato global se necess√°rio
                        contaId: usarProvisionado ? faturaMeta.id : origemId, 
                        valor: principal,
                        descricao: `${descFinal} (Principal)`,
                        categoria: 'Pagamento de Fatura',
                        jornadaId: null,
                        requestId: requestId,
                        // Flag Vital para a Regra 2 (C√°lculo de Saldo):
                        isPagamentoReal: true, 
                        isUsoProvisao: usarProvisionado // Marcador para saber que consumiu a reserva
                    };

                    AppState.historicoTransacoes.push(txSaida);
                    pushedTxIds.push(idSaida);
                }

                // B) Encargos
                if (encargos > 0) {
                    const idEncargo = crypto.randomUUID();
                    AppState.historicoTransacoes.push({
                        id: idEncargo,
                        data: dataTimestamp,
                        tipo: 'saida',
                        contaId: usarProvisionado ? faturaMeta.id : origemId,
                        valor: encargos,
                        descricao: `${descFinal} (Juros/Multa)`,
                        categoria: 'Juros e Multas',
                        isCustoOperacional: false,
                        jornadaId: null,
                        requestId: requestId,
                        isPagamentoReal: true,
                        isUsoProvisao: usarProvisionado
                    });
                    pushedTxIds.push(idEncargo);
                }

                // 5. PERSIST√äNCIA
                try {
                    Storage.salvarConfiguracoes();
                } catch (e) {
                    throw new Error("Falha ao salvar dados: " + e.message);
                }

                try { if (requestIdElem) requestIdElem.remove(); } catch(e){}

                UIRenderer.fecharModal();
                UIRenderer.render();
                UIRenderer.renderContasBancarias();

                const dataMsg = isRetroativo ? ` (Data: ${Utils.formatarDataParaDisplay(new Date(dataTimestamp))})` : '';
                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Pago com Sucesso!', 
                    mensagem: `Total pago: ${Utils.formatarMoeda(totalPagar)}.${dataMsg}`, 
                    type: 'success' 
                });

            } catch (erro) {
                if (erro.message === 'DUPLICATE_REQUEST_SILENT') {
                    UIRenderer.fecharModal();
                    return;
                }
                console.error("Erro Pagamento Fatura:", erro);

                // 6. ROLLBACK
                if (snapshot) {
                    if (snapshot.origem && snapshot.origem.id) {
                        const metaOrigem = AppState.configuracoes.metasFinanceiras.find(m => m.id === snapshot.origem.id);
                        if (metaOrigem) {
                            metaOrigem.valorAtual = snapshot.origem.valorAtual;
                            metaOrigem.valorProvisionado = snapshot.origem.valorProvisionado;
                        }
                    }
                    if (snapshot.destino) {
                        const metaDestino = AppState.configuracoes.metasFinanceiras.find(m => m.id === snapshot.destino.id);
                        if (metaDestino) {
                            metaDestino.valorAtual = snapshot.destino.valorAtual;
                            metaDestino.valorProvisionado = snapshot.destino.valorProvisionado;
                        }
                    }
                }
                
                if (pushedTxIds.length > 0) {
                    AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !pushedTxIds.includes(t.id));
                }
                try { Storage.salvarConfiguracoes(); } catch (e) {}

                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: erro.message });
            } finally {
                releaseLock();
                btn.removeAttribute('data-processing');
                btn.textContent = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-wait');
            }
        },

/* 
// --- SALVAR PAGAMENTO DE FATURA (VERS√ÉO FINAL: LOCK OWNER + AUDITORIA + VALIDA√á√ÉO ESTRITA) ---
        handleSalvarPagamentoFatura: () => {
            const btn = document.getElementById('btn-confirmar-pgto-fatura');
            
            // 1. TRAVA DE UI
            if (btn.hasAttribute('data-processing')) return;
            btn.setAttribute('data-processing', 'true');
            const textoOriginal = btn.textContent;
            btn.textContent = "Processando...";
            btn.classList.add('opacity-50', 'cursor-wait');

            // Vari√°veis de Escopo para Rollback
            let snapshot = null;
            let pushedTxIds = [];
            let lockOwner = null; // Identificador √∫nico desta execu√ß√£o para o Lock

            // --- LOCK MULTI-TAB (COM PROPRIEDADE/OWNER) ---
            const LOCK_KEY = 'app_payment_lock';
            
            const acquireLock = () => {
                const now = Date.now();
                const lockRaw = localStorage.getItem(LOCK_KEY);
                
                // Gera um ID √∫nico para esta tentativa de execu√ß√£o
                const myId = crypto.randomUUID();
                
                if (lockRaw) {
                    try {
                        const lock = JSON.parse(lockRaw);
                        // Se expirou (mais de 5s), assumimos a posse
                        if (now - lock.ts > 5000) {
                            lockOwner = myId;
                            localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: lockOwner, ts: now }));
                            return true;
                        }
                        return false; // Est√° ocupado e v√°lido
                    } catch {
                        // Se o JSON estiver corrompido, assumimos a posse
                        lockOwner = myId;
                        localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: lockOwner, ts: now }));
                        return true;
                    }
                }
                
                // Se n√£o existe lock, criamos
                lockOwner = myId;
                localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: lockOwner, ts: now }));
                return true;
            };

            const releaseLock = () => {
                try {
                    const raw = localStorage.getItem(LOCK_KEY);
                    if (!raw) return;
                    const lock = JSON.parse(raw);
                    // S√≥ remove se EU for o dono (evita remover o lock de outra aba que assumiu ap√≥s expira√ß√£o)
                    if (lockOwner && lock.owner === lockOwner) {
                        localStorage.removeItem(LOCK_KEY);
                    }
                } catch {
                    localStorage.removeItem(LOCK_KEY); // Fallback de seguran√ßa
                }
            };

            if (!acquireLock()) {
                btn.removeAttribute('data-processing');
                btn.textContent = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-wait');
                UIRenderer.abrirModal('alerta', { titulo: 'Sistema Ocupado', mensagem: 'Outra opera√ß√£o est√° em andamento. Tente novamente em alguns segundos.' });
                return;
            }

            try {
                const faturaId = document.getElementById('pgto-fatura-id').value;
                const origemId = document.getElementById('pgto-fatura-origem').value;
                const principal = Utils.parseMoeda(document.getElementById('pgto-fatura-principal').value);
                const descricaoManual = document.getElementById('pgto-fatura-desc').value.trim();
                
                // --- IDEMPOT√äNCIA (RequestId) ---
                let requestIdElem = document.getElementById('modal-request-id');
                if (!requestIdElem) {
                    const modalContainer = document.getElementById('modalContainer') || document.body;
                    requestIdElem = document.createElement('input');
                    requestIdElem.type = 'hidden';
                    requestIdElem.id = 'modal-request-id';
                    requestIdElem.value = crypto.randomUUID();
                    modalContainer.appendChild(requestIdElem);
                }
                const requestId = requestIdElem.value;

                if (AppState.historicoTransacoes.some(t => t.requestId === requestId)) {
                    throw new Error('DUPLICATE_REQUEST_SILENT');
                }

                // --- VALIDA√á√ÉO DE INTEGRIDADE (FAIL FAST) ---
                // Verifica se a Fatura de destino realmente existe antes de continuar
                const faturaMeta = AppState.configuracoes.metasFinanceiras.find(m => m.id === faturaId);
                if (!faturaMeta) throw new Error('Fatura de destino n√£o encontrada (ID inv√°lido).');

                // C√°lculos
                let encargos = 0;
                if (document.getElementById('chk-add-juros').checked) {
                    const multaPercent = parseFloat(document.getElementById('pgto-multa-percent').value) || 0;
                    const jurosValor = Utils.parseMoeda(document.getElementById('pgto-juros-valor').value);
                    encargos = (principal * (multaPercent / 100)) + jurosValor;
                }
                const totalPagar = principal + encargos;

                // Valida√ß√µes de Valor
                if (totalPagar <= 0) throw new Error('O valor total deve ser maior que zero.');
                if (!origemId) throw new Error('Selecione a origem do pagamento.');

                // Identifica Origem
                let origemRef = null;
                let origemTipo = 'conta';
                let origemNome = 'Origem';

                if (origemId === 'AUTO_ID_CARTEIRA') {
                    origemTipo = 'caixa';
                    origemNome = 'Carteira (Dinheiro)';
                } else {
                    const conta = AppState.configuracoes.contasBancarias.find(c => c.id === origemId);
                    if (conta) {
                        origemRef = conta;
                        origemNome = conta.nome;
                    } else {
                        const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === origemId);
                        if (meta) {
                            origemRef = meta;
                            origemTipo = 'caixinha';
                            origemNome = meta.descricao;
                        }
                    }
                }

                // Valida Saldo (H√≠brido)
                let saldoOrigem = 0;
                if (origemTipo === 'caixinha') {
                    saldoOrigem = (origemRef.tipo === 'parcelamento') ? (origemRef.valorProvisionado || 0) : (origemRef.valorAtual || 0);
                } else {
                    saldoOrigem = BusinessLogic.calcularSaldoConta(origemId);
                }

                if (saldoOrigem < totalPagar) throw new Error(`Saldo insuficiente em "${origemNome}".`);

                // Data (Retroativo)
                let dataTimestamp = Date.now();
                const isRetroativo = document.getElementById('chk-pgto-retroativo').checked;
                if (isRetroativo) {
                    const dataRetroStr = document.getElementById('pgto-data-retro').value;
                    if (dataRetroStr) dataTimestamp = new Date(dataRetroStr + "T12:00:00").getTime();
                }

                const descFinal = descricaoManual || `Pagamento Fatura`;

                // 2. SNAPSHOT (Para Rollback e Auditoria)
                snapshot = {
                    origem: origemTipo === 'caixinha' ? { 
                        id: origemRef.id, 
                        valorAtual: origemRef.valorAtual, 
                        valorProvisionado: origemRef.valorProvisionado 
                    } : null
                };

                // 3. MUTA√á√ÉO DE STATE (Se origem for caixinha)
                if (origemTipo === 'caixinha') {
                    if (origemRef.tipo === 'parcelamento') {
                        origemRef.valorProvisionado = Math.max(0, (origemRef.valorProvisionado || 0) - totalPagar);
                    } else {
                        origemRef.valorAtual = Math.max(0, (origemRef.valorAtual || 0) - totalPagar);
                    }
                }

                // 4. REGISTRO CONT√ÅBIL
                
                // A) Principal (Abate D√≠vida)
                if (principal > 0) {
                    const idSaida = crypto.randomUUID();
                    const idEntrada = crypto.randomUUID();
                // PATCH 4: Transfer√™ncias (transferId + rollback)
                    const transferId = crypto.randomUUID();

                    const txSaida = {
                        id: idSaida,
                        data: dataTimestamp,
                        tipo: 'saida',
                        contaId: origemId,
                        valor: principal,
                        descricao: `${descFinal} (Principal)`,
                        categoria: 'Metas Financeiras',
                        jornadaId: null,
                        requestId: requestId,
                        // Auditoria: Guarda o estado anterior no registro
                        metaSnapshot: snapshot.origem ? { origemAntes: snapshot.origem } : undefined
                    };

                    const txEntrada = {
                        id: idEntrada,
                        data: dataTimestamp,
                        tipo: 'entrada', // Apenas entrada (Corre√ß√£o de tipagem)
                        contaId: faturaId,
                        valor: principal,
                        descricao: `Pagamento recebido via ${origemNome}`,
                        jornadaId: null,
                        requestId: requestId,
                        // Rastreabilidade: Link com a origem
                        origem: { id: origemId, nome: origemNome },
                        destino: { id: faturaId, nome: faturaMeta.descricao }
                    };

                    AppState.historicoTransacoes.push(txSaida, txEntrada);
                    pushedTxIds.push(idSaida, idEntrada);
                }

                // B) Encargos (Despesa Pura - S√≥ sai da origem, n√£o abate a d√≠vida)
                if (encargos > 0) {
                    const idEncargo = crypto.randomUUID();
                    AppState.historicoTransacoes.push({
                        id: idEncargo,
                        data: dataTimestamp,
                        tipo: 'saida',
                        contaId: origemId,
                        valor: encargos,
                        descricao: `${descFinal} (Juros/Multa)`,
                        categoria: 'Juros e Multas',
                        isCustoOperacional: false,
                        jornadaId: null,
                        requestId: requestId,
                        metaSnapshot: snapshot.origem ? { origemAntes: snapshot.origem } : undefined
                    });
                    pushedTxIds.push(idEncargo);
                }

                // 5. PERSIST√äNCIA
                try {
                    Storage.salvarConfiguracoes();
                } catch (e) {
                    throw new Error("Falha ao salvar dados: " + e.message);
                }

                // Limpeza Sucesso
                try { if (requestIdElem) requestIdElem.remove(); } catch(e){}

                UIRenderer.fecharModal();
                UIRenderer.render();
                UIRenderer.renderContasBancarias();

                const dataMsg = isRetroativo ? ` (Data: ${Utils.formatarDataParaDisplay(new Date(dataTimestamp))})` : '';
                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Pago com Sucesso!', 
                    mensagem: `Total debitado: ${Utils.formatarMoeda(totalPagar)}.${dataMsg}`, 
                    type: 'success' 
                });

            } catch (erro) {
                if (erro.message === 'DUPLICATE_REQUEST_SILENT') {
                    UIRenderer.fecharModal();
                    return;
                }
                console.error("Erro Pagamento Fatura:", erro);

                // 6. ROLLBACK
                if (snapshot && snapshot.origem) {
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === snapshot.origem.id);
                    if (meta) {
                        meta.valorAtual = snapshot.origem.valorAtual;
                        meta.valorProvisionado = snapshot.origem.valorProvisionado;
                    }
                }
                if (pushedTxIds.length > 0) {
                    AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !pushedTxIds.includes(t.id));
                }
                // Tenta salvar o estado revertido
                try { Storage.salvarConfiguracoes(); } catch (e) {}

                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: erro.message });
            } finally {
                releaseLock();
                btn.removeAttribute('data-processing');
                btn.textContent = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-wait');
            }
        },


 */

// --- ADICIONE APENAS ESTA FUN√á√ÉO AQUI ---
        handleSanearDados: () => {
            const confirmacao = confirm("ATEN√á√ÉO: Deseja realizar o SANEAMENTO E RECONSTRU√á√ÉO dos dados?\n\nIsso ir√°:\n1. Corrigir formata√ß√µes.\n2. RECALCULAR saldos do zero.\n3. Corrigir combust√≠vel.\n\nRecomendado se o DRE estiver zerado.");
            
            if (!confirmacao) return;
            const btn = document.getElementById('btn-sanear-dados');
            if(btn) { btn.textContent = "Processando..."; btn.disabled = true; }

            try {
                // 1. Limpeza de Formatos
                AppState.historicoTransacoes = AppState.historicoTransacoes.map(t => {
                    t.data = Utils.parseDataSegura(t.data);
                    t.valor = Utils.parseMoeda(t.valor);
                    return t;
                });
                
                if (Array.isArray(AppState.configuracoes.custosFixos)) {
                    AppState.configuracoes.custosFixos.forEach(c => c.valor = Utils.parseMoeda(c.valor));
                }
                if (Array.isArray(AppState.configuracoes.contasRecorrentes)) {
                    AppState.configuracoes.contasRecorrentes.forEach(c => c.valor = Utils.parseMoeda(c.valor));
                }
                AppState.configuracoes.proLabore = Utils.parseMoeda(AppState.configuracoes.proLabore);
                
                // 2. Reconstru√ß√£o L√≥gica (Usa o objeto DataRepair que criamos acima)
                DataRepair.reconstruirSaldos();
                DataRepair.recalcularHistoricoCombustivel();

                Storage.salvarConfiguracoes();
                Storage.salvarJornadas();
                
                alert("SUCESSO: Base de dados saneada e saldos reconstru√≠dos!");
                window.location.reload();

            } catch (e) {
                console.error("Erro cr√≠tico:", e);
                alert("Erro: " + e.message);
                if(btn) { btn.textContent = "Sanear Base de Dados"; btn.disabled = false; }
            }
        },
// --- SALVAR RETROATIVO (CORRIGIDO: REFRESH IMEDIATO + DETALHES) ---
        handleSalvarRetroativo: () => {
            const dataStr = document.getElementById('retro-data').value;
            const litros = Utils.parseMoeda(document.getElementById('retro-litros').value);
            const valor = Utils.parseMoeda(document.getElementById('retro-valor').value);
            const leitura = Utils.parseMoeda(document.getElementById('retro-leitura').value);
            const km = parseInt(document.getElementById('retro-km').value) || 0;
            const contaId = document.getElementById('retro-conta-id').value;

            if (!dataStr || litros <= 0 || valor <= 0) {
                 UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha Data, Litros e Valor.' });
                 return;
            }

            const dataObj = new Date(dataStr + "T12:00:00");
            const jornadaRetro = BusinessLogic.getJornadaDoDia(dataObj);
            
            // 1. Atualiza a Jornada (C√°lculo da M√©dia)
            const litrosAnt = jornadaRetro.custos.abastecimento.litros || 0;
            const valorAnt = jornadaRetro.custos.abastecimento.valor || 0;
            
            jornadaRetro.custos.abastecimento.litros = litrosAnt + litros;
            jornadaRetro.custos.abastecimento.valor = valorAnt + valor;
            
            // O KM do abastecimento √© crucial para a m√©dia
            if (km > 0) jornadaRetro.custos.abastecimento.km = km;

            // C√°lculo do Restante/Leitura
            const { metodoLeituraCombustivel } = AppState.configuracoes;
            let restanteFinal = 0;

            if (metodoLeituraCombustivel === 'consumo') {
                jornadaRetro.custos.abastecimento.litrosConsumidosPainel = leitura;
                const anterior = BusinessLogic.findLastRefuelData(dataObj) || { litrosRestantes: 0 };
                jornadaRetro.custos.abastecimento.litrosRestantes = Math.max(0, (anterior.litrosRestantes + litros) - leitura);
            } else {
                jornadaRetro.custos.abastecimento.litrosRestantes = leitura;
                jornadaRetro.custos.abastecimento.litrosConsumidosPainel = 0;
            }
            
            // Recalcula a m√©dia deste dia retroativo
            const mediaObj = BusinessLogic.calcularMediaConsumo(jornadaRetro, dataObj);
            jornadaRetro.custos.abastecimento.mediaCalculada = mediaObj.media;

            // 2. Cria a Transa√ß√£o Financeira (COM DETALHES T√âCNICOS)
            // Agora salvamos tudo dentro de 'detalhes' para o bot√£o Editar funcionar depois
            const novaTransacao = {
                id: crypto.randomUUID(),
                data: dataObj.getTime(),
                contaId: contaId,
                tipo: 'saida',
                valor: valor,
                descricao: `Abastecimento Retroativo (${litros}L)`,
                categoria: 'Abastecimento',
                isCustoOperacional: true,
                jornadaId: Utils.formatarDataParaChave(dataObj),
                detalhes: {
                    litros: litros,
                    km: km,
                    leitura: leitura,
                    posto: 'Retroativo',
                    tanqueCheio: false
                }
            };

            AppState.historicoTransacoes.push(novaTransacao);

            // 3. Salva Tudo
            Storage.salvarJornadas();
            Storage.salvarConfiguracoes();
            
            UIRenderer.fecharModal();
            UIRenderer.abrirModal('alerta', { titulo: 'Salvo!', mensagem: 'Abastecimento registrado e m√©dia recalculada.', type: 'success' });
            
            // 4. >>> REFRESH INTELIGENTE <<<
            // Se a data do retroativo for a mesma que estou vendo na tela, atualiza a UI agora!
            if (dataStr === Utils.formatarDataParaChave(AppState.dataSelecionada)) {
                UIRenderer.render(); // Isso preenche os campos "KM Atual", "Litros", etc.
            }
        },


handleSalvarRetroativoLote: () => {
            const checkboxes = document.querySelectorAll('.chk-retro-parcela:checked:not([disabled])');
            if (checkboxes.length === 0) return;

            const metaId = AppState.itemParaEditarId;
            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
            if (!meta) return;

            let totalPago = 0;
            let qtdPagas = 0;
            const agora = Date.now(); // Usa um timestamp base para garantir ordem

            checkboxes.forEach((chk, index) => {
                const num = chk.dataset.num;
                const dataInput = document.getElementById(`retro-data-${num}`).value;
                const valorInput = document.getElementById(`retro-valor-${num}`).value;
                
                const valor = Utils.parseMoeda(valorInput);
                // Adiciona milissegundos para n√£o ficarem com ID igual ou ordem errada
                const dataTs = new Date(dataInput + "T12:00:00").getTime() + index; 

                if (valor > 0) {
                    AppState.historicoTransacoes.push({
                        id: crypto.randomUUID(),
                        data: dataTs,
                        tipo: 'entrada',
                        valor: valor,
                        contaId: metaId,
                        descricao: `Registro Hist√≥rico: Parcela ${num}`,
                        categoria: 'Metas Financeiras',
                        jornadaId: null,
                        detalhes: { qtdParcelas: 1, tipo: 'importacao_historico' }
                    });

                    totalPago += valor;
                    qtdPagas++;
                }
            });
            
            if (qtdPagas > 0) {
                // Apenas INCREMENTA as pagas. N√ÉO mexe no totalParcelas.
                if (!meta.financiamento.parcelasPagas) meta.financiamento.parcelasPagas = 0;
               // meta.financiamento.parcelasPagas += qtdPagas;
                
                meta.financiamento.totalAmortizado = (meta.financiamento.totalAmortizado || 0) + totalPago;
                
                Storage.salvarConfiguracoes();
                BusinessLogic.atualizarProgressoFinanciamentos();
                
                UIRenderer.fecharModal(); 
                UIRenderer.fecharModal(); 
                UIRenderer.render();
                UIRenderer.renderMetasFinanceiras();

                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Hist√≥rico Atualizado', 
                    mensagem: `${qtdPagas} parcelas antigas foram registradas.`, 
                    type: 'success' 
                });
            }
        },

// --- Salvar edi√ß√£o de Custo Fixo ---
handleSalvarEdicaoCustoFixo: () => {
    
    const itemId = AppState.itemParaEditarId;
    if (!itemId) {
        console.warn("Nenhum item selecionado para edi√ß√£o (itemParaEditarId vazio).");
        UIRenderer.fecharModal();
        return;
    }

    const item = AppState.configuracoes.custosFixos.find(c => c.id === itemId);
    if (!item) {
        console.warn("Item n√£o encontrado para edi√ß√£o:", itemId);
        UIRenderer.fecharModal();
        return;
    }

    const descricao = (document.getElementById('editDescricao')?.value || '').trim();
    const valor = Utils.parseMoeda(document.getElementById('editValor')?.value || '');
    const vencimento = parseInt(document.getElementById('editVencimento')?.value) || 0;
    const categoria = document.getElementById('editCategoriaCustoFixo')?.value || item.categoria;
    const subcategoriaInput = document.getElementById('editSubcategoriaCustoFixo')?.value || '';
    const subcategoria = subcategoriaInput.trim() === '' ? 'N/A' : subcategoriaInput.trim();

    // Valida√ß√µes simples
    if (!descricao || valor <= 0) {
        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha a descri√ß√£o e um valor mensal maior que zero.' });
        return;
    }
    if (vencimento < 1 || vencimento > 31) {
        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'O Dia de Vencimento deve ser entre 1 e 31.' });
        return;
    }

    // Atualiza o item
    item.descricao = descricao;
    item.valor = valor;
    item.vencimento = vencimento;
    item.categoria = categoria;
    item.subcategoria = subcategoria;

    // Atualiza depend√™ncias / metas
    if (typeof BusinessLogic !== 'undefined' && BusinessLogic.atualizarMetaCustosMensais) {
        BusinessLogic.atualizarMetaCustosMensais();
    }

    // Persiste e atualiza UI
    if (typeof Storage !== 'undefined' && Storage.salvarConfiguracoes) {
        Storage.salvarConfiguracoes();
    }

    // Fecha modal e re-renderiza a lista espec√≠fica para garantir atualiza√ß√£o imediata
    UIRenderer.fecharModal();
    if (UIRenderer.renderListaCustosFixos) {
        UIRenderer.renderListaCustosFixos(); // for√ßa apenas a lista relevante
    } else {
        UIRenderer.render();
        
    }
    if (UIRenderer.renderListaCustosFixos) UIRenderer.renderListaCustosFixos();
    // limpa estado de edi√ß√£o
    AppState.itemParaEditarId = null;
},
handleFactoryReset: () => {
            UIRenderer.abrirModal('confirmacao', {
                titulo: 'ZERAR TUDO?',
                mensagem: 'ATEN√á√ÉO: Isso apagar√° TODO o hist√≥rico, configura√ß√µes, contas e metas. O aplicativo voltar√° ao estado original. N√£o h√° como desfazer.',
                confirmLabel: 'SIM, APAGAR TUDO',
                confirmClass: 'bg-red-600 hover:bg-red-800',
                showAbort: true,
                callback: (confirmado) => {
                    if (confirmado) {
                        // Lista de todas as chaves do sistema v7.3+
                        const chaves = [
                            'jornadasTrabalho_v6.4',
                            'configuracoesDiario_v6.4',
                            'historicoTransacoes_v6.4',
                            'historicoManutencao_v6.4',
                            'cotaManutencao_v6.4',
                            'visualSettings_v6_4',
                            'activeJornadaChave_v6.4',
                            'lastDescriptions_v6.4',
                            'lastSubcategories_v6.4',
                            'ultimoBackupData'
                        ];

                        chaves.forEach(key => localStorage.removeItem(key));
                        
                        alert("Sistema resetado com sucesso.");
                        location.reload();
                    }
                }
            });
        },

handleListaContasRecorrentes: (e) => {
            const btn = e.target.closest('button'); 
            if (!btn) return;
            
            const id = btn.dataset.id;
            
            // EXCLUIR COM CONFIRMA√á√ÉO
            if (btn.classList.contains('btn-excluir-conta-recorrente')) {
                 UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Conta?',
                    mensagem: 'Deseja remover esta conta recorrente da lista? Os alertas de pagamento parar√£o.',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (confirmado) => {
                        if (confirmado) {
                            AppState.configuracoes.contasRecorrentes = AppState.configuracoes.contasRecorrentes.filter(c => c.id !== id);
                            Storage.salvarConfiguracoes();
                            UIRenderer.renderContasRecorrentes();
                            
                            // Atualiza alertas silenciosamente
                            try {
                                const jornadaDoDia = BusinessLogic.getJornadaDoDia(new Date());
                                UIRenderer.renderAlertasJornada(jornadaDoDia);
                                UIRenderer.renderAlertasContasRecorrentes(jornadaDoDia);
                            } catch(err) {}
                        }
                    }
                });
                return;
            }
            
            // EDITAR
            if (btn.classList.contains('btn-editar-conta-recorrente')) {
                const conta = AppState.configuracoes.contasRecorrentes.find(c => c.id === id);
                if (conta) {
                    AppState.itemParaEditarId = id;
                    UIRenderer.abrirModal('edicaoContaRecorrente', { item: conta });
                }
            }
        },
        handleDownload: () => {
            const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
            if (!jornada || (jornada.atividades.length === 0 && jornada.status === 'inativa')) {
                UIRenderer.abrirModal('alerta', { titulo: 'Sem Dados', mensagem: 'N√£o h√° dados para baixar para este dia.' });
                return;
            }

            const resumo = BusinessLogic.calcularResumoDia(jornada, AppState.dataSelecionada);
            const { 
                totalGanhosFinalizados, duracaoPausas, tempoLiquido, 
                kmTotal, custoOperacionalTotal, lucroReal
            } = resumo;

            let conteudo = `Resumo do Di√°rio de Bordo - ${Utils.formatarDataParaDisplay(AppState.dataSelecionada)}\n`;
            conteudo += `==================================================\n\n`;
            conteudo += `VIS√ÉO GERAL FINANCEIRA\n--------------------------------------------------\n`;
            conteudo += `Ganhos Brutos:      ${Utils.formatarMoeda(totalGanhosFinalizados)}\n`;
            conteudo += `Custo Operacional:  ${Utils.formatarMoeda(custoOperacionalTotal)}\n`;
            conteudo += `LUCRO REAL:         ${Utils.formatarMoeda(lucroReal)}\n\n`;
            
            conteudo += `DESEMPENHO\n--------------------------------------------------\n`;
            conteudo += `Tempo L√≠quido:      ${Utils.formatarDuracao(tempoLiquido)}\n`;
            conteudo += `Tempo em Pausa:     ${Utils.formatarDuracao(duracaoPausas)}\n\n`;

            if (jornada.kmInicial > 0) {
                conteudo += `QUILOMETRAGEM\n--------------------------------------------------\n`;
                conteudo += `KM Rodados (Jornada): ${Utils.formatarDistancia(kmTotal)}\n`;
                if(kmTotal > 0) {
                   conteudo += `Custo Op./KM:         ${Utils.formatarMoedaPorKm(custoOperacionalTotal / kmTotal)}\n\n`;
                }
            }
            
            conteudo += `ATIVIDADES FINALIZADAS (${jornada.atividades.length})\n==================================================\n`;
            if (jornada.atividades.length > 0) {
                jornada.atividades.slice().reverse().forEach(at => {
                    const subcatInfo = at.subcategoria ? ` (${at.subcategoria})` : '';
                    conteudo += `\n- Valor: ${Utils.formatarMoeda(at.valor)} (${at.categoria}${subcatInfo}) | ${Utils.formatarHora(at.inicio)} - ${Utils.formatarHora(at.fim)}\n`;
                    conteudo += `  Descri√ß√£o: ${at.descricao || 'N/A'}\n`;
                });
            } else {
                conteudo += `Nenhuma atividade finalizada.\n`;
            }

            const blob = new Blob(["\uFEFF", conteudo], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diario-de-bordo-${Utils.formatarDataParaChave(AppState.dataSelecionada)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
        },
// --- RENDERIZA O MODAL DE CUSTOS MENSAIS (COM SLIDERS LISOS/SMOOTH) ---
        handleRenderModalCustos: (dataReferencia) => {
            const metaId = AppState.itemParaEditarId;
            
            // 1. Sincroniza e Valida
            if (metaId === 'META_CUSTOS_MENSAIS') {
                if (BusinessLogic.atualizarMetaCustosMensais) {
                    BusinessLogic.atualizarMetaCustosMensais(); 
                }
            }
            
            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
            if (!meta) return;

            AppState.custosModalState.data = dataReferencia;
            const hoje = new Date();
            const chaveMes = `${dataReferencia.getFullYear()}-${dataReferencia.getMonth()}`;
            
            if (!meta.aceleradorMensal) meta.aceleradorMensal = {};

            // 2. C√°lculos Financeiros
            const custoBase = BusinessLogic.calcularCustoDiarioMeta({ ...meta, aceleradorMensal: {} }, dataReferencia);
            const valorAceleradorSalvo = meta.aceleradorMensal[chaveMes] || 0;
            const valorInicialInput = Math.max(custoBase, valorAceleradorSalvo);
            
            AppState.custosModalState.acelerador = valorInicialInput;
            if (AppState.custosModalState.originalAcelerador === 0) {
                 AppState.custosModalState.originalAcelerador = valorInicialInput;
            }
            
            // Define o valor total da acelera√ß√£o (Gordura)
            const valorAceleracaoTotal = Math.max(0, valorInicialInput - custoBase);
            meta.valorAceleracaoDiaria = valorAceleracaoTotal; 

            // Garante pesos iniciais
            if (!meta.custosDetalhados) meta.custosDetalhados = [];
            const totalItens = Math.max(1, meta.custosDetalhados.length);
            meta.custosDetalhados.forEach(c => {
                if (typeof c.pesoAceleracao === 'undefined' || c.pesoAceleracao === null) {
                    c.pesoAceleracao = (100 / totalItens);
                }
            });

            // 3. V√≠nculo Banc√°rio
            const { contasBancarias } = AppState.configuracoes;
            let optionsBancos = `<option value="">-- Sem V√≠nculo (Caixinha Virtual) --</option>`;
            optionsBancos += `<option value="AUTO_ID_CARTEIRA" ${meta.bancoId === 'AUTO_ID_CARTEIRA' ? 'selected' : ''}>üíµ Carteira (Dinheiro)</option>`;
            contasBancarias.forEach(c => {
                if (c.tipo !== 'credito') {
                    const selected = meta.bancoId === c.id ? 'selected' : '';
                    optionsBancos += `<option value="${c.id}" ${selected}>${c.nome}</option>`;
                }
            });

            const mesDisplay = dataReferencia.toLocaleString('pt-BR', { month: 'long' });
            const anoDisplay = dataReferencia.getFullYear();
            const proxMes = new Date(dataReferencia);
            proxMes.setMonth(proxMes.getMonth() + 1);
            proxMes.setDate(1);

            const saldoRealTotal = BusinessLogic.calcularSaldoConta(meta.id);
            const ano = dataReferencia.getFullYear();
            const mes = dataReferencia.getMonth();
            const totalPrevisto = meta.valorTotal || 0;
            
            const saidasDesteMes = (meta.saidas || []).filter(s => {
                const d = new Date(s.data);
                return d.getMonth() === mes && d.getFullYear() === ano;
            });
            const totalSaidasValor = saidasDesteMes.reduce((acc, s) => acc + s.valor, 0);
            const saldoFinalProjetado = totalPrevisto - totalSaidasValor;
            const valorRestante = totalPrevisto - saldoRealTotal;

            // --- HTML DO MODAL ---
            const modalHTML = `
                <div class="bg-slate-800 rounded-lg p-6 w-full max-w-4xl shadow-xl" style="max-height: 90vh; overflow-y: auto;">
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3 border-b border-slate-700 pb-3">
                        <div>
                            <h3 class="text-xl font-bold text-sky-400">üìâ Custos Mensais</h3>
                            <div class="flex items-center gap-2 mt-1 bg-slate-900/50 p-1 rounded border border-slate-700">
                                <span class="text-[10px] text-slate-400 uppercase font-bold pl-1">V√≠nculo:</span>
                                <select id="select-banco-vinculado-custos" class="bg-slate-700 border border-slate-600 text-white text-xs rounded p-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                                    ${optionsBancos}
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2 text-lg font-semibold bg-slate-900/50 px-3 py-1 rounded-full">
                                <button id="btn-custo-mes-ant" class="p-1 text-slate-400 hover:text-white transition">‚Üê</button>
                                <span id="custo-mes-ano-display" class="text-sm min-w-[100px] text-center capitalize">${mesDisplay} ${anoDisplay}</span>
                                <button id="btn-custo-mes-prox" class="p-1 text-slate-400 hover:text-white transition" ${proxMes > hoje ? 'disabled' : ''}>‚Üí</button>
                            </div>
                            <button class="btn-cancelar text-slate-400 hover:text-white text-2xl ml-2">√ó</button>
                        </div>
                    </div>

                    <div class="flex justify-center border-b border-slate-700 text-sm mb-4">
                        <button class="custo-modal-tab-button py-2 px-4 font-semibold active" data-tab="resumo">Resumo</button>
                        <button class="custo-modal-tab-button py-2 px-4 font-semibold" data-tab="itens">Itens & Pesos</button>
                        <button class="custo-modal-tab-button py-2 px-4 font-semibold" data-tab="detalhado">Detalhado</button>
                    </div>

                    <div id="custo-modal-content-resumo" class="custo-modal-tab-pane space-y-4">
                        <div class="grid grid-cols-2 gap-3 text-center">
                            <div class="bg-slate-700 p-3 rounded"><span class="block text-sm text-slate-400">Saldo Real</span><span class="font-bold text-3xl text-green-400">${Utils.formatarMoeda(saldoRealTotal)}</span></div>
                            <div class="bg-slate-700 p-3 rounded"><span class="block text-sm text-slate-400">Saldo Esperado</span><span class="font-bold text-3xl text-cyan-400">${Utils.formatarMoeda(saldoFinalProjetado)}</span></div>
                            <div class="bg-slate-700 p-3 rounded"><span class="block text-xs text-slate-400">Total Previsto</span><span class="font-bold text-lg text-white">${Utils.formatarMoeda(totalPrevisto)}</span></div>
                            <div class="bg-slate-700 p-3 rounded"><span class="block text-xs text-slate-400">Total Sa√≠das</span><span class="font-bold text-lg text-amber-400">${Utils.formatarMoeda(totalSaidasValor)}</span></div>
                        </div>
                        
                        <div id="acelerador-container" class="p-4 bg-slate-700/50 rounded space-y-3 ${valorRestante <= 0 ? 'hidden' : ''}">
                            <h4 class="text-lg font-semibold text-slate-300 text-center">Acelerar Provisionamento</h4>
                            <div class="text-center"><span class="text-sm text-slate-400">Base:</span><span id="custo-acelerar-base" class="font-bold text-lg text-white">${Utils.formatarMoeda(custoBase)}</span></div>
                            <div class="flex items-center justify-center gap-3">
                                <button id="btn-acelerar-menos" class="p-2 bg-slate-600 rounded hover:bg-slate-500 text-white font-bold w-10">-</button>
                                <input type="text" id="input-acelerar-meta" class="w-32 bg-slate-800 border-slate-600 rounded p-3 text-white text-center font-bold" value="${Utils.formatarMoedaParaInput(valorInicialInput)}">
                                <button id="btn-acelerar-mais" class="p-2 bg-slate-600 rounded hover:bg-slate-500 text-white font-bold w-10">+</button>
                            </div>
                            <p id="custo-acelerar-resultado" class="text-center text-cyan-300 text-sm h-4"></p>
                        </div>
                        <div id="surplus-container" class="${valorRestante <= 0 ? '' : 'hidden'} p-4 bg-emerald-900/50 border border-emerald-600 rounded text-center"><h4 class="text-lg font-bold text-emerald-400">Custo Coberto!</h4><p class="text-sm text-slate-300">Excedente: <b id="custo-surplus-valor">${Utils.formatarMoeda(Math.abs(valorRestante))}</b></p></div>
                    </div>
                    
                    <div id="custo-modal-content-itens" class="custo-modal-tab-pane space-y-4 hidden"></div>
                    
                    <div id="custo-modal-content-detalhado" class="custo-modal-tab-pane space-y-4 hidden"></div>
                </div>`;
            
            UIElements.modalContainer.innerHTML = modalHTML;
            UIElements.modalContainer.classList.remove('hidden');

            setTimeout(() => {
                // Listeners Comuns
                if (document.getElementById('select-banco-vinculado-custos')) {
                    document.getElementById('select-banco-vinculado-custos').addEventListener('change', (e) => {
                        meta.bancoId = e.target.value;
                        Storage.salvarConfiguracoes();
                    });
                }
                
                // --- L√ìGICA DO ACELERADOR (ABA RESUMO) ---
                const atualizarAcelerador = (incremento) => {
                    const input = document.getElementById('input-acelerar-meta');
                    let val = Utils.parseMoeda(input.value);
                    val = Math.max(custoBase, val + incremento);
                    input.value = Utils.formatarMoedaParaInput(val);
                    
                    const extra = Math.max(0, val - custoBase);
                    meta.valorAceleracaoDiaria = extra;
                    meta.aceleradorMensal[chaveMes] = val;
                    Storage.salvarConfiguracoes();

                    const txt = document.getElementById('custo-acelerar-resultado');
                    if (extra > 0) {
                        const diasTrabalho = BusinessLogic.calcularDiasTrabalhoNoMes(ano, mes);
                        txt.innerHTML = `<span class="text-cyan-300 font-bold">‚ö° TURBO ATIVADO:</span> + ${Utils.formatarMoeda(extra)}/dia.<br><span class="text-xs opacity-80">Gordura extra de ${Utils.formatarMoeda(extra * diasTrabalho)} este m√™s.</span>`;
                    } else {
                        txt.textContent = "Modo Padr√£o (Sem extra).";
                    }
                    
                    // Atualiza a aba Itens em tempo real
                    refreshValues(null, true);
                };

                document.getElementById('btn-acelerar-mais').onclick = () => atualizarAcelerador(1);
                document.getElementById('btn-acelerar-menos').onclick = () => atualizarAcelerador(-1);
                document.getElementById('input-acelerar-meta').onchange = () => atualizarAcelerador(0);
                
                // Init Texto
                const txtInit = document.getElementById('custo-acelerar-resultado');
                const extraInit = Math.max(0, valorInicialInput - custoBase);
                if (extraInit > 0) {
                     const diasTrabalho = BusinessLogic.calcularDiasTrabalhoNoMes(ano, mes);
                     txtInit.innerHTML = `<span class="text-cyan-300 font-bold">‚ö° TURBO ATIVADO:</span> + ${Utils.formatarMoeda(extraInit)}/dia.<br><span class="text-xs opacity-80">Gordura extra de ${Utils.formatarMoeda(extraInit * diasTrabalho)} este m√™s.</span>`;
                } else {
                     txtInit.textContent = "Modo Padr√£o (Sem extra).";
                }

                // =======================================================
                // RENDERIZA√á√ÉO DA ABA ITENS (L√ìGICA)
                // =======================================================
                const containerItens = document.getElementById('custo-modal-content-itens');
                
                // Fun√ß√£o auxiliar para atualizar APENAS os valores visuais (Sem reconstruir HTML)
                // Isso permite que o slider deslize sem travar
                const refreshValues = (activeInput, updateAll = false) => {
                    // Recalcula o valor da gordura total atual
                    const valAtualInput = Utils.parseMoeda(document.getElementById('input-acelerar-meta').value);
                    const valAceleracaoReal = Math.max(0, valAtualInput - custoBase);
                    let totalP = 0;

                    meta.custosDetalhados.forEach(item => {
                        totalP += (item.pesoAceleracao || 0);
                        
                        // Atualiza R$ Extra Verde
                        const spanExtra = containerItens.querySelector(`.extra-value[data-id="${item.idCustoFixo}"]`);
                        if (spanExtra) {
                             const valorItem = valAceleracaoReal * (item.pesoAceleracao / 100);
                             spanExtra.textContent = valorItem > 0 ? `+${Utils.formatarMoeda(valorItem)}/dia` : '';
                        }

                        // Atualiza Inputs (SE n√£o for o que eu estou mexendo)
                        const slider = containerItens.querySelector(`.slider-peso-integrado[data-id="${item.idCustoFixo}"]`);
                        const number = containerItens.querySelector(`.input-peso-integrado[data-id="${item.idCustoFixo}"]`);
                        
                        if (slider && slider !== activeInput) {
                            slider.value = Math.round(item.pesoAceleracao);
                        }
                        if (number && number !== activeInput) {
                            number.value = Math.round(item.pesoAceleracao);
                        }
                    });

                    // Atualiza Total Text
                    const spanTot = document.getElementById('custo-itens-total-peso');
                    if(spanTot) {
                        spanTot.textContent = totalP.toFixed(1) + '%';
                        spanTot.className = Math.abs(totalP-100)<0.1 ? 'font-bold text-green-400' : 'font-bold text-red-400';
                    }
                };

                // Constr√≥i o HTML inicial da lista
                if (containerItens) {
                    let listaItensHTML = '';
                    let totalPesosCalculado = 0;
                    
                    if (meta.custosDetalhados.length === 0) {
                        listaItensHTML = '<p class="text-slate-500 italic text-center">Nenhum custo fixo cadastrado.</p>';
                    } else {
                        listaItensHTML = '<div class="space-y-3 max-h-[60vh] overflow-y-auto scrollable-content p-1">';
                        
                        meta.custosDetalhados.forEach(item => {
                            totalPesosCalculado += (item.pesoAceleracao || 0);
                            const valorGuardadoItem = saldoRealTotal * (item.pesoAceleracao / 100);
                            
                            const foiPago = AppState.historicoTransacoes.some(t => {
                                const d = new Date(t.data);
                                return d.getMonth() === mes && d.getFullYear() === ano && t.tipo === 'saida' && 
                                       ((t.descricao||'').toLowerCase().includes((item.descricao||'').toLowerCase()));
                            });
                            
                            const isAntecipado = meta.itensAntecipados && meta.itensAntecipados.includes(item.idCustoFixo);
                            const statusPago = foiPago && !isAntecipado;
                            const percentProgresso = item.valorObjetivo > 0 ? (valorGuardadoItem / item.valorObjetivo) * 100 : 0;
                            
                            let conteudoCard = '';

                            if (statusPago) {
                                // ITEM PAGO: APENAS VISUALIZA√á√ÉO
                                conteudoCard = `
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-medium text-white opacity-50 decoration-line-through">${item.descricao}</span>
                                        <span class="text-[10px] text-green-400 font-bold border border-green-500/30 px-2 rounded bg-green-900/20">‚úì PAGO</span>
                                    </div>
                                    <div class="flex justify-end mt-1">
                                        <button class="btn-toggle-antecipar text-[10px] bg-slate-600 hover:bg-slate-500 text-white py-1 px-2 rounded transition" 
                                                data-idcusto="${item.idCustoFixo}" data-antecipar="true">
                                            Adiantar Pr√≥x. M√™s
                                        </button>
                                    </div>`;
                            } else {
                                // ITEM PENDENTE: COM SLIDERS
                                const chk = `<input type="checkbox" class="check-pagar-item h-5 w-5 rounded bg-slate-800 border-slate-500 text-emerald-500 cursor-pointer" data-valor="${item.valorObjetivo}" data-nome="${item.descricao}" data-categoria="${item.categoria||'Fixos'}">`;
                                
                                conteudoCard = `
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="flex items-center gap-3 w-full">
                                            ${chk}
                                            <span class="font-medium text-white truncate">${item.descricao}</span>
                                            <span class="text-[10px] text-green-400 font-bold ml-auto bg-green-900/30 px-2 rounded extra-value" data-id="${item.idCustoFixo}"></span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                                         <span>${Utils.formatarMoeda(valorGuardadoItem)}</span>
                                         <span>Meta: ${Utils.formatarMoeda(item.valorObjetivo)}</span>
                                    </div>
                                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden mb-2">
                                        <div class="h-full bg-cyan-500 transition-all duration-500" style="width: ${Math.min(100, percentProgresso)}%"></div>
                                    </div>
                                    <div class="flex items-center gap-2 bg-slate-800/50 p-1.5 rounded border border-slate-600/30">
                                        <span class="text-[10px] text-slate-400 w-16">Peso Acel.:</span>
                                        <input type="range" min="0" max="100" step="1" 
                                               value="${Math.round(item.pesoAceleracao)}" 
                                               data-id="${item.idCustoFixo}" 
                                               class="slider-peso-integrado flex-1 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                                        <input type="number" value="${Math.round(item.pesoAceleracao)}" 
                                               data-id="${item.idCustoFixo}" 
                                               class="input-peso-integrado w-12 bg-slate-900 border border-slate-600 rounded px-1 text-center text-xs text-white font-bold outline-none">
                                        <span class="text-[10px] text-slate-500">%</span>
                                    </div>
                                `;
                            }
                            listaItensHTML += `<div class="p-3 bg-slate-700 rounded-md text-sm shadow-sm border border-slate-600">${conteudoCard}</div>`;
                        });
                        listaItensHTML += '</div>';
                    }

                    const totalPesoCor = Math.abs(totalPesosCalculado - 100) < 0.1 ? 'text-green-400' : 'text-red-400';

                    containerItens.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
                            <div class="flex flex-col h-full">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold text-slate-300 text-center">Itens & Pesos</h4>
                                    <div class="text-xs font-bold ${totalPesoCor}" id="custo-itens-total-peso">Total: ${totalPesosCalculado.toFixed(1)}%</div>
                                </div>
                                ${listaItensHTML}
                                <div class="mt-4 space-y-3">
                                    <button id="btn-pagar-selecionados" class="w-full bg-slate-700 text-slate-400 font-bold py-3 px-4 rounded-lg transition cursor-not-allowed shadow-lg" disabled>Pagar Selecionados (R$ 0,00)</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-slate-300 mb-2 text-center">Custos por Categoria</h4>
                                <div class="max-w-xs mx-auto"><canvas id="custo-modal-pie-chart"></canvas></div>
                                <div class="mt-4 p-3 bg-slate-800/50 rounded-lg text-xs text-slate-400 text-center">
                                    <button id="btn-rebalancear-pesos" class="text-xs bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-3 rounded transition w-full">Auto Ajuste (Resetar Pesos)</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // --- LISTENERS DOS SLIDERS (FLUIDEZ) ---
                    const inputsPeso = containerItens.querySelectorAll('.slider-peso-integrado, .input-peso-integrado');
                    
                    inputsPeso.forEach(el => {
                        // Evento 'input': Ocorre ENQUANTO arrasta
                        el.addEventListener('input', (e) => {
                            const idAlterado = e.target.dataset.id;
                            const novoValor = parseFloat(e.target.value);
                            
                            // Calcula matematicamente
                            if (BusinessLogic.recalcularPesosAceleracao) {
                                BusinessLogic.recalcularPesosAceleracao(meta.custosDetalhados, idAlterado, novoValor);
                                
                                // ATUALIZA APENAS OS OUTROS INPUTS (N√£o o que voc√™ est√° segurando)
                                refreshValues(e.target);
                            }
                        });

                        // Evento 'change': Ocorre ao SOLTAR
                        // Aqui salvamos no disco e fazemos refresh completo para garantir integridade
                        el.addEventListener('change', () => {
                             Storage.salvarConfiguracoes();
                             // N√£o recarrega o HTML todo para n√£o perder a posi√ß√£o do scroll,
                             // apenas garante que os valores finais est√£o certos.
                             refreshValues(null); 
                        });
                    });
                    
                    // Executa uma vez para preencher os valores "Verdes" iniciais
                    refreshValues(null);

                    // Bot√£o Rebalancear
                    document.getElementById('btn-rebalancear-pesos').onclick = () => {
                         const ativos = meta.custosDetalhados.length;
                         if(ativos > 0) {
                             meta.custosDetalhados.forEach(c => c.pesoAceleracao = 100 / ativos);
                             Storage.salvarConfiguracoes();
                             EventHandlers.handleRenderModalCustos(dataReferencia);
                         }
                    };

                    // Listeners de Pagamento (Mantidos)
                    const checkboxes = containerItens.querySelectorAll('.check-pagar-item');
                    const btnPagar = document.getElementById('btn-pagar-selecionados');
                    checkboxes.forEach(cb => {
                        cb.addEventListener('change', () => {
                            let total = 0, count = 0;
                            checkboxes.forEach(c => { if(c.checked) { total += parseFloat(c.dataset.valor); count++; } });
                            if(count > 0) {
                                btnPagar.textContent = `Pagar ${count} Item(ns) - ${Utils.formatarMoeda(total)}`;
                                btnPagar.disabled = false;
                                btnPagar.classList.replace('bg-slate-700', 'bg-emerald-600');
                                btnPagar.classList.replace('text-slate-400', 'text-white');
                            } else {
                                btnPagar.textContent = 'Pagar Selecionados (R$ 0,00)';
                                btnPagar.disabled = true;
                                btnPagar.classList.replace('bg-emerald-600', 'bg-slate-700');
                                btnPagar.classList.replace('text-white', 'text-slate-400');
                            }
                        });
                    });
                    if(btnPagar) btnPagar.onclick = EventHandlers.handlePagarItensSelecionados;

                    const btnsAnt = containerItens.querySelectorAll('.btn-toggle-antecipar');
                    btnsAnt.forEach(b => {
                        b.onclick = (e) => {
                             const id = e.target.dataset.idcusto;
                             const ativar = e.target.dataset.antecipar === 'true';
                             if (!meta.itensAntecipados) meta.itensAntecipados = [];
                             if (ativar) { if (!meta.itensAntecipados.includes(id)) meta.itensAntecipados.push(id); } 
                             else { meta.itensAntecipados = meta.itensAntecipados.filter(x => x !== id); }
                             Storage.salvarConfiguracoes();
                             EventHandlers.handleRenderModalCustos(dataReferencia);
                        };
                    });

                    // Gr√°fico de Pizza
                    const pieCanvas = document.getElementById('custo-modal-pie-chart');
                    if (pieCanvas && AppState.configuracoes.custosFixos) {
                        const custosPorCat = AppState.configuracoes.custosFixos.reduce((acc, custo) => {
                            const cat = custo.categoria || 'Outro C. Fixo';
                            acc[cat] = (acc[cat] || 0) + custo.valor;
                            return acc;
                        }, {});
                        new Chart(pieCanvas, { type: 'doughnut', data: { labels: Object.keys(custosPorCat), datasets: [{ data: Object.values(custosPorCat), backgroundColor: ['#fb923c', '#f87171', '#fbbf24', '#a3e635', '#4ade80'], borderColor: '#1e293b', borderWidth: 2 }] }, options: { plugins: { legend: { position: 'top', labels: { color: '#cbd5e1', font: { size: 10 } } } }, cutout: '60%' } });
                    }
                }

                // 4. RENDERIZA ABA 3: DETALHADO (RESTAURADO COMPLETO)
                const containerDetalhado = document.getElementById('custo-modal-content-detalhado');
                if (containerDetalhado) {
                    const diasNoMes = new Date(ano, mes + 1, 0).getDate();
                    let logHTML = '<div class="space-y-2 max-h-96 overflow-y-auto scrollable-content">';
                    
                    // C√°lculo do Saldo Inicial do M√™s (Retroativo)
                    const totalProvisionadoMes = meta.historicoProvisao
                        .filter(p => { const data = new Date(p.data + "T12:00:00"); return data.getFullYear() === ano && data.getMonth() === mes; })
                        .reduce((acc, p) => acc + p.valor, 0);
                        
                    let saldoRealCorrente = saldoRealTotal - totalProvisionadoMes + totalSaidasValor;
                    
                    const { custosFixos } = AppState.configuracoes;

                    for (let dia = 1; dia <= diasNoMes; dia++) {
                        const dataAtual = new Date(ano, mes, dia);
                        const chaveData = Utils.formatarDataParaChave(dataAtual);
                        
                        const provisaoDoDia = meta.historicoProvisao.find(p => p.data === chaveData);
                        const saidasDoDia = meta.saidas.filter(s => s.data === chaveData);
                        const custosVencendo = custosFixos.filter(c => c.vencimento == dia);
                        
                        if (provisaoDoDia || saidasDoDia.length > 0 || custosVencendo.length > 0) {
                            logHTML += `<div class="p-3 bg-slate-700 rounded-md">`;
                            logHTML += `<div class="flex justify-between items-center mb-1">
                                            <span class="font-bold text-white">${dataAtual.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'})}</span>
                                            <span class="text-sm text-slate-300">Saldo In√≠cio Dia: ${Utils.formatarMoeda(saldoRealCorrente)}</span>
                                        </div>`;
                            
                            // Vencimentos
                            custosVencendo.forEach(custo => {
                                    logHTML += `<div class="text-xs text-amber-400 ml-2 mb-1">‚ö†Ô∏è Vencimento: ${custo.descricao} (${Utils.formatarMoeda(custo.valor)})</div>`;
                            });
                            
                            // Entradas (Provis√£o)
                            if (provisaoDoDia) {
                                saldoRealCorrente += provisaoDoDia.valor;
                                logHTML += `<div class="flex justify-between text-xs text-green-400 ml-2 border-l-2 border-green-500 pl-2 mb-1">
                                    <span>+ Prov. Di√°ria</span>
                                    <span>${Utils.formatarMoeda(provisaoDoDia.valor)}</span>
                                </div>`;
                            }
                            
                            // Sa√≠das (Pagamentos)
                            saidasDoDia.forEach(saida => {
                                saldoRealCorrente -= saida.valor;
                                logHTML += `<div class="flex justify-between text-xs text-red-400 ml-2 border-l-2 border-red-500 pl-2">
                                    <span>- Pagto: ${saida.descricao}</span>
                                    <span>${Utils.formatarMoeda(saida.valor)}</span>
                                </div>`;
                            });
                            
                            logHTML += `<div class="text-right border-t border-slate-600/50 mt-1 pt-1"><span class="text-[10px] text-slate-400">Saldo Final: ${Utils.formatarMoeda(saldoRealCorrente)}</span></div>`;
                            logHTML += `</div>`;
                        }
                    }
                    logHTML += '</div>';
                    containerDetalhado.innerHTML = logHTML;
                }

            }, 100);
            
            AppState.itemParaEditarId = meta.id;
        },


// --- FUN√á√ÉO DE PAGAMENTO (USA BANCO VINCULADO PARA MANTER LASTRO) ---
        handlePagarItensSelecionados: () => {
            const checkboxes = document.querySelectorAll('.check-pagar-item:checked');
            if (checkboxes.length === 0) return;

            let total = 0;
            const nomes = [];
            const categoriasEncontradas = new Set();

            checkboxes.forEach(cb => {
                total += parseFloat(cb.dataset.valor);
                nomes.push(cb.dataset.nome);
                if (cb.dataset.categoria) categoriasEncontradas.add(cb.dataset.categoria);
            });

            // Decide a categoria final
            let categoriaFinal = 'Custos Fixos';
            if (categoriasEncontradas.size === 1) {
                categoriaFinal = [...categoriasEncontradas][0];
            } else if (categoriasEncontradas.size > 1) {
                categoriaFinal = 'Custos Fixos'; 
            }

            let descricao = `Pgto Mensal: ${nomes.join(', ')}`;
            if (descricao.length > 50) descricao = descricao.substring(0, 47) + '...';

            // >>> AQUI EST√Å A L√ìGICA DO LASTRO REAL <<<
            const metaCustos = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
            let contaOrigemId = 'AUTO_ID_CARTEIRA'; // Padr√£o
            
            if (metaCustos && metaCustos.bancoId) {
                // Se tem banco vinculado, usa ele!
                contaOrigemId = metaCustos.bancoId;
            }
            // ----------------------------------------

            UIRenderer.fecharModal();

            UIRenderer.abrirModal('novaTransacaoAvulsa', {
                defaultTipo: 'saida',
                defaultValor: total,
                defaultCategoria: categoriaFinal,
                defaultDescricao: descricao,
                defaultContaId: contaOrigemId, // Passa o banco correto
                
                // Contexto para saber que √© um pagamento de custo fixo
                // Isso ajuda no handleSalvarTransacaoAvulsa a saber se precisa dar baixa na provis√£o
                context: 'pagamento_custos_mensais' 
            });
            
            // For√ßa a sele√ß√£o visual (garantia extra)
            setTimeout(() => {
                const selectConta = document.getElementById('trans-conta-id');
                if (selectConta) {
                    selectConta.value = contaOrigemId;
                }
            }, 100);

            AppState.modalContext = 'pagamento_custos_mensais'; 
        },

handlePesoItemChange: (input) => {
            const idCustoFixo = input.dataset.idcusto;
            let novoPeso = parseFloat(input.value);

            if (isNaN(novoPeso) || novoPeso < 0) novoPeso = 0;
            if (novoPeso > 100) novoPeso = 100;
            
            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === AppState.itemParaEditarId);
            if (!meta || !meta.custosDetalhados) return;

            // Atualiza o peso do item alterado
            const custoItemAtual = meta.custosDetalhados.find(c => c.idCustoFixo === idCustoFixo);
            if (custoItemAtual) {
                custoItemAtual.pesoAceleracao = novoPeso;
            }
            
            // Salva
            Storage.salvarConfiguracoes();

            // Atualiza SOMENTE o total na tela (sem recarregar tudo para n√£o perder o foco)
            let totalPesosCalculado = meta.custosDetalhados.reduce((acc, c) => acc + (c.pesoAceleracao || 0), 0);
            const totalDisplay = document.getElementById('custo-itens-total-peso');
            
            if (totalDisplay) {
                const totalFinal = Math.round(totalPesosCalculado);
                totalDisplay.textContent = `${totalFinal}%`;
                
                // Muda cor se n√£o fechar 100%
                if (totalFinal === 100) {
                    totalDisplay.className = "font-bold text-green-400";
                    // Se fechou 100%, podemos recarregar o modal para atualizar as barras
                    // (Pequeno delay para o usu√°rio ver o 100% verde)
                    setTimeout(() => EventHandlers.handleRenderModalCustos(AppState.custosModalState.data), 500);
                } else {
                    totalDisplay.className = "font-bold text-red-400";
                }
            }
        },
      
handleSimuladorAceleradorChange: (incremento = 0) => {
            const inputAcelerar = document.getElementById('input-acelerar-meta');
            if (!inputAcelerar) return;

            let valorAtual = Utils.parseMoeda(inputAcelerar.value);
            if (incremento !== 0) valorAtual += incremento;

            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === AppState.itemParaEditarId);
            if (!meta) return;

            // Custo Base (Ch√£o)
            const custoBase = BusinessLogic.calcularCustoDiarioMeta({ ...meta, aceleradorMensal: {} }, AppState.custosModalState.data);
            
            if (valorAtual < custoBase) valorAtual = custoBase;
            if (valorAtual < 0) valorAtual = 0;
            
            // 1. Atualiza Input
            inputAcelerar.value = Utils.formatarMoedaParaInput(valorAtual);
            
            // 2. AUTO-SAVE (Salva imediatamente)
            const chaveMes = `${AppState.custosModalState.data.getFullYear()}-${AppState.custosModalState.data.getMonth()}`;
            if (!meta.aceleradorMensal) meta.aceleradorMensal = {};
            meta.aceleradorMensal[chaveMes] = valorAtual;
            Storage.salvarConfiguracoes();

            // 3. Atualiza Estado "Original" (Evita modal de "Deseja salvar?")
            AppState.custosModalState.acelerador = valorAtual;
            AppState.custosModalState.originalAcelerador = valorAtual; 

            // 4. Feedback Texto Turbo
            const resultadoEl = document.getElementById('custo-acelerar-resultado');
            if (resultadoEl) {
                if (valorAtual > custoBase) {
                    const diasTrabalho = BusinessLogic.calcularDiasTrabalhoNoMes(AppState.custosModalState.data.getFullYear(), AppState.custosModalState.data.getMonth());
                    const extraPorDia = valorAtual - custoBase;
                    const extraNoMes = extraPorDia * diasTrabalho;
                    
                    resultadoEl.innerHTML = `<span class="text-cyan-300 font-bold">‚ö° TURBO ATIVADO:</span> + ${Utils.formatarMoeda(extraPorDia)}/dia. <br><span class="text-xs opacity-80">Gordura extra de ${Utils.formatarMoeda(extraNoMes)} este m√™s para quitar antes.</span>`;
                    resultadoEl.className = "text-center text-sm mt-2 leading-tight";
                } else {
                    resultadoEl.textContent = "Modo Padr√£o: Voc√™ est√° guardando o valor m√≠nimo necess√°rio.";
                    resultadoEl.className = "text-center text-slate-500 text-xs mt-2";
                }
            }
        },
       
handleSimuladorGerarCronograma: () => {
            const P = parseFloat(document.getElementById('simValorFinanciado').value);
            const i_anual = parseFloat(document.getElementById('simTaxaAnual').value);
            const i_mensal = Math.pow(1 + (i_anual / 100), 1 / 12) - 1;
            const i_m_percent = i_mensal * 100;
            const method = document.getElementById('simMethod').value;
            const dataInicio = new Date(document.getElementById('simDataInicio').value + "T12:00:00");
            const dataRef = new Date(document.getElementById('simDataRef').value + "T12:00:00");
            const PMT_contrato = parseFloat(document.getElementById('simValorParcelaOpt').value) || 0;
            
            // --- CORRE√á√ÉO: O Total √© o Total. N√£o some nada! ---
            // Antes estava: parseInt(...) + parseInt(...) -> ISSO DUPLICAVA
            const nTotalOriginal = parseInt(document.getElementById('simNTotal').value); 
            const parcelasPagas = parseInt(document.getElementById('simParcelasPagas').value);
            // ---------------------------------------------------

            if (!P || !nTotalOriginal || !i_anual) {
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Dados do contrato inv√°lidos.' });
                return;
            }

            // 1. Gera o cronograma COMPLETO (1 at√© 4)
            const info = method === 'price' 
                ? Utils.genPriceSchedule(P, i_m_percent, nTotalOriginal, dataInicio, PMT_contrato) 
                : Utils.genSAC(P, i_m_percent, nTotalOriginal, dataInicio);
            
            // 2. Filtra: Joga fora as que j√° foram pagas (Slice remove as X primeiras)
            // Se pagou 3, remove 0, 1, 2. Sobra a partir da 3 (que √© a parcela #4).
            const scheduleFuturo = info.schedule.slice(parcelasPagas);
            
            AppState.currentScheduleModal = scheduleFuturo; 
            
            EventHandlers.handleSimuladorRenderLista(scheduleFuturo, dataRef, i_anual);
            
            // Atualiza Info do Topo
            // O saldo atual √© o saldo FINAL da √∫ltima parcela paga (ou o Inicial se nada foi pago)
            let saldoAtual = P;
            if (parcelasPagas > 0 && parcelasPagas <= info.schedule.length) {
                saldoAtual = info.schedule[parcelasPagas - 1].saldo;
            } else if (parcelasPagas > info.schedule.length) {
                saldoAtual = 0;
            }
            
            const jurosRest = scheduleFuturo.reduce((a, b) => a + b.juros, 0);

            document.getElementById('simPaidCount').innerText = parcelasPagas;
            document.getElementById('simRemainCount').innerText = scheduleFuturo.length;
            document.getElementById('simSaldoAtual').innerText = Utils.toBRL(saldoAtual);
            document.getElementById('simJurosRest').innerText = Utils.toBRL(jurosRest);

            document.getElementById('simInfo').classList.remove('hidden');
            document.getElementById('resultadoSimModal').classList.add('hidden');
            document.getElementById('resultadoSimVazio').classList.remove('hidden');
        },
handleSimuladorRenderLista: (schedule, dateRef, i_anual) => {
            const container = document.getElementById('listaParcelasModal');
            container.innerHTML = '';
            
            const r_daily = Math.pow(1 + i_anual / 100, 1 / 365) - 1;
            
            let hasFutureInstallments = false;

            for (const p of schedule) {
                if (p.due <= dateRef) continue; // S√≥ mostra parcelas futuras
                hasFutureInstallments = true;
                
                const div = document.createElement('div');
                // Classes base do item (sem sele√ß√£o)
                div.className = 'parcela-item p-3 rounded-md flex justify-between items-center hover:bg-slate-700/50 transition border border-transparent mb-1'; 
                div.dataset.num = p.num;

                const days = Utils.daysBetween(dateRef, p.due);
                const pv = days > 0 ? (p.pmt / Math.pow(1 + r_daily, days)) : p.pmt;

                div.innerHTML = `
                    <div class="parcela-item-left flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" data-num="${p.num}" class="h-5 w-5 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-cyan-500 transition"> 
                            <span class="ml-3 text-sm text-slate-200 font-medium">Parcela ${p.num}</span>
                        </label>
                        <div class="parcela-meta ml-4 flex flex-col">
                            <span class="pmt-old text-white font-bold transition-all">${Utils.toBRL(p.pmt.toFixed(2))}</span>
                            <span class="pmt-new text-cyan-400 text-xs font-bold hidden" data-pv="${pv.toFixed(2)}"></span>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400 text-right leading-tight">
                        Venc: <span class="text-slate-300">${p.due.toLocaleDateString('pt-BR')}</span>
                        <br>Saldo ap√≥s: ${Utils.toBRL(p.saldo.toFixed(2))}
                    </div>
                `;
                container.appendChild(div);
            }
            if (!hasFutureInstallments) {
                container.innerHTML = `<p class="text-center text-slate-500 italic p-6 bg-slate-900/50 rounded-lg">N√£o h√° parcelas futuras para simular.</p>`;
            }
        },
        handleSimuladorUpdateInfo: (schedule, dateRef) => {
            let lastPaidIdx = -1;
            for (let i = 0; i < schedule.length; i++) {
                if (schedule[i].due < dateRef) lastPaidIdx = i;
                else break;
            }
            const paidCount = lastPaidIdx + 1;
            const remainCount = schedule.length - paidCount;
            const currentSaldo = lastPaidIdx >= 0 ? schedule[lastPaidIdx].saldo : (schedule[0]?.saldo + schedule[0]?.amort || schedule[0]?.pmt); // Estimar inicial se for o caso
            const jurosRest = schedule.slice(paidCount).reduce((a, b) => a + b.juros, 0);

            document.getElementById('simPaidCount').innerText = paidCount;
            document.getElementById('simRemainCount').innerText = remainCount;
            document.getElementById('simSaldoAtual').innerText = Utils.toBRL(currentSaldo);
            document.getElementById('simJurosRest').innerText = Utils.toBRL(jurosRest);
        },
        handleSimuladorToggleParcela: (checkbox) => {
            const item = checkbox.closest('.parcela-item');
            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
            EventHandlers.handleSimuladorUpdateSelecao(); // Recalcula tudo
        },
handleSimuladorUpdateSelecao: () => {
            const schedule = AppState.currentScheduleModal;
            if (!schedule) return;
            
            // Captura checkboxes marcados
            const selectedBoxes = Array.from(document.querySelectorAll('#listaParcelasModal input[type=checkbox]:checked'));
            const selectedNums = selectedBoxes.map(b => parseInt(b.dataset.num));
            
            // Par√¢metros
            const dataRef = new Date(document.getElementById('simDataRef').value + "T12:00:00");
            const i_anual = parseFloat(document.getElementById('simTaxaAnual').value);
            const r_daily = Math.pow(1 + i_anual / 100, 1 / 365) - 1;
            
            // 1. ATUALIZA√á√ÉO VISUAL (TOGGLE)
            document.querySelectorAll('.parcela-item').forEach(div => {
                const num = parseInt(div.dataset.num);
                const pmtOldSpan = div.querySelector('.pmt-old');
                const pmtNewSpan = div.querySelector('.pmt-new');
                
                if (selectedNums.includes(num)) {
                    // === SELECIONADO (RISCADO) ===
                    const item = schedule.find(p => p.num === num);
                    const days = Utils.daysBetween(dataRef, item.due);
                    const pvItem = days > 0 ? (item.pmt / Math.pow(1 + r_daily, days)) : item.pmt;

                    pmtNewSpan.textContent = `Hoje: ${Utils.toBRL(pvItem)}`;
                    pmtNewSpan.classList.remove('hidden');
                    
                    // Adiciona risco e cor cinza
                    pmtOldSpan.classList.add('line-through', 'text-slate-500', 'text-xs');
                    pmtOldSpan.classList.remove('text-white', 'font-bold');
                    
                    // Destaque no container
                    div.classList.add('bg-cyan-900/20', 'border-cyan-500/50');
                    div.classList.remove('border-transparent');
                } else {
                    // === N√ÉO SELECIONADO (NORMAL) ===
                    pmtNewSpan.textContent = '';
                    pmtNewSpan.classList.add('hidden');
                    
                    // Remove risco e volta branco
                    pmtOldSpan.classList.remove('line-through', 'text-slate-500', 'text-xs');
                    pmtOldSpan.classList.add('text-white', 'font-bold');
                    
                    // Remove destaque
                    div.classList.remove('bg-cyan-900/20', 'border-cyan-500/50');
                    div.classList.add('border-transparent');
                }
            });

            // 2. C√ÅLCULOS FINANCEIROS (MANTIDOS IGUAIS)
            const pvTotal = Utils.pvOfSelected(schedule, selectedNums, dataRef, r_daily, true);
            const currentSaldo = Utils.parseMoeda(document.getElementById('simSaldoAtual').innerText);
            const newSaldo = Math.max(0, currentSaldo - pvTotal); 

            const valorFaceTotal = selectedNums.reduce((acc, num) => {
                const item = schedule.find(p => p.num === num);
                return acc + (item ? item.pmt : 0);
            }, 0);
            const econMarketing = Math.max(0, valorFaceTotal - pvTotal);

            let lastPaidIdx = -1;
            for (let i = 0; i < schedule.length; i++) {
                if (schedule[i].due < dataRef) lastPaidIdx = i; else break;
            }
            const paidCount = lastPaidIdx + 1;
            const remainingN = schedule.length - paidCount;
            
            let afterSchedule = [];
            const modo = document.getElementById('simModoAmort').value;
            const method = document.getElementById('simMethod').value;
            const P_financiado = parseFloat(document.getElementById('simValorFinanciado').value);
            const N_total = parseInt(document.getElementById('simNTotal').value);
            const i_mensal = Math.pow(1 + (i_anual / 100), 1 / 12) - 1;
            const i_m_percent = i_mensal * 100;

            if (remainingN > 0) {
                if (modo === 'reduzirPrazo') {
                    if (method === 'price') {
                        const PMTcurrent = schedule[paidCount]?.pmt || schedule[0].pmt;
                        const novo_n_float = -Math.log(1 - (newSaldo * i_mensal) / PMTcurrent) / Math.log(1 + i_mensal);
                        const newN = Math.max(1, Math.ceil(novo_n_float));
                        afterSchedule = Utils.genPriceSchedule(newSaldo, i_m_percent, newN, Utils.addMonths(schedule[paidCount]?.due || dataRef, 0)).schedule;
                    } else {
                        const amortConstOrig = P_financiado / N_total;
                        const parcelasComidas = Math.floor(pvTotal / amortConstOrig);
                        const newN = Math.max(1, remainingN - parcelasComidas);
                        afterSchedule = Utils.genSAC(newSaldo, i_m_percent, newN, Utils.addMonths(schedule[paidCount]?.due || dataRef, 0)).schedule;
                    }
                } else { 
                    afterSchedule = (method === 'price') 
                        ? Utils.genPriceSchedule(newSaldo, i_m_percent, remainingN, Utils.addMonths(schedule[paidCount]?.due || dataRef, 0)).schedule
                        : Utils.genSAC(newSaldo, i_m_percent, remainingN, Utils.addMonths(schedule[paidCount]?.due || dataRef, 0)).schedule;
                }
            }

            const origFutureInterest = schedule.slice(paidCount).reduce((a, b) => a + b.juros, 0);
            const afterFutureInterest = afterSchedule.reduce((a, b) => a + b.juros, 0);
            const econReal = Math.max(0, origFutureInterest - afterFutureInterest);

            // 3. ATUALIZA√á√ÉO DO PAINEL LATERAL
            const resultBlock = document.getElementById('resultadoSimModal');
            const resultVazio = document.getElementById('resultadoSimVazio');
            
            if (selectedNums.length > 0) {
                resultBlock.classList.remove('hidden');
                resultVazio.classList.add('hidden');
                
                document.getElementById('simPvVal').innerText = Utils.toBRL(pvTotal);
                
                document.getElementById('simEconomiaVal').innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-green-400 text-xl font-bold">${Utils.toBRL(econMarketing)}</span>
                        <span class="text-[10px] text-slate-400 font-normal">(Desconto Nominal)</span>
                        <span class="text-emerald-600 text-xs font-bold mt-1 border-t border-slate-600/50 pt-1">${Utils.toBRL(econReal)}</span>
                        <span class="text-[10px] text-slate-500 font-normal">(Juros Reais Abatidos)</span>
                    </div>`;

                document.getElementById('simNovoSaldo').innerText = Utils.toBRL(newSaldo);
                
                let novoPlanoTxt = 'Quitado!';
                if (afterSchedule.length > 0) {
                    novoPlanoTxt = modo === 'reduzirPrazo' 
                        ? `Novo prazo: ${afterSchedule.length} meses` 
                        : `Nova 1¬™ parcela: ${Utils.toBRL(afterSchedule[0].pmt)}`;
                }
                document.getElementById('simNovoPlano').innerText = novoPlanoTxt;
                
                // Atualiza Bot√µes
                const btnCriarMeta = document.getElementById('btn-criar-meta-amortizacao');
                if(btnCriarMeta) {
                    btnCriarMeta.dataset.pv = pvTotal;
                    btnCriarMeta.dataset.economia = econMarketing;
                    btnCriarMeta.dataset.parcelas = selectedNums.join(', ');
                }
                
                let btnPagarAgora = document.getElementById('btn-pagar-agora-do-modal');
                if (!btnPagarAgora) {
                    // Recria se sumiu
                    btnPagarAgora = document.createElement('button');
                    btnPagarAgora.id = 'btn-pagar-agora-do-modal';
                    btnPagarAgora.className = 'w-full mt-2 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-bold py-2 px-4 rounded-lg transition highlight';
                    btnCriarMeta.insertAdjacentElement('afterend', btnPagarAgora);
                    const p = document.createElement('p');
                    p.className = 'text-xs text-slate-500 text-center mt-1';
                    p.textContent = '("Pagar Agora" usar√° um saldo de outra caixinha)';
                    btnPagarAgora.insertAdjacentElement('afterend', p);
                }
                
                btnPagarAgora.textContent = `Pagar ${Utils.toBRL(pvTotal)} Agora`;
                btnPagarAgora.dataset.pv = pvTotal;
                btnPagarAgora.dataset.economia = econMarketing;
                btnPagarAgora.dataset.parcelas = selectedNums.join(','); 
                btnPagarAgora.dataset.dataRef = document.getElementById('simDataRef').value;

            } else {
                resultBlock.classList.add('hidden');
                resultVazio.classList.remove('hidden');
            }
        },
        

handleSimuladorCriarMeta: () => {
            const btn = document.getElementById('btn-criar-meta-amortizacao');
            const pvHoje = parseFloat(btn.dataset.pv);
            const economia = parseFloat(btn.dataset.economia);
            const parcelas = btn.dataset.parcelas;
            const metaDividaId = AppState.itemParaEditarId; // ID da d√≠vida sendo simulada

            if (!pvHoje || !metaDividaId) {
                alert('Erro ao ler dados da simula√ß√£o.');
                return;
            }

            // Abre o modal e PASSA OS DADOS
            UIRenderer.abrirModal('criarCaixinhaAmortizacao', { 
                pvHoje: pvHoje, 
                economia: economia, 
                parcelas: parcelas,
                metaDividaId: metaDividaId
            });
            
            // Inicia o c√°lculo visual do modal imediatamente
            setTimeout(() => EventHandlers.recalcularValorAlvoModal(3), 100);
        },
confirmarCriacaoCaixinha: (e) => {
    const btn = e.target.closest('button');
    const pvFuturo = parseFloat(btn.dataset.pvFuturo);
    const economia = parseFloat(btn.dataset.economia);
    const parcelas = btn.dataset.parcelas;
    const meses = parseInt(btn.dataset.meses);
    
    const context = AppState.modalContext;
    if (!context || context.type !== 'criarCaixinhaAmortizacao') {
        console.error("Contexto perdido. Reabra o simulador.");
        return;
    }
    
    const metaDivida = AppState.configuracoes.metasFinanceiras.find(m => m.id === context.metaDividaId);

    if (!pvFuturo || !metaDivida) {
        UIRenderer.abrirModal('alerta', { 
            titulo: 'Erro', 
            mensagem: 'Dados da simula√ß√£o inv√°lidos.' 
        });
        return;
    }

    // 1. CALCULA O VALOR MENSAL (POUPAN√áA FIXA)
    const valorMensal = pvFuturo / meses;
    
    // 3. CRIA A META (TIPO POUPAN√áA)
    const novaMeta = {
        id: crypto.randomUUID(),
        descricao: `Quitar ${metaDivida.descricao} (Pcls: ${parcelas})`,
        tipo: 'poupanca', // Criamos como poupan√ßa fixa (n√£o depende de KM)
        valorTotal: pvFuturo,
        valorAtual: 0,
        prazoMeses: meses,
        dataVencimento: null,
        contribuicaoMensal: valorMensal, // Valor fixo sugerido
        taxaJuros: 0,
        valorPorKm: 0,
        incluirComoCustoDiario: true, // J√° nasce provisionando no dia a dia
        bancoId: null
    };
    
    AppState.configuracoes.metasFinanceiras.push(novaMeta);
    SystemLog.success('MetaFinanceira', `Nova caixinha criada: ${novaMeta.descricao}`);
    // 4. FECHA E ATUALIZA
    UIRenderer.fecharModal(); // Fecha o criar caixinha
    UIRenderer.fecharModal(); // Fecha o simulador (se estiver aberto por baixo)
    
    // For√ßa ida para a aba financeira
    const finTab = document.querySelector('.tab-button[data-tab="financeiro"]');
    if(finTab) finTab.click();
    
    UIRenderer.renderMetasFinanceiras();
    Storage.salvarConfiguracoes();
    
    UIRenderer.abrirModal('alerta', {
        titulo: 'Plano Criado!',
        mensagem: `Meta criada: Juntar ${Utils.formatarMoeda(valorMensal)}/m√™s durante ${meses} meses para quitar as parcelas e economizar ${Utils.formatarMoeda(economia)}.`,
        type: 'success'
    });
},

        handleRecalcularCotacao: () => {
            // Coleta de dados financeiros
            const distEmbarque = parseFloat(document.getElementById('cotacaoDistEmbarque').value) || 0;
            const distViagem = parseFloat(document.getElementById('cotacaoDistViagem').value) || 0;
            const pedagios = Utils.parseMoeda(document.getElementById('cotacaoPedagios').value);
            const seguranca = Utils.parseMoeda(document.getElementById('cotacaoSeguranca').value);
            const semRetorno = document.getElementById('cotacaoSemRetorno').checked;
            const valorKm = Utils.parseMoeda(document.getElementById('cotacaoValorKm').value);
            
            // Coleta de dados descritivos
            const nomeCliente = document.getElementById('cotacaoNomeCliente').value;
            const dataInicio = document.getElementById('cotacaoDataInicio').value || null;
            const dataFim = document.getElementById('cotacaoDataFim').value || null;
            const tipoServico = document.getElementById('cotacaoTipoServico').value;
            const qtdItens = parseFloat(document.getElementById('cotacaoQtdItens').value) || 0;
            const peso = Utils.parseMoeda(document.getElementById('cotacaoPeso').value);

            // Coleta das paradas
            const paradasInputs = document.querySelectorAll('.cotacao-parada-input');
            const paradas = Array.from(paradasInputs).map(input => input.value);

            // Coleta dos custos inclusos
            const custosInclusos = [];
            const custosCheckboxes = document.querySelectorAll('.cotacao-custo-checkbox:checked');
            custosCheckboxes.forEach(cb => {
                const id = cb.id;
                let descricao = cb.closest('label').querySelector('span').textContent;
                
                if (id === 'cotacao-custo-prolabore') {
                    descricao = "Pr√≥-labore (Custo Di√°rio)";
                } else if (id === 'cotacao-custo-META_CUSTOS_MENSAIS') {
                    descricao = "Custos Fixos (Di√°rio)";
                }

                custosInclusos.push({ descricao: descricao, valor: 0 });
            });

            let valorKmRetorno = 0;
            const inputRetorno = document.getElementById('cotacaoValorKmRetorno');

            // Calcula o valor do retorno
            if (semRetorno) {
                inputRetorno.disabled = false;
                inputRetorno.classList.replace('bg-slate-600', 'bg-slate-700');
                valorKmRetorno = Utils.parseMoeda(inputRetorno.value);
                
                if (valorKmRetorno <= 0 && valorKm > 0) {
                    valorKmRetorno = valorKm * 0.5; // Sugest√£o de 50%
                    inputRetorno.value = Utils.formatarMoedaParaInput(valorKmRetorno);
                }
            } else {
                inputRetorno.disabled = true;
                inputRetorno.classList.replace('bg-slate-700', 'bg-slate-600');
                inputRetorno.value = '';
            }

            // Calcula os subtotais
            const totalEmbarque = distEmbarque * valorKm;
            const totalViagem = distViagem * valorKm;
            const totalRetorno = semRetorno ? (distViagem * valorKmRetorno) : 0;
            
            const totalFinal = totalEmbarque + totalViagem + totalRetorno + pedagios + seguranca;

            // Salva TUDO no estado
            AppState.cotacaoState = {
                nomeCliente,
                dataInicio,
                dataFim,
                paradas,
                tipoServico,
                qtdItens,
                peso,
                custosInclusos,
                distEmbarque, 
                distViagem, 
                pedagios, 
                seguranca, 
                semRetorno,
                valorKm, 
                valorKmRetorno, 
                total: totalFinal
            };

            // Exibe o resultado
            document.getElementById('calc-resultado-cotacao').textContent = Utils.formatarMoeda(totalFinal);
        },
        handleSugerirCotacaoCustos: () => {
            const { kmMetaDiaria, proLabore, metasFinanceiras } = AppState.configuracoes;
            const hoje = new Date();
            
            if (kmMetaDiaria <= 0) {
                alert('Faltam Dados: Defina sua "KM Meta Di√°ria" nas Configura√ß√µes.');
                return;
            }

            const custosCheckboxes = document.querySelectorAll('.cotacao-custo-checkbox:checked');
            if (custosCheckboxes.length === 0) {
                 alert('Selecione pelo menos um custo na lista acima para calcular.');
                return;
            }

            let totalCustoDiarioSelecionado = 0;
            const diasTrabalhoMes = BusinessLogic.calcularDiasTrabalhoNoMes(hoje.getFullYear(), hoje.getMonth());

            custosCheckboxes.forEach(cb => {
                const tipo = cb.dataset.custoTipo;
                if (tipo === 'prolabore') {
                    if (proLabore > 0 && diasTrabalhoMes > 0) {
                        totalCustoDiarioSelecionado += (proLabore / diasTrabalhoMes);
                    }
                } else if (tipo === 'meta') {
                    const metaId = cb.dataset.metaId;
                    const meta = metasFinanceiras.find(m => m.id === metaId);
                    if (meta) {
                        totalCustoDiarioSelecionado += BusinessLogic.calcularCustoDiarioMeta(meta, hoje);
                    }
                }
            });

            if (totalCustoDiarioSelecionado <= 0) {
                alert('Os custos selecionados precisam ter valores cadastrados nas Configura√ß√µes.');
                return;
            }

            const custoPorKm = totalCustoDiarioSelecionado / kmMetaDiaria;
            
            const MARGEM_LUCRO = 1.30; // 30% de margem
            const valorKmSugerido = custoPorKm * MARGEM_LUCRO;

            // 1. Preenche o input
            const inputValorKm = document.getElementById('cotacaoValorKm');
            inputValorKm.value = Utils.formatarMoedaParaInput(valorKmSugerido);

            // 2. Recalcula (Isso preencher√° o Retorno automaticamente se a checkbox estiver marcada)
            EventHandlers.handleRecalcularCotacao();
            
            // 3. Feedback Visual no Bot√£o (SEM FECHAR O MODAL)
            const btn = document.getElementById('btn-sugerir-cotacao-custos');
            const textoOriginal = btn.textContent;
            btn.textContent = `‚úÖ Preenchido: ${Utils.formatarMoeda(valorKmSugerido)}/km`;
            btn.classList.replace('bg-indigo-600', 'bg-green-600');
            
            setTimeout(() => {
                btn.textContent = textoOriginal;
                btn.classList.replace('bg-green-600', 'bg-indigo-600');
            }, 3000);
        },

        handleSugerirCotacaoDesempenho: () => {
            const hoje = new Date();
            const resumoMes = BusinessLogic.calcularResumoPeriodo(hoje.getFullYear(), hoje.getMonth(), -1); // Vis√£o mensal
            
            let valorKmSugerido = 0;

            if (resumoMes.mediaPorKm > 0) {
                // Usa a m√©dia bruta por KM do m√™s
                valorKmSugerido = resumoMes.mediaPorKm;
            } else {
                // Fallback: Se n√£o tiver m√©dia, usa a Meta Aut√¥noma / Meta de KM
                const { metaAutonoma, kmMetaDiaria } = AppState.configuracoes;
                if (metaAutonoma > 0 && kmMetaDiaria > 0) {
                    valorKmSugerido = metaAutonoma / kmMetaDiaria;
                } else {
                    alert('Dados Insuficientes: Registre atividades no m√™s ou preencha suas Metas nas Configura√ß√µes.');
                    return;
                }
            }

            // 1. Preenche o valor/km sugerido
            const inputValorKm = document.getElementById('cotacaoValorKm');
            inputValorKm.value = Utils.formatarMoedaParaInput(valorKmSugerido);

            // 2. Recalcula o total e o retorno
            EventHandlers.handleRecalcularCotacao();
            
            // 3. Feedback Visual no Bot√£o (SEM FECHAR O MODAL)
            const btn = document.getElementById('btn-sugerir-cotacao-desempenho');
            const textoOriginal = btn.textContent;
            btn.textContent = `‚úÖ Preenchido: ${Utils.formatarMoeda(valorKmSugerido)}/km`;
            btn.classList.remove('bg-slate-700', 'text-cyan-300');
            btn.classList.add('bg-green-600', 'text-white');
            
            setTimeout(() => {
                btn.textContent = textoOriginal;
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('bg-slate-700', 'text-cyan-300');
            }, 3000);
        },
        
  
       
       handleGerarPdfCotacao: () => {
            // Apenas chama a fun√ß√£o que j√° est√° no ReciboGenerator
            ReciboGenerator.gerarPDFCotacao();
        },
        handleAddParadaCotacao: () => {
            const container = document.getElementById('cotacao-paradas-container');
            if (!container) return;

            const paradaCount = container.querySelectorAll('input').length;
            const novoPontoLabel = String.fromCharCode(65 + paradaCount); // C, D, E...

            const div = document.createElement('div');
            div.className = 'relative fade-in'; // Adiciona 'relative' para o bot√£o de excluir
            div.innerHTML = `
                <label for="cotacaoPonto${paradaCount}" class="block text-xs font-medium text-slate-400 mb-1">Parada (Ponto ${novoPontoLabel})</label>
                <input type="text" id="cotacaoPonto${paradaCount}" class="cotacao-parada-input w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" placeholder="Endere√ßo da parada">
                <button class="btn-remover-parada absolute top-6 right-2 text-red-500 hover:text-red-400 transition">&times;</button>
            `;
            
            // Adiciona o listener para o novo bot√£o de remover
            div.querySelector('.btn-remover-parada').addEventListener('click', (e) => {
                e.preventDefault(); // Impede o 'oninput' do formul√°rio
                div.remove();
                EventHandlers.handleRecalcularCotacao(); // Recalcula ao remover
            });

            container.appendChild(div);
        },
handleAdicionarPlano: () => {
            // Captura os valores
            const categoria = UIElements.planoCategoriaSelect.value;
            const acao = document.getElementById('planoAcaoSelect').value; // Busca direta
            const descricao = UIElements.planoDescricaoInput.value.trim();
            const custoEstimado = Utils.parseMoeda(document.getElementById('planoCustoEstimado').value);
            const observacao = document.getElementById('planoObservacao').value.trim();
            const intervaloKm = parseInt(UIElements.planoIntervaloKmInput.value) || 0;
            const intervaloMeses = parseInt(UIElements.planoIntervaloMesesInput.value) || 0;
            const metaId = UIElements.planoMetaVinculadaSelect.value;

            if (!descricao) {
                alert("Por favor, preencha a descri√ß√£o do servi√ßo.");
                return;
            }
            if (intervaloKm <= 0 && intervaloMeses <= 0) {
                alert("Defina uma frequ√™ncia em KM ou em Meses.");
                return;
            }

            // Cria objeto completo
            const novoItem = {
                id: crypto.randomUUID(),
                categoria,
                acao, // Novo
                descricao,
                custoEstimado, // Novo
                observacao, // Novo
                intervaloKm,
                intervaloMeses,
                metaId,
            };

            if (metaId) {
                AppState.configuracoes.planoManutencao.push(novoItem);
                Storage.salvarConfiguracoes();
                UIRenderer.renderPlanoMestre();
                UIRenderer.renderHistoricoServicos();
                
                // Limpa campos
                UIElements.planoDescricaoInput.value = '';
                document.getElementById('planoCustoEstimado').value = '';
                document.getElementById('planoObservacao').value = '';
                UIElements.planoIntervaloKmInput.value = '';
                UIElements.planoIntervaloMesesInput.value = '';
                UIElements.planoMetaVinculadaSelect.value = '';
                
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Item adicionado ao plano.', type: 'success' });
            } else {
                // L√≥gica de criar meta autom√°tica (Mantida, mas atualizada para passar os novos dados se precisar)
                // Para simplificar, vamos apenas adicionar sem meta se o usu√°rio confirmar, ou criar a meta.
                // Vou manter sua l√≥gica original de "Criar Caixinha?"
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Criar "Caixinha"?',
                    mensagem: `Deseja criar uma meta de poupan√ßa para "${descricao}"? (Custo Est: ${Utils.formatarMoeda(custoEstimado)})`,
                    callback: (confirmado) => {
                        if (confirmado) {
                            EventHandlers.handleCriarPlanoComMetaCompleto(novoItem); // Nova fun√ß√£o auxiliar abaixo
                        } else {
                            AppState.configuracoes.planoManutencao.push(novoItem);
                            Storage.salvarConfiguracoes();
                            UIRenderer.renderPlanoMestre();
                            // Limpa campos...
                            UIElements.planoDescricaoInput.value = '';
                            document.getElementById('planoCustoEstimado').value = '';
                            document.getElementById('planoObservacao').value = '';
                            UIElements.planoIntervaloKmInput.value = '';
                            UIElements.planoIntervaloMesesInput.value = '';
                        }
                    }
                });
            }
        },

// Fun√ß√£o auxiliar para criar com meta (CORRIGIDA)
handleCriarPlanoComMetaCompleto: (itemPlano) => {
    // 1. Calcula a Contribui√ß√£o Mensal para suavizar o custo
    const prazo = itemPlano.intervaloMeses > 0 ? itemPlano.intervaloMeses : 12; // Padr√£o 1 ano se n√£o informado
    const valorTotal = itemPlano.custoEstimado || 0;
    const contribuicaoMensalCalculada = valorTotal / prazo;

    const novaMeta = {
        id: crypto.randomUUID(),
        descricao: `Fundo: ${itemPlano.descricao}`,
        tipo: 'poupanca',
        valorTotal: valorTotal,
        valorAtual: 0,
        prazoMeses: prazo,
        dataVencimento: null, // Opcional, o prazoMeses j√° controla
        
        // AQUI EST√Å A CORRE√á√ÉO: Definimos a parcela mensal
        contribuicaoMensal: contribuicaoMensalCalculada, 
        
        taxaJuros: 0,
        valorPorKm: 0,
        
        // Define como TRUE para j√° come√ßar a aparecer nos custos di√°rios
        incluirComoCustoDiario: true, 
        isObrigatorio: true, // Trava para n√£o esquecer
        
        bancoId: null
    };

    AppState.configuracoes.metasFinanceiras.push(novaMeta);
    SystemLog.success('MetaFinanceira', `Nova caixinha criada: ${novaMeta.descricao} (${Utils.formatarMoeda(contribuicaoMensalCalculada)}/m√™s)`);
    
    // Vincula o item do plano √† nova meta
    itemPlano.metaId = novaMeta.id;
    AppState.configuracoes.planoManutencao.push(itemPlano);
    
    Storage.salvarConfiguracoes();
    
    // Atualiza a tela
    UIRenderer.render(); 
    
    // Limpa campos
    UIElements.planoDescricaoInput.value = '';
    document.getElementById('planoCustoEstimado').value = '';
    document.getElementById('planoObservacao').value = '';
    UIElements.planoIntervaloKmInput.value = '';
    UIElements.planoIntervaloMesesInput.value = '';
    
    UIRenderer.renderPlanoMestre();
    
    UIRenderer.abrirModal('alerta', { 
        titulo: 'Caixinha Criada!', 
        mensagem: `Meta criada para juntar ${Utils.formatarMoeda(valorTotal)} em ${prazo} meses.\nCusto di√°rio aprox: ${Utils.formatarMoeda(contribuicaoMensalCalculada/30)}.`, 
        type: 'success' 
    });
},

       handleRepopularCalculadora: () => {
            const { cotacaoState } = AppState;
            if (!cotacaoState) return;

            // Repopula todos os campos com os valores salvos no AppState
            document.getElementById('cotacaoNomeCliente').value = cotacaoState.nomeCliente || '';

            // Recria as paradas
            const container = document.getElementById('cotacao-paradas-container');
            container.innerHTML = ''; // Limpa as paradas padr√£o
            cotacaoState.paradas.forEach((parada, index) => {
                const pontoLabel = String.fromCharCode(65 + index); // A, B, C...
                const label = (index === 0) ? 'Ponto A (Origem)' : (index === 1 ? 'Ponto B (Destino)' : `Parada (Ponto ${pontoLabel})`);

                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `
                    <label for="cotacaoPonto${index}" class="block text-xs font-medium text-slate-400 mb-1">${label}</label>
                    <input type="text" id="cotacaoPonto${index}" class="cotacao-parada-input w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white" value="${parada}">
                    ${index > 1 ? '<button class="btn-remover-parada absolute top-6 right-2 text-red-500 hover:text-red-400 transition">&times;</button>' : ''}
                `;

                if (index > 1) {
                    div.querySelector('.btn-remover-parada').addEventListener('click', (e) => {
                        e.preventDefault();
                        div.remove();
                    });
                }
                container.appendChild(div);
            });

            // Repopula datas
            if (cotacaoState.dataInicio) document.getElementById('cotacaoDataInicio').value = cotacaoState.dataInicio;
            if (cotacaoState.dataFim) document.getElementById('cotacaoDataFim').value = cotacaoState.dataFim;

            // Repopula detalhes
            document.getElementById('cotacaoTipoServico').value = cotacaoState.tipoServico || 'Passageiro';
            document.getElementById('cotacaoQtdItens').value = cotacaoState.qtdItens || '';
            document.getElementById('cotacaoPeso').value = Utils.formatarMoedaParaInput(cotacaoState.peso);

            // Repopula finan√ßas
            document.getElementById('cotacaoDistEmbarque').value = cotacaoState.distEmbarque || '';
            document.getElementById('cotacaoDistViagem').value = cotacaoState.distViagem || '';
            document.getElementById('cotacaoPedagios').value = Utils.formatarMoedaParaInput(cotacaoState.pedagios);
            document.getElementById('cotacaoSeguranca').value = Utils.formatarMoedaParaInput(cotacaoState.seguranca);
            document.getElementById('cotacaoSemRetorno').checked = cotacaoState.semRetorno;
            document.getElementById('cotacaoValorKm').value = Utils.formatarMoedaParaInput(cotacaoState.valorKm);
            document.getElementById('cotacaoValorKmRetorno').value = Utils.formatarMoedaParaInput(cotacaoState.valorKmRetorno);

            // Repopula checkboxes de custo
            const custosCheckboxes = document.querySelectorAll('.cotacao-custo-checkbox');
            const custosSelecionados = cotacaoState.custosInclusos.map(c => c.descricao);
            custosCheckboxes.forEach(cb => {
                let label = cb.closest('label').querySelector('span').textContent;
                if (cb.id === 'cotacao-custo-prolabore') label = "Pr√≥-labore (Custo Di√°rio)";
                if (cb.id === 'cotacao-custo-META_CUSTOS_MENSAIS') label = "Custos Fixos (Di√°rio)";

                cb.checked = custosSelecionados.includes(label);
            });

            // Garante que a aba de cota√ß√£o fique vis√≠vel
            document.querySelector('.calc-tab-button[data-tab="troco"]').classList.remove('active');
            document.querySelector('.calc-tab-button[data-tab="cotacao"]').classList.add('active');
            document.getElementById('calc-tab-content-troco').classList.add('hidden');
            document.getElementById('calc-tab-content-cotacao').classList.remove('hidden');

            // Recalcula o total final
            EventHandlers.handleRecalcularCotacao();
        },
        handleCriarPlanoVinculado: (categoria, descricao, intervaloKm, intervaloMeses, metaId) => {
            const novoItem = {
                id: crypto.randomUUID(),
                categoria: categoria,
                descricao: descricao,
                intervaloKm: intervaloKm,
                intervaloMeses: intervaloMeses,
                metaId: metaId,
            };
            
            AppState.configuracoes.planoManutencao.push(novoItem);
            Storage.salvarConfiguracoes();
            UIRenderer.renderPlanoMestre();
            UIRenderer.renderHistoricoServicos();
            
            UIElements.planoDescricaoInput.value = '';
            UIElements.planoIntervaloKmInput.value = '';
            UIElements.planoIntervaloMesesInput.value = '';
            UIElements.planoMetaVinculadaSelect.value = '';
            
            UIRenderer.abrirModal('alerta', { 
                titulo: 'Plano Vinculado!', 
                mensagem: `O item "${descricao}" foi adicionado ao plano e vinculado √† sua caixinha.`, 
                type: 'success' 
            });
            
            UIRenderer.fecharModal();
        },
        handleDispensarAlerta: (e) => {
            const btn = e.target.closest('.btn-dispensar-alerta');
            if (btn) {
                btn.parentElement.remove();
            }
        },
        handleExportarDados: () => {
            try {
                // O backup salva todos os armazenamentos principais
                const backupData = {
                    jornadas: AppState.jornadas,
                    configuracoes: AppState.configuracoes,
                    historicoTransacoes: AppState.historicoTransacoes,
                    historicoManutencao: AppState.historicoManutencao,
                    cotaManutencao: AppState.cotaManutencao,
                    visualSettings: AppState.visualSettings
                };
                
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                // Gera nome com data
                a.href = url;
                a.download = `diario_de_bordo_backup_v7.3_${Utils.formatarDataParaChave(new Date())}.json`;
                a.click();
                URL.revokeObjectURL(url);

                // --- NOVO: Salva a data deste backup para o lembrete ---
                localStorage.setItem('ultimoBackupData', Date.now().toString());

                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso!', mensagem: 'Backup dos dados exportado com sucesso.', type: 'success' });
            } catch (error) {
                console.error("Erro ao exportar dados:", error);
                UIRenderer.abrirModal('alerta', { titulo: 'Erro!', mensagem: 'N√£o foi poss√≠vel exportar os dados.' });
            }
        },
handleImportarDados: (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Valida√ß√£o b√°sica
                    if (data.jornadas && data.configuracoes) {
                        // 1. Salva temporariamente na mem√≥ria (N√ÉO no banco ainda)
                        AppState.tempImportData = data;
                        
                        // 2. Abre o menu para voc√™ escolher (Mesclar ou Substituir)
                        UIRenderer.abrirModal('importacaoOpcoes');
                    } else {
                        throw new Error("Arquivo inv√°lido ou corrompido.");
                    }
                } catch (error) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Erro!', mensagem: 'Falha ao ler o arquivo. Verifique se √© um backup v√°lido.' });
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reseta o input
        },
        
        handleCriarPlanoComMeta: (categoria, descricao, intervaloKm, intervaloMeses) => {
            const novaMeta = {
                id: crypto.randomUUID(),
                descricao: `Fundo: ${descricao}`,
                tipo: 'poupanca',
                valorTotal: 0,
                valorAtual: 0,
                prazoMeses: intervaloMeses,
                dataVencimento: null,
                contribuicaoMensal: 0,
                taxaJuros: 0,
                valorPorKm: 0,
				incluirComoCustoDiario: false,
                bancoId: null
            };
            AppState.configuracoes.metasFinanceiras.push(novaMeta);
            SystemLog.success('MetaFinanceira', `Nova caixinha criada: ${novaMeta.descricao}`);
            const novoItem = {
                id: crypto.randomUUID(),
                categoria: categoria,
                descricao: descricao,
                intervaloKm: intervaloKm,
                intervaloMeses: intervaloMeses,
                metaId: novaMeta.id,
            };
            AppState.configuracoes.planoManutencao.push(novoItem);
            
            Storage.salvarConfiguracoes();
            
            UIElements.planoDescricaoInput.value = '';
            UIElements.planoIntervaloKmInput.value = '';
            UIElements.planoIntervaloMesesInput.value = '';
            UIElements.planoMetaVinculadaSelect.value = '';

            UIRenderer.renderPlanoMestre();
            UIRenderer.renderHistoricoServicos();
            UIRenderer.renderMetasFinanceiras();

            UIRenderer.fecharModal();

            const finTabButton = document.querySelector('.tab-button[data-tab="financeiro"]');
            if (finTabButton) {
                finTabButton.click();
            }
            
            const metaTabManutencao = document.querySelector('.meta-tab-button[data-meta-tab="manutencao"]');
            if (metaTabManutencao) {
                metaTabManutencao.click();
            }
            
            EventHandlers.handleListaMetasFinanceiras({ target: document.querySelector(`.btn-editar-meta[data-id="${novaMeta.id}"]`) });
            
            UIRenderer.abrirModal('alerta', {
                titulo: 'Caixinha Criada!',
                mensagem: `A caixinha "Fundo: ${descricao}" foi criada. Vincule-a a um banco, defina o Valor Objetivo e clique em Salvar.`,
                type: 'success'
            });
        },
        
        handleListaPlanoMestre: (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('btn-remover-plano')) {
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Item do Plano?',
                    mensagem: 'Tem certeza que deseja excluir este item do Plano Mestre?',
                    callback: () => {
                        AppState.configuracoes.planoManutencao = AppState.configuracoes.planoManutencao.filter(item => item.id !== id);
                        Storage.salvarConfiguracoes();
                        UIRenderer.renderPlanoMestre();
                        UIRenderer.renderHistoricoServicos();
                    }
                });
            }
            
            if (target.classList.contains('btn-editar-plano')) {
                const itemParaEditar = AppState.configuracoes.planoManutencao.find(item => item.id === id);
                if (itemParaEditar) {
                    UIRenderer.abrirModal('edicaoPlanoMestre', { 
                        titulo: 'Editar Item do Plano', 
                        item: itemParaEditar 
                    });
                }
            }
        },
// --- CONFIRMAR TRANSFER√äNCIA (GOLD MASTER) ---
        handleConfirmarTransferencia: (e) => {
            const btn = e.target.closest('#btn-confirmar-transferencia');
            if (!btn) return;
            if (btn.hasAttribute('data-processing')) return;
            btn.setAttribute('data-processing', 'true');
            const textoOriginal = btn.textContent;
            btn.textContent = "Processando...";
            btn.classList.add('opacity-50', 'cursor-wait');

            // Lock e Idempot√™ncia
            const LOCK_KEY = 'app_transfer_lock';
            const acquireLock = () => {
                const now = Date.now();
                const lockRaw = localStorage.getItem(LOCK_KEY);
                const myId = crypto.randomUUID();
                if (lockRaw && (now - JSON.parse(lockRaw).ts < 5000)) return null; 
                localStorage.setItem(LOCK_KEY, JSON.stringify({ owner: myId, ts: now }));
                return myId;
            };
            const releaseLock = (owner) => {
                try {
                    const lock = JSON.parse(localStorage.getItem(LOCK_KEY));
                    if (lock && lock.owner === owner) localStorage.removeItem(LOCK_KEY);
                } catch(e){}
            };

            let lockOwner = acquireLock();
            if (!lockOwner) {
                btn.removeAttribute('data-processing');
                btn.textContent = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-wait');
                return;
            }

            let snapshot = null;
            let pushedTxIds = [];

            try {
                const valor = Utils.parseMoeda(document.getElementById('transf-valor').value);
                const origemId = document.getElementById('transf-origem-id').value;
                const destinoId = document.getElementById('transf-destino-id').value;
                let descricao = document.getElementById('transf-descricao').value.trim();

                if (valor <= 0) throw new Error('Valor deve ser maior que zero.');
                if (origemId === destinoId) throw new Error('Origem e destino iguais.');

                const getEntidade = (id) => {
                    if (id === 'AUTO_ID_CARTEIRA') return { tipo: 'carteira_fisica', ref: null, nome: 'Carteira (Dinheiro)' };
                    const conta = AppState.configuracoes.contasBancarias.find(c => c.id === id);
                    if (conta) return { tipo: 'conta', ref: conta, nome: conta.nome };
                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
                    if (meta) return { tipo: 'caixinha', ref: meta, nome: meta.descricao };
                    return null;
                };

                const objOrigem = getEntidade(origemId);
                const objDestino = getEntidade(destinoId);
                if (!objOrigem || !objDestino) throw new Error('Entidades n√£o localizadas.');

                // Valida√ß√£o de Saldo
                let saldoOrigem = 0;
                if (objOrigem.tipo === 'caixinha') {
                    saldoOrigem = (objOrigem.ref.tipo === 'parcelamento') ? (objOrigem.ref.valorProvisionado || 0) : (objOrigem.ref.valorAtual || 0);
                } else {
                    saldoOrigem = BusinessLogic.calcularSaldoConta(origemId);
                }

                if (saldoOrigem < valor) throw new Error(`Saldo insuficiente em "${objOrigem.nome}".`);
                if (!descricao) descricao = `Transf. para: ${objDestino.nome}`;

                snapshot = {
                    origem: objOrigem.tipo === 'caixinha' ? { id: objOrigem.ref.id, valorAtual: objOrigem.ref.valorAtual, valorProvisionado: objOrigem.ref.valorProvisionado } : null,
                    destino: objDestino.tipo === 'caixinha' ? { id: objDestino.ref.id, valorAtual: objDestino.ref.valorAtual, valorProvisionado: objDestino.ref.valorProvisionado } : null
                };

                // Muta√ß√£o Segura (Utils.Money)
                if (objDestino.tipo === 'caixinha') {
                    const meta = objDestino.ref;
                    if (meta.tipo === 'parcelamento') meta.valorProvisionado = Utils.Money.add(meta.valorProvisionado, valor);
                    else meta.valorAtual = Utils.Money.add(meta.valorAtual, valor);
                }
                if (objOrigem.tipo === 'caixinha') {
                    const meta = objOrigem.ref;
                    if (meta.tipo === 'parcelamento') meta.valorProvisionado = Math.max(0, Utils.Money.subtract(meta.valorProvisionado, valor));
                    else meta.valorAtual = Math.max(0, Utils.Money.subtract(meta.valorAtual, valor));
                }

                const dataAgora = Date.now();
                const transferId = crypto.randomUUID();

                const txSaida = {
                    id: crypto.randomUUID(), data: dataAgora, tipo: 'saida',
                    contaId: origemId, valor: valor, descricao: descricao,
                    jornadaId: null, isCustoOperacional: false,
                    origem: { id: origemId, nome: objOrigem.nome },
                    destino: { id: destinoId, nome: objDestino.nome },
                    detalhes: { transferId, leg: 'origin', tipo: 'transferencia' }
                };

                const txEntrada = {
                    id: crypto.randomUUID(), data: dataAgora, tipo: 'entrada',
                    contaId: destinoId, valor: valor, descricao: `Recebido de: ${objOrigem.nome}`,
                    jornadaId: null, isCustoOperacional: false,
                    origem: { id: origemId, nome: objOrigem.nome },
                    destino: { id: destinoId, nome: objDestino.nome },
                    detalhes: { transferId, leg: 'destination', tipo: 'transferencia' }
                };

                AppState.historicoTransacoes.push(Utils.normalizeTransaction(txSaida), Utils.normalizeTransaction(txEntrada));
                pushedTxIds.push(txSaida.id, txEntrada.id);

                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.render();
                UIRenderer.renderContasBancarias();
                UIRenderer.renderMetasFinanceiras();
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Transfer√™ncia realizada.', type: 'success' });

            } catch (erro) {
                if (snapshot) {
                    if (snapshot.origem) {
                        const m = AppState.configuracoes.metasFinanceiras.find(x => x.id === snapshot.origem.id);
                        if(m) { m.valorAtual = snapshot.origem.valorAtual; m.valorProvisionado = snapshot.origem.valorProvisionado; }
                    }
                    if (snapshot.destino) {
                        const m = AppState.configuracoes.metasFinanceiras.find(x => x.id === snapshot.destino.id);
                        if(m) { m.valorAtual = snapshot.destino.valorAtual; m.valorProvisionado = snapshot.destino.valorProvisionado; }
                    }
                }
                if (pushedTxIds.length > 0) AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !pushedTxIds.includes(t.id));
                try { Storage.salvarConfiguracoes(); } catch (e) {}
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: erro.message });
            } finally {
                releaseLock(lockOwner);
                btn.removeAttribute('data-processing');
                btn.textContent = textoOriginal;
                btn.classList.remove('opacity-50', 'cursor-wait');
            }
        },
        // ============================================================================
        // MOTOR DE TRANSA√á√ÉO V138 (CORRE√á√ÉO DE HOR√ÅRIO + ATOMICIDADE)
        // ============================================================================
        handleSalvarTransacaoAvulsa: () => {
            const btn = document.getElementById('btn-salvar-transacao-avulsa');
            
            // üõ°Ô∏è BUFFERS DE ATOMICIDADE
            const pendingTransactions = [];
            const pendingAccountUpdates = []; 
            const pendingConfigUpdates = [];

            try {
                // 1. CAPTURA DE DADOS
                const ancoraValor = document.getElementById('trans-valor');
                const rawConta = document.getElementById('trans-conta-id').value;
                const elData = document.getElementById('trans-data');
                
                const rawJornadaId = document.getElementById('trans-jornada-id').value;
                const jornadaIdFinal = rawJornadaId || AppState.activeJornadaChave || AppState.jornadaAtivaId || null;
                
                const resolverContaReal = (idInput) => {
                    if (!idInput || idInput === 'carteira_motorista' || idInput === 'AUTO_ID_CARTEIRA') {
                        const ID_ALVO = 'AUTO_ID_CARTEIRA';
                        const existeNoState = AppState.configuracoes.contasBancarias.some(c => c.id === ID_ALVO);
                        const existeNoPendente = pendingConfigUpdates.some(u => u.type === 'create_account' && u.payload.id === ID_ALVO);

                        if (!existeNoState && !existeNoPendente) {
                            pendingConfigUpdates.push({
                                type: 'create_account',
                                payload: { id: ID_ALVO, nome: 'Carteira (Dinheiro)', saldo: 0, tipo: 'carteira' }
                            });
                        }
                        return ID_ALVO;
                    }
                    return idInput;
                };

                const descInput = document.getElementById('trans-descricao').value.trim();
                let subExtraida = '';
                const matchSub = descInput.match(/\((.*?)\)/);
                if (matchSub) subExtraida = matchSub[1];

                const dadosForm = {
                    tipo: document.getElementById('trans-tipo').value,
                    valorTotal: Utils.parseMoeda(ancoraValor ? ancoraValor.value : '0'),
                    contaIdInput: rawConta,
                    categoria: document.getElementById('trans-categoria').value,
                    descricaoBase: descInput,
                    subcategoria: subExtraida,
                    dataSelecionada: elData.value, // Formato YYYY-MM-DD
                    parcelas: parseInt(document.getElementById('trans-parcelas').value) || 1,
                    idRecorrente: document.getElementById('trans-recorrente-id').value || null,
                    jornadaIdVal: jornadaIdFinal,
                    isCustoOperacionalVal: document.getElementById('trans-is-custo-operacional').checked,
                    context: document.getElementById('trans-context')?.value,
                    isMisto: document.getElementById('chk-trans-misto') ? document.getElementById('chk-trans-misto').checked : false,
                    c1: document.getElementById('trans-conta-1') ? document.getElementById('trans-conta-1').value : '',
                    v1: Utils.parseMoeda(document.getElementById('trans-valor-1') ? document.getElementById('trans-valor-1').value : '0'),
                    c2: document.getElementById('trans-conta-2') ? document.getElementById('trans-conta-2').value : '',
                    v2: Utils.parseMoeda(document.getElementById('trans-valor-2') ? document.getElementById('trans-valor-2').value : '0')
                };

                if (dadosForm.categoria === 'Abastecimento') dadosForm.isCustoOperacionalVal = true;
                if (!dadosForm.descricaoBase) dadosForm.descricaoBase = dadosForm.categoria;
                if (dadosForm.valorTotal <= 0) throw new Error('Valor inv√°lido (R$ 0,00).');

                // 2. CONTEXTO DE ABASTECIMENTO
                let detalhesMerge = {};
                let isAbastecimentoFlow = false;
                const TTL = 15 * 60 * 1000; 
                if (AppState.modalContext === 'pagamento_abastecimento' && AppState.tempAbastecimento) {
                    detalhesMerge = { ...AppState.tempAbastecimento }; isAbastecimentoFlow = true;
                } else if (dadosForm.categoria === 'Abastecimento') {
                    const rawDisk = localStorage.getItem('temp_abastecimento_pendente');
                    if (rawDisk) {
                        const parsed = JSON.parse(rawDisk);
                        if (parsed.litros > 0 && (Date.now() - (parsed._ts || 0) < TTL)) { detalhesMerge = parsed; isAbastecimentoFlow = true; } 
                        else { localStorage.removeItem('temp_abastecimento_pendente'); }
                    }
                }
                if (detalhesMerge._ts) delete detalhesMerge._ts;
                if (isAbastecimentoFlow) dadosForm.categoria = 'Abastecimento';

                // 3. NATUREZA ECON√îMICA
                const categoriasInvestimento = ['Metas Financeiras', 'Investimento', 'Poupan√ßa', 'Caixinha'];
                const termosInvestimento = ['caixinha', 'guardar', 'reserva', 'aporte'];
                let impactaResultado = true; 
                const catLower = dadosForm.categoria.toLowerCase();
                const descLower = dadosForm.descricaoBase.toLowerCase();
                if (categoriasInvestimento.some(c => catLower.includes(c.toLowerCase())) || termosInvestimento.some(t => descLower.includes(t))) {
                    impactaResultado = false;
                }

                // 4. AUTO-VINCULA√á√ÉO JORNADA
                if (dadosForm.isCustoOperacionalVal && !dadosForm.jornadaIdVal) {
                    const dataBusca = new Date(dadosForm.dataSelecionada + 'T12:00:00');
                    const jornadaEncontrada = BusinessLogic.getJornadaDoDia(dataBusca);
                    if (jornadaEncontrada) dadosForm.jornadaIdVal = jornadaEncontrada.id;
                }

                // 5. TRAVA LEDGER
                if (dadosForm.tipo === 'saida') {
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    let debitoCarteira = 0;
                    if (dadosForm.isMisto) {
                        if (resolverContaReal(dadosForm.c1) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v1;
                        if (resolverContaReal(dadosForm.c2) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v2;
                    } else {
                        if (resolverContaReal(dadosForm.contaIdInput) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.valorTotal;
                    }
                    if (debitoCarteira > 0 && (saldoCarteira - debitoCarteira) < -0.01) {
                        throw new Error(`Saldo insuficiente na Carteira.\nDispon√≠vel: ${Utils.formatarMoeda(saldoCarteira)}\nTentativa: ${Utils.formatarMoeda(debitoCarteira)}`);
                    }
                }

                if(btn) { btn.textContent = "Salvando..."; btn.disabled = true; }

                // 6. PREPARA√á√ÉO TEMPORAL (CORRE√á√ÉO V138)
                const requestId = Utils.gerarUUID(); 
                let horaTransacao = '12:00'; // Default seguro para datas passadas/futuras

                if (isAbastecimentoFlow && detalhesMerge.hora) {
                    horaTransacao = detalhesMerge.hora;
                } else {
                    // L√ìGICA ROBUSTA PARA "HOJE"
                    const inputDateParts = dadosForm.dataSelecionada.split('-'); // YYYY-MM-DD
                    const inputAno = parseInt(inputDateParts[0]);
                    const inputMes = parseInt(inputDateParts[1]) - 1; // JS meses s√£o 0-11
                    const inputDia = parseInt(inputDateParts[2]);

                    const now = new Date();
                    const isToday = (
                        now.getFullYear() === inputAno &&
                        now.getMonth() === inputMes &&
                        now.getDate() === inputDia
                    );

                    if (isToday) {
                        // Se √© hoje, pega o minuto exato
                        horaTransacao = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    }
                }

                // Cria data base com a hora correta
                const dataBase = new Date(dadosForm.dataSelecionada + 'T' + horaTransacao);
                // Fallback de seguran√ßa se der inv√°lido
                if (isNaN(dataBase.getTime())) dataBase.setTime(new Date(dadosForm.dataSelecionada + 'T12:00:00').getTime());

                // Data Econ√¥mica (Alinhada com Jornada se necess√°rio)
                let dataEconomicaBase = dataBase.getTime(); 
                if (dadosForm.isCustoOperacionalVal && dadosForm.jornadaIdVal) {
                    const jornadaRef = BusinessLogic.getJornadaById(dadosForm.jornadaIdVal);
                    if (jornadaRef) {
                        const dtJ = new Date(jornadaRef.data);
                        // Aqui for√ßamos 12:00 para garantir que caia no DIA da jornada no DRE,
                        // mas a data 'f√≠sica' (dataBase) mant√©m a hora exata para o Roadmap.
                        dataEconomicaBase = new Date(dtJ.getFullYear(), dtJ.getMonth(), dtJ.getDate(), 12, 0, 0).getTime();
                    }
                }

                const splitIdMaster = (dadosForm.isMisto || dadosForm.parcelas > 1) ? Utils.gerarUUID() : null;
                const pagamentos = [];

                // Montagem do Array de Pagamentos
                if (dadosForm.isMisto) {
                    if (dadosForm.v1 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c1), valor: dadosForm.v1, suffix: '(Parcial 1)', isMain: true });
                    if (dadosForm.v2 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c2), valor: dadosForm.v2, suffix: '(Parcial 2)', isMain: false });
                } else {
                    if (dadosForm.parcelas > 1 && dadosForm.tipo === 'saida') {
                        const valorParc = dadosForm.valorTotal / dadosForm.parcelas;
                        for(let p=1; p<=dadosForm.parcelas; p++) {
                            pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: valorParc, suffix: `(${p}/${dadosForm.parcelas})`, isMain: p===1, monthOffset: p-1 });
                        }
                    } else {
                        pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: dadosForm.valorTotal, suffix: '', isMain: true });
                    }
                }

                // 7. LOOP DE PROCESSAMENTO
                pagamentos.forEach((pgto) => {
                    const transacaoId = Utils.gerarUUID(); 
                    let detalhesFinais = {};
                    if (isAbastecimentoFlow) {
                        detalhesFinais = pgto.isMain ? { ...detalhesMerge, valorEvento: dadosForm.valorTotal } : { ...detalhesMerge, litros: 0, valorEvento: 0 };
                    }
                    const dataTransacao = new Date(dataBase);
                    let dataEconomicaFinal = dataEconomicaBase;
                    if (pgto.monthOffset) {
                        dataTransacao.setMonth(dataTransacao.getMonth() + pgto.monthOffset);
                        const dEco = new Date(dataEconomicaBase);
                        dEco.setMonth(dEco.getMonth() + pgto.monthOffset);
                        dataEconomicaFinal = dEco.getTime();
                    }
                    
                    const contaSelecionada = AppState.configuracoes.contasBancarias.find(c => c.id === pgto.contaId);
                    const descFinal = `${dadosForm.descricaoBase} ${pgto.suffix}`.trim();

                    const txBase = {
                        id: (contaSelecionada?.tipo === 'credito') ? Utils.gerarUUID() : transacaoId,
                        split_id: splitIdMaster,
                        data: dataTransacao.getTime(), // üïí AQUI EST√Å A DATA/HORA EXATA VISUAL
                        createdAt: Date.now(),
                        dataEconomica: dataEconomicaFinal, // üìÖ AQUI EST√Å A DATA CONT√ÅBIL (DRE)
                        tipo: dadosForm.tipo, 
                        valor: pgto.valor,
                        descricao: descFinal,
                        categoria: dadosForm.categoria,
                        jornadaId: dadosForm.jornadaIdVal,
                        requestId: requestId,
                        detalhes: detalhesFinais,
                        contaId: (contaSelecionada?.tipo === 'credito') ? `FATURA_${contaSelecionada.id}` : pgto.contaId,
                        isCredito: contaSelecionada?.tipo === 'credito',
                        isCustoOperacional: dadosForm.isCustoOperacionalVal,
                        impactaResultado: impactaResultado
                    };

                    if (isAbastecimentoFlow) FuelAuditor.enrichTransaction(txBase, 'Motorista', true);
                    
                    pendingTransactions.push(txBase);

                    if (contaSelecionada) {
                        pendingAccountUpdates.push(() => {
                            if (contaSelecionada.tipo === 'credito') {
                                if (dadosForm.tipo === 'saida') contaSelecionada.faturaAtual = (contaSelecionada.faturaAtual || 0) + pgto.valor;
                                else contaSelecionada.faturaAtual = (contaSelecionada.faturaAtual || 0) - pgto.valor;
                            } else {
                                if (typeof contaSelecionada.saldo !== 'number') contaSelecionada.saldo = 0;
                                if (dadosForm.tipo === 'entrada') contaSelecionada.saldo = Utils.Money.add(contaSelecionada.saldo, pgto.valor);
                                else contaSelecionada.saldo = Utils.Money.subtract(contaSelecionada.saldo, pgto.valor);
                            }
                        });
                    }
                });

                // COMMIT
                pendingConfigUpdates.forEach(update => {
                    if (update.type === 'create_account') AppState.configuracoes.contasBancarias.push(update.payload);
                });
                pendingTransactions.forEach(t => AppState.historicoTransacoes.push(t));
                pendingAccountUpdates.forEach(updateFn => updateFn());

                if (isAbastecimentoFlow) {
                    const transacaoPrincipal = pendingTransactions.find(t => t.detalhes?.litros > 0);
                    if (transacaoPrincipal) {
                        const transacaoUnificada = { ...transacaoPrincipal, valor: dadosForm.valorTotal };
                        if (!transacaoUnificada.detalhes) transacaoUnificada.detalhes = {};
                        transacaoUnificada.detalhes.km = detalhesMerge.km; 
                        BusinessLogic.sincronizarAbastecimentoComJornada(transacaoUnificada);
                    }
                    AppState.modalContext = null; AppState.tempAbastecimento = null;
                    localStorage.removeItem('temp_abastecimento_pendente');
                }

                Storage.salvarConfiguracoes();
                Storage.salvarJornadas(); 
                Storage.salvarTransacoes(); 

                UIRenderer.fecharModal(); 
                UIRenderer.render(); 
                if (EventHandlers.renderFuelHistoryList) EventHandlers.renderFuelHistoryList();

                const msgScore = (isAbastecimentoFlow && detalhesMerge.ratingSistema) ? `\n\nDesempenho: ${detalhesMerge.ratingSistema.score}` : '';
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso!', mensagem: `Transa√ß√£o salva com sucesso.${msgScore}`, type: 'success' });

            } catch (erro) {
                console.error("Rollback acionado:", erro);
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: erro.message, type: 'error' });
            } finally { 
                if(btn) { btn.textContent = "Salvar"; btn.disabled = false; }
            }
        },
    /*    
// ============================================================================
        // MOTOR DE TRANSA√á√ÉO V130 (ATOMICIDADE ESTRITA - ZERO SIDE EFFECTS)
        // ============================================================================
        handleSalvarTransacaoAvulsa: () => {
            const btn = document.getElementById('btn-salvar-transacao-avulsa');
            
            // üõ°Ô∏è BUFFERS DE ATOMICIDADE (ISOLAMENTO COMPLETO)
            const pendingTransactions = [];
            const pendingAccountUpdates = []; 
            const pendingConfigUpdates = []; // <--- NOVO: Para corre√ß√µes de estrutura (Carteira)

            try {
                // 1. CAPTURA DE DADOS
                const ancoraValor = document.getElementById('trans-valor');
                const rawConta = document.getElementById('trans-conta-id').value;
                const elData = document.getElementById('trans-data');
                
                // --- PATCH V149: RECUPERA√á√ÉO INTELIGENTE DA JORNADA ---
                const rawJornadaId = document.getElementById('trans-jornada-id').value;
                const jornadaIdFinal = rawJornadaId || AppState.activeJornadaChave || AppState.jornadaAtivaId || null;
                
                // --- HELPER PURO (SEM MUTA√á√ÉO) ---
                const resolverContaReal = (idInput) => {
                    if (!idInput || idInput === 'carteira_motorista' || idInput === 'AUTO_ID_CARTEIRA') {
                        const ID_ALVO = 'AUTO_ID_CARTEIRA';
                        
                        // 1. Verifica se j√° existe no Estado Real
                        const existeNoState = AppState.configuracoes.contasBancarias.some(c => c.id === ID_ALVO);
                        
                        // 2. Verifica se j√° mandamos criar nessa transa√ß√£o (para n√£o duplicar)
                        const existeNoPendente = pendingConfigUpdates.some(u => u.type === 'create_account' && u.payload.id === ID_ALVO);

                        if (!existeNoState && !existeNoPendente) {
                            // üõë N√ÉO CRIA AQUI. AGENDA A CRIA√á√ÉO.
                            pendingConfigUpdates.push({
                                type: 'create_account',
                                payload: { id: ID_ALVO, nome: 'Carteira (Dinheiro)', saldo: 0, tipo: 'carteira' }
                            });
                        }
                        return ID_ALVO;
                    }
                    return idInput;
                };

                const descInput = document.getElementById('trans-descricao').value.trim();
                let subExtraida = '';
                const matchSub = descInput.match(/\((.*?)\)/);
                if (matchSub) subExtraida = matchSub[1];

                const dadosForm = {
                    tipo: document.getElementById('trans-tipo').value,
                    valorTotal: Utils.parseMoeda(ancoraValor ? ancoraValor.value : '0'),
                    contaIdInput: rawConta,
                    categoria: document.getElementById('trans-categoria').value,
                    descricaoBase: descInput,
                    subcategoria: subExtraida,
                    dataSelecionada: elData.value,
                    parcelas: parseInt(document.getElementById('trans-parcelas').value) || 1,
                    idRecorrente: document.getElementById('trans-recorrente-id').value || null,
                    jornadaIdVal: jornadaIdFinal,
                    isCustoOperacionalVal: document.getElementById('trans-is-custo-operacional').checked,
                    context: document.getElementById('trans-context')?.value,
                    isMisto: document.getElementById('chk-trans-misto') ? document.getElementById('chk-trans-misto').checked : false,
                    c1: document.getElementById('trans-conta-1') ? document.getElementById('trans-conta-1').value : '',
                    v1: Utils.parseMoeda(document.getElementById('trans-valor-1') ? document.getElementById('trans-valor-1').value : '0'),
                    c2: document.getElementById('trans-conta-2') ? document.getElementById('trans-conta-2').value : '',
                    v2: Utils.parseMoeda(document.getElementById('trans-valor-2') ? document.getElementById('trans-valor-2').value : '0')
                };

                if (dadosForm.categoria === 'Abastecimento') dadosForm.isCustoOperacionalVal = true;
                if (!dadosForm.descricaoBase) dadosForm.descricaoBase = dadosForm.categoria;
                if (dadosForm.valorTotal <= 0) throw new Error('Valor inv√°lido (R$ 0,00).');

                // 2. CONTEXTO DE ABASTECIMENTO (L√≥gica mantida...)
                let detalhesMerge = {};
                let isAbastecimentoFlow = false;
                const TTL = 15 * 60 * 1000; 
                if (AppState.modalContext === 'pagamento_abastecimento' && AppState.tempAbastecimento) {
                    detalhesMerge = { ...AppState.tempAbastecimento }; isAbastecimentoFlow = true;
                } else if (dadosForm.categoria === 'Abastecimento') {
                    const rawDisk = localStorage.getItem('temp_abastecimento_pendente');
                    if (rawDisk) {
                        const parsed = JSON.parse(rawDisk);
                        if (parsed.litros > 0 && (Date.now() - (parsed._ts || 0) < TTL)) { detalhesMerge = parsed; isAbastecimentoFlow = true; } 
                        else { localStorage.removeItem('temp_abastecimento_pendente'); }
                    }
                }
                if (detalhesMerge._ts) delete detalhesMerge._ts;
                if (isAbastecimentoFlow) dadosForm.categoria = 'Abastecimento';

                // 3. NATUREZA ECON√îMICA
                const categoriasInvestimento = ['Metas Financeiras', 'Investimento', 'Poupan√ßa', 'Caixinha'];
                const termosInvestimento = ['caixinha', 'guardar', 'reserva', 'aporte'];
                let impactaResultado = true; 
                const catLower = dadosForm.categoria.toLowerCase();
                const descLower = dadosForm.descricaoBase.toLowerCase();
                if (categoriasInvestimento.some(c => catLower.includes(c.toLowerCase())) || termosInvestimento.some(t => descLower.includes(t))) {
                    impactaResultado = false;
                }

                // 4. AUTO-VINCULA√á√ÉO JORNADA
                if (dadosForm.isCustoOperacionalVal && !dadosForm.jornadaIdVal) {
                    const dataBusca = new Date(dadosForm.dataSelecionada + 'T12:00:00');
                    const jornadaEncontrada = BusinessLogic.getJornadaDoDia(dataBusca);
                    if (jornadaEncontrada) dadosForm.jornadaIdVal = jornadaEncontrada.id;
                }

                // 5. TRAVA LEDGER (LEITURA SEGURA)
                // Nota: Ler o estado √© seguro. Mudar n√£o.
                if (dadosForm.tipo === 'saida') {
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    let debitoCarteira = 0;
                    if (dadosForm.isMisto) {
                        if (resolverContaReal(dadosForm.c1) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v1;
                        if (resolverContaReal(dadosForm.c2) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v2;
                    } else {
                        if (resolverContaReal(dadosForm.contaIdInput) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.valorTotal;
                    }
                    if (debitoCarteira > 0 && (saldoCarteira - debitoCarteira) < -0.01) {
                        throw new Error(`Saldo insuficiente na Carteira.\nDispon√≠vel: ${Utils.formatarMoeda(saldoCarteira)}\nTentativa: ${Utils.formatarMoeda(debitoCarteira)}`);
                    }
                }

                if(btn) { btn.textContent = "Salvando..."; btn.disabled = true; }

                // 6. PREPARA√á√ÉO TEMPORAL
                const requestId = Utils.gerarUUID(); 
                let horaTransacao = '12:00';
                if (isAbastecimentoFlow && detalhesMerge.hora) horaTransacao = detalhesMerge.hora;
                else {
                    const hojeISO = new Date().toLocaleDateString('pt-BR').split('/').reverse().join('-');
                    if (dadosForm.dataSelecionada === hojeISO) {
                        const now = new Date();
                        horaTransacao = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    }
                }
                const dataBase = new Date(dadosForm.dataSelecionada + 'T' + horaTransacao);
                if (isNaN(dataBase.getTime())) dataBase.setTime(new Date(dadosForm.dataSelecionada + 'T12:00:00').getTime());

                let dataEconomicaBase = dataBase.getTime(); 
                if (dadosForm.isCustoOperacionalVal && dadosForm.jornadaIdVal) {
                    const jornadaRef = BusinessLogic.getJornadaById(dadosForm.jornadaIdVal);
                    if (jornadaRef) {
                        const dtJ = new Date(jornadaRef.data);
                        dataEconomicaBase = new Date(dtJ.getFullYear(), dtJ.getMonth(), dtJ.getDate(), 12, 0, 0).getTime();
                    }
                }

                const splitIdMaster = (dadosForm.isMisto || dadosForm.parcelas > 1) ? Utils.gerarUUID() : null;
                const pagamentos = [];

                // Montagem do Array de Pagamentos (Puramente mem√≥ria local)
                if (dadosForm.isMisto) {
                    if (dadosForm.v1 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c1), valor: dadosForm.v1, suffix: '(Parcial 1)', isMain: true });
                    if (dadosForm.v2 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c2), valor: dadosForm.v2, suffix: '(Parcial 2)', isMain: false });
                } else {
                    if (dadosForm.parcelas > 1 && dadosForm.tipo === 'saida') {
                        const valorParc = dadosForm.valorTotal / dadosForm.parcelas;
                        for(let p=1; p<=dadosForm.parcelas; p++) {
                            pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: valorParc, suffix: `(${p}/${dadosForm.parcelas})`, isMain: p===1, monthOffset: p-1 });
                        }
                    } else {
                        pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: dadosForm.valorTotal, suffix: '', isMain: true });
                    }
                }

                // 7. LOOP DE PROCESSAMENTO (POPULA BUFFERS)
                pagamentos.forEach((pgto) => {
                    const transacaoId = Utils.gerarUUID(); 
                    let detalhesFinais = {};
                    if (isAbastecimentoFlow) {
                        detalhesFinais = pgto.isMain ? { ...detalhesMerge, valorEvento: dadosForm.valorTotal } : { ...detalhesMerge, litros: 0, valorEvento: 0 };
                    }
                    const dataTransacao = new Date(dataBase);
                    let dataEconomicaFinal = dataEconomicaBase;
                    if (pgto.monthOffset) {
                        dataTransacao.setMonth(dataTransacao.getMonth() + pgto.monthOffset);
                        const dEco = new Date(dataEconomicaBase);
                        dEco.setMonth(dEco.getMonth() + pgto.monthOffset);
                        dataEconomicaFinal = dEco.getTime();
                    }
                    
                    const contaSelecionada = AppState.configuracoes.contasBancarias.find(c => c.id === pgto.contaId);
                    const descFinal = `${dadosForm.descricaoBase} ${pgto.suffix}`.trim();

                    const txBase = {
                        id: (contaSelecionada?.tipo === 'credito') ? Utils.gerarUUID() : transacaoId,
                        split_id: splitIdMaster,
                        data: dataTransacao.getTime(),
                        createdAt: Date.now(),
                        dataEconomica: dataEconomicaFinal, 
                        tipo: dadosForm.tipo, 
                        valor: pgto.valor,
                        descricao: descFinal,
                        categoria: dadosForm.categoria,
                        jornadaId: dadosForm.jornadaIdVal,
                        requestId: requestId,
                        detalhes: detalhesFinais,
                        contaId: (contaSelecionada?.tipo === 'credito') ? `FATURA_${contaSelecionada.id}` : pgto.contaId,
                        isCredito: contaSelecionada?.tipo === 'credito',
                        isCustoOperacional: dadosForm.isCustoOperacionalVal,
                        impactaResultado: impactaResultado
                    };

                    if (isAbastecimentoFlow) FuelAuditor.enrichTransaction(txBase, 'Motorista', true);
                    
                    // BUFFER DE TRANSA√á√ÉO
                    pendingTransactions.push(txBase);

                    // BUFFER DE ATUALIZA√á√ÉO DE CONTA (Fun√ß√£o Lazy)
                    if (contaSelecionada) {
                        pendingAccountUpdates.push(() => {
                            if (contaSelecionada.tipo === 'credito') {
                                if (dadosForm.tipo === 'saida') contaSelecionada.faturaAtual = (contaSelecionada.faturaAtual || 0) + pgto.valor;
                                else contaSelecionada.faturaAtual = (contaSelecionada.faturaAtual || 0) - pgto.valor;
                            } else {
                                if (typeof contaSelecionada.saldo !== 'number') contaSelecionada.saldo = 0;
                                if (dadosForm.tipo === 'entrada') contaSelecionada.saldo = Utils.Money.add(contaSelecionada.saldo, pgto.valor);
                                else contaSelecionada.saldo = Utils.Money.subtract(contaSelecionada.saldo, pgto.valor);
                            }
                        });
                    }
                });

                // =========================================================
                // üöÄ COMMIT AT√îMICO (TUDO OU NADA)
                // Se chegou aqui, nenhuma exce√ß√£o foi lan√ßada. O sistema est√° √≠ntegro.
                // =========================================================
                
                // A. Aplica Corre√ß√µes Estruturais (Cria√ß√£o de Carteira)
                pendingConfigUpdates.forEach(update => {
                    if (update.type === 'create_account') {
                        AppState.configuracoes.contasBancarias.push(update.payload);
                        console.info("üîß [AUTO-FIX] Carteira criada durante commit de transa√ß√£o.");
                    }
                });

                // B. Aplica Transa√ß√µes
                pendingTransactions.forEach(t => AppState.historicoTransacoes.push(t));

                // C. Aplica Saldos
                pendingAccountUpdates.forEach(updateFn => updateFn());

                // D. Limpeza e Persist√™ncia
                if (isAbastecimentoFlow) {
                    const transacaoPrincipal = pendingTransactions.find(t => t.detalhes?.litros > 0);
                    if (transacaoPrincipal) {
                        const transacaoUnificada = { ...transacaoPrincipal, valor: dadosForm.valorTotal };
                        if (!transacaoUnificada.detalhes) transacaoUnificada.detalhes = {};
                        transacaoUnificada.detalhes.km = detalhesMerge.km; 
                        BusinessLogic.sincronizarAbastecimentoComJornada(transacaoUnificada);
                    }
                    AppState.modalContext = null; AppState.tempAbastecimento = null;
                    localStorage.removeItem('temp_abastecimento_pendente');
                }

                Storage.salvarConfiguracoes();
                Storage.salvarJornadas(); 
                Storage.salvarTransacoes(); 

                UIRenderer.fecharModal(); 
                UIRenderer.render(); 
                if (EventHandlers.renderFuelHistoryList) EventHandlers.renderFuelHistoryList();

                const msgScore = (isAbastecimentoFlow && detalhesMerge.ratingSistema) ? `\n\nDesempenho: ${detalhesMerge.ratingSistema.score}` : '';
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso!', mensagem: `Transa√ß√£o salva com sucesso.${msgScore}`, type: 'success' });

            } catch (erro) {
                console.error("Rollback acionado:", erro);
                // Como n√£o tocamos no AppState, o Rollback √© impl√≠cito (apenas descartamos as vari√°veis locais)
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: erro.message, type: 'error' });
            } finally { 
                if(btn) { btn.textContent = "Salvar"; btn.disabled = false; }
            }
        },
 
 */
 
 /*
   // ============================================================================
        // MOTOR DE TRANSA√á√ÉO V36.2 (REFINED + FIX CR√âDITO + SUBCATEGORIA)
        // ============================================================================
        handleSalvarTransacaoAvulsa: () => {
            const btn = document.getElementById('btn-salvar-transacao-avulsa');
            
            try {
                // 1. CAPTURA DE DADOS (Mantido igual)
                const ancoraValor = document.getElementById('trans-valor');
                const rawConta = document.getElementById('trans-conta-id').value;
                
                const resolverContaReal = (idInput) => {
                    if (!idInput || idInput === 'carteira_motorista' || idInput === 'AUTO_ID_CARTEIRA') {
                        let carteira = AppState.configuracoes.contasBancarias.find(c => c.id === 'AUTO_ID_CARTEIRA');
                        if (!carteira) { 
                            carteira = { id: 'AUTO_ID_CARTEIRA', nome: 'Carteira (Dinheiro)', saldo: 0, tipo: 'carteira' };
                            AppState.configuracoes.contasBancarias.push(carteira);
                        }
                        return carteira.id;
                    }
                    return idInput;
                };

                // --- CAPTURA SUBCATEGORIA (NOVO) ---
                // Precisamos capturar a subcategoria que vem do Registrar Custo (geralmente injetada na descri√ß√£o ou oculta)
                // Se n√£o tiver campo expl√≠cito, tentamos extrair do texto da descri√ß√£o (ex: "Padaria (Caf√©)")
                const descInput = document.getElementById('trans-descricao').value.trim();
                let subExtraida = '';
                const matchSub = descInput.match(/\((.*?)\)/);
                if (matchSub) subExtraida = matchSub[1];
                // -----------------------------------

                const dadosForm = {
                    tipo: document.getElementById('trans-tipo').value,
                    valorTotal: Utils.parseMoeda(ancoraValor ? ancoraValor.value : '0'),
                    contaIdInput: rawConta,
                    categoria: document.getElementById('trans-categoria').value,
                    descricaoBase: descInput,
                    subcategoria: subExtraida, // Adicionado
                    dataSelecionada: document.getElementById('trans-data').value,
                    parcelas: parseInt(document.getElementById('trans-parcelas').value) || 1,
                    idRecorrente: document.getElementById('trans-recorrente-id').value || null,
                    jornadaIdVal: document.getElementById('trans-jornada-id').value || null,
                    isCustoOperacionalVal: document.getElementById('trans-is-custo-operacional').checked,
                    context: document.getElementById('trans-context')?.value,
                    isMisto: document.getElementById('chk-trans-misto') ? document.getElementById('chk-trans-misto').checked : false,
                    c1: document.getElementById('trans-conta-1') ? document.getElementById('trans-conta-1').value : '',
                    v1: Utils.parseMoeda(document.getElementById('trans-valor-1') ? document.getElementById('trans-valor-1').value : '0'),
                    c2: document.getElementById('trans-conta-2') ? document.getElementById('trans-conta-2').value : '',
                    v2: Utils.parseMoeda(document.getElementById('trans-valor-2') ? document.getElementById('trans-valor-2').value : '0')
                };

                // Regras
                if (dadosForm.categoria === 'Abastecimento') dadosForm.isCustoOperacionalVal = true;
                if (!dadosForm.descricaoBase) dadosForm.descricaoBase = dadosForm.categoria;
                if (dadosForm.valorTotal <= 0) throw new Error('Valor inv√°lido (R$ 0,00).');

                // 2. VALIDA√á√ÉO DE CONTEXTO (Mantido igual)
                let detalhesMerge = {};
                let isAbastecimentoFlow = false;
                const TTL = 15 * 60 * 1000; 

                if (AppState.modalContext === 'pagamento_abastecimento' && AppState.tempAbastecimento) {
                    detalhesMerge = { ...AppState.tempAbastecimento };
                    isAbastecimentoFlow = true;
                } 
                else if (dadosForm.categoria === 'Abastecimento') {
                    const rawDisk = localStorage.getItem('temp_abastecimento_pendente');
                    if (rawDisk) {
                        const parsed = JSON.parse(rawDisk);
                        if (parsed.litros > 0 && (Date.now() - (parsed._ts || 0) < TTL)) {
                            console.log("üíæ Motor: Resgate V√°lido do disco.");
                            detalhesMerge = parsed;
                            isAbastecimentoFlow = true;
                        } else {
                            localStorage.removeItem('temp_abastecimento_pendente'); 
                        }
                    }
                }

                if (detalhesMerge._ts) delete detalhesMerge._ts;
                if (isAbastecimentoFlow) dadosForm.categoria = 'Abastecimento';
                if (dadosForm.categoria === 'Abastecimento' && !isAbastecimentoFlow) {
                    throw new Error("‚õî DADOS EXPIRADOS.\n\nO registro de litros expirou por seguran√ßa (limitado a 15 min).\nCancele e inicie novamente pelo bot√£o 'Registrar Abastecimento'.");
                }

                // 3. TRAVA LEDGER (Mantido igual)
                if (dadosForm.tipo === 'saida') {
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    let debitoCarteira = 0;
                    
                    if (dadosForm.isMisto) {
                        if (resolverContaReal(dadosForm.c1) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v1;
                        if (resolverContaReal(dadosForm.c2) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v2;
                    } else {
                        if (resolverContaReal(dadosForm.contaIdInput) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.valorTotal;
                    }
                    
                    if (debitoCarteira > 0 && (saldoCarteira - debitoCarteira) < -0.01) {
                        throw new Error(`Saldo insuficiente na Carteira.\nDispon√≠vel: ${Utils.formatarMoeda(saldoCarteira)}\nTentativa: ${Utils.formatarMoeda(debitoCarteira)}`);
                    }
                }

                if(btn) { btn.textContent = "Salvando..."; btn.disabled = true; }

                // 4. PREPARA√á√ÉO DO COMMIT (Mantido igual)
                const pagamentos = [];
                if (dadosForm.isMisto) {
                    if (dadosForm.v1 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c1), valor: dadosForm.v1, suffix: '(Parcial 1)', isMain: true });
                    if (dadosForm.v2 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c2), valor: dadosForm.v2, suffix: '(Parcial 2)', isMain: false });
                } 
                else {
                    if (dadosForm.parcelas > 1 && dadosForm.tipo === 'saida') {
                        const valorParc = dadosForm.valorTotal / dadosForm.parcelas;
                        for(let p=1; p<=dadosForm.parcelas; p++) {
                            pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: valorParc, suffix: `(${p}/${dadosForm.parcelas})`, isMain: p===1, monthOffset: p-1 });
                        }
                    } else {
                        pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: dadosForm.valorTotal, suffix: '', isMain: true });
                    }
                }

                if (Math.abs(pagamentos.reduce((acc, p) => acc + p.valor, 0) - dadosForm.valorTotal) > 0.05) throw new Error(`Erro de soma.`);

                const requestId = Utils.gerarUUID(); 
                
                const horaValida = (
                    isAbastecimentoFlow && 
                    typeof detalhesMerge.hora === 'string' && 
                    /^([01]\d|2[0-3]):([0-5]\d)$/.test(detalhesMerge.hora)
                );
                const horaTransacao = horaValida ? detalhesMerge.hora : '12:00';
                
                const dataBase = new Date(dadosForm.dataSelecionada + 'T' + horaTransacao);
                if (isNaN(dataBase.getTime())) dataBase.setTime(new Date(dadosForm.dataSelecionada + 'T12:00:00').getTime());

                const splitIdMaster = (dadosForm.isMisto || dadosForm.parcelas > 1) ? Utils.gerarUUID() : null;
                
                // 5. EXECU√á√ÉO
                const transacoesSalvas = [];

                pagamentos.forEach((pgto) => {
                    const transacaoId = Utils.gerarUUID(); 
                    
                    let detalhesFinais = {};
                    if (isAbastecimentoFlow) {
                        detalhesFinais = pgto.isMain 
                            ? { ...detalhesMerge, valorEvento: dadosForm.valorTotal } 
                            : { ...detalhesMerge, litros: 0, valorEvento: 0 };
                    }

                    const dataTransacao = new Date(dataBase);
                    if (pgto.monthOffset) dataTransacao.setMonth(dataTransacao.getMonth() + pgto.monthOffset);
                    
                    const contaSelecionada = AppState.configuracoes.contasBancarias.find(c => c.id === pgto.contaId);
                    const descFinal = `${dadosForm.descricaoBase} ${pgto.suffix}`.trim();

                    // Objeto Base
                    const txBase = {
                        id: (contaSelecionada?.tipo === 'credito') ? Utils.gerarUUID() : transacaoId,
                        split_id: splitIdMaster,
                        data: dataTransacao.getTime(),
                        createdAt: Date.now(),
                        // FIX TIPO: Se √© cr√©dito, no extrato principal aparece como ENTRADA (d√≠vida), a n√£o ser que seja pagamento de fatura
                        // Mas espera! Se salvarmos como ENTRADA, vai ficar VERDE.
                        // O seu c√≥digo original for√ßava 'entrada' se fosse cr√©dito. Vamos mudar isso.
                        // Mantemos 'saida' para ficar vermelho, e usamos isCredito para o √≠cone.
                        tipo: dadosForm.tipo, 
                        valor: pgto.valor,
                        descricao: descFinal,
                        categoria: dadosForm.categoria,
                        jornadaId: dadosForm.jornadaIdVal,
                        requestId: requestId,
                        detalhes: detalhesFinais,
                        contaId: (contaSelecionada?.tipo === 'credito') ? `FATURA_${contaSelecionada.id}` : pgto.contaId,
                        isCredito: contaSelecionada?.tipo === 'credito',
                        isCustoOperacional: dadosForm.isCustoOperacionalVal // Salva isso no hist√≥rico global tamb√©m
                    };

                    if (isAbastecimentoFlow) FuelAuditor.enrichTransaction(txBase, 'Motorista', true);
                    
                    AppState.historicoTransacoes.push(txBase);
                    transacoesSalvas.push(txBase);

                    // REGISTRO ESPELHO (CR√âDITO APENAS)
                    if (contaSelecionada?.tipo === 'credito') {
                        const txCaixa = { 
                            ...txBase, 
                            id: transacaoId, 
                            contaId: 'LIVRO_CAIXA_DESPESA_CREDITO', 
                            tipo: 'saida', 
                            descricao: `${descFinal} (C.C.)`,
                            isCustoOperacional: dadosForm.isCustoOperacionalVal 
                        };
                        AppState.historicoTransacoes.push(txCaixa);
                    }
                    
                    // =========================================================
                    // ‚ö†Ô∏è FIX CR√çTICO: SALDO vs FATURA (AQUI ESTAVA O BUG)
                    // =========================================================
                    if (contaSelecionada) {
                        if (contaSelecionada.tipo === 'credito') {
                            // Se √© GASTO (saida), a FATURA AUMENTA
                            if (dadosForm.tipo === 'saida') {
                                contaSelecionada.faturaAtual = (contaSelecionada.faturaAtual || 0) + pgto.valor;
                            } else {
                                // Se √© Pagamento (entrada na fatura), a FATURA DIMINUI
                                contaSelecionada.faturaAtual = (contaSelecionada.faturaAtual || 0) - pgto.valor;
                            }
                        } else {
                            // Conta Normal (D√©bito/Carteira)
                            if (typeof contaSelecionada.saldo !== 'number') contaSelecionada.saldo = 0;
                            if (dadosForm.tipo === 'entrada') contaSelecionada.saldo = Utils.Money.add(contaSelecionada.saldo, pgto.valor);
                            else contaSelecionada.saldo = Utils.Money.subtract(contaSelecionada.saldo, pgto.valor);
                        }
                    }
                });

                // 6. SINCRONIA COM ROADMAP (Mantido igual)
                if (isAbastecimentoFlow) {
                    const transacaoPrincipal = transacoesSalvas.find(t => t.detalhes?.litros > 0);
                    if (transacaoPrincipal) {
                        const transacaoUnificada = { 
                            ...transacaoPrincipal, 
                            valor: dadosForm.valorTotal 
                        };
                        if (!transacaoUnificada.detalhes) transacaoUnificada.detalhes = {};
                        transacaoUnificada.detalhes.km = detalhesMerge.km; 
                        BusinessLogic.sincronizarAbastecimentoComJornada(transacaoUnificada);
                    }
                    AppState.modalContext = null;
                    AppState.tempAbastecimento = null;
                    localStorage.removeItem('temp_abastecimento_pendente');
                }

                // Sincronia de Outros Custos (Mantido e Refor√ßado)
                if ((dadosForm.jornadaIdVal || dadosForm.context === 'custo_jornada') && dadosForm.isCustoOperacionalVal === true && dadosForm.categoria !== 'Abastecimento') {
                    const jornada = AppState.jornadas[dadosForm.jornadaIdVal] || BusinessLogic.getJornadaDoDia(dataBase);
                    if (jornada) {
                        if (!jornada.custos) jornada.custos = {};
                        if (!Array.isArray(jornada.custos.outros)) jornada.custos.outros = [];
                        pagamentos.forEach(pgto => {
                            jornada.custos.outros.push({
                                id: Utils.gerarUUID(), 
                                descricao: `${dadosForm.descricaoBase} ${pgto.suffix}`.trim(), 
                                valor: pgto.valor, 
                                categoria: dadosForm.categoria,
                                subcategoria: dadosForm.subcategoria // <--- FIX: Agora salva a subcategoria
                            });
                        });
                    }
                }

                Storage.salvarConfiguracoes();
                Storage.salvarJornadas(); 
                Storage.salvarTransacoes(); 

                UIRenderer.fecharModal(); 
                UIRenderer.render(); 
                if (EventHandlers.renderFuelHistoryList) EventHandlers.renderFuelHistoryList();

                const msgScore = (isAbastecimentoFlow && detalhesMerge.ratingSistema) ? `\n\nDesempenho: ${detalhesMerge.ratingSistema.score}` : '';
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: `Transa√ß√£o salva!${msgScore}`, type: 'success' });

            } catch (erro) {
                console.error("Erro Transa√ß√£o:", erro);
                alert("‚ö†Ô∏è " + erro.message);
            } finally { 
                if(btn) { btn.textContent = "Salvar"; btn.disabled = false; }
            }
        },     */
/*         
        
// ============================================================================
        // MOTOR DE TRANSA√á√ÉO V36.1 (REFINED - SEM√ÇNTICA E VALIDA√á√ÉO ESTRITA)
        // ============================================================================
        handleSalvarTransacaoAvulsa: () => {
            const btn = document.getElementById('btn-salvar-transacao-avulsa');
            
            try {
                // 1. CAPTURA DE DADOS
                const ancoraValor = document.getElementById('trans-valor');
                const rawConta = document.getElementById('trans-conta-id').value;
                
                const resolverContaReal = (idInput) => {
                    if (!idInput || idInput === 'carteira_motorista' || idInput === 'AUTO_ID_CARTEIRA') {
                        let carteira = AppState.configuracoes.contasBancarias.find(c => c.id === 'AUTO_ID_CARTEIRA');
                        if (!carteira) { 
                            carteira = { id: 'AUTO_ID_CARTEIRA', nome: 'Carteira (Dinheiro)', saldo: 0, tipo: 'carteira' };
                            AppState.configuracoes.contasBancarias.push(carteira);
                        }
                        return carteira.id;
                    }
                    return idInput;
                };

                const dadosForm = {
                    tipo: document.getElementById('trans-tipo').value,
                    valorTotal: Utils.parseMoeda(ancoraValor ? ancoraValor.value : '0'),
                    contaIdInput: rawConta,
                    categoria: document.getElementById('trans-categoria').value,
                    descricaoBase: document.getElementById('trans-descricao').value.trim(),
                    dataSelecionada: document.getElementById('trans-data').value,
                    parcelas: parseInt(document.getElementById('trans-parcelas').value) || 1,
                    idRecorrente: document.getElementById('trans-recorrente-id').value || null,
                    jornadaIdVal: document.getElementById('trans-jornada-id').value || null,
                    isCustoOperacionalVal: document.getElementById('trans-is-custo-operacional').checked,
                    context: document.getElementById('trans-context')?.value,
                    isMisto: document.getElementById('chk-trans-misto') ? document.getElementById('chk-trans-misto').checked : false,
                    c1: document.getElementById('trans-conta-1') ? document.getElementById('trans-conta-1').value : '',
                    v1: Utils.parseMoeda(document.getElementById('trans-valor-1') ? document.getElementById('trans-valor-1').value : '0'),
                    c2: document.getElementById('trans-conta-2') ? document.getElementById('trans-conta-2').value : '',
                    v2: Utils.parseMoeda(document.getElementById('trans-valor-2') ? document.getElementById('trans-valor-2').value : '0')
                };

                // Regras
                if (dadosForm.categoria === 'Abastecimento') dadosForm.isCustoOperacionalVal = true;
                if (!dadosForm.descricaoBase) dadosForm.descricaoBase = dadosForm.categoria;
                if (dadosForm.valorTotal <= 0) throw new Error('Valor inv√°lido (R$ 0,00).');

                // =============================================================
                // 2. VALIDA√á√ÉO DE CONTEXTO (TTL 15 MIN)
                // =============================================================
                let detalhesMerge = {};
                let isAbastecimentoFlow = false;
                const TTL = 15 * 60 * 1000; 

                // A. Mem√≥ria
                if (AppState.modalContext === 'pagamento_abastecimento' && AppState.tempAbastecimento) {
                    detalhesMerge = { ...AppState.tempAbastecimento };
                    isAbastecimentoFlow = true;
                } 
                // B. Disco (Backup)
                else if (dadosForm.categoria === 'Abastecimento') {
                    const rawDisk = localStorage.getItem('temp_abastecimento_pendente');
                    if (rawDisk) {
                        const parsed = JSON.parse(rawDisk);
                        if (parsed.litros > 0 && (Date.now() - (parsed._ts || 0) < TTL)) {
                            console.log("üíæ Motor: Resgate V√°lido do disco.");
                            detalhesMerge = parsed;
                            isAbastecimentoFlow = true;
                        } else {
                            localStorage.removeItem('temp_abastecimento_pendente'); 
                        }
                    }
                }

                // C. Limpeza de Metadados Internos
                if (detalhesMerge._ts) delete detalhesMerge._ts;

                // D. Enforce Categoria
                if (isAbastecimentoFlow) dadosForm.categoria = 'Abastecimento';

                // E. Bloqueio de Seguran√ßa
                if (dadosForm.categoria === 'Abastecimento' && !isAbastecimentoFlow) {
                    throw new Error("‚õî DADOS EXPIRADOS.\n\nO registro de litros expirou por seguran√ßa (limitado a 15 min).\nCancele e inicie novamente pelo bot√£o 'Registrar Abastecimento'.");
                }

                // =============================================================
                // 3. TRAVA LEDGER (CARTEIRA)
                // =============================================================
                if (dadosForm.tipo === 'saida') {
                    const saldoCarteira = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA');
                    let debitoCarteira = 0;
                    
                    if (dadosForm.isMisto) {
                        if (resolverContaReal(dadosForm.c1) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v1;
                        if (resolverContaReal(dadosForm.c2) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.v2;
                    } else {
                        if (resolverContaReal(dadosForm.contaIdInput) === 'AUTO_ID_CARTEIRA') debitoCarteira += dadosForm.valorTotal;
                    }
                    
                    if (debitoCarteira > 0 && (saldoCarteira - debitoCarteira) < -0.01) {
                        throw new Error(`Saldo insuficiente na Carteira.\nDispon√≠vel: ${Utils.formatarMoeda(saldoCarteira)}\nTentativa: ${Utils.formatarMoeda(debitoCarteira)}`);
                    }
                }

                if(btn) { btn.textContent = "Salvando..."; btn.disabled = true; }

                // =============================================================
                // 4. PREPARA√á√ÉO DO COMMIT
                // =============================================================
                const pagamentos = [];
                // Montagem Misto
                if (dadosForm.isMisto) {
                    if (dadosForm.v1 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c1), valor: dadosForm.v1, suffix: '(Parcial 1)', isMain: true });
                    if (dadosForm.v2 > 0) pagamentos.push({ contaId: resolverContaReal(dadosForm.c2), valor: dadosForm.v2, suffix: '(Parcial 2)', isMain: false });
                } 
                // Montagem Parcelado/√önico
                else {
                    if (dadosForm.parcelas > 1 && dadosForm.tipo === 'saida') {
                        const valorParc = dadosForm.valorTotal / dadosForm.parcelas;
                        for(let p=1; p<=dadosForm.parcelas; p++) {
                            pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: valorParc, suffix: `(${p}/${dadosForm.parcelas})`, isMain: p===1, monthOffset: p-1 });
                        }
                    } else {
                        pagamentos.push({ contaId: resolverContaReal(dadosForm.contaIdInput), valor: dadosForm.valorTotal, suffix: '', isMain: true });
                    }
                }

                if (Math.abs(pagamentos.reduce((acc, p) => acc + p.valor, 0) - dadosForm.valorTotal) > 0.05) throw new Error(`Erro de soma.`);

                const requestId = Utils.gerarUUID(); 
                
                // PATCH: Valida√ß√£o de Hora Estrita (Regex HH:MM 00:00 a 23:59)
                const horaValida = (
                    isAbastecimentoFlow && 
                    typeof detalhesMerge.hora === 'string' && 
                    /^([01]\d|2[0-3]):([0-5]\d)$/.test(detalhesMerge.hora)
                );
                const horaTransacao = horaValida ? detalhesMerge.hora : '12:00';
                
                const dataBase = new Date(dadosForm.dataSelecionada + 'T' + horaTransacao);
                if (isNaN(dataBase.getTime())) dataBase.setTime(new Date(dadosForm.dataSelecionada + 'T12:00:00').getTime());

                const splitIdMaster = (dadosForm.isMisto || dadosForm.parcelas > 1) ? Utils.gerarUUID() : null;
                
                // =============================================================
                // 5. EXECU√á√ÉO
                // =============================================================
                const transacoesSalvas = [];

                pagamentos.forEach((pgto) => {
                    const transacaoId = Utils.gerarUUID(); 
                    
                    // PATCH: Sem√¢ntica 'valorEvento' (Substitui valorTotalReal)
                    // Armazena o custo total do evento f√≠sico (abastecimento) para c√°lculo de m√©dia R$/L,
                    // independente de quanto esta transa√ß√£o pagou.
                    let detalhesFinais = {};
                    if (isAbastecimentoFlow) {
                        detalhesFinais = pgto.isMain 
                            ? { ...detalhesMerge, valorEvento: dadosForm.valorTotal } 
                            : { ...detalhesMerge, litros: 0, valorEvento: 0 };
                    }

                    const dataTransacao = new Date(dataBase);
                    if (pgto.monthOffset) dataTransacao.setMonth(dataTransacao.getMonth() + pgto.monthOffset);
                    
                    const contaSelecionada = AppState.configuracoes.contasBancarias.find(c => c.id === pgto.contaId);
                    const descFinal = `${dadosForm.descricaoBase} ${pgto.suffix}`.trim();

                    // Objeto Base (Unificado)
                    const txBase = {
                        id: (contaSelecionada?.tipo === 'credito') ? Utils.gerarUUID() : transacaoId,
                        split_id: splitIdMaster,
                        data: dataTransacao.getTime(),
                        createdAt: Date.now(),
                        tipo: (contaSelecionada?.tipo === 'credito') ? 'entrada' : dadosForm.tipo,
                        valor: pgto.valor,
                        descricao: descFinal,
                        categoria: dadosForm.categoria,
                        jornadaId: dadosForm.jornadaIdVal,
                        requestId: requestId,
                        detalhes: detalhesFinais,
                        contaId: (contaSelecionada?.tipo === 'credito') ? `FATURA_${contaSelecionada.id}` : pgto.contaId
                    };

                    // Auditoria
                    if (isAbastecimentoFlow) FuelAuditor.enrichTransaction(txBase, 'Motorista', true);
                    
                    AppState.historicoTransacoes.push(txBase);
                    transacoesSalvas.push(txBase);

                    // REGISTRO ESPELHO (CR√âDITO APENAS)
                    // Nota de Arquitetura: Cart√£o de Cr√©dito gera 2 registros:
                    // 1. Entrada na Fatura (Aumenta D√≠vida)
                    // 2. Sa√≠da no Livro Caixa Virtual (Registra a Despesa/DRE no dia da compra)
                    // Ambos compartilham requestId e split_id.
                    if (contaSelecionada?.tipo === 'credito') {
                        const txCaixa = { 
                            ...txBase, 
                            id: transacaoId, 
                            contaId: 'LIVRO_CAIXA_DESPESA_CREDITO', 
                            tipo: 'saida', 
                            descricao: `${descFinal} (C.C.)`,
                            isCustoOperacional: dadosForm.isCustoOperacionalVal 
                        };
                        AppState.historicoTransacoes.push(txCaixa);
                    }
                    
                    // Atualiza Saldo Cache (exceto cr√©dito)
                    if (contaSelecionada && contaSelecionada.tipo !== 'credito') {
                        if (typeof contaSelecionada.saldo !== 'number') contaSelecionada.saldo = 0;
                        if (dadosForm.tipo === 'entrada') contaSelecionada.saldo = Utils.Money.add(contaSelecionada.saldo, pgto.valor);
                        else contaSelecionada.saldo = Utils.Money.subtract(contaSelecionada.saldo, pgto.valor);
                    }
                });

                // =============================================================
                // 6. SINCRONIA COM ROADMAP (OBJETO VIRTUAL UNIFICADO)
                // =============================================================
                if (isAbastecimentoFlow) {
                    const transacaoPrincipal = transacoesSalvas.find(t => t.detalhes?.litros > 0);
                    
                    if (transacaoPrincipal) {
                        // Sincroniza usando o valor TOTAL do evento, n√£o da transa√ß√£o parcial.
                        const transacaoUnificada = { 
                            ...transacaoPrincipal, 
                            valor: dadosForm.valorTotal 
                        };
                        // CORRE√á√ÉO V37: Garantir que o KM est√° sendo passado
                        // O BusinessLogic.sincronizar... espera receber o KM dentro do objeto
                        if (!transacaoUnificada.detalhes) transacaoUnificada.detalhes = {};
                        transacaoUnificada.detalhes.km = detalhesMerge.km; // Refor√ßo expl√≠cito
                        
                        BusinessLogic.sincronizarAbastecimentoComJornada(transacaoUnificada);
                    }
                    
                    // LIMPEZA OBRIGAT√ìRIA
                    AppState.modalContext = null;
                    AppState.tempAbastecimento = null;
                    localStorage.removeItem('temp_abastecimento_pendente');
                }

                // Sincronia de Outros Custos
                if ((dadosForm.jornadaIdVal || dadosForm.context === 'custo_jornada') && dadosForm.isCustoOperacionalVal === true && dadosForm.categoria !== 'Abastecimento') {
                    const jornada = AppState.jornadas[dadosForm.jornadaIdVal] || BusinessLogic.getJornadaDoDia(dataBase);
                    if (jornada) {
                        if (!jornada.custos) jornada.custos = {};
                        if (!Array.isArray(jornada.custos.outros)) jornada.custos.outros = [];
                        pagamentos.forEach(pgto => {
                            jornada.custos.outros.push({
                                id: Utils.gerarUUID(), descricao: `${dadosForm.descricaoBase} ${pgto.suffix}`.trim(), valor: pgto.valor, categoria: dadosForm.categoria
                            });
                        });
                    }
                }

                Storage.salvarConfiguracoes();
                Storage.salvarJornadas(); 
                Storage.salvarTransacoes(); 

                UIRenderer.fecharModal(); 
                UIRenderer.render(); 
                if (EventHandlers.renderFuelHistoryList) EventHandlers.renderFuelHistoryList();

                const msgScore = (isAbastecimentoFlow && detalhesMerge.ratingSistema) ? `\n\nDesempenho: ${detalhesMerge.ratingSistema.score}` : '';
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: `Transa√ß√£o salva!${msgScore}`, type: 'success' });

            } catch (erro) {
                console.error("Erro Transa√ß√£o:", erro);
                alert("‚ö†Ô∏è " + erro.message);
            } finally { 
                if(btn) { btn.textContent = "Salvar"; btn.disabled = false; }
            }
        },

      */

handleAdicionarHistoricoServico: () => {
            const data = UIElements.histDataInput.value;
            const km = parseInt(UIElements.histKmInput.value);
            const servico = UIElements.histServicoInput.value.trim();
            const planoId = UIElements.histPlanoMestreItemSelect.value;
            const local = UIElements.histLocalInput.value.trim();
            const valor = Utils.parseMoeda(UIElements.histValorInput.value);
            const metaId = UIElements.histPagarComCaixinhaSelect.value;
            const categoriaTecnica = UIElements.histCategoriaSelect.value;

            const elRetro = document.getElementById('histRegistroRetroativo');
            const isRetroativo = elRetro ? elRetro.checked : false;

            if (!data || !km || !servico || valor <= 0 || !categoriaTecnica) {
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Incompletos', mensagem: 'Preencha Data, KM, Categoria, Servi√ßo e Valor.' });
                return;
            }
            
            const dadosManutencao = {
                id: crypto.randomUUID(),
                data, km, categoria: categoriaTecnica, servico, planoId, local, valor, metaId
            };

            // --- L√ìGICA INTELIGENTE DE V√çNCULO ---
            if (metaId) {
                // 1. Verifica a Caixinha (Provis√£o)
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (meta) {
                    // Verifica saldo provisionado
                    if ((meta.valorAtual || 0) < valor) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Saldo Insuficiente', mensagem: `A caixinha "${meta.descricao}" s√≥ tem ${Utils.formatarMoeda(meta.valorAtual || 0)} provisionado.` });
                        return;
                    }
                    
                    // Verifica se tem Banco Vinculado
                    let contaDebitoId = meta.id; // Padr√£o: Debita da pr√≥pria caixinha (se for virtual)
                    let nomeOrigem = meta.descricao;
                    
                    if (meta.bancoId) {
                        // Se tem v√≠nculo, a transa√ß√£o real sai do BANCO
                        const banco = AppState.configuracoes.contasBancarias.find(c => c.id === meta.bancoId);
                        if (banco) {
                            contaDebitoId = banco.id;
                            nomeOrigem = banco.nome;
                            
                            // Opcional: Verificar saldo do banco real tamb√©m
                            const saldoBanco = BusinessLogic.calcularSaldoConta(banco.id);
                            if (saldoBanco < valor) {
                                UIRenderer.abrirModal('alerta', { titulo: 'Falta Dinheiro Real', mensagem: `Voc√™ tem saldo na caixinha, mas o banco vinculado (${banco.nome}) n√£o tem saldo suficiente.` });
                                return;
                            }
                        }
                    }

                    // A. Debita da Caixinha (Visual/Meta)
                    meta.valorAtual -= valor;

                    // B. Cria a Transa√ß√£o Real (Extrato)
                    if (!isRetroativo) {
                        AppState.historicoTransacoes.push({
                            id: crypto.randomUUID(),
                            data: new Date(data + "T12:00:00").getTime(),
                            contaId: contaDebitoId, // <--- AQUI: Vai para o Banco Vinculado se existir
                            tipo: 'saida',
                            valor: valor,
                            descricao: `Manut: ${servico} (Usando ${meta.descricao})`,
                            categoria: categoriaTecnica,
                            jornadaId: null 
                        });
                    }
                    
                    AppState.historicoManutencao.push(dadosManutencao);
                    BusinessLogic.finalizarRegistroManutencao(planoId, servico, km, true);
                    return;
                }
            } 
            
            // CEN√ÅRIO 2: Custo AVULSO (Sem Caixinha)
            else {
                // Abre modal de transa√ß√£o para escolher o banco manualmente
                if (isRetroativo) {
                    AppState.historicoManutencao.push(dadosManutencao);
                    BusinessLogic.finalizarRegistroManutencao(planoId, servico, km, true);
                } else {
                    UIRenderer.abrirModal('novaTransacaoAvulsa', {
                        defaultTipo: 'saida',
                        defaultValor: valor,
                        defaultCategoria: 'Manuten√ß√£o', 
                        defaultDescricao: `Manut: ${servico} [${categoriaTecnica}] ${local ? '- '+local : ''}`,
                        isCustoOperacional: true
                    });
                    
                    AppState.tempManutencao = dadosManutencao;
                    AppState.modalContext = 'pagamento_manutencao';
                    localStorage.setItem('tempManutencao_backup', JSON.stringify(dadosManutencao));
                }
            }
        },

handleListaHistoricoServicos: (e) => {
            const target = e.target;
            // Verifica se clicou no bot√£o de remover
            if (target.classList.contains('btn-remover-historico')) {
                const id = target.dataset.id;
                const itemIndex = AppState.historicoManutencao.findIndex(item => item.id === id);
                
                if (itemIndex === -1) return;
                
                const itemRemovido = AppState.historicoManutencao[itemIndex];
                
                // Mensagem inteligente baseada na fonte do pagamento
                const msg = (itemRemovido.metaId)
                    ? `Tem certeza? Esta a√ß√£o remover√° o hist√≥rico e <b>devolver√° ${Utils.formatarMoeda(itemRemovido.valor)} para a caixinha</b>.`
                    : `Tem certeza? Esta a√ß√£o remover√° o hist√≥rico e <b>estornar√° ${Utils.formatarMoeda(itemRemovido.valor)} para a Carteira</b>.`;

                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir e Estornar?',
                    mensagem: msg,
                    confirmLabel: "Sim, Excluir",
                    confirmClass: "bg-red-600 hover:bg-red-700",
                    callback: (confirmado) => {
                        if (confirmado) {
                            // 1. Remove do Hist√≥rico T√©cnico (GAM)
                            AppState.historicoManutencao.splice(itemIndex, 1);
                            
                            // 2. Remove do Financeiro (Estorno Real)
                            // O sistema procura a transa√ß√£o que tem o MESMO ID do hist√≥rico t√©cnico
                            const txIndex = AppState.historicoTransacoes.findIndex(t => t.id === id);
                            
                            if (txIndex !== -1) {
                                const transacao = AppState.historicoTransacoes[txIndex];
                                AppState.historicoTransacoes.splice(txIndex, 1);
                                
                                // Se foi pago com Caixinha, precisamos "devolver" o saldo visualmente na meta agora
                                // (Embora o calcularSaldoConta fa√ßa isso, atualizamos o objeto para a UI reagir r√°pido)
                                if (transacao.contaId && transacao.contaId.startsWith('META_')) {
                                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === transacao.contaId);
                                    if (meta) {
                                        meta.valorAtual = (meta.valorAtual || 0) + transacao.valor;
                                    }
                                }
                                SystemLog.success('Manuten√ß√£o', `Estorno financeiro realizado: ${Utils.formatarMoeda(transacao.valor)}`);
                            } else {
                                SystemLog.warn('Manuten√ß√£o', 'Transa√ß√£o financeira vinculada n√£o encontrada para estorno.');
                            }

                            // 3. Salva e Renderiza
                            Storage.salvarConfiguracoes();
                            UIRenderer.renderHistoricoServicos();
                            UIRenderer.renderGamDashboard();
                            UIRenderer.renderSaudeVeiculo();
                            UIRenderer.render(); // Atualiza saldos do topo
                            
                            UIRenderer.abrirModal('alerta', { 
                                titulo: 'Registro Exclu√≠do', 
                                mensagem: 'O servi√ßo foi removido e o valor foi estornado ao saldo.', 
                                type: 'success' 
                            });
                        }
                    }
                });
            }
        },
        
        handleAdicionarCota: () => {
            const servico = UIElements.cotaServicoInput.value.trim();
            const local = UIElements.cotaLocalInput.value.trim();
            const valor = Utils.parseMoeda(UIElements.cotaValorInput.value);
            const validade = UIElements.cotaValidadeInput.value;
            
            if (!servico || valor <= 0) {
                alert("Preencha o Servi√ßo e o Valor.");
                return;
            }
            
            AppState.cotaManutencao.push({
                id: crypto.randomUUID(), servico, local, valor, validade
            });
            
            Storage.salvarConfiguracoes();
            UIRenderer.renderCotaServicos();
            
            UIElements.cotaServicoInput.value = '';
            UIElements.cotaLocalInput.value = '';
            UIElements.cotaValorInput.value = '';
            UIElements.cotaValidadeInput.value = '';
        },
        
        handleListaCota: (e) => {
            const target = e.target;
            const id = target.dataset.id;
            
            if (target.classList.contains('btn-remover-cota')) {
                AppState.cotaManutencao = AppState.cotaManutencao.filter(item => item.id !== id);
                Storage.salvarConfiguracoes();
                UIRenderer.renderCotaServicos();
            }
            
            if (target.classList.contains('btn-aprovar-cota')) {
                const cota = AppState.cotaManutencao.find(item => item.id === id);
                if (cota) {
                    UIElements.histServicoInput.value = cota.servico;
                    UIElements.histLocalInput.value = cota.local;
                    UIElements.histValorInput.value = Utils.formatarMoedaParaInput(cota.valor);
                    UIElements.histDataInput.value = Utils.getDataInputHoje();
                    UIElements.histKmInput.focus();
                    
                    AppState.cotaManutencao = AppState.cotaManutencao.filter(item => item.id !== id);
                    Storage.salvarConfiguracoes();
                    UIRenderer.renderCotaServicos();
                }
            }
        },
        
        handleHistPlanoMestreChange: (e) => {
            const select = e.target;
            const selectedOption = select.options[select.selectedIndex];
            const planoId = selectedOption.value;
            
            if (planoId) {
                // Se selecionou um item do plano, preenche e trava os campos
                const categoria = selectedOption.dataset.categoria;
                const descricao = selectedOption.dataset.descricao;
                
                UIElements.histCategoriaSelect.value = categoria;
                UIElements.histServicoInput.value = descricao;
                
                UIElements.histCategoriaSelect.disabled = true;
                UIElements.histServicoInput.disabled = true;
            } else {
                // Se selecionou "Nenhum", limpa e destrava
                UIElements.histServicoInput.value = '';
                UIElements.histCategoriaSelect.disabled = false;
                UIElements.histServicoInput.disabled = false;
            }
            // REMOVIDO: O alert() que estava aqui atrapalhando
        },
        
handleListaMetasFinanceiras: (e) => {
            const target = e.target; 
            
            const btnExcluir = target.closest('.btn-excluir-meta');
            const btnEditar = target.closest('.btn-editar-meta');
            const btnAmortizar = target.closest('.btn-abrir-amortizacao');
            const btnExtrato = target.closest('.btn-ver-extrato-meta');
            const btnUsarSaldo = target.closest('.btn-usar-saldo-meta');
            const btnVisualizar = target.closest('.btn-visualizar-custos-mensais');
            const btnAbrirTransferencia = target.closest('.btn-abrir-transferencia');
            const btnPagarFatura = target.closest('.btn-pagar-fatura');
            const btnToggleSaldo = target.closest('.btn-toggle-saldo-carteira');

            // ... (Mantenha os blocos 1 a 6: Nova Transfer√™ncia, Pagar Fatura, Extrato, Visualizar, Toggle, Excluir iguais) ...
            // Se quiser economizar espa√ßo na resposta, estou focando no bloco 7 (Editar), que √© o problema.
            // Copie os blocos anteriores do seu c√≥digo atual se n√£o for alterar.
            
            // 1. NOVA TRANSFER√äNCIA
            if (btnAbrirTransferencia) {
                const metaId = btnAbrirTransferencia.dataset.id;
                UIRenderer.abrirModal('novaTransferencia', { defaultOrigemId: metaId });
                return;
            }
            // 2. PAGAR FATURA
            if (btnPagarFatura) {
                const metaId = btnPagarFatura.dataset.id;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (meta) {
                    const saldoDevedor = BusinessLogic.calcularSaldoConta(metaId);
                    UIRenderer.abrirModal('pagarFaturaDetalhado', { meta: meta, saldoDevedor: saldoDevedor });
                }
                return;
            }
            // 3. EXTRATO
            if (btnExtrato) {
                const metaId = btnExtrato.dataset.id;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                
                if (meta) {
                    // üö® FILTRO SEGURO: Evita o erro "undefined reading id"
                    const transacoes = AppState.historicoTransacoes.filter(t => {
                        if (!t) return false;
                        
                        // 1. Verifica ID direto (Novo Padr√£o)
                        if (t.contaId === metaId || t.contaDestino === metaId) return true;

                        // 2. Verifica Objetos Antigos (Com verifica√ß√£o de exist√™ncia)
                        if (t.tipo === 'transferencia') {
                            // S√≥ acessa .id se o objeto existir
                            if (t.origem && typeof t.origem === 'object' && t.origem.id === metaId) return true;
                            if (t.destino && typeof t.destino === 'object' && t.destino.id === metaId) return true;
                        }
                        return false;
                    });

                    // Verifica se √© meta de parcelamento ou comum para pegar o saldo correto
                    const saldoFinal = meta.tipo === 'parcelamento' ? (meta.valorProvisionado || 0) : (meta.valorAtual || 0);

                    if (typeof Modals !== 'undefined') {
                        Modals.abrirModal('extratoConta', { contaId: metaId, contaNome: meta.descricao, transacoes: transacoes, saldoFinal: saldoFinal });
                    } else {
                        UIRenderer.abrirModal('extratoConta', { contaId: metaId, contaNome: meta.descricao, transacoes: transacoes, saldoFinal: saldoFinal });
                    }
                }
                return;
            }
            // 4. VISUALIZAR CUSTOS
            if (btnVisualizar) {
                const metaId = btnVisualizar.dataset.id;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (meta) {
                    UIRenderer.abrirModal('visualizarCustosMensais', { meta: meta });
                    setTimeout(() => EventHandlers.handleRenderModalCustos(new Date()), 0);
                }
                return;
            }
            // 5. TOGGLE SALDO
            if (btnToggleSaldo) {
                AppState.visualSettings.isSaldoCarteiraOculto = !AppState.visualSettings.isSaldoCarteiraOculto;
                Storage.salvarVisualSettings();
                UIRenderer.render();
                return;
            }
            // 6. EXCLUIR
// 6. EXCLUIR META (CORRIGIDO AQUI)
            if (btnExcluir) {
                const metaId = btnExcluir.dataset.id;
                if (metaId.startsWith('AUTO_ID_') || metaId === 'META_CUSTOS_MENSAIS') {
                     UIRenderer.abrirModal('alerta', { titulo: 'A√ß√£o Inv√°lida', mensagem: 'Esta caixinha √© autom√°tica e n√£o pode ser exclu√≠da.' });
                     return; 
                }

                const isConcluida = btnExcluir.closest('ul') === UIElements.listaMetasConcluidas || btnExcluir.closest('ul') === UIElements.listaMetasManutencaoConcluidas;
                
                // >>> A CORRE√á√ÉO EST√Å NESTA FUN√á√ÉO <<<
                const deleteMeta = (confirmado) => {
                    if (!confirmado) return; // SE N√ÉO CONFIRMOU, PARA TUDO!

                    AppState.configuracoes.metasFinanceiras = AppState.configuracoes.metasFinanceiras.filter(m => m.id !== metaId);
                    
                    // Remove v√≠nculos no Plano de Manuten√ß√£o
                    AppState.configuracoes.planoManutencao.forEach(item => { 
                        if (item.metaId === metaId) item.metaId = ""; 
                    });
                    
                    Storage.salvarConfiguracoes();
                    UIRenderer.render();
                    UIRenderer.renderPlanoMestre();
                };
                // -------------------------------------
                const titulo = isConcluida ? 'Excluir Meta Hist√≥rica?' : 'Excluir Meta Ativa?';
                const msg = isConcluida ? 'Esta a√ß√£o remover√° o registro hist√≥rico. Deseja continuar?' : 'Tem certeza que deseja excluir esta meta?';
                UIRenderer.abrirModal('confirmacao', { titulo: titulo, mensagem: msg, callback: deleteMeta });
                return;
            }

            // --- 7. EDITAR / AJUSTAR (CORRE√á√ÉO AQUI) ---
            if (btnEditar) {
                const metaId = btnEditar.dataset.id;
                
                // A) AJUSTE DE SALDO (CARTEIRA)
                if (metaId === 'AUTO_ID_CARTEIRA') {
                    const metaCarteira = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                    const saldoAtual = BusinessLogic.calcularSaldoConta(metaId);
                    UIRenderer.abrirModal('ajusteSaldo', {
                        contaId: metaId,
                        nomeConta: metaCarteira ? metaCarteira.descricao : 'Carteira',
                        saldoAtual: saldoAtual
                    });
                    return;
                }
                
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (!meta) return;

                // B) VISUALIZAR DETALHES (MANUTEN√á√ÉO AUTO)
                if (meta.tipo === 'poupanca_km' || meta.descricao.includes('(Auto)')) {
                     UIRenderer.abrirModal('visualizarMetaManutencao', { meta: meta });
                     return;
                }

                // C) EDI√á√ÉO NORMAL (D√≠vidas e Poupan√ßas Comuns)
                metaEmEdicaoId = metaId;
                
                // 1. Preenche Dados B√°sicos
                UIElements.metaDescricaoInput.value = meta.descricao;
                UIElements.metaTipoSelect.value = meta.tipo;
                UIElements.metaIncluirCustoDiarioCheckbox.checked = (meta.isObrigatorio === true);
                UIElements.metaBancoVinculado.value = meta.bancoId || "";

                // 2. Configura Interface Baseada no Tipo
                // For√ßamos a renderiza√ß√£o AGORA para garantir que os campos existam e estejam vis√≠veis
                UIRenderer.renderMetasFinanceiras(); 

                // 3. Preenche Dados Espec√≠ficos
                if (meta.tipo === 'poupanca') {
                    UIElements.metaValorTotalInput.value = Utils.formatarMoedaParaInput(meta.valorAtual);
                    UIElements.metaValorObjetivoInput.value = Utils.formatarMoedaParaInput(meta.valorTotal);
                    UIElements.metaPrazoMesesInput.value = meta.prazoMeses;
                    UIElements.metaTaxaJurosInput.value = Utils.formatarMoedaParaInput(meta.taxaJuros);
                    UIElements.metaContribuicaoMensalInput.value = Utils.formatarMoedaParaInput(meta.contribuicaoMensal);
                
                } else if (meta.tipo === 'parcelamento') {
                    // D√≠vida: Valor Total √© o valor original ou total do contrato
                    // (Se tiver financiamento, o valorFinanciado √© mais preciso, preenchemos abaixo)
                    UIElements.metaValorTotalInput.value = Utils.formatarMoedaParaInput(meta.valorTotal);
                    UIElements.metaDataVencimentoInput.value = meta.dataVencimento; // Pr√≥ximo vencimento
                    
                    // Configura√ß√µes de Juros
                    UIElements.metaJurosCheckbox.checked = meta.temJuros || false;
                    // For√ßa atualiza√ß√£o visual dos campos de juros
                    UIRenderer.renderMetasFinanceiras(); 

                    if (meta.temJuros) {
                        UIElements.metaTipoDividaSelect.value = meta.tipoDivida || 'financiamento';
                        // For√ßa atualiza√ß√£o visual do tipo de d√≠vida
                        UIRenderer.renderMetasFinanceiras();

                        if (meta.tipoDivida === 'financiamento' || meta.tipoDivida === 'emprestimo') {
                            if (meta.financiamento) {
                                // Preenchimento detalhado
                                const elFinanciado = document.getElementById('metaValorFinanciadoInput');
                                if (elFinanciado) elFinanciado.value = Utils.formatarMoedaParaInput(meta.financiamento.valorFinanciado);
                                
                                const elTaxaAnual = document.getElementById('metaTaxaJurosAnualInput');
                                if (elTaxaAnual) elTaxaAnual.value = Utils.formatarMoedaParaInput(meta.financiamento.taxaJurosAnual);
                                
                                const elParcelas = document.getElementById('metaTotalParcelasInput');
                                if (elParcelas) elParcelas.value = meta.financiamento.totalParcelas;
                                
                                const elValorParcela = document.getElementById('metaValorParcelaInput');
                                if (elValorParcela) elValorParcela.value = Utils.formatarMoedaParaInput(meta.financiamento.valorParcela);
                                
                                const elDataInicio = document.getElementById('metaDataInicioFinanciamentoInput');
                                if (elDataInicio) elDataInicio.value = meta.financiamento.dataInicioFinanciamento;
                                
                                const elMetodo = document.getElementById('metaMetodoAmortizacaoInput');
                                if (elMetodo) elMetodo.value = meta.financiamento.metodoAmortizacao;
                            }
                        } else if (meta.tipoDivida === 'consorcio') {
                            if (meta.consorcio) {
                                UIElements.metaValorObjetivoConsorcioInput.value = Utils.formatarMoedaParaInput(meta.consorcio.valorObjetivo);
                            }
                            UIElements.metaValorTotalInput.value = Utils.formatarMoedaParaInput(meta.consorcio.valorObjetivo);
                        }
                    }
                } else if (meta.tipo === 'poupanca_km') {
                    UIElements.metaValorTotalInput.value = Utils.formatarMoedaParaInput(meta.valorAtual); 
                    UIElements.metaValorPorKmInput.value = Utils.formatarMoedaPorKmParaInput(meta.valorPorKm);
                    UIElements.metaValorObjetivoInputKm.value = Utils.formatarMoedaParaInput(meta.valorTotal);
                    UIElements.metaDataVencimentoInputKm.value = meta.dataVencimento || '';
                    UIElements.metaTaxaJurosInputKm.value = Utils.formatarMoedaParaInput(meta.taxaJuros);
                }
                
                // Foco e Scroll
                UIElements.metaDescricaoInput.focus();
                
                // Opcional: Scroll suave at√© o formul√°rio
                const formContainer = document.getElementById('metaDescricaoInput');
                if (formContainer) formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                return;
            }

            // 8. AMORTIZAR (Mantido)
            if (btnAmortizar) {
                const metaId = btnAmortizar.dataset.id;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (meta) {
                    UIRenderer.abrirModal('amortizacaoFinanciamento', { meta: meta });
                }
                return;
            }
            // 9. USAR SALDO (Mantido)
            if (btnUsarSaldo) {
                const metaId = btnUsarSaldo.dataset.id;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (!meta) return;
                if (meta.id === 'META_CUSTOS_MENSAIS') {
                    UIRenderer.abrirModal('pagarCustoMensal', { meta: meta });
                } else {
                    UIRenderer.abrirModal('novaTransacaoAvulsa', {
                        defaultTipo: 'saida',
                        defaultValor: 0,
                        defaultContaId: metaId,
                        defaultCategoria: 'Metas Financeiras',
                        defaultDescricao: `Uso de saldo: ${meta.descricao}`,
                        isCustoOperacional: false
                    });
                    setTimeout(() => {
                        const selectConta = document.getElementById('trans-conta-id');
                        if (selectConta) selectConta.value = metaId;
                    }, 100);
                }
                return; 
            }
        },
    
  // --- IN√çCIO: SUPER-PASSO G (CORRIGIDO E OTIMIZADO) ---
        handleAdicionarMeta: () => {
            // 1. Extra√ß√£o Segura de Todos os Elementos Necess√°rios
            const { 
                metaDescricaoInput, metaTipoSelect, metaBancoVinculado,
                metaValorTotalInput, metaValorObjetivoInput,
                metaDataVencimentoInput, metaPrazoMesesInput, 
                metaTaxaJurosInput, metaContribuicaoMensalInput, metaIncluirCustoDiarioCheckbox,
                metaJurosCheckbox, metaTipoDividaSelect, metaValorObjetivoConsorcioInput,
                // NOVOS CAMPOS QUE FALTAVAM NA DESESTRUTURA√á√ÉO:
                metaValorPorKmInput, metaValorObjetivoInputKm, metaDataVencimentoInputKm, metaTaxaJurosInputKm
            } = UIElements;

            // Helper para pegar valor de input com seguran√ßa (evita erro se elemento n√£o existir)
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };

            const descricao = metaDescricaoInput.value.trim();
            const tipo = metaTipoSelect.value;
            const bancoId = metaBancoVinculado.value;
            
            const valorInicial = Utils.parseMoeda(metaValorTotalInput.value);
            const valorObjetivo = Utils.parseMoeda(metaValorObjetivoInput.value);

            const dataVencimento = metaDataVencimentoInput.value || null;
            const prazoMeses = parseInt(metaPrazoMesesInput.value) || 0;
            const taxaJuros = Utils.parseMoeda(metaTaxaJurosInput.value);
            const contribuicaoMensal = Utils.parseMoeda(metaContribuicaoMensalInput.value);
            const isObrigatorio = metaIncluirCustoDiarioCheckbox.checked;
            const incluirComoCustoDiario = isObrigatorio ? true : false;

            // Valida√ß√µes B√°sicas
            if (!descricao) { alert("A descri√ß√£o √© obrigat√≥ria."); return; }
            if (tipo === 'parcelamento' && !(metaJurosCheckbox.checked && metaTipoDividaSelect.value === 'consorcio') && valorInicial <= 0) { alert("D√≠vidas devem ter um Valor Total."); return; }
            if (tipo === 'parcelamento' && !dataVencimento && !metaJurosCheckbox.checked) { alert("D√≠vidas (sem juros) devem ter uma Data de Vencimento."); return; }
            
            // Valida√ß√£o Espec√≠fica de Financiamento
            if (tipo === 'parcelamento' && metaJurosCheckbox.checked && metaTipoDividaSelect.value !== 'consorcio') {
                if (!getVal('metaDataInicioFinanciamentoInput')) { alert("Financiamentos devem ter uma Data da 1¬™ Parcela."); return; }
            }

            const novaMeta = {
                id: crypto.randomUUID(),
                descricao, tipo,
                bancoId: bancoId,
                valorTotal: 0, valorAtual: 0, dataVencimento: null, prazoMeses: 0,
                contribuicaoMensal: 0, taxaJuros: 0, valorPorKm: 0,
                incluirComoCustoDiario: incluirComoCustoDiario,
                isObrigatorio: isObrigatorio, 
                financiamento: null, temJuros: false, tipoDivida: null, consorcio: null
            };

            // L√ìGICA DE PREENCHIMENTO POR TIPO
            if (tipo === 'poupanca') {
                novaMeta.valorTotal = valorObjetivo;
                novaMeta.prazoMeses = prazoMeses;
                novaMeta.contribuicaoMensal = contribuicaoMensal;
                novaMeta.taxaJuros = taxaJuros;

            } else if (tipo === 'parcelamento') {
                novaMeta.valorTotal = valorInicial;
                novaMeta.dataVencimento = dataVencimento;
                
                novaMeta.temJuros = metaJurosCheckbox.checked;
                if (novaMeta.temJuros) {
                    novaMeta.tipoDivida = metaTipoDividaSelect.value;
                    
                    // --- CORRE√á√ÉO AQUI: FINANCIAMENTO ---
                    if (novaMeta.tipoDivida === 'financiamento' || novaMeta.tipoDivida === 'emprestimo') {
                        // L√™ os inputs pelo ID para garantir (j√° que n√£o est√£o no UIElements padr√£o)
                        const valFinanciado = Utils.parseMoeda(getVal('metaValorFinanciadoInput'));
                        const taxaAnual = Utils.parseMoeda(getVal('metaTaxaJurosAnualInput'));
                        // Tenta ler 'TotalParcelas' OU 'NumeroParcelas' (para evitar erro de nome de ID)
                        const totalParcelas = parseInt(getVal('metaTotalParcelasInput') || getVal('metaNumeroParcelasInput')) || 0;
                        const valorParcela = Utils.parseMoeda(getVal('metaValorParcelaInput'));
                        
                        novaMeta.financiamento = {
                            valorFinanciado: valFinanciado,
                            taxaJurosAnual: taxaAnual,
                            totalParcelas: totalParcelas,
                            valorParcela: valorParcela,
                            dataInicioFinanciamento: getVal('metaDataInicioFinanciamentoInput'),
                            metodoAmortizacao: getVal('metaMetodoAmortizacaoInput') || 'sac', // Padr√£o SAC se vazio
                            totalAmortizado: 0,
                            totalJurosPagos: 0,
                            totalEconomizado: 0,
                            historicoAmortizacao: []
                        };
                        
                        // Atualiza Valor Total com base no contrato
                        if (totalParcelas > 0 && valorParcela > 0) novaMeta.valorTotal = totalParcelas * valorParcela;
                        else if (valFinanciado > 0) novaMeta.valorTotal = valFinanciado;

                    } else if (novaMeta.tipoDivida === 'consorcio') {
                        novaMeta.consorcio = {
                            valorObjetivo: Utils.parseMoeda(metaValorObjetivoConsorcioInput.value)
                        };
                        novaMeta.valorTotal = Utils.parseMoeda(metaValorObjetivoConsorcioInput.value);
                    }
                }

            } else if (tipo === 'poupanca_km') { 
                // --- CORRE√á√ÉO AQUI: POUPAN√áA KM ---
                // Agora usa os campos que extra√≠mos ou busca direto se falhar
                novaMeta.valorPorKm = metaValorPorKmInput ? Utils.parseMoeda(metaValorPorKmInput.value) : Utils.parseMoeda(getVal('metaValorPorKmInput'));
                novaMeta.valorTotal = metaValorObjetivoInputKm ? Utils.parseMoeda(metaValorObjetivoInputKm.value) : Utils.parseMoeda(getVal('metaValorObjetivoInputKm'));
                novaMeta.dataVencimento = metaDataVencimentoInputKm ? metaDataVencimentoInputKm.value : getVal('metaDataVencimentoInputKm');
                novaMeta.taxaJuros = metaTaxaJurosInputKm ? Utils.parseMoeda(metaTaxaJurosInputKm.value) : Utils.parseMoeda(getVal('metaTaxaJurosInputKm'));
            }
            
            // Se o usu√°rio digitou um "Valor Inicial", cria uma transa√ß√£o de entrada
            if (valorInicial > 0 && (tipo === 'poupanca' || tipo === 'poupanca_km')) {
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: Date.now(),
                    contaId: novaMeta.id,
                    tipo: 'entrada',
                    valor: valorInicial,
                    descricao: 'Dep√≥sito inicial da caixinha'
                });
            }

            AppState.configuracoes.metasFinanceiras.push(novaMeta);
            
            // Feedback Visual
            if(window.SystemLog) SystemLog.success('MetaFinanceira', `Nova caixinha criada: ${novaMeta.descricao}`);
            else console.log(`Nova caixinha criada: ${novaMeta.descricao}`);

            // L√≥gica Especial Cons√≥rcio (Cria Lance Autom√°tico)
            if (novaMeta.tipo === 'parcelamento' && novaMeta.tipoDivida === 'consorcio' && novaMeta.consorcio.valorObjetivo > 0) {
                const novaMetaLance = {
                    id: crypto.randomUUID(),
                    descricao: `Lance: ${novaMeta.descricao}`,
                    tipo: 'poupanca_km',
                    bancoId: null,
                    valorTotal: novaMeta.consorcio.valorObjetivo * 0.5, // Sugest√£o: 50% para lance
                    valorAtual: 0,
                    dataVencimento: novaMeta.dataVencimento,
                    prazoMeses: 0, contribuicaoMensal: 0, taxaJuros: 0, valorPorKm: 0,
                    incluirComoCustoDiario: true,
                    financiamento: null, temJuros: false, tipoDivida: null, consorcio: null
                };
                AppState.configuracoes.metasFinanceiras.push(novaMetaLance);
            }

            EventHandlers.handleCancelarEdicaoMeta();
            Storage.salvarConfiguracoes();
            UIRenderer.render(); // Renderiza tudo
        },  
/*     
    
    // --- IN√çCIO: SUPER-PASSO G (MODIFICADO) ---
        handleAdicionarMeta: () => {
            const { 
                metaDescricaoInput, metaTipoSelect, metaBancoVinculado,
                metaValorTotalInput, metaValorObjetivoInput,
                metaDataVencimentoInput, metaPrazoMesesInput, 
                metaTaxaJurosInput, metaContribuicaoMensalInput, metaIncluirCustoDiarioCheckbox,
                metaJurosCheckbox, metaTipoDividaSelect, metaValorObjetivoConsorcioInput
            } = UIElements;

            const descricao = metaDescricaoInput.value.trim();
            const tipo = metaTipoSelect.value;
            const bancoId = metaBancoVinculado.value;
            
            const valorInicial = Utils.parseMoeda(metaValorTotalInput.value);
            const valorObjetivo = Utils.parseMoeda(metaValorObjetivoInput.value);

            const dataVencimento = metaDataVencimentoInput.value || null;
            const prazoMeses = parseInt(metaPrazoMesesInput.value) || 0;
            const taxaJuros = Utils.parseMoeda(metaTaxaJurosInput.value);
            const contribuicaoMensal = Utils.parseMoeda(metaContribuicaoMensalInput.value);
			const isObrigatorio = metaIncluirCustoDiarioCheckbox.checked;
            // Se for obrigat√≥rio, for√ßamos 'incluir' como true
            const incluirComoCustoDiario = isObrigatorio ? true : false;

            if (!descricao) { alert("A descri√ß√£o √© obrigat√≥ria."); return; }
            if (tipo === 'parcelamento' && !(UIElements.metaJurosCheckbox.checked && UIElements.metaTipoDividaSelect.value === 'consorcio') && valorInicial <= 0) { alert("D√≠vidas devem ter um Valor Total."); return; }
            if (tipo === 'parcelamento' && !dataVencimento && !UIElements.metaJurosCheckbox.checked) { alert("D√≠vidas (sem juros) devem ter uma Data de Vencimento."); return; }
            if (tipo === 'parcelamento' && UIElements.metaJurosCheckbox.checked && !document.getElementById('metaDataInicioFinanciamentoInput').value && UIElements.metaTipoDividaSelect.value !== 'consorcio') { alert("Financiamentos devem ter uma Data da 1¬™ Parcela."); return; }

            // --- ETAPA 5: REMOVIDA A VALIDA√á√ÉO DE BANCO OBRIGAT√ìRIO ---
            // if ((tipo === 'poupanca' || tipo === 'poupanca_km') && !bancoId) {
            //    UIRenderer.abrirModal('alerta', { titulo: 'Banco Necess√°rio', mensagem: 'Caixinhas do tipo "Poupan√ßa" e "R$/KM" devem ser vinculadas a uma Conta/Banco real.' });
            //    return;
            // }

            const novaMeta = {
                id: crypto.randomUUID(),
                descricao, tipo,
                bancoId: bancoId,
                valorTotal: 0, valorAtual: 0, dataVencimento: null, prazoMeses: 0,
                contribuicaoMensal: 0, taxaJuros: 0, valorPorKm: 0,
				incluirComoCustoDiario: incluirComoCustoDiario,
                isObrigatorio: isObrigatorio, 
                incluirComoCustoDiario: incluirComoCustoDiario,
                financiamento: null, temJuros: false, tipoDivida: null, consorcio: null
            };

            if (tipo === 'poupanca') {
                novaMeta.valorTotal = valorObjetivo;
                novaMeta.prazoMeses = prazoMeses;
                novaMeta.contribuicaoMensal = contribuicaoMensal;
                novaMeta.taxaJuros = taxaJuros;

            } else if (tipo === 'parcelamento') {
                novaMeta.valorTotal = valorInicial;
                novaMeta.dataVencimento = dataVencimento;
                
                novaMeta.temJuros = metaJurosCheckbox.checked;
                if (novaMeta.temJuros) {
                    novaMeta.tipoDivida = metaTipoDividaSelect.value;
                    if (novaMeta.tipoDivida === 'financiamento' || novaMeta.tipoDivida === 'emprestimo') {
                        novaMeta.financiamento = {
                            valorFinanciado: Utils.parseMoeda(document.getElementById('metaValorFinanciadoInput').value),
                            taxaJurosAnual: Utils.parseMoeda(document.getElementById('metaTaxaJurosAnualInput').value),
                            totalParcelas: parseInt(document.getElementById('metaTotalParcelasInput').value) || 0,
                            valorParcela: Utils.parseMoeda(document.getElementById('metaValorParcelaInput').value),
                            dataInicioFinanciamento: document.getElementById('metaDataInicioFinanciamentoInput').value,
                            metodoAmortizacao: document.getElementById('metaMetodoAmortizacaoInput').value,
                            totalAmortizado: 0,
                            totalJurosEconomizados: 0,
                        };
                    } else if (novaMeta.tipoDivida === 'consorcio') {
                        novaMeta.consorcio = {
                            valorObjetivo: Utils.parseMoeda(metaValorObjetivoConsorcioInput.value)
                        };
                        novaMeta.valorTotal = Utils.parseMoeda(metaValorObjetivoConsorcioInput.value);
                    }
                }

            } else if (tipo === 'poupanca_km') { 
                novaMeta.valorPorKm = Utils.parseMoeda(UIElements.metaValorPorKmInput.value);
                novaMeta.valorTotal = Utils.parseMoeda(UIElements.metaValorObjetivoInputKm.value);
                novaMeta.dataVencimento = UIElements.metaDataVencimentoInputKm.value || null;
                novaMeta.taxaJuros = Utils.parseMoeda(UIElements.metaTaxaJurosInputKm.value);
            }
            
            // Se o usu√°rio digitou um "Valor Inicial", cria uma transa√ß√£o de entrada
            if (valorInicial > 0 && (tipo === 'poupanca' || tipo === 'poupanca_km')) {
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: Date.now(),
                    contaId: novaMeta.id,
                    tipo: 'entrada',
                    valor: valorInicial,
                    descricao: 'Dep√≥sito inicial da caixinha'
                });
            }

            AppState.configuracoes.metasFinanceiras.push(novaMeta);
			SystemLog.success('MetaFinanceira', `Nova caixinha criada: ${novaMeta.descricao}`);
			if (novaMeta.tipo === 'parcelamento' && novaMeta.tipoDivida === 'consorcio' && novaMeta.consorcio.valorObjetivo > 0) {
                const novaMetaLance = {
                    id: crypto.randomUUID(),
                    descricao: `Lance: ${novaMeta.descricao}`,
                    tipo: 'poupanca_km',
                    bancoId: null, // Lances podem ser virtuais ou vinculadosDepois
                    valorTotal: novaMeta.consorcio.valorObjetivo,
                    valorAtual: 0,
                    dataVencimento: novaMeta.dataVencimento,
                    prazoMeses: 0, contribuicaoMensal: 0, taxaJuros: 0, valorPorKm: 0,
                    incluirComoCustoDiario: true,
                    financiamento: null, temJuros: false, tipoDivida: null, consorcio: null
                };
                AppState.configuracoes.metasFinanceiras.push(novaMetaLance);
            }

            EventHandlers.handleCancelarEdicaoMeta();
            Storage.salvarConfiguracoes();
            UIRenderer.render();
        },
     


      */
handleSalvarEdicaoMeta: () => {
            if (!metaEmEdicaoId) return;

            // 1. Encontra a meta original
            const metaIndex = AppState.configuracoes.metasFinanceiras.findIndex(m => m.id === metaEmEdicaoId);
            if (metaIndex === -1) return;
            const meta = AppState.configuracoes.metasFinanceiras[metaIndex];

            // --- HELPER DE SEGURAN√áA (O Segredo) ---
            // Tenta pegar do UIElements. Se for null, tenta buscar pelo ID. Se falhar, retorna vazio.
            const getVal = (uiEl, idFallback) => {
                if (uiEl && uiEl.value !== undefined) return uiEl.value;
                const el = document.getElementById(idFallback);
                return el ? el.value : '';
            };

            // 2. Coleta dados b√°sicos
            const descricao = getVal(UIElements.metaDescricaoInput, 'metaDescricaoInput').trim();
            const tipo = getVal(UIElements.metaTipoSelect, 'metaTipoSelect');
            const bancoId = getVal(UIElements.metaBancoVinculado, 'metaBancoVinculado');
            
            if (!descricao) { alert('A descri√ß√£o √© obrigat√≥ria.'); return; }
            
            // 3. Atualiza Objeto
            meta.descricao = descricao;
            meta.tipo = tipo;
            meta.bancoId = bancoId;
            meta.isObrigatorio = UIElements.metaIncluirCustoDiarioCheckbox ? UIElements.metaIncluirCustoDiarioCheckbox.checked : false;
            meta.incluirComoCustoDiario = meta.isObrigatorio;

            // 4. L√ìGICA POR TIPO (Blindada)
            if (tipo === 'poupanca_km') {
                meta.valorPorKm = Utils.parseMoeda(getVal(UIElements.metaValorPorKmInput, 'metaValorPorKmInput'));
                meta.valorTotal = Utils.parseMoeda(getVal(UIElements.metaValorObjetivoInputKm, 'metaValorObjetivoInputKm'));
                meta.dataVencimento = getVal(UIElements.metaDataVencimentoInputKm, 'metaDataVencimentoInputKm');
                meta.taxaJuros = Utils.parseMoeda(getVal(UIElements.metaTaxaJurosInputKm, 'metaTaxaJurosInputKm'));
                meta.financiamento = null; 
            
            } else if (tipo === 'poupanca') {
                meta.valorTotal = Utils.parseMoeda(getVal(UIElements.metaValorObjetivoInput, 'metaValorObjetivoInput'));
                meta.prazoMeses = parseInt(getVal(UIElements.metaPrazoMesesInput, 'metaPrazoMesesInput')) || 0;
                meta.contribuicaoMensal = Utils.parseMoeda(getVal(UIElements.metaContribuicaoMensalInput, 'metaContribuicaoMensalInput'));
                meta.taxaJuros = Utils.parseMoeda(getVal(UIElements.metaTaxaJurosInput, 'metaTaxaJurosInput'));
                meta.financiamento = null;

            } else if (tipo === 'parcelamento') {
                meta.valorTotal = Utils.parseMoeda(getVal(UIElements.metaValorTotalInput, 'metaValorTotalInput'));
                meta.dataVencimento = getVal(UIElements.metaDataVencimentoInput, 'metaDataVencimentoInput');
                
                const chkJuros = document.getElementById('metaJurosCheckbox');
                meta.temJuros = chkJuros ? chkJuros.checked : false;
                
                if (meta.temJuros) {
                    meta.tipoDivida = getVal(UIElements.metaTipoDividaSelect, 'metaTipoDividaSelect');
                    
                    if (meta.tipoDivida === 'financiamento' || meta.tipoDivida === 'emprestimo') {
                        if (!meta.financiamento) meta.financiamento = {};
                        
                        // Tenta achar o input de parcelas (Total vs Numero)
                        let parcInput = getVal(UIElements.metaTotalParcelasInput, 'metaTotalParcelasInput');
                        if (!parcInput) parcInput = getVal(null, 'metaNumeroParcelasInput'); // Tenta o outro nome

                        meta.financiamento.valorFinanciado = Utils.parseMoeda(getVal(UIElements.metaValorFinanciadoInput, 'metaValorFinanciadoInput'));
                        meta.financiamento.totalParcelas = parseInt(parcInput) || 0;
                        meta.financiamento.valorParcela = Utils.parseMoeda(getVal(UIElements.metaValorParcelaInput, 'metaValorParcelaInput'));
                        meta.financiamento.taxaJurosAnual = Utils.parseMoeda(getVal(UIElements.metaTaxaJurosAnualInput, 'metaTaxaJurosAnualInput'));
                        meta.financiamento.metodoAmortizacao = getVal(UIElements.metaMetodoAmortizacaoInput, 'metaMetodoAmortizacaoInput');
                        meta.financiamento.dataInicioFinanciamento = getVal(UIElements.metaDataInicioFinanciamentoInput, 'metaDataInicioFinanciamentoInput');

                        // Recalcula total visual
                        if (meta.financiamento.totalParcelas > 0 && meta.financiamento.valorParcela > 0) {
                            meta.valorTotal = meta.financiamento.totalParcelas * meta.financiamento.valorParcela;
                        }
                    }
                }
            }

            // 5. Salva e Renderiza
            Storage.salvarConfiguracoes();
            UIRenderer.render(); 
            
            alert("‚úÖ Edi√ß√£o salva com sucesso!");
            EventHandlers.handleCancelarEdicaoMeta();
        },  
/*       
      
handleSalvarEdicaoMeta: () => {
            if (!metaEmEdicaoId) return;
            const metaIndex = AppState.configuracoes.metasFinanceiras.findIndex(m => m.id === metaEmEdicaoId);
            if (metaIndex === -1) return;
            const meta = AppState.configuracoes.metasFinanceiras[metaIndex];
            
            // --- CORRE√á√ÉO CR√çTICA: CAPTURA DADOS ANTIGOS PARA PRESERVAR ---
            const oldFinanciamento = meta.financiamento || {};
            // -------------------------------------------------------------

            const descricao = UIElements.metaDescricaoInput.value.trim();
            const tipo = UIElements.metaTipoSelect.value;
            const bancoId = UIElements.metaBancoVinculado.value;
            const valorInicial = Utils.parseMoeda(UIElements.metaValorTotalInput.value);
            const valorObjetivo = Utils.parseMoeda(UIElements.metaValorObjetivoInput.value);
            const dataVencimento = UIElements.metaDataVencimentoInput.value || null;
            
            if (!descricao) { 
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'A descri√ß√£o √© obrigat√≥ria.' });
                return; 
            }
            
            meta.descricao = descricao;
            meta.tipo = tipo;
            meta.bancoId = bancoId;
            meta.isObrigatorio = UIElements.metaIncluirCustoDiarioCheckbox.checked;
            meta.incluirComoCustoDiario = meta.isObrigatorio ? true : false;

            // Reset condicional: Se mudou de tipo, limpa. Se n√£o, mant√©m.
            // Para seguran√ßa, vamos sobrescrever apenas o necess√°rio.

            if (tipo === 'poupanca') {
                meta.valorTotal = valorObjetivo;
                meta.valorAtual = valorInicial;
                meta.prazoMeses = parseInt(UIElements.metaPrazoMesesInput.value) || 0;
                meta.taxaJuros = Utils.parseMoeda(UIElements.metaTaxaJurosInput.value);
                meta.contribuicaoMensal = Utils.parseMoeda(UIElements.metaContribuicaoMensalInput.value);
                meta.dataVencimento = null;
                meta.financiamento = null; // Limpa se virou poupan√ßa
            
            } else if (tipo === 'poupanca_km') { 
                meta.valorAtual = valorInicial;
                meta.valorPorKm = Utils.parseMoeda(UIElements.metaValorPorKmInput.value);
                meta.valorTotal = Utils.parseMoeda(UIElements.metaValorObjetivoInputKm.value);
                meta.dataVencimento = UIElements.metaDataVencimentoInputKm.value || null;
                meta.taxaJuros = Utils.parseMoeda(UIElements.metaTaxaJurosInputKm.value);
                meta.financiamento = null; // Limpa se virou poupan√ßa

            } else { // Parcelamento (D√≠vida)
                // Se for sem juros, precisa de vencimento
                if (!dataVencimento && !UIElements.metaJurosCheckbox.checked) { 
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'D√≠vidas (sem juros) devem ter uma Data de Vencimento.' });
                    return; 
                }
                
                // Se n√£o for financiamento, valorTotal √© o inicial
                if (!UIElements.metaJurosCheckbox.checked) {
                    meta.valorTotal = valorInicial;
                }
                
                meta.dataVencimento = dataVencimento;
                meta.temJuros = UIElements.metaJurosCheckbox.checked;
                
                if (meta.temJuros) {
                    meta.tipoDivida = UIElements.metaTipoDividaSelect.value;
                    
                    if (meta.tipoDivida === 'financiamento' || meta.tipoDivida === 'emprestimo') {
                        // --- CORRE√á√ÉO: MESCLA COM DADOS ANTIGOS ---
                        meta.financiamento = {
                            valorFinanciado: Utils.parseMoeda(document.getElementById('metaValorFinanciadoInput').value),
                            taxaJurosAnual: Utils.parseMoeda(document.getElementById('metaTaxaJurosAnualInput').value),
                            totalParcelas: parseInt(document.getElementById('metaTotalParcelasInput').value) || 0,
                            valorParcela: Utils.parseMoeda(document.getElementById('metaValorParcelaInput').value),
                            dataInicioFinanciamento: document.getElementById('metaDataInicioFinanciamentoInput').value,
                            metodoAmortizacao: document.getElementById('metaMetodoAmortizacaoInput').value,
                            // Preserva o hist√≥rico
                            totalAmortizado: oldFinanciamento.totalAmortizado || 0,
                            parcelasPagas: oldFinanciamento.parcelasPagas || 0,
                            totalJurosEconomizados: oldFinanciamento.totalJurosEconomizados || 0
                        };
                        
                        // Recalcula o progresso para atualizar o valorAtual e valorTotal corretos
                        BusinessLogic.atualizarProgressoFinanciamentos();
                        
                    } else if (meta.tipoDivida === 'consorcio') {
                        meta.consorcio = {
                            valorObjetivo: Utils.parseMoeda(UIElements.metaValorObjetivoConsorcioInput.value)
                        };
                        meta.valorTotal = Utils.parseMoeda(UIElements.metaValorObjetivoConsorcioInput.value);
                    }
                } else {
                    meta.financiamento = null;
                }
            }

            metaEmEdicaoId = null;
            EventHandlers.handleCancelarEdicaoMeta();
            Storage.salvarConfiguracoes();
            UIRenderer.render();
        },
    
 */

    handleCancelarEdicaoMeta: () => {
            metaEmEdicaoId = null;
            
            UIElements.metaDescricaoInput.value = '';
            UIElements.metaValorTotalInput.value = '';
            UIElements.metaValorObjetivoInput.value = '';
            UIElements.metaDataVencimentoInput.value = '';
            UIElements.metaPrazoMesesInput.value = '';
            UIElements.metaTaxaJurosInput.value = '';
            UIElements.metaContribuicaoMensalInput.value = '';
            if (UIElements.metaValorPorKmInput) UIElements.metaValorPorKmInput.value = '';
            if (UIElements.metaValorObjetivoInputKm) UIElements.metaValorObjetivoInputKm.value = '';
            if (UIElements.metaDataVencimentoInputKm) UIElements.metaDataVencimentoInputKm.value = '';
            if (UIElements.metaTaxaJurosInputKm) UIElements.metaTaxaJurosInputKm.value = '';
            if (UIElements.metaJurosCheckbox) UIElements.metaJurosCheckbox.checked = false;
            if (UIElements.metaTipoDividaSelect) UIElements.metaTipoDividaSelect.value = 'financiamento';
            if (UIElements.metaValorObjetivoConsorcioInput) UIElements.metaValorObjetivoConsorcioInput.value = '';
            
            const finInputs = ['metaValorFinanciadoInput', 'metaTaxaJurosAnualInput', 'metaTotalParcelasInput', 'metaValorParcelaInput', 'metaDataInicioFinanciamentoInput'];
            finInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            const hintElement = document.getElementById('hintPoupancaKm');
            if (hintElement) {
                hintElement.textContent = 'Preencha o Objetivo e Vencimento para calcular o R$/KM.';
            }

            UIRenderer.renderMetasFinanceiras(); 
        },
        
        handleCalculoPoupancaKm: () => {
            if (UIElements.metaTipoSelect.value !== 'poupanca_km') return;
            if (AppState.isCalculatingMeta) return;
            AppState.isCalculatingMeta = true;

            const {
                metaValorTotalInput, metaValorObjetivoInputKm,
                metaDataVencimentoInputKm, metaTaxaJurosInputKm, metaValorPorKmInput
            } = UIElements;

            const valorInicial = Utils.parseMoeda(metaValorTotalInput.value);
            const valorObjetivo = Utils.parseMoeda(metaValorObjetivoInputKm.value);
            const dataVencimento = metaDataVencimentoInputKm.value;
            const taxaJurosAnual = Utils.parseMoeda(metaTaxaJurosInputKm.value);
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            metaValorPorKmInput.readOnly = false;
            metaValorPorKmInput.classList.remove('bg-slate-600');
            const hintElement = document.getElementById('hintPoupancaKm');
            
            if (valorObjetivo > 0 && dataVencimento) {
                const dataVenc = new Date(dataVencimento + "T12:00:00");
                const prazoMeses = (dataVenc.getFullYear() - hoje.getFullYear()) * 12 + (dataVenc.getMonth() - hoje.getMonth());
                
                if (prazoMeses > 0 && valorObjetivo > valorInicial) {
                    const taxaJurosMensal = taxaJurosAnual > 0 ? Math.pow(1 + (taxaJurosAnual / 100), 1 / 12) - 1 : 0;
                    const pmtCalculado = Utils.calcularContribuicaoMensal(valorInicial, valorObjetivo, taxaJurosMensal, prazoMeses);
                    const diasTrabalhoMes = BusinessLogic.calcularDiasTrabalhoNoMes(hoje.getFullYear(), hoje.getMonth());
                    const valorDiario = pmtCalculado / diasTrabalhoMes;
                    const kmMetaDiaria = AppState.configuracoes.kmMetaDiaria;
                    
                    if (kmMetaDiaria > 0) {
                        const sugestaoKm = valorDiario / kmMetaDiaria;
                        metaValorPorKmInput.value = Utils.formatarMoedaPorKmParaInput(sugestaoKm);
                        metaValorPorKmInput.readOnly = true;
                        metaValorPorKmInput.classList.add('bg-slate-600');
                        if (hintElement) hintElement.textContent = `C√°lculo autom√°tico baseado em ${kmMetaDiaria} km/dia.`;
                    } else {
                        if (hintElement) hintElement.textContent = `Defina "KM Meta Di√°ria" nas Configs. para calcular o R$/KM.`;
                    }
                }
            } else {
                if (hintElement) hintElement.textContent = 'Preencha o Objetivo e Vencimento para calcular o R$/KM.';
            }
            AppState.isCalculatingMeta = false;
        },
        
        handleCalculoTaxaAuto: () => {
            const tipoCorreto = UIElements.metaTipoSelect.value === 'parcelamento';
            const jurosMarcado = UIElements.metaJurosCheckbox.checked;
            const tipoDividaCorreto = UIElements.metaTipoDividaSelect.value === 'financiamento' || UIElements.metaTipoDividaSelect.value === 'emprestimo';
            if (!tipoCorreto || !jurosMarcado || !tipoDividaCorreto) return;

            const P = Utils.parseMoeda(UIElements.metaValorFinanciadoInput.value);
            const n = parseInt(UIElements.metaTotalParcelasInput.value);
            const PMT = Utils.parseMoeda(UIElements.metaValorParcelaInput.value);
            const taxaAnualInput = UIElements.metaTaxaJurosAnualInput;

            if (P > 0 && n > 0 && PMT > 0) {
                const taxaMensal = Utils.descobrirTaxaJuros(P, PMT, n);
                if (taxaMensal > 0) {
                    const taxaAnual = (Math.pow(1 + taxaMensal, 12) - 1) * 100;
                    taxaAnualInput.value = taxaAnual.toLocaleString('pt-BR', {minimumFractionDigits: 3, maximumFractionDigits: 3, useGrouping: false}).replace('.', ',');
                } else {
                    taxaAnualInput.value = '0,000';
                }
            } 
        },
        
applyVisualSettings: () => {
            const { theme, fontSize, padding, customColors } = AppState.visualSettings;
            const body = document.getElementById('main-body');
            const main = document.getElementById('main-content');
            
            const oldStyleTag = document.getElementById('custom-theme-styles');
            if (oldStyleTag) oldStyleTag.remove();

            body.classList.remove('theme-dark', 'theme-light', 'theme-custom');
            
            if (theme === 'theme-light') {
                body.classList.add('theme-light');
                
                const styleTag = document.createElement('style');
                styleTag.id = 'custom-theme-styles';
                styleTag.innerHTML = `
                    /* --- FUNDOS E ESTRUTURA --- */
                    body.theme-light { background-color: #f0f2f5 !important; color: #1c1e21 !important; }
                    .theme-light #main-content { background-color: #f0f2f5 !important; }

                    /* Cards: Branco Puro com Borda Sutil */
                    .theme-light .bg-slate-800, 
                    .theme-light .bg-slate-900 { 
                        background-color: #ffffff !important; 
                        border: 1px solid #dddfe2 !important;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
                    }

                    /* --- TIPOGRAFIA (LEITURA M√ÅXIMA) --- */
                    .theme-light .text-white { color: #050505 !important; font-weight: 600 !important; } /* T√≠tulos pretos */
                    .theme-light .text-slate-200 { color: #24292e !important; }
                    .theme-light .text-slate-300 { color: #3b4148 !important; }
                    .theme-light .text-slate-400 { color: #57606a !important; }
                    .theme-light .text-slate-500 { color: #6e7781 !important; }

                    /* --- INPUTS FORMTADOS --- */
                    .theme-light input, 
                    .theme-light select, 
                    .theme-light textarea {
                        background-color: #ffffff !important;
                        border: 1px solid #ced4da !important;
                        color: #212529 !important;
                    }
                    .theme-light input:focus { border-color: #0891b2 !important; box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.2) !important; }

                    /* --- CORES DE DESTAQUE (CONVERTENDO NEON PARA S√ìLIDO) --- */
                    /* Cyan (Azul Petr√≥leo) */
                    .theme-light .text-cyan-400 { color: #0077b6 !important; font-weight: 700 !important; }
                    .theme-light .border-cyan-500 { border-color: #0077b6 !important; }
                    .theme-light .bg-cyan-600 { background-color: #0284c7 !important; color: #fff !important; }

                    /* Green (Verde Dinheiro) */
                    .theme-light .text-green-400 { color: #166534 !important; font-weight: 700 !important; }
                    
                    /* Amber/Yellow (Alerta/Ouro) */
                    .theme-light .text-amber-400,
                    .theme-light .text-yellow-400 { color: #d97706 !important; font-weight: 700 !important; }
                    
                    /* Red (Erro/Sa√≠da) */
                    .theme-light .text-red-400,
                    .theme-light .text-red-500 { color: #b91c1c !important; }

                    /* --- CORRE√á√ÉO DAS METAS FINANCEIRAS --- */
                    /* Fundo da barra de progresso (Trilho) */
                    .theme-light .w-full.bg-slate-700.rounded-full {
                        background-color: #e9ecef !important;
                        border: 1px solid #dee2e6;
                    }
                    
                    /* A barra colorida interna (Mant√©m a cor original mas tira transpar√™ncia se houver) */
                    .theme-light .bg-blue-500 { background-color: #2563eb !important; }
                    .theme-light .bg-green-500 { background-color: #16a34a !important; }
                    .theme-light .bg-amber-500 { background-color: #d97706 !important; }
                    
                    /* Textos dentro das metas */
                    .theme-light .flex.justify-between.text-xs.mb-1 span {
                        color: #495057 !important;
                        font-weight: 600;
                    }

                    /* --- BOT√ïES E A√á√ïES --- */
                    /* Bot√µes Cinzas (Cancelar/Fechar) */
                    .theme-light .bg-slate-600,
                    .theme-light .bg-slate-700 {
                        background-color: #e2e8f0 !important;
                        color: #1e293b !important;
                        border: 1px solid #cbd5e1;
                    }
                    .theme-light .bg-slate-600:hover,
                    .theme-light .bg-slate-700:hover {
                        background-color: #cbd5e1 !important;
                    }

                    /* EXCE√á√ÉO: Bot√µes de A√ß√£o Principal (Salvar/Pagar) devem manter texto branco */
                    .theme-light .btn-salvar,
                    .theme-light .btn-confirmar,
                    .theme-light button[class*="bg-blue-600"],
                    .theme-light button[class*="bg-green-600"],
                    .theme-light button[class*="bg-red-600"] {
                        color: #ffffff !important;
                        border: none !important;
                    }
                    
                    /* Divis√≥rias */
                    .theme-light .border-slate-600,
                    .theme-light .border-slate-700,
                    .theme-light .divide-slate-700 > * + * {
                        border-color: #e5e7eb !important;
                    }
                `;
                document.head.appendChild(styleTag);
            } 
            else if (theme === 'theme-custom') {
                body.classList.add('theme-custom');
                const styleTag = document.createElement('style');
                styleTag.id = 'custom-theme-styles';
                let css = ':root {\n';
                for (const [key, value] of Object.entries(customColors)) { css += `    ${key}: ${value};\n`; }
                css += '}';
                styleTag.innerHTML = css;
                document.head.appendChild(styleTag);
            }
            
            body.classList.remove('font-size-sm', 'font-size-base', 'font-size-lg');
            body.classList.add(fontSize);
            main.classList.remove('padding-sm', 'padding-base', 'padding-lg');
            main.classList.add(padding);
        },

handleSaveVisualSettings: () => {
            const theme = document.querySelector('input[name="theme"]:checked').value;
            const fontSize = document.querySelector('input[name="font-size"]:checked').value;
            const padding = document.querySelector('input[name="padding"]:checked').value;
            const showIcons = document.getElementById('vs-show-icons').checked; // <--- NOVO
            
            const customColors = {
                '--color-cyan': document.getElementById('custom-color-cyan').value,
                '--text-primary': document.getElementById('custom-text-primary').value,
                '--bg-primary': document.getElementById('custom-bg-primary').value,
                '--bg-secondary': document.getElementById('custom-bg-secondary').value
            };
            
            AppState.visualSettings = { 
                theme, fontSize, padding, customColors, 
                showIconsInCards: showIcons, // <--- SALVA AQUI
                isSaldoCarteiraOculto: AppState.visualSettings.isSaldoCarteiraOculto 
            };
            
            Storage.salvarVisualSettings();
            EventHandlers.applyVisualSettings();
            UIRenderer.render(); // Re-renderiza para aplicar a mudan√ßa nos cards
            document.getElementById('visualSettingsModal').classList.add('hidden');
        },
        
        handleVisualSettingsRadioChange: () => {
            const theme = document.querySelector('input[name="theme"]:checked').value;
            const colorPicker = document.getElementById('customColorPickerContainer');
            colorPicker.classList.toggle('hidden', theme !== 'theme-custom');
        },
        
        handleCalculoPoupanca: () => {
            if (UIElements.metaTipoSelect.value !== 'poupanca') return;
            if (AppState.isCalculatingMeta) return;
            AppState.isCalculatingMeta = true;
            
            const {
                metaValorTotalInput, metaValorObjetivoInput, metaPrazoMesesInput,
                metaTaxaJurosInput, metaContribuicaoMensalInput
            } = UIElements;
            const valorInicial = Utils.parseMoeda(metaValorTotalInput.value);
            const valorObjetivo = Utils.parseMoeda(metaValorObjetivoInput.value);
            const prazoMeses = parseInt(metaPrazoMesesInput.value) || 0;
            const taxaJurosAnual = Utils.parseMoeda(metaTaxaJurosInput.value);
            const contribuicaoMensal = Utils.parseMoeda(metaContribuicaoMensalInput.value);
            const taxaJurosMensal = taxaJurosAnual > 0 ? Math.pow(1 + (taxaJurosAnual / 100), 1 / 12) - 1 : 0;
            const lastEdited = AppState.lastMetaFieldEdited;

            try {
                if (lastEdited === 'metaValorObjetivoInput' || lastEdited === 'metaPrazoMesesInput' || lastEdited === 'metaValorTotalInput' || lastEdited === 'metaTaxaJurosInput') {
                    if (valorObjetivo > 0 && prazoMeses > 0 && valorObjetivo > valorInicial) {
                        const pmtCalculado = Utils.calcularContribuicaoMensal(valorInicial, valorObjetivo, taxaJurosMensal, prazoMeses);
                        metaContribuicaoMensalInput.value = Utils.formatarMoedaParaInput(pmtCalculado);
                        metaContribuicaoMensalInput.readOnly = true;
                        metaValorObjetivoInput.readOnly = false;
                        metaContribuicaoMensalInput.classList.add('bg-slate-600');
                        metaValorObjetivoInput.classList.remove('bg-slate-600');
                    }
                }
                else if (lastEdited === 'metaContribuicaoMensalInput') {
                    if (contribuicaoMensal > 0 && prazoMeses > 0) {
                        const fvCalculado = Utils.calcularValorFuturo(valorInicial, contribuicaoMensal, taxaJurosMensal, prazoMeses);
                        metaValorObjetivoInput.value = Utils.formatarMoedaParaInput(fvCalculado);
                        metaValorObjetivoInput.readOnly = true;
                        metaContribuicaoMensalInput.readOnly = false;
                        metaValorObjetivoInput.classList.add('bg-slate-600');
                        metaContribuicaoMensalInput.classList.remove('bg-slate-600');
                    }
                }
            } catch (e) {
                console.error("Erro no c√°lculo da meta:", e);
            }
            AppState.isCalculatingMeta = false;
        },
        
        handleDescriptionMouseDown: (e) => {
            clearTimeout(AppState.descriptionLongPressTimer); 
            AppState.descriptionLongPressTimer = setTimeout(() => {
                const input = UIElements.descricaoServicoInput;
                if (input.value.trim() !== '') {
                    input.value = '';
                    console.log("Descri√ß√£o limpa por segurar.");
                }
                AppState.descriptionLongPressTimer = null;
            }, 3000); // 3 segundos
        },

        handleDescriptionMouseUp: (e) => {
            if (AppState.descriptionLongPressTimer) {
                clearTimeout(AppState.descriptionLongPressTimer);
                AppState.descriptionLongPressTimer = null;
            }
        },
        
        handleAlertasJornadaClick: (e) => {
            const target = e.target;

            const btnPagarRecorrente = target.closest('.btn-pagar-conta-recorrente');
            if (btnPagarRecorrente) {
                const { id, valor, descricao, categoria } = btnPagarRecorrente.dataset;

                // --- IN√çCIO DA MODIFICA√á√ÉO (Etapa 5) ---
                // Abre o modal de transa√ß√£o avulsa, passando os dados do alerta
                UIRenderer.abrirModal('novaTransacaoAvulsa', {
                    defaultTipo: 'saida',
                    defaultValor: parseFloat(valor),
                    defaultCategoria: categoria,
                    defaultDescricao: descricao,
                    defaultRecorrenteId: id, // Passa o ID da conta recorrente
                    isCustoOperacional: false // <-- ETAPA 5: Custo pessoal
                });
                // --- FIM DA MODIFICA√á√ÉO ---
                
                return; // Clique tratado
            }

            // L√≥gica 2: Dispensar Alerta de Conta
            const btnDispensar = target.closest('.btn-dispensar-alerta');
            if(btnDispensar) {
                // Remove o alerta (div pai)
                btnDispensar.closest('div.p-3.rounded-lg').remove();
            }
        },
        
        handleDescriptionClick: (e) => {
            const input = UIElements.descricaoServicoInput;
            if (AppState.descriptionClickTimer) {
                clearTimeout(AppState.descriptionClickTimer);
            }
            AppState.descriptionClickCount++;
            if (input.value.trim() === '' && AppState.descriptionClickCount >= 3) {
                if (AppState.descriptionClickCount === 3 || AppState.currentDescriptionHistory.length === 0) {
                    const categoria = UIElements.categoriaServicoSelect.value;
                    AppState.currentDescriptionHistory = buildUniqueDescriptionHistory(categoria);
                    AppState.descriptionHistoryIndex = 0;
                } else {
                    AppState.descriptionHistoryIndex++;
                }
                if (AppState.currentDescriptionHistory.length > 0) {
                    if (AppState.descriptionHistoryIndex >= AppState.currentDescriptionHistory.length) {
                        AppState.descriptionHistoryIndex = 0; 
                    }
                    input.value = AppState.currentDescriptionHistory[AppState.descriptionHistoryIndex];
                }
            } else if (input.value.trim() !== '') {
                AppState.descriptionClickCount = 0;
            }
            AppState.descriptionClickTimer = setTimeout(() => {
                AppState.descriptionClickCount = 0;
                AppState.descriptionHistoryIndex = 0;
            }, 800);
        },
  

      handleVoltarDrilldown: () => {
            AppState.dashboardState.drilldown.active = false;
            AppState.dashboardState.drilldown.type = null;
            AppState.dashboardState.drilldown.category = null;
            AppState.dashboardState.drilldown.subcategory = null;
            document.getElementById('graficoDrilldownContainer').classList.add('hidden');
            document.getElementById('graficoDrilldownKmContainer').classList.add('hidden');
            
            // Mostra os gr√°ficos principais
            UIElements.graficoGanhosCustos.parentElement.parentElement.classList.remove('hidden');
            document.getElementById('graficoCustoCombustivelContainer').classList.remove('hidden'); // <-- ETAPA 5
            document.getElementById('graficoMediaKmLContainer').classList.remove('hidden'); // <-- ETAPA 5
            UIElements.graficoMetasContainer.classList.remove('hidden');
            UIElements.graficoCategorias.parentElement.parentElement.classList.remove('hidden');
            UIElements.graficoCustos.parentElement.parentElement.classList.remove('hidden');
            
            UIRenderer.renderDashboard();
        },
    // Fun√ß√£o secreta para for√ßar edi√ß√£o de dias passados
        liberarEdicaoPassada: () => {
            AppState.isToday = true; // Engana o sistema temporariamente
            UIRenderer.render();     // Redesenha a tela desbloqueada
            console.log("üîì Modo de edi√ß√£o hist√≥rica ativado!");
        },    
        
        
init: () => {
    
    // Listener para os bot√µes de Dias da Semana
            const containerDias = document.getElementById('selectorDiasTrabalho');
            if (containerDias) {
                containerDias.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-dia-semana')) {
                        EventHandlers.handleDiaSemanaClick(e.target);
                    }
                });
            }
            // --- PROMO√á√ïES E B√îNUS ---
            const btnPromocoes = document.getElementById('btnAbrirPromocoes');
            if (btnPromocoes) {
                btnPromocoes.addEventListener('click', () => {
                    UIRenderer.abrirModal('gestaoPromocoes');
                });
            }
            // Isso deve estar no seu init()
            if (UIElements.btnAdicionarCusto) {
                // Remove listeners antigos para evitar duplica√ß√£o (boa pr√°tica em SPAs)
                const novoBtn = UIElements.btnAdicionarCusto.cloneNode(true);
                UIElements.btnAdicionarCusto.parentNode.replaceChild(novoBtn, UIElements.btnAdicionarCusto);
                UIElements.btnAdicionarCusto = novoBtn; // Atualiza refer√™ncia

                // Adiciona o novo listener apontando para a fun√ß√£o atualizada
                UIElements.btnAdicionarCusto.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarCusto, 300));
            }
            // --- ABAS ---
            UIElements.tabs.forEach(tab => tab.addEventListener('click', EventHandlers.handleTabClick));
            
            // --- RESUMO ABASTECIMENTO ---
            if (UIElements.resumoAbastecimento) {
                UIElements.resumoAbastecimento.addEventListener('click', (e) => {
                    if (e.target.id === 'btn-abrir-retroativo' || e.target.closest('#btn-abrir-retroativo')) {
                        UIRenderer.abrirModal('registroAbastecimentoRetroativo');
                    }
                });
            }
// No seu init()...
    const btnAdd = document.getElementById('btnAdicionarCusto');
    
    if (btnAdd) {
        // 1. Clona para destruir listeners antigos
        const novoBtn = btnAdd.cloneNode(true);
        btnAdd.parentNode.replaceChild(novoBtn, btnAdd);
        if (UIElements) UIElements.btnAdicionarCusto = novoBtn;

        // 2. Adiciona o Listener √öNICO
        novoBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopImmediatePropagation(); // <--- TRAVA TOTAL DE OUTROS LISTENERS

            console.log(">>> CLICK NO BOT√ÉO ADICIONAR (DISPARO √öNICO) <<<");
            EventHandlers.handleAdicionarCusto(e);
        });
    }
            // --- STATUS E MODAL ---
            UIElements.btnToggleStatusView.addEventListener('click', EventHandlers.handleToggleStatusView);
            UIElements.modalContainer.addEventListener('click', EventHandlers.handleModalClick);

            // --- ALERTA MANUTEN√á√ÉO ---
            const accordion = document.getElementById('maintenanceAlertAccordion');
            if (accordion) {
                accordion.addEventListener('toggle', () => {
                    if (accordion.open) {
                        AppState.alertaManutencaoVistoHoje = true;
                        const jornadaDoDia = BusinessLogic.getJornadaDoDia(new Date());
                        UIRenderer.renderAlertasJornada(jornadaDoDia);
                    }
                });
            }

// --- LISTENER GLOBAL DE CLIQUES (V3 GOLD BLINDADO) ---
document.addEventListener('click', (e) => {

    // =================================================
    // NORMALIZA√á√ÉO DE TARGET (OBRIGAT√ìRIA)
    // =================================================
    let el = e.target;

    if (!(el instanceof Element)) {
        el = el.parentElement;
    }

    if (!el) return;

    // A PARTIR DAQUI, SEMPRE √â UM ELEMENT
    const target = el;

    // =================================================
    // ROTAS EXISTENTES (SEM ALTERA√á√ÉO DE L√ìGICA)
    // =================================================

    // Rota 1: Custos Fixos
    if (target.closest('.btn-excluir-custo-fixo') || target.closest('.btn-editar-custo-fixo')) {
        EventHandlers.handleListaCustosFixos(e);
        return;
    }

    // Rota 2: Contas Recorrentes
    if (target.closest('.btn-excluir-conta-recorrente') || target.closest('.btn-editar-conta-recorrente')) {
        EventHandlers.handleListaContasRecorrentes(e);
        return;
    }

    // Rota 3: Salvar Edi√ß√£o Custo
    if (target.closest('.btn-salvar-edicao-custo-fixo')) {
        EventHandlers.handleSalvarEdicaoCustoFixo();
        return;
    }

    // Rota 4: Subcategorias
    if (target.closest('.btn-excluir-subcategoria')) {
        EventHandlers.handleListaSubcategorias(e);
        return;
    }

    // Rota 5: Factory Reset
    if (target.id === 'btn-factory-reset') {
        EventHandlers.handleFactoryReset();
        return;
    }
// =================================================================
    // Rota 6: EXTRATO INTELIGENTE (VERS√ÉO BLINDADA)
    // =================================================================
    const btnExtrato = target.closest('.btn-ver-extrato');
    
    if (btnExtrato) {
        e.preventDefault();
        e.stopPropagation();

        const id = btnExtrato.dataset.id;
        if (!id) return; // Se n√£o tem ID, ignora silenciosamente

        let nome = "Extrato";
        let saldo = 0;

        // Identifica Contexto
        const conta = AppState.configuracoes.contasBancarias.find(c => c.id === id);
        
        if (conta) {
            nome = conta.nome;
            saldo = BusinessLogic.calcularSaldoConta(id);
        } else {
            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
            if (meta) {
                nome = meta.descricao;
                saldo = meta.tipo === 'parcelamento' ? (meta.valorProvisionado || 0) : (meta.valorAtual || 0);
            }
        }

        // üö® FILTRO BLINDADO (AQUI ESTAVA O ERRO)
        const transacoes = AppState.historicoTransacoes.filter(t => {
            if (!t) return false; // Ignora itens nulos
            
            // 1. Verifica ID direto (Origem ou Destino novo)
            if (t.contaId === id || t.contaDestino === id) return true;

            // 2. Verifica Destino Objeto (Legado) COM SEGURAN√áA
            if (t.destino && typeof t.destino === 'object' && t.destino.id === id) return true;

            return false;
        });

        if (typeof Modals !== 'undefined' && Modals.abrirModal) {
            Modals.abrirModal('extratoConta', {
                contaId: id,
                contaNome: nome,
                transacoes: transacoes,
                saldoFinal: saldo
            });
        }
        return; 
    }
});

const timelineLista = document.getElementById('historicoServicosLista');
            if (timelineLista) {
                const novaLista = timelineLista.cloneNode(true);
                timelineLista.parentNode.replaceChild(novaLista, timelineLista);
                novaLista.addEventListener('click', EventHandlers.handleListaAtividades);
            }
// Garante que a lista de pend√™ncias tamb√©m funcione
            if (UIElements.listaPendencias) {
                 const novaListaPend = UIElements.listaPendencias.cloneNode(true);
                 UIElements.listaPendencias.parentNode.replaceChild(novaListaPend, UIElements.listaPendencias);
                 novaListaPend.addEventListener('click', EventHandlers.handleListaPendentesClick);
                 // Atualiza a refer√™ncia no UIElements
                 UIElements.listaPendencias = novaListaPend; 
            }
            // --- LISTENERS GLOBAIS DE INPUT ---
            UIElements.modalContainer.addEventListener('input', (e) => {
                const targetId = e.target.id;
                if (targetId === 'input-acelerar-meta') EventHandlers.handleSimuladorAceleradorChange(0);
                if (e.target.classList.contains('input-peso-item')) EventHandlers.handlePesoItemChange(e.target);
                if (targetId === 'meses-para-juntar') {
                    const meses = parseInt(e.target.value) || 0;
                    Utils.debounce(EventHandlers.recalcularValorAlvoModal, 300)(meses);
                }
            });

            document.addEventListener('input', (e) => {
                const targetId = e.target.id;
                // Simuladores
                if (['metaValorFinanciadoInput', 'metaTotalParcelasInput', 'metaValorParcelaInput'].includes(targetId)) {
                    Utils.debounce(EventHandlers.handleCalculoTaxaAuto, 400)();
                }
                // Meta Poupan√ßa
                if (['metaValorTotalInput', 'metaValorObjetivoInput', 'metaPrazoMesesInput', 'metaContribuicaoMensalInput', 'metaTaxaJurosInput'].includes(targetId)) {
                    Utils.debounce(EventHandlers.handleCalculoPoupanca, 300)();
                }
                // Meta KM
                if (['metaValorTotalInput', 'metaValorObjetivoInputKm', 'metaDataVencimentoInputKm', 'metaTaxaJurosInputKm'].includes(targetId)) {
                    Utils.debounce(EventHandlers.handleCalculoPoupancaKm, 300)();
                }
                // EV Config
                const evBateria = document.getElementById('configCapacidadeBateria');
                const evCusto = document.getElementById('configCustoKWh');
                if (evBateria && evCusto && (targetId === evBateria.id || targetId === evCusto.id)) {
                    EventHandlers.handleConfigInputChange();
                }
            });
            // --- LISTENER PARA BOT√ÉO "PAGAR FATURA" (VINDO DO ALERTA) ---
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-pagar-fatura-alerta');
            if (btn) {
                const faturaId = btn.dataset.id;
                const faturaMeta = AppState.configuracoes.metasFinanceiras.find(m => m.id === faturaId);
                
                if (faturaMeta) {
                    // Calcula saldo devedor atualizado
                    const saldoDevedor = BusinessLogic.calcularSaldoConta(faturaId);
                    
                    // Abre o modal espec√≠fico de Fatura
                    UIRenderer.abrirModal('pagarFaturaDetalhado', { 
                        meta: faturaMeta, 
                        saldoDevedor: saldoDevedor 
                    });
                }
            }
        });
// --- LISTENER PARA BOT√ÉO "PAGAR RECORRENTE" (CORRIGIDO) ---
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-pagar-recorrente');
            if (btn) {
                const idRecorrente = btn.dataset.id;
                const conta = AppState.configuracoes.contasRecorrentes.find(c => c.id === idRecorrente);
                
                if (conta) {
                    // AQUI ESTAVA O ERRO:
                    // 1. O nome do modal correto √© 'novaTransacaoAvulsa'
                    // 2. Os dados devem ser passados diretamente (ex: defaultValor), n√£o dentro de objetos
                    
                    UIRenderer.abrirModal('novaTransacaoAvulsa', {
                        defaultTipo: 'saida',
                        defaultValor: conta.valor,
                        defaultDescricao: conta.descricao,
                        defaultCategoria: conta.categoria || 'Outras Despesas',
                        defaultRecorrenteId: conta.id, // VITAL: Isso liga o pagamento √† conta para atualizar a data
                        defaultData: new Date().toISOString().split('T')[0], // Data de hoje
                        isCustoOperacional: false // Define como despesa pessoal (n√£o abate do lucro da corrida)
                    });
                }
            }
        });
            document.addEventListener('focusin', (e) => {
                const targetId = e.target.id;
                if ([
                    'metaValorTotalInput', 'metaValorObjetivoInput', 'metaPrazoMesesInput', 'metaContribuicaoMensalInput',
                    'metaValorObjetivoInputKm', 'metaDataVencimentoInputKm', 'metaTaxaJurosInputKm'
                ].includes(targetId)) {
                    AppState.lastMetaFieldEdited = targetId;
                    if (UIElements.metaTipoSelect.value === 'poupanca') UIRenderer.renderMetasFinanceiras();
                }
            });

           // --- VISUAL SETTINGS (CORRIGIDO: CHECKBOX CARREGA O ESTADO) ---
            const visualModal = document.getElementById('visualSettingsModal');
            const btnAbrirVisual = document.getElementById('btnAbrirVisualSettings');
            
            if (btnAbrirVisual) {
                btnAbrirVisual.addEventListener('click', () => {
                    const { theme, fontSize, padding, customColors, showIconsInCards } = AppState.visualSettings;
                    
                    // 1. Carrega Radio Buttons
                    const radioTheme = document.getElementById(theme);
                    if(radioTheme) radioTheme.checked = true;
                    
                    const radioFont = document.getElementById(fontSize);
                    if(radioFont) radioFont.checked = true;
                    
                    const radioPad = document.getElementById(padding);
                    if(radioPad) radioPad.checked = true;
                    
                    // 2. CORRE√á√ÉO: Carrega o Checkbox dos √çcones
                    const chkIcons = document.getElementById('vs-show-icons');
                    if (chkIcons) {
                        chkIcons.checked = showIconsInCards === true; // Garante booleano
                    }

                    // 3. Carrega Cores Custom
                    document.getElementById('custom-color-cyan').value = customColors['--color-cyan'];
                    document.getElementById('custom-text-primary').value = customColors['--text-primary'];
                    document.getElementById('custom-bg-primary').value = customColors['--bg-primary'];
                    document.getElementById('custom-bg-secondary').value = customColors['--bg-secondary'];
                    
                    EventHandlers.handleVisualSettingsRadioChange();
                    visualModal.classList.remove('hidden');
                });
            }
            if (visualModal) {
                visualModal.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.id === 'btnSalvarVisualSettings') EventHandlers.handleSaveVisualSettings();
                    if (target.dataset.closeModal === 'visualSettingsModal') visualModal.classList.add('hidden');
                });
            }
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', EventHandlers.handleVisualSettingsRadioChange);
            });

            // Visibilidade
            document.addEventListener('visibilitychange', TimeManager.handleVisibilityChange);

            // --- ABA JORNADA ---
            ['kmInicialInput', 'kmFinalInput', 'metaHorasInput'].forEach(id => {
                if(UIElements[id]) UIElements[id].addEventListener('change', EventHandlers.handleJornadaInputChange);
            });
            UIElements.btnJornada.addEventListener('click', Utils.debounce(EventHandlers.handleJornada, 300));
            UIElements.btnPausa.addEventListener('click', Utils.debounce(EventHandlers.handlePausa, 300));
            UIElements.categoriaServicoSelect.addEventListener('change', EventHandlers.handleCategoriaChange);

            const descInput = UIElements.descricaoServicoInput;
            if (descInput) {
                descInput.addEventListener('mousedown', EventHandlers.handleDescriptionMouseDown);
                descInput.addEventListener('mouseup', EventHandlers.handleDescriptionMouseUp);
                descInput.addEventListener('touchstart', EventHandlers.handleDescriptionMouseDown, { passive: true });
                descInput.addEventListener('touchend', EventHandlers.handleDescriptionMouseUp);
                descInput.addEventListener('click', EventHandlers.handleDescriptionClick);
            }

            UIElements.btnIniciarServico.addEventListener('click', Utils.debounce(EventHandlers.handleIniciarServico, 300));
            UIElements.btnServicoRapido.addEventListener('click', Utils.debounce(EventHandlers.handleServicoRapido, 300));
            UIElements.listaServicosEmAndamento.addEventListener('click', EventHandlers.handleListaServicos);
            UIElements.diaAnteriorBtn.addEventListener('click', () => EventHandlers.mudarDia(-1));
            UIElements.proximoDiaBtn.addEventListener('click', () => EventHandlers.mudarDia(1));
            UIElements.btnExcluirDia.addEventListener('click', EventHandlers.handleExcluirDia);
            UIElements.btnDownloadDia.addEventListener('click', EventHandlers.handleDownload);
            UIElements.btnTogglePendentes.addEventListener('click', EventHandlers.handleTogglePendentes);

            if (UIElements.btnAbrirCalculadora) {
                UIElements.btnAbrirCalculadora.addEventListener('click', () => UIRenderer.abrirModal('calculadoras', {}));
            }

            if (UIElements.contasRecorrentesAlertContainer) {
                UIElements.contasRecorrentesAlertContainer.addEventListener('click', EventHandlers.handleAlertasJornadaClick);
            }
            UIElements.listaPendencias.addEventListener('click', EventHandlers.handleListaPendentesClick);
            
            // OUVINTE ORIGINAL DA LISTA DO HIST√ìRICO (Pode ser redundante se o de cima funcionar, mas mantemos por seguran√ßa)
            if (UIElements.listaAtividades) {
                UIElements.listaAtividades.addEventListener('click', EventHandlers.handleListaAtividades);
            }

            UIElements.btnMostrarCustos.addEventListener('click', EventHandlers.handleToggleCustos);

            ['litrosAbastecidosInput', 'valorAbastecidoInput', 'kmAbastecimentoInput', 'litrosRestantesInput'].forEach(id => {
                if (UIElements[id]) UIElements[id].addEventListener('change', EventHandlers.handleCurrencyInputChangeJornada);
            });

            UIElements.btnAdicionarCusto.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarCusto, 300));
            UIElements.listaCustos.addEventListener('click', EventHandlers.handleListaCustosClick);

            // --- OUTRAS ABAS ---
            // Dashboard
            UIElements.selectDia.addEventListener('change', UIRenderer.renderDashboard);
            UIElements.selectMes.addEventListener('change', UIRenderer.renderDashboard);
            UIElements.selectAno.addEventListener('change', UIRenderer.renderDashboard);
            UIElements.dashboardFilterContainer.addEventListener('click', (e) => {
                if (e.target.tagName !== 'SELECT' && e.target.tagName !== 'OPTION') {
                    AppState.dashboardState.isRoadmapVisible = !AppState.dashboardState.isRoadmapVisible;
                    UIRenderer.renderDashboard();
                }
            });

            // Manuten√ß√£o
            UIElements.btnAdicionarPlano.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarPlano, 300));
            UIElements.listaPlanoMestre.addEventListener('click', EventHandlers.handleListaPlanoMestre);
            UIElements.btnAdicionarHistoricoServico.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarHistoricoServico, 300));
            UIElements.listaHistoricoServicos.addEventListener('click', EventHandlers.handleListaHistoricoServicos);
            UIElements.btnAdicionarCota.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarCota, 300));
            UIElements.listaCota.addEventListener('click', EventHandlers.handleListaCota);
            UIElements.tabContents.manutencao.addEventListener('click', EventHandlers.handleGamTabClick);
            UIElements.histPlanoMestreItemSelect.addEventListener('change', EventHandlers.handleHistPlanoMestreChange);

            // Financeiro
            UIElements.tabContents.financeiro.addEventListener('click', EventHandlers.handleFinContentClick);
            UIElements.btnAdicionarCustoFixo.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarCustoFixo, 300));
            UIElements.listaCustosFixos.addEventListener('click', EventHandlers.handleListaCustosFixos);
            UIElements.listaContasRecorrentes.addEventListener('click', EventHandlers.handleListaContasRecorrentes);
            UIElements.btnAdicionarContaRecorrente.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarContaRecorrente, 300));
            UIElements.metaTipoSelect.addEventListener('change', UIRenderer.renderMetasFinanceiras);
            UIElements.btnAdicionarMeta.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarMeta, 300));
            UIElements.btnSalvarEdicaoMeta.addEventListener('click', Utils.debounce(EventHandlers.handleSalvarEdicaoMeta, 300));
            if (UIElements.metaJurosCheckbox) UIElements.metaJurosCheckbox.addEventListener('change', UIRenderer.renderMetasFinanceiras);
            if (UIElements.metaTipoDividaSelect) UIElements.metaTipoDividaSelect.addEventListener('change', UIRenderer.renderMetasFinanceiras);
            UIElements.btnCancelarEdicaoMeta.addEventListener('click', EventHandlers.handleCancelarEdicaoMeta);
            UIElements.listaMetasManutencaoPlano.addEventListener('click', EventHandlers.handleListaMetasFinanceiras);
            UIElements.listaMetasManutencaoKm.addEventListener('click', EventHandlers.handleListaMetasFinanceiras);
            UIElements.listaMetasManutencaoConcluidas.addEventListener('click', EventHandlers.handleListaMetasFinanceiras);
            UIElements.listaMetasAtivas.addEventListener('click', EventHandlers.handleListaMetasFinanceiras);
            UIElements.listaMetasConcluidas.addEventListener('click', EventHandlers.handleListaMetasFinanceiras);
            UIElements.metaTabAtivas.addEventListener('click', EventHandlers.handleMetaTabClick);
            UIElements.metaTabConcluidas.addEventListener('click', EventHandlers.handleMetaTabClick);
            UIElements.metaTabManutencao.addEventListener('click', EventHandlers.handleMetaTabClick);
            UIElements.metaTabContentManutencao.addEventListener('click', EventHandlers.handleMetaSubTabClick);

            // Configura√ß√µes
            ['diasTrabalhoSemanaInput','proLaboreInput', 'valorVeiculoInput', 'valorCustoFixoInput', 'metaAutonomaInput', 'autonomiaVeiculoInput'].forEach(id => {
                if(UIElements[id]) UIElements[id].addEventListener('input', Utils.debounce(EventHandlers.handleCurrencyInputChangeConfig, 400));
            });
            ['diasTrabalhoSemanaInput', 'vidaUtilVeiculoInput', 'tipoCombustivelSelect', 'configTipoDeclaracao', 'configMeiPercentual', 'usarGpsTracking', 'rateioDinamicoCustos', 'incluirPrevisaoManutencao', 'manterCalculoKmAntigo'].forEach(id => {
                if (UIElements[id]) UIElements[id].addEventListener('change', EventHandlers.handleConfigInputChange);
            });
            UIElements.btnSalvarConfiguracoes.addEventListener('click', EventHandlers.handleSalvarConfiguracoes);
            UIElements.btnAdicionarSubcategoria.addEventListener('click', Utils.debounce(EventHandlers.handleAdicionarSubcategoria, 300));
            UIElements.listaSubcategorias.addEventListener('click', EventHandlers.handleListaSubcategorias);
            UIElements.btnExportarDados.addEventListener('click', EventHandlers.handleExportarDados);
            UIElements.importFileInput.addEventListener('change', EventHandlers.handleImportarDados);
        },
      handleTabClick: (e) => {
            UIElements.tabs.forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            Object.values(UIElements.tabContents).forEach(content => content.classList.add('hidden'));
            const activeTab = e.target.dataset.tab;
            UIElements.tabContents[activeTab].classList.remove('hidden');

            if (activeTab === 'dashboard') {
                AppState.dashboardState.graficoCategoriaNivel = 'categoria';
                AppState.dashboardState.graficoCategoriaPai = null;
                AppState.dashboardState.graficoCustoNivel = 'categoria';
                AppState.dashboardState.graficoCustoPai = null;
                AppState.dashboardState.drilldown.active = false;
                UIRenderer.renderDashboard();
            }
        },
		
		handleGamTabClick: (e) => {
            const clickedButton = e.target.closest('.gam-tab-button');
            if (!clickedButton) return;

            // Remove 'active' de todos os bot√µes GAM
            UIElements.gamTabButtons.forEach(t => t.classList.remove('active'));
            // Adiciona 'active' ao bot√£o clicado
            clickedButton.classList.add('active');

            // Esconde todos os pain√©is GAM
            Object.values(UIElements.gamTabPanes).forEach(content => content.classList.add('hidden'));
            
            // Mostra o painel correspondente
            const activeTab = clickedButton.dataset.gamTab;
            if (UIElements.gamTabPanes[activeTab]) {
                UIElements.gamTabPanes[activeTab].classList.remove('hidden');
            }
            if (activeTab === 'dashboard') {
                UIRenderer.renderGamDashboard();
            }
            if (activeTab === 'alertas') {
                UIRenderer.renderSaudeVeiculo();
            }
        },
     
// =========================================================
        // HANDLER CENTRAL DE CLIQUES (V68 - COMPLETO E BLINDADO)
        // =========================================================
        handleFinContentClick: (e) => {
            const target = e.target;
            
            // --- 1. Troca de Sub-Abas Principais (Bancos, Custos, Relat√≥rios) ---
            const clickedSubTab = target.closest('.fin-tab-button');
            if (clickedSubTab) {
                UIElements.finTabButtons.forEach(t => t.classList.remove('active'));
                clickedSubTab.classList.add('active');
                
                // Esconde todos os pain√©is
                Object.values(UIElements.finTabPanes).forEach(content => {
                    if(content) content.classList.add('hidden');
                });
                
                const activeTab = clickedSubTab.dataset.finTab;
                if (UIElements.finTabPanes[activeTab]) {
                    UIElements.finTabPanes[activeTab].classList.remove('hidden');
                }
                
                // Renderiza√ß√£o espec√≠fica por aba
                if (activeTab === 'bancos') {
                    UIRenderer.renderContasBancarias();
                }
                if (activeTab === 'custos') {
                    UIRenderer.renderConfiguracoes();
                    UIRenderer.renderContasRecorrentes();
                }
                if (activeTab === 'relatorios') {
                    if (UIElements.btnGerarRelatorio && UIElements.reportStartDate.value) {
                        // Opcional: Auto-gerar se j√° tiver datas
                    }
                }
                return; 
            }
            
// --- 2. Troca de Sub-Abas de Relat√≥rios (DRE, Livro Caixa, MEI) ---
            const clickedReportTab = target.closest('.report-tab-button');
            
            if (clickedReportTab) {
                // A. RESETA ESTILO DOS BOT√ïES (Visual)
                UIElements.reportTabButtons.forEach(t => {
                    t.classList.remove('active', 'bg-slate-700', 'text-cyan-400'); // Remove destaque
                    t.classList.add('text-slate-400'); // Volta a ficar cinza
                });

                // B. ATIVA O BOT√ÉO CLICADO (Visual)
                clickedReportTab.classList.add('active', 'bg-slate-700', 'text-cyan-400');
                clickedReportTab.classList.remove('text-slate-400');
                
                // C. ESCONDE TODAS AS DIVS (L√≥gica)
                Object.values(UIElements.reportTabPanes).forEach(content => {
                    if(content) content.classList.add('hidden');
                });
                
                // D. MOSTRA A DIV CERTA (L√≥gica)
                const activeReportTab = clickedReportTab.dataset.reportTab; // ex: 'dre', 'mei'
                const targetPane = UIElements.reportTabPanes[activeReportTab];
                
                if (targetPane) {
                    targetPane.classList.remove('hidden');
                }

                // E. GERA O RELAT√ìRIO AUTOMATICAMENTE (UX)
                // Se j√° tiver data selecionada, clica no bot√£o "Gerar" sozinho para atualizar os dados
                if (UIElements.btnGerarRelatorio && document.getElementById('report-start-date').value) {
                    // Pequeno delay para garantir que a UI trocou antes de travar o calculo
                    setTimeout(() => {
                        UIElements.btnGerarRelatorio.click();
                    }, 10);
                }
                
                return true; // Para a propaga√ß√£o do clique
            }
          /* 

           const clickedReportTab = target.closest('.report-tab-button');
            if (clickedReportTab) {
                UIElements.reportTabButtons.forEach(t => t.classList.remove('active'));
                clickedReportTab.classList.add('active');
                
                Object.values(UIElements.reportTabPanes).forEach(content => {
                    if(content) content.classList.add('hidden');
                });
                
                const activeReportTab = clickedReportTab.dataset.reportTab;
                if (UIElements.reportTabPanes[activeReportTab]) {
                    UIElements.reportTabPanes[activeReportTab].classList.remove('hidden');
                }
                // Tenta gerar o relat√≥rio automaticamente se j√° tiver datas preenchidas
                if (UIElements.btnGerarRelatorio && UIElements.reportStartDate.value) {
                    UIElements.btnGerarRelatorio.click();
                }
                return;
            }
            */
            // --- 3. Bot√£o: Nova Transa√ß√£o Avulsa ---
            const btnAbrirNovaTransacao = target.closest('#btn-abrir-nova-transacao');
            if (btnAbrirNovaTransacao) {
                UIRenderer.abrirModal('novaTransacaoAvulsa', {});
                return;
            }

            // --- 4. Bot√£o: Adicionar Nova Conta/Cart√£o (Formul√°rio) ---
            const btnAdicionarConta = target.closest('#btn-adicionar-conta');
            if (btnAdicionarConta) {
                const nome = UIElements.finNomeConta.value.trim();
                const tipo = UIElements.finTipoConta.value;
                const iconeSelect = UIElements.finIconeConta.value;
                const iconeUrl = UIElements.finIconeUrl.value.trim();
                const iconeFinal = iconeUrl ? iconeUrl : iconeSelect; 

                if (!nome) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha o Nome da conta.' });
                    return;
                }

                const novaConta = {
                    id: crypto.randomUUID(),
                    nome, tipo,
                    icone: iconeFinal
                };

                if (tipo === 'credito') {
                    const limite = Utils.parseMoeda(UIElements.finLimiteCartao.value);
                    const diaVencimento = parseInt(UIElements.finDiaVencimento.value);

                    if (limite <= 0) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Cart√µes de cr√©dito devem ter um Limite.' });
                        return;
                    }
                    if (!diaVencimento || diaVencimento < 1 || diaVencimento > 31) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'O Dia de Vencimento da Fatura deve ser entre 1 e 31.' });
                        return;
                    }
                    
                    novaConta.limite = limite;
                    novaConta.diaVencimento = diaVencimento;

                    // Cria a meta de Fatura associada
                    const dataVencFatura = new Date();
                    if (dataVencFatura.getDate() >= diaVencimento) {
                        dataVencFatura.setMonth(dataVencFatura.getMonth() + 1); 
                    }
                    dataVencFatura.setDate(diaVencimento);

                    const novaFatura = {
                        id: `FATURA_${novaConta.id}`,
                        descricao: `Fatura ${nome}`,
                        tipo: 'parcelamento', // Ou 'credito' dependendo da sua vers√£o base
                        bancoId: null,
                        valorTotal: 0,
                        dataVencimento: Utils.formatarDataParaChave(dataVencFatura),
                        incluirComoCustoDiario: false,
                        isLocked: true 
                    };
                    AppState.configuracoes.metasFinanceiras.push(novaFatura);

                } else {
                    // Se for conta normal, permite saldo inicial
                    const saldoInicial = Utils.parseMoeda(UIElements.finSaldoInicial.value);
                    if (saldoInicial > 0) {
                        AppState.historicoTransacoes.push({
                            id: crypto.randomUUID(), data: Date.now(),
                            contaId: novaConta.id, tipo: 'entrada',
                            valor: saldoInicial, descricao: 'Saldo inicial'
                        });
                    }
                }
                
                AppState.configuracoes.contasBancarias.push(novaConta);
                Storage.salvarConfiguracoes(); 
                UIRenderer.renderContasBancarias();
                
                // Limpa formul√°rio
                UIElements.finNomeConta.value = '';
                UIElements.finSaldoInicial.value = '';
                UIElements.finIconeUrl.value = ''; 
                UIElements.finIconeConta.value = 'default';
                UIElements.finTipoConta.value = 'corrente';
                UIElements.finLimiteCartao.value = '';
                UIElements.finDiaVencimento.value = '';
                
                // Reseta visibilidade dos campos
                UIElements.containerCamposConta.classList.remove('hidden');
                UIElements.containerCamposCredito.classList.add('hidden');
                return;
            }

            // --- 5. L√≥gica Visual: Mostrar/Ocultar campos de Conta/Cr√©dito no form ---
            if (e.target.id === 'fin-modal-tipo-conta') {
                const tipo = e.target.value;
                UIElements.containerCamposConta.classList.toggle('hidden', tipo === 'credito');
                UIElements.containerCamposCredito.classList.toggle('hidden', tipo !== 'credito');
                return;
            }

            // =========================================================================
            // 6. A√á√ïES NOS CARDS (EXTRATO / EXCLUIR / EDITAR / TRANSFERIR)
            // =========================================================================
            
            const btnExtrato = target.closest('.btn-ver-extrato-conta') || target.closest('.card-conta-bancaria');
            const btnExcluir = target.closest('.btn-excluir-conta');
            const btnEditar = target.closest('.btn-editar-conta');
            const btnTransferir = target.closest('.btn-abrir-transferencia');

            // --- ABRIR EXTRATO (COM CORRE√á√ÉO DE SEGURAN√áA TRY-CATCH) ---
            if (btnExtrato) {
                // Evita conflito se houver bot√µes aninhados (seguran√ßa)
                if (target.closest('.btn-editar-conta') || target.closest('.btn-abrir-transferencia')) return;

                const idConta = btnExtrato.getAttribute('data-id');
                if (!idConta) return;

                // 1. Busca apenas o nome para o cabe√ßalho ficar bonito
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === idConta) || 
                              AppState.configuracoes.metasFinanceiras.find(m => m.id === idConta);

                // 2. Fecha outros modais para evitar sobreposi√ß√£o
                if (typeof UIRenderer.fecharModal === 'function') {
                    UIRenderer.fecharModal();
                }

                // 3. ABRE O MODAL SEM FILTRAR NADA
                // O segredo √© N√ÉO passar 'transacoes'. O case 'extratoConta' vai buscar sozinho.
                UIRenderer.abrirModal('extratoConta', { 
                    contaId: idConta, 
                    contaNome: conta ? conta.nome : 'Extrato Detalhado'
                });
                
                return;
            }

            // --- EXCLUIR CONTA ---
            if (btnExcluir) {
                const contaId = btnExcluir.dataset.id;
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);
                
                if (conta) {
                    UIRenderer.abrirModal('confirmacao', {
                        titulo: 'Excluir Conta?',
                        mensagem: `Tem certeza que deseja excluir a conta "${conta.nome}"?`,
                        callback: (confirmado) => {
                            if (confirmado) {
                                AppState.configuracoes.contasBancarias = AppState.configuracoes.contasBancarias.filter(c => c.id !== contaId);
                                // Se for cart√£o, remove a meta de fatura associada tamb√©m
                                if (conta.tipo === 'credito') {
                                    const faturaId = `FATURA_${conta.id}`;
                                    AppState.configuracoes.metasFinanceiras = AppState.configuracoes.metasFinanceiras.filter(m => m.id !== faturaId);
                                }
                                Storage.salvarConfiguracoes();
                                UIRenderer.renderContasBancarias();
                            }
                        }
                    });
                }
                return;
            }
            
            // --- EDITAR CONTA ---
            if (btnEditar) {
                const contaId = btnEditar.dataset.id;
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);
                if (conta) {
                    AppState.itemParaEditarId = contaId; 
                    UIRenderer.abrirModal('editarConta', { conta: conta });
                }
                return;
            }

            // --- ABRIR TRANSFER√äNCIA ---
            if (btnTransferir) {
                const contaId = btnTransferir.dataset.id;
                UIRenderer.abrirModal('novaTransferencia', { defaultOrigemId: contaId });
                return;
            }
            
            // --- 7. Gerar Relat√≥rios (Bot√£o Final) ---
            const btnGerarRelatorioMain = target.closest('#btn-gerar-relatorio');
            if (btnGerarRelatorioMain) {
                const startStr = UIElements.reportStartDate.value;
                const endStr = UIElements.reportEndDate.value;

                if (!startStr || !endStr) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Datas Inv√°lidas', mensagem: 'Por favor, selecione um per√≠odo v√°lido.' });
                    return;
                }

                const start = new Date(startStr + "T00:00:00");
                const end = new Date(endStr + "T23:59:59");
                
                if (end < start) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Datas Inv√°lidas', mensagem: 'A data final n√£o pode ser anterior √† inicial.' });
                    return;
                }

                // Identifica qual aba de relat√≥rio est√° ativa
                const activeReportTab = document.querySelector('.report-tab-button.active')?.dataset.reportTab;

                if (activeReportTab === 'dre') {
                    const dreData = BusinessLogic.gerarDRE(start, end);
                    UIRenderer.renderDRE(dreData);
                } else if (activeReportTab === 'livrocaixa') {
                    const livroCaixaData = BusinessLogic.gerarLivroCaixa(start, end);
                    UIRenderer.renderLivroCaixa(livroCaixaData);
                } else if (activeReportTab === 'mei') {
                    const meiData = BusinessLogic.gerarSimuladorMEI(start, end);
                    UIRenderer.renderSimuladorMEI(meiData);
                }
                
                return;
            }
        },
/*      
handleFinContentClick: (e) => {
            const target = e.target;
            
            // --- L√≥gica 1: Troca de Sub-Abas Principais (Receita, Custos, etc) ---
            const clickedSubTab = target.closest('.fin-tab-button');
            if (clickedSubTab) {
                UIElements.finTabButtons.forEach(t => t.classList.remove('active'));
                clickedSubTab.classList.add('active');
                Object.values(UIElements.finTabPanes).forEach(content => content.classList.add('hidden'));
                
                const activeTab = clickedSubTab.dataset.finTab;
                if (UIElements.finTabPanes[activeTab]) {
                    UIElements.finTabPanes[activeTab].classList.remove('hidden');
                }
                
                if (activeTab === 'bancos') {
                    UIRenderer.renderContasBancarias();
                }
                if (activeTab === 'custos') {
                    UIRenderer.renderConfiguracoes();
                    UIRenderer.renderContasRecorrentes();
                }
                if (activeTab === 'relatorios') {
                    if (UIElements.btnGerarRelatorio) {
                        // Opcional: Auto-gerar relat√≥rio ao abrir a aba
                        // UIElements.btnGerarRelatorio.click(); 
                    }
                }
                return; // Clique tratado
            }
            
            // --- L√≥gica 2: Troca de Sub-Abas de Relat√≥rios ---
            const clickedReportTab = target.closest('.report-tab-button');
            if (clickedReportTab) {
                UIElements.reportTabButtons.forEach(t => t.classList.remove('active'));
                clickedReportTab.classList.add('active');
                Object.values(UIElements.reportTabPanes).forEach(content => content.classList.add('hidden'));
                
                const activeReportTab = clickedReportTab.dataset.reportTab;
                if (UIElements.reportTabPanes[activeReportTab]) {
                    UIElements.reportTabPanes[activeReportTab].classList.remove('hidden');
                }
                if (UIElements.btnGerarRelatorio) {
                    UIElements.btnGerarRelatorio.click();
                }
                return; // Clique tratado
            }
            
            // --- L√≥gica 3: Abrir Modal de Nova Transa√ß√£o Avulsa ---
            const btnAbrirNovaTransacao = target.closest('#btn-abrir-nova-transacao');
            if (btnAbrirNovaTransacao) {
                UIRenderer.abrirModal('novaTransacaoAvulsa', {});
                return; // Clique tratado
            }

            // --- L√≥gica 4: Adicionar Conta (Bot√£o) ---
            const btnAdicionarConta = target.closest('#btn-adicionar-conta');
            if (btnAdicionarConta) {
                const nome = UIElements.finNomeConta.value.trim();
                const tipo = UIElements.finTipoConta.value;
                const iconeSelect = UIElements.finIconeConta.value;
                const iconeUrl = UIElements.finIconeUrl.value.trim();
                const iconeFinal = iconeUrl ? iconeUrl : iconeSelect; 

                if (!nome) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha o Nome da conta.' });
                    return;
                }

                const novaConta = {
                    id: crypto.randomUUID(),
                    nome, tipo,
                    icone: iconeFinal
                };

                if (tipo === 'credito') {
                    const limite = Utils.parseMoeda(UIElements.finLimiteCartao.value);
                    const diaVencimento = parseInt(UIElements.finDiaVencimento.value);

                    if (limite <= 0) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Cart√µes de cr√©dito devem ter um Limite.' });
                        return;
                    }
                    if (!diaVencimento || diaVencimento < 1 || diaVencimento > 31) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'O Dia de Vencimento da Fatura deve ser entre 1 e 31.' });
                        return;
                    }
                    
                    novaConta.limite = limite;
                    novaConta.diaVencimento = diaVencimento;

                    const dataVencFatura = new Date();
                    if (dataVencFatura.getDate() >= diaVencimento) {
                        dataVencFatura.setMonth(dataVencFatura.getMonth() + 1); 
                    }
                    dataVencFatura.setDate(diaVencimento);

                    const novaFatura = {
                        id: `FATURA_${novaConta.id}`,
                        descricao: `Fatura ${nome}`,
                        tipo: 'parcelamento',
                        bancoId: null,
                        valorTotal: 0,
                        dataVencimento: Utils.formatarDataParaChave(dataVencFatura),
                        incluirComoCustoDiario: false,
                        isLocked: true 
                    };
                    AppState.configuracoes.metasFinanceiras.push(novaFatura);

                } else {
                    const saldoInicial = Utils.parseMoeda(UIElements.finSaldoInicial.value);
                    if (saldoInicial > 0) {
                        AppState.historicoTransacoes.push({
                            id: crypto.randomUUID(), data: Date.now(),
                            contaId: novaConta.id, tipo: 'entrada',
                            valor: saldoInicial, descricao: 'Saldo inicial'
                        });
                    }
                }
                
                AppState.configuracoes.contasBancarias.push(novaConta);
                Storage.salvarConfiguracoes(); 
                UIRenderer.renderContasBancarias();
                
                UIElements.finNomeConta.value = '';
                UIElements.finSaldoInicial.value = '';
                UIElements.finIconeUrl.value = ''; 
                UIElements.finIconeConta.value = 'default';
                UIElements.finTipoConta.value = 'corrente';
                UIElements.finLimiteCartao.value = '';
                UIElements.finDiaVencimento.value = '';
                UIElements.containerCamposConta.classList.remove('hidden');
                UIElements.containerCamposCredito.classList.add('hidden');
                return; // Clique tratado
            }

            // --- L√≥gica 5: Mostrar/Ocultar campos de Conta/Cr√©dito ---
            if (e.target.id === 'fin-modal-tipo-conta') {
                const tipo = e.target.value;
                UIElements.containerCamposConta.classList.toggle('hidden', tipo === 'credito');
                UIElements.containerCamposCredito.classList.toggle('hidden', tipo !== 'credito');
                return; // Clique tratado
            }

            // --- L√≥gica 6: Lista de Contas (Bot√µes Excluir/Extrato/Editar) ---
            const btnExcluir = target.closest('.btn-excluir-conta');
            const btnExtrato = target.closest('.btn-ver-extrato-conta');
            const btnEditar = target.closest('.btn-editar-conta');

            if (btnExtrato) {
                const contaId = btnExtrato.dataset.id;
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);
                
                let faturaId = null;
                if (conta && conta.tipo === 'credito') {
                    faturaId = `FATURA_${conta.id}`;
                }
                
                const fatura = AppState.configuracoes.metasFinanceiras.find(m => m.id === (faturaId || contaId));
                
                let nomeExtrato, saldoFinalExtrato;
                let transacoes = [];

                if (conta && conta.tipo !== 'credito') {
                    nomeExtrato = conta.nome;
                    saldoFinalExtrato = BusinessLogic.calcularSaldoConta(contaId);
                    transacoes = AppState.historicoTransacoes.filter(t => 
                        t.contaId === contaId || 
                        (t.tipo === 'transferencia' && (t.origem.id === contaId || t.destino.id === contaId))
                    );
                } else if (fatura) {
                    nomeExtrato = fatura.descricao;
                    saldoFinalExtrato = BusinessLogic.calcularSaldoConta(fatura.id);
                    transacoes = AppState.historicoTransacoes.filter(t => t.contaId === fatura.id);
                }

                if (nomeExtrato) {
                    UIRenderer.abrirModal('extratoConta', {
                        contaId: fatura ? fatura.id : conta.id,
                        contaNome: nomeExtrato,
                        transacoes: transacoes,
                        saldoFinal: saldoFinalExtrato
                    });
                }
                return; // Clique tratado
            }

            if (btnExcluir) {
                const contaId = btnExcluir.dataset.id;
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);
                if (conta) {
                    UIRenderer.abrirModal('confirmacao', {
                        titulo: 'Excluir Conta?',
                        mensagem: `Tem certeza que deseja excluir a conta "${conta.nome}"? O saldo atual de ${Utils.formatarMoeda(BusinessLogic.calcularSaldoConta(contaId))} ser√° perdido.`,
                        callback: (confirmado) => {
                            if (confirmado) {
                                AppState.configuracoes.contasBancarias = AppState.configuracoes.contasBancarias.filter(c => c.id !== contaId);
                                if (conta.tipo === 'credito') {
                                    const faturaId = `FATURA_${conta.id}`;
                                    AppState.configuracoes.metasFinanceiras = AppState.configuracoes.metasFinanceiras.filter(m => m.id !== faturaId);
                                }
                                Storage.salvarConfiguracoes();
                                UIRenderer.renderContasBancarias();
                            }
                        }
                    });
                }
                return; // Clique tratado
            }
            
            if (btnEditar) {
                const contaId = btnEditar.dataset.id;
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);
                if (conta) {
                    AppState.itemParaEditarId = contaId; 
                    UIRenderer.abrirModal('editarConta', { conta: conta });
                }
                return; // Clique tratado
            }
            
            // --- L√≥gica 7: Gerar Relat√≥rios (DRE / Livro-Caixa / MEI) ---
            const btnGerarRelatorio = target.closest('#btn-gerar-relatorio');
            if (btnGerarRelatorio) {
                const start = new Date(UIElements.reportStartDate.value + "T00:00:00");
                const end = new Date(UIElements.reportEndDate.value + "T23:59:59");

                if (!UIElements.reportStartDate.value || !UIElements.reportEndDate.value || end < start) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Datas Inv√°lidas', mensagem: 'Por favor, selecione um per√≠odo v√°lido.' });
                    return;
                }
                
                const activeReportTab = document.querySelector('.report-tab-button.active').dataset.reportTab;

                if (activeReportTab === 'dre') {
                    const dreData = BusinessLogic.gerarDRE(start, end);
                    UIRenderer.renderDRE(dreData);
                } else if (activeReportTab === 'livrocaixa') {
                    const livroCaixaData = BusinessLogic.gerarLivroCaixa(start, end);
                    UIRenderer.renderLivroCaixa(livroCaixaData);
                } else if (activeReportTab === 'mei') {
                    const meiData = BusinessLogic.gerarSimuladorMEI(start, end);
                    UIRenderer.renderSimuladorMEI(meiData);
                }
                
                return; // Clique tratado
            }

            // --- 8. ABRIR TRANSFER√äNCIA (CORRIGIDO - MOVIDO PARA O ESCOPO PRINCIPAL) ---
            const btnTransferir = target.closest('.btn-abrir-transferencia');
            if (btnTransferir) {
                const contaId = btnTransferir.dataset.id;
                UIRenderer.abrirModal('novaTransferencia', { defaultOrigemId: contaId });
                return;
            }
            // --------------------------------------------------------------------------
            
        },
   
 */

   
        handleAbrirGestaoFinanceira: (options = {}) => {
            const defaultTab = options.defaultTab || 'contas';
            UIRenderer.abrirModal('gestaoFinanceira', {});
            
            if (defaultTab !== 'contas') {
                const modalContent = document.getElementById('gestaoFinanceiraModalContent');
                if (modalContent) {
                    modalContent.querySelector('.fin-modal-tab-button.active').classList.remove('active');
                    modalContent.querySelector('.fin-modal-tab-pane').classList.add('hidden');
                    modalContent.querySelector(`.fin-modal-tab-button[data-fin-tab="${defaultTab}"]`).classList.add('active');
                    document.getElementById(`fin-modal-tab-content-${defaultTab}`).classList.remove('hidden');
                }
            }
        },
        handleConfirmarDistribuicao: (e) => {
            const btn = e.target.closest('.btn-confirmar-distribuicao');
            if (!btn) return;

            const saldoMaximo = parseFloat(btn.dataset.saldoMax);
            const valor = Utils.parseMoeda(document.getElementById('dist-valor').value);
            const origemId = document.getElementById('dist-origem-id').value;
            const destinoId = document.getElementById('dist-destino-id').value;
            const descricao = document.getElementById('dist-descricao').value.trim() || 'Transfer√™ncia entre contas';

            if (valor <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Valor Inv√°lido', mensagem: 'O valor deve ser maior que zero.' });
                return;
            }
            if (valor > saldoMaximo) {
                UIRenderer.abrirModal('alerta', { titulo: 'Saldo Insuficiente', mensagem: `O valor excede o saldo dispon√≠vel de ${Utils.formatarMoeda(saldoMaximo)}.` });
                return;
            }
            if (!origemId || !destinoId) {
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Origem ou destino n√£o selecionados.' });
                return;
            }

            const nomeOrigem = AppState.configuracoes.metasFinanceiras.find(m => m.id === origemId)?.descricao;
            const nomeDestino = AppState.configuracoes.contasBancarias.find(c => c.id === destinoId)?.nome;

            // Cria a transa√ß√£o de Transfer√™ncia (Sa√≠da da Caixinha, Entrada no Banco)
            AppState.historicoTransacoes.push({
                id: crypto.randomUUID(),
                data: Date.now(),
                tipo: 'transferencia',
                valor: valor,
                descricao: descricao,
                origem: { tipo: 'caixinha', id: origemId, nome: nomeOrigem },
                destino: { tipo: 'conta', id: destinoId, nome: nomeDestino },
                jornadaId: null // Transfer√™ncia manual n√£o √© ligada a uma jornada
            });

            Storage.salvarConfiguracoes();
            UIRenderer.fecharModal();
            UIRenderer.render(); // Re-renderiza a lista de metas
            UIRenderer.renderContasBancarias(); // Re-renderiza a lista de contas
        },
        // --- IN√çCIO: SUPER-PASSO C (MODIFICADO) ---
        handleGestaoFinanceiraClicks: (e) => {
            const target = e.target;

            // 1. Troca de Sub-Abas internas do modal
            const clickedSubTab = target.closest('.fin-modal-tab-button');
            if (clickedSubTab) {
                const activeTab = clickedSubTab.dataset.finTab;
                const modalContent = target.closest('#gestaoFinanceiraModalContent');
                modalContent.querySelectorAll('.fin-modal-tab-button').forEach(t => t.classList.remove('active'));
                clickedSubTab.classList.add('active');
                modalContent.querySelectorAll('.fin-modal-tab-pane').forEach(content => content.classList.add('hidden'));
                document.getElementById(`fin-modal-tab-content-${activeTab}`).classList.remove('hidden');
                return true;
            }

            // 2. Adicionar nova Conta/Banco
            const btnAdicionarConta = target.closest('#btn-adicionar-conta');
            if (btnAdicionarConta) {
                const nome = document.getElementById('fin-modal-nome-conta').value.trim();
                const saldoInicial = Utils.parseMoeda(document.getElementById('fin-modal-saldo-inicial').value);
                const tipo = document.getElementById('fin-modal-tipo-conta').value;
                const icone = document.getElementById('fin-modal-icone-conta').value;

                if (!nome || !tipo) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha o Nome e o Tipo da conta.' });
                    return true;
                }

                const novaConta = {
                    id: crypto.randomUUID(),
                    nome, tipo, icone
                    // 'saldo' n√£o √© mais usado aqui
                };
                AppState.configuracoes.contasBancarias.push(novaConta);
                
                // Adiciona ao Extrato (Hist√≥rico de Transa√ß√µes)
                if (saldoInicial > 0) {
                    AppState.historicoTransacoes.push({
                        id: crypto.randomUUID(),
                        data: Date.now(),
                        contaId: novaConta.id,
                        tipo: 'entrada',
                        valor: saldoInicial,
                        descricao: 'Saldo inicial'
                    });
                }
                
                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.abrirModal('gestaoFinanceira', {}); // Reabre o modal atualizado
                return true;
            }
            
            // 3. Executar Transfer√™ncia (Caixinha -> Conta)
            const btnTransferir = target.closest('#btn-executar-transferencia');
            if (btnTransferir) {
                const valor = Utils.parseMoeda(document.getElementById('fin-modal-valor-transferir').value);
                const origemId = document.getElementById('fin-modal-origem-id').value;
                const destinoId = document.getElementById('fin-modal-destino-id').value;
                const descricao = document.getElementById('fin-modal-transf-desc').value.trim() || 'Transfer√™ncia';
                
                if (valor <= 0 || !origemId || !destinoId) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Verifique o valor, a origem e o destino.' });
                    return true;
                }
                
                const metaOrigem = AppState.configuracoes.metasFinanceiras.find(m => m.id === origemId);
                const contaDestino = AppState.configuracoes.contasBancarias.find(c => c.id === destinoId);

                if (!metaOrigem || !contaDestino) {
                     UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'N√£o foi poss√≠vel encontrar a origem ou destino.' });
                     return true;
                }
                
                // CALCULA O SALDO REAL
                const saldoOrigem = BusinessLogic.calcularSaldoConta(origemId);
                if (saldoOrigem < valor) {
                     UIRenderer.abrirModal('alerta', { titulo: 'Saldo Insuficiente', mensagem: `A caixinha "${metaOrigem.descricao}" (${Utils.formatarMoeda(saldoOrigem)}) n√£o tem saldo suficiente.` });
                     return true;
                }

                // Registra no Extrato
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: Date.now(),
                    tipo: 'transferencia',
                    valor: valor,
                    descricao: descricao,
                    origem: { tipo: 'caixinha', id: origemId, nome: metaOrigem.descricao },
                    destino: { tipo: 'conta', id: destinoId, nome: contaDestino.nome }
                });

                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.abrirModal('gestaoFinanceira', { defaultTab: 'distribuir' }); // Reabre na mesma aba
                return true;
            }

            // 4. Excluir Conta/Banco (PROTEGIDA)
            // EXCLUIR CONTA (BLINDAGEM)
            const btnExcluirConta = target.closest('.btn-excluir-conta');
            if (btnExcluirConta) {
                const contaId = btnExcluirConta.dataset.id;
                
                // BLINDAGEM 1: Contas do Sistema
                if (contaId.startsWith('AUTO_ID_')) {
                    UIRenderer.abrirModal('alerta', { 
                        titulo: 'A√ß√£o Proibida', 
                        mensagem: 'Esta √© uma conta nativa do sistema (Carteira/Reserva) e n√£o pode ser exclu√≠da.' 
                    });
                    return true;
                }
                
                // BLINDAGEM 2: Metas Autom√°ticas
                if (contaId === 'META_CUSTOS_MENSAIS') {
                     UIRenderer.abrirModal('alerta', { 
                        titulo: 'A√ß√£o Proibida', 
                        mensagem: 'Esta caixinha √© gerenciada automaticamente pelos seus Custos Fixos.' 
                    });
                    return true;
                }

                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);
                if (conta) {
                    const saldoConta = BusinessLogic.calcularSaldoConta(contaId);
                    UIRenderer.abrirModal('confirmacao', {
                        titulo: 'Excluir Conta Banc√°ria?',
                        mensagem: `Tem certeza que deseja excluir "${conta.nome}"? <br><b>Aten√ß√£o:</b> O saldo atual de ${Utils.formatarMoeda(saldoConta)} ser√° perdido e o hist√≥rico de transa√ß√µes ficar√° √≥rf√£o.`,
                        confirmLabel: "Sim, Excluir",
                        confirmClass: "bg-red-600 hover:bg-red-700",
                        callback: (confirmado) => {
                            if (confirmado) {
                                AppState.configuracoes.contasBancarias = AppState.configuracoes.contasBancarias.filter(c => c.id !== contaId);
                                
                                // Limpa faturas de cart√£o associadas
                                if (conta.tipo === 'credito') {
                                    const faturaId = `FATURA_${conta.id}`;
                                    AppState.configuracoes.metasFinanceiras = AppState.configuracoes.metasFinanceiras.filter(m => m.id !== faturaId);
                                }
                                
                                Storage.salvarConfiguracoes();
                                UIRenderer.fecharModal();
                                UIRenderer.renderContasBancarias();
                                UIRenderer.abrirModal('alerta', { titulo: 'Conta Exclu√≠da', mensagem: 'A conta foi removida com sucesso.', type: 'success' });
                            }
                        }
                    });
                }
                return true;
            }
            
            // 5. Ver Extrato
// üïµÔ∏è DEBUG LISTENER (Cole isso no seu addEventListener global)
        const btnExtrato = target.closest('.btn-ver-extrato-conta');
        if (btnExtrato) {
            const idNoBotao = btnExtrato.dataset.id;
            
            console.group('üîç RASTREIO CLIQUE EXTRATO');
            console.log('1. Bot√£o Clicado:', btnExtrato);
            console.log('2. ID Cru no HTML (data-id):', idNoBotao);

            // Tenta achar a conta na mem√≥ria
            const conta = AppState.configuracoes.contasBancarias.find(c => c.id === idNoBotao);
            console.log('3. Config da Conta encontrada:', conta);
            
            // Verifica se √© cr√©dito
            const isCredito = conta && conta.tipo === 'credito';
            console.log('4. √â Cart√£o de Cr√©dito?', isCredito);

            // ABRINDO O MODAL
            console.log('5. Enviando comando para UIRenderer.abrirModal...');
            
            // NOTA: N√£o estamos passando 'transacoes' aqui. Deixamos o Modal buscar.
            UIRenderer.abrirModal('extratoConta', { 
                contaId: idNoBotao, 
                contaNome: conta ? conta.nome : 'Conta',
                debugOrigem: 'Listener do RenderContas'
            });
            
            console.groupEnd();
            return true;
        }
        // 6. Abrir Transfer√™ncia (Bot√£o Direto da Lista)
            const btnTransferirLista = target.closest('.btn-abrir-transferencia');
            if (btnTransferirLista) {
                const origemId = btnTransferirLista.dataset.id;
                // Fecha o modal de gest√£o de contas
                UIRenderer.fecharModal();
                // Abre o modal de transfer√™ncia j√° configurado
                UIRenderer.abrirModal('novaTransferencia', { defaultOrigemId: origemId });
                return true;
            }
            
            return false;
        },
        // --- FIM: SUPER-PASSO C ---
        
        handleMetaTabClick: (e) => {
            const clickedTab = e.target.closest('.meta-tab-button');
            if (!clickedTab) return;
            const tabName = clickedTab.dataset.metaTab;
            
            [UIElements.metaTabAtivas, UIElements.metaTabManutencao, UIElements.metaTabConcluidas].forEach(tab => {
                if (tab) tab.classList.remove('active');
            });
            [UIElements.metaTabContentAtivas, UIElements.metaTabContentManutencao, UIElements.metaTabContentConcluidas].forEach(content => {
                if (content) content.classList.add('hidden');
            });

            clickedTab.classList.add('active');
            const activeContent = document.getElementById(`meta-tab-content-${tabName}`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
        },
        
        handleMetaSubTabClick: (e) => {
            const clickedSubTab = e.target.closest('.meta-sub-tab-button');
            if (!clickedSubTab) return;

            const subTabName = clickedSubTab.dataset.metaSubTab;
            const subTabs = UIElements.metaTabContentManutencao.querySelectorAll('.meta-sub-tab-button');
            subTabs.forEach(tab => tab.classList.remove('active'));
            const subContents = UIElements.metaTabContentManutencao.querySelectorAll('.scrollable-content');
            subContents.forEach(content => content.classList.add('hidden'));

            clickedSubTab.classList.add('active');
            const activeSubContent = document.getElementById(`meta-sub-tab-content-${subTabName}`);
            if (activeSubContent) {
                activeSubContent.classList.remove('hidden');
            }
        },
        
        handleToggleStatusView: () => {
            AppState.isStatusVisible = !AppState.isStatusVisible;
            localStorage.setItem('isStatusVisible_v6.4', JSON.stringify(AppState.isStatusVisible));
            UIRenderer.render();
            if (AppState.isStatusVisible) {
                EventHandlers.handleCategoriaChange();
            }
        },
// Essa fun√ß√£o captura quando voc√™ digita no campo de KM. Vamos adicionar o rec√°lculo nela.
/*         handleJornadaInputChange: () => {
            const jornada = BusinessLogic.getJornadaDoDia(new Date());
            jornada.kmInicial = parseFloat(UIElements.kmInicialInput.value) || null;
            jornada.kmFinal = parseFloat(UIElements.kmFinalInput.value) || null;
            const meta = parseFloat(UIElements.metaHorasInput.value);
            jornada.metaHoras = isNaN(meta) || meta <= 0 ? null : meta;
            if (jornada.metaHoras) jornada.metaAlcancadaNotificada = false;
            Storage.salvarJornadas();
            UIRenderer.render();
        },
        
         */
         
         handleJornadaInputChange: () => {
            const dataHoje = new Date();
            const chaveJornada = Utils.formatarDataParaChave(dataHoje);
            const jornada = BusinessLogic.getJornadaDoDia(dataHoje);
            
            // Captura os valores digitados
            jornada.kmInicial = parseFloat(UIElements.kmInicialInput.value) || null;
            jornada.kmFinal = parseFloat(UIElements.kmFinalInput.value) || null;

            // L√≥gica do olho (Status View) - Mantida original
            if (AppState.isStatusVisible) {
                // Se estiver vis√≠vel, salva e processa
            }

            // --- AQUI EST√Å A M√ÅGICA (V77) ---
            // For√ßa o rec√°lculo do custo (V46.1) baseado nos novos KMs digitados
            if (typeof BusinessLogic.recalcularCustosAbastecimentoJornada === 'function') {
                BusinessLogic.recalcularCustosAbastecimentoJornada(chaveJornada);
            }
            // --------------------------------

            Storage.salvarJornadas();
            UIRenderer.render(); // Atualiza a tela (incluindo o card Cobrir Custos)
        },
handleConfigInputChange: (e) => {
            // 1. Dias de Trabalho (PROTEGIDO)
            // N√£o lemos mais o input num√©rico para sobrescrever a config.
            // A config 'diasTrabalhoSemana' agora √© controlada apenas pelos bot√µes.
            const diasInput = UIElements.diasTrabalhoSemanaInput;
            if (diasInput && Array.isArray(AppState.configuracoes.diasTrabalhoSemana)) {
                diasInput.value = AppState.configuracoes.diasTrabalhoSemana.length;
            }

            // 2. Valores Monet√°rios
            AppState.configuracoes.proLabore = Utils.parseMoeda(UIElements.proLaboreInput.value);
            AppState.configuracoes.metaAutonoma = Utils.parseMoeda(UIElements.metaAutonomaInput.value);
            AppState.configuracoes.kmMetaDiaria = parseInt(UIElements.kmMetaDiariaInput.value) || 0;
            
            // 3. Dia do Pagamento (PROTEGIDO)
            const diaSalarioInput = document.getElementById('proLaboreDiaInput');
            if (diaSalarioInput) {
                let dia = parseInt(diaSalarioInput.value);
                if (!isNaN(dia)) {
                    if (dia < 1) dia = 1;
                    if (dia > 31) dia = 31;
                    AppState.configuracoes.diaPagamentoProLabore = dia;
                }
            }
            // Se o input n√£o existir (aba fechada), mant√©m o valor atual do AppState (n√£o zera).

// --- 4. SINCRONIZA META SAL√ÅRIO (COM TRAVA AUTOM√ÅTICA) ---
            const metaPL = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'AUTO_ID_PROLABORE');
            if (metaPL) {
                metaPL.valorTotal = AppState.configuracoes.proLabore;
                
                // SE TEM VALOR DEFINIDO, TORNA OBRIGAT√ìRIO
                if (metaPL.valorTotal > 0) {
                    metaPL.isObrigatorio = true;       // Trava o checkbox
                    metaPL.incluirComoCustoDiario = true; // For√ßa a inclus√£o
                } else {
                    // SE FOR ZERO, LIBERA E REMOVE
                    metaPL.isObrigatorio = false;
                    metaPL.incluirComoCustoDiario = false;
                }
            }
            // -----------------------------------------------------------

            // 5. Ve√≠culo e Deprecia√ß√£o
            const vidaUtilInput = UIElements.vidaUtilVeiculoInput.value.replace(',', '.');
            let vidaUtil = parseFloat(vidaUtilInput);
            if (isNaN(vidaUtil) || vidaUtil <= 0.1) vidaUtil = 5; 
            AppState.configuracoes.veiculo.vidaUtil = vidaUtil;
            
            AppState.configuracoes.veiculo.valor = Utils.parseMoeda(UIElements.valorVeiculoInput.value);
            AppState.configuracoes.veiculo.autonomia = Utils.parseMoeda(UIElements.autonomiaVeiculoInput.value);
            AppState.configuracoes.veiculo.combustivel = UIElements.tipoCombustivelSelect.value;
            
            // 6. Switches
            if (UIElements.usarGpsTracking) AppState.configuracoes.usarGpsTracking = UIElements.usarGpsTracking.checked;
            if (UIElements.incluirPrevisaoManutencao) AppState.configuracoes.incluirPrevisaoManutencao = UIElements.incluirPrevisaoManutencao.checked;
            if (UIElements.manterCalculoKmAntigo) AppState.configuracoes.manterCalculoKmAntigo = UIElements.manterCalculoKmAntigo.checked;
            
            // (Rateio Din√¢mico √© salvo pelos bot√µes da UI, n√£o precisa aqui)

            const cronoOpcao = document.querySelector('input[name="cronometroModo"]:checked');
            if (cronoOpcao) AppState.configuracoes.cronometroModo = cronoOpcao.value;
            
            const metodoOpcao = document.querySelector('input[name="metodoLeituraCombustivel"]:checked');
            if (metodoOpcao) AppState.configuracoes.metodoLeituraCombustivel = metodoOpcao.value;

            // 7. Perfil
            if (UIElements.reciboNomeMotorista) {
                AppState.configuracoes.perfilRecibo.nome = UIElements.reciboNomeMotorista.value.trim();
                AppState.configuracoes.perfilRecibo.documento = UIElements.reciboDocumento.value.trim();
                AppState.configuracoes.perfilRecibo.placa = UIElements.reciboPlacaVeiculo.value.trim();
            }
            if (UIElements.configTipoDeclaracao) {
                const tipo = UIElements.configTipoDeclaracao.value;
                AppState.configuracoes.perfilFiscal.tipo = tipo;
                AppState.configuracoes.perfilFiscal.meiPercentual = parseInt(UIElements.configMeiPercentual.value) || 16;
                UIElements.containerConfigMei.classList.toggle('hidden', tipo !== 'mei');
            }
        },
 
handleCurrencyInputChangeJornada: (e) => {
    const jornada = BusinessLogic.getJornadaDoDia(new Date());
    if (!jornada || jornada.status === 'inativa') return;

    // 1. Captura Inputs
    const newLitros = Utils.parseMoeda(UIElements.litrosAbastecidosInput.value) || 0;
    const newValor = Utils.parseMoeda(UIElements.valorAbastecidoInput.value) || 0;
    const newKm = UIElements.kmAbastecimentoInput
        ? parseInt(UIElements.kmAbastecimentoInput.value) || 0
        : 0;

    const inputLeitura = Utils.parseMoeda(UIElements.litrosRestantesInput.value) || 0;

    const metodo = AppState.configuracoes.metodoLeituraCombustivel || 'nivel';
    const combustivel = AppState.configuracoes.veiculo.combustivel?.toLowerCase() || '';
    const isEV = combustivel.includes('el√©trico');

    // 2. PROCESSAMENTO DA L√ìGICA DE CONVERS√ÉO
    let restanteCalculado = 0;
    let consumidoPainel = 0;

    if (metodo === 'consumo' && inputLeitura > 0) {
        // Usu√°rio informou o quanto FOI CONSUMIDO segundo o painel
        consumidoPainel = inputLeitura;

        // Busca o "n√≠vel antes" (√∫ltimo abastecimento do hist√≥rico)
        const anterior = BusinessLogic.findLastRefuelData(new Date()) || { litrosRestantes: 0 };
        const nivelAnterior = anterior.litrosRestantes || 0;

        // F√≥rmula do consumo:
        // restante = (restante anterior + abastecido agora) - consumido
        restanteCalculado = Math.max(0, (nivelAnterior + newLitros) - consumidoPainel);

    } else {
        // M√©todo N√≠vel (usu√°rio digitou quanto SOBROU diretamente)
        restanteCalculado = inputLeitura;
        consumidoPainel = 0;
    }

    // 3. SALVA NA JORNADA
    jornada.custos.abastecimento.litros = newLitros;
    jornada.custos.abastecimento.valor = newValor;
    jornada.custos.abastecimento.km = newKm;

    jornada.custos.abastecimento.litrosRestantes = restanteCalculado;
    AppState.configuracoes.litrosRestantes = restanteCalculado;

    jornada.custos.abastecimento.litrosConsumidosPainel = consumidoPainel;

    // Atualiza kmFinal caso o usu√°rio tenha digitado um maior
    if (newKm > (jornada.kmFinal || 0)) {
        jornada.kmFinal = newKm;
    }

    // 4. RE-C√ÅLCULO DA M√âDIA (agora com suporte ao consumoPainel)
    const mediaObj = BusinessLogic.calcularMediaConsumo(jornada, new Date());
    jornada.custos.abastecimento.mediaCalculada = mediaObj.media;

    // 5. SALVA LOCALMENTE
    Storage.salvarJornadas();
    Storage.salvarConfiguracoes();

    // 6. RE-RENDERIZA√á√ÉO DEBAOUNCE (segura para inputs)
    UIRenderer.renderResumoDia(jornada);

    // (Opcional ‚Äî Se quiser atualizar os pain√©is de forma suave)
    // setTimeout(() => UIRenderer.renderCustos(jornada), 50);
},
 
       handleCurrencyInputChangeConfig: (e) => {
            EventHandlers.handleConfigInputChange();
        },
  

  handleJornada: () => {
    // üîß PATCH 3: TRAVA DE RECURSIVIDADE (ANTI-LOOP)
    if (AppState._handleJornadaRodando) {
        console.warn("‚õî [SISTEMA] handleJornada j√° em execu√ß√£o. Ignorando chamada recursiva.");
        return;
    }
    AppState._handleJornadaRodando = true;

    try {
        console.group("üïπÔ∏è Motor de Fluxo: handleJornada");

        // 1. Tenta recuperar a jornada ativa da mem√≥ria
        let jornadaAtiva = BusinessLogic.getJornadaAtiva();
        
        // --- üßü AUTO-FIX: RESTAURA√á√ÉO P√ìS-F5 ---
        if (!jornadaAtiva) {
            const chaveHoje = Utils.getDataInputHoje();
            const jornadaNoDisco = AppState.jornadas[chaveHoje];
            
            if (jornadaNoDisco && (jornadaNoDisco.status === 'ativa' || jornadaNoDisco.status === 'em_pausa')) {
                console.warn("üßü [RESTORE] Recuperando jornada ativa do Storage...");
                
                AppState.activeJornadaChave = chaveHoje;
                AppState.jornadaAtiva = jornadaNoDisco;
                AppState.modo = 'jornada_ativa'; // üõ°Ô∏è Destrava bot√µes
                
                Storage.salvarJornadaAtiva();
                jornadaAtiva = jornadaNoDisco;

                if (typeof TimeManager !== 'undefined') TimeManager.iniciarCronometro(); 
                UIRenderer.render();
            }
        }
/*
        // 2. DECIS√ÉO DE FLUXO
        if (jornadaAtiva) {
            // =================================================
            // üõë BOT√ÉO VERMELHO: FLUXO DE FINALIZAR
            // =================================================
            console.log("-> Fluxo: Preparando Finaliza√ß√£o");
            
            let kmFinalMsg = '';
            if (!jornadaAtiva.kmFinal || jornadaAtiva.kmFinal <= 0) {
                const ultimoKm = BusinessLogic.getUltimoKmRegistrado();
                if (ultimoKm > 0) {
                    jornadaAtiva.kmFinal = ultimoKm;
                    kmFinalMsg = `KM Final sugerido: ${ultimoKm}`;
                }
            }
            
            let lucroDisponivel = 0;
            try {
                const resumo = BusinessLogic.calcularResumoDia(jornadaAtiva, new Date());
                const custosFixos = BusinessLogic.calcularCustosFixosDiarios(new Date());
                const metaObrigatoria = (resumo.custoVariavelTotal || 0) + (custosFixos.operacional || 0) + (custosFixos.proLaboreDiario || 0);
                lucroDisponivel = Math.max(0, (resumo.totalGanhosFinalizados || 0) - metaObrigatoria);
            } catch (e) { lucroDisponivel = 0; }

            UIRenderer.abrirModal('alocacaoMetas', {
                lucroDisponivel: lucroDisponivel,
                kmFinalAuto: kmFinalMsg
            });

        } else {
            // =================================================
            // ‚ñ∂Ô∏è BOT√ÉO VERDE/√ÇMBAR: INICIAR OU REABRIR
            // =================================================
            const jornadaHoje = BusinessLogic.getJornadaDoDia(new Date());

            if (jornadaHoje.status === 'inativa') {
                console.log("-> Fluxo: Iniciar Nova Jornada");
                // ... (L√≥gica de Iniciar mantida conforme original)
                const kmInicialManual = parseFloat(UIElements.kmInicialInput?.value) || 0;
                if (!kmInicialManual || kmInicialManual <= 0) {
                    UIRenderer.abrirModal('alerta', { titulo: 'KM Requerido', mensagem: 'Defina o KM inicial.' });
                    return;
                }
                BusinessLogic.iniciarJornada(); // Centraliza a l√≥gica no Manager
            } 
            
            // üîß PATCH 2: DESACOPLAMENTO DA REABERTURA
            else if (jornadaHoje.status === 'finalizada') {
                console.log("-> Fluxo: Jornada de hoje j√° finalizada. Aguardando a√ß√£o da UI (Bot√£o Reabrir).");
                // N√ÉO fazemos nada aqui. O bot√£o no renderControlesGerais cuidar√° disso.
            }
        }*/

    } catch (err) {
        console.error("‚ùå Erro no handleJornada:", err);
    } finally {
        console.groupEnd();
        // Libera a trava no pr√≥ximo tick para evitar loops
        setTimeout(() => { AppState._handleJornadaRodando = false; }, 0);
    }
},        


/*        
handleJornada: () => {
            // 1. Tenta recuperar a jornada ativa da mem√≥ria
            let jornadaAtiva = BusinessLogic.getJornadaAtiva();
            
            // --- AUTO-FIX: PROTE√á√ÉO CONTRA "ESTADO ZUMBI" ---
            // Se a mem√≥ria falhou (F5), mas existe uma jornada salva com data de hoje...
            if (!jornadaAtiva) {
                const chaveHoje = Utils.formatarDataParaChave(new Date());
                const jornadaHojenosDados = AppState.jornadas[chaveHoje];
                
                if (jornadaHojenosDados && (jornadaHojenosDados.status === 'ativa' || jornadaHojenosDados.status === 'em_pausa')) {
                    console.warn("üßü Sistema: Restaurando jornada ativa recuperada do disco...");
                    
                    AppState.activeJornadaChave = chaveHoje;
                    Storage.salvarJornadaAtiva();
                    jornadaAtiva = jornadaHojenosDados;

                    TimeManager.iniciarCronometro(); 
                    UIRenderer.render();
                }
            }
            // --------------------------------------------------

            if (jornadaAtiva) {
                // =================================================
                // üõë FLUXO DE FINALIZAR (ABRE MODAL DE ALOCA√á√ÉO)
                // =================================================
                
                let kmFinalMsg = '';
                // Preenchimento autom√°tico de KM se estiver vazio (usa o √∫ltimo registrado)
                if (!jornadaAtiva.kmFinal || jornadaAtiva.kmFinal <= 0) {
                    const ultimoKm = BusinessLogic.getUltimoKmRegistrado();
                    if (ultimoKm > 0) {
                        jornadaAtiva.kmFinal = ultimoKm;
                        Storage.salvarJornadas();
                        kmFinalMsg = `Seu KM Final foi preenchido automaticamente com ${jornadaAtiva.kmFinal} km.`;
                    }
                }
                
                let lucroDisponivel = 0;

                // C√°lculo Pr√©vio do Lucro (Para mostrar no Modal)
                try {
                    const chaveJornada = AppState.activeJornadaChave;
                    const dataDaJornada = chaveJornada ? new Date(chaveJornada + "T12:00:00") : new Date();
                    
                    const resumo = BusinessLogic.calcularResumoDia(jornadaAtiva, dataDaJornada);
                    const custosFixos = BusinessLogic.calcularCustosFixosDiarios(dataDaJornada);
                    
                    // Soma tudo que √© "Obrigat√≥rio" do dia para ver o que sobra
                    const metaObrigatoria = (resumo.custoVariavelTotal || 0) + 
                                          (custosFixos.operacional || 0) + 
                                          (custosFixos.proLaboreDiario || 0);
                                      
                    lucroDisponivel = Math.max(0, (resumo.totalGanhosFinalizados || 0) - metaObrigatoria);
                } catch (erro) {
                    console.error("Erro ao calcular lucro pr√©vio:", erro);
                    lucroDisponivel = 0; 
                }

                UIRenderer.abrirModal('alocacaoMetas', {
                    lucroDisponivel: lucroDisponivel,
                    kmFinalAuto: kmFinalMsg
                });

            } else {
                // =================================================
                // ‚ñ∂Ô∏è FLUXO DE INICIAR OU REABRIR
                // =================================================
                const jornadaHoje = BusinessLogic.getJornadaDoDia(new Date());

                if (jornadaHoje.status === 'inativa') {
                    // --- A. INICIAR NOVA JORNADA ---
                    const kmInicialManual = parseFloat(UIElements.kmInicialInput.value) || 0;
                    
                    if (!kmInicialManual || kmInicialManual <= 0) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Aten√ß√£o!', mensagem: 'Por favor, defina o KM inicial antes de come√ßar.' });
                        return;
                    }
                    
                    jornadaHoje.kmInicial = kmInicialManual;
                    jornadaHoje.status = 'ativa';
                    jornadaHoje.inicioJornada = Date.now();
                    jornadaHoje.tempoInativoAcumulado = 0;
                    jornadaHoje.kmProvisionado = 0;
                    
                    // Garante que o dia comece "limpo" (sem flag de pago)
                    jornadaHoje.custosFixosProvisionadosDia = null; 
                    
                    AppState.activeJornadaChave = Utils.formatarDataParaChave(new Date());
                    Storage.salvarJornadaAtiva();
                    Storage.salvarJornadas();
                    
                    TimeManager.iniciarCronometro();
                    
                    if (AppState.configuracoes.usarGpsTracking) {
                        jornadaHoje.kmGps = 0;
                        GpsTracker.startTracking(kmInicialManual);
                    }
                    UIRenderer.render();
                    
                    
                    } else if (jornadaHoje.status === 'finalizada') {
                // =================================================================
                // üõ°Ô∏è REABRIR JORNADA V6 (COM MARCA√á√ÉO SEM√ÇNTICA FORTE)
                // =================================================================
                UIRenderer.abrirModal('confirmacao', { 
                    titulo: 'Reabrir Jornada?', 
                    mensagem: 'Isso ir√° estornar os valores e invalidar o fechamento anterior. Confirma?', 
                    callback: (confirmado) => {
                        if (!confirmado) return;

                        try {
                            const chaveJornada = AppState.activeJornadaChave || Utils.formatarDataParaChave(new Date());
                            let totalEstornado = 0;

                            if (AppState.historicoTransacoes && Array.isArray(AppState.historicoTransacoes)) {
                                AppState.historicoTransacoes.forEach(t => {
                                    // Filtra transfer√™ncias DESTA jornada
                                    if (t.jornadaId === chaveJornada && 
                                       t.tipo === 'transferencia' && 
                                       t.contaId === 'AUTO_ID_CARTEIRA' && 
                                       !t.invalida) { // S√≥ processa se ainda for v√°lida

                                        const metaId = t.contaDestino || (t.destino ? t.destino.id : null);
                                        const descricaoSegura = t.descricao || '';

                                        // Ignora se j√° for um estorno
                                        if (metaId && !descricaoSegura.includes('Estorno')) {
                                            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                                            
                                            if (meta) {
                                                const valor = Number(t.valor) || 0;
                                                
                                                // 1. REVERTE O SALDO NA CAIXINHA (Para o Card principal)
                                                if (meta.tipo === 'parcelamento') {
                                                    meta.valorProvisionado = Math.max(0, (meta.valorProvisionado || 0) - valor);
                                                } else {
                                                    meta.valorAtual = (meta.valorAtual || 0) - valor;
                                                }

                                                // 2. INVALIDA√á√ÉO SEM√ÇNTICA (AQUI EST√Å A CORRE√á√ÉO REAL)
                                                // Transforma a transa√ß√£o antiga em "lixo l√≥gico"
                                                t.invalida = true;
                                                t.descricao = t.descricao + ' (Anulado)';
                                                
                                                // üî• INJE√á√ÉO DE METADADOS (Isso faz o V12 funcionar)
                                                t.isAjusteInterno = true; // O Porteiro barra isso
                                                t.categoria = 'Estorno';  // O Porteiro barra isso
                                                t.origem = 'ajuste';      // O Porteiro barra isso
                                                
                                                totalEstornado += valor;
                                            }
                                        }
                                    }
                                });
                            }

                            // 3. CRIA O ESTORNO PARA A CARTEIRA
                            if (totalEstornado > 0) {
                                AppState.historicoTransacoes.push({
                                    id: 'estorno-' + Date.now() + Math.floor(Math.random() * 1000),
                                    data: new Date().toISOString(),
                                    contaId: 'AUTO_ID_CARTEIRA',
                                    tipo: 'entrada',
                                    valor: totalEstornado,
                                    descricao: `Estorno de Reabertura`,
                                    
                                    // üî• ETIQUETA O ESTORNO TAMB√âM (Para n√£o contar como Faturamento)
                                    categoria: 'Estorno', 
                                    origem: 'ajuste',
                                    isAjusteInterno: true,
                                    
                                    jornadaId: chaveJornada,
                                    isCustoOperacional: false
                                });
                            }

                            // 4. RESET DO ESTADO
                            jornadaHoje.status = 'ativa';
                            jornadaHoje.fimJornada = null;
                            if (jornadaHoje.financeiroFinal) delete jornadaHoje.financeiroFinal;
                            if (jornadaHoje.custosFixosProvisionadosDia) delete jornadaHoje.custosFixosProvisionadosDia;

                            // 5. SALVA E ATUALIZA TUDO
                            Storage.salvarJornadas();
                            Storage.salvarConfiguracoes();
                            Storage.salvarTransacoes ? Storage.salvarTransacoes() : null; // Garante salvar as flags
                            
                            if (typeof TimeManager !== 'undefined') TimeManager.iniciarCronometro();
                            
                            // For√ßa re-renderiza√ß√£o global
                            UIRenderer.renderMetasFinanceiras ? UIRenderer.renderMetasFinanceiras() : null;
                            UIRenderer.render();

                            setTimeout(() => {
                                if (totalEstornado > 0) {
                                    alert(`üîì Jornada Reaberta com Sucesso!\n\n‚ôªÔ∏è R$ ${Utils.formatarMoeda(totalEstornado)} foram estornados das caixinhas para sua Carteira.`);
                                } else {
                                    alert('üîì Jornada reaberta.');
                                }
                            }, 100);

                        } catch (error) {
                            console.error("Erro reabertura:", error);
                            alert("Erro cr√≠tico na reabertura.");
                        }
                    }
                });
            }

            
            }
        },
*/
     handlePausa: () => {
            const jornada = BusinessLogic.getJornadaAtiva();
            if (!jornada) return;
            const agora = Date.now();

            if (jornada.status === 'ativa') {
                jornada.status = 'em_pausa';
                jornada.pausas.push({ inicio: agora, fim: null });
                if (AppState.isGpsTracking) {
                    GpsTracker.stopTracking();
                }
                AppState.isStatusVisible = true;
            } else if (jornada.status === 'em_pausa') {
                jornada.status = 'ativa';
                const ultimaPausa = jornada.pausas[jornada.pausas.length - 1];
                if(ultimaPausa) ultimaPausa.fim = agora;
                if (AppState.configuracoes.usarGpsTracking) {
                    const ultimoKm = jornada.kmFinal || jornada.kmInicial || 0;
                    GpsTracker.startTracking(ultimoKm);
                }
            }

            Storage.salvarJornadas();
            UIRenderer.render();
        },
        

        
        handleIniciarServico: () => {
            const jornada = BusinessLogic.getJornadaAtiva();
            if (!jornada) return;

            let estavaEmPausa = false;
            if (jornada.status === 'em_pausa') {
                EventHandlers.handlePausa();
                estavaEmPausa = true;
            }

            const valor = Utils.parseMoeda(UIElements.valorServicoInput.value);
            if (valor <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Valor Inv√°lido', mensagem: 'Por favor, insira um valor v√°lido e maior que zero.' });
                if (estavaEmPausa) EventHandlers.handlePausa();
                return;
            }
            
            let kmInicialServico;
            if (AppState.configuracoes.usarGpsTracking) {
                kmInicialServico = AppState.gpsCurrentOdometer;
            } else {
                kmInicialServico = parseFloat(UIElements.kmInicialServicoInput.value) || null;
            }

            const categoria = UIElements.categoriaServicoSelect.value;
            const subcategoria = UIElements.subcategoriaServicoSelect.value;
            
            if (subcategoria) {
                AppState.lastSubcategories[categoria] = subcategoria;
                Storage.salvarUltimaSubcategoria();
            }
			
            jornada.servicosEmAndamento.push({ 
                id: crypto.randomUUID(), 
                valor, 
                categoria: categoria,
                subcategoria: subcategoria,
                descricao: UIElements.descricaoServicoInput.value.trim(), 
                inicio: Date.now(),
                kmInicialServico: kmInicialServico,
                iniciadoEmPausa: estavaEmPausa
            });
            
            UIElements.valorServicoInput.value = '';
            UIElements.descricaoServicoInput.value = '';
            UIElements.kmInicialServicoInput.value = '';
            UIElements.categoriaServicoSelect.value = 'Corrida';
            UIElements.subcategoriaServicoSelect.value = '';
            UIElements.subcategoriaServicoContainer.classList.add('hidden');
            Storage.salvarJornadas();
            
            AppState.isStatusVisible = false;
            UIRenderer.render(); 

            if (UIElements.btnMostrarCustos) {
                setTimeout(() => {
                    UIElements.btnMostrarCustos.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 10);
            }
        },
        
        handleServicoRapido: () => {
            const jornada = BusinessLogic.getJornadaAtiva();
            if (!jornada) return;
            
            let estavaEmPausa = false;
            if (jornada.status === 'em_pausa') {
                EventHandlers.handlePausa();
                estavaEmPausa = true;
            }
            
            jornada.servicosEmAndamento.push({ 
                id: `servico-rapido-${crypto.randomUUID()}`, 
                valor: 0, 
                categoria: 'Corrida',
                subcategoria: '', 
                descricao: 'Servi√ßo R√°pido', 
                inicio: Date.now(),
                    kmInicialServico: AppState.configuracoes.usarGpsTracking 
                        ? AppState.gpsCurrentOdometer 
                        : (parseFloat(UIElements.kmInicialServicoInput.value) || null), // <--- CORRE√á√ÉO: L√™ o input
                iniciadoEmPausa: estavaEmPausa
            });
            
            UIElements.kmInicialServicoInput.value = '';
            AppState.isStatusVisible = false;
            UIRenderer.render(); 

            if (UIElements.btnMostrarCustos) {
                setTimeout(() => {
                    UIElements.btnMostrarCustos.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 10);
            }
            Storage.salvarJornadas();
        },
mudarDia: (direcao) => {
            // 1. Altera a data no objeto global
            AppState.dataSelecionada.setDate(AppState.dataSelecionada.getDate() + direcao);
            
            // 2. üõ°Ô∏è A BLINDAGEM: Sincroniza o isToday com a nova data
            const hoje = new Date();
            AppState.isToday = AppState.dataSelecionada.toDateString() === hoje.toDateString();
            
            // 3. Limpa o estado de visualiza√ß√£o para evitar lixo de mem√≥ria
            AppState.custosVisiveis = false;

            // 4. Renderiza tudo com a nova data selecionada
            UIRenderer.render();
        },    
/*        
        mudarDia: (direcao) => {
            AppState.dataSelecionada.setDate(AppState.dataSelecionada.getDate() + direcao);
            AppState.custosVisiveis = false;
            UIRenderer.render();
        },
        */ 
// --- EXCLUIR DIA (CORRE√á√ÉO: CHECK DE CANCELAR + LIMPEZA FINANCEIRA TOTAL) ---
        handleExcluirDia: () => {
            const chaveDia = Utils.formatarDataParaChave(AppState.dataSelecionada);
            
            if (!AppState.jornadas[chaveDia]) {
                UIRenderer.abrirModal('alerta', { titulo: 'Nada para excluir', mensagem: 'N√£o h√° registros neste dia.' });
                return;
            }
            
            UIRenderer.abrirModal('confirmacao', {
                titulo: 'Excluir Hist√≥rico do Dia?',
                mensagem: `Toda a jornada, atividades e <b>transa√ß√µes financeiras</b> do dia ${Utils.formatarDataParaDisplay(AppState.dataSelecionada)} ser√£o apagadas permanentemente.`,
                confirmLabel: 'Sim, Apagar Tudo',
                confirmClass: 'bg-red-600 hover:bg-red-700',
                callback: (confirmado) => {
                    // 1. CORRE√á√ÉO DO CANCELAR: Se n√£o confirmou, para tudo.
                    if (!confirmado) return;

                    // 2. CORRE√á√ÉO DO DRE (LIMPEZA EM CASCATA)
                    // Remove todas as transa√ß√µes financeiras vinculadas a este dia
                    const transacoesAntes = AppState.historicoTransacoes.length;
                    AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => t.jornadaId !== chaveDia);
                    const transacoesDepois = AppState.historicoTransacoes.length;
                    const removidos = transacoesAntes - transacoesDepois;

                    // 3. Remove a Jornada Operacional
                    delete AppState.jornadas[chaveDia];

                    // 4. Se estava ativa, reseta os estados globais
                    if (AppState.activeJornadaChave === chaveDia) {
                        AppState.activeJornadaChave = null;
                        Storage.salvarJornadaAtiva();
                        TimeManager.pararCronometro();
                        if (AppState.isGpsTracking) GpsTracker.stopTracking(); // Para o GPS tamb√©m
                    }

                    // 5. Salva Tudo e Renderiza
                    Storage.salvarJornadas();
                    Storage.salvarConfiguracoes(); // Importante: Salva o hist√≥rico financeiro limpo
                    
                    UIRenderer.render();
                    
                    // Feedback detalhado
                    UIRenderer.abrirModal('alerta', { 
                        titulo: 'Dia Exclu√≠do', 
                        mensagem: `Jornada removida.<br><b>${removidos}</b> lan√ßamentos financeiros foram limpos do DRE.`, 
                        type: 'success' 
                    });
                }
            });
        },
        
handleListaAtividades: (e) => {
            // === A. VERIFICA√á√ÉO: BOT√ÉO REMOVER B√îNUS (CARD VERDE) ===
            const btnRemoverTransacao = e.target.closest('.btn-excluir-transacao');
            if (btnRemoverTransacao) {
                e.preventDefault();
                const id = btnRemoverTransacao.dataset.id;
                if (typeof EventHandlers.handleExcluirTransacao === 'function') {
                    EventHandlers.handleExcluirTransacao(id);
                }
                return;
            }

            // === B. VERIFICA√á√ÉO: BOT√ïES DE ATIVIDADE (CARD AZUL) ===
            const btnEditar = e.target.closest('.btn-editar-atividade');
            const btnExcluir = e.target.closest('.btn-excluir-atividade');
            const btnExtra = e.target.closest('.btn-extra');

            const targetButton = btnEditar || btnExcluir || btnExtra;
            
            if (!targetButton) return;
            
            const atividadeId = targetButton.dataset.id;
            
            // >>> CORRE√á√ÉO DA VIRADA DE NOITE <<<
            // 1. Tenta achar no dia selecionado no calend√°rio
            let jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
            let atividade = jornada ? jornada.atividades.find(a => a.id === atividadeId) : null;

            // 2. Se n√£o achou, e existe uma jornada rodando (que pode ser de ontem), procura nela!
            if (!atividade && AppState.activeJornadaChave) {
                const jornadaAtiva = AppState.jornadas[AppState.activeJornadaChave];
                if (jornadaAtiva) {
                    const found = jornadaAtiva.atividades.find(a => a.id === atividadeId);
                    if (found) {
                        jornada = jornadaAtiva; // Atualiza a refer√™ncia da jornada
                        atividade = found;      // Atualiza a refer√™ncia da atividade
                        console.log("Atividade encontrada na Jornada Ativa (Dia anterior/Virada).");
                    }
                }
            }
            // ------------------------------------
            
            if (!atividade) {
                console.warn("Atividade n√£o encontrada em nenhum contexto.");
                return;
            }

            // A√á√ÉO EXTRA
            if (targetButton.classList.contains('btn-extra')) {
                AppState.itemParaEditarId = atividade.id; 
                UIRenderer.abrirModal('adicionarExtra', { atividadeId: atividade.id }); 
            } 
            // A√á√ÉO EXCLUIR
            else if (targetButton.classList.contains('btn-excluir-atividade') || targetButton.classList.contains('btn-excluir')) {
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Atividade?', 
                    mensagem: 'Deseja excluir este registro finalizado? O valor ser√° removido dos ganhos.',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (confirmado) => {
                        if (confirmado) {
                            jornada.atividades = jornada.atividades.filter(a => a.id !== atividade.id);
                            Storage.salvarJornadas();
                            if (typeof PromotionManager !== 'undefined') PromotionManager.recalcularTudo();
                            UIRenderer.render();
                        }
                    }
                });
            } 
            // A√á√ÉO EDITAR
            else if (targetButton.classList.contains('btn-editar-atividade') || targetButton.classList.contains('btn-editar')) {
                AppState.itemParaEditarId = atividade.id;
                // Importante: Passamos a atividade encontrada, n√£o importa de qual dia ela veio
                UIRenderer.abrirModal('edicaoAtividade', { titulo: 'Editar Atividade e KM', item: atividade });
            }
        },
// --- GERENCIAR CLIQUE NA LISTA DE CUSTOS (EXCLUIR COM BUSCA INTELIGENTE) ---
        handleListaCustosClick: (e) => {
            const target = e.target;
            const btnExcluir = target.closest('.btn-excluir-custo');
            const btnEditar = target.closest('.btn-editar-custo');

            // 1. L√ìGICA DE EXCLUS√ÉO (BLINDADA)
            if (btnExcluir) {
                const custoId = btnExcluir.dataset.id;
                const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
                const chaveDia = Utils.formatarDataParaChave(AppState.dataSelecionada);
                
                // Tenta encontrar o item visual para pegar os dados de busca
                const itemJornada = jornada.custos?.outros?.find(c => c.id === custoId);
                
                // Busca a transa√ß√£o financeira correspondente
                let txFinanceira = AppState.historicoTransacoes.find(t => t.id === custoId);
                
                // --- BUSCA INTELIGENTE (SMART MATCH) ---
                // Se n√£o achou pelo ID, tenta achar por compatibilidade (Valor + Descri√ß√£o + Data)
                if (!txFinanceira && itemJornada) {
                    txFinanceira = AppState.historicoTransacoes.find(t => 
                        t.jornadaId === chaveDia && 
                        t.tipo === 'saida' &&
                        Math.abs(t.valor - itemJornada.valor) < 0.01 && // Margem de erro de centavos
                        t.descricao === itemJornada.descricao
                    );
                }

                // Define dados para o alerta
                const valorParaReembolso = txFinanceira ? txFinanceira.valor : (itemJornada ? itemJornada.valor : 0);
                const descricaoItem = txFinanceira ? txFinanceira.descricao : (itemJornada ? itemJornada.descricao : "Item");
                const batchId = (txFinanceira && txFinanceira.detalhes) ? txFinanceira.detalhes.batchId : null;

                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Custo?',
                    mensagem: `Deseja excluir <b>"${descricaoItem}"</b>?<br>Isso limpar√° o <b>Roadmap</b>, <b>DRE</b> e  <b>devolver√° o saldo</b>.`,
                    confirmLabel: "Sim, Excluir Tudo",
                    confirmClass: "bg-red-600 hover:bg-red-700",
                    callback: (confirmado) => {
                        if (confirmado) {
                            // A) REMO√á√ÉO DO FINANCEIRO (A Fonte da Verdade)
                            if (batchId) {
                                // Se for lote, remove tudo
                                AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !t.detalhes || t.detalhes.batchId !== batchId);
                            } else if (txFinanceira) {
                                // Se achou a transa√ß√£o (pelo ID ou Smart Match), remove ela
                                AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => t.id !== txFinanceira.id);
                            } else {
                                // Caso extremo: N√£o achou financeiro, mas tem ID. Tenta limpar pelo ID original por seguran√ßa.
                                AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => t.id !== custoId);
                            }

                            // B) REMO√á√ÉO DA JORNADA (INTEGRADA COM FUEL SERVICE)
    const dataTransacao = new Date(transacao.data);
    const jornada = BusinessLogic.getJornadaDoDia(dataTransacao);

    if (isFuel) {
        // Usa o servi√ßo para remover litros, valor e recalcular m√©dia
        const litrosParaRemover = transacao.detalhes?.litros || 0;
        
        FuelService.sincronizarJornada(
            dataTransacao,
            litrosParaRemover,
            transacao.valor,
            0,   // N√£o removemos KM
            null, // N√£o alteramos leitura
            'remover'
        );
        console.log("FuelService: Abastecimento estornado da jornada.");
    } 
    else if (jornada && jornada.custos && jornada.custos.outros) {
        // Remo√ß√£o de custo vari√°vel comum
        jornada.custos.outros = jornada.custos.outros.filter(c => c.id !== id);
        Storage.salvarJornadas();
    }

                            // C) SALVA TUDO
                            Storage.salvarJornadas();
                            Storage.salvarConfiguracoes();

                            // D) REFRESH GERAL
                            UIRenderer.renderCustos(jornada);
                            UIRenderer.renderResumoDia(jornada);
                            UIRenderer.renderContasBancarias(); 
                            
                            // FOR√áA ATUALIZA√á√ÉO DO ROADMAP (Se estiver vis√≠vel)
                            if (AppState.dashboardState.isRoadmapVisible) {
                                // Pequeno delay para garantir que a renderiza√ß√£o pegue o estado novo
                                setTimeout(() => RoadmapRenderer.render(), 50);
                            } else {
                                UIRenderer.renderDashboard();
                            }

                            UIRenderer.abrirModal('alerta', { 
                                titulo: 'Limpeza Completa!', 
                                mensagem: `Custo removido do hist√≥rico e relat√≥rios.<br>Saldo restaurado.`, 
                                type: 'success' 
                            });
                        }
                    }
                });
                return;
            }

            // 2. L√ìGICA DE EDI√á√ÉO (MANTIDA)
            if (btnEditar) {
                const id = btnEditar.dataset.id;
                const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
                let item = jornada.custos.outros.find(c => c.id === id);
                
                // Tenta achar no financeiro se n√£o estiver na jornada
                if (!item) {
                    item = AppState.historicoTransacoes.find(t => t.id === id);
                }
                
                if (item) {
                    UIRenderer.abrirModal('edicaoCusto', { item });
                }
            }
        },

/* 
   handleToggleCustos: () => {
            AppState.custosVisiveis = !AppState.custosVisiveis;
            if (AppState.custosVisiveis) {
                UIElements.btnMostrarCustos.textContent = 'Ocultar Custos Di√°rios';
            } else {
                UIElements.btnMostrarCustos.textContent = AppState.isToday ? 'Registrar Custos Di√°rios' : 'Visualizar Custos Di√°rios';
            }
            UIRenderer.render();
        },
        
         */
         
         handleToggleCustos: (e) => {
            // 1. Previne refresh (Seguran√ßa Padr√£o agora)
            if (e) e.preventDefault();

            // 2. Inverte o estado
            AppState.custosVisiveis = !AppState.custosVisiveis;

            // 3. Renderiza√ß√£o Cir√∫rgica (S√≥ atualiza a parte de custos)
            // Isso √© muito melhor que UIRenderer.render() pois mant√©m o resto da tela quieto.
            const jornada = BusinessLogic.getJornadaAtiva();
            if (jornada) {
                UIRenderer.renderCustos(jornada);
            } else {
                // Fallback: Se n√£o achar jornada, a√≠ sim redesenha tudo
                UIRenderer.render(); 
            }
            },
// ============================================================================
// HANDLER: ADICIONAR CUSTO (V129 - DATA ECON√îMICA CORRETA)
// ============================================================================
handleAdicionarCusto: (e) => {
    if (e) e.preventDefault();

    const elDesc = UIElements.descricaoCustoInput;
    const elValor = UIElements.valorCustoInput;

    const descricao = elDesc?.value.trim();
    const valor = Utils.parseMoeda(elValor?.value);

    const categoria = document.getElementById('categoriaCustoVariavel')?.value || 'Outras Despesas';
    const subcategoria = document.getElementById('subcategoriaCustoVariavel')?.value.trim() || null;

    if (!descricao || valor <= 0) {
        UIRenderer.abrirModal('alerta', {
            titulo: 'Dados inv√°lidos',
            mensagem: 'Informe descri√ß√£o e valor v√°lido.'
        });
        return;
    }

    const jornada = BusinessLogic.getJornadaAtiva();

    // üß† DATA ECON√îMICA CORRETA
    let dataEconomica;

    if (jornada?.id && /^\d{4}-\d{2}-\d{2}$/.test(jornada.id)) {
        // Usa a data da jornada (MEIO-DIA = blindagem UTC)
        const [y, m, d] = jornada.id.split('-').map(Number);
        dataEconomica = new Date(y, m - 1, d, 12, 0, 0, 0).getTime();
    } else {
        // Fallback: hoje
        const agora = new Date();
        agora.setHours(12, 0, 0, 0);
        dataEconomica = agora.getTime();
    }

    UIRenderer.abrirModal('novaTransacaoAvulsa', {
        defaultTipo: 'saida',
        defaultValor: valor,
        defaultCategoria: categoria,
        defaultSubcategoria: subcategoria,
        defaultDescricao: descricao,
        defaultContaId: 'AUTO_ID_CARTEIRA',

        // ‚úÖ AQUI EST√Å A CURA
        defaultData: dataEconomica,

        isCustoOperacional: true,
        jornadaId: jornada ? jornada.id : null,
        context: jornada ? 'custo_jornada' : 'custo_operacional_avulso'
    });

    if (elDesc) elDesc.value = '';
    if (elValor) elValor.value = '';
    const elSub = document.getElementById('subcategoriaCustoVariavel');
    if (elSub) elSub.value = '';
},
    
/*          
  // ============================================================================
    // HANDLER: ADICIONAR CUSTO (V128 - CORRE√á√ÉO DE DATA: SEMPRE HOJE)
    // ============================================================================
    handleAdicionarCusto: (e) => {
        if(e) e.preventDefault();
        
        // 1. Captura os elementos
        const elDesc = UIElements.descricaoCustoInput || document.getElementById('descricaoCusto');
        const elValor = UIElements.valorCustoInput || document.getElementById('valorCusto');
        
        // 2. Leitura dos Valores
        const descricao = elDesc ? elDesc.value.trim() : '';
        const valorRaw = elValor ? elValor.value : '';
        const valor = Utils.parseMoeda(valorRaw);

        // Pega categoria e subcategoria injetados
        const elCategoria = document.getElementById('categoriaCustoVariavel');
        const elSub = document.getElementById('subcategoriaCustoVariavel');
        const categoria = elCategoria ? elCategoria.value : 'Outras Despesas';
        const subcategoria = elSub ? elSub.value.trim() : null;

        const jornada = BusinessLogic.getJornadaAtiva();
        
        // 3. Valida√ß√µes
        if (!descricao || valor <= 0) {
            UIRenderer.abrirModal('alerta', { 
                titulo: 'Dados Inv√°lidos', 
                mensagem: `Preencha a descri√ß√£o e um valor maior que zero.` 
            });
            return;
        }

        // üïí C√ÅLCULO DA DATA REAL (AGORA)
        // Isso garante que o modal abra com o dia de HOJE selecionado
        const dataAgora = new Date();
        dataAgora.setMinutes(dataAgora.getMinutes() - dataAgora.getTimezoneOffset());
        const timestampAgora = dataAgora.getTime();

        // 4. ABRE O MODAL (Passando a data correta)
        UIRenderer.abrirModal('novaTransacaoAvulsa', {
            defaultTipo: 'saida',
            defaultValor: valor,
            defaultCategoria: categoria,
            defaultSubcategoria: subcategoria,
            defaultDescricao: descricao,
            defaultContaId: 'AUTO_ID_CARTEIRA', 
            
            // ‚úÖ AQUI EST√Å A CORRE√á√ÉO:
            // Mandamos a data de hoje e pedimos para o modal usar ela
            defaultData: timestampAgora,
            
            // Flags vitais
            isCustoOperacional: true,
            
            // V√≠nculo l√≥gico (para saber que pertence √† jornada, mas sem estragar a data)
            jornadaId: jornada ? jornada.id : null, 
            context: jornada ? 'custo_jornada' : 'custo_operacional_avulso' 
        });

        // 5. Limpa a tela principal
        if(elDesc) elDesc.value = '';
        if(elValor) elValor.value = '';
        if(elSub) elSub.value = '';
    },       
   

    */
 /*        
// ============================================================================
    // HANDLER: ADICIONAR CUSTO (V127 - FLEX√çVEL: COM OU SEM JORNADA)
    // ============================================================================
    handleAdicionarCusto: (e) => {
        if(e) e.preventDefault();
        
        // 1. Captura os elementos
        const elDesc = UIElements.descricaoCustoInput || document.getElementById('descricaoCusto');
        const elValor = UIElements.valorCustoInput || document.getElementById('valorCusto');
        
        // 2. Leitura dos Valores
        const descricao = elDesc ? elDesc.value.trim() : '';
        const valorRaw = elValor ? elValor.value : '';
        const valor = Utils.parseMoeda(valorRaw);

        // Pega categoria e subcategoria injetados
        const elCategoria = document.getElementById('categoriaCustoVariavel');
        const elSub = document.getElementById('subcategoriaCustoVariavel');
        const categoria = elCategoria ? elCategoria.value : 'Outras Despesas';
        const subcategoria = elSub ? elSub.value.trim() : null;

        // =============================================================
        // üîì L√ìGICA FLEX√çVEL (V127)
        // Tentamos achar uma jornada ativa para vincular.
        // Se n√£o achar, PERMITIMOS o lan√ßamento mesmo assim (Despesa Administrativa/Avulsa)
        // =============================================================
        const jornada = BusinessLogic.getJornadaAtiva();
        
        // 3. Valida√ß√µes B√°sicas (Apenas de dados, n√£o de estado)
        if (!descricao || valor <= 0) {
            UIRenderer.abrirModal('alerta', { 
                titulo: 'Dados Inv√°lidos', 
                mensagem: `Preencha a descri√ß√£o e um valor maior que zero.` 
            });
            return;
        }

        // 4. ABRE O MODAL (Com intelig√™ncia de contexto)
        UIRenderer.abrirModal('novaTransacaoAvulsa', {
            defaultTipo: 'saida',
            defaultValor: valor,
            defaultCategoria: categoria,
            defaultSubcategoria: subcategoria,
            defaultDescricao: descricao,
            defaultContaId: 'AUTO_ID_CARTEIRA', 
            
            // Flags vitais
            isCustoOperacional: true,
            
            // Se tem jornada, vincula e marca contexto de jornada.
            // Se n√£o tem, manda ID nulo e contexto gen√©rico.
            jornadaId: jornada ? jornada.id : null, 
            context: jornada ? 'custo_jornada' : 'custo_operacional_avulso' 
        });

        // 5. Limpa a tela principal
        if(elDesc) elDesc.value = '';
        if(elValor) elValor.value = '';
        if(elSub) elSub.value = '';
    },

*/

/*    
handleAdicionarCusto: () => {
            // 1. Captura os dados da tela da jornada
            const descricao = UIElements.descricaoCustoInput.value.trim();
            const valor = Utils.parseMoeda(UIElements.valorCustoInput.value);
            
            // Pega categoria e subcategoria dos selects da tela
            const elCategoria = document.getElementById('categoriaCustoVariavel');
            const elSub = document.getElementById('subcategoriaCustoVariavel');
            const categoria = elCategoria ? elCategoria.value : 'Outro C. Vari√°vel';
            const subcategoria = elSub ? elSub.value.trim() : null;

            const jornada = BusinessLogic.getJornadaDoDia(new Date());
            
            // Valida√ß√µes b√°sicas
            if (jornada.status === 'inativa' || jornada.status === 'finalizada') {
                UIRenderer.abrirModal('alerta', { titulo: 'Jornada Inativa', mensagem: 'Abra a jornada para lan√ßar custos operacionais do dia.' });
                return;
            }

            if (!descricao || valor <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha a descri√ß√£o e um valor maior que zero.' });
                return;
            }

            // 2. ABRE O MODAL DE TRANSA√á√ÉO (PREENCHIDO)
            // Aqui est√° o segredo: passamos os dados para o modal gen√©rico
            UIRenderer.abrirModal('novaTransacaoAvulsa', {
                defaultTipo: 'saida',
                defaultValor: valor,
                defaultCategoria: categoria, // Passa Alimenta√ß√£o, Ve√≠culo, etc.
                defaultSubcategoria: subcategoria,
                defaultDescricao: descricao,
                defaultContaId: 'AUTO_ID_CARTEIRA', // Sugere Carteira, mas voc√™ pode mudar!
                
                // IMPORTANTE: Marca como Custo Operacional da Jornada Atual
                isCustoOperacional: true,
                jornadaId: AppState.activeJornadaChave,
                
                // Contexto para saber que veio da tela de Jornada
                context: 'custo_jornada' 
            });

            // 3. Limpa os campos da tela principal (pois agora vai continuar no modal)
            UIElements.descricaoCustoInput.value = '';
            UIElements.valorCustoInput.value = '';
            if (elSub) elSub.value = '';
        },

 */
  handleSalvarConfiguracoes: () => {
            EventHandlers.handleConfigInputChange();
            Storage.salvarConfiguracoes();
            SystemLog.success('Configura√ß√µes', 'Dados salvos no LocalStorage com sucesso.');
            UIRenderer.abrirModal('alerta', { titulo: 'Sucesso!', mensagem: 'Configura√ß√µes salvas.', type: 'success' });
            UIRenderer.render();
            const kmMetaDiaria = Utils.parseMoeda(UIElements.kmMetaDiariaInput.value) || 0;
            AppState.configuracoes.kmMetaDiaria = kmMetaDiaria;
        },
        
        
handleAdicionarCustoFixo: () => {
            // 1. Busca Inputs
            const descInput = document.getElementById('descricaoCustoFixo');
            const valorInput = document.getElementById('valorCustoFixo');
            const vencInput = document.getElementById('vencimentoCustoFixo');
            const catSelect = document.getElementById('categoriaCustoFixo');
            const subInput = document.getElementById('subcategoriaCustoFixo');

            const descricao = descInput ? descInput.value.trim() : '';
            const valor = valorInput ? Utils.parseMoeda(valorInput.value) : 0;
            const vencimento = vencInput ? (parseInt(vencInput.value) || 0) : 0;
            const categoria = catSelect ? catSelect.value : 'Outro C. Fixo';
            const subcategoria = subInput ? subInput.value.trim() : 'N/A';

            // 2. Valida√ß√£o
            if (!descricao || valor <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha a descri√ß√£o e um valor v√°lido.' });
                return;
            }
            if (vencimento < 1 || vencimento > 31) {
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Dia de Vencimento deve ser entre 1 e 31.' });
                return;
            }

            // 3. Adiciona
            AppState.configuracoes.custosFixos.push({ 
                id: crypto.randomUUID(), 
                descricao, valor, categoria, subcategoria, vencimento
            });

            // 4. Limpa Inputs
            if(descInput) descInput.value = '';
            if(valorInput) valorInput.value = '';
            if(vencInput) vencInput.value = '';
            if(subInput) subInput.value = '';

            // 5. ATUALIZA√á√ÉO CR√çTICA: Sincroniza com a Meta e Salva
            BusinessLogic.atualizarMetaCustosMensais(); // <--- O PULO DO GATO
            Storage.salvarConfiguracoes();
            
            // 6. Renderiza
            UIRenderer.renderListaCustosFixos();
            UIRenderer.render(); // Atualiza o Dashboard/Metas para mostrar o novo total
            
            // Mant√©m foco
            setTimeout(() => { if(descInput) descInput.focus(); }, 100);
        },
 
// SUBSTITUA A FUN√á√ÉO EXISTENTE POR ESTA:
handleAdicionarContaRecorrente: () => {
    const descricao = UIElements.contaRecorrenteDescricao.value.trim();
    const valor = Utils.parseMoeda(UIElements.contaRecorrenteValor.value);
    const vencimento = parseInt(UIElements.contaRecorrenteVencimento.value);
    const categoria = UIElements.contaRecorrenteCategoria.value;

    if (!descricao || valor <= 0) {
        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha a Descri√ß√£o e o Valor.' });
        return;
    }
    if (!vencimento || vencimento < 1 || vencimento > 31) {
        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'O Dia de Vencimento deve ser entre 1 e 31.' });
        return;
    }
    
    // --- L√ìGICA INTELIGENTE: INICIAR NO PR√ìXIMO M√äS ---
    const hoje = new Date();
    let dataUltimoPagamento = null;
    let mensagemExtra = '';

    // Se o dia do vencimento (ex: 10) for menor que o dia de hoje (ex: 25), 
    // assumimos que, no cadastro inicial, voc√™ quer ignorar o m√™s corrente.
    if (vencimento < hoje.getDate()) {
        // Cria uma data de "pagamento fict√≠cio" para o m√™s atual
        const dataFicticia = new Date(hoje.getFullYear(), hoje.getMonth(), vencimento);
        dataUltimoPagamento = Utils.formatarDataParaChave(dataFicticia);
        
        mensagemExtra = ' (Como a data j√° passou, o alerta come√ßar√° apenas no m√™s que vem).';
    }
    // --------------------------------------------------

    AppState.configuracoes.contasRecorrentes.push({
        id: crypto.randomUUID(),
        descricao, 
        valor, 
        vencimento, 
        categoria,
        dataUltimoPagamento: dataUltimoPagamento // <--- Salva a data calculada
    });
    
    Storage.salvarConfiguracoes();
    
    // Limpa o formul√°rio
    UIElements.contaRecorrenteDescricao.value = '';
    UIElements.contaRecorrenteValor.value = '';
    UIElements.contaRecorrenteVencimento.value = '';

    // For√ßa o render
    UIRenderer.render(); 
    UIRenderer.renderContasRecorrentes();
    
    // Feedback visual explicativo
    UIRenderer.abrirModal('alerta', { 
        titulo: 'Conta Adicionada', 
        mensagem: `Conta recorrente salva com sucesso.${mensagemExtra}`,
        type: 'success'
    });
},
     // --- FIM: SUPER-PASSO K (Corre√ß√£o B.A) ---
        
        handleSalvarAbastecimentoAnterior: () => {
            const newLitros = Utils.parseMoeda(UIElements.litrosAbastecidosInput.value);
            const newValor = Utils.parseMoeda(UIElements.valorAbastecidoInput.value);
            const newKm = UIElements.kmAbastecimentoInput ? parseInt(UIElements.kmAbastecimentoInput.value) : 0;

            if (newKm <= 0 || newLitros <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Incompletos', mensagem: 'Preencha o KM, Litros e Valor atuais para salvar como refer√™ncia anterior.' });
                return;
            }
            let dataAnterior = new Date(AppState.dataSelecionada);
            dataAnterior.setDate(dataAnterior.getDate() - 1);
            const jornadaOntem = BusinessLogic.getJornadaDoDia(dataAnterior);
            jornadaOntem.custos.abastecimento = { 
                litros: newLitros, 
                valor: newValor, 
                km: newKm 
            };
            Storage.salvarJornadas();
            UIRenderer.abrirModal('alerta', { 
                titulo: 'Sucesso!', 
                mensagem: `Os dados de abastecimento (KM: ${newKm}) foram salvos no dia ${Utils.formatarDataParaDisplay(dataAnterior)} como refer√™ncia. A m√©dia agora ser√° calculada.`, 
                type: 'success' 
            });
            UIRenderer.renderCustos(BusinessLogic.getJornadaDoDia(AppState.dataSelecionada));
        },
// ============================================================================
        // EXCLUS√ÉO TRANSACIONAL V42 (DESTRUIR -> RECONSTRUIR)
        // ============================================================================
        handleExcluirTransacao: (id) => {
            if (!confirm('Confirma a exclus√£o? Transa√ß√µes vinculadas (resgates/faturas/splits) tamb√©m ser√£o revertidas.')) return;

            const snapshotState = JSON.stringify({
                configuracoes: AppState.configuracoes,
                historicoTransacoes: AppState.historicoTransacoes,
                jornadas: AppState.jornadas
            });

            try {
                const txAlvo = AppState.historicoTransacoes.find(t => t.id === id);
                if (!txAlvo) return;

                let transacoesParaEstornar = [txAlvo];
                const batchId = txAlvo.detalhes?.batchId;
                
                if (batchId) {
                    transacoesParaEstornar = AppState.historicoTransacoes.filter(t => t.detalhes?.batchId === batchId);
                } else if (txAlvo.split_id) {
                    transacoesParaEstornar = AppState.historicoTransacoes.filter(t => t.split_id === txAlvo.split_id);
                }

                const idsParaRemover = transacoesParaEstornar.map(t => t.id);

                transacoesParaEstornar.forEach(tx => {
                    let banco = AppState.configuracoes.contasBancarias.find(c => c.id === tx.contaId);
                    if (!banco && (tx.contaId === 'carteira_motorista' || tx.contaId === 'AUTO_ID_CARTEIRA')) {
                        banco = AppState.configuracoes.contasBancarias.find(c => c.id === 'AUTO_ID_CARTEIRA') || 
                                AppState.configuracoes.contasBancarias.find(c => c.nome === 'Carteira');
                    }
                    if (banco) {
                        if (tx.tipo === 'entrada') banco.saldo = Utils.Money.subtract(banco.saldo, tx.valor);
                        else banco.saldo = Utils.Money.add(banco.saldo, tx.valor);
                    }

                    const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === tx.contaId);
                    if (meta) {
                        if (tx.tipo === 'entrada') { 
                            if (meta.tipo === 'parcelamento') meta.valorProvisionado = Utils.Money.subtract(meta.valorProvisionado, tx.valor);
                            else meta.valorAtual = Utils.Money.subtract(meta.valorAtual, tx.valor);
                        } else { 
                            if (meta.tipo === 'parcelamento') meta.valorProvisionado = Utils.Money.add(meta.valorProvisionado, tx.valor);
                            else meta.valorAtual = Utils.Money.add(meta.valorAtual, tx.valor);
                        }
                        if (meta.saidas) {
                            meta.saidas = meta.saidas.filter(s => s.id !== tx.id && (!batchId || s.batchId !== batchId));
                        }
                    }

                    if (String(tx.contaId).startsWith('FATURA_')) {
                        const idContaReal = tx.contaId.replace('FATURA_', '');
                        const alvosPossiveis = [
                            AppState.configuracoes.contasBancarias.find(c => c.id === idContaReal),
                            AppState.configuracoes.metasFinanceiras.find(m => m.id === tx.contaId)
                        ];
                        alvosPossiveis.forEach(alvo => {
                            if (alvo && alvo.comprasParceladas) {
                                const lenAntes = alvo.comprasParceladas.length;
                                alvo.comprasParceladas = alvo.comprasParceladas.filter(p => {
                                    if (batchId && p.batchId) return p.batchId !== batchId; 
                                    return p.id !== batchId && p.dataCompra !== tx.data; 
                                });
                                if (alvo.comprasParceladas.length < lenAntes) {
                                    try { if(BusinessLogic.recalcularProvisaoFatura) BusinessLogic.recalcularProvisaoFatura(alvo); } catch(e){}
                                }
                            }
                        });
                    }
                });

               // 4. LIMPEZA PREVENTIVA JORNADA (Destruir Fantasma T√©cnico e Visual)
                if (txAlvo.categoria === 'Abastecimento') {
                    const dataChave = Utils.formatarDataParaChave(new Date(txAlvo.data));
                    const jornadaId = txAlvo.jornadaId || dataChave;
                    const jornada = AppState.jornadas[jornadaId];
                    
                    if (jornada && jornada.custos) {
                        console.log("üßπ [Exclus√£o] Limpeza preventiva iniciada.");
                        
                        // Limpa t√©cnico
                        if (jornada.custos.abastecimento) delete jornada.custos.abastecimento;
                        
                        // Limpa visual (Espelho) - CR√çTICO PARA N√ÉO DEIXAR FANTASMA NO ROADMAP
                        if (jornada.custos.outros) {
                            jornada.custos.outros = jornada.custos.outros.filter(c => c.origem !== 'fuel_mirror');
                        }
                    }
                }

                // 5. REMO√á√ÉO BD
                AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !idsParaRemover.includes(t.id));

                // 6. REC√ÅLCULO JORNADA
                if (txAlvo.categoria === 'Abastecimento') {
                    const dataChave = Utils.formatarDataParaChave(new Date(txAlvo.data));
                    const jornadaId = txAlvo.jornadaId || dataChave;
                    BusinessLogic.recalcularCustosAbastecimentoJornada(jornadaId);
                }

                // 7. LIMPEZA OUTROS
                if (txAlvo.categoria !== 'Abastecimento') {
                    const dataTx = new Date(typeof txAlvo.data === 'number' ? txAlvo.data : txAlvo.data);
                    const jornada = BusinessLogic.getJornadaDoDia(dataTx);
                    if (jornada && jornada.custos && jornada.custos.outros) {
                        const idsDoBatch = new Set(idsParaRemover);
                        jornada.custos.outros = jornada.custos.outros.filter(c => !idsDoBatch.has(c.id));
                    }
                }

                AppState.configuracoes.contasBancarias.forEach(b => {
                    if (typeof b.saldo === 'number' && !Number.isFinite(b.saldo)) throw new Error(`[AUDIT] Saldo inv√°lido em ${b.nome}`);
                });

                Storage.salvarConfiguracoes();
                Storage.salvarJornadas();
                if (Storage.salvarHistoricoTransacoes) Storage.salvarHistoricoTransacoes();
                else localStorage.setItem('historicoTransacoes_v6.4', JSON.stringify(AppState.historicoTransacoes));

                UIRenderer.render();
                if (UIRenderer.renderContasBancarias) UIRenderer.renderContasBancarias();
                if (UIRenderer.renderMetasFinanceiras) UIRenderer.renderMetasFinanceiras();
                if (UIRenderer.renderHistoricoTransacoes) UIRenderer.renderHistoricoTransacoes();
                if (EventHandlers.renderFuelHistoryList) EventHandlers.renderFuelHistoryList();

                const toast = document.createElement('div');
                toast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-lg z-50';
                toast.textContent = 'Transa√ß√£o revertida com sucesso.';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);

            } catch (erro) {
                console.error("[EXCLUS√ÉO ROLLBACK] Erro fatal:", erro);
                const backup = JSON.parse(snapshotState);
                AppState.configuracoes = backup.configuracoes;
                AppState.historicoTransacoes = backup.historicoTransacoes;
                AppState.jornadas = backup.jornadas;
                Storage.salvarConfiguracoes();
                Storage.salvarJornadas();
                if (Storage.salvarHistoricoTransacoes) Storage.salvarHistoricoTransacoes();
                alert("Erro cr√≠tico. Altera√ß√µes revertidas.\n" + erro.message);
                UIRenderer.render();
            }
        },

handleListaCustosFixos: (e) => {
            const btn = e.target.closest('button'); 
            if (!btn) return;
            
            const id = btn.dataset.id;
            
            // EXCLUIR COM CONFIRMA√á√ÉO
            if (btn.classList.contains('btn-excluir-custo-fixo')) {
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Custo Fixo?',
                    mensagem: 'Deseja remover este custo fixo mensal? Isso afetar√° o c√°lculo da meta mensal.',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (confirmado) => {
                        if (confirmado) {
                            AppState.configuracoes.custosFixos = AppState.configuracoes.custosFixos.filter(c => c.id !== id);
                            BusinessLogic.atualizarMetaCustosMensais();
                            Storage.salvarConfiguracoes();
                            UIRenderer.render(); // Atualiza tudo
                        }
                    }
                });
                return;
            } 
            
            // EDITAR
            if (btn.classList.contains('btn-editar-custo-fixo')) {
                const custo = AppState.configuracoes.custosFixos.find(c => c.id === id);
                if (custo) {
                    UIRenderer.abrirModal('edicaoCustoFixo', { titulo: 'Editar Custo Fixo', item: custo });
                }
            }
        },   
handleAdicionarSubcategoria: () => {
            // Pega os valores que j√° estavam nos inputs da config
            const catPai = UIElements.subcategoriaPaiSelect.value;
            const nome = UIElements.subcategoriaDescricaoInput.value;
            
            // --- CORRE√á√ÉO: PEGA A COR TAMB√âM ---
            const cor = UIElements.subcategoriaCorInput.value; 
            // -----------------------------------
            
            UIRenderer.abrirModal('salvarSubcategoria', {
                categoriaPai: catPai,
                nomeAtual: nome,
                iconeAtual: '',
                corAtual: cor, // <--- PASSA A COR PARA O MODAL
                isEdicao: false
            });
        },

handleListaSubcategorias: (e) => {
            const btnExcluir = e.target.closest('.btn-excluir-subcategoria');
            const btnEditar = e.target.closest('.btn-editar-subcategoria');

            if (btnExcluir) {
                const cat = btnExcluir.dataset.cat;
                const subcatNome = btnExcluir.dataset.nome;

                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Subcategoria?',
                    mensagem: `Tem certeza que deseja excluir "${subcatNome}"? O hist√≥rico antigo ser√° mantido, mas n√£o aparecer√° nas novas op√ß√µes.`,
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (confirmado) => {
                        if (confirmado) {
                            const subcategorias = AppState.configuracoes.subcategorias;
                            if (subcategorias[cat]) {
                                // Filtra removendo o item (suporta string e objeto)
                                subcategorias[cat] = subcategorias[cat].filter(s => (typeof s === 'string' ? s : s.nome) !== subcatNome);
                                Storage.salvarConfiguracoes();
                                UIRenderer.renderSubcategorias();
                                EventHandlers.handleCategoriaChange(); // Atualiza select da jornada
                            }
                        }
                    }
                });
                return;
            }

// Substitua a parte do btnEditar dentro de handleListaSubcategorias:
            if (btnEditar) {
                const cat = btnEditar.dataset.cat;
                const nome = btnEditar.dataset.nome;
                const lista = AppState.configuracoes.subcategorias[cat] || [];
                const item = lista.find(s => (typeof s === 'string' ? s : s.nome) === nome);
                
                const iconeAtual = (typeof item === 'object') ? item.icone : '';
                const corAtual = (typeof item === 'object') ? item.cor : '#818cf8'; // <--- PEGA A COR

                UIRenderer.abrirModal('salvarSubcategoria', {
                    categoriaPai: cat,
                    nomeAtual: nome,
                    iconeAtual: iconeAtual,
                    corAtual: corAtual, // <--- PASSA A COR
                    isEdicao: true
                });
            }
        },
        
// --- FUN√á√ïES QUE ESTAVAM FALTANDO PARA O SIMULADOR ---
        
        recalcularValorAlvoModal: (meses) => {
            if (meses <= 0) meses = 1;
            
            const context = AppState.modalContext;
            // Verifica se o contexto √© v√°lido
            if (!context || context.type !== 'criarCaixinhaAmortizacao') return;

            const { dataRef, i_anual, parcelas, metaDividaId } = context;
            const schedule = AppState.currentScheduleModal;
            
            // Recupera os n√∫meros das parcelas selecionadas
            // (Se vier como string "1, 2, 3", converte para array de n√∫meros)
            const selectedNums = (typeof parcelas === 'string') 
                ? parcelas.split(', ').map(n => parseInt(n)) 
                : [];

            // 1. Calcula a Data Alvo (daqui a X meses)
            const dataAlvo = Utils.addMonths(new Date(dataRef), meses);
            
            // 2. Calcula o PV na Data Alvo (Valor Futuro necess√°rio)
            const r_daily = Math.pow(1 + i_anual / 100, 1 / 365) - 1;
            const pvFuturo = Utils.pvOfSelected(schedule, selectedNums, dataAlvo, r_daily, true);

            // 3. Atualiza a UI do Modal (Texto din√¢mico)
            const displayMeses = document.getElementById('display-meses');
            const displayValor = document.getElementById('novo-valor-alvo-display');
            const btnConfirmar = document.getElementById('btn-confirmar-criacao-caixinha');

            if (displayMeses) displayMeses.textContent = meses;
            if (displayValor) displayValor.textContent = Utils.formatarMoeda(pvFuturo);
            
            // 4. Armazena os dados calculados no bot√£o de confirma√ß√£o para o clique
            if (btnConfirmar) {
                btnConfirmar.dataset.pvFuturo = pvFuturo;
                btnConfirmar.dataset.meses = meses;
            }
        },

// Adicione dentro de const EventHandlers = { ... }, antes de handleModalClick

handleSimuladorCriarMeta: () => {
            const btn = document.getElementById('btn-criar-meta-amortizacao');
            const inputTaxa = document.getElementById('simTaxaAnual'); // <--- CAPTURA A TAXA
            
            if (!btn || !btn.dataset.pv) {
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Dados da simula√ß√£o n√£o encontrados.' });
                return;
            }

            const pvHoje = parseFloat(btn.dataset.pv);
            const economia = parseFloat(btn.dataset.economia);
            const parcelas = btn.dataset.parcelas;
            const metaDividaId = AppState.itemParaEditarId; 
            const taxaAnual = inputTaxa ? parseFloat(inputTaxa.value) : 0; // <--- GUARDA O VALOR

            // Abre o modal e PASSA A TAXA JUNTO
            UIRenderer.abrirModal('criarCaixinhaAmortizacao', { 
                pvHoje: pvHoje, 
                economia: economia, 
                parcelas: parcelas,
                metaDividaId: metaDividaId,
                i_anual: taxaAnual // <--- ENVIA PARA O PR√ìXIMO MODAL
            });
            
            setTimeout(() => EventHandlers.recalcularValorAlvoModal(3), 100);
        },


handleModalClick: (e) => {
     const target = e.target.closest('button') || e.target;
    // --- REINSERINDO: SALVAR AJUSTE ---
            if (target.id === 'btn-salvar-ajuste-saldo') {
                const contaId = document.getElementById('ajuste-conta-id').value;
                const saldoAnterior = parseFloat(document.getElementById('ajuste-saldo-anterior').value);
                const inputNovo = document.getElementById('ajuste-novo-saldo');
                const novoSaldo = Utils.parseMoeda(inputNovo.value);

                if (isNaN(novoSaldo)) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Valor Inv√°lido', mensagem: 'Digite o valor correto.' });
                    return;
                }

                const diferenca = novoSaldo - saldoAnterior;

                if (Math.abs(diferenca) < 0.01) {
                    UIRenderer.fecharModal();
                    return;
                }

                // Cria a transa√ß√£o de corre√ß√£o (VERS√ÉO BLINDADA)
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: Date.now(),
                    contaId: contaId,
                    tipo: diferenca > 0 ? 'entrada' : 'saida',
                    valor: Math.abs(diferenca),
                    descricao: 'Ajuste manual de saldo',
                    categoria: 'Ajuste',
                    jornadaId: null,
                    
                    // üõ°Ô∏è TRAVAS DE SEGURAN√áA (O QUE FALTAVA)
                    isAjusteInterno: true,      // üëà Impede de aparecer no Card de GANHOS
                    isCustoOperacional: false,   // üëà Impede de aparecer no Card de CUSTOS
                    
                    // üïí SINCRONIZA√á√ÉO COM O FILTRO DE NAVEGA√á√ÉO
                    dataDia: new Date().setHours(0, 0, 0, 0) 
                });

                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.render();
                UIRenderer.renderContasBancarias(); 
                UIRenderer.renderMetasFinanceiras(); 

                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Saldo Corrigido', 
                    mensagem: `Novo saldo: ${Utils.formatarMoeda(novoSaldo)}.`, 
                    type: 'success' 
                });
                return;
            }
            
            // =================================================================
            // HANDLER DO BOT√ÉO SALVAR (BLINDADO CONTRA VALORES FANTASMAS)
            // =================================================================
            if (target.classList.contains('btn-salvar-alocacao')) {
                // 1. Trava imediata do bot√£o para evitar duplo clique
                target.disabled = true;
                target.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processando...`;

                const checkboxes = document.querySelectorAll('#modalContainer input[type="checkbox"]:checked');
                const { metasFinanceiras } = AppState.configuracoes;
                const jornadaAtiva = BusinessLogic.getJornadaAtiva(); 
                const chaveJornada = jornadaAtiva ? jornadaAtiva.id : Utils.formatarDataParaChave(new Date());
                
                if (!jornadaAtiva || !chaveJornada) { 
                    UIRenderer.fecharModal(); 
                    return; 
                }

                try {
                    // --- FUN√á√ïES AUXILIARES DE MATEM√ÅTICA SEGURA ---
                    const toCents = (v) => Math.round(Number(v) * 100);
                    const toMoney = (c) => c / 100;
                    
                    // 1. PREPARA√á√ÉO
                    const agora = new Date().toISOString(); // Usa ISO para garantir compatibilidade
                    
                    const transacoesParaGravar = []; 
                    const atualizacoesMetas = new Map();
                    const metasProcessadasIds = new Set(); 

                    const getSaldoMetaVirtual = (meta) => {
                        if (atualizacoesMetas.has(meta.id)) return atualizacoesMetas.get(meta.id).novoSaldo;
                        return (meta.tipo === 'parcelamento') ? (meta.valorProvisionado || 0) : (meta.valorAtual || 0);
                    };

                    const registrarTransferencia = (meta, valor, descricao) => {
                        if (valor < 0.01) return; // Ignora migalhas

                        const saldoAtualCents = toCents(getSaldoMetaVirtual(meta));
                        const valorCents = toCents(valor);
                        const novoSaldo = toMoney(saldoAtualCents + valorCents);
                        
                        atualizacoesMetas.set(meta.id, { 
                            metaRef: meta, 
                            novoSaldo: novoSaldo,
                            campo: (meta.tipo === 'parcelamento') ? 'valorProvisionado' : 'valorAtual'
                        });

                        transacoesParaGravar.push({ 
                            id: 'tx-' + Date.now() + Math.random().toString(36).substr(2, 9), 
                            data: agora, 
                            tipo: 'transferencia', 
                            valor: valor, 
                            descricao: descricao, 
                            contaId: 'AUTO_ID_CARTEIRA', // Origem
                            contaDestino: meta.id,       // Destino
                            jornadaId: chaveJornada 
                        });
                    };

                    // =================================================================
                    // 2. DEFINI√á√ÉO DO TETO REAL (C√ÅLCULO EM CENTAVOS)
                    // =================================================================
                    // Calcula saldo da carteira garantindo que venha num√©rico
                    const saldoCarteiraRaw = BusinessLogic.calcularSaldoConta('AUTO_ID_CARTEIRA') || 0;
                    
                    // Calcula ganhos apenas desta jornada
                    const ganhosReaisDoDia = AppState.historicoTransacoes
                        .filter(t => 
                            t.jornadaId === chaveJornada && 
                            t.tipo === 'entrada' && 
                            ['Corrida', 'Entrega', 'Gorjeta', 'Outro', 'Particular'].includes(t.categoria) &&
                            !String(t.descricao).includes('Estorno')
                        )
                        .reduce((acc, t) => acc + (Number(t.valor) || 0), 0);

                    const custosOperacionaisPagos = AppState.historicoTransacoes
                        .filter(t => 
                            t.jornadaId === chaveJornada && 
                            t.tipo === 'saida' && 
                            t.isCustoOperacional === true &&
                            t.contaId === 'AUTO_ID_CARTEIRA'
                        )
                        .reduce((acc, t) => acc + (Number(t.valor) || 0), 0);

                    // Matem√°tica em Centavos para precis√£o
                    const ganhosCents = toCents(ganhosReaisDoDia);
                    const custosCents = toCents(custosOperacionaisPagos);
                    const carteiraCents = toCents(saldoCarteiraRaw);
                    
                    const lucroLiquidoCents = Math.max(0, ganhosCents - custosCents);
                    
                    // O Saldo Dispon√≠vel √© o menor entre o Lucro e o que tem na Carteira
                    let saldoDispCents = Math.min(carteiraCents, lucroLiquidoCents);

                    console.log(`[Math] Carteira: ${carteiraCents}, Lucro: ${lucroLiquidoCents}, Disp: ${saldoDispCents}`);

                    // --- P0: REEMBOLSOS (Carteira paga para Conta Externa) ---
                    const custosExternos = AppState.historicoTransacoes.filter(t => 
                        t.jornadaId === chaveJornada && t.tipo === 'saida' && t.isCustoOperacional === true && t.contaId !== 'AUTO_ID_CARTEIRA'
                    );
                    
                    custosExternos.forEach(custo => { 
                        const custoValCents = toCents(custo.valor);
                        if (saldoDispCents >= custoValCents) { 
                            const contaDestino = AppState.configuracoes.contasBancarias.find(c => c.id === custo.contaId);
                            if (!contaDestino) return;

                            // Cria par de transa√ß√µes (Sai da Carteira -> Entra na Conta)
                            transacoesParaGravar.push(
                                {
                                    id: 'remb-s-' + Date.now() + Math.random(),
                                    data: agora, tipo: 'saida', valor: custo.valor,
                                    descricao: `Reembolso (${custo.descricao})`,
                                    contaId: 'AUTO_ID_CARTEIRA', isCustoOperacional: false, jornadaId: chaveJornada
                                },
                                {
                                    id: 'remb-e-' + Date.now() + Math.random(),
                                    data: agora, tipo: 'entrada', valor: custo.valor,
                                    descricao: `Reembolso custo operacional`,
                                    contaId: contaDestino.id, jornadaId: chaveJornada
                                }
                            );
                            saldoDispCents -= custoValCents;
                        }
                    });

                    // --- P1: MANUTEN√á√ÉO POR KM ---
                    const resumo = BusinessLogic.calcularResumoDia(jornadaAtiva, new Date());
                    const kmTotalDoDia = resumo.kmTotal || 0;
                    const kmNaoProvisionado = Math.max(0, kmTotalDoDia - (jornadaAtiva.kmProvisionado || 0));
                    
                    if (kmNaoProvisionado > 0) { 
                        metasFinanceiras.filter(m => m.tipo === 'poupanca_km' && m.valorPorKm > 0).forEach(meta => { 
                            const valorProvCents = Math.round(kmNaoProvisionado * meta.valorPorKm * 100);
                            const debitoCents = Math.min(saldoDispCents, valorProvCents);
                            
                            if (debitoCents > 0) { 
                                registrarTransferencia(meta, toMoney(debitoCents), `Prov. KM (${kmNaoProvisionado}km)`);
                                saldoDispCents -= debitoCents;
                                metasProcessadasIds.add(meta.id); 
                            } 
                        }); 
                    }

                    // --- P2: CUSTOS FIXOS OPERACIONAIS ---
                    if (jornadaAtiva.custosFixosProvisionadosDia !== chaveJornada) {
                        const metasCustos = metasFinanceiras.filter(meta => 
                            meta.incluirComoCustoDiario === true && 
                            meta.tipo !== 'poupanca_km' && 
                            meta.id !== 'AUTO_ID_PROLABORE'
                        );
                        
                        metasCustos.forEach(meta => {
                            const custoDiario = BusinessLogic.calcularCustoDiarioMeta(meta, new Date());
                            const custoCents = toCents(custoDiario);

                            if (custoCents > 0 && saldoDispCents > 0) {
                                const valorRealCents = Math.min(saldoDispCents, custoCents);
                                
                                const desc = meta.id === 'META_CUSTOS_MENSAIS' ? 'Prov. Custos Fixos' : `Prov. Di√°rio: ${meta.descricao}`;
                                registrarTransferencia(meta, toMoney(valorRealCents), desc);
                                
                                saldoDispCents -= valorRealCents;
                                metasProcessadasIds.add(meta.id); 
                            }
                        });
                    }

                    // --- P3: PR√ì-LABORE ---
                    if (saldoDispCents > 0) {
                        const metaSalario = metasFinanceiras.find(m => m.id === 'AUTO_ID_PROLABORE');
                        if (metaSalario && metaSalario.valorTotal > 0) {
                            const metaDoDia = BusinessLogic.calcularCustoDiarioMeta(metaSalario, new Date());
                            const metaCents = toCents(metaDoDia);
                            const valorPagarCents = Math.min(saldoDispCents, metaCents);
                            
                            if (valorPagarCents > 0) {
                                registrarTransferencia(metaSalario, toMoney(valorPagarCents), 'Pagamento Pr√≥-Labore');
                                saldoDispCents -= valorPagarCents;
                                metasProcessadasIds.add(metaSalario.id); 
                            }
                        }
                    }

                    // --- P4: METAS OPCIONAIS (CHECKBOXES) ---
                    // Agora processa tudo, mesmo que disabled
                    checkboxes.forEach(cb => {
                        const metaId = cb.dataset.id;
                        if (metasProcessadasIds.has(metaId)) return; // J√° foi pago nos passos anteriores

                        const valorAlocado = parseFloat(cb.dataset.custo || 0);
                        const valorAlocadoCents = toCents(valorAlocado);
                        const meta = metasFinanceiras.find(m => m.id === metaId);

                        if (meta && valorAlocadoCents > 0 && saldoDispCents > 0) {
                            const valorRealCents = Math.min(saldoDispCents, valorAlocadoCents);
                            registrarTransferencia(meta, toMoney(valorRealCents), `Aloca√ß√£o Extra: ${meta.descricao}`);
                            saldoDispCents -= valorRealCents;
                        }
                    });

                    // --- P5: RESERVA DE LUCRO (SOBRA) ---
                    if (saldoDispCents > 0) { 
                        const metaReserva = metasFinanceiras.find(m => m.id === 'AUTO_ID_RESERVA_LUCRO');
                        if (metaReserva) {
                            registrarTransferencia(metaReserva, toMoney(saldoDispCents), 'Lucro Excedente');
                        }
                    }
                    
                    // =========================================================
                    // 3. COMMIT E SALVAMENTO
                    // =========================================================

                    // Atualiza Saldos das Metas
                    atualizacoesMetas.forEach(update => {
                        const { metaRef, novoSaldo, campo } = update;
                        metaRef[campo] = novoSaldo;
                        
                        // Hist√≥rico interno da meta de custos mensais
                        if (metaRef.id === 'META_CUSTOS_MENSAIS') {
                            const totalEntrou = transacoesParaGravar
                                .filter(t => t.contaDestino === 'META_CUSTOS_MENSAIS') // Note: contaDestino √© string agora no registro
                                .reduce((sum, t) => sum + t.valor, 0);

                            if (totalEntrou > 0) {
                                if (!metaRef.historicoProvisao) metaRef.historicoProvisao = [];
                                metaRef.historicoProvisao = metaRef.historicoProvisao.filter(p => p.data !== chaveJornada);
                                metaRef.historicoProvisao.push({ id: crypto.randomUUID(), data: chaveJornada, valor: totalEntrou });
                            }
                        }
                    });
                    
                    // Salva Transa√ß√µes
                    AppState.historicoTransacoes.push(...transacoesParaGravar); 
                    
                    // Finaliza Jornada
                    jornadaAtiva.kmProvisionado = kmTotalDoDia;
                    jornadaAtiva.custosFixosProvisionadosDia = chaveJornada;
                    jornadaAtiva.status = 'finalizada'; 
                    jornadaAtiva.fimJornada = agora;
                    if(jornadaAtiva.servicosEmAndamento) jornadaAtiva.servicosEmAndamento = [];
                    
                    // Limpa Chaves
                    AppState.activeJornadaChave = null; 
                    
                    // PERSIST√äNCIA ROBUSTA (v6.4)
                    Storage.salvarJornadaAtiva(); // Remove a chave
                    Storage.salvarJornadas(); 
                    Storage.salvarConfiguracoes(); 
                    localStorage.removeItem('driver_app_jornada_ativa'); // Limpeza extra
                    
                    // UI
                    TimeManager.pararCronometro(); 
                    if (AppState.isGpsTracking && GpsTracker) GpsTracker.stopTracking();
                    
                    UIRenderer.fecharModal(); 
                    
                    // Feedback final
                    const totalDistribuido = transacoesParaGravar.reduce((acc, t) => acc + t.valor, 0);
                    alert(`Jornada Finalizada com Sucesso!\n\nForam distribu√≠dos ${Utils.formatarMoeda(totalDistribuido)}.`);
                    
                    location.reload();

                } catch (err) {
                    console.error("Erro cr√≠tico ao salvar:", err);
                    alert("Erro ao finalizar: " + err.message);
                    location.reload();
                }
                
                return;
            }
            

 
 //           console.log("üñ±Ô∏è [DEBUG] Click no Modal. Alvo:", target.id || target.className);
            // CORRE√á√ÉO: Captura o momento exato do clique (com segundos)
            const agora = new Date(); 
// SALVAR ABASTECIMENTO RETROATIVO (L√≥gica Completa)
            if (target.id === 'btn-salvar-retroativo') {
                const dataStr = document.getElementById('retro-data').value;
                const litros = Utils.parseMoeda(document.getElementById('retro-litros').value);
                const valor = Utils.parseMoeda(document.getElementById('retro-valor').value);
                const leitura = Utils.parseMoeda(document.getElementById('retro-leitura').value); // Novo campo
                const km = parseInt(document.getElementById('retro-km').value) || 0;

                if (!dataStr || litros <= 0 || valor <= 0) {
                     UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha Data, Litros e Valor.' });
                     return;
                }

                const dataObj = new Date(dataStr + "T12:00:00");
                const jornadaRetro = BusinessLogic.getJornadaDoDia(dataObj);
                
                // Atualiza dados b√°sicos
                // (Nota: Se j√° houver dados no dia, somamos os litros/valor, mas sobrescrevemos a leitura)
                const litrosAnt = jornadaRetro.custos.abastecimento.litros || 0;
                const valorAnt = jornadaRetro.custos.abastecimento.valor || 0;
                
                jornadaRetro.custos.abastecimento.litros = litrosAnt + litros;
                jornadaRetro.custos.abastecimento.valor = valorAnt + valor;
                if (km > 0) jornadaRetro.custos.abastecimento.km = km;

                // --- C√ÅLCULO DO TANQUE RESTANTE (RETROATIVO) ---
                const { metodoLeituraCombustivel } = AppState.configuracoes;
                let restanteFinal = 0;

                if (metodoLeituraCombustivel === 'consumo') {
                    // Precisa saber quanto tinha ANTES desse dia retroativo para subtrair o consumo
                    const anterior = BusinessLogic.findLastRefuelData(dataObj) || { litrosRestantes: 0 };
                    // Matem√°tica: (O que tinha antes + O que coloquei agora) - O que consumi
                    restanteFinal = Math.max(0, (anterior.litrosRestantes + litros) - leitura);
                    
                    // Salva o consumo do painel tamb√©m para refer√™ncia
                    jornadaRetro.custos.abastecimento.litrosConsumidosPainel = leitura;
                } else {
                    // M√©todo N√≠vel: O usu√°rio digitou quanto sobrou
                    restanteFinal = leitura;
                }
                
                jornadaRetro.custos.abastecimento.litrosRestantes = restanteFinal;
                // -----------------------------------------------
                
                // Recalcula a m√©dia desse dia retroativo (opcional, mas bom pra consist√™ncia)
                const mediaObj = BusinessLogic.calcularMediaConsumo(jornadaRetro, dataObj);
                jornadaRetro.custos.abastecimento.mediaCalculada = mediaObj.media;

                // Registra Transa√ß√£o
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: dataObj.getTime(),
                    contaId: 'AUTO_ID_CARTEIRA',
                    tipo: 'saida',
                    valor: valor,
                    descricao: `Abastecimento Retroativo (${litros}L)`,
                    categoria: 'Abastecimento',
                    isCustoOperacional: true,
                    jornadaId: Utils.formatarDataParaChave(dataObj)
                });

                Storage.salvarJornadas();
                Storage.salvarConfiguracoes();
                
                UIRenderer.fecharModal();
                UIRenderer.abrirModal('alerta', { titulo: 'Salvo!', mensagem: 'Abastecimento registrado. A refer√™ncia para m√©dias futuras foi atualizada.', type: 'success' });
                
                if (dataStr === Utils.getDataInputHoje()) {
                    UIRenderer.render();
                }
                return;
            } 
if (target.id === 'btn-configurar-retroativo') {
                const metaId = document.getElementById('simMetaId').value;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                if (meta) UIRenderer.abrirModal('configurarHistoricoRetroativo', { meta });
                return;
            }
            // ABRIR CONTESTA√á√ÉO
            if (target.closest('.btn-iniciar-contestacao')) {
                const btn = target.closest('.btn-iniciar-contestacao');
                const id = btn.dataset.id;
                const transacao = AppState.historicoTransacoes.find(t => t.id === id);
                
                if (transacao) {
                    // Fecha o extrato (para focar na contesta√ß√£o)
                    UIRenderer.fecharModal();
                    // Abre o modal de an√°lise
                    UIRenderer.abrirModal('analiseContestacao', { transacao });
                }
                return;
            }
// --- SALVAR VALOR EXTRA (NOVA L√ìGICA: CARD SEPARADO) ---
            if (target.id === 'btn-salvar-extra') {
                
                const atividadeIdEl = document.getElementById('input-atividade-id');
                const valorExtraEl = document.getElementById('input-valor-extra');

                if (!atividadeIdEl || !valorExtraEl) {
                     UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Erro ao identificar campos.' });
                     return;
                }

                const atividadeId = atividadeIdEl.value;
                const valorExtra = Utils.parseMoeda(valorExtraEl.value);

                // Busca a jornada do dia para pegar a data correta
                const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
                const atividade = jornada.atividades.find(a => a.id === atividadeId);

                if (atividade && valorExtra > 0) {
                    
                    // EM VEZ DE SOMAR NA ATIVIDADE, CRIAMOS UMA TRANSA√á√ÉO (CARD VERDE)
                    const novaTransacao = {
                        id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'extra_' + Date.now(),
                        data: Date.now(), // Hor√°rio de agora (vai aparecer no topo)
                        tipo: 'entrada',
                        categoria: 'Gorjeta', // Isso define o √≠cone de moeda/presente
                        contaId: 'AUTO_ID_CARTEIRA', // Importante: Isso diz ao sistema que √© dinheiro real (Gera o Card Verde)
                        valor: valorExtra,
                        descricao: `B√¥nus: Extra Manual (Referente √† corrida das ${new Date(atividade.fim).toLocaleTimeString().slice(0,5)})`,
                        jornadaId: Utils.formatarDataParaChave(new Date(jornada.data || Date.now()))
                    };

                    // Adiciona ao hist√≥rico financeiro
                    if (!AppState.historicoTransacoes) AppState.historicoTransacoes = [];
                    AppState.historicoTransacoes.push(novaTransacao);
                    
                    
                    
                    
                    
                    // Opcional: Adiciona uma marca√ß√£o na descri√ß√£o da corrida AZUL s√≥ para saber que teve extra (sem mudar valor)
                    if (!String(atividade.descricao).includes('‚≠ê')) {
                        atividade.descricao += ` ‚≠ê`;
                    }

                    // Salva e Atualiza
                    Storage.salvarJornadas(); 
                    // Se tiver a fun√ß√£o de salvar transa√ß√µes separada, chame-a, sen√£o o salvarJornadas costuma salvar tudo no seu app
                    // (Verifique se o seu Storage salva o historicoTransacoes. Se n√£o, adicione: 
                    localStorage.setItem('historicoTransacoes_v6.4', JSON.stringify(AppState.historicoTransacoes));

                    if (typeof PromotionManager !== 'undefined') PromotionManager.recalcularTudo();
                    
                    UIRenderer.fecharModal();
                    UIRenderer.render();
                    
                    UIRenderer.abrirModal('alerta', { 
                        titulo: 'Sucesso', 
                        mensagem: `Card de Extra no valor de ${Utils.formatarMoeda(valorExtra)} criado!`, 
                        type: 'success' 
                    });
                } else {
                    UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Valor inv√°lido.' });
                }
                return; 
            }
         
         // --- 0. SALVAR CONFIGURA√á√ÉO DE PROVISIONAMENTO (NOVO) ---
            if (target.id === 'btn-salvar-config-provisionamento') {
                const fixos = document.getElementById('prov-custos-fixos').checked;
                const prolabore = document.getElementById('prov-prolabore').checked;
                const metas = document.getElementById('prov-metas').checked;
                
                AppState.configuracoes.itensProvisionamento = {
                    incluirCustosFixos: fixos,
                    incluirProLabore: prolabore,
                    incluirMetas: metas
                };
                
                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.abrirModal('alerta', { titulo: 'Configurado!', mensagem: 'O provisionamento di√°rio foi atualizado conforme suas prioridades.', type: 'success' });
                UIRenderer.render(); 
                return;
            }
// 2. SALVAR PROMO√á√ÉO (L√ìGICA DE SOMA AUTOM√ÅTICA)
            if (target.id === 'btn-salvar-promo') {
                
                const getSafeValue = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
                const getSafeChecked = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };

                const promoId = getSafeValue('promo-id');
                const titulo = getSafeValue('promo-titulo') || 'Nova Campanha';
                const app = getSafeValue('promo-app');
                const tipo = getSafeValue('promo-tipo');
                const dataInicio = getSafeValue('promo-data-inicio');
                const dataFim = getSafeValue('promo-data-fim');
                const repetirDiariamente = getSafeChecked('promo-repetir-diariamente');
                
                const horarios = [];
                if (repetirDiariamente) {
                    const hIni = getSafeValue('promo-hora-inicio');
                    const hFim = getSafeValue('promo-hora-fim');
                    if (hIni && hFim) horarios.push({ inicio: hIni, fim: hFim });
                } else {
                    horarios.push({ inicio: '00:00', fim: '23:59' });
                }

                // --- LEITURA E CORRE√á√ÉO DAS FASES ---
                let fases = [];
                let metaAcumulada = 0;
                let ultimaMeta = 0;

                // 1. L√™ o que est√° na tela na ordem visual (linha 1, linha 2...)
                const linhas = document.querySelectorAll('.fase-row');
                
                linhas.forEach((row, index) => {
                    const qtdInput = row.querySelector('.input-fase-qtd');
                    const valorInput = row.querySelector('.input-fase-valor');
                    
                    if (qtdInput && valorInput) {
                        let q = parseInt(qtdInput.value);
                        const v = Utils.parseMoeda(valorInput.value);
                        
                        if (q > 0 && v > 0) {
                            // L√ìGICA INTELIGENTE DE SOMA (CORRE√á√ÉO UBER)
                            // Se a meta digitada (ex: 20) for menor que a meta anterior (ex: 60),
                            // assumimos que o usu√°rio quis dizer "+20" e somamos.
                            if (index > 0 && q < ultimaMeta) {
                                q = ultimaMeta + q; 
                            }
                            
                            fases.push({ qtd: q, valor: v });
                            ultimaMeta = q;
                        }
                    }
                });
                
                // Agora sim, ordenamos para garantir a consist√™ncia (60, 80...)
                fases.sort((a, b) => a.qtd - b.qtd);

                if (fases.length === 0) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Aten√ß√£o', mensagem: 'Adicione pelo menos uma fase v√°lida.' });
                    return;
                }

                const metaTotal = fases[fases.length - 1].qtd;
                const valorTotal = fases.reduce((acc, f) => acc + f.valor, 0); // Soma dos pr√™mios

                if (promoId && AppState.promocoesAtivas) {
                    AppState.promocoesAtivas = AppState.promocoesAtivas.filter(p => p.id !== promoId);
                }

                const dados = {
                    id: promoId || 'promo_' + Date.now(),
                    titulo, app, tipo: 'escalonada',
                    dataInicio, dataFim,
                    metaQtd: metaTotal,
                    valorObjetivo: valorTotal,
                    fases: fases,
                    horarios: horarios,
                    repetirDiariamente: repetirDiariamente,
                    regras: { metaQtd: metaTotal, valorObjetivo: valorTotal, fases: fases } 
                };

                PromotionManager.criarPromocao(dados);
                
                UIRenderer.fecharModal();
                setTimeout(() => {
                    UIRenderer.render(); 
                    UIRenderer.abrirModal('alerta', { 
                        titulo: 'Salvo!', 
                        mensagem: `Campanha salva com ${fases.length} fases (Meta Final: ${metaTotal}).`, 
                        type: 'success' 
                    });
                }, 100);
                
                return;
            }
     // --- BOT√ÉO "ANTECIPAR" (NO EXTRATO) ---
            if (target.classList.contains('btn-antecipar-parcela')) {
                UIRenderer.abrirModal('anteciparParcela', {
                    transacaoId: target.dataset.id,
                    valorTotal: parseFloat(target.dataset.valor),
                    numParcelas: parseInt(target.dataset.parcelas),
                    descricaoItem: target.dataset.descricao,
                    contaFaturaId: target.dataset.fatura 
                });
                return;
            }

            // --- CONFIRMAR ANTECIPA√á√ÉO ---
          
// Adicione onde escuta cliques no modal de Extrato
// (Como o extrato √© um modal, o listener pode ser global ou dentro da fun√ß√£o que gera a lista)
// A melhor forma √© capturar no 'click' global do documento ou do modalContainer se o bot√£o estiver l√°.
// EXCLUIR PROMO√á√ÉO
            if (target.classList.contains('btn-excluir-promo')) {
                const id = target.dataset.id;
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Excluir Campanha?',
                    mensagem: 'Deseja remover esta campanha? O hist√≥rico de b√¥nus j√° pagos ser√° mantido.',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (confirmado) => {
                        if (confirmado) {
                            AppState.promocoesAtivas = AppState.promocoesAtivas.filter(p => p.id !== id);
                            Storage.salvarConfiguracoes();
                            // Reabre o modal para atualizar a lista imediatamente
                            UIRenderer.abrirModal('gestaoPromocoes');
                        }
                    }
                });
                return;
            }


if (target.id === 'btn-confirmar-antecipacao') {
                const faturaId = document.getElementById('antecipar-fatura-id').value; // Este ID vem do bot√£o anterior? N√£o, precisa vir do input hidden
                // Espere, no passo 1 eu n√£o coloquei o ID da fatura no bot√£o.
                // Vamos corrigir isso pegando do contexto ou garantindo que o bot√£o tenha.
                
                // Vamos assumir que o modal foi aberto corretamente com os dados.
                const idTransacaoOriginal = document.getElementById('antecipar-transacao-id').value;
                const idFatura = document.getElementById('antecipar-fatura-id').value; // Corrigir passo 2 para ter esse input
                
                const valorPago = Utils.parseMoeda(document.getElementById('antecipar-valor-pagar').value);
                const fonteId = document.getElementById('antecipar-fonte-id').value;
                const qtdParcelas = document.getElementById('antecipar-qtd-parcelas').value;
                
                if (valorPago <= 0 || !fonteId) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha o valor e a fonte de pagamento.' });
                    return;
                }

                const fonte = AppState.configuracoes.contasBancarias.find(c => c.id === fonteId) || 
                              AppState.configuracoes.metasFinanceiras.find(m => m.id === fonteId);
                const nomeFonte = fonte ? (fonte.nome || fonte.descricao) : 'Origem Desconhecida';

                const dataAgora = Date.now();

                // 1. Sai o dinheiro da Conta/Caixinha (Pagamento Real)
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: dataAgora,
                    contaId: fonteId,
                    tipo: 'saida',
                    valor: valorPago,
                    descricao: `Antecipa√ß√£o Fatura: ${qtdParcelas}x item`, // Pode melhorar a descri√ß√£o pegando do item original
                    jornadaId: null
                });

                // 2. Entra na Fatura (Abatimento da D√≠vida)
                // Importante: Isso reduz o saldo devedor da fatura
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: dataAgora,
                    contaId: idFatura,
                    tipo: 'saida', // 'saida' na fatura reduz o saldo positivo (que representa d√≠vida) ou 'entrada' negativa?
                    // No seu sistema, compras s√£o 'entrada' na fatura (aumentam saldo). Pagamentos s√£o 'saida'.
                    valor: valorPago, 
                    descricao: `Pgto Antecipado (${qtdParcelas}x) via ${nomeFonte}`,
                    jornadaId: null
                });
                
                // 3. (Opcional) Marcar a transa√ß√£o original como "Antecipada" ou criar um v√≠nculo
                // Para simplicidade, apenas registramos o pagamento.

                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal(); // Fecha antecipa√ß√£o
                
                // Atualiza o extrato que estava por baixo (se poss√≠vel) ou fecha tudo
                UIRenderer.fecharModal(); // Fecha extrato para for√ßar refresh
                UIRenderer.render();
                UIRenderer.renderContasBancarias(); // Atualiza saldo da fatura visualmente
                
                UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Antecipa√ß√£o realizada e saldo da fatura atualizado.', type: 'success' });
                return;
            }
// --- 0. SALVAR CONFIGURA√á√ÉO DE PROVISIONAMENTO (CORRIGIDO) ---
            if (target.closest('#btn-salvar-config-provisionamento')) {
                const fixos = document.getElementById('prov-custos-fixos').checked;
                const prolabore = document.getElementById('prov-prolabore').checked;
                const metas = document.getElementById('prov-metas').checked;
                
                // Salva no estado global
                AppState.configuracoes.itensProvisionamento = {
                    incluirCustosFixos: fixos,
                    incluirProLabore: prolabore,
                    incluirMetas: metas
                };
                
                // Persiste no LocalStorage
                Storage.salvarConfiguracoes();
                
                // Feedback e Atualiza√ß√£o
                UIRenderer.fecharModal();
                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Configurado!', 
                    mensagem: 'O provisionamento di√°rio foi atualizado conforme suas prioridades.', 
                    type: 'success' 
                });
                
                // Recalcula a tela (Isso atualizar√° o valor do "Cobrir Custos" imediatamente)
                UIRenderer.render(); 
                return;
            }
// 1. SALVAR TRANSA√á√ÉO AVULSA
            if (target.closest('#btn-salvar-transacao-avulsa')) {
                const tipo = document.getElementById('trans-tipo').value;
                const valor = Utils.parseMoeda(document.getElementById('trans-valor').value);
                const contaId = document.getElementById('trans-conta-id').value;
                const categoria = document.getElementById('trans-categoria').value;
                const descricao = document.getElementById('trans-descricao').value.trim() || categoria;
                const dataSelecionada = document.getElementById('trans-data').value;
                const parcelas = parseInt(document.getElementById('trans-parcelas').value) || 1;

                // >>> CORRE√á√ÉO: CAPTURA O ID DA CONTA RECORRENTE PARA SINCRONIZAR <<<
                const idRecorrente = document.getElementById('trans-recorrente-id').value || null;

                const agora = new Date();
                const dataDaTransacao = new Date(dataSelecionada + 'T00:00:00');
                dataDaTransacao.setHours(agora.getHours());
                dataDaTransacao.setMinutes(agora.getMinutes());
                const dataTimestamp = dataDaTransacao.getTime();

                const jornadaIdVal = document.getElementById('trans-jornada-id').value || null;
                const isCustoOperacionalVal = document.getElementById('trans-is-custo-operacional').value === "true";

                if (valor <= 0 || !contaId || !dataSelecionada) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha o Tipo, Data, Valor e Conta.' });
                    return;
                }

                const contaSelecionada = AppState.configuracoes.contasBancarias.find(c => c.id === contaId);

                // L√ìGICA DE CART√ÉO DE CR√âDITO
                if (contaSelecionada && contaSelecionada.tipo === 'credito') {
                    if (tipo === 'saida') {
                        const faturaId = `FATURA_${contaId}`;
                        const faturaMeta = AppState.configuracoes.metasFinanceiras.find(m => m.id === faturaId);

                        if (!faturaMeta) {
                             UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Fatura n√£o encontrada.' });
                             return;
                        }

                        // Valida Limite
                        const saldoAtualFatura = BusinessLogic.calcularSaldoConta(faturaId);
                        const limiteTotal = contaSelecionada.limite || 0;
                        const disponivel = limiteTotal - saldoAtualFatura;

                        if (valor > disponivel) {
                            UIRenderer.abrirModal('alerta', { titulo: 'Compra Negada', mensagem: `Limite insuficiente.` });
                            return;
                        }

                        // 1. Registra na Fatura (Aumenta D√≠vida Total)
                        AppState.historicoTransacoes.push({
                            id: crypto.randomUUID(), data: dataTimestamp, contaId: faturaId,
                            tipo: 'entrada', valor: valor,
                            descricao: `${descricao} (${parcelas}x)`,
                            jornadaId: jornadaIdVal
                        });

                        // 2. Registra no Livro Caixa (Despesa Cont√°bil) e Cria Objeto para Sincroniza√ß√£o
                        const transacaoLivroCaixa = {
                            id: crypto.randomUUID(), data: dataTimestamp, contaId: 'LIVRO_CAIXA_DESPESA_CREDITO',
                            tipo: 'saida', valor: valor,
                            descricao: `${descricao} (C.C. ${contaSelecionada.nome})`,
                            categoria: categoria, jornadaId: jornadaIdVal, isCustoOperacional: isCustoOperacionalVal
                        };
                        AppState.historicoTransacoes.push(transacaoLivroCaixa);

                        // >>> SINCRONIZA√á√ÉO RECORRENTE (CR√âDITO) <<<
                        // Se veio de um alerta, avisa que foi pago
                        BusinessLogic.sincronizarPagamentoRecorrente(transacaoLivroCaixa, idRecorrente);

                        // 3. Intelig√™ncia de Provis√£o (Parcelas)
                        if (!faturaMeta.comprasParceladas) faturaMeta.comprasParceladas = [];

                        faturaMeta.comprasParceladas.push({
                            id: crypto.randomUUID(),
                            descricao: descricao,
                            valorTotal: valor,
                            parcelas: parcelas,
                            valorParcela: valor / parcelas,
                            dataCompra: dataTimestamp
                        });

                        BusinessLogic.recalcularProvisaoFatura(faturaMeta);

                    } else {
                        // Pagamento de Fatura (Cr√©dito/Estorno)
                         AppState.historicoTransacoes.push({
                            id: crypto.randomUUID(), data: dataTimestamp, contaId: `FATURA_${contaId}`,
                            tipo: 'saida', valor: valor, descricao: `Cr√©dito: ${descricao}`, jornadaId: jornadaIdVal
                        });
                    }
                } else {
                    // L√ìGICA DE CONTA NORMAL (D√©bito/Dinheiro)
                    if (tipo === 'saida' && BusinessLogic.calcularSaldoConta(contaId) < valor) {
                         UIRenderer.abrirModal('alerta', { titulo: 'Saldo Insuficiente', mensagem: 'Verifique o saldo da conta.' });
                         return;
                    }

                    // Cria Objeto da Transa√ß√£o
                    const novaTransacao = {
                        id: crypto.randomUUID(), data: dataTimestamp, contaId: contaId,
                        tipo: tipo, valor: valor, descricao: descricao, categoria: categoria,
                        jornadaId: jornadaIdVal, isCustoOperacional: isCustoOperacionalVal
                    };
                    AppState.historicoTransacoes.push(novaTransacao);

                    // >>> SINCRONIZA√á√ÉO RECORRENTE (D√âBITO) <<<
                    if (tipo === 'saida') {
                        BusinessLogic.sincronizarPagamentoRecorrente(novaTransacao, idRecorrente);
                    }
                }

                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.render();
                UIRenderer.renderContasBancarias();

                // >>> FOR√áA A ATUALIZA√á√ÉO DOS ALERTAS PARA SUMIR O AVISO IMEDIATAMENTE <<<
                const diaAtual = BusinessLogic.getJornadaDoDia(new Date());
                UIRenderer.renderAlertasContasRecorrentes(diaAtual);

                return;
            }
            // --- 2. EDI√á√ïES DE CADASTROS ---

            // Edi√ß√£o Custo Fixo
            if (target.classList.contains('btn-salvar-edicao-custo-fixo')) {
                const custoFixo = AppState.configuracoes.custosFixos.find(c => c.id === AppState.itemParaEditarId);
                
                if (custoFixo) {
                    const novoValor = Utils.parseMoeda(document.getElementById('editValor').value);
                    const novaDescricao = document.getElementById('editDescricao').value.trim();
                    const novoVencimento = parseInt(document.getElementById('editVencimento').value) || 0;
                    const novaCategoria = document.getElementById('editCategoriaCustoFixo').value;
                    const novaSubcategoria = document.getElementById('editSubcategoriaCustoFixo').value.trim() || 'N/A';

                    if (!novaDescricao || novoValor <= 0 || novoVencimento < 1) {
                         UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Preencha descri√ß√£o, valor e dia de vencimento v√°lido.' });
                         return;
                    }

                    // Atualiza objeto na mem√≥ria
                    custoFixo.valor = novoValor;
                    custoFixo.descricao = novaDescricao;
                    custoFixo.categoria = novaCategoria;
                    custoFixo.subcategoria = novaSubcategoria;
                    custoFixo.vencimento = novoVencimento;
                    
                    // Atualiza meta autom√°tica e salva
                    BusinessLogic.atualizarMetaCustosMensais();
                    Storage.salvarConfiguracoes();
                    
                    // Atualiza UI
                    UIRenderer.renderListaCustosFixos();
                    UIRenderer.render();
                    UIRenderer.fecharModal();
                }
                return;
            }

            // Edi√ß√£o Conta Recorrente
            if (target.classList.contains('btn-salvar-edicao-conta-recorrente')) {
                const conta = AppState.configuracoes.contasRecorrentes.find(c => c.id === AppState.itemParaEditarId);
                
                if (conta) {
                    const novaDescricao = document.getElementById('edit-recorrente-descricao').value.trim();
                    const novoValor = Utils.parseMoeda(document.getElementById('edit-recorrente-valor').value);
                    const novoVencimento = parseInt(document.getElementById('edit-recorrente-vencimento').value);
                    const novaCategoria = document.getElementById('edit-recorrente-categoria').value;

                    if (!novaDescricao || novoValor <= 0 || !novoVencimento) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Verifique os campos preenchidos.' });
                        return;
                    }

                    conta.descricao = novaDescricao;
                    conta.valor = novoValor;
                    conta.vencimento = novoVencimento;
                    conta.categoria = novaCategoria;

                    Storage.salvarConfiguracoes();
                    UIRenderer.renderContasRecorrentes();
                    
                    // Atualiza alertas na jornada
                    try {
                        const jornadaDoDia = BusinessLogic.getJornadaDoDia(new Date());
                        UIRenderer.renderAlertasJornada(jornadaDoDia);
                        UIRenderer.renderAlertasContasRecorrentes(jornadaDoDia);
                    } catch(e) { console.log('Erro ao atualizar alertas:', e); }
                }
                UIRenderer.fecharModal();
                return;
            }

            // Edi√ß√£o Conta Banc√°ria (COM SALVAMENTO DO V√çNCULO)
            if (target.closest('.btn-salvar-edicao-conta')) {
                const conta = AppState.configuracoes.contasBancarias.find(c => c.id === AppState.itemParaEditarId);
                
                if (conta) {
                    const nome = document.getElementById('edit-conta-nome').value.trim();
                    const tipo = document.getElementById('edit-conta-tipo').value;
                    const iconeUrl = document.getElementById('edit-conta-icone-url').value.trim();
                    const iconeSelect = document.getElementById('edit-conta-icone').value;

                    if (!nome) {
                        UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'O nome da conta n√£o pode ficar em branco.' });
                        return;
                    }
                    
                    conta.nome = nome;
                    conta.tipo = tipo;
                    conta.icone = iconeUrl ? iconeUrl : iconeSelect; 

                    if (conta.tipo === 'credito') {
                        conta.limite = Utils.parseMoeda(document.getElementById('edit-conta-limite-cartao').value);
                        conta.diaVencimento = parseInt(document.getElementById('edit-conta-dia-vencimento').value) || 1;
                        
                        // üÜï NOVA L√ìGICA: SALVAR O V√çNCULO COM O BANCO
                        const vinculoSelect = document.getElementById('edit-conta-vinculada');
                        conta.contaVinculadaId = vinculoSelect ? vinculoSelect.value : null;
                    } else {
                        // Se mudou de cr√©dito para outro tipo, remove o v√≠nculo e limite
                        delete conta.contaVinculadaId;
                        delete conta.limite;
                        delete conta.diaVencimento;
                    }

                    Storage.salvarConfiguracoes();
                    UIRenderer.fecharModal();
                    UIRenderer.renderContasBancarias();
                }
                return; 
            }
            // Edi√ß√£o Custo Vari√°vel (Jornada)
            if (target.id === 'btn-salvar-edicao-custo') {
                const item = AppState.historicoTransacoes.find(t => t.id === target.dataset.id);
                if (item) {
                    const desc = document.getElementById('edit-custo-descricao').value.trim();
                    const val = Utils.parseMoeda(document.getElementById('edit-custo-valor').value);
                    if (!desc || val <= 0) { UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Dados inv√°lidos.' }); return; }
                    
                    item.descricao = desc; 
                    item.valor = val;
                    item.categoria = document.getElementById('edit-custo-categoria').value;
                    item.subcategoria = document.getElementById('edit-custo-subcategoria').value.trim();
                    
                    Storage.salvarConfiguracoes();
                    UIRenderer.fecharModal();
                    
                    const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
                    UIRenderer.renderCustos(jornada);
                    UIRenderer.renderResumoDia(jornada);
                    UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Custo atualizado.', type: 'success' });
                }
                return;
            }

            // Edi√ß√£o Plano Mestre (CORRIGIDO: AGORA SALVA OS CAMPOS NOVOS)
if (target.classList.contains('btn-salvar-edicao-plano')) {
                const item = AppState.configuracoes.planoManutencao.find(i => i.id === AppState.itemParaEditarId);
                if (item) {
                    item.categoria = document.getElementById('editPlanoCategoria').value;
                    item.acao = document.getElementById('editPlanoAcao').value;
                    item.descricao = document.getElementById('editPlanoDescricao').value.trim();
                    item.custoEstimado = Utils.parseMoeda(document.getElementById('editPlanoCusto').value);
                    item.observacao = document.getElementById('editPlanoObservacao').value.trim();
                    item.intervaloKm = parseInt(document.getElementById('editPlanoIntervaloKm').value) || 0;
                    item.intervaloMeses = parseInt(document.getElementById('editPlanoIntervaloMeses').value) || 0;
                    item.metaId = document.getElementById('editPlanoMetaVinculada').value;

                    if (!item.descricao) {
                        alert("A descri√ß√£o n√£o pode ficar em branco.");
                        return;
                    }

                    Storage.salvarConfiguracoes();
                    
                    // --- INTELIG√äNCIA ATIVADA ---
                    if (item.metaId) {
                        BusinessLogic.sincronizarMetaManutencao(item.metaId);
                    }
                    // ----------------------------

                    UIRenderer.fecharModal();
                    UIRenderer.renderPlanoMestre();
                    UIRenderer.renderHistoricoServicos();
                    UIRenderer.renderSaudeVeiculo();
                }
                return;
            }

            // Edi√ß√£o Manuten√ß√£o Simples (Compatibilidade)
            if (target.classList.contains('btn-salvar-edicao-manutencao')) {
                const item = AppState.configuracoes.manutencao.find(i => i.id === AppState.itemParaEditarId);
                if(item) {
                    item.descricao = document.getElementById('editManutencaoDescricao').value.trim();
                    item.ultimoKm = parseInt(document.getElementById('editManutencaoUltimoKm').value);
                    item.intervalo = parseInt(document.getElementById('editManutencaoIntervalo').value);
                    Storage.salvarConfiguracoes();
                    UIRenderer.fecharModal();
                    UIRenderer.render();
                }
                return;
            }

// 3. CONFIRMAR TRANSFER√äNCIA (VERS√ÉO FINAL√çSSIMA: ACID + SNAPSHOT FATURA + LOCK ROBUSTO)
            if (target.closest('#btn-confirmar-transferencia')) {
                const btn = target.closest('#btn-confirmar-transferencia');
                
                // 1. TRAVA UI
                if (btn.hasAttribute('data-processing')) return;
                btn.setAttribute('data-processing', 'true');
                const textoOriginal = btn.textContent;
                btn.textContent = "Processando...";
                btn.classList.add('opacity-50', 'cursor-wait');

                // Vari√°veis de Escopo (Para Rollback)
                let snapshot = null;
                let snapshotFatura = null; 
                let pushedTxIds = [];
                let lockOwner = null;

                // --- IDEMPOT√äNCIA (Sess√£o do Modal) ---
                let requestIdElem = document.getElementById('modal-request-id');
                if (!requestIdElem) {
                    const modalContainer = document.getElementById('modalContainer') || document.body;
                    requestIdElem = document.createElement('input');
                    requestIdElem.type = 'hidden';
                    requestIdElem.id = 'modal-request-id';
                    requestIdElem.value = crypto.randomUUID();
                    modalContainer.appendChild(requestIdElem);
                }
                const requestId = requestIdElem.value;

                if (AppState.historicoTransacoes.some(t => t.requestId === requestId)) {
                    // Limpeza de UI antes de sair silenciosamente
                    btn.removeAttribute('data-processing');
                    btn.textContent = textoOriginal;
                    btn.classList.remove('opacity-50', 'cursor-wait');
                    UIRenderer.fecharModal();
                    return true;
                }

                // --- LOCK ROBUSTO (TTL 10s + Owner) ---
                const LOCK_KEY = 'app_transfer_lock';
                const acquireLock = () => {
                    const now = Date.now();
                    const lockRaw = localStorage.getItem(LOCK_KEY);
                    const myId = crypto.randomUUID();
                    
                    const lockPayload = JSON.stringify({ 
                        owner: myId, 
                        ts: now, 
                        req: requestId 
                    });

                    if (lockRaw) {
                        try {
                            const lock = JSON.parse(lockRaw);
                            // TTL 10s para redes m√≥veis/lat√™ncia
                            if (now - lock.ts > 10000) { 
                                lockOwner = myId;
                                localStorage.setItem(LOCK_KEY, lockPayload);
                                return true;
                            }
                            return false;
                        } catch {
                            lockOwner = myId;
                            localStorage.setItem(LOCK_KEY, lockPayload);
                            return true;
                        }
                    }
                    lockOwner = myId;
                    localStorage.setItem(LOCK_KEY, lockPayload);
                    return true;
                };

                const releaseLock = () => {
                    try {
                        const raw = localStorage.getItem(LOCK_KEY);
                        if (!raw) return;
                        const lock = JSON.parse(raw);
                        if (lockOwner && lock.owner === lockOwner) localStorage.removeItem(LOCK_KEY);
                    } catch { localStorage.removeItem(LOCK_KEY); }
                };

                if (!acquireLock()) {
                    btn.removeAttribute('data-processing');
                    btn.textContent = textoOriginal;
                    btn.classList.remove('opacity-50', 'cursor-wait');
                    UIRenderer.abrirModal('alerta', { titulo: 'Aguarde', mensagem: 'Sistema processando outra opera√ß√£o simult√¢nea.' });
                    return;
                }

                try {
                    const valor = Utils.parseMoeda(document.getElementById('transf-valor').value);
                    const origemId = document.getElementById('transf-origem-id').value;
                    const destinoId = document.getElementById('transf-destino-id').value;
                    let descricao = document.getElementById('transf-descricao').value.trim();

                    // Valida√ß√µes de Neg√≥cio
                    if (valor <= 0) throw new Error('Valor deve ser maior que zero.');
                    if (origemId === destinoId) throw new Error('Origem e destino iguais.');

                    // Helper de Identifica√ß√£o
                    const getEntidade = (id) => {
                        if (id === 'AUTO_ID_CARTEIRA') return { tipo: 'carteira_fisica', ref: null, nome: 'Carteira (Dinheiro)' };
                        const conta = AppState.configuracoes.contasBancarias.find(c => c.id === id);
                        if (conta) return { tipo: 'conta', ref: conta, nome: conta.nome };
                        const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === id);
                        if (meta) return { tipo: 'caixinha', ref: meta, nome: meta.descricao };
                        return null;
                    };

                    const objOrigem = getEntidade(origemId);
                    const objDestino = getEntidade(destinoId);

                    if (!objOrigem || !objDestino) throw new Error('Entidades n√£o localizadas.');

                    // Valida√ß√£o Saldo (H√≠brida: State vs Hist√≥rico)
                    let saldoOrigem = 0;
                    if (objOrigem.tipo === 'caixinha') {
                        const meta = objOrigem.ref;
                        saldoOrigem = (meta.tipo === 'parcelamento') ? (meta.valorProvisionado || 0) : (meta.valorAtual || 0);
                    } else {
                        saldoOrigem = BusinessLogic.calcularSaldoConta(origemId);
                    }

                    if (saldoOrigem < valor) throw new Error(`Saldo insuficiente em "${objOrigem.nome}".`);

                    if (!descricao) descricao = `Transf. para: ${objDestino.nome}`;

                    // 2. SNAPSHOTS (CR√çTICO: FATURA SEPARADA)
                    
                    // A) Snapshot Gen√©rico (Saldos de Metas)
                    snapshot = {
                        origem: objOrigem.tipo === 'caixinha' ? { 
                            id: objOrigem.ref.id, 
                            valorAtual: objOrigem.ref.valorAtual, 
                            valorProvisionado: objOrigem.ref.valorProvisionado 
                        } : null,
                        destino: objDestino.tipo === 'caixinha' ? { 
                            id: objDestino.ref.id, 
                            valorAtual: objDestino.ref.valorAtual, 
                            valorProvisionado: objDestino.ref.valorProvisionado 
                        } : null
                    };

                    // B) Snapshot Espec√≠fico de Fatura (Deep Copy de Arrays)
                    if (objDestino.ref && objDestino.ref.id && objDestino.ref.id.startsWith('FATURA_')) {
                        snapshotFatura = {
                            id: objDestino.ref.id,
                            valorAtual: objDestino.ref.valorAtual,
                            valorProvisionado: objDestino.ref.valorProvisionado,
                            // Deep Copy do array para garantir rollback perfeito
                            comprasParceladas: JSON.parse(JSON.stringify(objDestino.ref.comprasParceladas || []))
                        };
                    }

                    // 3. MUTA√á√ÉO DE STATE (Update Visual Imediato)
                    let flagAfetouOrigem = false;
                    let flagAfetouDestino = false;

                    // Destino (Soma)
                    if (objDestino.tipo === 'caixinha') {
                        const meta = objDestino.ref;
                        if (meta.tipo === 'parcelamento') meta.valorProvisionado = (meta.valorProvisionado || 0) + valor;
                        else meta.valorAtual = (meta.valorAtual || 0) + valor;
                        flagAfetouDestino = true;
                    }

                    // Origem (Subtrai)
                    if (objOrigem.tipo === 'caixinha') {
                        const meta = objOrigem.ref;
                        if (meta.tipo === 'parcelamento') meta.valorProvisionado = Math.max(0, (meta.valorProvisionado || 0) - valor);
                        else meta.valorAtual = Math.max(0, (meta.valorAtual || 0) - valor);
                        flagAfetouOrigem = true;
                    }

                    // 4. REGISTRO CONT√ÅBIL (DOUBLE ENTRY + AUDITORIA)
                    const dataAgora = Date.now();
                    const batchId = crypto.randomUUID();
                    // DEFINI√á√ÉO DO ID DE TRANSFER√äNCIA <<<
                    const transferId = crypto.randomUUID();
                    // Metadados de Auditoria
                    const auditMeta = {
                        batchId: batchId,
                        isSistema: false, // Transa√ß√£o manual
                        timestamp: dataAgora,
                        userAction: 'modal_transferencia',
                        device: navigator.userAgent // Fingerprint simples
                    };

                    // Transa√ß√£o 1: SA√çDA da Origem
                    const txSaida = {
                        id: crypto.randomUUID(),
                        data: dataAgora,
                        tipo: 'saida',
                        contaId: origemId,
                        valor: valor,
                        descricao: descricao,
                        jornadaId: null,
                        requestId: requestId,
                        isCustoOperacional: false,
                        origem: { id: origemId, nome: objOrigem.nome, tipo: objOrigem.tipo, afetouState: flagAfetouOrigem },
                        destino: { id: destinoId, nome: objDestino.nome, tipo: objDestino.tipo, afetouState: flagAfetouDestino },
                        // detalhes: { ...auditMeta, leg: 'source' }
                        // vers√£o blindada:
                        detalhes: {
                                    ...auditMeta,
                                    transferId,
                                    leg: 'origin',
                                    tipo: 'transferencia'
                                }

                    };

                    // Transa√ß√£o 2: ENTRADA no Destino
                    const txEntrada = {
                        id: crypto.randomUUID(),
                        data: dataAgora,
                        tipo: 'entrada',
                        contaId: destinoId,
                        valor: valor,
                        descricao: `Recebido de: ${objOrigem.nome}`,
                        jornadaId: null,
                        requestId: requestId,
                        isCustoOperacional: false,
                        origem: { id: origemId, nome: objOrigem.nome, tipo: objOrigem.tipo, afetouState: flagAfetouOrigem },
                        destino: { id: destinoId, nome: objDestino.nome, tipo: objDestino.tipo, afetouState: flagAfetouDestino },
                        // detalhes: { ...auditMeta, leg: 'destination' }
                        detalhes: {
                                        transferId,
                                        leg: 'destination',
                                        tipo: 'transferencia'
                                    },
                    };

                    // Ajuste Sem√¢ntico para Fatura (Se for pagamento)
                    if (objDestino.ref && objDestino.ref.id && objDestino.ref.id.startsWith('FATURA_')) {
                         txSaida.descricao = `Pagamento Fatura: ${objDestino.nome}`;
                         txEntrada.descricao = `Pagamento recebido de: ${objOrigem.nome}`;
                    }

                    AppState.historicoTransacoes.push(txSaida, txEntrada);
                    pushedTxIds.push(txSaida.id, txEntrada.id);

                    // 5. PERSIST√äNCIA (COMMIT)
                    try {
                        Storage.salvarConfiguracoes();
                    } catch (e) {
                        throw new Error("Falha ao salvar dados: " + e.message);
                    }

                    // SUCESSO
                    try { if (requestIdElem) requestIdElem.remove(); } catch(e){}

                    UIRenderer.fecharModal();
                    UIRenderer.render(); 
                    UIRenderer.renderContasBancarias();
                    UIRenderer.renderMetasFinanceiras(); 

                    UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Transfer√™ncia realizada.', type: 'success' });

                } catch (erro) {
                    if (erro.message === 'DUPLICATE_REQUEST_SILENT') {
                        UIRenderer.fecharModal();
                        return true;
                    }
                    console.error("Erro Transfer√™ncia:", erro);

                    // --- ROLLBACK COMPLETO ---
                    
                    // 1. Reverte Saldos de Metas Simples
                    if (snapshot) {
                        if (snapshot.origem) {
                            const m = AppState.configuracoes.metasFinanceiras.find(x => x.id === snapshot.origem.id);
                            if(m) { m.valorAtual = snapshot.origem.valorAtual; m.valorProvisionado = snapshot.origem.valorProvisionado; }
                        }
                        if (snapshot.destino) {
                            const m = AppState.configuracoes.metasFinanceiras.find(x => x.id === snapshot.destino.id);
                            if(m) { m.valorAtual = snapshot.destino.valorAtual; m.valorProvisionado = snapshot.destino.valorProvisionado; }
                        }
                    }

                    // 2. Reverte Fatura (Objeto Complexo + Rec√°lculo)
                    if (snapshotFatura) {
                        const m = AppState.configuracoes.metasFinanceiras.find(x => x.id === snapshotFatura.id);
                        if(m) {
                            m.valorAtual = snapshotFatura.valorAtual; 
                            m.valorProvisionado = snapshotFatura.valorProvisionado;
                            m.comprasParceladas = snapshotFatura.comprasParceladas;
                            try { BusinessLogic.recalcularProvisaoFatura(m); } catch(e){}
                        }
                    }
                    
                    // 3. Remove Transa√ß√µes da Mem√≥ria
                    if (pushedTxIds.length > 0) {
                        AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !pushedTxIds.includes(t.id));
                    }
                    
                    // 4. Persiste Rollback
                    try { Storage.salvarConfiguracoes(); UIRenderer.renderMetasFinanceiras(); } catch (e) {}

                    UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: erro.message });
                } finally {
                    releaseLock();
                    btn.removeAttribute('data-processing');
                    btn.textContent = textoOriginal;
                    btn.classList.remove('opacity-50', 'cursor-wait');
                }
                return true; 
            }

         // Salvar Ajuste de Saldo
            if (target.id === 'btn-confirmar-ajuste-saldo') {
                const contaId = AppState.itemParaEditarId;
                const novoSaldoInput = document.getElementById('novoSaldoInput').value;
                if (!novoSaldoInput.trim()) {
                     UIRenderer.abrirModal('alerta', { titulo: 'Campo Obrigat√≥rio', mensagem: 'Por favor, preencha o novo saldo para fazer o ajuste.' });
                     return;
                }
                const novoSaldo = Utils.parseMoeda(novoSaldoInput);
                const saldoAtual = BusinessLogic.calcularSaldoConta(contaId);
                const diferenca = novoSaldo - saldoAtual;

                if (Math.abs(diferenca) >= 0.01) {
                    AppState.historicoTransacoes.push({
                        id: crypto.randomUUID(), data: agora.getTime(), contaId: contaId,
                        tipo: diferenca > 0 ? 'entrada' : 'saida',
                        valor: Math.abs(diferenca),
                        descricao: 'Ajuste manual de saldo',
                        jornadaId: null
                    });
                    Storage.salvarConfiguracoes();
                }
                UIRenderer.fecharModal();
                UIRenderer.render();
                
                // Destrava cronometro se houver jornada
                const jornadaAtiva = BusinessLogic.getJornadaAtiva();
                if (jornadaAtiva) TimeManager.iniciarCronometro();
                
                return;
            }

// Salvar Extra/Gorjeta (VERS√ÉO CORRIGIDA V2)
            if (target.id === 'btn-confirmar-extra') {
                const atividadeId = AppState.itemParaEditarId;
                const valorExtra = Utils.parseMoeda(document.getElementById('valorExtraInput').value);
                
                if (valorExtra <= 0) { 
                    UIRenderer.abrirModal('alerta', { titulo: 'Valor Inv√°lido', mensagem: 'Insira um valor maior que zero.' }); 
                    return; 
                }
// 2. Cria Transa√ß√£o (Para o Extrato Financeiro - Fonte da Verdade)
                    const txExtra = {
                        id: crypto.randomUUID(),
                        data: Date.now(),
                        tipo: 'entrada',
                        contaId: 'AUTO_ID_CARTEIRA', // Entrou na m√£o
                        categoria: 'Gorjeta', // Mant√©m visual
                        descricao: `B√¥nus: Extra Manual (Referente √† corrida das ${new Date(atividade.fim).toLocaleTimeString().slice(0,5)})`,
                        valor: valorExtra,
                        jornadaId: AppState.activeJornadaChave,
                        
                        // >>> O CARIMBO DE OURO <<<
                        isExtra: true, // Identificador estrutural para o Dashboard
                        // >>>>>>>>>>>>>>>>>>>>>>>>>
                        
                        detalhes: { 
                            origem: 'manual_atividade',
                            atividadeId: atividadeId
                        }
                    };
                const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
                const atividade = jornada.atividades.find(a => a.id === atividadeId);
                
                if (atividade) {
                    // 1. Atualiza a Atividade (Para o Roadmap somar via getGorjetaTotalDaJornada)
                    if (atividade.valorBruto && !atividade.taxaAppOriginal) {
                        atividade.taxaAppOriginal = atividade.valorBruto - atividade.valor;
                    }
                    
                    // CORRE√á√ÉO CR√çTICA: Garante que o valorExtras seja num√©rico e acumulativo
                    const anterior = parseFloat(atividade.valorExtras) || 0;
                    atividade.valorExtras = anterior + valorExtra;
                    atividade.valor += valorExtra; // Soma ao l√≠quido total
                    atividade.descricao += ` (+${Utils.formatarMoeda(valorExtra)} extra)`;
                    
                    // 2. Cria Transa√ß√£o (Para o Extrato Financeiro)
                    // Nome "B√¥nus: Extra Manual" √© obrigat√≥rio para a l√≥gica do Roadmap
                    if (atividade.statusPagamento !== 'pendente') {
                        AppState.historicoTransacoes.push({
                            id: crypto.randomUUID(), 
                            data: Date.now(), 
                            contaId: 'AUTO_ID_CARTEIRA',
                            tipo: 'entrada', 
                            valor: valorExtra, 
                            descricao: `B√¥nus: Extra Manual (Ref. corrida das ${new Date(atividade.fim).toLocaleTimeString().slice(0,5)})`,
                            categoria: 'Gorjeta', 
                            jornadaId: AppState.activeJornadaChave
                        });
                        Storage.salvarConfiguracoes();
                    }
                    
                    Storage.salvarJornadas();
                    UIRenderer.fecharModal();
                    UIRenderer.render(); 
                    
                    // For√ßa atualiza√ß√£o imediata do Roadmap
                    if (AppState.dashboardState.isRoadmapVisible) {
                         setTimeout(() => RoadmapRenderer.render(), 100);
                    }
                    
                    UIRenderer.abrirModal('alerta', { 
                        titulo: 'Sucesso', 
                        mensagem: `Extra de ${Utils.formatarMoeda(valorExtra)} adicionado!`, 
                        type: 'success' 
                    });
                }
                return;
            }
    // Gest√£o Financeira (Modal Interno)
            if (target.closest('#gestaoFinanceiraModalContent')) {
                if (EventHandlers.handleGestaoFinanceiraClicks(e)) return;
            }

            // Simuladores e Amortiza√ß√£o (RESTAURADO E CORRIGIDO)
            if (target.id === 'btn-gerar-cronograma-modal') { EventHandlers.handleSimuladorGerarCronograma(); return; }
            
            // Delega√ß√£o crucial para o simulador (estava quebrada)
            if (target.id === 'btn-criar-meta-amortizacao') { 
                EventHandlers.handleSimuladorCriarMeta(); 
                // For√ßa o c√°lculo inicial no modal
                setTimeout(() => EventHandlers.recalcularValorAlvoModal(3), 200);
                return; 
            }
            
            // Delega√ß√£o crucial para criar caixinha (RESTAURADA)
            if (target.id === 'btn-confirmar-criacao-caixinha') { 
                EventHandlers.confirmarCriacaoCaixinha(e); 
                return; 
            } 
            
// BOT√ÉO PAGAR AGORA (DO SIMULADOR)
            if (target.id === 'btn-pagar-agora-do-modal') {
                const pv = parseFloat(target.dataset.pv);
                // Se n√£o tiver economia no dataset, calcula zero ou pega do elemento visual (opcional)
                const economia = 0; 
                const parcelas = target.dataset.parcelas;
                const dataRef = target.dataset.dataRef; 
                
                // Abre o modal de sele√ß√£o (que cont√©m o bot√£o de confirmar)
                UIRenderer.abrirModal('selecionarFontePagamento', { 
                    pv: pv, 
                    economia: economia, 
                    parcelas: parcelas,
                    dataRef: dataRef 
                });
                return; 
            }
// --- 1. L√≥gica de Rebalanceamento (Fase 8) ---
            if (target.id === 'btn-rebalancear-pesos') {
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === AppState.itemParaEditarId);
                if (meta && meta.custosDetalhados.length > 0) {
                    const pesoEquitativo = 100 / meta.custosDetalhados.length;
                    meta.custosDetalhados.forEach(c => { c.pesoAceleracao = pesoEquitativo; });
                    Storage.salvarConfiguracoes();
                    EventHandlers.handleRenderModalCustos(AppState.custosModalState.data);
                }
                return;
            }
            
// C√ìDIGO NOVO (SUBSTITUIR O BLOCO ACIMA)
            if (target.classList.contains('btn-confirmar-pagamento-amortizacao')) {
                EventHandlers.handleConfirmarPagamentoAmortizacao(target);
                return;
            }
// --- 2. Bot√£o Registrar Pagamento Individual (Lista) ---
           // --- NOVO LISTENER (PASSO 1 - PAGAMENTO CUSTO MENSAL COM V√çNCULO) ---
// --- 2. Bot√£o Registrar Pagamento Individual (Lista de Custos Mensais) ---
            if (target.classList.contains('btn-registrar-pagamento-item')) {
                const idCustoFixo = target.dataset.idcusto;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === AppState.itemParaEditarId);
                const custoItem = meta?.custosDetalhados.find(c => c.idCustoFixo === idCustoFixo);
                
                const inputValor = document.getElementById(`pagar-item-${idCustoFixo}`);
                const selectBanco = document.getElementById(`banco-item-${idCustoFixo}`);
                
                if (!meta || !custoItem || !inputValor || !selectBanco) return;

                const valorPago = Utils.parseMoeda(inputValor.value);
                const bancoId = selectBanco.value;

                if (valorPago <= 0) { 
                    UIRenderer.abrirModal('alerta', { titulo: 'Valor Inv√°lido', mensagem: "O valor a pagar deve ser maior que zero." }); 
                    return; 
                }
                
                // 1. VERIFICA√á√ÉO DO BANCO (ORIGEM DO DINHEIRO)
                const saldoBancoReal = BusinessLogic.calcularSaldoConta(bancoId);
                const nomeBanco = bancoId === 'AUTO_ID_CARTEIRA' ? 'Carteira' : (AppState.configuracoes.contasBancarias.find(c => c.id === bancoId)?.nome || 'Banco');

                // Fun√ß√£o para executar o pagamento (Encapsulada para usar no callback)
                const processarPagamento = () => {
                    // 2. DEDU√á√ÉO DA CAIXINHA (L√ìGICA BLINDADA - N√ÉO NEGATIVA)
                    const saldoItemGuardado = custoItem.valorGuardado || 0;
                    
                    // Se o valor guardado for menor que a conta, usamos tudo o que tem (zera), mas n√£o negativa.
                    // O restante √© considerado "Custo n√£o provisionado" (sai do saldo livre).
                    const valorDeduzidoDaCaixinha = Math.min(saldoItemGuardado, valorPago);
                    
                    custoItem.valorGuardado -= valorDeduzidoDaCaixinha;
                    // Atualiza o total da meta somando todos os itens
                    meta.valorAtual = meta.custosDetalhados.reduce((acc, c) => acc + (c.valorGuardado || 0), 0);

                    // 3. REGISTRO (LOG) NA META
                    if (!meta.saidas) meta.saidas = [];
                    meta.saidas.push({
                        id: crypto.randomUUID(),
                        data: Utils.formatarDataParaChave(new Date()),
                        descricao: `${custoItem.descricao} (via ${nomeBanco})`,
                        valor: valorPago
                    });

                    // 4. REGISTRO FINANCEIRO REAL (SA√çDA DO BANCO)
                    AppState.historicoTransacoes.push({
                        id: crypto.randomUUID(),
                        data: Date.now(),
                        tipo: 'saida',
                        contaId: bancoId, 
                        valor: valorPago, // O valor que sai do banco √© o total da conta
                        descricao: `Pagamento Custo: ${custoItem.descricao}`,
                        categoria: custoItem.categoria || 'Outro C. Fixo', 
                        subcategoria: custoItem.subcategoria || null,
                        isCustoOperacional: true,
                        jornadaId: null
                    });

                    Storage.salvarConfiguracoes();
                    
                    UIRenderer.fecharModal();
                    // Reabre o modal para ver a atualiza√ß√£o
                    setTimeout(() => {
                        UIRenderer.abrirModal('pagarCustoMensal', { meta: meta });
                        UIRenderer.render(); // Atualiza saldo do topo
                    }, 200);
                    
                    // Feedback Diferenciado
                    if (valorDeduzidoDaCaixinha < valorPago) {
                        const diferenca = valorPago - valorDeduzidoDaCaixinha;
                        UIRenderer.abrirModal('alerta', { 
                            titulo: 'Pago (Saldo Insuficiente na Provis√£o)', 
                            mensagem: `A conta de <b>${Utils.formatarMoeda(valorPago)}</b> foi paga.<br>A caixinha cobriu apenas <b>${Utils.formatarMoeda(valorDeduzidoDaCaixinha)}</b>.<br>A diferen√ßa de <b>${Utils.formatarMoeda(diferenca)}</b> saiu do seu saldo livre.`,
                            type: 'warning'
                        });
                    } else {
                        UIRenderer.abrirModal('alerta', { titulo: 'Sucesso', mensagem: 'Pagamento registrado e descontado da provis√£o.', type: 'success' });
                    }
                };

                // APLICA√á√ÉO DAS REGRAS DE SALDO

                // Regra A: Falta dinheiro na Caixinha? (Aviso visual, mas permite pagar com saldo livre)
                // (Essa l√≥gica j√° est√° embutida no processarPagamento com Math.min, mas podemos confirmar se o usu√°rio quer gastar saldo livre)
                /* Opcional: Adicionar confirma√ß√£o se a caixinha n√£o cobrir tudo. 
                   Por fluidez, deixei autom√°tico (zera a caixinha e paga o resto), mas avisa no final. */

                // Regra B: Falta dinheiro no BANCO? (Cheque Especial)
                if (saldoBancoReal < valorPago) {
                    const futuroSaldo = saldoBancoReal - valorPago;
                    UIRenderer.abrirModal('confirmacao', {
                        titulo: 'Saldo Insuficiente no Banco',
                        mensagem: `
                            <div class="text-left text-sm space-y-2">
                                <p>O banco <b>${nomeBanco}</b> tem apenas <b class="text-amber-400">${Utils.formatarMoeda(saldoBancoReal)}</b>.</p>
                                <p>O pagamento √© de <b>${Utils.formatarMoeda(valorPago)}</b>.</p>
                                <hr class="border-slate-600">
                                <p>Saldo Final Previsto: <b class="text-red-400">${Utils.formatarMoeda(futuroSaldo)}</b></p>
                                <p class="mt-2 font-bold text-white">Deseja confirmar mesmo assim (Cheque Especial)?</p>
                            </div>`,
                        confirmText: 'Sim, Pagar e Negativar',
                        cancelText: 'Cancelar',
                        confirmClass: 'bg-red-600 hover:bg-red-700',
                        callback: (confirmado) => { 
                            if (confirmado) processarPagamento(); 
                        }
                    });
                    return;
                }

                // Se tem saldo no banco, processa direto
                processarPagamento();
                return;
            }
        // Calculadoras
            // if (target.id === 'btn-calcular-troco') { document.getElementById('calc-resultado-troco').textContent = Utils.formatarMoeda(Math.max(0, Utils.parseMoeda(document.getElementById('calcValorRecebido').value) - Utils.parseMoeda(document.getElementById('calcValorCorrida').value))); return; }
            // --- C√ÅLCULO DE TROCO INTELIGENTE (FALTA vs TROCO) ---
            if (target.id === 'btn-calcular-troco') {
                const valorCorrida = Utils.parseMoeda(document.getElementById('calcValorCorrida').value);
                const valorRecebido = Utils.parseMoeda(document.getElementById('calcValorRecebido').value);
                
                const resultadoEl = document.getElementById('calc-resultado-troco');
                // O label √© o <span> logo antes do <h3> do resultado
                const labelEl = resultadoEl.previousElementSibling; 
                
                const diferenca = valorRecebido - valorCorrida;

                if (diferenca >= 0) {
                    // Cen√°rio: O passageiro pagou a mais ou o valor exato
                    if (labelEl) labelEl.textContent = "Troco a devolver:";
                    resultadoEl.className = "text-3xl font-bold text-green-400"; // Verde
                    resultadoEl.textContent = Utils.formatarMoeda(diferenca);
                } else {
                    // Cen√°rio: O passageiro pagou menos (Falta)
                    if (labelEl) labelEl.textContent = "Falta receber:";
                    resultadoEl.className = "text-3xl font-bold text-red-400 animate-pulse"; // Vermelho piscando
                    resultadoEl.textContent = Utils.formatarMoeda(Math.abs(diferenca));
                }
                return;
            }
            
            if (target.id === 'btn-sugerir-cotacao-custos') { EventHandlers.handleSugerirCotacaoCustos(); return; }
            if (target.id === 'btn-sugerir-cotacao-desempenho') { EventHandlers.handleSugerirCotacaoDesempenho(); return; }
            if (target.id === 'btn-pdf-cotacao') { EventHandlers.handleGerarPdfCotacao(); return; }
            if (target.closest('.calc-tab-pane') && (target.tagName === 'INPUT' || target.tagName === 'SELECT')) { EventHandlers.handleRecalcularCotacao(); }
            
            // Custos Mensais (Abas)
            if (target.classList.contains('custo-modal-tab-button')) { const tab = target.dataset.tab; document.querySelectorAll('.custo-modal-tab-button').forEach(b => b.classList.remove('active')); target.classList.add('active'); document.querySelectorAll('.custo-modal-tab-pane').forEach(p => p.classList.add('hidden')); document.getElementById(`custo-modal-content-${tab}`).classList.remove('hidden'); return; }
            if (target.id === 'btn-ajuda-custos-mensais') { UIRenderer.abrirModal('alerta', { titulo: 'Ajuda', mensagem: 'Esta caixinha √© autom√°tica.' }); return; }
            if (target.id === 'btn-custo-mes-ant') { AppState.custosModalState.data.setMonth(AppState.custosModalState.data.getMonth()-1); EventHandlers.handleRenderModalCustos(AppState.custosModalState.data); return; }
            if (target.id === 'btn-custo-mes-prox') { AppState.custosModalState.data.setMonth(AppState.custosModalState.data.getMonth()+1); EventHandlers.handleRenderModalCustos(AppState.custosModalState.data); return; }
            if (target.id === 'btn-acelerar-mais') { EventHandlers.handleSimuladorAceleradorChange(1); return; }
            if (target.id === 'btn-acelerar-menos') { EventHandlers.handleSimuladorAceleradorChange(-1); return; }

            // Simulador Checkbox
            if (target.type === 'checkbox' && target.closest('#listaParcelasModal')) { EventHandlers.handleSimuladorToggleParcela(target); return; }
EventHandlers.handleSalvarAlocacao = (idsSelecionados, lucroDisponivel) => {
    if (typeof FechamentoJornada !== 'undefined' && FechamentoJornada.executar) {
        FechamentoJornada.executar(idsSelecionados, lucroDisponivel);
    } else {
        alert("Erro Cr√≠tico: Motor V8 n√£o carregado.");
    }
};



// --- 6. FINALIZAR SERVI√áO (SALVAR) ---
            if (target.classList.contains('btn-salvar-finalizacao')) {
                const servicoId = AppState.itemParaEditarId;
                const jornada = BusinessLogic.getJornadaAtiva();
                if (servicoId && jornada) {
                    const servico = jornada.servicosEmAndamento.find(s => s.id === servicoId);
                    if(servico) {
                        if(servico.id.startsWith('servico-rapido')) {
                             servico.valor = Utils.parseMoeda(document.getElementById('editValor').value);
                             servico.descricao = document.getElementById('editDescricao').value; 
                             servico.categoria = document.getElementById('editCategoria').value; 
                             servico.subcategoria = document.getElementById('editSubcategoria').value;
                             if(servico.categoria === 'Particular') { 
                                 servico.nomeCliente = document.getElementById('editNomeCliente').value; 
                                 servico.statusPagamento = document.getElementById('editStatusPagamento').value; 
                                 if(servico.statusPagamento === 'pendente') servico.dataVencimento = document.getElementById('editDataVencimento').value; 
                             }
                        }
                        const vb = Utils.parseMoeda(document.getElementById('editValorBruto')?.value); 
                        if(vb > 0) servico.valorBruto = vb;
                        
                        let kmIni = parseFloat(document.getElementById('inicialKmServico')?.value)||null; 
                        let kmFim = parseFloat(document.getElementById('finalKmServico')?.value)||null; 
                        if(document.getElementById('ignorarKmInicial')?.checked) kmIni = null;
                        
                        BusinessLogic.finalizarServico(servicoId, Date.now(), { inicial: kmIni, final: kmFim });
                        // >>>>> ADICIONE ISTO <<<<<
                // Pega o servi√ßo que acabou de ser salvo (o √∫ltimo da lista de atividades)
                const jornadaAtual = BusinessLogic.getJornadaAtiva();
                if (jornadaAtual && jornadaAtual.atividades.length > 0) {
                    const ultimaAtividade = jornadaAtual.atividades[jornadaAtual.atividades.length - 1];
                    // Chama o verificador de promo√ß√µes
                    PromotionManager.recalcularTudo();
                }
                // >>>>> FIM DA ADI√á√ÉO <<<<<
                        
                        SystemLog.info('Jornada', 'Servi√ßo Finalizado', { valor: servico.valor, id: servicoId });
                        if(servico.iniciadoEmPausa) AppState.servicoFinalizadoEmPausa = true;
                        
                        if (UIElements.kmInicialServicoInput) UIElements.kmInicialServicoInput.value = ''; 
                // Isso limpa o campo "sujo" e for√ßa o sistema a ler o KM novo!
                        Storage.salvarJornadas(); 
                        UIRenderer.fecharModal(); 
                        UIRenderer.render();
                        
                        // RECIBO DIRETO (Corre√ß√£o Recibo)
                        if(servico.categoria === 'Particular' && servico.statusPagamento !== 'pendente') {
                            const atv = jornada.atividades.find(a => a.id === servicoId);
                            if(atv) ReciboGenerator.gerarPDF(atv);
                        }
                    }
                }
                return;
            }

// 5. SALVAR EDI√á√ÉO DE ATIVIDADE (COM SINCRONIA FINANCEIRA)
if (target.classList.contains('btn-salvar-edicao-atividade')) {
                const jornada = BusinessLogic.getJornadaDoDia(AppState.dataSelecionada);
                const atividade = jornada.atividades.find(a => a.id === AppState.itemParaEditarId);

                if (atividade) {
                    // 1. Captura o valor ANTIGO antes de atualizar
                    const valorAntigo = atividade.valor;
                    
                    // 2. Coleta dados novos do formul√°rio
                    const valorNovo = Utils.parseMoeda(document.getElementById('editValor').value);
                    const valorBruto = Utils.parseMoeda(document.getElementById('editValorBruto').value); 
                    const descricao = document.getElementById('editDescricao').value.trim();
                    const categoria = document.getElementById('editCategoria').value;
                    const subcategoria = document.getElementById('editSubcategoria').value;
                    const kmInicialNovo = parseFloat(document.getElementById('editKmInicial').value) || null;
                    const kmFinalNovo = parseFloat(document.getElementById('editKmFinal').value) || null;
                    
                    // 3. Atualiza a Atividade (Jornada)
                    atividade.valor = valorNovo;
                    atividade.valorBruto = valorBruto > 0 ? valorBruto : null;
                    atividade.taxaAppOriginal = null;
                    atividade.descricao = descricao;
                    atividade.categoria = categoria;
                    atividade.subcategoria = subcategoria;
                    atividade.kmInicialServico = kmInicialNovo;
                    atividade.kmFinalServico = kmFinalNovo;

                    // Atualiza KM Final da Jornada se necess√°rio
                    if (kmFinalNovo && kmFinalNovo > (jornada.kmFinal || 0)) {
                        jornada.kmFinal = kmFinalNovo;
                    }

                    // 4. >>> SINCRONIA FINANCEIRA (O PULO DO GATO) <<<
                    // Se o valor mudou, precisamos atualizar o extrato financeiro tamb√©m
                    if (valorAntigo !== valorNovo) {
                        const chaveDia = Utils.formatarDataParaChave(AppState.dataSelecionada);
                        
                        // Procura a transa√ß√£o financeira correspondente
                        // Crit√©rios: Mesmo dia, Mesmo valor antigo, Tipo Entrada
                        const transacao = AppState.historicoTransacoes.find(t => 
                            t.jornadaId === chaveDia && 
                            Math.abs(t.valor - valorAntigo) < 0.01 && // Margem de erro float
                            t.tipo === 'entrada'
                        );

                        if (transacao) {
                            // Atualiza o valor no financeiro
                            transacao.valor = valorNovo;
                            transacao.descricao = `Servi√ßo: ${descricao || categoria} (Editado)`;
                            
                            // Se a transa√ß√£o foi cr√©dito em uma META (Caixinha), corrige o saldo dela
                            if (transacao.contaId && transacao.contaId.startsWith('META_')) {
                                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === transacao.contaId);
                                if (meta) {
                                    // Remove o antigo e soma o novo
                                    meta.valorAtual = (meta.valorAtual || 0) - valorAntigo + valorNovo;
                                }
                            }
                            
                            SystemLog.success('Sincronia', `Transa√ß√£o financeira atualizada de ${Utils.formatarMoeda(valorAntigo)} para ${Utils.formatarMoeda(valorNovo)}.`);
                        } else {
                            // Se n√£o achou a transa√ß√£o (caso raro ou manual), avisa
                            console.warn("Transa√ß√£o financeira vinculada n√£o encontrada para atualiza√ß√£o autom√°tica.");
                        }
                    }
                    // -------------------------------------------------------

                    Storage.salvarJornadas();
                    Storage.salvarConfiguracoes(); // Salva o financeiro atualizado
                }
                UIRenderer.fecharModal();
                UIRenderer.render(); 
                UIRenderer.renderContasBancarias(); // Atualiza saldo visual da carteira
                return;
            }
            // 8. GERA RECIBO NA EDI√á√ÉO
            if (target.classList.contains('btn-gerar-recibo-edicao')) {
                ReciboGenerator.gerarPDF({
                    valor: Utils.parseMoeda(document.getElementById('editValor').value),
                    nomeCliente: document.getElementById('editNomeCliente')?.value || 'Cliente',
                    descricao: document.getElementById('editDescricao').value,
                    fim: Date.now(),
                    kmInicialServico: parseFloat(document.getElementById('editKmInicial')?.value || 0),
                    kmFinalServico: parseFloat(document.getElementById('editKmFinal')?.value || 0)
                }); 
                return;
            }
// --- NOVO: VOLTAR PARA SIMULA√á√ÉO (Evita fechar tudo) ---
            if (target.id === 'btn-voltar-simulacao') {
                const metaId = AppState.itemParaEditarId;
                const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaId);
                
                if (meta) {
                    // 1. Reabre o modal principal
                    UIRenderer.abrirModal('amortizacaoFinanciamento', { meta: meta });
                    
                    // 2. Tenta restaurar a simula√ß√£o automaticamente
                    setTimeout(() => {
                        const btnGerar = document.getElementById('btn-gerar-cronograma-modal');
                        if (btnGerar) {
                            btnGerar.click(); // Clica sozinho para refazer o c√°lculo
                            
                            // Opcional: Se voc√™ quiser reabrir a lista de parcelas selecionadas, 
                            // precisaria de uma l√≥gica extra aqui, mas s√≥ reabrir a tela j√° resolve a frustra√ß√£o.
                        }
                    }, 100);
                } else {
                    UIRenderer.fecharModal(); // Se perder a refer√™ncia, fecha normal
                }
                return;
            }
// -------------------------------------------------------
            // --- IMPORTA√á√ÉO: MESCLAR BLINDADA (V142) ---
            // -------------------------------------------------------
            if (target.id === 'btn-importar-mesclar' || target.closest('#btn-importar-mesclar')) {
                const imported = AppState.tempImportData;
                if (!imported) return;

                // Fun√ß√£o auxiliar para unir listas sem duplicar IDs
                const mergeLists = (currentList, importedList) => {
                    const map = new Map();
                    (currentList || []).forEach(i => map.set(i.id, i));
                    (importedList || []).forEach(i => {
                        if (!map.has(i.id)) map.set(i.id, i);
                    });
                    return Array.from(map.values());
                };

                // 1. Mescla na MEM√ìRIA primeiro
                AppState.jornadas = { ...imported.jornadas, ...AppState.jornadas };
                AppState.historicoTransacoes = mergeLists(AppState.historicoTransacoes, imported.historicoTransacoes);
                AppState.historicoManutencao = mergeLists(AppState.historicoManutencao, imported.historicoManutencao);
                AppState.cotaManutencao = mergeLists(AppState.cotaManutencao, imported.cotaManutencao);

                // Configura√ß√µes (Mesclagem Profunda)
                const currConfig = AppState.configuracoes;
                const impConfig = imported.configuracoes || {};
                
                currConfig.custosFixos = mergeLists(currConfig.custosFixos, impConfig.custosFixos);
                currConfig.contasRecorrentes = mergeLists(currConfig.contasRecorrentes, impConfig.contasRecorrentes);
                currConfig.planoManutencao = mergeLists(currConfig.planoManutencao, impConfig.planoManutencao);
                currConfig.contasBancarias = mergeLists(currConfig.contasBancarias, impConfig.contasBancarias);
                currConfig.metasFinanceiras = mergeLists(currConfig.metasFinanceiras, impConfig.metasFinanceiras);

                // Subcategorias
                const impSubs = impConfig.subcategorias || {};
                Object.keys(impSubs).forEach(cat => {
                    const existingNames = new Set((currConfig.subcategorias[cat] || []).map(i => (typeof i === 'string' ? i : i.nome)));
                    (impSubs[cat] || []).forEach(item => {
                        const name = typeof item === 'string' ? item : item.nome;
                        const obj = typeof item === 'string' ? { nome: item, cor: '#818cf8' } : item;
                        if (!existingNames.has(name)) {
                            if(!currConfig.subcategorias[cat]) currConfig.subcategorias[cat] = [];
                            currConfig.subcategorias[cat].push(obj);
                        }
                    });
                });

                // =========================================================
                // üßπ A GRANDE LIMPEZA (V142)
                // Antes de salvar, passamos o pente fino nos dados mesclados
                // =========================================================
                if (typeof SystemMigrator !== 'undefined') {
                    console.log("üßπ Saneando dados mesclados...");
                    SystemMigrator.executar();
                }

                // 2. Agora sim, SALVA os dados limpos
                if (BusinessLogic.salvarDados) {
                    BusinessLogic.salvarDados();
                } else {
                    Storage.salvarJornadas();
                    Storage.salvarTransacoes();
                    Storage.salvarConfiguracoes();
                }

                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Sucesso!', 
                    mensagem: 'Dados mesclados e higienizados com sucesso.', 
                    type: 'success' 
                });
                setTimeout(() => location.reload(), 2000);
                return;
            }
            // -------------------------------------------------------
            // --- IMPORTA√á√ÉO: SUBSTITUIR BLINDADA (V142) ---
            // -------------------------------------------------------
            if (target.id === 'btn-importar-substituir' || target.closest('#btn-importar-substituir')) {
                const data = AppState.tempImportData;
                if (!data) return;

                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Tem certeza absoluta?',
                    mensagem: 'Isso APAGAR√Å todos os dados atuais e colocar√° o backup no lugar.',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                    callback: (sim) => {
                        if (sim) {
                            // 1. Carrega na Mem√≥ria
                            AppState.jornadas = data.jornadas || {};
                            AppState.configuracoes = data.configuracoes || AppState.configuracoes; // Fallback seguro
                            AppState.historicoTransacoes = data.historicoTransacoes || [];
                            AppState.historicoManutencao = data.historicoManutencao || [];
                            AppState.cotaManutencao = data.cotaManutencao || [];
                            
                            // Restaura chaves antigas se existirem (para o migrador pegar)
                            if (data.activeJornadaChave) AppState.activeJornadaChave = data.activeJornadaChave;

                            // =========================================================
                            // üßπ A GRANDE LIMPEZA (V142)
                            // O backup pode ter zumbis. Matamos eles agora.
                            // =========================================================
                            if (typeof SystemMigrator !== 'undefined') {
                                console.log("üßπ Saneando dados substituidos...");
                                SystemMigrator.executar();
                            }

                            // 2. Salva (Overwrite)
                            if (BusinessLogic.salvarDados) {
                                BusinessLogic.salvarDados();
                            } else {
                                // Fallback manual se n√£o tiver a fun√ß√£o unificada
                                localStorage.setItem('jornadasTrabalho_v6.4', JSON.stringify(AppState.jornadas));
                                localStorage.setItem('configuracoesDiario_v6.4', JSON.stringify(AppState.configuracoes));
                                localStorage.setItem('historicoTransacoes_v6.4', JSON.stringify(AppState.historicoTransacoes));
                                localStorage.setItem('historicoManutencao_v6.4', JSON.stringify(AppState.historicoManutencao));
                                localStorage.setItem('cotaManutencao_v6.4', JSON.stringify(AppState.cotaManutencao));
                            }
                            
                            location.reload();
                        }
                    }
                });
                return;
            }

            // =================================================================
            // L√ìGICA DE FECHAMENTO E NAVEGA√á√ÉO (CORRIGIDA)
            // =================================================================
            if (target.classList.contains('btn-cancelar') || target.classList.contains('btn-ok') || target.classList.contains('btn-confirmar')) {
                
                // 1. MODAL DE CONFIRMA√á√ÉO (SIM/N√ÉO ou OK/CANCELAR)
                if (AppState.onConfirmCallback) {
                    const isConfirm = target.classList.contains('btn-confirmar'); // True se clicou no bot√£o principal
                    const callback = AppState.onConfirmCallback;

                    // >>> CORRE√á√ÉO VITAL: FECHA ANTES DE EXECUTAR O CALLBACK <<<
                    AppState.onConfirmCallback = null; // Limpa a trava
                    UIRenderer.fecharModal();          // Fecha o modal atual (Aviso)
                    
                    // Agora sim, executa a a√ß√£o (que pode ser reabrir o modal anterior)
                    if (callback) callback(isConfirm); 
                    
                    return;
                }

                // 2. MODAL DE ALERTA (S√ì OK)
                if (target.classList.contains('btn-ok')) {
                    const callback = AppState.onAlertCallback;
                    
                    AppState.onAlertCallback = null;
                    UIRenderer.fecharModal(); // Fecha primeiro!
                    
                    if (typeof callback === 'function') {
                        callback(); // Executa retorno (reabre modal anterior)
                    } else {
                        // L√≥gica de legado para contextos
                        if (AppState.modalContext === 'calculadoras') {
                            UIRenderer.abrirModal('calculadoras', {});
                            EventHandlers.handleRepopularCalculadora();
                        } else if (AppState.modalContext === 'custosMensais') {
                            const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                            if (meta) {
                                 UIRenderer.abrirModal('visualizarCustosMensais', { meta: meta });
                                 setTimeout(() => EventHandlers.handleRenderModalCustos(AppState.custosModalState.data), 0);
                            }
                        }
                    }
                    return;
                }

                // 3. BOT√ÉO CANCELAR GEN√âRICO (RASTRO DE P√ÉO)
                if (target.classList.contains('btn-cancelar')) {
                    // Voltar para Custos Mensais se estiver pagando um custo
                    if (AppState.modalContext === 'pagamento_custos_mensais') {
                        const metaCustos = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                        if (metaCustos) {
                            UIRenderer.abrirModal('visualizarCustosMensais', { meta: metaCustos });
                            setTimeout(() => EventHandlers.handleRenderModalCustos(AppState.custosModalState.data), 0);
                            AppState.modalContext = 'custosMensais'; 
                            return; 
                        }
                    }
                }

                // 4. FECHAMENTO PADR√ÉO
                AppState.currentScheduleModal = null;
                UIRenderer.fecharModal();
            }
          // >>> FIM DA CORRE√á√ÉO <<<3
            // Adicione este bloco dentro de handleModalClick
// Substitua o bloco do bot√£o salvar subcategoria dentro de handleModalClick:
// Substitua o bloco do bot√£o salvar subcategoria dentro de handleModalClick:
            if (target.id === 'btn-confirmar-salvar-sub') {
                const isEdicao = document.getElementById('sub-is-edicao').value === 'true';
                const nomeOriginal = document.getElementById('sub-nome-original').value;
                const catPai = document.getElementById('sub-categoria-pai').value;
                const novoNome = document.getElementById('sub-nome').value.trim();
                const novaCor = document.getElementById('sub-cor').value; // <--- CAPTURA A COR
                
                const iconeUrl = document.getElementById('sub-icone-url').value.trim();
                const iconeSelect = document.getElementById('sub-icone-select').value;
                const novoIcone = iconeUrl ? iconeUrl : iconeSelect;

                if (!novoNome) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'O nome √© obrigat√≥rio.' });
                    return;
                }

                const subs = AppState.configuracoes.subcategorias;
                if (!subs[catPai]) subs[catPai] = [];

                // Verifica duplicidade
                const duplicado = subs[catPai].some(s => {
                    const sNome = typeof s === 'string' ? s : s.nome;
                    return sNome.toLowerCase() === novoNome.toLowerCase() && sNome !== nomeOriginal;
                });

                if (duplicado) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'J√° existe uma subcategoria com esse nome.' });
                    return;
                }

                // Cria o objeto COM A COR
                const novaSubObj = { nome: novoNome, icone: novoIcone, cor: novaCor };

                if (isEdicao) {
                    const index = subs[catPai].findIndex(s => (typeof s === 'string' ? s : s.nome) === nomeOriginal);
                    if (index !== -1) {
                        subs[catPai][index] = novaSubObj;
                    }
                } else {
                    subs[catPai].push(novaSubObj);
                }
                
                if (target.classList.contains('btn-cancelar') || target.classList.contains('btn-ok') || target.classList.contains('btn-confirmar')) {
                
                // A) L√ìGICA DE CONFIRMA√á√ÉO (SIM/N√ÉO)
                if (AppState.onConfirmCallback) {
                    const isConfirm = target.classList.contains('btn-confirmar');
                    // Executa o callback com true (Sim) ou false (Cancelar)
                    AppState.onConfirmCallback(isConfirm);
                    
                    AppState.onConfirmCallback = null;
                    UIRenderer.fecharModal();
                    return;
                }

                // B) L√ìGICA DE ALERTA (OK COM RETORNO)
                if (target.classList.contains('btn-ok')) {
                    const callback = AppState.onAlertCallback;
                    
                    UIRenderer.fecharModal(); // Fecha o alerta
                    
                    if (typeof callback === 'function') {
                        console.log("üîÑ Executando callback de retorno...");
                        callback(); // REABRE O MODAL ANTERIOR
                    } else {
                        console.log("‚ùå Nenhum callback encontrado.");
                    }
                    
                    AppState.onAlertCallback = null;
                    
                    // L√≥gica de legado (Contextos antigos)
                    if (AppState.modalContext === 'calculadoras') {
                        UIRenderer.abrirModal('calculadoras', {});
                        EventHandlers.handleRepopularCalculadora();
                    } else if (AppState.modalContext === 'custosMensais') {
                        const meta = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                        if (meta) {
                             UIRenderer.abrirModal('visualizarCustosMensais', { meta: meta });
                             setTimeout(() => EventHandlers.handleRenderModalCustos(AppState.custosModalState.data), 0);
                        }
                    }
                    return;
                }

                // C) L√ìGICA DE CANCELAR ESPEC√çFICA (RASTRO DE P√ÉO)
                if (target.classList.contains('btn-cancelar')) {
                    if (AppState.modalContext === 'pagamento_custos_mensais') {
                        const metaCustos = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
                        if (metaCustos) {
                            UIRenderer.abrirModal('visualizarCustosMensais', { meta: metaCustos });
                            setTimeout(() => EventHandlers.handleRenderModalCustos(AppState.custosModalState.data), 0);
                            AppState.modalContext = 'custosMensais'; 
                            return; 
                        }
                    }
                }

                // D) FECHAMENTO PADR√ÉO
                AppState.currentScheduleModal = null;
                UIRenderer.fecharModal();
            }

                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                UIRenderer.renderSubcategorias();
                EventHandlers.handleCategoriaChange();
                return;
            }
      },
       handleToggleStatusView: () => {
            AppState.isStatusVisible = !AppState.isStatusVisible;
            localStorage.setItem('isStatusVisible_v6.4', JSON.stringify(AppState.isStatusVisible));
            UIRenderer.render();
            if (AppState.isStatusVisible) {
                EventHandlers.handleCategoriaChange();
            }
        },
   


      
        handleListaServicos: (e) => {
            const btn = e.target.closest('.btn-finalizar-servico');
            const btnDescartar = e.target.closest('.btn-descartar-servico');

            if (btnDescartar) {
                const servicoId = btnDescartar.dataset.id;
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Descartar Servi√ßo?',
                    mensagem: 'Tem certeza que deseja descartar este servi√ßo em andamento? Esta a√ß√£o n√£o pode ser desfeita.',
                    callback: (confirmado) => {
                        if (confirmado) {
                            const jornada = BusinessLogic.getJornadaAtiva();
                            if (jornada) {
                                jornada.servicosEmAndamento = jornada.servicosEmAndamento.filter(s => s.id !== servicoId);
                                Storage.salvarJornadas();
                                UIRenderer.render();
                            }
                        }
                    }
                });
                return;
            }

            if (!btn) return;

            const servicoId = btn.dataset.id;
            const jornada = BusinessLogic.getJornadaAtiva();
            const servico = jornada.servicosEmAndamento.find(s => s.id === servicoId);
            const isServicoRapido = servico.id.startsWith('servico-rapido');

            UIRenderer.abrirModal('finalizarServico', {
                titulo: isServicoRapido ? 'Finalizar Servi√ßo R√°pido' : 'Finalizar Servi√ßo',
                item: servico,
                isServicoRapido: isServicoRapido
            });
        },
            
        handleExcluirCustoVariavel: (e) => {
            const btn = e.target.closest('.btn-excluir-custo');
            if (btn) {
                const custoId = btn.dataset.id;
                const jornada = BusinessLogic.getJornadaDoDia(new Date());
                
                // 1. Remove da Jornada
                const indice = jornada.custos.outros.findIndex(c => c.id === custoId);
                if (indice !== -1) {
                    const custoRemovido = jornada.custos.outros[indice];
                    jornada.custos.outros.splice(indice, 1);
                    Storage.salvarJornadas();

                    // 2. >>> CORRE√á√ÉO: Remove do Financeiro tamb√©m <<<
                    // Procura a transa√ß√£o com o mesmo ID
                    AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => t.id !== custoId);
                    Storage.salvarConfiguracoes();
                    
                    UIRenderer.renderCustos(jornada);
                    UIRenderer.renderResumoDia(jornada);
                }
            }
        },
        
   

//vers√£o 4.7
handleCategoriaChange: () => {
            const { categoriaServicoSelect, subcategoriaServicoContainer, subcategoriaServicoSelect, descricaoServicoInput } = UIElements;
            const categoria = categoriaServicoSelect.value;
            const subcategorias = AppState.configuracoes.subcategorias[categoria] || [];
            
            if (subcategorias.length > 0) {
                subcategoriaServicoSelect.innerHTML = '<option value="">Selecione...</option>';
                subcategorias.forEach(sub => {
                    // Suporte a objeto {nome, cor} ou string antiga
                    const nome = typeof sub === 'string' ? sub : sub.nome;
                    subcategoriaServicoSelect.innerHTML += `<option value="${nome}">${nome}</option>`;
                });
                subcategoriaServicoContainer.classList.remove('hidden');
                
                // --- CORRE√á√ÉO: RECUPERA A √öLTIMA USADA ---
                const lastSub = AppState.lastSubcategories[categoria];
                if (lastSub) {
                    subcategoriaServicoSelect.value = lastSub;
                }
                // ------------------------------------------
            } else {
                subcategoriaServicoContainer.classList.add('hidden');
            }
            
            if (categoria === 'Entrega' || categoria === 'Outro') {
                descricaoServicoInput.value = AppState.lastDescriptions[categoria] || '';
            } else {
                descricaoServicoInput.value = '';
            }
        },

        handleIniciarServico: () => {
            const jornada = BusinessLogic.getJornadaAtiva();
            if (!jornada) return;

            let estavaEmPausa = false;
            if (jornada.status === 'em_pausa') {
                EventHandlers.handlePausa();
                estavaEmPausa = true;
            }

            const valor = Utils.parseMoeda(UIElements.valorServicoInput.value);
            if (valor <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Valor Inv√°lido', mensagem: 'Insira um valor maior que zero.' });
                if (estavaEmPausa) EventHandlers.handlePausa();
                return;
            }
            
            // --- CORRE√á√ÉO: KM AUTOM√ÅTICO INTELIGENTE ---
            // Se o campo estiver vazio, tenta pegar do GPS ou do √∫ltimo registro
            let kmInicialServico = parseFloat(UIElements.kmInicialServicoInput.value);
            
            if (isNaN(kmInicialServico) || kmInicialServico <= 0) {
                if (AppState.configuracoes.usarGpsTracking && AppState.gpsCurrentOdometer > 0) {
                    kmInicialServico = AppState.gpsCurrentOdometer;
                } else {
                    kmInicialServico = BusinessLogic.getUltimoKmRegistrado(); // Busca do hist√≥rico
                }
            }
            // -------------------------------------------

            const categoria = UIElements.categoriaServicoSelect.value;
            const subcategoria = UIElements.subcategoriaServicoSelect.value;
            
            // Salva a prefer√™ncia
            if (subcategoria) {
                AppState.lastSubcategories[categoria] = subcategoria;
                Storage.salvarUltimaSubcategoria();
            }
            
            jornada.servicosEmAndamento.push({ 
                id: crypto.randomUUID(), 
                valor, 
                categoria,
                subcategoria,
                descricao: UIElements.descricaoServicoInput.value.trim(), 
                inicio: Date.now(),
                kmInicialServico: kmInicialServico || null,
                iniciadoEmPausa: estavaEmPausa
            });
            
            // Limpa e reseta UI
            UIElements.valorServicoInput.value = '';
            UIElements.descricaoServicoInput.value = '';
            
            // Atualiza o input de KM para o pr√≥ximo (opcional, deixa pronto)
            UIElements.kmInicialServicoInput.value = kmInicialServico || ''; 
            
            Storage.salvarJornadas();
            AppState.isStatusVisible = false;
            UIRenderer.render(); 
        },
        handleTogglePendentes: () => {
            AppState.isPendentesVisible = !AppState.isPendentesVisible;
            const { isPendentesVisible, configuracoes } = AppState;
            const { tituloHistoricoCard, historicoDiaContainer, pendentesContainer, btnTogglePendentes, listaPendencias } = UIElements;

            if (isPendentesVisible) {
                tituloHistoricoCard.textContent = 'Pagamentos Pendentes';
                tituloHistoricoCard.classList.add('text-amber-400');
                historicoDiaContainer.classList.add('hidden');
                pendentesContainer.classList.remove('hidden');
                btnTogglePendentes.classList.add('text-cyan-400');

                listaPendencias.innerHTML = '';
                const pendentes = configuracoes.pagamentosPendentes || [];
                if (pendentes.length === 0) {
                    listaPendencias.innerHTML = `<li class="text-center text-slate-500 italic py-4">Nenhum pagamento pendente.</li>`;
                } else {
                    pendentes.sort((a, b) => (new Date(a.dataVencimento) || 0) - (new Date(b.dataVencimento) || 0));
                    
                    pendentes.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'bg-slate-800 p-4 rounded-lg fade-in';
                        
                        let vencimentoHTML = '';
                        if (item.dataVencimento) {
                            const hoje = new Date();
                            const venc = new Date(item.dataVencimento + "T12:00:00");
                            hoje.setHours(0, 0, 0, 0);
                            
                            const estaVencido = venc < hoje;
                            vencimentoHTML = `<span class="text-xs ${estaVencido ? 'text-red-400 font-bold' : 'text-slate-400'} block">Vence em: ${Utils.formatarDataParaDisplay(venc)}</span>`;
                        }

                        li.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0 pr-2">
                                    <span class="font-bold text-lg text-amber-400">${Utils.formatarMoeda(item.valor)}</span>
                                    <span class="text-sm text-slate-400 block truncate">${item.nomeCliente || 'Cliente n√£o informado'}</span>
                                    ${vencimentoHTML}
                                    <span class="text-xs text-slate-500 block">De: ${Utils.formatarDataParaDisplay(new Date(item.fim))}</span>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <button data-id="${item.idAtividade}" class="btn-marcar-pago bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-xs transition">Marcar Pago</button>
                                    <button data-id="${item.idAtividade}" class="btn-recibo-pendente text-cyan-600 hover:text-cyan-700 text-white font-bold py-1 px-3 rounded-lg text-xs transition">Recibo</button>
                                </div>
                            </div>
                        `;
                        listaPendencias.appendChild(li);
                    });
                }

            } else {
                tituloHistoricoCard.textContent = 'Hist√≥rico do Dia';
                tituloHistoricoCard.classList.remove('text-amber-400');
                historicoDiaContainer.classList.remove('hidden');
                pendentesContainer.classList.add('hidden');
                btnTogglePendentes.classList.remove('text-cyan-400');
            }
        },

// --- GERENCIAR CLIQUE NA LISTA DE PEND√äNCIAS (RECEBIMENTO) ---
        handleListaPendentesClick: (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const atividadeId = target.dataset.id;
            const { configuracoes, jornadas } = AppState;

            const itemPendenteIndex = configuracoes.pagamentosPendentes.findIndex(p => p.idAtividade === atividadeId);
            if (itemPendenteIndex === -1) return;

            const itemPendente = configuracoes.pagamentosPendentes[itemPendenteIndex];

            // 1. GERAR RECIBO
            if (target.classList.contains('btn-recibo-pendente')) {
                ReciboGenerator.gerarPDF(itemPendente);
                return;
            }

            // 2. MARCAR COMO PAGO (A CORRE√á√ÉO)
            if (target.classList.contains('btn-marcar-pago')) {
                
                // >>> CRIA O REGISTRO FINANCEIRO REAL <<<
                // Isso garante que o valor entre no DRE e no Saldo na data de hoje (Regime de Caixa)
                AppState.historicoTransacoes.push({
                    id: crypto.randomUUID(),
                    data: Date.now(), // Data do recebimento (Hoje)
                    contaId: 'AUTO_ID_CARTEIRA', // Entra na Carteira por padr√£o
                    tipo: 'entrada',
                    valor: itemPendente.valor,
                    descricao: `Recebimento: ${itemPendente.nomeCliente || 'Particular'} (Ref. servi√ßo passado)`,
                    categoria: itemPendente.categoria || 'Particular',
                    jornadaId: itemPendente.idJornada // Mant√©m o v√≠nculo com o dia original
                });

                // Remove da lista de pend√™ncias
                configuracoes.pagamentosPendentes.splice(itemPendenteIndex, 1);

                // Atualiza o status na jornada original (apenas para hist√≥rico visual)
                const idJornada = itemPendente.idJornada;
                if (idJornada && jornadas[idJornada]) {
                    const atividadeOriginal = jornadas[idJornada].atividades.find(a => a.id === atividadeId);
                    if (atividadeOriginal) {
                        atividadeOriginal.statusPagamento = 'pago';
                        atividadeOriginal.dataVencimento = null;
                    }
                    Storage.salvarJornadas();
                }

                Storage.salvarConfiguracoes();

                // Atualiza a UI
                UIRenderer.render(); // Atualiza saldo l√° em cima
                UIRenderer.renderContasBancarias();
                EventHandlers.handleTogglePendentes(); // Recarrega a lista
                
                // Reabre a lista para mostrar que sumiu (Hack visual do toggle)
                setTimeout(() => {
                   // Se a lista fechou, reabre. Se j√° estava aberta (recarregada), n√£o faz nada.
                   if (document.getElementById('pendentesContainer').classList.contains('hidden')) {
                       EventHandlers.handleTogglePendentes();
                   }
                }, 50);

                UIRenderer.abrirModal('alerta', { 
                    titulo: 'Recebido!', 
                    mensagem: `O valor de <b>${Utils.formatarMoeda(itemPendente.valor)}</b> foi adicionado ao seu saldo e ao DRE de hoje.`, 
                    type: 'success' 
                });
            }
        },
        
// =============================================================
        // HANDLER DE ABASTECIMENTO V34.1 (PRODUTOR COMPLETO)
        // =============================================================
        handleSalvarAbastecimentoPro: () => {
            const dataStr = document.getElementById('fuel-data').value;
            const hora = document.getElementById('fuel-hora').value; // PATCH 1: Capturado
            const postoNome = document.getElementById('fuel-posto').value.trim();
            const tipo = document.getElementById('fuel-tipo').value;
            const kmPainel = parseInt(document.getElementById('fuel-km').value) || 0;
            const valor = Utils.parseMoeda(document.getElementById('fuel-valor').value);
            const litros = Utils.parseMoeda(document.getElementById('fuel-litros').value);
            const leitura = Utils.parseMoeda(document.getElementById('fuel-leitura').value);
            const tanqueCheio = document.getElementById('fuel-tanque-cheio').checked;
            const ratingUser = parseInt(document.getElementById('fuel-rating-value').value) || 0;

            if (!dataStr || valor <= 0 || litros <= 0) {
                UIRenderer.abrirModal('alerta', { titulo: 'Dados Inv√°lidos', mensagem: 'Valores e Litros devem ser positivos.' });
                return;
            }

            // PATCH 2: Auditoria com Contexto Completo
            const historicoFuel = AppState.historicoTransacoes.filter(t => t.categoria === 'Abastecimento');
            const alertas = FuelAuditor.detectarAnomalias(
                { valorTotal: valor, litros, kmAtual: kmPainel, precoPorLitro: valor/litros }, // Contexto rico
                historicoFuel
            );
            
            const ultimoKm = BusinessLogic.getUltimoKmRegistrado();
            if (ultimoKm > 0 && kmPainel > 0 && kmPainel < ultimoKm) alertas.push(`‚ö†Ô∏è OD√îMETRO REGRESSIVO: Atual (${kmPainel}) < Anterior (${ultimoKm})`);

            if (alertas.length > 0) {
                if (!confirm("Inconsist√™ncias detectadas:\n" + alertas.join("\n") + "\n\nDeseja continuar para o pagamento?")) return;
            }

            // Intelig√™ncia (Score)
            let dadosEficiencia = { kmRodados: 0, media: 0, score: null };
            if (ultimoKm > 0 && kmPainel > ultimoKm) {
                const kmRodados = kmPainel - ultimoKm;
                dadosEficiencia = { kmRodados, media: kmRodados/litros, score: FuelAuditor.calcularScore(kmRodados, litros, AppState.configuracoes.veiculo) };
            }

            // --- EMPACOTAMENTO V34.1 (COM HORA E TIMESTAMP) ---
            const dadosAbastecimento = {
                litros, 
                posto: postoNome, 
                km: kmPainel,
                hora: hora || "12:00", // PATCH 1: Persist√™ncia da Hora
                kmRodados: dadosEficiencia.kmRodados,
                mediaTanque: dadosEficiencia.media,
                tipoCombustivel: tipo, 
                tanqueCheio, 
                leituraPainel: leitura,
                ratingMotorista: ratingUser, 
                ratingSistema: dadosEficiencia.score,
                idOriginal: AppState.itemParaEditarId || null,
                _ts: Date.now() // Contrato de Validade
            };

            // 1. Salva na Mem√≥ria
            AppState.tempAbastecimento = dadosAbastecimento;
            AppState.modalContext = 'pagamento_abastecimento';
            
            // 2. Salva no Disco (Backup)
            localStorage.setItem('temp_abastecimento_pendente', JSON.stringify(dadosAbastecimento));
            
            UIRenderer.fecharModal();

            // 3. Abre Pagamento
            setTimeout(() => {
                UIRenderer.abrirModal('novaTransacaoAvulsa', {
                    defaultTipo: 'saida',
                    defaultValor: valor,
                    defaultCategoria: 'Abastecimento',
                    defaultSubcategoria: 'Combust√≠vel',
                    defaultDescricao: `Abastecimento ${tipo} (${litros}L) - ${postoNome || 'Posto'}`,
                    isCustoOperacional: true,
                    defaultData: dataStr
                });
            }, 250);
        },





// =============================================================
        // RENDER LISTA V36.2 (L√ìGICA V36.1 + DIAGN√ìSTICO RICO)
        // =============================================================
        renderFuelHistoryList: () => {
            const lista = document.getElementById('lista-historico-combustivel');
            if (!lista) return;
            lista.innerHTML = '';
            
            // Sensibilidade do comparativo (R$ 0.02)
            const LIMIAR_ESTAVEL = 0.019; 

            // 1. Filtro e Ordena√ß√£o (V36.1 - L√≥gica Robusta)
            const abastecimentos = AppState.historicoTransacoes
                .filter(t => {
                    if (t.categoria !== 'Abastecimento') return false;
                    // Esconde parciais vazias (Splits financeiros)
                    if (t.split_id && (!t.detalhes?.litros || t.detalhes.litros <= 0)) return false;
                    return true;
                })
                .sort((a, b) => {
                    const timeA = new Date(a.data).getTime();
                    const timeB = new Date(b.data).getTime();
                    // Prioridade: Data mais recente
                    if (timeA !== timeB) return timeB - timeA;
                    // Desempate: Quem tem litros fica em cima (Pai vs Filho)
                    return (b.detalhes?.litros || 0) - (a.detalhes?.litros || 0);
                });

            if (abastecimentos.length === 0) {
                lista.innerHTML = '<li class="text-slate-500 text-center italic text-sm py-4">Nenhum hist√≥rico encontrado.</li>';
                return;
            }

            abastecimentos.forEach((t, index) => {
                const dataObj = new Date(t.data);
                const dataFmt = !isNaN(dataObj.getTime()) ? dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'Data Inv.';
                
                const detalhes = t.detalhes || {};
                const litros = detalhes.litros || 0;
                const nomePosto = detalhes.posto || 'Posto';
                
                // 2. C√°lculo Real (V36.1 - Usa valor do evento f√≠sico, n√£o da transa√ß√£o parcial)
                const valorParaCalculo = detalhes.valorEvento ? detalhes.valorEvento : t.valor;
                const precoPorLitro = (litros > 0) ? (valorParaCalculo / litros) : 0;
                
                const precoPorLitroFmt = precoPorLitro > 0 ? `R$ ${precoPorLitro.toFixed(2)}/L` : '';
                const valorTotalFmt = Utils.formatarMoeda(valorParaCalculo);

                // Badges e Estrelas
                const rating = detalhes.ratingMotorista || 0;
                const starsHTML = rating > 0 ? `<span class="text-yellow-500 text-[10px] ml-1">${'‚òÖ'.repeat(rating)}</span>` : '';
                
                let badgeSys = '';
                if (detalhes.ratingSistema && detalhes.ratingSistema.score) {
                    badgeSys = `<span class="text-[9px] font-bold px-1 py-0.5 rounded border border-slate-600 ml-1 ${detalhes.ratingSistema.classe}">${detalhes.ratingSistema.score.split(' ')[1] || detalhes.ratingSistema.score}</span>`;
                }

                // 3. Comparativo Rico (RESTAURADO: Tooltips com valores exatos)
                let comparativoHTML = '';
                if (index < abastecimentos.length - 1 && precoPorLitro > 0) {
                    const tAnt = abastecimentos[index + 1];
                    const litrosAnt = tAnt.detalhes?.litros || 0;
                    
                    if (litrosAnt > 0) {
                        // Garante compara√ß√£o justa (Evento vs Evento)
                        const valAnt = tAnt.detalhes?.valorEvento || tAnt.valor;
                        const precoAnt = valAnt / litrosAnt;
                        const diff = precoPorLitro - precoAnt;
                        
                        // Tooltips adicionados de volta para diagn√≥stico
                        if (diff > LIMIAR_ESTAVEL) {
                            comparativoHTML = `<span class="text-red-400 text-xs font-bold ml-1 cursor-help" title="Subiu R$ ${diff.toFixed(2)}">‚ñ≤</span>`;
                        } else if (diff < -LIMIAR_ESTAVEL) {
                            comparativoHTML = `<span class="text-green-400 text-xs font-bold ml-1 cursor-help" title="Caiu R$ ${Math.abs(diff).toFixed(2)}">‚ñº</span>`;
                        } else {
                            comparativoHTML = `<span class="text-slate-500 text-xs font-bold ml-1 cursor-help" title="Pre√ßo Est√°vel">=</span>`;
                        }
                    }
                }

                const iconeMisto = t.split_id ? '<span class="text-[9px] text-purple-400 border border-purple-500/50 px-1 rounded ml-1" title="Pagamento Misto/Parcelado">Misto</span>' : '';
                
                // 4. Diagn√≥stico de Erro (RESTAURADO: Diferencia Erro Atual de Legado)
                let alertaErro = '';
                if (litros <= 0) {
                    // Se tem valorEvento mas 0 litros, √© erro de persist√™ncia recente. Se n√£o, √© dado velho.
                    const tipoErro = detalhes.valorEvento ? '0L (Sync)' : '0L (Legado)';
                    alertaErro = `<span class="text-[9px] text-red-500 border border-red-500 px-1 rounded ml-1 bg-red-900/20 cursor-help" title="Registro inv√°lido. Recomendado excluir.">${tipoErro}</span>`;
                }

                lista.innerHTML += `
                    <li class="bg-slate-800 border-l-4 border-orange-500 p-3 rounded mb-2 shadow-lg relative group">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-white text-sm flex items-center flex-wrap gap-1">
                                    ${nomePosto} ${starsHTML} ${badgeSys} ${iconeMisto} ${alertaErro}
                                </div>
                                <div class="text-xs text-slate-400 mt-1 flex items-center">
                                    <span class="bg-slate-700 px-1.5 py-0.5 rounded text-slate-300 mr-1">${dataFmt}</span>
                                    <span class="font-mono text-slate-200">${litros.toFixed(1)} L</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-amber-400 text-lg leading-tight">${valorTotalFmt}</div>
                                <div class="text-[10px] text-slate-400 flex items-center justify-end">
                                    ${precoPorLitroFmt} ${comparativoHTML}
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-2 pt-2 border-t border-slate-700/50 opacity-60 group-hover:opacity-100 transition">
                            <button class="text-xs text-cyan-400 hover:text-white btn-editar-transacao" data-id="${t.id}">Editar</button>
                            <button class="text-xs text-red-500 hover:text-red-400 btn-excluir-transacao" data-id="${t.id}">Excluir</button>
                        </div>
                    </li>
                `;
            });
        },


     
       renderPostosList: () => {
            const lista = document.getElementById('lista-meus-postos');
            if (!lista) return;
            lista.innerHTML = '';
            
            const postos = AppState.postosCombustivel || [];
            if (postos.length === 0) {
                lista.innerHTML = '<li class="text-slate-500 text-center italic text-sm">Nenhum posto cadastrado.</li>';
                return;
            }

            postos.forEach(p => {
                // Link do Google Maps
                const query = encodeURIComponent(`${p.nome} ${p.endereco || ''}`);
                const mapsLink = `https://www.google.com/maps/search/?api=1&query=${query}`;

                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700 hover:bg-slate-750 transition';
                
                // Parte clic√°vel (abre detalhes)
                const infoDiv = document.createElement('div');
                infoDiv.className = "cursor-pointer flex-1";
                infoDiv.innerHTML = `
                    <span class="font-bold text-white block">${p.nome}</span>
                    <span class="text-xs text-slate-400">${p.bandeira || 'Bandeira n√£o inf.'}</span>
                `;
                infoDiv.onclick = () => EventHandlers.renderDetalhesPosto(p);

                // Bot√£o de Navega√ß√£o
                const navBtn = document.createElement('a');
                navBtn.href = mapsLink;
                navBtn.target = "_blank"; // Abre em nova aba/app
                navBtn.className = "text-cyan-400 hover:text-white text-xs border border-cyan-600 px-3 py-1.5 rounded flex items-center gap-1 ml-3 no-underline";
                navBtn.innerHTML = `Ir Agora üìç`;

                li.appendChild(infoDiv);
                li.appendChild(navBtn);
                lista.appendChild(li);
            });
        },
        renderDetalhesPosto: (posto) => {
            document.getElementById('view-lista-postos').classList.add('hidden');
            document.getElementById('view-detalhes-posto').classList.remove('hidden');
            
            document.getElementById('detalhe-posto-nome').textContent = posto.nome;
            document.getElementById('detalhe-posto-end').textContent = posto.endereco || 'Endere√ßo n√£o cadastrado';

            // --- CORRE√á√ÉO: IMAGEM GEN√âRICA ---
            const imgContainer = document.getElementById('detalhe-posto-img-container');
            const imgEl = document.getElementById('detalhe-posto-img');
            
            // URL de imagem gen√©rica (√çcone de posto flat design)
            const imagemPadrao = 'https://cdn-icons-png.flaticon.com/512/9800/9800512.png'; 

            if (posto.imagem || imagemPadrao) {
                imgEl.src = posto.imagem || imagemPadrao;
                imgContainer.classList.remove('hidden');
                // Ajuste de estilo para imagem gen√©rica ficar bonita (menor e centralizada se for padr√£o)
                if (!posto.imagem) {
                    imgEl.className = "w-full h-full object-contain opacity-40 p-4 bg-slate-800";
                } else {
                    imgEl.className = "w-full h-full object-cover opacity-60";
                }
            }
            // ---------------------------------

            const historico = AppState.historicoTransacoes.filter(t => 
                t.categoria === 'Abastecimento' && 
                t.descricao.toLowerCase().includes(posto.nome.toLowerCase())
            ).sort((a, b) => b.data - a.data);

            const totalGasto = historico.reduce((acc, t) => acc + t.valor, 0);
            document.getElementById('detalhe-total-gasto').textContent = Utils.formatarMoeda(totalGasto);
            document.getElementById('detalhe-visitas').textContent = historico.length;

            const ul = document.getElementById('lista-historico-posto-especifico');
            ul.innerHTML = '';

            if (historico.length === 0) {
                ul.innerHTML = '<li class="text-center text-slate-500 text-xs py-4">Nenhum abastecimento registrado com este nome exato.</li>';
            } else {
                historico.forEach((t, index) => {
                    const dataFmt = new Date(t.data).toLocaleDateString('pt-BR');
                    const matchL = t.descricao.match(/\(([\d,.]+)L\)/);
                    const litros = matchL ? parseFloat(matchL[1].replace(',', '.')) : 0;
                    const precoL = (litros > 0) ? (t.valor / litros) : 0;
                    
                    const rating = t.detalhes?.rating || 0;
                    const starsHTML = rating > 0 ? `<span class="text-yellow-500 text-xs ml-2">${'‚òÖ'.repeat(rating)}</span>` : '';
                    
                    let comparativoHTML = '';
                    if (index < historico.length - 1 && precoL > 0) {
                        const tAnt = historico[index+1];
                        const matchLAnt = tAnt.descricao.match(/\(([\d,.]+)L\)/);
                        const litrosAnt = matchLAnt ? parseFloat(matchLAnt[1].replace(',', '.')) : 0;
                        const precoLAnt = (litrosAnt > 0) ? (tAnt.valor / litrosAnt) : 0;
                        if (precoLAnt > 0) {
                            if (precoL > precoLAnt) comparativoHTML = `<span class="text-red-400 text-[10px] font-bold">‚ñ≤</span>`;
                            else if (precoL < precoLAnt) comparativoHTML = `<span class="text-green-400 text-[10px] font-bold">‚ñº</span>`;
                        }
                    }

                    ul.innerHTML += `
                        <li class="bg-slate-900 p-2 rounded flex justify-between items-center text-xs border border-slate-700">
                            <div>
                                <span class="text-slate-300">${dataFmt}</span>
                                <span class="text-slate-500 ml-1">${litros.toFixed(1)}L ${starsHTML}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-white">${Utils.formatarMoeda(t.valor)} ${comparativoHTML}</div>
                            </div>
                        </li>
                    `;
                });
            }
        },
       renderFuelCharts: () => {
            // Gr√°fico Mix (Pizza)
            const ctxMix = document.getElementById('chart-fuel-mix');
            if (ctxMix) {
                const dadosMix = FuelManager.gerarMixCombustivel();
                new Chart(ctxMix, {
                    type: 'pie',
                    data: {
                        labels: dadosMix.labels,
                        datasets: [{
                            data: dadosMix.data,
                            backgroundColor: ['#f59e0b', '#22c55e', '#ef4444', '#3b82f6'],
                            borderColor: '#1e293b'
                        }]
                    },
                    options: { plugins: { legend: { position: 'right', labels: { color: '#cbd5e1', font: { size: 10 } } } } }
                });
            }

            // Gr√°fico Piloto (Tend√™ncia)
            const ctxTrend = document.getElementById('chart-fuel-trend');
            if (ctxTrend) {
                const previsao = FuelManager.gerarPrevisaoGastos();
                if (previsao) {
                    new Chart(ctxTrend, {
                        type: 'bar',
                        data: {
                            labels: previsao.labels,
                            datasets: [
                                {
                                    label: 'Gasto Real',
                                    data: previsao.valoresReais,
                                    backgroundColor: '#f59e0b',
                                    order: 2
                                },
                                {
                                    type: 'line',
                                    label: 'Tend√™ncia/Previs√£o',
                                    data: previsao.valoresProjetados,
                                    borderColor: '#94a3b8',
                                    borderDash: [5, 5],
                                    pointBackgroundColor: '#ffffff',
                                    fill: false,
                                    order: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                            },
                            plugins: { legend: { labels: { color: '#cbd5e1' } } }
                        }
                    });
                } else {
                    ctxTrend.parentElement.innerHTML = '<p class="text-center text-xs text-slate-500 py-8">Dados insuficientes para previs√£o (min. 2 meses).</p>';
                }
            }
        },
        
        handleBuscarPostoGPS: () => {
            // 1. Verifica se o navegador suporta GPS
            if (!navigator.geolocation) {
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Seu navegador n√£o suporta geolocaliza√ß√£o.' });
                return;
            }

            // 2. Mostra aviso de carregamento
            UIRenderer.abrirModal('alerta', { titulo: 'Buscando...', mensagem: 'Consultando sat√©lites e mapa...' });

            // 3. Pega a posi√ß√£o
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                try {
                    // --- A M√ÅGICA ACONTECE AQUI (OVERPASS API) ---
                    // Busca n√≥s (node) que s√£o postos (amenity=fuel) num raio de 2000 metros (around:2000)
                    const query = `[out:json];node(around:2000,${lat},${lon})["amenity"="fuel"];out;`;
                    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
                    
                    const resp = await fetch(url);
                    const data = await resp.json();

                    UIRenderer.fecharModal();

                    if (!data || !data.elements || data.elements.length === 0) {
                        // Fallback: Se n√£o achar nada no mapa, preenche com gen√©rico
                        const input = document.getElementById('fuel-posto');
                        if (input) input.value = "Posto Local (GPS)";
                        UIRenderer.abrirModal('alerta', { titulo: 'Aviso', mensagem: 'Nenhum posto cadastrado no mapa pr√≥ximo. Usando nome gen√©rico.' });
                        return;
                    }

                    // Pega o primeiro posto que tiver nome
                    const postoEncontrado = data.elements.find(p => p.tags && p.tags.name);
                    const nomePosto = postoEncontrado ? postoEncontrado.tags.name : "Posto sem nome (GPS)";
                    const brand = postoEncontrado && postoEncontrado.tags.brand ? ` (${postoEncontrado.tags.brand})` : '';

                    // Preenche o campo
                    const input = document.getElementById('fuel-posto');
                    if (input) {
                        input.value = `${nomePosto}${brand}`;
                        
                        // (Opcional) Se tiver campo de endere√ßo, tenta preencher a rua
                        const inputEnd = document.getElementById('posto-endereco');
                        if (inputEnd && postoEncontrado.tags['addr:street']) {
                             inputEnd.value = `${postoEncontrado.tags['addr:street']}, ${postoEncontrado.tags['addr:housenumber'] || ''}`;
                        }
                    }
                    
                    UIRenderer.abrirModal('alerta', { titulo: 'Encontrado!', mensagem: `Localizado: ${nomePosto}`, type: 'success' });

                } catch (e) {
                    console.error("Erro API Mapa:", e);
                    UIRenderer.fecharModal();
                    // Fallback em caso de erro (sem internet ou API fora)
                    const input = document.getElementById('fuel-posto');
                    if (input) input.value = "Posto (GPS Detectado)";
                }

            }, (erro) => {
                UIRenderer.fecharModal();
                let msg = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                if (erro.code === 1) msg = 'Voc√™ precisa permitir o acesso ao GPS no navegador.';
                if (erro.code === 2) msg = 'Sinal de GPS indispon√≠vel.';
                if (erro.code === 3) msg = 'Tempo esgotado ao buscar GPS.';
                UIRenderer.abrirModal('alerta', { titulo: 'Erro GPS', mensagem: msg });
            }, {
                enableHighAccuracy: true, // Tenta usar GPS real do celular
                timeout: 10000,
                maximumAge: 0
            });
            
            
        },


// --- PAGAMENTO DE AMORTIZA√á√ÉO (CORRE√á√ÉO FINAL: MEM√ìRIA DE NAVEGA√á√ÉO) ---
        handleConfirmarPagamentoAmortizacao: (btn) => {
            const valorInput = document.getElementById('amort-valor-real');
            const pv = valorInput ? Utils.parseMoeda(valorInput.value) : 0;
            const qtdAmortizada = parseInt(btn.dataset.qtd) || 0;

            // 1. CAPTURA O CONTEXTO ATUAL ANTES DE QUALQUER COISA
            // Isso salva "quem" estamos pagando para n√£o perder a refer√™ncia
            const metaDividaId = AppState.itemParaEditarId;
            const metaDivida = AppState.configuracoes.metasFinanceiras.find(m => m.id === metaDividaId);
            
            if (!metaDivida?.financiamento) return; // Seguran√ßa b√°sica

            // --- ESTADO VISUAL PARA RESTAURAR ---
            const dataAtualStr = document.getElementById('amort-data-retro')?.value;
            const isMistoMarcado = document.getElementById('chk-amort-misto')?.checked;
            const c1 = document.getElementById('amort-conta-1')?.value;
            const v1 = document.getElementById('amort-valor-1')?.value;
            const c2 = document.getElementById('amort-conta-2')?.value;
            const v2 = document.getElementById('amort-valor-2')?.value;
            const fonteRadio = document.querySelector('input[name="fontePagamento"]:checked')?.value;
            
            // --- FUN√á√ÉO DE RESTAURA√á√ÉO BLINDADA ---
            const restaurarModalAnterior = () => {
                // >>> AQUI EST√Å A CORRE√á√ÉO: For√ßa o sistema a lembrar da d√≠vida <<<
                AppState.itemParaEditarId = metaDividaId; 
                
                UIRenderer.abrirModal('selecionarFontePagamento', {
                    pv: pv,
                    parcelas: qtdAmortizada,
                    dataRef: dataAtualStr
                });
                
                setTimeout(() => {
                    // Restaura checkbox e valores
                    if (isMistoMarcado) {
                        const chk = document.getElementById('chk-amort-misto');
                        if (chk) { 
                            chk.click(); 
                            document.getElementById('amort-conta-1').value = c1;
                            document.getElementById('amort-valor-1').value = v1;
                            document.getElementById('amort-conta-2').value = c2;
                            document.getElementById('amort-valor-2').value = v2;
                        }
                    } else if (fonteRadio) {
                        const radio = document.querySelector(`input[name="fontePagamento"][value="${fonteRadio}"]`);
                        if (radio) radio.click();
                    }
                }, 100);
            };

            if (pv <= 0) { 
                UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'Valor inv√°lido.', callback: restaurarModalAnterior }); 
                return; 
            }

            let dataPagamento = Date.now(); 
            const chkRetro = document.getElementById('chk-amort-retroativo');
            const inputData = document.getElementById('amort-data-retro');
            if (chkRetro && chkRetro.checked && inputData && inputData.value) {
                dataPagamento = new Date(inputData.value + "T12:00:00").getTime();
            }

            // --- VALIDA√á√ÉO DE INPUTS ---
            const isMisto = document.getElementById('chk-amort-misto')?.checked;
            const pagamentosParaProcessar = [];

            if (isMisto) {
                const c1_val = document.getElementById('amort-conta-1').value;
                const v1_val = Utils.parseMoeda(document.getElementById('amort-valor-1').value);
                const c2_val = document.getElementById('amort-conta-2').value;
                const v2_val = Utils.parseMoeda(document.getElementById('amort-valor-2').value);

                if (Math.abs((v1_val + v2_val) - pv) > 0.05) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: 'A soma das fontes n√£o bate com o total.', callback: restaurarModalAnterior }); 
                    return;
                }
                if (!c1_val || !c2_val) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Aten√ß√£o', mensagem: 'Selecione as duas contas.', callback: restaurarModalAnterior }); 
                    return;
                }
                const n1 = document.getElementById('amort-conta-1').selectedOptions[0].text;
                const n2 = document.getElementById('amort-conta-2').selectedOptions[0].text;
                
                if (v1_val > 0) pagamentosParaProcessar.push({ fonteId: c1_val, valor: v1_val, nome: n1 });
                if (v2_val > 0) pagamentosParaProcessar.push({ fonteId: c2_val, valor: v2_val, nome: n2 });
            } else {
                const fonteRadioEl = document.querySelector('input[name="fontePagamento"]:checked');
                if (!fonteRadioEl) { 
                    UIRenderer.abrirModal('alerta', { titulo: 'Aten√ß√£o', mensagem: 'Selecione a fonte de pagamento.', callback: restaurarModalAnterior }); 
                    return; 
                }
                let nFonte = fonteRadioEl.closest('label').querySelector('span.font-bold').textContent;
                pagamentosParaProcessar.push({ fonteId: fonteRadioEl.value, valor: pv, nome: nFonte });
            }

            // --- VALIDA√á√ÉO DE SALDO ---
            for (const pgto of pagamentosParaProcessar) {
                let saldoDisponivel = 0;

                // CASO 1: Caixinha Pr√≥pria
                if (pgto.fonteId === 'PROVISIONADO_PROPRIO') {
                    saldoDisponivel = metaDivida.valorProvisionado || 0;
                    if (saldoDisponivel < pgto.valor) {
                        const faltante = pgto.valor - saldoDisponivel;
                        const bancoVinculado = AppState.configuracoes.contasBancarias.find(c => c.id === (metaDivida.bancoId || 'AUTO_ID_CARTEIRA'));
                        const nomeBanco = bancoVinculado ? bancoVinculado.nome : 'Carteira';
                        
                        UIRenderer.abrirModal('confirmacao', {
                            titulo: 'Saldo Insuficiente na Caixinha',
                            mensagem: `
                                <div class="text-left text-sm space-y-2">
                                    <p>A caixinha tem apenas <b class="text-amber-400">${Utils.formatarMoeda(saldoDisponivel)}</b>.</p>
                                    <p>Faltam <b class="text-red-400">${Utils.formatarMoeda(faltante)}</b>.</p>
                                    <p>Deseja usar o saldo da caixinha e completar o resto com o <b>${nomeBanco}</b>?</p>
                                </div>`,
                            confirmText: 'Sim, Completar',
                            cancelText: 'Cancelar',
                            confirmClass: 'bg-emerald-600 hover:bg-emerald-700',
                            callback: (confirmado) => { 
                                if (confirmado) executarLogicaPagamento(); 
                                else restaurarModalAnterior(); 
                            }
                        });
                        return; 
                    }
                } 
                // CASO 2: Outra Fonte
                else {
                    saldoDisponivel = BusinessLogic.calcularSaldoConta(pgto.fonteId);
                    
                    if (saldoDisponivel < pgto.valor) {
                        const isCaixinha = AppState.configuracoes.metasFinanceiras.some(m => m.id === pgto.fonteId);
                        
                        if (isCaixinha) {
                             UIRenderer.abrirModal('alerta', { 
                                titulo: 'Opera√ß√£o Bloqueada', 
                                mensagem: `A caixinha <b>${pgto.nome.split('(')[0]}</b> tem apenas <b>${Utils.formatarMoeda(saldoDisponivel)}</b>.<br><br>Caixinhas n√£o possuem cheque especial.`,
                                callback: restaurarModalAnterior 
                            });
                            return;
                        } else {
                            const futuroSaldo = saldoDisponivel - pgto.valor;
                            UIRenderer.abrirModal('confirmacao', {
                                titulo: 'Saldo Insuficiente',
                                mensagem: `
                                    <div class="text-left text-sm space-y-2">
                                        <p>A conta <b>${pgto.nome.split('(')[0]}</b> tem apenas <b class="text-amber-400">${Utils.formatarMoeda(saldoDisponivel)}</b>.</p>
                                        <p>O pagamento √© de <b>${Utils.formatarMoeda(pgto.valor)}</b>.</p>
                                        <hr class="border-slate-600">
                                        <p>Saldo Final Previsto: <b class="text-red-400">${Utils.formatarMoeda(futuroSaldo)}</b></p>
                                        <p class="mt-2 font-bold text-white">Deseja confirmar mesmo assim (Cheque Especial)?</p>
                                    </div>`,
                                confirmText: 'Sim, Pagar e Negativar',
                                cancelText: 'Voltar',
                                confirmClass: 'bg-red-600 hover:bg-red-700',
                                callback: (confirmado) => { 
                                    if (confirmado) executarLogicaPagamento(); 
                                    else restaurarModalAnterior(); 
                                }
                            });
                            return; 
                        }
                    }
                }
            }

            executarLogicaPagamento();

            function executarLogicaPagamento() {
                const snapshot = {
                    valorProvisionado: metaDivida.valorProvisionado || 0,
                    parcelasPagas: metaDivida.financiamento.parcelasPagas || 0,
                    totalAmortizado: metaDivida.financiamento.totalAmortizado || 0,
                    historico: [...AppState.historicoTransacoes]
                };
                const batchId = crypto.randomUUID();

                const processarItem = (item) => {
                    const { fonteId, valor } = item;
                    try {
                        if (fonteId === 'PROVISIONADO_PROPRIO') {
                            const saldoDisponivel = metaDivida.valorProvisionado || 0;
                            const valorResgate = Math.min(saldoDisponivel, valor);
                            metaDivida.valorProvisionado = Math.max(0, saldoDisponivel - valorResgate);
                            
                            const bancoRealId = metaDivida.bancoId || 'AUTO_ID_CARTEIRA';
                            const banco = AppState.configuracoes.contasBancarias.find(c => c.id === bancoRealId);
                            const nomeBanco = banco ? banco.nome : 'Carteira';

                            if (valorResgate > 0) {
                                AppState.historicoTransacoes.push({
                                    id: crypto.randomUUID(), data: dataPagamento, tipo: 'transferencia',
                                    valor: valorResgate, contaId: bancoRealId, descricao: `Resgate Autom√°tico: ${metaDivida.descricao}`,
                                    origem: { id: metaDividaId, nome: metaDivida.descricao, tipo: 'caixinha' },
                                    destino: { id: bancoRealId, nome: nomeBanco, tipo: 'conta' },
                                    detalhes: { batchId: batchId, leg: 'destination' }
                                });
                            }
                            AppState.historicoTransacoes.push({
                                id: crypto.randomUUID(), data: dataPagamento + 100, tipo: 'saida', valor: valor,
                                contaId: bancoRealId, descricao: `Amortiza√ß√£o: ${metaDivida.descricao} (${isMisto ? 'Parcial' : qtdAmortizada + 'x'})`,
                                categoria: 'Metas Financeiras', detalhes: { batchId: batchId, tipo: 'amortizacao_saida_banco' }
                            });
                            AppState.historicoTransacoes.push({
                                id: crypto.randomUUID(), data: dataPagamento + 200, tipo: 'entrada', valor: valor,
                                contaId: metaDividaId, descricao: `Amortiza√ß√£o via ${nomeBanco}`, categoria: 'Metas Financeiras',
                                detalhes: { batchId: batchId, tipo: 'amortizacao_entrada', qtdParcelas: (isMisto ? 0 : qtdAmortizada) }
                            });

                        } else {
                            const f = AppState.configuracoes.contasBancarias.find(c => c.id === fonteId) || AppState.configuracoes.metasFinanceiras.find(m => m.id === fonteId);
                            const nomeFonte = f?.nome || f?.descricao || 'Carteira';

                            AppState.historicoTransacoes.push({
                                id: crypto.randomUUID(), data: dataPagamento, tipo: 'saida', valor: valor, contaId: fonteId,
                                descricao: `Amortiza√ß√£o D√≠vida: ${metaDivida.descricao} (${isMisto ? 'Parcial' : qtdAmortizada + 'x'})`,
                                categoria: 'Metas Financeiras', detalhes: { batchId: batchId, tipo: 'amortizacao_saida' }
                            });
                            AppState.historicoTransacoes.push({
                                id: crypto.randomUUID(), data: dataPagamento, tipo: 'entrada', valor: valor, contaId: metaDividaId,
                                descricao: `Pgto Recebido via ${nomeFonte}`, categoria: 'Metas Financeiras',
                                detalhes: { batchId: batchId, tipo: 'amortizacao_entrada', qtdParcelas: (isMisto ? 0 : qtdAmortizada) }
                            });
                        }
                    } catch (e) {
                        Object.assign(metaDivida, { valorProvisionado: snapshot.valorProvisionado });
                        Object.assign(metaDivida.financiamento, { parcelasPagas: snapshot.parcelasPagas, totalAmortizado: snapshot.totalAmortizado });
                        AppState.historicoTransacoes = snapshot.historico;
                        throw e;
                    }
                };

                try {
                    pagamentosParaProcessar.forEach(processarItem);
                    if(!isMisto) metaDivida.financiamento.parcelasPagas = (metaDivida.financiamento.parcelasPagas || 0) + qtdAmortizada;
                    metaDivida.financiamento.totalAmortizado = (metaDivida.financiamento.totalAmortizado || 0) + pv;
                    
                    Storage.salvarConfiguracoes();
                    BusinessLogic.atualizarProgressoFinanciamentos();
                    UIRenderer.fecharModal(); 
                    UIRenderer.fecharModal(); 
                    UIRenderer.render();      
                    UIRenderer.renderMetasFinanceiras();
                    UIRenderer.renderContasBancarias(); 
                    
                    UIRenderer.abrirModal('alerta', { titulo: 'Amortiza√ß√£o Realizada!', mensagem: `Valor Total: ${Utils.formatarMoeda(pv)}.<br>Parcelas: ${qtdAmortizada}.`, type: 'success' });
                } catch (err) {
                    UIRenderer.abrirModal('alerta', { titulo: 'Erro', mensagem: err.message, callback: restaurarModalAnterior });
                }
            }
        },
 };
    // =============================================================
    // ======================= INIT ================================
    // =============================================================
    const initDashboard = () => {
        const hoje = new Date();
        const anoAtual = hoje.getFullYear();
        const mesAtual = hoje.getMonth();

        // Popula Anos (Atual e 2 anteriores)
        UIElements.selectAno.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const ano = anoAtual - i;
            UIElements.selectAno.innerHTML += `<option value="${ano}">${ano}</option>`;
        }
        UIElements.selectAno.value = anoAtual;

        // Popula Meses (Com "Ano Inteiro")
        const meses = [
            "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        UIElements.selectMes.innerHTML = `<option value="-1">Ano Inteiro</Opc√£o>`;
        meses.forEach((mes, index) => {
            UIElements.selectMes.innerHTML += `<option value="${index}">${mes}</option>`;
        });
        UIElements.selectMes.value = mesAtual;
    };
    // =================================================================
    // M√ìDULO DE ACELERA√á√ÉO (INJE√á√ÉO SEGURA)
    // =================================================================
    
    // 1. L√≥gica Matem√°tica (Distribui√ß√£o de Pesos)
    BusinessLogic.recalcularPesosAceleracao = (listaItens, idItemAlterado, novoPercentual) => {
        if (novoPercentual < 0) novoPercentual = 0;
        if (novoPercentual > 100) novoPercentual = 100;

        // Atualiza o item que voc√™ mexeu
        const itemPrincipal = listaItens.find(i => i.idCustoFixo === idItemAlterado);
        if (itemPrincipal) itemPrincipal.pesoAceleracao = novoPercentual;

        // Calcula a sobra para os outros
        const percentualRestante = 100 - novoPercentual;
        const outrosItens = listaItens.filter(i => i.idCustoFixo !== idItemAlterado);
        const qtdOutros = outrosItens.length;

        // Distribui a sobra igualmente
        if (qtdOutros > 0) {
            const fatiaParaCada = percentualRestante / qtdOutros;
            outrosItens.forEach(item => {
                item.pesoAceleracao = parseFloat(fatiaParaCada.toFixed(2)); 
            });
            
            // Ajuste fino para fechar 100% cravado
            const somaAtual = listaItens.reduce((acc, i) => acc + i.pesoAceleracao, 0);
            const diferenca = 100 - somaAtual;
            if (Math.abs(diferenca) > 0.001) {
                outrosItens[0].pesoAceleracao += diferenca;
            }
        }
        return listaItens;
    };

    // 2. L√≥gica Visual (Tela de Configura√ß√£o)
    UIRenderer.renderConfigurarAceleracao = () => {
        const metaCustos = AppState.configuracoes.metasFinanceiras.find(m => m.id === 'META_CUSTOS_MENSAIS');
        if (!metaCustos) return;

        // Garante pesos iniciais
        if (!metaCustos.custosDetalhados) metaCustos.custosDetalhados = [];
        const totalItens = metaCustos.custosDetalhados.length;
        
        metaCustos.custosDetalhados.forEach(c => {
            if (typeof c.pesoAceleracao === 'undefined' || c.pesoAceleracao === null) {
                c.pesoAceleracao = (100 / Math.max(1, totalItens));
            }
        });

        const valorAceleracaoTotal = metaCustos.valorAceleracaoDiaria || 0;

        const htmlItens = metaCustos.custosDetalhados.map(item => {
            const valorReais = (valorAceleracaoTotal * (item.pesoAceleracao / 100));
            return `
            <div class="bg-slate-700/50 p-3 rounded mb-2 border border-slate-600 flex items-center justify-between gap-4">
                <div class="flex-1">
                    <p class="text-sm font-bold text-white truncate">${item.descricao}</p>
                    <p class="text-[10px] text-slate-400">Recebe: <span class="text-green-400 font-bold">+${Utils.formatarMoeda(valorReais)}/dia</span></p>
                </div>
                <div class="flex items-center gap-2 w-40">
                    <input type="range" 
                           min="0" max="100" step="1" 
                           value="${Math.round(item.pesoAceleracao)}" 
                           data-id="${item.idCustoFixo}"
                           class="slider-peso w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                    
                    <div class="relative">
                        <input type="number" 
                               value="${Math.round(item.pesoAceleracao)}" 
                               data-id="${item.idCustoFixo}"
                               class="input-peso w-14 bg-slate-800 border border-slate-500 rounded px-1 py-1 text-center text-xs text-white font-bold focus:border-cyan-500 outline-none">
                        <span class="absolute right-1 top-1 text-[10px] text-slate-500">%</span>
                    </div>
                </div>
            </div>`;
        }).join('');

        const modalHTML = `
            <div class="bg-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white">üöÄ Acelerar Provisionamento</h3>
                    <button class="btn-fechar-modal text-slate-400 hover:text-white text-2xl">√ó</button>
                </div>

                <div class="mb-6 bg-cyan-900/20 p-4 rounded-lg border border-cyan-800/50">
                    <label class="block text-xs text-cyan-400 font-bold uppercase mb-2">Valor Extra Di√°rio (Total)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-slate-400">R$</span>
                        <input type="text" id="input-valor-aceleracao" 
                               value="${Utils.formatarMoedaParaInput(valorAceleracaoTotal)}" 
                               class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 pl-8 text-white font-bold text-lg focus:border-cyan-500 outline-none"
                               placeholder="0,00">
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2">Este valor ser√° somado √† meta di√°ria base e dividido conforme os pesos abaixo.</p>
                </div>

                <div class="max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <span class="text-xs text-slate-400">Distribui√ß√£o do Extra</span>
                        <span class="text-xs text-slate-400" id="soma-total-pesos">Total: 100%</span>
                    </div>
                    <div id="container-sliders-pesos">
                        ${htmlItens}
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-700">
                    <button class="btn-fechar-modal px-4 py-2 rounded bg-slate-700 text-slate-300 hover:bg-slate-600 text-sm font-bold">Cancelar</button>
                    <button id="btn-salvar-aceleracao" class="px-6 py-2 rounded bg-cyan-600 text-white hover:bg-cyan-500 text-sm font-bold shadow-lg shadow-cyan-900/50 transition-all">Salvar Distribui√ß√£o</button>
                </div>
            </div>`;

        const modalContainer = document.getElementById('modalContainer');
        modalContainer.innerHTML = modalHTML;
        modalContainer.classList.remove('hidden');

        // Listeners
        setTimeout(() => {
            const container = document.getElementById('container-sliders-pesos');
            const inputs = container.querySelectorAll('.input-peso, .slider-peso');
            const inputTotal = document.getElementById('input-valor-aceleracao');

            const atualizarUI = () => {
                const totalReais = Utils.parseMoeda(inputTotal.value);
                let somaPesos = 0;

                metaCustos.custosDetalhados.forEach(item => {
                    const inputRef = container.querySelector(`input[data-id="${item.idCustoFixo}"]`);
                    if(!inputRef) return;
                    
                    const row = inputRef.closest('div.bg-slate-700\\/50');
                    const spanValor = row.querySelector('span.text-green-400');
                    const inputNum = row.querySelector('.input-peso');
                    const inputSlide = row.querySelector('.slider-peso');
                    
                    inputNum.value = Math.round(item.pesoAceleracao);
                    inputSlide.value = Math.round(item.pesoAceleracao);
                    somaPesos += item.pesoAceleracao;

                    const parteReais = (totalReais * (item.pesoAceleracao / 100));
                    spanValor.textContent = `+${Utils.formatarMoeda(parteReais)}/dia`;
                });

                const lblTotal = document.getElementById('soma-total-pesos');
                if (Math.round(somaPesos) !== 100) {
                    lblTotal.textContent = `Total: ${Math.round(somaPesos)}% (Ajuste!)`;
                    lblTotal.className = "text-xs text-red-400 font-bold";
                } else {
                    lblTotal.textContent = "Total: 100%";
                    lblTotal.className = "text-xs text-green-400 font-bold";
                }
            };

            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const idAlterado = e.target.dataset.id;
                    let novoValor = parseFloat(e.target.value);
                    
                    BusinessLogic.recalcularPesosAceleracao(metaCustos.custosDetalhados, idAlterado, novoValor);
                    atualizarUI();
                });
            });

            inputTotal.addEventListener('input', atualizarUI);

            document.getElementById('btn-salvar-aceleracao').addEventListener('click', () => {
                metaCustos.valorAceleracaoDiaria = Utils.parseMoeda(inputTotal.value);
                Storage.salvarConfiguracoes();
                UIRenderer.fecharModal();
                
                UIRenderer.abrirModal('visualizarCustosMensais', { meta: metaCustos });
                setTimeout(() => EventHandlers.handleRenderModalCustos(new Date()), 100);

                UIRenderer.abrirModal('alerta', { titulo: 'Acelera√ß√£o Configurada!', mensagem: 'Os valores di√°rios foram atualizados.', type: 'success' });
            });

            document.querySelectorAll('.btn-fechar-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    UIRenderer.fecharModal();
                    UIRenderer.abrirModal('visualizarCustosMensais', { meta: metaCustos });
                    setTimeout(() => EventHandlers.handleRenderModalCustos(new Date()), 100);
                });
            });

        }, 100);
    };

    // 3. Handler de Atalho
    EventHandlers.handleAbrirAceleracao = () => {
        UIRenderer.renderConfigurarAceleracao();
    };
    // =================================================================
    
// --- NOVA FUN√á√ÉO DE SEGURAN√áA DE DADOS ---
const verificarNecessidadeBackup = () => {
        const ultimoBackup = localStorage.getItem('ultimoBackupData');
        const agora = Date.now();
        const SETE_DIAS = 7 * 24 * 60 * 60 * 1000; // 7 dias em milissegundos

        // Se nunca fez backup OU se o √∫ltimo foi h√° mais de 7 dias
        if (!ultimoBackup || (agora - parseInt(ultimoBackup)) > SETE_DIAS) {
            // Pequeno delay para n√£o encavalar com outros modais de inicializa√ß√£o
            setTimeout(() => {
                UIRenderer.abrirModal('confirmacao', {
                    titulo: 'Backup Recomendado',
                    mensagem: 'Faz mais de 7 dias que voc√™ n√£o exporta seus dados. Como o sistema roda no seu navegador, √© importante fazer backup para evitar perdas. Deseja baixar agora?',
                    confirmLabel: "Baixar Backup",
                    cancelLabel: "Lembrar depois", // Agora funciona como "Soneca"
                    confirmClass: 'bg-sky-600 hover:bg-sky-700',
                    callback: (sim) => {
                        if (sim) {
                            // Se confirmou, baixa e salva a data (j√° faz isso no handleExportarDados)
                            EventHandlers.handleExportarDados();
                        } else {
                            // --- CORRE√á√ÉO: L√ìGICA DE SONECA ---
                            // Se clicou em "Lembrar depois", atualizamos a data para HOJE.
                            // Assim, ele s√≥ vai perguntar de novo daqui a 7 dias.
                            localStorage.setItem('ultimoBackupData', Date.now().toString());
                            console.log("Aviso de backup adiado por 7 dias.");
                        }
                    }
                });
            }, 1500);
        }
    };
    
    const initApp = () => {
        SystemHealthCheck.run();
        Storage.carregarVisualSettings();
        EventHandlers.applyVisualSettings();
        Storage.carregarDados();
        // =========================================================
        // üßπ AQUI! INSIRA O FAXINEIRO AQUI (V139)
        // =========================================================
        if (typeof SystemMigrator !== 'undefined') {
            console.log("üßπ Executando migra√ß√£o de sistema...");
            SystemMigrator.executar();
        }
        // =========================================================
        EventHandlers.init();
        initDashboard();
        EventHandlers.handleCategoriaChange();
        
        BusinessLogic.verificarViradaFaturas();
        
        
        // üõ°Ô∏è PATCH DE INICIALIZA√á√ÉO: Garante que as arrays existam
            if (!AppState.historicoManutencao) AppState.historicoManutencao = [];
            if (!AppState.configuracoes.planoManutencao) AppState.configuracoes.planoManutencao = [];
            if (!AppState.planoManutencao) AppState.planoManutencao = []; // Caso esteja na raiz em alguma vers√£o
                
        
        
        if (UIElements.metaDataVencimentoInput) {
            UIElements.metaDataVencimentoInput.min = Utils.getDataInputHoje();
        }
        
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        
        if (UIElements.reportStartDate) {
            UIElements.reportStartDate.value = Utils.formatarDataParaChave(inicioMes);
        }
        if (UIElements.reportEndDate) {
            UIElements.reportEndDate.value = Utils.formatarDataParaChave(fimMes);
        }
        
        AppState.isStatusVisible = JSON.parse(localStorage.getItem('isStatusVisible_v6.4')) ?? true;
        
        const jornadaAtiva = BusinessLogic.getJornadaAtiva();
        if (jornadaAtiva) {
            TimeManager.iniciarCronometro();
        }
        
        
        
        
        
        
        
        
        
        
        
        UIRenderer.render();
        UIRenderer.renderPlanoMestre();
        UIRenderer.renderHistoricoServicos();
        UIRenderer.renderCotaServicos();
        UIRenderer.renderContasBancarias();

        UIElements.tabs[0].classList.add('active');
        UIElements.tabContents.jornada.classList.remove('hidden');
        
        verificarNecessidadeBackup();
   // window.App = { AppState, BusinessLogic, UIRenderer, EventHandlers, Storage };
   // --- SAFETY NET: LIBERA√á√ÉO DE LOCKS AO FECHAR ABA ---
    window.addEventListener('beforeunload', () => {
        const lockKeys = ['app_transfer_lock', 'app_payment_lock', 'app_transacao_lock'];
        
        lockKeys.forEach(key => {
            try {
                const raw = localStorage.getItem(key);
                if (raw) {
                    const lock = JSON.parse(raw);
                    // Se eu sou o dono deste lock, libero antes de morrer
                    // (Nota: lockOwner precisaria ser escopo global ou armazenado na session, 
                    //  mas limpar baseada no TTL curto de 5s j√° √© seguro o suficiente para este cen√°rio)
                    localStorage.removeItem(key); 
                }
            } catch (e) { /* Silent fail */ }
        });
    });
    };



  // =================================================================
// 5. HELPER GLOBAL: EXCLUS√ÉO INTELIGENTE (COLE NO FINAL DO ARQUIVO)
// =================================================================
window.excluirTransacaoInteligente = (idAlvo) => {
    // 1. Localiza o alvo
    const alvo = AppState.historicoTransacoes.find(t => t.id === idAlvo);
    if (!alvo) return;

    // 2. Detecta transa√ß√µes "g√™meas" (mesmo timestamp exato)
    // Isso serve para deletar (Parcial 1) e (Parcial 2) juntos, 
    // ou deletar (Lan√ßamento Fatura) e (Lan√ßamento Caixa) juntos.
    const transacoesGemeas = AppState.historicoTransacoes.filter(t => 
        t.data === alvo.data && 
        t.categoria === alvo.categoria && 
        !t.invalida
    );

    const qtd = transacoesGemeas.length; 
    let msg = "Tem certeza que deseja excluir esta transa√ß√£o?";
    
    if (qtd > 1) {
        msg = `Detectei <b>${qtd} registros vinculados</b> (ex: Parciais ou Lan√ßamento Cruzado).<br>Deseja excluir TODOS de uma vez para manter a integridade?`;
    }

    // 3. Pede confirma√ß√£o
    UIRenderer.abrirModal('confirmacao', {
        titulo: 'Excluir Transa√ß√£o',
        mensagem: msg,
        callback: (confirmado) => {
            if (confirmado) {
                // Lista de IDs para matar
                // Lista de IDs para matar
                const idsParaDeletar = transacoesGemeas.map(t => t.id);
                if(!idsParaDeletar.includes(idAlvo)) idsParaDeletar.push(idAlvo);

                // Remove do array (Hard Delete)
                AppState.historicoTransacoes = AppState.historicoTransacoes.filter(t => !idsParaDeletar.includes(t.id));

                // Salva
                Storage.salvarTransacoes ? Storage.salvarTransacoes() : Storage.salvarConfiguracoes();
                
                // Feedback e Reload
                alert("üóëÔ∏è Transa√ß√µes removidas com sucesso!");
                
                // Fecha modal se estiver aberto
                if(typeof UIRenderer.fecharModal === 'function') UIRenderer.fecharModal();
                
                // Recarrega a p√°gina para atualizar Extratos e Saldos
                location.reload(); 
            }
        }
    });
};  
    // =================================================================
// FUN√á√ÉO DE EXCLUS√ÉO INTELIGENTE (REMOVE PARCIAIS JUNTAS)
// =================================================================
const excluirTransacaoInteligente = (idAlvo) => {
    const alvo = AppState.historicoTransacoes.find(t => t.id === idAlvo);
    if (!alvo) return;
    const transacoesGemeas = AppState.historicoTransacoes.filter(t => 
        t.data === alvo.data && t.categoria === alvo.categoria && !t.invalida
    );
    const qtd = transacoesGemeas.length;
    let msg = "Tem certeza que deseja excluir esta transa√ß√£o?";
    if (qtd > 1) msg = `Detectei ${qtd} pagamentos vinculados (Parciais). Deseja excluir TODOS de uma vez?`;

    UIRenderer.abrirModal('confirmacao', {
        titulo: 'Excluir Transa√ß√£o',
        mensagem: msg,
        callback: (confirmado) => {
            if (confirmado) {
                transacoesGemeas.forEach(gemea => {
                    const index = AppState.historicoTransacoes.findIndex(t => t.id === gemea.id);
                    if (index > -1) AppState.historicoTransacoes.splice(index, 1);
                });
                Storage.salvarTransacoes ? Storage.salvarTransacoes() : Storage.salvarConfiguracoes();
                alert("üóëÔ∏è Transa√ß√µes removidas com sucesso!");
                if(UIRenderer.fecharModal) UIRenderer.fecharModal();
                const container = document.getElementById('modalContainer');
                if(container && !container.classList.contains('hidden')) {
                     // Se estiver no extrato, tenta recarregar s√≥ o extrato ou a pagina toda
                     location.reload();
                } else {
                     location.reload();
                }
            }
        }
    });
};
    
    // =============================================================
// ================= SYSTEM HEALTH CHECK (BOOT) ================
// =============================================================
const SystemHealthCheck = {
    run: () => {
        const criticalDeps = [
            { name: 'Utils', check: () => typeof Utils !== 'undefined' },
            { name: 'Utils.Money.toCents', check: () => typeof Utils?.Money?.toCents === 'function' },
            { name: 'Utils.Money.fromCents', check: () => typeof Utils?.Money?.fromCents === 'function' },
            { name: 'Utils.gerarUUID', check: () => typeof Utils?.gerarUUID === 'function' },
            { name: 'Utils.formatarDataParaChave', check: () => typeof Utils?.formatarDataParaChave === 'function' },
            { name: 'BusinessLogic.calcularSaldoConta', check: () => typeof BusinessLogic?.calcularSaldoConta === 'function' }
        ];

        const failures = criticalDeps.filter(dep => !dep.check());

        if (failures.length > 0) {
            const msg = `‚õî ERRO CR√çTICO DE SISTEMA\n\nDepend√™ncias obrigat√≥rias n√£o encontradas:\n${failures.map(f => `‚ùå ${f.name}`).join('\n')}\n\nO sistema foi interrompido para evitar corrup√ß√£o de dados.`;
            console.error(msg);
            alert(msg);
            throw new Error('SystemHealthCheck Failed: Aborting Boot');
        }

        console.info('‚úÖ SystemHealthCheck: Integridade de depend√™ncias validada.');
        return true;
    }
};
    
// ============================================================================
    // SAFETY NET: DESFIBRILADOR DE UI (CORRE√á√ÉO DO MODO ZUMBI)
    // ============================================================================
    // Detecta quando o usu√°rio volta para a aba e limpa estados travados
    // causados pelo congelamento de scripts do navegador em segundo plano.
    // ============================================================================
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            console.log("üëÅÔ∏è Aba fcou vis√≠vel: Verificando integridade da UI...");
            
            // 1. Verifica Locks Expirados no Storage
            const LOCK_KEY = 'app_transacao_lock';
            try {
                const lockRaw = localStorage.getItem(LOCK_KEY);
                if (lockRaw) {
                    const lock = JSON.parse(lockRaw);
                    const now = Date.now();
                    // Se o lock tem mais de 6 segundos, √© lixo de processo zumbi. Mata.
                    if (now - lock.ts > 6000) {
                        console.warn("üíÄ Lock Zumbi detectado e removido.");
                        localStorage.removeItem(LOCK_KEY);
                    }
                }
            } catch (e) { localStorage.removeItem(LOCK_KEY); }

            // 2. Destrava Bot√µes "Processando..." congelados
            // Procura qualquer bot√£o que esteja com o atributo data-processing
            const botoesTravados = document.querySelectorAll('[data-processing="true"]');
            
            if (botoesTravados.length > 0) {
                console.warn(`‚ö†Ô∏è Encontrados ${botoesTravados.length} bot√µes em estado Zumbi. Destravando...`);
                
                botoesTravados.forEach(btn => {
                    // Remove a trava visual
                    btn.removeAttribute('data-processing');
                    btn.classList.remove('opacity-50', 'cursor-wait');
                    btn.disabled = false;
                    
                    // Restaura texto se poss√≠vel (remove o spinner)
                    if (btn.innerHTML.includes('animate-spin')) {
                        // Tenta adivinhar o texto original pelo ID ou define um padr√£o
                        if (btn.id.includes('salvar')) btn.textContent = 'Salvar';
                        else if (btn.id.includes('confirmar')) btn.textContent = 'Confirmar';
                        else btn.textContent = 'Tentar Novamente';
                    }
                });
                
                // Opcional: Feedback visual discreto
                // UIRenderer.showToast('Sistema sincronizado.');
            }
        }
    });
    initApp();


window.alternarModoFinanceiro = () => {
    // 1. Inverte o estado
    const novoModo = (AppState.modoDRE === 'real') ? 'presumido' : 'real';
    AppState.modoDRE = novoModo;
    
    // 2. Persiste a prefer√™ncia
    localStorage.setItem('preferencia_dre', novoModo);
    
    // 3. Renderiza sem travar (Boot suave)
    UIRenderer.render(); 
    
};

/**
 * üöë PATCH DE EMERG√äNCIA (V2025.2)
 * Cola isso no FINAL do ScriptCompleto.js para corrigir os erros do Console.
 */

(function aplicarCurativo() {
    console.log("üöë Aplicando Patch de Corre√ß√£o de Erros...");

    // 1. CORRE√á√ÉO DA DATA (Resolve o erro .getDate is not a function)
    // For√ßa a dataSelecionada a ser sempre um Objeto Date real
    if (window.AppState) {
        const corrigirData = () => {
            if (typeof AppState.dataSelecionada === 'string') {
                // Converte "2023-01-01" volta para Objeto Date
                const partes = AppState.dataSelecionada.split('-');
                if(partes.length === 3) {
                    AppState.dataSelecionada = new Date(partes[0], partes[1]-1, partes[2]);
                    console.log("‚úÖ Data corrigida para Objeto Date.");
                } else {
                    AppState.dataSelecionada = new Date();
                }
            }
        };
        // Roda agora e a cada clique de navega√ß√£o
        corrigirData();
        document.getElementById('diaAnteriorBtn')?.addEventListener('mousedown', corrigirData);
        document.getElementById('diaSeguinteBtn')?.addEventListener('mousedown', corrigirData);
    }

    // 2. RECONSTRU√á√ÉO DO BUSINESS LOGIC (Tapa os buracos das fun√ß√µes faltando)
    if (!window.BusinessLogic) window.BusinessLogic = {};

    // Fun√ß√£o que faltava no Loop de Renderiza√ß√£o (A mais cr√≠tica)
    if (!window.BusinessLogic.calcularSaudeVeiculo) {
        window.BusinessLogic.calcularSaudeVeiculo = function() {
            // Retorna um valor padr√£o para n√£o travar o loop
            return { saude: 100, status: 'OK', alertas: [] };
        };
        console.log("‚úÖ Fun√ß√£o calcularSaudeVeiculo restaurada (Dummy).");
    }

    // Fun√ß√µes dos Bot√µes de Pausa (Linhas ~9000)
    if (!window.BusinessLogic.iniciarPausa) {
        window.BusinessLogic.iniciarPausa = function() {
            console.log("Redirecionando Pausa para JornadaManager...");
            if(window.JornadaManager) window.JornadaManager.pausar();
        };
    }
    if (!window.BusinessLogic.retomarJornada) {
        window.BusinessLogic.retomarJornada = function() {
            console.log("Redirecionando Retomada para JornadaManager...");
            if(window.JornadaManager) window.JornadaManager.retomar();
        };
    }

    // Fun√ß√µes de Relat√≥rio Financeiro
    if (!window.BusinessLogic.gerarLivroCaixa) {
        window.BusinessLogic.gerarLivroCaixa = function() { alert("Funcionalidade Livro Caixa em manuten√ß√£o."); };
    }
    if (!window.BusinessLogic.gerarSimuladorMEI) {
        window.BusinessLogic.gerarSimuladorMEI = function() { alert("Simulador MEI em manuten√ß√£o."); };
    }
    if (!window.BusinessLogic.calcularResumoPeriodo) {
        window.BusinessLogic.calcularResumoPeriodo = function() { return { totalGanhos: 0, totalCustos: 0, saldo: 0 }; };
    }

    console.log("‚úÖ Patch Aplicado. O console deve parar de ver vermelho.");
})();

});
